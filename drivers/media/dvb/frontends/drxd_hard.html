<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › frontends › drxd_hard.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>drxd_hard.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drxd_hard.c: DVB-T Demodulator Micronas DRX3975D-A2,DRX397xD-B1</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2003-2007 Micronas</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * version 2 only, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301, USA</span>
<span class="cm"> * Or, point your browser to http://www.gnu.org/copyleft/gpl.html</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;asm/div64.h&gt;</span>

<span class="cp">#include &quot;dvb_frontend.h&quot;</span>
<span class="cp">#include &quot;drxd.h&quot;</span>
<span class="cp">#include &quot;drxd_firm.h&quot;</span>

<span class="cp">#define DRX_FW_FILENAME_A2 &quot;drxd-a2-1.1.fw&quot;</span>
<span class="cp">#define DRX_FW_FILENAME_B1 &quot;drxd-b1-1.1.fw&quot;</span>

<span class="cp">#define CHUNK_SIZE 48</span>

<span class="cp">#define DRX_I2C_RMW           0x10</span>
<span class="cp">#define DRX_I2C_BROADCAST     0x20</span>
<span class="cp">#define DRX_I2C_CLEARCRC      0x80</span>
<span class="cp">#define DRX_I2C_SINGLE_MASTER 0xC0</span>
<span class="cp">#define DRX_I2C_MODEFLAGS     0xC0</span>
<span class="cp">#define DRX_I2C_FLAGS         0xF0</span>

<span class="cp">#ifndef SIZEOF_ARRAY</span>
<span class="cp">#define SIZEOF_ARRAY(array) (sizeof((array))/sizeof((array)[0]))</span>
<span class="cp">#endif</span>

<span class="cp">#define DEFAULT_LOCK_TIMEOUT    1100</span>

<span class="cp">#define DRX_CHANNEL_AUTO 0</span>
<span class="cp">#define DRX_CHANNEL_HIGH 1</span>
<span class="cp">#define DRX_CHANNEL_LOW  2</span>

<span class="cp">#define DRX_LOCK_MPEG  1</span>
<span class="cp">#define DRX_LOCK_FEC   2</span>
<span class="cp">#define DRX_LOCK_DEMOD 4</span>

<span class="cm">/****************************************************************************/</span>

<span class="k">enum</span> <span class="n">CSCDState</span> <span class="p">{</span>
	<span class="n">CSCD_INIT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">CSCD_SET</span><span class="p">,</span>
	<span class="n">CSCD_SAVED</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">CDrxdState</span> <span class="p">{</span>
	<span class="n">DRXD_UNINITIALIZED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">DRXD_STOPPED</span><span class="p">,</span>
	<span class="n">DRXD_STARTED</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">AGC_CTRL_MODE</span> <span class="p">{</span>
	<span class="n">AGC_CTRL_AUTO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">AGC_CTRL_USER</span><span class="p">,</span>
	<span class="n">AGC_CTRL_OFF</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">OperationMode</span> <span class="p">{</span>
	<span class="n">OM_Default</span><span class="p">,</span>
	<span class="n">OM_DVBT_Diversity_Front</span><span class="p">,</span>
	<span class="n">OM_DVBT_Diversity_End</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">SCfgAgc</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">AGC_CTRL_MODE</span> <span class="n">ctrlMode</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">outputLevel</span><span class="p">;</span>	<span class="cm">/* range [0, ... , 1023], 1/n of fullscale range */</span>
	<span class="n">u16</span> <span class="n">settleLevel</span><span class="p">;</span>	<span class="cm">/* range [0, ... , 1023], 1/n of fullscale range */</span>
	<span class="n">u16</span> <span class="n">minOutputLevel</span><span class="p">;</span>	<span class="cm">/* range [0, ... , 1023], 1/n of fullscale range */</span>
	<span class="n">u16</span> <span class="n">maxOutputLevel</span><span class="p">;</span>	<span class="cm">/* range [0, ... , 1023], 1/n of fullscale range */</span>
	<span class="n">u16</span> <span class="n">speed</span><span class="p">;</span>		<span class="cm">/* range [0, ... , 1023], 1/n of fullscale range */</span>

	<span class="n">u16</span> <span class="n">R1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">R2</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">R3</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">SNoiseCal</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpOpt</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">cpNexpOfs</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">tdCal2k</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">tdCal8k</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">app_env</span> <span class="p">{</span>
	<span class="n">APPENV_STATIC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">APPENV_PORTABLE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">APPENV_MOBILE</span> <span class="o">=</span> <span class="mi">2</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">EIFFilter</span> <span class="p">{</span>
	<span class="n">IFFILTER_SAW</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">IFFILTER_DISCRETE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">drxd_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="n">frontend</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="n">props</span><span class="p">;</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drxd_config</span> <span class="n">config</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">i2c_access</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">init_done</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">chip_adr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hi_cfg_timing_div</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hi_cfg_bridge_delay</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hi_cfg_wakeup_key</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hi_cfg_ctrl</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">intermediate_freq</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">osc_clock_freq</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">CSCDState</span> <span class="n">cscd_state</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">CDrxdState</span> <span class="n">drxd_state</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">sys_clock_freq</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">osc_clock_deviation</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">expected_sys_clock_freq</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">insert_rs_byte</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">enable_parallel</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">operation_mode</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">SCfgAgc</span> <span class="n">if_agc_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">SCfgAgc</span> <span class="n">rf_agc_cfg</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">SNoiseCal</span> <span class="n">noise_cal</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">fe_fs_add_incr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">org_fe_fs_add_incr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">current_fe_if_incr</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">m_FeAgRegAgPwd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">m_FeAgRegAgAgcSio</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">m_EcOcRegOcModeLop</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">m_EcOcRegSncSncLvl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">m_InitAtomicRead</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">m_HiI2cPatch</span><span class="p">;</span>

	<span class="n">u8</span> <span class="o">*</span><span class="n">m_ResetCEFR</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">m_InitFE_1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">m_InitFE_2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">m_InitCP</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">m_InitCE</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">m_InitEQ</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">m_InitSC</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">m_InitEC</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">m_ResetECRAM</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">m_InitDiversityFront</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">m_InitDiversityEnd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">m_DisableDiversity</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">m_StartDiversityFront</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">m_StartDiversityEnd</span><span class="p">;</span>

	<span class="n">u8</span> <span class="o">*</span><span class="n">m_DiversityDelay8MHZ</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">m_DiversityDelay6MHZ</span><span class="p">;</span>

	<span class="n">u8</span> <span class="o">*</span><span class="n">microcode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">microcode_length</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">type_A</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">PGA</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">diversity</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tuner_mirrors</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">app_env</span> <span class="n">app_env_default</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">app_env</span> <span class="n">app_env_diversity</span><span class="p">;</span>

<span class="p">};</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/* I2C **********************************************************************/</span>
<span class="cm">/****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="n">u8</span> <span class="n">adr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">adr</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span>
		    <span class="n">u8</span> <span class="n">adr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">answ</span><span class="p">,</span> <span class="kt">int</span> <span class="n">alen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msgs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">adr</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">msg</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span>
		<span class="p">},</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">adr</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">answ</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">alen</span>
		<span class="p">}</span>
	<span class="p">};</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">MulDiv32</span><span class="p">(</span><span class="n">u32</span> <span class="n">a</span><span class="p">,</span> <span class="n">u32</span> <span class="n">b</span><span class="p">,</span> <span class="n">u32</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">tmp64</span><span class="p">;</span>

	<span class="n">tmp64</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">b</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">tmp64</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">tmp64</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">Read16</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">adr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">demod_address</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mm1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="n">flags</span> <span class="o">|</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="n">mm2</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_read</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">adr</span><span class="p">,</span> <span class="n">mm1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">mm2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">mm2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">mm2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mm2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">mm2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">Read32</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">adr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">demod_address</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mm1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="n">flags</span> <span class="o">|</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="n">mm2</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_read</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">adr</span><span class="p">,</span> <span class="n">mm1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">mm2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span>
		    <span class="n">mm2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">mm2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mm2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mm2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">Write16</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">adr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">demod_address</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mm</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="n">flags</span> <span class="o">|</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_write</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">adr</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">Write32</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">adr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">demod_address</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mm</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="n">flags</span> <span class="o">|</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_write</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">adr</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_chunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
		       <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">adr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">demod_address</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mm</span><span class="p">[</span><span class="n">CHUNK_SIZE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="n">flags</span> <span class="o">|</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mm</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_write</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">adr</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error in write_chunk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">WriteBlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
		      <span class="n">u32</span> <span class="n">Address</span><span class="p">,</span> <span class="n">u16</span> <span class="n">BlockSize</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pBlock</span><span class="p">,</span> <span class="n">u8</span> <span class="n">Flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">BlockSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">Chunk</span> <span class="o">=</span> <span class="n">BlockSize</span> <span class="o">&gt;</span> <span class="n">CHUNK_SIZE</span> <span class="o">?</span> <span class="n">CHUNK_SIZE</span> <span class="o">:</span> <span class="n">BlockSize</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">write_chunk</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">Address</span><span class="p">,</span> <span class="n">pBlock</span><span class="p">,</span> <span class="n">Chunk</span><span class="p">,</span> <span class="n">Flags</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">pBlock</span> <span class="o">+=</span> <span class="n">Chunk</span><span class="p">;</span>
		<span class="n">Address</span> <span class="o">+=</span> <span class="p">(</span><span class="n">Chunk</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">BlockSize</span> <span class="o">-=</span> <span class="n">Chunk</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">WriteTable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">pTable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pTable</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">Length</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">Address</span> <span class="o">=</span> <span class="n">pTable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">pTable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">pTable</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pTable</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Address</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">pTable</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

		<span class="n">Length</span> <span class="o">=</span> <span class="n">pTable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">pTable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">pTable</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Length</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">WriteBlock</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">Address</span><span class="p">,</span> <span class="n">Length</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pTable</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pTable</span> <span class="o">+=</span> <span class="p">(</span><span class="n">Length</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/****************************************************************************/</span>
<span class="cm">/****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ResetCEFR</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">WriteTable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_ResetCEFR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">InitCP</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">WriteTable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitCP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">InitCE</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">app_env</span> <span class="n">AppEnv</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">app_env_default</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">WriteTable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitCE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">operation_mode</span> <span class="o">==</span> <span class="n">OM_DVBT_Diversity_Front</span> <span class="o">||</span>
		    <span class="n">state</span><span class="o">-&gt;</span><span class="n">operation_mode</span> <span class="o">==</span> <span class="n">OM_DVBT_Diversity_End</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">AppEnv</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">app_env_diversity</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">AppEnv</span> <span class="o">==</span> <span class="n">APPENV_STATIC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CE_REG_TAPSET__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AppEnv</span> <span class="o">==</span> <span class="n">APPENV_PORTABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CE_REG_TAPSET__A</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AppEnv</span> <span class="o">==</span> <span class="n">APPENV_MOBILE</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CE_REG_TAPSET__A</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AppEnv</span> <span class="o">==</span> <span class="n">APPENV_MOBILE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CE_REG_TAPSET__A</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* start ce */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_CE_REG_COMM_EXEC__A</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">StopOC</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ocSyncLvl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ocModeLop</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_EcOcRegOcModeLop</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dtoIncLop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dtoIncHip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Store output configuration */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_SNC_ISC_LVL__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ocSyncLvl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* CHK_ERROR(Read16(EC_OC_REG_OC_MODE_LOP__A, &amp;ocModeLop)); */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_EcOcRegSncSncLvl</span> <span class="o">=</span> <span class="n">ocSyncLvl</span><span class="p">;</span>
		<span class="cm">/* m_EcOcRegOcModeLop = ocModeLop; */</span>

		<span class="cm">/* Flush FIFO (byte-boundary) at fixed rate */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_RCN_MAP_LOP__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dtoIncLop</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_RCN_MAP_HIP__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dtoIncHip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_DTO_INC_LOP__A</span><span class="p">,</span> <span class="n">dtoIncLop</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_DTO_INC_HIP__A</span><span class="p">,</span> <span class="n">dtoIncHip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ocModeLop</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EC_OC_REG_OC_MODE_LOP_DTO_CTR_SRC__M</span><span class="p">);</span>
		<span class="n">ocModeLop</span> <span class="o">|=</span> <span class="n">EC_OC_REG_OC_MODE_LOP_DTO_CTR_SRC_STATIC</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_OC_MODE_LOP__A</span><span class="p">,</span> <span class="n">ocModeLop</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_COMM_EXEC__A</span><span class="p">,</span> <span class="n">EC_OC_REG_COMM_EXEC_CTL_HOLD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Output pins to &#39;0&#39; */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_OCR_MPG_UOS__A</span><span class="p">,</span> <span class="n">EC_OC_REG_OCR_MPG_UOS__M</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Force the OC out of sync */</span>
		<span class="n">ocSyncLvl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EC_OC_REG_SNC_ISC_LVL_OSC__M</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_SNC_ISC_LVL__A</span><span class="p">,</span> <span class="n">ocSyncLvl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ocModeLop</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EC_OC_REG_OC_MODE_LOP_PAR_ENA__M</span><span class="p">);</span>
		<span class="n">ocModeLop</span> <span class="o">|=</span> <span class="n">EC_OC_REG_OC_MODE_LOP_PAR_ENA_ENABLE</span><span class="p">;</span>
		<span class="n">ocModeLop</span> <span class="o">|=</span> <span class="mh">0x2</span><span class="p">;</span>	<span class="cm">/* Magically-out-of-sync */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_OC_MODE_LOP__A</span><span class="p">,</span> <span class="n">ocModeLop</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_COMM_INT_STA__A</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_COMM_EXEC__A</span><span class="p">,</span> <span class="n">EC_OC_REG_COMM_EXEC_CTL_ACTIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">StartOC</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Stop OC */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_COMM_EXEC__A</span><span class="p">,</span> <span class="n">EC_OC_REG_COMM_EXEC_CTL_HOLD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Restore output configuration */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_SNC_ISC_LVL__A</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_EcOcRegSncSncLvl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_OC_MODE_LOP__A</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_EcOcRegOcModeLop</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Output pins active again */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_OCR_MPG_UOS__A</span><span class="p">,</span> <span class="n">EC_OC_REG_OCR_MPG_UOS_INIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Start OC */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_COMM_EXEC__A</span><span class="p">,</span> <span class="n">EC_OC_REG_COMM_EXEC_CTL_ACTIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">InitEQ</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">WriteTable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitEQ</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">InitEC</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">WriteTable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitEC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">InitSC</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">WriteTable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitSC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">InitAtomicRead</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">WriteTable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitAtomicRead</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">CorrectSysClockDeviation</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DRX_GetLockStatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">pLockStatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ScRaRamLock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="n">mpeg_lock_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">SC_RA_RAM_LOCK_MPEG__M</span> <span class="o">|</span>
				    <span class="n">SC_RA_RAM_LOCK_FEC__M</span> <span class="o">|</span>
				    <span class="n">SC_RA_RAM_LOCK_DEMOD__M</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="n">fec_lock_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">SC_RA_RAM_LOCK_FEC__M</span> <span class="o">|</span>
				   <span class="n">SC_RA_RAM_LOCK_DEMOD__M</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="n">demod_lock_mask</span> <span class="o">=</span> <span class="n">SC_RA_RAM_LOCK_DEMOD__M</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pLockStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_LOCK__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ScRaRamLock</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Can&#39;t read SC_RA_RAM_LOCK__A status = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">drxd_state</span> <span class="o">!=</span> <span class="n">DRXD_STARTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ScRaRamLock</span> <span class="o">&amp;</span> <span class="n">mpeg_lock_mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">mpeg_lock_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pLockStatus</span> <span class="o">|=</span> <span class="n">DRX_LOCK_MPEG</span><span class="p">;</span>
		<span class="n">CorrectSysClockDeviation</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ScRaRamLock</span> <span class="o">&amp;</span> <span class="n">fec_lock_mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">fec_lock_mask</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pLockStatus</span> <span class="o">|=</span> <span class="n">DRX_LOCK_FEC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ScRaRamLock</span> <span class="o">&amp;</span> <span class="n">demod_lock_mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">demod_lock_mask</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pLockStatus</span> <span class="o">|=</span> <span class="n">DRX_LOCK_DEMOD</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetCfgIfAgc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">struct</span> <span class="n">SCfgAgc</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">outputLevel</span> <span class="o">&gt;</span> <span class="n">DRXD_FE_CTRL_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ctrlMode</span> <span class="o">==</span> <span class="n">AGC_CTRL_USER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">FeAgRegPm1AgcWri</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">FeAgRegAgModeLop</span><span class="p">;</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_MODE_LOP__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FeAgRegAgModeLop</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">FeAgRegAgModeLop</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">FE_AG_REG_AG_MODE_LOP_MODE_4__M</span><span class="p">);</span>
			<span class="n">FeAgRegAgModeLop</span> <span class="o">|=</span> <span class="n">FE_AG_REG_AG_MODE_LOP_MODE_4_STATIC</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_MODE_LOP__A</span><span class="p">,</span> <span class="n">FeAgRegAgModeLop</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">FeAgRegPm1AgcWri</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">outputLevel</span> <span class="o">&amp;</span>
						  <span class="n">FE_AG_REG_PM1_AGC_WRI__M</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_PM1_AGC_WRI__A</span><span class="p">,</span> <span class="n">FeAgRegPm1AgcWri</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ctrlMode</span> <span class="o">==</span> <span class="n">AGC_CTRL_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maxOutputLevel</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">minOutputLevel</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maxOutputLevel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">DRXD_FE_CTRL_MAX</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">DRXD_FE_CTRL_MAX</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">settleLevel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">DRXD_FE_CTRL_MAX</span><span class="p">)</span>
		    <span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">FeAgRegAgModeLop</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">FeAgRegEgcSetLvl</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">slope</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>

			<span class="cm">/* == Mode == */</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_MODE_LOP__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FeAgRegAgModeLop</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">FeAgRegAgModeLop</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">FE_AG_REG_AG_MODE_LOP_MODE_4__M</span><span class="p">);</span>
			<span class="n">FeAgRegAgModeLop</span> <span class="o">|=</span>
			    <span class="n">FE_AG_REG_AG_MODE_LOP_MODE_4_DYNAMIC</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_MODE_LOP__A</span><span class="p">,</span> <span class="n">FeAgRegAgModeLop</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* == Settle level == */</span>

			<span class="n">FeAgRegEgcSetLvl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">settleLevel</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
						  <span class="n">FE_AG_REG_EGC_SET_LVL__M</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_EGC_SET_LVL__A</span><span class="p">,</span> <span class="n">FeAgRegEgcSetLvl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* == Min/Max == */</span>

			<span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maxOutputLevel</span> <span class="o">-</span>
					<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">minOutputLevel</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">maxOutputLevel</span> <span class="o">+</span>
					 <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">minOutputLevel</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">511</span><span class="p">);</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_GC1_AGC_RIC__A</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_GC1_AGC_OFF__A</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* == Speed == */</span>
			<span class="p">{</span>
				<span class="k">const</span> <span class="n">u16</span> <span class="n">maxRur</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">const</span> <span class="n">u16</span> <span class="n">slowIncrDecLUT</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span> <span class="p">};</span>
				<span class="k">const</span> <span class="n">u16</span> <span class="n">fastIncrDecLUT</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>
					<span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span>
					<span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span>
					<span class="mi">24</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span>
					<span class="mi">29</span><span class="p">,</span> <span class="mi">31</span>
				<span class="p">};</span>

				<span class="n">u16</span> <span class="n">fineSteps</span> <span class="o">=</span> <span class="p">(</span><span class="n">DRXD_FE_CTRL_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span>
				    <span class="p">(</span><span class="n">maxRur</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">u16</span> <span class="n">fineSpeed</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">-</span>
						       <span class="p">((</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">/</span>
							 <span class="n">fineSteps</span><span class="p">)</span> <span class="o">*</span>
							<span class="n">fineSteps</span><span class="p">));</span>
				<span class="n">u16</span> <span class="n">invRurCount</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">/</span>
							 <span class="n">fineSteps</span><span class="p">);</span>
				<span class="n">u16</span> <span class="n">rurCount</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">invRurCount</span> <span class="o">&gt;</span> <span class="n">maxRur</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rurCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">fineSpeed</span> <span class="o">+=</span> <span class="n">fineSteps</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">rurCount</span> <span class="o">=</span> <span class="n">maxRur</span> <span class="o">-</span> <span class="n">invRurCount</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/*</span>
<span class="cm">				   fastInc = default *</span>
<span class="cm">				   (2^(fineSpeed/fineSteps))</span>
<span class="cm">				   =&gt; range[default...2*default&gt;</span>
<span class="cm">				   slowInc = default *</span>
<span class="cm">				   (2^(fineSpeed/fineSteps))</span>
<span class="cm">				 */</span>
				<span class="p">{</span>
					<span class="n">u16</span> <span class="n">fastIncrDec</span> <span class="o">=</span>
					    <span class="n">fastIncrDecLUT</span><span class="p">[</span><span class="n">fineSpeed</span> <span class="o">/</span>
							   <span class="p">((</span><span class="n">fineSteps</span> <span class="o">/</span>
							     <span class="p">(</span><span class="mi">14</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)];</span>
					<span class="n">u16</span> <span class="n">slowIncrDec</span> <span class="o">=</span>
					    <span class="n">slowIncrDecLUT</span><span class="p">[</span><span class="n">fineSpeed</span> <span class="o">/</span>
							   <span class="p">(</span><span class="n">fineSteps</span> <span class="o">/</span>
							    <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))];</span>

					<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_EGC_RUR_CNT__A</span><span class="p">,</span> <span class="n">rurCount</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_EGC_FAS_INC__A</span><span class="p">,</span> <span class="n">fastIncrDec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_EGC_FAS_DEC__A</span><span class="p">,</span> <span class="n">fastIncrDec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_EGC_SLO_INC__A</span><span class="p">,</span> <span class="n">slowIncrDec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_EGC_SLO_DEC__A</span><span class="p">,</span> <span class="n">slowIncrDec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* No OFF mode for IF control */</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetCfgRfAgc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">struct</span> <span class="n">SCfgAgc</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">outputLevel</span> <span class="o">&gt;</span> <span class="n">DRXD_FE_CTRL_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ctrlMode</span> <span class="o">==</span> <span class="n">AGC_CTRL_USER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">AgModeLop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">level</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">outputLevel</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="n">DRXD_FE_CTRL_MAX</span><span class="p">)</span>
				<span class="n">level</span><span class="o">++</span><span class="p">;</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_PM2_AGC_WRI__A</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/*==== Mode ====*/</span>

			<span class="cm">/* Powerdown PD2, WRI source */</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_FeAgRegAgPwd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FE_AG_REG_AG_PWD_PWD_PD2__M</span><span class="p">);</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_FeAgRegAgPwd</span> <span class="o">|=</span>
			    <span class="n">FE_AG_REG_AG_PWD_PWD_PD2_DISABLE</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_PWD__A</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_FeAgRegAgPwd</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_MODE_LOP__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">AgModeLop</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">AgModeLop</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">FE_AG_REG_AG_MODE_LOP_MODE_5__M</span> <span class="o">|</span>
					<span class="n">FE_AG_REG_AG_MODE_LOP_MODE_E__M</span><span class="p">));</span>
			<span class="n">AgModeLop</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FE_AG_REG_AG_MODE_LOP_MODE_5_STATIC</span> <span class="o">|</span>
				      <span class="n">FE_AG_REG_AG_MODE_LOP_MODE_E_STATIC</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_MODE_LOP__A</span><span class="p">,</span> <span class="n">AgModeLop</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* enable AGC2 pin */</span>
			<span class="p">{</span>
				<span class="n">u16</span> <span class="n">FeAgRegAgAgcSio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_AGC_SIO__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FeAgRegAgAgcSio</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">FeAgRegAgAgcSio</span> <span class="o">&amp;=</span>
				    <span class="o">~</span><span class="p">(</span><span class="n">FE_AG_REG_AG_AGC_SIO_AGC_SIO_2__M</span><span class="p">);</span>
				<span class="n">FeAgRegAgAgcSio</span> <span class="o">|=</span>
				    <span class="n">FE_AG_REG_AG_AGC_SIO_AGC_SIO_2_OUTPUT</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_AGC_SIO__A</span><span class="p">,</span> <span class="n">FeAgRegAgAgcSio</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ctrlMode</span> <span class="o">==</span> <span class="n">AGC_CTRL_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">AgModeLop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">level</span><span class="p">;</span>
			<span class="cm">/* Automatic control */</span>
			<span class="cm">/* Powerup PD2, AGC2 as output, TGC source */</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_FeAgRegAgPwd</span><span class="p">)</span> <span class="o">&amp;=</span>
			    <span class="o">~</span><span class="p">(</span><span class="n">FE_AG_REG_AG_PWD_PWD_PD2__M</span><span class="p">);</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_FeAgRegAgPwd</span><span class="p">)</span> <span class="o">|=</span>
			    <span class="n">FE_AG_REG_AG_PWD_PWD_PD2_DISABLE</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_PWD__A</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_FeAgRegAgPwd</span><span class="p">),</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_MODE_LOP__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">AgModeLop</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">AgModeLop</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">FE_AG_REG_AG_MODE_LOP_MODE_5__M</span> <span class="o">|</span>
					<span class="n">FE_AG_REG_AG_MODE_LOP_MODE_E__M</span><span class="p">));</span>
			<span class="n">AgModeLop</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FE_AG_REG_AG_MODE_LOP_MODE_5_STATIC</span> <span class="o">|</span>
				      <span class="n">FE_AG_REG_AG_MODE_LOP_MODE_E_DYNAMIC</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_MODE_LOP__A</span><span class="p">,</span> <span class="n">AgModeLop</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* Settle level */</span>
			<span class="n">level</span> <span class="o">=</span> <span class="p">(((</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">settleLevel</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span>
				 <span class="n">FE_AG_REG_TGC_SET_LVL__M</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_TGC_SET_LVL__A</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* Min/max: don&#39;t care */</span>

			<span class="cm">/* Speed: TODO */</span>

			<span class="cm">/* enable AGC2 pin */</span>
			<span class="p">{</span>
				<span class="n">u16</span> <span class="n">FeAgRegAgAgcSio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_AGC_SIO__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FeAgRegAgAgcSio</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">FeAgRegAgAgcSio</span> <span class="o">&amp;=</span>
				    <span class="o">~</span><span class="p">(</span><span class="n">FE_AG_REG_AG_AGC_SIO_AGC_SIO_2__M</span><span class="p">);</span>
				<span class="n">FeAgRegAgAgcSio</span> <span class="o">|=</span>
				    <span class="n">FE_AG_REG_AG_AGC_SIO_AGC_SIO_2_OUTPUT</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_AGC_SIO__A</span><span class="p">,</span> <span class="n">FeAgRegAgAgcSio</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">AgModeLop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="cm">/* No RF AGC control */</span>
			<span class="cm">/* Powerdown PD2, AGC2 as output, WRI source */</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_FeAgRegAgPwd</span><span class="p">)</span> <span class="o">&amp;=</span>
			    <span class="o">~</span><span class="p">(</span><span class="n">FE_AG_REG_AG_PWD_PWD_PD2__M</span><span class="p">);</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_FeAgRegAgPwd</span><span class="p">)</span> <span class="o">|=</span>
			    <span class="n">FE_AG_REG_AG_PWD_PWD_PD2_ENABLE</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_PWD__A</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">m_FeAgRegAgPwd</span><span class="p">),</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_MODE_LOP__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">AgModeLop</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">AgModeLop</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">FE_AG_REG_AG_MODE_LOP_MODE_5__M</span> <span class="o">|</span>
					<span class="n">FE_AG_REG_AG_MODE_LOP_MODE_E__M</span><span class="p">));</span>
			<span class="n">AgModeLop</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FE_AG_REG_AG_MODE_LOP_MODE_5_STATIC</span> <span class="o">|</span>
				      <span class="n">FE_AG_REG_AG_MODE_LOP_MODE_E_STATIC</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_MODE_LOP__A</span><span class="p">,</span> <span class="n">AgModeLop</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* set FeAgRegAgAgcSio AGC2 (RF) as input */</span>
			<span class="p">{</span>
				<span class="n">u16</span> <span class="n">FeAgRegAgAgcSio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_AGC_SIO__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FeAgRegAgAgcSio</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">FeAgRegAgAgcSio</span> <span class="o">&amp;=</span>
				    <span class="o">~</span><span class="p">(</span><span class="n">FE_AG_REG_AG_AGC_SIO_AGC_SIO_2__M</span><span class="p">);</span>
				<span class="n">FeAgRegAgAgcSio</span> <span class="o">|=</span>
				    <span class="n">FE_AG_REG_AG_AGC_SIO_AGC_SIO_2_INPUT</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_AGC_SIO__A</span><span class="p">,</span> <span class="n">FeAgRegAgAgcSio</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ReadIFAgc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">pValue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">.</span><span class="n">ctrlMode</span> <span class="o">!=</span> <span class="n">AGC_CTRL_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">Value</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_GC1_AGC_DAT__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Value</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">Value</span> <span class="o">&amp;=</span> <span class="n">FE_AG_REG_GC1_AGC_DAT__M</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*           3.3V</span>
<span class="cm">			   |</span>
<span class="cm">			   R1</span>
<span class="cm">			   |</span>
<span class="cm">			   Vin - R3 - * -- Vout</span>
<span class="cm">			   |</span>
<span class="cm">			   R2</span>
<span class="cm">			   |</span>
<span class="cm">			   GND</span>
<span class="cm">			 */</span>
			<span class="n">u32</span> <span class="n">R1</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">.</span><span class="n">R1</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">R2</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">.</span><span class="n">R2</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">R3</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">.</span><span class="n">R3</span><span class="p">;</span>

			<span class="n">u32</span> <span class="n">Vmax</span><span class="p">,</span> <span class="n">Rpar</span><span class="p">,</span> <span class="n">Vmin</span><span class="p">,</span> <span class="n">Vout</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">R2</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">R1</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">R3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">Vmax</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3300</span> <span class="o">*</span> <span class="n">R2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">R1</span> <span class="o">+</span> <span class="n">R2</span><span class="p">);</span>
			<span class="n">Rpar</span> <span class="o">=</span> <span class="p">(</span><span class="n">R2</span> <span class="o">*</span> <span class="n">R3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">R3</span> <span class="o">+</span> <span class="n">R2</span><span class="p">);</span>
			<span class="n">Vmin</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3300</span> <span class="o">*</span> <span class="n">Rpar</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">R1</span> <span class="o">+</span> <span class="n">Rpar</span><span class="p">);</span>
			<span class="n">Vout</span> <span class="o">=</span> <span class="n">Vmin</span> <span class="o">+</span> <span class="p">((</span><span class="n">Vmax</span> <span class="o">-</span> <span class="n">Vmin</span><span class="p">)</span> <span class="o">*</span> <span class="n">Value</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>

			<span class="o">*</span><span class="n">pValue</span> <span class="o">=</span> <span class="n">Vout</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">load_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxd: firmware load failure [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">microcode</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">microcode</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxd: firmware load failure: no memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">microcode_length</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DownloadMicrocode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			     <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pMCImage</span><span class="p">,</span> <span class="n">u32</span> <span class="n">Length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pSrc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">Address</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">nBlocks</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">BlockSize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pSrc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">pMCImage</span><span class="p">;</span>
	<span class="cm">/* We&#39;re not using Flags */</span>
	<span class="cm">/* Flags = (pSrc[0] &lt;&lt; 8) | pSrc[1]; */</span>
	<span class="n">pSrc</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
	<span class="n">nBlocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">pSrc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pSrc</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">pSrc</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nBlocks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Address</span> <span class="o">=</span> <span class="p">(</span><span class="n">pSrc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pSrc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">pSrc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pSrc</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">pSrc</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

		<span class="n">BlockSize</span> <span class="o">=</span> <span class="p">((</span><span class="n">pSrc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pSrc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
		<span class="n">pSrc</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>

		<span class="cm">/* We&#39;re not using Flags */</span>
		<span class="cm">/* u16 Flags = (pSrc[0] &lt;&lt; 8) | pSrc[1]; */</span>
		<span class="n">pSrc</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>

		<span class="cm">/* We&#39;re not using BlockCRC */</span>
		<span class="cm">/* u16 BlockCRC = (pSrc[0] &lt;&lt; 8) | pSrc[1]; */</span>
		<span class="n">pSrc</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">WriteBlock</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">Address</span><span class="p">,</span> <span class="n">BlockSize</span><span class="p">,</span>
				    <span class="n">pSrc</span><span class="p">,</span> <span class="n">DRX_I2C_CLEARCRC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">pSrc</span> <span class="o">+=</span> <span class="n">BlockSize</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">BlockSize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">HI_Command</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">pResult</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">nrRetries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">waitCmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">HI_RA_RAM_SRV_CMD__A</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">nrRetries</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nrRetries</span> <span class="o">&gt;</span> <span class="n">DRXD_MAX_RETRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">};</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">HI_RA_RAM_SRV_CMD__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">waitCmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">waitCmd</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">HI_RA_RAM_SRV_RES__A</span><span class="p">,</span> <span class="n">pResult</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">HI_CfgCommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">HI_RA_RAM_SRV_CFG_KEY__A</span><span class="p">,</span> <span class="n">HI_RA_RAM_SRV_RST_KEY_ACT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">HI_RA_RAM_SRV_CFG_DIV__A</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">hi_cfg_timing_div</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">HI_RA_RAM_SRV_CFG_BDL__A</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">hi_cfg_bridge_delay</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">HI_RA_RAM_SRV_CFG_WUP__A</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">hi_cfg_wakeup_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">HI_RA_RAM_SRV_CFG_ACT__A</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">hi_cfg_ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">HI_RA_RAM_SRV_CFG_KEY__A</span><span class="p">,</span> <span class="n">HI_RA_RAM_SRV_RST_KEY_ACT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">hi_cfg_ctrl</span> <span class="o">&amp;</span> <span class="n">HI_RA_RAM_SRV_CFG_ACT_PWD_EXE</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">HI_RA_RAM_SRV_CFG_ACT_PWD_EXE</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">HI_RA_RAM_SRV_CMD__A</span><span class="p">,</span>
				 <span class="n">HI_RA_RAM_SRV_CMD_CONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">HI_Command</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">HI_RA_RAM_SRV_CMD_CONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">InitHI</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">hi_cfg_wakeup_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">chip_adr</span><span class="p">);</span>
	<span class="cm">/* port/bridge/power down ctrl */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">hi_cfg_ctrl</span> <span class="o">=</span> <span class="n">HI_RA_RAM_SRV_CFG_ACT_SLV0_ON</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">HI_CfgCommand</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">HI_ResetCommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">HI_RA_RAM_SRV_RST_KEY__A</span><span class="p">,</span>
			 <span class="n">HI_RA_RAM_SRV_RST_KEY_ACT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">HI_Command</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">HI_RA_RAM_SRV_CMD_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DRX_ConfigureI2CBridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bEnableBridge</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">hi_cfg_ctrl</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">HI_RA_RAM_SRV_CFG_ACT_BRD__M</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bEnableBridge</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">hi_cfg_ctrl</span> <span class="o">|=</span> <span class="n">HI_RA_RAM_SRV_CFG_ACT_BRD_ON</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">hi_cfg_ctrl</span> <span class="o">|=</span> <span class="n">HI_RA_RAM_SRV_CFG_ACT_BRD_OFF</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">HI_CfgCommand</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define HI_TR_WRITE      0x9</span>
<span class="cp">#define HI_TR_READ       0xA</span>
<span class="cp">#define HI_TR_READ_WRITE 0xB</span>
<span class="cp">#define HI_TR_BROADCAST  0x4</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int AtomicReadBlock(struct drxd_state *state,</span>
<span class="c">			   u32 Addr, u16 DataSize, u8 *pData, u8 Flags)</span>
<span class="c">{</span>
<span class="c">	int status;</span>
<span class="c">	int i = 0;</span>

<span class="c">	/* Parameter check */</span>
<span class="c">	if ((!pData) || ((DataSize &amp; 1) != 0))</span>
<span class="c">		return -1;</span>

<span class="c">	mutex_lock(&amp;state-&gt;mutex);</span>

<span class="c">	do {</span>
<span class="c">		/* Instruct HI to read n bytes */</span>
<span class="c">		/* TODO use proper names forthese egisters */</span>
<span class="c">		status = Write16(state, HI_RA_RAM_SRV_CFG_KEY__A, (HI_TR_FUNC_ADDR &amp; 0xFFFF), 0);</span>
<span class="c">		if (status &lt; 0)</span>
<span class="c">			break;</span>
<span class="c">		status = Write16(state, HI_RA_RAM_SRV_CFG_DIV__A, (u16) (Addr &gt;&gt; 16), 0);</span>
<span class="c">		if (status &lt; 0)</span>
<span class="c">			break;</span>
<span class="c">		status = Write16(state, HI_RA_RAM_SRV_CFG_BDL__A, (u16) (Addr &amp; 0xFFFF), 0);</span>
<span class="c">		if (status &lt; 0)</span>
<span class="c">			break;</span>
<span class="c">		status = Write16(state, HI_RA_RAM_SRV_CFG_WUP__A, (u16) ((DataSize / 2) - 1), 0);</span>
<span class="c">		if (status &lt; 0)</span>
<span class="c">			break;</span>
<span class="c">		status = Write16(state, HI_RA_RAM_SRV_CFG_ACT__A, HI_TR_READ, 0);</span>
<span class="c">		if (status &lt; 0)</span>
<span class="c">			break;</span>

<span class="c">		status = HI_Command(state, HI_RA_RAM_SRV_CMD_EXECUTE, 0);</span>
<span class="c">		if (status &lt; 0)</span>
<span class="c">			break;</span>

<span class="c">	} while (0);</span>

<span class="c">	if (status &gt;= 0) {</span>
<span class="c">		for (i = 0; i &lt; (DataSize / 2); i += 1) {</span>
<span class="c">			u16 word;</span>

<span class="c">			status = Read16(state, (HI_RA_RAM_USR_BEGIN__A + i),</span>
<span class="c">					&amp;word, 0);</span>
<span class="c">			if (status &lt; 0)</span>
<span class="c">				break;</span>
<span class="c">			pData[2 * i] = (u8) (word &amp; 0xFF);</span>
<span class="c">			pData[(2 * i) + 1] = (u8) (word &gt;&gt; 8);</span>
<span class="c">		}</span>
<span class="c">	}</span>
<span class="c">	mutex_unlock(&amp;state-&gt;mutex);</span>
<span class="c">	return status;</span>
<span class="c">}</span>

<span class="c">static int AtomicReadReg32(struct drxd_state *state,</span>
<span class="c">			   u32 Addr, u32 *pData, u8 Flags)</span>
<span class="c">{</span>
<span class="c">	u8 buf[sizeof(u32)];</span>
<span class="c">	int status;</span>

<span class="c">	if (!pData)</span>
<span class="c">		return -1;</span>
<span class="c">	status = AtomicReadBlock(state, Addr, sizeof(u32), buf, Flags);</span>
<span class="c">	*pData = (((u32) buf[0]) &lt;&lt; 0) +</span>
<span class="c">	    (((u32) buf[1]) &lt;&lt; 8) +</span>
<span class="c">	    (((u32) buf[2]) &lt;&lt; 16) + (((u32) buf[3]) &lt;&lt; 24);</span>
<span class="c">	return status;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">StopAllProcessors</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">HI_COMM_EXEC__A</span><span class="p">,</span>
		       <span class="n">SC_COMM_EXEC_CTL_STOP</span><span class="p">,</span> <span class="n">DRX_I2C_BROADCAST</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">EnableAndResetMB</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable? monitor bus observe @ EC_OC */</span>
		<span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_OC_MON_SIO__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* do inverse broadcast, followed by explicit write to HI */</span>
	<span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">HI_COMM_MB__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">DRX_I2C_BROADCAST</span><span class="p">);</span>
	<span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">HI_COMM_MB__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">InitCC</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">osc_clock_freq</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">state</span><span class="o">-&gt;</span><span class="n">osc_clock_freq</span> <span class="o">&gt;</span> <span class="mi">20000</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">osc_clock_freq</span> <span class="o">%</span> <span class="mi">4000</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;invalid osc frequency %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">osc_clock_freq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CC_REG_OSC_MODE__A</span><span class="p">,</span> <span class="n">CC_REG_OSC_MODE_M20</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CC_REG_PLL_MODE__A</span><span class="p">,</span> <span class="n">CC_REG_PLL_MODE_BYPASS_PLL</span> <span class="o">|</span>
		<span class="n">CC_REG_PLL_MODE_PUMP_CUR_12</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CC_REG_REF_DIVIDE__A</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">osc_clock_freq</span> <span class="o">/</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CC_REG_PWD_MODE__A</span><span class="p">,</span> <span class="n">CC_REG_PWD_MODE_DOWN_PLL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CC_REG_UPDATE__A</span><span class="p">,</span> <span class="n">CC_REG_UPDATE_KEY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ResetECOD</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OD_REG_SYNC__A</span><span class="p">,</span> <span class="mh">0x0664</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_EC_OD_REG_SYNC__A</span><span class="p">,</span> <span class="mh">0x0664</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">WriteTable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_ResetECRAM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OD_REG_COMM_EXEC__A</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Configure PGA switch */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetCfgPga</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pgaSwitch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">AgModeLop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">AgModeHip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pgaSwitch</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* PGA on */</span>
			<span class="cm">/* fine gain */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_FE_AG_REG_AG_MODE_LOP__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">AgModeLop</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">AgModeLop</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">B_FE_AG_REG_AG_MODE_LOP_MODE_C__M</span><span class="p">));</span>
			<span class="n">AgModeLop</span> <span class="o">|=</span> <span class="n">B_FE_AG_REG_AG_MODE_LOP_MODE_C_DYNAMIC</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_FE_AG_REG_AG_MODE_LOP__A</span><span class="p">,</span> <span class="n">AgModeLop</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* coarse gain */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_FE_AG_REG_AG_MODE_HIP__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">AgModeHip</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">AgModeHip</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">B_FE_AG_REG_AG_MODE_HIP_MODE_J__M</span><span class="p">));</span>
			<span class="n">AgModeHip</span> <span class="o">|=</span> <span class="n">B_FE_AG_REG_AG_MODE_HIP_MODE_J_DYNAMIC</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_FE_AG_REG_AG_MODE_HIP__A</span><span class="p">,</span> <span class="n">AgModeHip</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* enable fine and coarse gain, enable AAF,</span>
<span class="cm">			   no ext resistor */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_FE_AG_REG_AG_PGA_MODE__A</span><span class="p">,</span> <span class="n">B_FE_AG_REG_AG_PGA_MODE_PFY_PCY_AFY_REN</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* PGA off, bypass */</span>

			<span class="cm">/* fine gain */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_FE_AG_REG_AG_MODE_LOP__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">AgModeLop</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">AgModeLop</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">B_FE_AG_REG_AG_MODE_LOP_MODE_C__M</span><span class="p">));</span>
			<span class="n">AgModeLop</span> <span class="o">|=</span> <span class="n">B_FE_AG_REG_AG_MODE_LOP_MODE_C_STATIC</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_FE_AG_REG_AG_MODE_LOP__A</span><span class="p">,</span> <span class="n">AgModeLop</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* coarse gain */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_FE_AG_REG_AG_MODE_HIP__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">AgModeHip</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">AgModeHip</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">B_FE_AG_REG_AG_MODE_HIP_MODE_J__M</span><span class="p">));</span>
			<span class="n">AgModeHip</span> <span class="o">|=</span> <span class="n">B_FE_AG_REG_AG_MODE_HIP_MODE_J_STATIC</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_FE_AG_REG_AG_MODE_HIP__A</span><span class="p">,</span> <span class="n">AgModeHip</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* disable fine and coarse gain, enable AAF,</span>
<span class="cm">			   no ext resistor */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_FE_AG_REG_AG_PGA_MODE__A</span><span class="p">,</span> <span class="n">B_FE_AG_REG_AG_PGA_MODE_PFN_PCN_AFY_REN</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">InitFE</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">WriteTable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitFE_1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_PGA_MODE__A</span><span class="p">,</span>
					 <span class="n">FE_AG_REG_AG_PGA_MODE_PFN_PCN_AFY_REN</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">PGA</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">SetCfgPga</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">status</span> <span class="o">=</span>
				    <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_FE_AG_REG_AG_PGA_MODE__A</span><span class="p">,</span>
					    <span class="n">B_FE_AG_REG_AG_PGA_MODE_PFN_PCN_AFY_REN</span><span class="p">,</span>
					    <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_AGC_SIO__A</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_FeAgRegAgAgcSio</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_AG_REG_AG_PWD__A</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_FeAgRegAgPwd</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">WriteTable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitFE_2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">InitFT</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	   norm OFFSET,  MB says =2 voor 8K en =3 voor 2K waarschijnlijk</span>
<span class="cm">	   SC stuff</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FT_REG_COMM_EXEC__A</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SC_WaitForReady</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">curCmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DRXD_MAX_RETRIES</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_CMD__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">curCmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">curCmd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SC_SendCommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">errCode</span><span class="p">;</span>

	<span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_CMD__A</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">SC_WaitForReady</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_CMD_ADDR__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">errCode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errCode</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Command Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SC_ProcStartCommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">subCmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">param0</span><span class="p">,</span> <span class="n">u16</span> <span class="n">param1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">scExec</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_COMM_EXEC__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scExec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scExec</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">SC_WaitForReady</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_CMD_ADDR__A</span><span class="p">,</span> <span class="n">subCmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_PARAM1__A</span><span class="p">,</span> <span class="n">param1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_PARAM0__A</span><span class="p">,</span> <span class="n">param0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">SC_SendCommand</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_CMD_PROC_START</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SC_SetPrefParamCommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
				  <span class="n">u16</span> <span class="n">subCmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">param0</span><span class="p">,</span> <span class="n">u16</span> <span class="n">param1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">SC_WaitForReady</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_CMD_ADDR__A</span><span class="p">,</span> <span class="n">subCmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_PARAM1__A</span><span class="p">,</span> <span class="n">param1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_PARAM0__A</span><span class="p">,</span> <span class="n">param0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">SC_SendCommand</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_CMD_SET_PREF_PARAM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int SC_GetOpParamCommand(struct drxd_state *state, u16 * result)</span>
<span class="c">{</span>
<span class="c">	int status = 0;</span>

<span class="c">	mutex_lock(&amp;state-&gt;mutex);</span>
<span class="c">	do {</span>
<span class="c">		status = SC_WaitForReady(state);</span>
<span class="c">		if (status &lt; 0)</span>
<span class="c">			break;</span>
<span class="c">		status = SC_SendCommand(state, SC_RA_RAM_CMD_GET_OP_PARAM);</span>
<span class="c">		if (status &lt; 0)</span>
<span class="c">			break;</span>
<span class="c">		status = Read16(state, SC_RA_RAM_PARAM0__A, result, 0);</span>
<span class="c">		if (status &lt; 0)</span>
<span class="c">			break;</span>
<span class="c">	} while (0);</span>
<span class="c">	mutex_unlock(&amp;state-&gt;mutex);</span>
<span class="c">	return status;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ConfigureMPEGOutput</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bEnableOutput</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">EcOcRegIprInvMpg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">EcOcRegOcModeLop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">EcOcRegOcModeHip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">EcOcRegOcMpgSio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*CHK_ERROR(Read16(state, EC_OC_REG_OC_MODE_LOP__A, &amp;EcOcRegOcModeLop, 0)); */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">operation_mode</span> <span class="o">==</span> <span class="n">OM_DVBT_Diversity_Front</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bEnableOutput</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">EcOcRegOcModeHip</span> <span class="o">|=</span>
				    <span class="n">B_EC_OC_REG_OC_MODE_HIP_MPG_BUS_SRC_MONITOR</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">EcOcRegOcMpgSio</span> <span class="o">|=</span> <span class="n">EC_OC_REG_OC_MPG_SIO__M</span><span class="p">;</span>
			<span class="n">EcOcRegOcModeLop</span> <span class="o">|=</span>
			    <span class="n">EC_OC_REG_OC_MODE_LOP_PAR_ENA_DISABLE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">EcOcRegOcModeLop</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_EcOcRegOcModeLop</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bEnableOutput</span><span class="p">)</span>
				<span class="n">EcOcRegOcMpgSio</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">EC_OC_REG_OC_MPG_SIO__M</span><span class="p">));</span>
			<span class="k">else</span>
				<span class="n">EcOcRegOcMpgSio</span> <span class="o">|=</span> <span class="n">EC_OC_REG_OC_MPG_SIO__M</span><span class="p">;</span>

			<span class="cm">/* Don&#39;t Insert RS Byte */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">insert_rs_byte</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">EcOcRegOcModeLop</span> <span class="o">&amp;=</span>
				    <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">EC_OC_REG_OC_MODE_LOP_PAR_ENA__M</span><span class="p">));</span>
				<span class="n">EcOcRegOcModeHip</span> <span class="o">&amp;=</span>
				    <span class="p">(</span><span class="o">~</span><span class="n">EC_OC_REG_OC_MODE_HIP_MPG_PAR_VAL__M</span><span class="p">);</span>
				<span class="n">EcOcRegOcModeHip</span> <span class="o">|=</span>
				    <span class="n">EC_OC_REG_OC_MODE_HIP_MPG_PAR_VAL_ENABLE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">EcOcRegOcModeLop</span> <span class="o">|=</span>
				    <span class="n">EC_OC_REG_OC_MODE_LOP_PAR_ENA_DISABLE</span><span class="p">;</span>
				<span class="n">EcOcRegOcModeHip</span> <span class="o">&amp;=</span>
				    <span class="p">(</span><span class="o">~</span><span class="n">EC_OC_REG_OC_MODE_HIP_MPG_PAR_VAL__M</span><span class="p">);</span>
				<span class="n">EcOcRegOcModeHip</span> <span class="o">|=</span>
				    <span class="n">EC_OC_REG_OC_MODE_HIP_MPG_PAR_VAL_DISABLE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Mode = Parallel */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">enable_parallel</span><span class="p">)</span>
				<span class="n">EcOcRegOcModeLop</span> <span class="o">&amp;=</span>
				    <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">EC_OC_REG_OC_MODE_LOP_MPG_TRM_MDE__M</span><span class="p">));</span>
			<span class="k">else</span>
				<span class="n">EcOcRegOcModeLop</span> <span class="o">|=</span>
				    <span class="n">EC_OC_REG_OC_MODE_LOP_MPG_TRM_MDE_SERIAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Invert Data */</span>
		<span class="cm">/* EcOcRegIprInvMpg |= 0x00FF; */</span>
		<span class="n">EcOcRegIprInvMpg</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mh">0x00FF</span><span class="p">));</span>

		<span class="cm">/* Invert Error ( we don&#39;t use the pin ) */</span>
		<span class="cm">/*  EcOcRegIprInvMpg |= 0x0100; */</span>
		<span class="n">EcOcRegIprInvMpg</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mh">0x0100</span><span class="p">));</span>

		<span class="cm">/* Invert Start ( we don&#39;t use the pin ) */</span>
		<span class="cm">/* EcOcRegIprInvMpg |= 0x0200; */</span>
		<span class="n">EcOcRegIprInvMpg</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mh">0x0200</span><span class="p">));</span>

		<span class="cm">/* Invert Valid ( we don&#39;t use the pin ) */</span>
		<span class="cm">/* EcOcRegIprInvMpg |= 0x0400; */</span>
		<span class="n">EcOcRegIprInvMpg</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mh">0x0400</span><span class="p">));</span>

		<span class="cm">/* Invert Clock */</span>
		<span class="cm">/* EcOcRegIprInvMpg |= 0x0800; */</span>
		<span class="n">EcOcRegIprInvMpg</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mh">0x0800</span><span class="p">));</span>

		<span class="cm">/* EcOcRegOcModeLop =0x05; */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_IPR_INV_MPG__A</span><span class="p">,</span> <span class="n">EcOcRegIprInvMpg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_OC_MODE_LOP__A</span><span class="p">,</span> <span class="n">EcOcRegOcModeLop</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_OC_MODE_HIP__A</span><span class="p">,</span> <span class="n">EcOcRegOcModeHip</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OC_REG_OC_MPG_SIO__A</span><span class="p">,</span> <span class="n">EcOcRegOcMpgSio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetDeviceTypeId</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">deviceId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CC_REG_JTAGID_L__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">deviceId</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* TODO: why twice? */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CC_REG_JTAGID_L__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">deviceId</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;drxd: deviceId = %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">deviceId</span><span class="p">);</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">PGA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">diversity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">deviceId</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* on A2 only 3975 available */</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DRX3975D-A2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">deviceId</span> <span class="o">&gt;&gt;=</span> <span class="mi">12</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DRX397%dD-B1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">deviceId</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">deviceId</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">diversity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:
			<span class="k">case</span> <span class="mi">7</span>:
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">PGA</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">6</span>:
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">diversity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">5</span>:
			<span class="k">case</span> <span class="mi">8</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Init Table selection */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitAtomicRead</span> <span class="o">=</span> <span class="n">DRXD_InitAtomicRead</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitSC</span> <span class="o">=</span> <span class="n">DRXD_InitSC</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_ResetECRAM</span> <span class="o">=</span> <span class="n">DRXD_ResetECRAM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_ResetCEFR</span> <span class="o">=</span> <span class="n">DRXD_ResetCEFR</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitFE_1</span> <span class="o">=</span> <span class="n">DRXD_InitFEA2_1</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitFE_2</span> <span class="o">=</span> <span class="n">DRXD_InitFEA2_2</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitCP</span> <span class="o">=</span> <span class="n">DRXD_InitCPA2</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitCE</span> <span class="o">=</span> <span class="n">DRXD_InitCEA2</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitEQ</span> <span class="o">=</span> <span class="n">DRXD_InitEQA2</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitEC</span> <span class="o">=</span> <span class="n">DRXD_InitECA2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">load_firmware</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DRX_FW_FILENAME_A2</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_ResetCEFR</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitFE_1</span> <span class="o">=</span> <span class="n">DRXD_InitFEB1_1</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitFE_2</span> <span class="o">=</span> <span class="n">DRXD_InitFEB1_2</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitCP</span> <span class="o">=</span> <span class="n">DRXD_InitCPB1</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitCE</span> <span class="o">=</span> <span class="n">DRXD_InitCEB1</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitEQ</span> <span class="o">=</span> <span class="n">DRXD_InitEQB1</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitEC</span> <span class="o">=</span> <span class="n">DRXD_InitECB1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">load_firmware</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DRX_FW_FILENAME_B1</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">diversity</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitDiversityFront</span> <span class="o">=</span> <span class="n">DRXD_InitDiversityFront</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitDiversityEnd</span> <span class="o">=</span> <span class="n">DRXD_InitDiversityEnd</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DisableDiversity</span> <span class="o">=</span> <span class="n">DRXD_DisableDiversity</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_StartDiversityFront</span> <span class="o">=</span> <span class="n">DRXD_StartDiversityFront</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_StartDiversityEnd</span> <span class="o">=</span> <span class="n">DRXD_StartDiversityEnd</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DiversityDelay8MHZ</span> <span class="o">=</span> <span class="n">DRXD_DiversityDelay8MHZ</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DiversityDelay6MHZ</span> <span class="o">=</span> <span class="n">DRXD_DiversityDelay6MHZ</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitDiversityFront</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitDiversityEnd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DisableDiversity</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_StartDiversityFront</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_StartDiversityEnd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DiversityDelay8MHZ</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DiversityDelay6MHZ</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">CorrectSysClockDeviation</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">incr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">nomincr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bandwidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sysClockInHz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sysClockFreq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* in kHz */</span>
	<span class="n">s16</span> <span class="n">oscClockDeviation</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">Diff</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Retrieve bandwidth and incr, sanity check */</span>

		<span class="cm">/* These accesses should be AtomicReadReg32, but that</span>
<span class="cm">		   causes trouble (at least for diversity */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Read32</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">LC_RA_RAM_IFINCR_NOM_L__A</span><span class="p">,</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">nomincr</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Read32</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_IF_REG_INCR0__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">incr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">nomincr</span> <span class="o">-</span> <span class="n">incr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">500</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">nomincr</span> <span class="o">-</span> <span class="n">incr</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">nomincr</span> <span class="o">-</span> <span class="n">incr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">2000</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">nomincr</span> <span class="o">-</span> <span class="n">incr</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">bandwidth_hz</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8000000</span>:
			<span class="n">bandwidth</span> <span class="o">=</span> <span class="n">DRXD_BANDWIDTH_8MHZ_IN_HZ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">7000000</span>:
			<span class="n">bandwidth</span> <span class="o">=</span> <span class="n">DRXD_BANDWIDTH_7MHZ_IN_HZ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">6000000</span>:
			<span class="n">bandwidth</span> <span class="o">=</span> <span class="n">DRXD_BANDWIDTH_6MHZ_IN_HZ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Compute new sysclock value</span>
<span class="cm">		   sysClockFreq = (((incr + 2^23)*bandwidth)/2^21)/1000 */</span>
		<span class="n">incr</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>
		<span class="n">sysClockInHz</span> <span class="o">=</span> <span class="n">MulDiv32</span><span class="p">(</span><span class="n">incr</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">);</span>
		<span class="n">sysClockFreq</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">sysClockInHz</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="cm">/* rounding */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sysClockInHz</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span>
			<span class="n">sysClockFreq</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Compute clock deviation in ppm */</span>
		<span class="n">oscClockDeviation</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((((</span><span class="n">s32</span><span class="p">)</span> <span class="p">(</span><span class="n">sysClockFreq</span><span class="p">)</span> <span class="o">-</span>
					     <span class="p">(</span><span class="n">s32</span><span class="p">)</span>
					     <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">expected_sys_clock_freq</span><span class="p">))</span> <span class="o">*</span>
					    <span class="mi">1000000L</span><span class="p">)</span> <span class="o">/</span>
					   <span class="p">(</span><span class="n">s32</span><span class="p">)</span>
					   <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">expected_sys_clock_freq</span><span class="p">));</span>

		<span class="n">Diff</span> <span class="o">=</span> <span class="n">oscClockDeviation</span> <span class="o">-</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">osc_clock_deviation</span><span class="p">;</span>
		<span class="cm">/*printk(KERN_INFO &quot;sysclockdiff=%d\n&quot;, Diff); */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Diff</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">200</span> <span class="o">&amp;&amp;</span> <span class="n">Diff</span> <span class="o">&lt;=</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">sys_clock_freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">sysClockFreq</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">oscClockDeviation</span> <span class="o">!=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">osc_clock_deviation</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">osc_deviation</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">osc_deviation</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">,</span>
								    <span class="n">oscClockDeviation</span><span class="p">,</span>
								    <span class="mi">1</span><span class="p">);</span>
					<span class="n">state</span><span class="o">-&gt;</span><span class="n">osc_clock_deviation</span> <span class="o">=</span>
					    <span class="n">oscClockDeviation</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/* switch OFF SRMM scan in SC */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_SAMPLE_RATE_COUNT__A</span><span class="p">,</span> <span class="n">DRXD_OSCDEV_DONT_SCAN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* overrule FE_IF internal value for</span>
<span class="cm">			   proper re-locking */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_IF_SAVE__AX</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_fe_if_incr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">cscd_state</span> <span class="o">=</span> <span class="n">CSCD_SAVED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DRX_Stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">drxd_state</span> <span class="o">!=</span> <span class="n">DRXD_STARTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cscd_state</span> <span class="o">!=</span> <span class="n">CSCD_SAVED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">lock</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">DRX_GetLockStatus</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">StopOC</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">drxd_state</span> <span class="o">=</span> <span class="n">DRXD_STOPPED</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">ConfigureMPEGOutput</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Stop relevant processors off the device */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OD_REG_COMM_EXEC__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_COMM_EXEC__A</span><span class="p">,</span> <span class="n">SC_COMM_EXEC_CTL_STOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">LC_COMM_EXEC__A</span><span class="p">,</span> <span class="n">SC_COMM_EXEC_CTL_STOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Stop all processors except HI &amp; CC &amp; FE */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_SC_COMM_EXEC__A</span><span class="p">,</span> <span class="n">SC_COMM_EXEC_CTL_STOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_LC_COMM_EXEC__A</span><span class="p">,</span> <span class="n">SC_COMM_EXEC_CTL_STOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_FT_COMM_EXEC__A</span><span class="p">,</span> <span class="n">SC_COMM_EXEC_CTL_STOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_CP_COMM_EXEC__A</span><span class="p">,</span> <span class="n">SC_COMM_EXEC_CTL_STOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_CE_COMM_EXEC__A</span><span class="p">,</span> <span class="n">SC_COMM_EXEC_CTL_STOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_EQ_COMM_EXEC__A</span><span class="p">,</span> <span class="n">SC_COMM_EXEC_CTL_STOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_OD_REG_COMM_EXEC__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">SetOperationMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oMode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">drxd_state</span> <span class="o">!=</span> <span class="n">DRXD_STOPPED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">oMode</span> <span class="o">==</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">operation_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">oMode</span> <span class="o">!=</span> <span class="n">OM_Default</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">diversity</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">oMode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OM_DVBT_Diversity_Front</span>:
			<span class="n">status</span> <span class="o">=</span> <span class="n">WriteTable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitDiversityFront</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OM_DVBT_Diversity_End</span>:
			<span class="n">status</span> <span class="o">=</span> <span class="n">WriteTable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_InitDiversityEnd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OM_Default</span>:
			<span class="cm">/* We need to check how to</span>
<span class="cm">			   get DRXD out of diversity */</span>
		<span class="nl">default:</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">WriteTable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DisableDiversity</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">operation_mode</span> <span class="o">=</span> <span class="n">oMode</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">StartDiversity</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rcControl</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">operation_mode</span> <span class="o">==</span> <span class="n">OM_DVBT_Diversity_Front</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">WriteTable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_StartDiversityFront</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">operation_mode</span> <span class="o">==</span> <span class="n">OM_DVBT_Diversity_End</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">WriteTable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_StartDiversityEnd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">bandwidth_hz</span> <span class="o">==</span> <span class="mi">8000000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">WriteTable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DiversityDelay8MHZ</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">WriteTable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_DiversityDelay6MHZ</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_EQ_REG_RC_SEL_CAR__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rcControl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">rcControl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">B_EQ_REG_RC_SEL_CAR_FFTMODE__M</span><span class="p">);</span>
			<span class="n">rcControl</span> <span class="o">|=</span> <span class="n">B_EQ_REG_RC_SEL_CAR_DIV_ON</span> <span class="o">|</span>
			    <span class="cm">/*  combining enabled */</span>
			    <span class="n">B_EQ_REG_RC_SEL_CAR_MEAS_A_CC</span> <span class="o">|</span>
			    <span class="n">B_EQ_REG_RC_SEL_CAR_PASS_A_CC</span> <span class="o">|</span>
			    <span class="n">B_EQ_REG_RC_SEL_CAR_LOCAL_A_CC</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_EQ_REG_RC_SEL_CAR__A</span><span class="p">,</span> <span class="n">rcControl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetFrequencyShift</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">offsetFreq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channelMirrored</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">negativeShift</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_mirrors</span> <span class="o">==</span> <span class="n">channelMirrored</span><span class="p">);</span>

	<span class="cm">/* Handle all mirroring</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note: ADC mirroring (aliasing) is implictly handled by limiting</span>
<span class="cm">	 * feFsRegAddInc to 28 bits below</span>
<span class="cm">	 * (if the result before masking is more than 28 bits, this means</span>
<span class="cm">	 *  that the ADC is mirroring.</span>
<span class="cm">	 * The masking is in fact the aliasing of the ADC)</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>

	<span class="cm">/* Compute register value, unsigned computation */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe_fs_add_incr</span> <span class="o">=</span> <span class="n">MulDiv32</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">intermediate_freq</span> <span class="o">+</span>
					 <span class="n">offsetFreq</span><span class="p">,</span>
					 <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">sys_clock_freq</span><span class="p">);</span>
	<span class="cm">/* Remove integer part */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe_fs_add_incr</span> <span class="o">&amp;=</span> <span class="mh">0x0FFFFFFFL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">negativeShift</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe_fs_add_incr</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">-</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe_fs_add_incr</span><span class="p">);</span>

	<span class="cm">/* Save the frequency shift without tunerOffset compensation</span>
<span class="cm">	   for CtrlGetChannel. */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">org_fe_fs_add_incr</span> <span class="o">=</span> <span class="n">MulDiv32</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">intermediate_freq</span><span class="p">,</span>
					     <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">sys_clock_freq</span><span class="p">);</span>
	<span class="cm">/* Remove integer part */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">org_fe_fs_add_incr</span> <span class="o">&amp;=</span> <span class="mh">0x0FFFFFFFL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">negativeShift</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">org_fe_fs_add_incr</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">-</span>
					     <span class="n">state</span><span class="o">-&gt;</span><span class="n">org_fe_fs_add_incr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">Write32</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_FS_REG_ADD_INC_LOP__A</span><span class="p">,</span>
		       <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe_fs_add_incr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">SetCfgNoiseCalibration</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">SNoiseCal</span> <span class="o">*</span><span class="n">noiseCal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">beOptEna</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_BE_OPT_ENA__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">beOptEna</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">noiseCal</span><span class="o">-&gt;</span><span class="n">cpOpt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">beOptEna</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SC_RA_RAM_BE_OPT_ENA_CP_OPT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">beOptEna</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SC_RA_RAM_BE_OPT_ENA_CP_OPT</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">CP_REG_AC_NEXP_OFFS__A</span><span class="p">,</span> <span class="n">noiseCal</span><span class="o">-&gt;</span><span class="n">cpNexpOfs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_BE_OPT_ENA__A</span><span class="p">,</span> <span class="n">beOptEna</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_SC_RA_RAM_CO_TD_CAL_2K__A</span><span class="p">,</span> <span class="n">noiseCal</span><span class="o">-&gt;</span><span class="n">tdCal2k</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">B_SC_RA_RAM_CO_TD_CAL_8K__A</span><span class="p">,</span> <span class="n">noiseCal</span><span class="o">-&gt;</span><span class="n">tdCal8k</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">DRX_Start</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">s32</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">transmissionParams</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">operationMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">qpskTdTpsPwr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">qam16TdTpsPwr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">qam64TdTpsPwr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">feIfIncr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bandwidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mirrorFreqSpect</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">qpskSnCeGain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">qam16SnCeGain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">qam64SnCeGain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">qpskIsGainMan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">qam16IsGainMan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">qam64IsGainMan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">qpskIsGainExp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">qam16IsGainExp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">qam64IsGainExp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bandwidthParam</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">off</span> <span class="o">=</span> <span class="p">(</span><span class="n">off</span> <span class="o">-</span> <span class="mi">500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">off</span> <span class="o">=</span> <span class="p">(</span><span class="n">off</span> <span class="o">+</span> <span class="mi">500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">drxd_state</span> <span class="o">!=</span> <span class="n">DRXD_STOPPED</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ResetECOD</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">InitSC</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">InitFT</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">InitCP</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">InitCE</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">InitEQ</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">InitSC</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Restore current IF &amp; RF AGC settings */</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">SetCfgIfAgc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">SetCfgRfAgc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_agc_cfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">mirrorFreqSpect</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">inversion</span> <span class="o">==</span> <span class="n">INVERSION_ON</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">transmission_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>	<span class="cm">/* Not set, detect it automatically */</span>
			<span class="n">operationMode</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_AUTO_MODE__M</span><span class="p">;</span>
			<span class="cm">/* fall through , try first guess DRX_FFTMODE_8K */</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_8K</span>:
			<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_PARAM_MODE_8K</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_SB_REG_TR_MODE__A</span><span class="p">,</span> <span class="n">EC_SB_REG_TR_MODE_8K</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">qpskSnCeGain</span> <span class="o">=</span> <span class="mi">99</span><span class="p">;</span>
				<span class="n">qam16SnCeGain</span> <span class="o">=</span> <span class="mi">83</span><span class="p">;</span>
				<span class="n">qam64SnCeGain</span> <span class="o">=</span> <span class="mi">67</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TRANSMISSION_MODE_2K</span>:
			<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_PARAM_MODE_2K</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_SB_REG_TR_MODE__A</span><span class="p">,</span> <span class="n">EC_SB_REG_TR_MODE_2K</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">qpskSnCeGain</span> <span class="o">=</span> <span class="mi">97</span><span class="p">;</span>
				<span class="n">qam16SnCeGain</span> <span class="o">=</span> <span class="mi">71</span><span class="p">;</span>
				<span class="n">qam64SnCeGain</span> <span class="o">=</span> <span class="mi">65</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">guard_interval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_4</span>:
			<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_PARAM_GUARD_4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_8</span>:
			<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_PARAM_GUARD_8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_16</span>:
			<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_PARAM_GUARD_16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_32</span>:
			<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_PARAM_GUARD_32</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="cm">/* Not set, detect it automatically */</span>
			<span class="n">operationMode</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_AUTO_GUARD__M</span><span class="p">;</span>
			<span class="cm">/* try first guess 1/4 */</span>
			<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_PARAM_GUARD_4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">hierarchy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HIERARCHY_1</span>:
			<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_PARAM_HIER_A1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EQ_REG_OT_ALPHA__A</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_SB_REG_ALPHA__A</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="n">qpskTdTpsPwr</span> <span class="o">=</span> <span class="n">EQ_TD_TPS_PWR_UNKNOWN</span><span class="p">;</span>
				<span class="n">qam16TdTpsPwr</span> <span class="o">=</span> <span class="n">EQ_TD_TPS_PWR_QAM16_ALPHA1</span><span class="p">;</span>
				<span class="n">qam64TdTpsPwr</span> <span class="o">=</span> <span class="n">EQ_TD_TPS_PWR_QAM64_ALPHA1</span><span class="p">;</span>

				<span class="n">qpskIsGainMan</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_UNKNOWN_MAN__PRE</span><span class="p">;</span>
				<span class="n">qam16IsGainMan</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_16QAM_MAN__PRE</span><span class="p">;</span>
				<span class="n">qam64IsGainMan</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_64QAM_MAN__PRE</span><span class="p">;</span>

				<span class="n">qpskIsGainExp</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_UNKNOWN_EXP__PRE</span><span class="p">;</span>
				<span class="n">qam16IsGainExp</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_16QAM_EXP__PRE</span><span class="p">;</span>
				<span class="n">qam64IsGainExp</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_64QAM_EXP__PRE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">HIERARCHY_2</span>:
			<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_PARAM_HIER_A2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EQ_REG_OT_ALPHA__A</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_SB_REG_ALPHA__A</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="n">qpskTdTpsPwr</span> <span class="o">=</span> <span class="n">EQ_TD_TPS_PWR_UNKNOWN</span><span class="p">;</span>
				<span class="n">qam16TdTpsPwr</span> <span class="o">=</span> <span class="n">EQ_TD_TPS_PWR_QAM16_ALPHA2</span><span class="p">;</span>
				<span class="n">qam64TdTpsPwr</span> <span class="o">=</span> <span class="n">EQ_TD_TPS_PWR_QAM64_ALPHA2</span><span class="p">;</span>

				<span class="n">qpskIsGainMan</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_UNKNOWN_MAN__PRE</span><span class="p">;</span>
				<span class="n">qam16IsGainMan</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_16QAM_A2_MAN__PRE</span><span class="p">;</span>
				<span class="n">qam64IsGainMan</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_64QAM_A2_MAN__PRE</span><span class="p">;</span>

				<span class="n">qpskIsGainExp</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_UNKNOWN_EXP__PRE</span><span class="p">;</span>
				<span class="n">qam16IsGainExp</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_16QAM_A2_EXP__PRE</span><span class="p">;</span>
				<span class="n">qam64IsGainExp</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_64QAM_A2_EXP__PRE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HIERARCHY_4</span>:
			<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_PARAM_HIER_A4</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EQ_REG_OT_ALPHA__A</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_SB_REG_ALPHA__A</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="n">qpskTdTpsPwr</span> <span class="o">=</span> <span class="n">EQ_TD_TPS_PWR_UNKNOWN</span><span class="p">;</span>
				<span class="n">qam16TdTpsPwr</span> <span class="o">=</span> <span class="n">EQ_TD_TPS_PWR_QAM16_ALPHA4</span><span class="p">;</span>
				<span class="n">qam64TdTpsPwr</span> <span class="o">=</span> <span class="n">EQ_TD_TPS_PWR_QAM64_ALPHA4</span><span class="p">;</span>

				<span class="n">qpskIsGainMan</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_UNKNOWN_MAN__PRE</span><span class="p">;</span>
				<span class="n">qam16IsGainMan</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_16QAM_A4_MAN__PRE</span><span class="p">;</span>
				<span class="n">qam64IsGainMan</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_64QAM_A4_MAN__PRE</span><span class="p">;</span>

				<span class="n">qpskIsGainExp</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_UNKNOWN_EXP__PRE</span><span class="p">;</span>
				<span class="n">qam16IsGainExp</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_16QAM_A4_EXP__PRE</span><span class="p">;</span>
				<span class="n">qam64IsGainExp</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_64QAM_A4_EXP__PRE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HIERARCHY_AUTO</span>:
		<span class="nl">default:</span>
			<span class="cm">/* Not set, detect it automatically, start with none */</span>
			<span class="n">operationMode</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_AUTO_HIER__M</span><span class="p">;</span>
			<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_PARAM_HIER_NO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EQ_REG_OT_ALPHA__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_SB_REG_ALPHA__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="n">qpskTdTpsPwr</span> <span class="o">=</span> <span class="n">EQ_TD_TPS_PWR_QPSK</span><span class="p">;</span>
				<span class="n">qam16TdTpsPwr</span> <span class="o">=</span> <span class="n">EQ_TD_TPS_PWR_QAM16_ALPHAN</span><span class="p">;</span>
				<span class="n">qam64TdTpsPwr</span> <span class="o">=</span> <span class="n">EQ_TD_TPS_PWR_QAM64_ALPHAN</span><span class="p">;</span>

				<span class="n">qpskIsGainMan</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_QPSK_MAN__PRE</span><span class="p">;</span>
				<span class="n">qam16IsGainMan</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_16QAM_MAN__PRE</span><span class="p">;</span>
				<span class="n">qam64IsGainMan</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_64QAM_MAN__PRE</span><span class="p">;</span>

				<span class="n">qpskIsGainExp</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_QPSK_EXP__PRE</span><span class="p">;</span>
				<span class="n">qam16IsGainExp</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_16QAM_EXP__PRE</span><span class="p">;</span>
				<span class="n">qam64IsGainExp</span> <span class="o">=</span>
				    <span class="n">SC_RA_RAM_EQ_IS_GAIN_64QAM_EXP__PRE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="n">operationMode</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_AUTO_CONST__M</span><span class="p">;</span>
			<span class="cm">/* fall through , try first guess</span>
<span class="cm">			   DRX_CONSTELLATION_QAM64 */</span>
		<span class="k">case</span> <span class="n">QAM_64</span>:
			<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_PARAM_CONST_QAM64</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EQ_REG_OT_CONST__A</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_SB_REG_CONST__A</span><span class="p">,</span> <span class="n">EC_SB_REG_CONST_64QAM</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_SB_REG_SCALE_MSB__A</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_SB_REG_SCALE_BIT2__A</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_SB_REG_SCALE_LSB__A</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EQ_REG_TD_TPS_PWR_OFS__A</span><span class="p">,</span> <span class="n">qam64TdTpsPwr</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EQ_REG_SN_CEGAIN__A</span><span class="p">,</span> <span class="n">qam64SnCeGain</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EQ_REG_IS_GAIN_MAN__A</span><span class="p">,</span> <span class="n">qam64IsGainMan</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EQ_REG_IS_GAIN_EXP__A</span><span class="p">,</span> <span class="n">qam64IsGainExp</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QPSK</span>:
			<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_PARAM_CONST_QPSK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EQ_REG_OT_CONST__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_SB_REG_CONST__A</span><span class="p">,</span> <span class="n">EC_SB_REG_CONST_QPSK</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_SB_REG_SCALE_MSB__A</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_SB_REG_SCALE_BIT2__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_SB_REG_SCALE_LSB__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EQ_REG_TD_TPS_PWR_OFS__A</span><span class="p">,</span> <span class="n">qpskTdTpsPwr</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EQ_REG_SN_CEGAIN__A</span><span class="p">,</span> <span class="n">qpskSnCeGain</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EQ_REG_IS_GAIN_MAN__A</span><span class="p">,</span> <span class="n">qpskIsGainMan</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EQ_REG_IS_GAIN_EXP__A</span><span class="p">,</span> <span class="n">qpskIsGainExp</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">QAM_16</span>:
			<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_PARAM_CONST_QAM16</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EQ_REG_OT_CONST__A</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_SB_REG_CONST__A</span><span class="p">,</span> <span class="n">EC_SB_REG_CONST_16QAM</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_SB_REG_SCALE_MSB__A</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_SB_REG_SCALE_BIT2__A</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_SB_REG_SCALE_LSB__A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EQ_REG_TD_TPS_PWR_OFS__A</span><span class="p">,</span> <span class="n">qam16TdTpsPwr</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EQ_REG_SN_CEGAIN__A</span><span class="p">,</span> <span class="n">qam16SnCeGain</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EQ_REG_IS_GAIN_MAN__A</span><span class="p">,</span> <span class="n">qam16IsGainMan</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EQ_REG_IS_GAIN_EXP__A</span><span class="p">,</span> <span class="n">qam16IsGainExp</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">DRX_CHANNEL_HIGH</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">DRX_CHANNEL_AUTO</span>:
		<span class="k">case</span> <span class="n">DRX_CHANNEL_LOW</span>:
			<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_PARAM_PRIO_LO</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_SB_REG_PRIOR__A</span><span class="p">,</span> <span class="n">EC_SB_REG_PRIOR_LO</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DRX_CHANNEL_HIGH</span>:
			<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_PARAM_PRIO_HI</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_SB_REG_PRIOR__A</span><span class="p">,</span> <span class="n">EC_SB_REG_PRIOR_HI</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FEC_1_2</span>:
			<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_PARAM_RATE_1_2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_VD_REG_SET_CODERATE__A</span><span class="p">,</span> <span class="n">EC_VD_REG_SET_CODERATE_C1_2</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">operationMode</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_AUTO_RATE__M</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FEC_2_3</span>:
			<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_PARAM_RATE_2_3</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_VD_REG_SET_CODERATE__A</span><span class="p">,</span> <span class="n">EC_VD_REG_SET_CODERATE_C2_3</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FEC_3_4</span>:
			<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_PARAM_RATE_3_4</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_VD_REG_SET_CODERATE__A</span><span class="p">,</span> <span class="n">EC_VD_REG_SET_CODERATE_C3_4</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FEC_5_6</span>:
			<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_PARAM_RATE_5_6</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_VD_REG_SET_CODERATE__A</span><span class="p">,</span> <span class="n">EC_VD_REG_SET_CODERATE_C5_6</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FEC_7_8</span>:
			<span class="n">transmissionParams</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_OP_PARAM_RATE_7_8</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EC_VD_REG_SET_CODERATE__A</span><span class="p">,</span> <span class="n">EC_VD_REG_SET_CODERATE_C7_8</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* First determine real bandwidth (Hz) */</span>
		<span class="cm">/* Also set delay for impulse noise cruncher (only A2) */</span>
		<span class="cm">/* Also set parameters for EC_OC fix, note</span>
<span class="cm">		   EC_OC_REG_TMD_HIL_MAR is changed</span>
<span class="cm">		   by SC for fix for some 8K,1/8 guard but is restored by</span>
<span class="cm">		   InitEC and ResetEC</span>
<span class="cm">		   functions */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">8000000</span><span class="p">;</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="mi">8000000</span>:
			<span class="cm">/* (64/7)*(8/8)*1000000 */</span>
			<span class="n">bandwidth</span> <span class="o">=</span> <span class="n">DRXD_BANDWIDTH_8MHZ_IN_HZ</span><span class="p">;</span>

			<span class="n">bandwidthParam</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
					 <span class="n">FE_AG_REG_IND_DEL__A</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">7000000</span>:
			<span class="cm">/* (64/7)*(7/8)*1000000 */</span>
			<span class="n">bandwidth</span> <span class="o">=</span> <span class="n">DRXD_BANDWIDTH_7MHZ_IN_HZ</span><span class="p">;</span>
			<span class="n">bandwidthParam</span> <span class="o">=</span> <span class="mh">0x4807</span><span class="p">;</span>	<span class="cm">/*binary:0100 1000 0000 0111 */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
					 <span class="n">FE_AG_REG_IND_DEL__A</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">6000000</span>:
			<span class="cm">/* (64/7)*(6/8)*1000000 */</span>
			<span class="n">bandwidth</span> <span class="o">=</span> <span class="n">DRXD_BANDWIDTH_6MHZ_IN_HZ</span><span class="p">;</span>
			<span class="n">bandwidthParam</span> <span class="o">=</span> <span class="mh">0x0F07</span><span class="p">;</span>	<span class="cm">/*binary: 0000 1111 0000 0111 */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
					 <span class="n">FE_AG_REG_IND_DEL__A</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_BAND__A</span><span class="p">,</span> <span class="n">bandwidthParam</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="p">{</span>
			<span class="n">u16</span> <span class="n">sc_config</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_CONFIG__A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc_config</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* enable SLAVE mode in 2k 1/32 to</span>
<span class="cm">			   prevent timing change glitches */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">==</span> <span class="n">TRANSMISSION_MODE_2K</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">==</span> <span class="n">GUARD_INTERVAL_1_32</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* enable slave */</span>
				<span class="n">sc_config</span> <span class="o">|=</span> <span class="n">SC_RA_RAM_CONFIG_SLAVE__M</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* disable slave */</span>
				<span class="n">sc_config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC_RA_RAM_CONFIG_SLAVE__M</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_CONFIG__A</span><span class="p">,</span> <span class="n">sc_config</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">SetCfgNoiseCalibration</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">noise_cal</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cscd_state</span> <span class="o">==</span> <span class="n">CSCD_INIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* switch on SRMM scan in SC */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_SAMPLE_RATE_COUNT__A</span><span class="p">,</span> <span class="n">DRXD_OSCDEV_DO_SCAN</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
<span class="cm">/*            CHK_ERROR(Write16(SC_RA_RAM_SAMPLE_RATE_STEP__A, DRXD_OSCDEV_STEP, 0x0000));*/</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">cscd_state</span> <span class="o">=</span> <span class="n">CSCD_SET</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Now compute FE_IF_REG_INCR */</span>
		<span class="cm">/*((( SysFreq/BandWidth)/2)/2) -1) * 2^23) =&gt;</span>
<span class="cm">		   ((SysFreq / BandWidth) * (2^21) ) - (2^23) */</span>
		<span class="n">feIfIncr</span> <span class="o">=</span> <span class="n">MulDiv32</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">sys_clock_freq</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>
				    <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">),</span> <span class="n">bandwidth</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_IF_REG_INCR0__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">feIfIncr</span> <span class="o">&amp;</span> <span class="n">FE_IF_REG_INCR0__M</span><span class="p">),</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">FE_IF_REG_INCR1__A</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">feIfIncr</span> <span class="o">&gt;&gt;</span> <span class="n">FE_IF_REG_INCR0__W</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FE_IF_REG_INCR1__M</span><span class="p">),</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Bandwidth setting done */</span>

		<span class="cm">/* Mirror &amp; frequency offset */</span>
		<span class="n">SetFrequencyShift</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">mirrorFreqSpect</span><span class="p">);</span>

		<span class="cm">/* Start SC, write channel settings to SC */</span>

		<span class="cm">/* Enable SC after setting all other parameters */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_COMM_STATE__A</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_COMM_EXEC__A</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Write SC parameter registers, operation mode */</span>
<span class="cp">#if 1</span>
		<span class="n">operationMode</span> <span class="o">=</span> <span class="p">(</span><span class="n">SC_RA_RAM_OP_AUTO_MODE__M</span> <span class="o">|</span>
				 <span class="n">SC_RA_RAM_OP_AUTO_GUARD__M</span> <span class="o">|</span>
				 <span class="n">SC_RA_RAM_OP_AUTO_CONST__M</span> <span class="o">|</span>
				 <span class="n">SC_RA_RAM_OP_AUTO_HIER__M</span> <span class="o">|</span>
				 <span class="n">SC_RA_RAM_OP_AUTO_RATE__M</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">SC_SetPrefParamCommand</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">transmissionParams</span><span class="p">,</span> <span class="n">operationMode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Start correct processes to get in lock */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">SC_ProcStartCommand</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_PROC_LOCKTRACK</span><span class="p">,</span> <span class="n">SC_RA_RAM_SW_EVENT_RUN_NMASK__M</span><span class="p">,</span> <span class="n">SC_RA_RAM_LOCKTRACK_MIN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">StartOC</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">operation_mode</span> <span class="o">!=</span> <span class="n">OM_Default</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">StartDiversity</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">drxd_state</span> <span class="o">=</span> <span class="n">DRXD_STARTED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">CDRXD</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">IntermediateFrequency</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ulRfAgcOutputLevel</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulRfAgcSettleLevel</span> <span class="o">=</span> <span class="mi">528</span><span class="p">;</span>	<span class="cm">/* Optimum value for MT2060 */</span>
	<span class="n">u32</span> <span class="n">ulRfAgcMinLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Currently unused */</span>
	<span class="n">u32</span> <span class="n">ulRfAgcMaxLevel</span> <span class="o">=</span> <span class="n">DRXD_FE_CTRL_MAX</span><span class="p">;</span>	<span class="cm">/* Currently unused */</span>
	<span class="n">u32</span> <span class="n">ulRfAgcSpeed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Currently unused */</span>
	<span class="n">u32</span> <span class="n">ulRfAgcMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*2;   Off */</span>
	<span class="n">u32</span> <span class="n">ulRfAgcR1</span> <span class="o">=</span> <span class="mi">820</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulRfAgcR2</span> <span class="o">=</span> <span class="mi">2200</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulRfAgcR3</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulIfAgcMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Auto */</span>
	<span class="n">u32</span> <span class="n">ulIfAgcOutputLevel</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulIfAgcSettleLevel</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulIfAgcMinLevel</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulIfAgcMaxLevel</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulIfAgcSpeed</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulIfAgcR1</span> <span class="o">=</span> <span class="mi">820</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulIfAgcR2</span> <span class="o">=</span> <span class="mi">2200</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulIfAgcR3</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulClock</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">clock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulSerialMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulEcOcRegOcModeLop</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* Dynamic DTO source */</span>
	<span class="n">u32</span> <span class="n">ulHiI2cDelay</span> <span class="o">=</span> <span class="n">HI_I2C_DELAY</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulHiI2cBridgeDelay</span> <span class="o">=</span> <span class="n">HI_I2C_BRIDGE_DELAY</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulHiI2cPatch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulEnvironment</span> <span class="o">=</span> <span class="n">APPENV_PORTABLE</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulEnvironmentDiversity</span> <span class="o">=</span> <span class="n">APPENV_MOBILE</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ulIFFilter</span> <span class="o">=</span> <span class="n">IFFILTER_SAW</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">.</span><span class="n">ctrlMode</span> <span class="o">=</span> <span class="n">AGC_CTRL_AUTO</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">.</span><span class="n">outputLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">.</span><span class="n">settleLevel</span> <span class="o">=</span> <span class="mi">140</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">.</span><span class="n">minOutputLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">.</span><span class="n">maxOutputLevel</span> <span class="o">=</span> <span class="mi">1023</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">904</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ulIfAgcMode</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ulIfAgcOutputLevel</span> <span class="o">&lt;=</span> <span class="n">DRXD_FE_CTRL_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">.</span><span class="n">ctrlMode</span> <span class="o">=</span> <span class="n">AGC_CTRL_USER</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">.</span><span class="n">outputLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ulIfAgcOutputLevel</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ulIfAgcMode</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ulIfAgcSettleLevel</span> <span class="o">&lt;=</span> <span class="n">DRXD_FE_CTRL_MAX</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ulIfAgcMinLevel</span> <span class="o">&lt;=</span> <span class="n">DRXD_FE_CTRL_MAX</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ulIfAgcMaxLevel</span> <span class="o">&lt;=</span> <span class="n">DRXD_FE_CTRL_MAX</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ulIfAgcSpeed</span> <span class="o">&lt;=</span> <span class="n">DRXD_FE_CTRL_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">.</span><span class="n">ctrlMode</span> <span class="o">=</span> <span class="n">AGC_CTRL_AUTO</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">.</span><span class="n">settleLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ulIfAgcSettleLevel</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">.</span><span class="n">minOutputLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ulIfAgcMinLevel</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">.</span><span class="n">maxOutputLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ulIfAgcMaxLevel</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ulIfAgcSpeed</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">.</span><span class="n">R1</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ulIfAgcR1</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">.</span><span class="n">R2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ulIfAgcR2</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">.</span><span class="n">R3</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ulIfAgcR3</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_agc_cfg</span><span class="p">.</span><span class="n">R1</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ulRfAgcR1</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_agc_cfg</span><span class="p">.</span><span class="n">R2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ulRfAgcR2</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_agc_cfg</span><span class="p">.</span><span class="n">R3</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ulRfAgcR3</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_agc_cfg</span><span class="p">.</span><span class="n">ctrlMode</span> <span class="o">=</span> <span class="n">AGC_CTRL_AUTO</span><span class="p">;</span>
	<span class="cm">/* rest of the RFAgcCfg structure currently unused */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ulRfAgcMode</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ulRfAgcOutputLevel</span> <span class="o">&lt;=</span> <span class="n">DRXD_FE_CTRL_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_agc_cfg</span><span class="p">.</span><span class="n">ctrlMode</span> <span class="o">=</span> <span class="n">AGC_CTRL_USER</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_agc_cfg</span><span class="p">.</span><span class="n">outputLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ulRfAgcOutputLevel</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ulRfAgcMode</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ulRfAgcSettleLevel</span> <span class="o">&lt;=</span> <span class="n">DRXD_FE_CTRL_MAX</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ulRfAgcMinLevel</span> <span class="o">&lt;=</span> <span class="n">DRXD_FE_CTRL_MAX</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ulRfAgcMaxLevel</span> <span class="o">&lt;=</span> <span class="n">DRXD_FE_CTRL_MAX</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ulRfAgcSpeed</span> <span class="o">&lt;=</span> <span class="n">DRXD_FE_CTRL_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_agc_cfg</span><span class="p">.</span><span class="n">ctrlMode</span> <span class="o">=</span> <span class="n">AGC_CTRL_AUTO</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_agc_cfg</span><span class="p">.</span><span class="n">settleLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ulRfAgcSettleLevel</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_agc_cfg</span><span class="p">.</span><span class="n">minOutputLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ulRfAgcMinLevel</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_agc_cfg</span><span class="p">.</span><span class="n">maxOutputLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ulRfAgcMaxLevel</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_agc_cfg</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ulRfAgcSpeed</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ulRfAgcMode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_agc_cfg</span><span class="p">.</span><span class="n">ctrlMode</span> <span class="o">=</span> <span class="n">AGC_CTRL_OFF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ulEnvironment</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">app_env_default</span> <span class="o">=</span> <span class="p">(</span><span class="k">enum</span> <span class="n">app_env</span><span class="p">)</span>
		    <span class="p">(</span><span class="n">ulEnvironment</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ulEnvironmentDiversity</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">app_env_diversity</span> <span class="o">=</span> <span class="p">(</span><span class="k">enum</span> <span class="n">app_env</span><span class="p">)</span>
		    <span class="p">(</span><span class="n">ulEnvironmentDiversity</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ulIFFilter</span> <span class="o">==</span> <span class="n">IFFILTER_DISCRETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* discrete filter */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">noise_cal</span><span class="p">.</span><span class="n">cpOpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">noise_cal</span><span class="p">.</span><span class="n">cpNexpOfs</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">noise_cal</span><span class="p">.</span><span class="n">tdCal2k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">40</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">noise_cal</span><span class="p">.</span><span class="n">tdCal8k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">24</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* SAW filter */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">noise_cal</span><span class="p">.</span><span class="n">cpOpt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">noise_cal</span><span class="p">.</span><span class="n">cpNexpOfs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">noise_cal</span><span class="p">.</span><span class="n">tdCal2k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">21</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">noise_cal</span><span class="p">.</span><span class="n">tdCal8k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">24</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_EcOcRegOcModeLop</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ulEcOcRegOcModeLop</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">chip_adr</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">demod_address</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ulHiI2cPatch</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HiI2cPatch</span> <span class="o">=</span> <span class="n">DRXD_HiI2cPatch_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HiI2cPatch</span> <span class="o">=</span> <span class="n">DRXD_HiI2cPatch_3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HiI2cPatch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* modify tuner and clock attributes */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">intermediate_freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">IntermediateFrequency</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="cm">/* expected system clock frequency in kHz */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">expected_sys_clock_freq</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="cm">/* real system clock frequency in kHz */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">sys_clock_freq</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">osc_clock_freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">ulClock</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">osc_clock_deviation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">cscd_state</span> <span class="o">=</span> <span class="n">CSCD_INIT</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">drxd_state</span> <span class="o">=</span> <span class="n">DRXD_UNINITIALIZED</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">PGA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_mirrors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* modify MPEG output attributes */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">insert_rs_byte</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">insert_rs_byte</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">enable_parallel</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulSerialMode</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Timing div, 250ns/Psys */</span>
	<span class="cm">/* Timing div, = ( delay (nano seconds) * sysclk (kHz) )/ 1000 */</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">hi_cfg_timing_div</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">sys_clock_freq</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span>
					  <span class="n">ulHiI2cDelay</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="cm">/* Bridge delay, uses oscilator clock */</span>
	<span class="cm">/* Delay = ( delay (nano seconds) * oscclk (kHz) )/ 1000 */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">hi_cfg_bridge_delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">osc_clock_freq</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span>
					    <span class="n">ulHiI2cBridgeDelay</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_FeAgRegAgPwd</span> <span class="o">=</span> <span class="n">DRXD_DEF_AG_PWD_CONSUMER</span><span class="p">;</span>
	<span class="cm">/* state-&gt;m_FeAgRegAgPwd = DRXD_DEF_AG_PWD_PRO; */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_FeAgRegAgAgcSio</span> <span class="o">=</span> <span class="n">DRXD_DEF_AG_AGC_SIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">DRXD_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">fw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">fw_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">driverVersion</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">init_done</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">CDRXD</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">IF</span> <span class="o">?</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">IF</span> <span class="o">:</span> <span class="mi">36000000</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">operation_mode</span> <span class="o">=</span> <span class="n">OM_Default</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">SetDeviceTypeId</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Apply I2c address patch to B1 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HiI2cPatch</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">WriteTable</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">m_HiI2cPatch</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* HI firmware patch for UIO readout,</span>
<span class="cm">			   avoid clearing of result register */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x43012D</span><span class="p">,</span> <span class="mh">0x047f</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">HI_ResetCommand</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">StopAllProcessors</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">InitCC</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">osc_clock_deviation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">osc_deviation</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">osc_clock_deviation</span> <span class="o">=</span>
			    <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">osc_deviation</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">{</span>
			<span class="cm">/* Handle clock deviation */</span>
			<span class="n">s32</span> <span class="n">devB</span><span class="p">;</span>
			<span class="n">s32</span> <span class="n">devA</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">osc_clock_deviation</span><span class="p">)</span> <span class="o">*</span>
			    <span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">expected_sys_clock_freq</span><span class="p">);</span>
			<span class="cm">/* deviation in kHz */</span>
			<span class="n">s32</span> <span class="n">deviation</span> <span class="o">=</span> <span class="p">(</span><span class="n">devA</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000000L</span><span class="p">));</span>
			<span class="cm">/* rounding, signed */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devA</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">devB</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">devB</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">devB</span> <span class="o">*</span> <span class="p">(</span><span class="n">devA</span> <span class="o">%</span> <span class="mi">1000000L</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000000L</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* add +1 or -1 */</span>
				<span class="n">deviation</span> <span class="o">+=</span> <span class="p">(</span><span class="n">devB</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">state</span><span class="o">-&gt;</span><span class="n">sys_clock_freq</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">expected_sys_clock_freq</span><span class="p">)</span> <span class="o">+</span>
				   <span class="n">deviation</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">InitHI</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">InitAtomicRead</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">EnableAndResetMB</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">type_A</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ResetCEFR</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">DownloadMicrocode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">fw</span><span class="p">,</span> <span class="n">fw_size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">DownloadMicrocode</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">microcode</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">microcode_length</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">PGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_FeAgRegAgPwd</span> <span class="o">=</span> <span class="n">DRXD_DEF_AG_PWD_PRO</span><span class="p">;</span>
			<span class="n">SetCfgPga</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* PGA = 0 dB */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_FeAgRegAgPwd</span> <span class="o">=</span> <span class="n">DRXD_DEF_AG_PWD_CONSUMER</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">m_FeAgRegAgAgcSio</span> <span class="o">=</span> <span class="n">DRXD_DEF_AG_AGC_SIO</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">InitFE</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">InitFT</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">InitCP</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">InitCE</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">InitEQ</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">InitEC</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">InitSC</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">SetCfgIfAgc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">if_agc_cfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">SetCfgRfAgc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_agc_cfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">cscd_state</span> <span class="o">=</span> <span class="n">CSCD_INIT</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_COMM_EXEC__A</span><span class="p">,</span> <span class="n">SC_COMM_EXEC_CTL_STOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">Write16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">LC_COMM_EXEC__A</span><span class="p">,</span> <span class="n">SC_COMM_EXEC_CTL_STOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">driverVersion</span> <span class="o">=</span> <span class="p">(((</span><span class="n">VERSION_MAJOR</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
				 <span class="p">(</span><span class="n">VERSION_MAJOR</span> <span class="o">%</span> <span class="mi">10</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">driverVersion</span> <span class="o">+=</span> <span class="p">(((</span><span class="n">VERSION_MINOR</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
				  <span class="p">(</span><span class="n">VERSION_MINOR</span> <span class="o">%</span> <span class="mi">10</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">driverVersion</span> <span class="o">+=</span> <span class="p">((</span><span class="n">VERSION_PATCH</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span>
		    <span class="p">((</span><span class="n">VERSION_PATCH</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
		    <span class="p">((</span><span class="n">VERSION_PATCH</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">VERSION_PATCH</span> <span class="o">%</span> <span class="mi">10</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">Write32</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">SC_RA_RAM_DRIVER_VERSION__AX</span><span class="p">,</span> <span class="n">driverVersion</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">StopOC</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">drxd_state</span> <span class="o">=</span> <span class="n">DRXD_STOPPED</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">init_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">DRXD_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">pLockStatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DRX_GetLockStatus</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">pLockStatus</span><span class="p">);</span>

	<span class="cm">/*if (*pLockStatus&amp;DRX_LOCK_MPEG) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pLockStatus</span> <span class="o">&amp;</span> <span class="n">DRX_LOCK_FEC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ConfigureMPEGOutput</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Get status again, in case we have MPEG lock now */</span>
		<span class="cm">/*DRX_GetLockStatus(state, pLockStatus); */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/****************************************************************************/</span>
<span class="cm">/****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drxd_read_signal_strength</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">strength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ReadIFAgc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="mh">0xffff</span> <span class="o">-</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drxd_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_status_t</span> <span class="o">*</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lock</span><span class="p">;</span>

	<span class="n">DRXD_status</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
	<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* No MPEG lock in V255 firmware, bug ? */</span>
<span class="cp">#if 1</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="n">DRX_LOCK_MPEG</span><span class="p">)</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_LOCK</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="n">DRX_LOCK_FEC</span><span class="p">)</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_LOCK</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="n">DRX_LOCK_FEC</span><span class="p">)</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_VITERBI</span> <span class="o">|</span> <span class="n">FE_HAS_SYNC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="n">DRX_LOCK_DEMOD</span><span class="p">)</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_CARRIER</span> <span class="o">|</span> <span class="n">FE_HAS_SIGNAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drxd_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/*	if (request_firmware(&amp;state-&gt;fw, &quot;drxd.fw&quot;, state-&gt;dev)&lt;0) */</span>
	<span class="k">return</span> <span class="n">DRXD_init</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">DRXD_init</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drxd_config_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">disable_i2c_gate_ctrl</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">DRX_ConfigureI2CBridge</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">onoff</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drxd_config_i2c</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drxd_get_tune_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">dvb_frontend_tune_settings</span> <span class="o">*</span><span class="n">sets</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sets</span><span class="o">-&gt;</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="n">sets</span><span class="o">-&gt;</span><span class="n">max_drift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sets</span><span class="o">-&gt;</span><span class="n">step_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drxd_read_ber</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">ber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">ber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drxd_read_snr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">snr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drxd_read_ucblocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">ucblocks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">ucblocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drxd_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">ConfigureMPEGOutput</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drxd_i2c_gate_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">drxd_config_i2c</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drxd_set_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">props</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">DRX_Stop</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">DRX_Start</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drxd_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">drxd_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">delsys</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SYS_DVBT</span><span class="p">},</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Micronas DRXD DVB-T&quot;</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_min</span> <span class="o">=</span> <span class="mi">47125000</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_max</span> <span class="o">=</span> <span class="mi">855250000</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_stepsize</span> <span class="o">=</span> <span class="mi">166667</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_tolerance</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">FE_CAN_FEC_1_2</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_2_3</span> <span class="o">|</span>
		 <span class="n">FE_CAN_FEC_3_4</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_5_6</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_7_8</span> <span class="o">|</span>
		 <span class="n">FE_CAN_FEC_AUTO</span> <span class="o">|</span>
		 <span class="n">FE_CAN_QAM_16</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_64</span> <span class="o">|</span>
		 <span class="n">FE_CAN_QAM_AUTO</span> <span class="o">|</span>
		 <span class="n">FE_CAN_TRANSMISSION_MODE_AUTO</span> <span class="o">|</span>
		 <span class="n">FE_CAN_GUARD_INTERVAL_AUTO</span> <span class="o">|</span>
		 <span class="n">FE_CAN_HIERARCHY_AUTO</span> <span class="o">|</span> <span class="n">FE_CAN_RECOVER</span> <span class="o">|</span> <span class="n">FE_CAN_MUTE_TS</span><span class="p">},</span>

	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">drxd_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">drxd_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">drxd_sleep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">i2c_gate_ctrl</span> <span class="o">=</span> <span class="n">drxd_i2c_gate_ctrl</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_frontend</span> <span class="o">=</span> <span class="n">drxd_set_frontend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tune_settings</span> <span class="o">=</span> <span class="n">drxd_get_tune_settings</span><span class="p">,</span>

	<span class="p">.</span><span class="n">read_status</span> <span class="o">=</span> <span class="n">drxd_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ber</span> <span class="o">=</span> <span class="n">drxd_read_ber</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_signal_strength</span> <span class="o">=</span> <span class="n">drxd_read_signal_strength</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_snr</span> <span class="o">=</span> <span class="n">drxd_read_snr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ucblocks</span> <span class="o">=</span> <span class="n">drxd_read_ucblocks</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="nf">drxd_attach</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">drxd_config</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span>
				 <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drxd_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drxd_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">state</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drxd_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend_ops</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Read16</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drxd_ops</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend_ops</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">demodulator_priv</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">ConfigureMPEGOutput</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;drxd: not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drxd_attach</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;DRXD driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Micronas&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
