<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › frontends › dib0090.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>dib0090.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Linux-DVB Driver for DiBcom&#39;s DiB0090 base-band RF Tuner.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-9 DiBcom (http://www.dibcom.fr/)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation; either version 2 of the</span>
<span class="cm"> * License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This code is more or less generated from another driver, please</span>
<span class="cm"> * excuse some codingstyle oddities.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &quot;dvb_frontend.h&quot;</span>

<span class="cp">#include &quot;dib0090.h&quot;</span>
<span class="cp">#include &quot;dibx000_common.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;turn on debugging (default: 0)&quot;</span><span class="p">);</span>

<span class="cp">#define dprintk(args...) do { \</span>
<span class="cp">	if (debug) { \</span>
<span class="cp">		printk(KERN_DEBUG &quot;DiB0090: &quot;); \</span>
<span class="cp">		printk(args); \</span>
<span class="cp">		printk(&quot;\n&quot;); \</span>
<span class="cp">	} \</span>
<span class="cp">} while (0)</span>

<span class="cp">#define CONFIG_SYS_DVBT</span>
<span class="cp">#define CONFIG_SYS_ISDBT</span>
<span class="cp">#define CONFIG_BAND_CBAND</span>
<span class="cp">#define CONFIG_BAND_VHF</span>
<span class="cp">#define CONFIG_BAND_UHF</span>
<span class="cp">#define CONFIG_DIB0090_USE_PWM_AGC</span>

<span class="cp">#define EN_LNA0      0x8000</span>
<span class="cp">#define EN_LNA1      0x4000</span>
<span class="cp">#define EN_LNA2      0x2000</span>
<span class="cp">#define EN_LNA3      0x1000</span>
<span class="cp">#define EN_MIX0      0x0800</span>
<span class="cp">#define EN_MIX1      0x0400</span>
<span class="cp">#define EN_MIX2      0x0200</span>
<span class="cp">#define EN_MIX3      0x0100</span>
<span class="cp">#define EN_IQADC     0x0040</span>
<span class="cp">#define EN_PLL       0x0020</span>
<span class="cp">#define EN_TX        0x0010</span>
<span class="cp">#define EN_BB        0x0008</span>
<span class="cp">#define EN_LO        0x0004</span>
<span class="cp">#define EN_BIAS      0x0001</span>

<span class="cp">#define EN_IQANA     0x0002</span>
<span class="cp">#define EN_DIGCLK    0x0080	</span><span class="cm">/* not in the 0x24 reg, only in 0x1b */</span><span class="cp"></span>
<span class="cp">#define EN_CRYSTAL   0x0002</span>

<span class="cp">#define EN_UHF		 0x22E9</span>
<span class="cp">#define EN_VHF		 0x44E9</span>
<span class="cp">#define EN_LBD		 0x11E9</span>
<span class="cp">#define EN_SBD		 0x44E9</span>
<span class="cp">#define EN_CAB		 0x88E9</span>

<span class="cm">/* Calibration defines */</span>
<span class="cp">#define      DC_CAL 0x1</span>
<span class="cp">#define     WBD_CAL 0x2</span>
<span class="cp">#define    TEMP_CAL 0x4</span>
<span class="cp">#define CAPTRIM_CAL 0x8</span>

<span class="cp">#define KROSUS_PLL_LOCKED   0x800</span>
<span class="cp">#define KROSUS              0x2</span>

<span class="cm">/* Use those defines to identify SOC version */</span>
<span class="cp">#define SOC               0x02</span>
<span class="cp">#define SOC_7090_P1G_11R1 0x82</span>
<span class="cp">#define SOC_7090_P1G_21R1 0x8a</span>
<span class="cp">#define SOC_8090_P1G_11R1 0x86</span>
<span class="cp">#define SOC_8090_P1G_21R1 0x8e</span>

<span class="cm">/* else use thos ones to check */</span>
<span class="cp">#define P1A_B      0x0</span>
<span class="cp">#define P1C	   0x1</span>
<span class="cp">#define P1D_E_F    0x3</span>
<span class="cp">#define P1G	   0x7</span>
<span class="cp">#define P1G_21R2   0xf</span>

<span class="cp">#define MP001 0x1		</span><span class="cm">/* Single 9090/8096 */</span><span class="cp"></span>
<span class="cp">#define MP005 0x4		</span><span class="cm">/* Single Sband */</span><span class="cp"></span>
<span class="cp">#define MP008 0x6		</span><span class="cm">/* Dual diversity VHF-UHF-LBAND */</span><span class="cp"></span>
<span class="cp">#define MP009 0x7		</span><span class="cm">/* Dual diversity 29098 CBAND-UHF-LBAND-SBAND */</span><span class="cp"></span>

<span class="cp">#define pgm_read_word(w) (*w)</span>

<span class="k">struct</span> <span class="n">dc_calibration</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">dib0090_tuning</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">max_freq</span><span class="p">;</span>		<span class="cm">/* for every frequency less than or equal to that field: this information is correct */</span>
	<span class="n">u8</span> <span class="n">switch_trim</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lna_tune</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">lna_bias</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">v2i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mix</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">load</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tuner_enable</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dib0090_pll</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">max_freq</span><span class="p">;</span>		<span class="cm">/* for every frequency less than or equal to that field: this information is correct */</span>
	<span class="n">u8</span> <span class="n">vco_band</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hfdiv_code</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hfdiv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">topresc</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dib0090_identity</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">version</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">product</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">p1g</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">in_soc</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">current_band</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">frontend_tune_state</span> <span class="n">tune_state</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">current_rf</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">wbd_offset</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">wbd_target</span><span class="p">;</span>		<span class="cm">/* in dB */</span>

	<span class="n">s16</span> <span class="n">rf_gain_limit</span><span class="p">;</span>	<span class="cm">/* take-over-point: where to split between bb and rf gain */</span>
	<span class="n">s16</span> <span class="n">current_gain</span><span class="p">;</span>	<span class="cm">/* keeps the currently programmed gain */</span>
	<span class="n">u8</span> <span class="n">agc_step</span><span class="p">;</span>		<span class="cm">/* new binary search */</span>

	<span class="n">u16</span> <span class="n">gain</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>		<span class="cm">/* for channel monitoring */</span>

	<span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">rf_ramp</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">bb_ramp</span><span class="p">;</span>

	<span class="cm">/* for the software AGC ramps */</span>
	<span class="n">u16</span> <span class="n">bb_1_def</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rf_lt_def</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">gain_reg</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="cm">/* for the captrim/dc-offset search */</span>
	<span class="n">s8</span> <span class="n">step</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">adc_diff</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">min_adc_diff</span><span class="p">;</span>

	<span class="n">s8</span> <span class="n">captrim</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">fcaptrim</span><span class="p">;</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">dc_calibration</span> <span class="o">*</span><span class="n">dc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bb6</span><span class="p">,</span> <span class="n">bb7</span><span class="p">;</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_tuning</span> <span class="o">*</span><span class="n">current_tune_table_index</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_pll</span> <span class="o">*</span><span class="n">current_pll_table_index</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">tuner_is_tuned</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">agc_freeze</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dib0090_identity</span> <span class="n">identity</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">rf_request</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">current_standard</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">calibrate</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rest</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bias</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">temperature</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">wbd_calibration_gain</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_wbd_slope</span> <span class="o">*</span><span class="n">current_wbd_table</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wbdmux</span><span class="p">;</span>

	<span class="cm">/* for the I2C transfer */</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">i2c_buffer_lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dib0090_fw_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib0090_identity</span> <span class="n">identity</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>

	<span class="cm">/* for the I2C transfer */</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">i2c_buffer_lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">dib0090_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not acquire lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_msg</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">i2c_address</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">i2c_address</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;DiB0090 I2C read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0090_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not acquire lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_msg</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">i2c_address</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;DiB0090 I2C write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">dib0090_fw_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_fw_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not acquire lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_msg</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;DiB0090 I2C read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_read_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0090_fw_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_fw_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;could not acquire lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_msg</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_write_buffer</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;DiB0090 I2C write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HARD_RESET(state) do {  if (cfg-&gt;reset) {  if (cfg-&gt;sleep) cfg-&gt;sleep(fe, 0); msleep(10);  cfg-&gt;reset(fe, 1); msleep(10);  cfg-&gt;reset(fe, 0); msleep(10);  }  } while (0)</span>
<span class="cp">#define ADC_TARGET -220</span>
<span class="cp">#define GAIN_ALPHA 5</span>
<span class="cp">#define WBD_ALPHA 6</span>
<span class="cp">#define LPF	100</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib0090_write_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">r</span><span class="p">,</span> <span class="k">const</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">u8</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">r</span><span class="o">++</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0090_identify</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib0090_identity</span> <span class="o">*</span><span class="n">identity</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">);</span>

	<span class="n">identity</span><span class="o">-&gt;</span><span class="n">p1g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">identity</span><span class="o">-&gt;</span><span class="n">in_soc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Tuner identification (Version = 0x%04x)&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>

	<span class="cm">/* without PLL lock info */</span>
	<span class="n">v</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">KROSUS_PLL_LOCKED</span><span class="p">;</span>

	<span class="n">identity</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">identity</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">identity</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">!=</span> <span class="n">KROSUS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">identification_error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">identity</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">==</span> <span class="n">SOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">identity</span><span class="o">-&gt;</span><span class="n">in_soc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">identity</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SOC_8090_P1G_11R1</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SOC 8090 P1-G11R1 Has been detected&quot;</span><span class="p">);</span>
			<span class="n">identity</span><span class="o">-&gt;</span><span class="n">p1g</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SOC_8090_P1G_21R1</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SOC 8090 P1-G21R1 Has been detected&quot;</span><span class="p">);</span>
			<span class="n">identity</span><span class="o">-&gt;</span><span class="n">p1g</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SOC_7090_P1G_11R1</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SOC 7090 P1-G11R1 Has been detected&quot;</span><span class="p">);</span>
			<span class="n">identity</span><span class="o">-&gt;</span><span class="n">p1g</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SOC_7090_P1G_21R1</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SOC 7090 P1-G21R1 Has been detected&quot;</span><span class="p">);</span>
			<span class="n">identity</span><span class="o">-&gt;</span><span class="n">p1g</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">identification_error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">identity</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MP001</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;MP001 : 9090/8096&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MP005</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;MP005 : Single Sband&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MP008</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;MP008 : diversity VHF-UHF-LBAND&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MP009</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;MP009 : diversity 29098 CBAND-UHF-LBAND-SBAND&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">identification_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">identity</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">P1G_21R2</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;P1G_21R2 detected&quot;</span><span class="p">);</span>
			<span class="n">identity</span><span class="o">-&gt;</span><span class="n">p1g</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">P1G</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;P1G detected&quot;</span><span class="p">);</span>
			<span class="n">identity</span><span class="o">-&gt;</span><span class="n">p1g</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">P1D_E_F</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;P1D/E/F detected&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">P1C</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;P1C detected&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">P1A_B</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;P1-A/B detected: driver is deactivated - not available&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">identification_error</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">identification_error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">identification_error:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0090_fw_identify</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_fw_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib0090_identity</span> <span class="o">*</span><span class="n">identity</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">v</span> <span class="o">=</span> <span class="n">dib0090_fw_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">);</span>
	<span class="n">identity</span><span class="o">-&gt;</span><span class="n">p1g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">identity</span><span class="o">-&gt;</span><span class="n">in_soc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;FE: Tuner identification (Version = 0x%04x)&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>

	<span class="cm">/* without PLL lock info */</span>
	<span class="n">v</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">KROSUS_PLL_LOCKED</span><span class="p">;</span>

	<span class="n">identity</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">identity</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">identity</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">!=</span> <span class="n">KROSUS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">identification_error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">identity</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">==</span> <span class="n">SOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">identity</span><span class="o">-&gt;</span><span class="n">in_soc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">identity</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SOC_8090_P1G_11R1</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SOC 8090 P1-G11R1 Has been detected&quot;</span><span class="p">);</span>
			<span class="n">identity</span><span class="o">-&gt;</span><span class="n">p1g</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SOC_8090_P1G_21R1</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SOC 8090 P1-G21R1 Has been detected&quot;</span><span class="p">);</span>
			<span class="n">identity</span><span class="o">-&gt;</span><span class="n">p1g</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SOC_7090_P1G_11R1</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SOC 7090 P1-G11R1 Has been detected&quot;</span><span class="p">);</span>
			<span class="n">identity</span><span class="o">-&gt;</span><span class="n">p1g</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SOC_7090_P1G_21R1</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;SOC 7090 P1-G21R1 Has been detected&quot;</span><span class="p">);</span>
			<span class="n">identity</span><span class="o">-&gt;</span><span class="n">p1g</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">identification_error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">identity</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MP001</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;MP001 : 9090/8096&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MP005</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;MP005 : Single Sband&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MP008</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;MP008 : diversity VHF-UHF-LBAND&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MP009</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;MP009 : diversity 29098 CBAND-UHF-LBAND-SBAND&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">identification_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">identity</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">P1G_21R2</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;P1G_21R2 detected&quot;</span><span class="p">);</span>
			<span class="n">identity</span><span class="o">-&gt;</span><span class="n">p1g</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">P1G</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;P1G detected&quot;</span><span class="p">);</span>
			<span class="n">identity</span><span class="o">-&gt;</span><span class="n">p1g</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">P1D_E_F</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;P1D/E/F detected&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">P1C</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;P1C detected&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">P1A_B</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;P1-A/B detected: driver is deactivated - not available&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">identification_error</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">identification_error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">identification_error:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib0090_reset_digital</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">PllCfg</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">HARD_RESET</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="n">EN_PLL</span> <span class="o">|</span> <span class="n">EN_CRYSTAL</span><span class="p">);</span>
	<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="n">EN_DIGCLK</span> <span class="o">|</span> <span class="n">EN_PLL</span> <span class="o">|</span> <span class="n">EN_CRYSTAL</span><span class="p">);</span>	<span class="cm">/* PLL, DIG_CLK and CRYSTAL remain */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">in_soc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* adcClkOutRatio=8-&gt;7, release reset */</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="p">((</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">adc_clock_ratio</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">clkoutdrive</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="o">!</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">analog_output</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
					  <span class="o">|</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">clkoutdrive</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">clkouttobamse</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="o">!</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">analog_output</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
					  <span class="o">|</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">clkouttobamse</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Read Pll current config * */</span>
	<span class="n">PllCfg</span> <span class="o">=</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>

	<span class="cm">/** Reconfigure PLL if current setting is different from default setting **/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">PllCfg</span> <span class="o">&amp;</span> <span class="mh">0x1FFF</span><span class="p">)</span> <span class="o">!=</span> <span class="p">((</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pll_range</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pll_loopdiv</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pll_prediv</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">in_soc</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pll_bypass</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Set Bypass mode */</span>
		<span class="n">PllCfg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">PllCfg</span><span class="p">);</span>

		<span class="cm">/* Set Reset Pll */</span>
		<span class="n">PllCfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">PllCfg</span><span class="p">);</span>

	<span class="cm">/*** Set new Pll configuration in bypass and reset state ***/</span>
		<span class="n">PllCfg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pll_range</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pll_loopdiv</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pll_prediv</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">PllCfg</span><span class="p">);</span>

		<span class="cm">/* Remove Reset Pll */</span>
		<span class="n">PllCfg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">PllCfg</span><span class="p">);</span>

	<span class="cm">/*** Wait for PLL lock ***/</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">v</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x800</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Pll: Unable to lock Pll&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Finally Remove Bypass mode */</span>
		<span class="n">PllCfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">PllCfg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pll_bypass</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PllCfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pll_bypass</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">PllCfg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0090_fw_reset_digital</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_fw_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">PllCfg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;fw reset digital&quot;</span><span class="p">);</span>
	<span class="n">HARD_RESET</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="n">dib0090_fw_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="n">EN_PLL</span> <span class="o">|</span> <span class="n">EN_CRYSTAL</span><span class="p">);</span>
	<span class="n">dib0090_fw_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="n">EN_DIGCLK</span> <span class="o">|</span> <span class="n">EN_PLL</span> <span class="o">|</span> <span class="n">EN_CRYSTAL</span><span class="p">);</span>	<span class="cm">/* PLL, DIG_CLK and CRYSTAL remain */</span>

	<span class="n">dib0090_fw_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>
			<span class="p">((</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">adc_clock_ratio</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">data_tx_drv</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ls_cfg_pad_drv</span><span class="p">);</span>

	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="o">!</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">analog_output</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">clkouttobamse</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">clkoutdrive</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">clkoutdrive</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">|=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">dib0090_fw_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>

	<span class="cm">/* Read Pll current config * */</span>
	<span class="n">PllCfg</span> <span class="o">=</span> <span class="n">dib0090_fw_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>

	<span class="cm">/** Reconfigure PLL if current setting is different from default setting **/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">PllCfg</span> <span class="o">&amp;</span> <span class="mh">0x1FFF</span><span class="p">)</span> <span class="o">!=</span> <span class="p">((</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pll_range</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pll_loopdiv</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pll_prediv</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pll_bypass</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Set Bypass mode */</span>
		<span class="n">PllCfg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="n">dib0090_fw_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">PllCfg</span><span class="p">);</span>

		<span class="cm">/* Set Reset Pll */</span>
		<span class="n">PllCfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>
		<span class="n">dib0090_fw_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">PllCfg</span><span class="p">);</span>

	<span class="cm">/*** Set new Pll configuration in bypass and reset state ***/</span>
		<span class="n">PllCfg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pll_range</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pll_loopdiv</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pll_prediv</span><span class="p">);</span>
		<span class="n">dib0090_fw_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">PllCfg</span><span class="p">);</span>

		<span class="cm">/* Remove Reset Pll */</span>
		<span class="n">PllCfg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>
		<span class="n">dib0090_fw_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">PllCfg</span><span class="p">);</span>

	<span class="cm">/*** Wait for PLL lock ***/</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">v</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">dib0090_fw_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x800</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Pll: Unable to lock Pll&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Finally Remove Bypass mode */</span>
		<span class="n">PllCfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="n">dib0090_fw_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">PllCfg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pll_bypass</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PllCfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pll_bypass</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="n">dib0090_fw_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">PllCfg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dib0090_fw_identify</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0090_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">sleep</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">sleep</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* enable dataTX in case we have been restarted in the wrong moment */</span>
	<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0090_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">sleep</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">sleep</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dib0090_dcc_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">fast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fast</span><span class="p">)</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib0090_dcc_freq</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">bb_ramp_pwm_normal_socs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">550</span><span class="p">,</span>			<span class="cm">/* max BB gain in 10th of dB */</span>
	<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="mi">8</span><span class="p">,</span>		<span class="cm">/* ramp_slope = 1dB of gain -&gt; clock_ticks_per_db = clk_khz / ramp_slope -&gt; BB_RAMP2 */</span>
	<span class="mi">440</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* BB_RAMP3 = 26dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="mi">208</span><span class="p">,</span>		<span class="cm">/* BB_RAMP4 */</span>
	<span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="mi">208</span><span class="p">,</span>		<span class="cm">/* BB_RAMP5 = 29dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="mi">440</span><span class="p">,</span>		<span class="cm">/* BB_RAMP6 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">rf_ramp_pwm_cband_7090</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">280</span><span class="p">,</span>			<span class="cm">/* max RF gain in 10th of dB */</span>
	<span class="mi">18</span><span class="p">,</span>			<span class="cm">/* ramp_slope = 1dB of gain -&gt; clock_ticks_per_db = clk_khz / ramp_slope -&gt; RF_RAMP2 */</span>
	<span class="mi">504</span><span class="p">,</span>			<span class="cm">/* ramp_max = maximum X used on the ramp */</span>
	<span class="p">(</span><span class="mi">29</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">364</span><span class="p">,</span>	<span class="cm">/* RF_RAMP5, LNA 1 = 8dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">504</span><span class="p">,</span>	<span class="cm">/* RF_RAMP6, LNA 1 */</span>
	<span class="p">(</span><span class="mi">60</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">228</span><span class="p">,</span>	<span class="cm">/* RF_RAMP7, LNA 2 = 7.7dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">364</span><span class="p">,</span>	<span class="cm">/* RF_RAMP8, LNA 2 */</span>
	<span class="p">(</span><span class="mi">34</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">109</span><span class="p">,</span>	<span class="cm">/* GAIN_4_1, LNA 3 = 6.8dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">228</span><span class="p">,</span>	<span class="cm">/* GAIN_4_2, LNA 3 */</span>
	<span class="p">(</span><span class="mi">37</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* RF_RAMP3, LNA 4 = 6.2dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">109</span><span class="p">,</span>	<span class="cm">/* RF_RAMP4, LNA 4 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">uint16_t</span> <span class="n">rf_ramp_pwm_cband_7090e_sensitivity</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">186</span><span class="p">,</span>
	<span class="mi">40</span><span class="p">,</span>
	<span class="mi">746</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">10</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">345</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">0</span>  <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">746</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">0</span>  <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">28</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">200</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">0</span>  <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">345</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">20</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">0</span>  <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">200</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">uint16_t</span> <span class="n">rf_ramp_pwm_cband_7090e_aci</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">86</span><span class="p">,</span>
	<span class="mi">40</span><span class="p">,</span>
	<span class="mi">345</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">28</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">200</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">0</span>  <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">345</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">20</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">0</span>  <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">200</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">rf_ramp_pwm_cband_8090</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">345</span><span class="p">,</span>			<span class="cm">/* max RF gain in 10th of dB */</span>
	<span class="mi">29</span><span class="p">,</span>			<span class="cm">/* ramp_slope = 1dB of gain -&gt; clock_ticks_per_db = clk_khz / ramp_slope -&gt; RF_RAMP2 */</span>
	<span class="mi">1000</span><span class="p">,</span>			<span class="cm">/* ramp_max = maximum X used on the ramp */</span>
	<span class="p">(</span><span class="mi">35</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">772</span><span class="p">,</span>	<span class="cm">/* RF_RAMP3, LNA 1 = 8dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1000</span><span class="p">,</span>	<span class="cm">/* RF_RAMP4, LNA 1 */</span>
	<span class="p">(</span><span class="mi">58</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">496</span><span class="p">,</span>	<span class="cm">/* RF_RAMP5, LNA 2 = 9.5dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">772</span><span class="p">,</span>	<span class="cm">/* RF_RAMP6, LNA 2 */</span>
	<span class="p">(</span><span class="mi">27</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">200</span><span class="p">,</span>	<span class="cm">/* RF_RAMP7, LNA 3 = 10.5dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">496</span><span class="p">,</span>	<span class="cm">/* RF_RAMP8, LNA 3 */</span>
	<span class="p">(</span><span class="mi">40</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* GAIN_4_1, LNA 4 = 7dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">200</span><span class="p">,</span>	<span class="cm">/* GAIN_4_2, LNA 4 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">rf_ramp_pwm_uhf_7090</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">407</span><span class="p">,</span>			<span class="cm">/* max RF gain in 10th of dB */</span>
	<span class="mi">13</span><span class="p">,</span>			<span class="cm">/* ramp_slope = 1dB of gain -&gt; clock_ticks_per_db = clk_khz / ramp_slope -&gt; RF_RAMP2 */</span>
	<span class="mi">529</span><span class="p">,</span>			<span class="cm">/* ramp_max = maximum X used on the ramp */</span>
	<span class="p">(</span><span class="mi">23</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* RF_RAMP3, LNA 1 = 14.7dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">176</span><span class="p">,</span>	<span class="cm">/* RF_RAMP4, LNA 1 */</span>
	<span class="p">(</span><span class="mi">63</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">400</span><span class="p">,</span>	<span class="cm">/* RF_RAMP5, LNA 2 = 8dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">529</span><span class="p">,</span>	<span class="cm">/* RF_RAMP6, LNA 2 */</span>
	<span class="p">(</span><span class="mi">48</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">316</span><span class="p">,</span>	<span class="cm">/* RF_RAMP7, LNA 3 = 6.8dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">400</span><span class="p">,</span>	<span class="cm">/* RF_RAMP8, LNA 3 */</span>
	<span class="p">(</span><span class="mi">29</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">176</span><span class="p">,</span>	<span class="cm">/* GAIN_4_1, LNA 4 = 11.5dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">316</span><span class="p">,</span>	<span class="cm">/* GAIN_4_2, LNA 4 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">rf_ramp_pwm_uhf_8090</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">388</span><span class="p">,</span>			<span class="cm">/* max RF gain in 10th of dB */</span>
	<span class="mi">26</span><span class="p">,</span>			<span class="cm">/* ramp_slope = 1dB of gain -&gt; clock_ticks_per_db = clk_khz / ramp_slope -&gt; RF_RAMP2 */</span>
	<span class="mi">1008</span><span class="p">,</span>			<span class="cm">/* ramp_max = maximum X used on the ramp */</span>
	<span class="p">(</span><span class="mi">11</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* RF_RAMP3, LNA 1 = 14.7dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">369</span><span class="p">,</span>	<span class="cm">/* RF_RAMP4, LNA 1 */</span>
	<span class="p">(</span><span class="mi">41</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">809</span><span class="p">,</span>	<span class="cm">/* RF_RAMP5, LNA 2 = 8dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1008</span><span class="p">,</span>	<span class="cm">/* RF_RAMP6, LNA 2 */</span>
	<span class="p">(</span><span class="mi">27</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">659</span><span class="p">,</span>	<span class="cm">/* RF_RAMP7, LNA 3 = 6dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">809</span><span class="p">,</span>	<span class="cm">/* RF_RAMP8, LNA 3 */</span>
	<span class="p">(</span><span class="mi">14</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">369</span><span class="p">,</span>	<span class="cm">/* GAIN_4_1, LNA 4 = 11.5dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">659</span><span class="p">,</span>	<span class="cm">/* GAIN_4_2, LNA 4 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">rf_ramp_pwm_cband</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>			<span class="cm">/* max RF gain in 10th of dB */</span>
	<span class="mi">0</span><span class="p">,</span>			<span class="cm">/* ramp_slope = 1dB of gain -&gt; clock_ticks_per_db = clk_khz / ramp_slope -&gt; 0x2b */</span>
	<span class="mi">0</span><span class="p">,</span>			<span class="cm">/* ramp_max = maximum X used on the ramp */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* 0x2c, LNA 1 = 0dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* 0x2d, LNA 1 */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* 0x2e, LNA 2 = 0dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* 0x2f, LNA 2 */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* 0x30, LNA 3 = 0dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* 0x31, LNA 3 */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* GAIN_4_1, LNA 4 = 0dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* GAIN_4_2, LNA 4 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">rf_ramp_vhf</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">412</span><span class="p">,</span>			<span class="cm">/* max RF gain in 10th of dB */</span>
	<span class="mi">132</span><span class="p">,</span> <span class="mi">307</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span>		<span class="cm">/* LNA1,  13.2dB */</span>
	<span class="mi">105</span><span class="p">,</span> <span class="mi">412</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span>		<span class="cm">/* LNA2,  10.5dB */</span>
	<span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span>		<span class="cm">/* LNA3,  5dB */</span>
	<span class="mi">125</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span>		<span class="cm">/* LNA4,  12.5dB */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span>		<span class="cm">/* CBAND, 0dB */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">rf_ramp_uhf</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">412</span><span class="p">,</span>			<span class="cm">/* max RF gain in 10th of dB */</span>
	<span class="mi">132</span><span class="p">,</span> <span class="mi">307</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span>		<span class="cm">/* LNA1  : total gain = 13.2dB, point on the ramp where this amp is full gain, value to write to get full gain */</span>
	<span class="mi">105</span><span class="p">,</span> <span class="mi">412</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span>		<span class="cm">/* LNA2  : 10.5 dB */</span>
	<span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span>		<span class="cm">/* LNA3  :  5.0 dB */</span>
	<span class="mi">125</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span>		<span class="cm">/* LNA4  : 12.5 dB */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span>		<span class="cm">/* CBAND :  0.0 dB */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">rf_ramp_cband_broadmatching</span><span class="p">[]</span> <span class="o">=</span>	<span class="cm">/* for p1G only */</span>
<span class="p">{</span>
	<span class="mi">314</span><span class="p">,</span>			<span class="cm">/* Calibrated at 200MHz order has been changed g4-g3-g2-g1 */</span>
	<span class="mi">84</span><span class="p">,</span> <span class="mi">314</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span>		<span class="cm">/* LNA1 */</span>
	<span class="mi">80</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span>		<span class="cm">/* LNA2 */</span>
	<span class="mi">80</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span>		<span class="cm">/* LNA3  It was measured 12dB, do not lock if 120 */</span>
	<span class="mi">70</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span>		<span class="cm">/* LNA4 */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span>		<span class="cm">/* CBAND */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">rf_ramp_cband</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">332</span><span class="p">,</span>			<span class="cm">/* max RF gain in 10th of dB */</span>
	<span class="mi">132</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span>		<span class="cm">/* LNA1,  dB */</span>
	<span class="mi">80</span><span class="p">,</span> <span class="mi">332</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span>		<span class="cm">/* LNA2,  dB */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span>		<span class="cm">/* LNA3,  dB */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span>		<span class="cm">/* LNA4,  dB */</span>
	<span class="mi">120</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span>		<span class="cm">/* LT1 CBAND */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">rf_ramp_pwm_vhf</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">404</span><span class="p">,</span>			<span class="cm">/* max RF gain in 10th of dB */</span>
	<span class="mi">25</span><span class="p">,</span>			<span class="cm">/* ramp_slope = 1dB of gain -&gt; clock_ticks_per_db = clk_khz / ramp_slope -&gt; 0x2b */</span>
	<span class="mi">1011</span><span class="p">,</span>			<span class="cm">/* ramp_max = maximum X used on the ramp */</span>
	<span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">417</span><span class="p">,</span>	<span class="cm">/* 0x2c, LNA 1 = 13.2dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">756</span><span class="p">,</span>	<span class="cm">/* 0x2d, LNA 1 */</span>
	<span class="p">(</span><span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">756</span><span class="p">,</span>	<span class="cm">/* 0x2e, LNA 2 = 10.5dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1011</span><span class="p">,</span>	<span class="cm">/* 0x2f, LNA 2 */</span>
	<span class="p">(</span><span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">290</span><span class="p">,</span>	<span class="cm">/* 0x30, LNA 3 = 5dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">417</span><span class="p">,</span>	<span class="cm">/* 0x31, LNA 3 */</span>
	<span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* GAIN_4_1, LNA 4 = 12.5dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">290</span><span class="p">,</span>	<span class="cm">/* GAIN_4_2, LNA 4 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">rf_ramp_pwm_uhf</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">404</span><span class="p">,</span>			<span class="cm">/* max RF gain in 10th of dB */</span>
	<span class="mi">25</span><span class="p">,</span>			<span class="cm">/* ramp_slope = 1dB of gain -&gt; clock_ticks_per_db = clk_khz / ramp_slope -&gt; 0x2b */</span>
	<span class="mi">1011</span><span class="p">,</span>			<span class="cm">/* ramp_max = maximum X used on the ramp */</span>
	<span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">417</span><span class="p">,</span>	<span class="cm">/* 0x2c, LNA 1 = 13.2dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">756</span><span class="p">,</span>	<span class="cm">/* 0x2d, LNA 1 */</span>
	<span class="p">(</span><span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">756</span><span class="p">,</span>	<span class="cm">/* 0x2e, LNA 2 = 10.5dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1011</span><span class="p">,</span>	<span class="cm">/* 0x2f, LNA 2 */</span>
	<span class="p">(</span><span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* 0x30, LNA 3 = 5dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">127</span><span class="p">,</span>	<span class="cm">/* 0x31, LNA 3 */</span>
	<span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">127</span><span class="p">,</span>	<span class="cm">/* GAIN_4_1, LNA 4 = 12.5dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">417</span><span class="p">,</span>	<span class="cm">/* GAIN_4_2, LNA 4 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">bb_ramp_boost</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">550</span><span class="p">,</span>			<span class="cm">/* max BB gain in 10th of dB */</span>
	<span class="mi">260</span><span class="p">,</span> <span class="mi">260</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span>		<span class="cm">/* BB1, 26dB */</span>
	<span class="mi">290</span><span class="p">,</span> <span class="mi">550</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span>		<span class="cm">/* BB2, 29dB */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">bb_ramp_pwm_normal</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">500</span><span class="p">,</span>			<span class="cm">/* max RF gain in 10th of dB */</span>
	<span class="mi">8</span><span class="p">,</span>			<span class="cm">/* ramp_slope = 1dB of gain -&gt; clock_ticks_per_db = clk_khz / ramp_slope -&gt; 0x34 */</span>
	<span class="mi">400</span><span class="p">,</span>
	<span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* 0x35 = 21dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="mi">168</span><span class="p">,</span>		<span class="cm">/* 0x36 */</span>
	<span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="mi">168</span><span class="p">,</span>		<span class="cm">/* 0x37 = 29dB */</span>
	<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="mi">400</span><span class="p">,</span>		<span class="cm">/* 0x38 */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">slope</span> <span class="p">{</span>
	<span class="n">s16</span> <span class="n">range</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">slope</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">slopes_to_scale</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">slope</span> <span class="o">*</span><span class="n">slopes</span><span class="p">,</span> <span class="n">u8</span> <span class="n">num</span><span class="p">,</span> <span class="n">s16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rest</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">slopes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">range</span><span class="p">)</span>
			<span class="n">rest</span> <span class="o">=</span> <span class="n">slopes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">range</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rest</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="p">(</span><span class="n">rest</span> <span class="o">*</span> <span class="n">slopes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">slope</span><span class="p">)</span> <span class="o">/</span> <span class="n">slopes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">range</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">-=</span> <span class="n">rest</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">slope</span> <span class="n">dib0090_wbd_slopes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">66</span><span class="p">,</span> <span class="mi">120</span><span class="p">},</span>		<span class="cm">/* -64,-52: offset -   65 */</span>
	<span class="p">{</span><span class="mi">600</span><span class="p">,</span> <span class="mi">170</span><span class="p">},</span>		<span class="cm">/* -52,-35: 65     -  665 */</span>
	<span class="p">{</span><span class="mi">170</span><span class="p">,</span> <span class="mi">250</span><span class="p">},</span>		<span class="cm">/* -45,-10: 665    - 835 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">s16</span> <span class="nf">dib0090_wbd_to_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u16</span> <span class="n">wbd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wbd</span> <span class="o">&amp;=</span> <span class="mh">0x3ff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wbd</span> <span class="o">&lt;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_offset</span><span class="p">)</span>
		<span class="n">wbd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wbd</span> <span class="o">-=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_offset</span><span class="p">;</span>
	<span class="cm">/* -64dB is the floor */</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">640</span> <span class="o">+</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="n">slopes_to_scale</span><span class="p">(</span><span class="n">dib0090_wbd_slopes</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dib0090_wbd_slopes</span><span class="p">),</span> <span class="n">wbd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib0090_wbd_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>

	<span class="cm">/* TODO : DAB digital N+/-1 interferer perfs : offset = 10 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">==</span> <span class="n">BAND_VHF</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">650</span><span class="p">;</span>
<span class="cp">#ifndef FIRMWARE_FIREFLY</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">==</span> <span class="n">BAND_VHF</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">wbd_vhf_offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">==</span> <span class="n">BAND_CBAND</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">wbd_cband_offset</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_target</span> <span class="o">=</span> <span class="n">dib0090_wbd_to_db</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_offset</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;wbd-target: %d dB&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_target</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">gain_reg_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x01</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib0090_gain_apply</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">s16</span> <span class="n">gain_delta</span><span class="p">,</span> <span class="n">s16</span> <span class="n">top_delta</span><span class="p">,</span> <span class="n">u8</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">rf</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="n">ref</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">gain_reg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">},</span> <span class="n">gain</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">g</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">top_delta</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">511</span><span class="p">)</span>
		<span class="n">top_delta</span> <span class="o">=</span> <span class="o">-</span><span class="mi">511</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">top_delta</span> <span class="o">&gt;</span> <span class="mi">511</span><span class="p">)</span>
		<span class="n">top_delta</span> <span class="o">=</span> <span class="mi">511</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">force</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">top_delta</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WBD_ALPHA</span><span class="p">);</span>
		<span class="n">gain_delta</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">GAIN_ALPHA</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">top_delta</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="n">s16</span><span class="p">)</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_ramp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">WBD_ALPHA</span><span class="p">)</span> <span class="o">-</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_gain_limit</span><span class="p">))</span>	<span class="cm">/* overflow */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_gain_limit</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_ramp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">WBD_ALPHA</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_gain_limit</span> <span class="o">+=</span> <span class="n">top_delta</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_gain_limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/*underflow */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_gain_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* use gain as a temporary variable and correct current_gain */</span>
	<span class="n">gain</span> <span class="o">=</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_gain_limit</span> <span class="o">&gt;&gt;</span> <span class="n">WBD_ALPHA</span><span class="p">)</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">bb_ramp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="n">GAIN_ALPHA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gain_delta</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="n">s16</span><span class="p">)</span> <span class="n">gain</span> <span class="o">-</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_gain</span><span class="p">))</span>	<span class="cm">/* overflow */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_gain</span> <span class="o">=</span> <span class="n">gain</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_gain</span> <span class="o">+=</span> <span class="n">gain_delta</span><span class="p">;</span>
	<span class="cm">/* cannot be less than 0 (only if gain_delta is less than 0 we can have current_gain &lt; 0) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_gain</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_gain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* now split total gain to rf and bb gain */</span>
	<span class="n">gain</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_gain</span> <span class="o">&gt;&gt;</span> <span class="n">GAIN_ALPHA</span><span class="p">;</span>

	<span class="cm">/* requested gain is bigger than rf gain limit - ACI/WBD adjustment */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gain</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_gain_limit</span> <span class="o">&gt;&gt;</span> <span class="n">WBD_ALPHA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_gain_limit</span> <span class="o">&gt;&gt;</span> <span class="n">WBD_ALPHA</span><span class="p">;</span>
		<span class="n">bb</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">-</span> <span class="n">rf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bb</span> <span class="o">&gt;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">bb_ramp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">bb</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">bb_ramp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* high signal level -&gt; all gains put on RF */</span>
		<span class="n">rf</span> <span class="o">=</span> <span class="n">gain</span><span class="p">;</span>
		<span class="n">bb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">gain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rf</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">gain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="p">;</span>

	<span class="cm">/* software ramp */</span>
	<span class="cm">/* Start with RF gains */</span>
	<span class="n">g</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_ramp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* point on RF LNA1 max gain */</span>
	<span class="n">ref</span> <span class="o">=</span> <span class="n">rf</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Go over all amplifiers =&gt; 5RF amps + 2 BB amps = 7 amps */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ref</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>	<span class="cm">/* if total gain of the current amp is null or this amp is not concerned because it starts to work from an higher gain value */</span>
			<span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* force the gain to write for the current amp to be null */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ref</span> <span class="o">&gt;=</span> <span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>	<span class="cm">/* Gain to set is higher than the high working point of this amp */</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* force this amp to be full gain */</span>
		<span class="k">else</span>		<span class="cm">/* compute the value to set to this amp because we are somewhere in his range */</span>
			<span class="n">v</span> <span class="o">=</span> <span class="p">((</span><span class="n">ref</span> <span class="o">-</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">*</span> <span class="n">g</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* LNA 1 reg mapping */</span>
			<span class="n">gain_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>	<span class="cm">/* LNA 2 reg mapping */</span>
			<span class="n">gain_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">v</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>	<span class="cm">/* LNA 3 reg mapping */</span>
			<span class="n">gain_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>	<span class="cm">/* LNA 4 reg mapping */</span>
			<span class="n">gain_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">v</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>	<span class="cm">/* CBAND LNA reg mapping */</span>
			<span class="n">gain_reg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="o">|</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_lt_def</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>	<span class="cm">/* BB gain 1 reg mapping */</span>
			<span class="n">gain_reg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>	<span class="cm">/* BB gain 2 reg mapping */</span>
			<span class="n">gain_reg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">v</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">g</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>		<span class="cm">/* go to next gain bloc */</span>

		<span class="cm">/* When RF is finished, start with BB */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">g</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">bb_ramp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* point on BB gain 1 max gain */</span>
			<span class="n">ref</span> <span class="o">=</span> <span class="n">bb</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">gain_reg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">bb_1_def</span><span class="p">;</span>
	<span class="n">gain_reg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">bb</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="mi">125</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG_AGC</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;GA CALC: DB: %3d(rf) + %3d(bb) = %3d gain_reg[0]=%04x gain_reg[1]=%04x gain_reg[2]=%04x gain_reg[0]=%04x&quot;</span><span class="p">,</span> <span class="n">rf</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="n">rf</span> <span class="o">+</span> <span class="n">bb</span><span class="p">,</span>
		<span class="n">gain_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gain_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gain_reg</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">gain_reg</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Write the amplifier regs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">gain_reg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">force</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">gain_reg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">gain_reg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">gain_reg_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">v</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib0090_set_boost</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">bb_1_def</span> <span class="o">&amp;=</span> <span class="mh">0xdfff</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">bb_1_def</span> <span class="o">|=</span> <span class="n">onoff</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib0090_set_rframp</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">const</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_ramp</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib0090_set_rframp_pwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">const</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_ramp</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;total RF gain: %ddB, step: %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">));</span>

	<span class="n">dib0090_write_regs</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="n">cfg</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">dib0090_write_regs</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="n">cfg</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib0090_set_bbramp</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">const</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">bb_ramp</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="n">dib0090_set_boost</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">);</span>	<span class="cm">/* we want the boost if the gain is higher that 50dB */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib0090_set_bbramp_pwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">const</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">bb_ramp</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="n">dib0090_set_boost</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">);</span>	<span class="cm">/* we want the boost if the gain is higher that 50dB */</span>

	<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;total BB gain: %ddB, step: %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">));</span>
	<span class="n">dib0090_write_regs</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="n">cfg</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dib0090_pwm_gain_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="cm">/* reset the AGC */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">use_pwm_agc</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_BAND_SBAND</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">==</span> <span class="n">BAND_SBAND</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dib0090_set_rframp_pwm</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">rf_ramp_pwm_sband</span><span class="p">);</span>
			<span class="n">dib0090_set_bbramp_pwm</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">bb_ramp_pwm_boost</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_CBAND</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">==</span> <span class="n">BAND_CBAND</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">in_soc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dib0090_set_bbramp_pwm</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">bb_ramp_pwm_normal_socs</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC_8090_P1G_11R1</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC_8090_P1G_21R1</span><span class="p">)</span>
					<span class="n">dib0090_set_rframp_pwm</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">rf_ramp_pwm_cband_8090</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC_7090_P1G_11R1</span>
						<span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC_7090_P1G_21R1</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">is_dib7090e</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_ramp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
							<span class="n">dib0090_set_rframp_pwm</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">rf_ramp_pwm_cband_7090e_sensitivity</span><span class="p">);</span>
						<span class="k">else</span>
							<span class="n">dib0090_set_rframp_pwm</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_ramp</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">dib0090_set_rframp_pwm</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">rf_ramp_pwm_cband_7090</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dib0090_set_rframp_pwm</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">rf_ramp_pwm_cband</span><span class="p">);</span>
				<span class="n">dib0090_set_bbramp_pwm</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">bb_ramp_pwm_normal</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_VHF</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">==</span> <span class="n">BAND_VHF</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">in_soc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dib0090_set_bbramp_pwm</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">bb_ramp_pwm_normal_socs</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dib0090_set_rframp_pwm</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">rf_ramp_pwm_vhf</span><span class="p">);</span>
				<span class="n">dib0090_set_bbramp_pwm</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">bb_ramp_pwm_normal</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">in_soc</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC_8090_P1G_11R1</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC_8090_P1G_21R1</span><span class="p">)</span>
					<span class="n">dib0090_set_rframp_pwm</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">rf_ramp_pwm_uhf_8090</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC_7090_P1G_11R1</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC_7090_P1G_21R1</span><span class="p">)</span>
					<span class="n">dib0090_set_rframp_pwm</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">rf_ramp_pwm_uhf_7090</span><span class="p">);</span>
				<span class="n">dib0090_set_bbramp_pwm</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">bb_ramp_pwm_normal_socs</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dib0090_set_rframp_pwm</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">rf_ramp_pwm_uhf</span><span class="p">);</span>
				<span class="n">dib0090_set_bbramp_pwm</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">bb_ramp_pwm_normal</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_ramp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">));</span>

		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib0090_pwm_gain_reset</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">dib0090_set_dc_servo</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">DC_servo_cutoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DC_servo_cutoff</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">DC_servo_cutoff</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib0090_set_dc_servo</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">dib0090_get_slow_adc_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">adc_val</span> <span class="o">=</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">in_soc</span><span class="p">)</span>
		<span class="n">adc_val</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">adc_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dib0090_gain_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">frontend_tune_state</span> <span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tune_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">wbd_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">apply_gain_immediatly</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">wbd_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">adc_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tune_state</span> <span class="o">==</span> <span class="n">CT_AGC_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">agc_freeze</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_BAND_SBAND</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">==</span> <span class="n">BAND_SBAND</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dib0090_set_rframp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">rf_ramp_sband</span><span class="p">);</span>
			<span class="n">dib0090_set_bbramp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">bb_ramp_boost</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_VHF</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">==</span> <span class="n">BAND_VHF</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">p1g</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dib0090_set_rframp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">rf_ramp_vhf</span><span class="p">);</span>
			<span class="n">dib0090_set_bbramp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">bb_ramp_boost</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_CBAND</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">==</span> <span class="n">BAND_CBAND</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">p1g</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dib0090_set_rframp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">rf_ramp_cband</span><span class="p">);</span>
			<span class="n">dib0090_set_bbramp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">bb_ramp_boost</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">==</span> <span class="n">BAND_CBAND</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">==</span> <span class="n">BAND_VHF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">p1g</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dib0090_set_rframp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">rf_ramp_cband_broadmatching</span><span class="p">);</span>
			<span class="n">dib0090_set_bbramp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">bb_ramp_boost</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dib0090_set_rframp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">rf_ramp_uhf</span><span class="p">);</span>
			<span class="n">dib0090_set_bbramp</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">bb_ramp_boost</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">dib0090_wbd_target</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_rf</span><span class="p">);</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_gain_limit</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_ramp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">WBD_ALPHA</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_gain</span> <span class="o">=</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_ramp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">bb_ramp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">GAIN_ALPHA</span><span class="p">;</span>

		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_AGC_STEP_0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">agc_freeze</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s16</span> <span class="n">wbd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>

		<span class="kt">int</span> <span class="n">adc</span><span class="p">;</span>
		<span class="n">wbd_val</span> <span class="o">=</span> <span class="n">dib0090_get_slow_adc_val</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tune_state</span> <span class="o">==</span> <span class="n">CT_AGC_STEP_0</span><span class="p">)</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wbd_val</span> <span class="o">=</span> <span class="n">dib0090_get_slow_adc_val</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="n">wbd</span> <span class="o">+=</span> <span class="n">dib0090_wbd_to_db</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">wbd_val</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">wbd</span> <span class="o">/=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">wbd_error</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_target</span> <span class="o">-</span> <span class="n">wbd</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tune_state</span> <span class="o">==</span> <span class="n">CT_AGC_STEP_0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wbd_error</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_gain_limit</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">p1g</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_BAND_CBAND</span>
				<span class="cm">/* in case of CBAND tune reduce first the lt_gain2 before adjusting the RF gain */</span>
				<span class="n">u8</span> <span class="n">ltg2</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_lt_def</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">==</span> <span class="n">BAND_CBAND</span> <span class="o">&amp;&amp;</span> <span class="n">ltg2</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ltg2</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_lt_def</span> <span class="o">&amp;=</span> <span class="n">ltg2</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>	<span class="cm">/* reduce in 3 steps from 7 to 0 */</span>
				<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">agc_step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_AGC_STEP_1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* calc the adc power */</span>
			<span class="n">adc</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">get_adc_power</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
			<span class="n">adc</span> <span class="o">=</span> <span class="p">(</span><span class="n">adc</span> <span class="o">*</span> <span class="p">((</span><span class="n">s32</span><span class="p">)</span> <span class="mi">355774</span><span class="p">)</span> <span class="o">+</span> <span class="p">(((</span><span class="n">s32</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">;</span>	<span class="cm">/* included in [0:-700] */</span>

			<span class="n">adc_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="p">(((</span><span class="n">s32</span><span class="p">)</span> <span class="n">ADC_TARGET</span><span class="p">)</span> <span class="o">-</span> <span class="n">adc</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_STANDARD_DAB</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">delivery_system</span> <span class="o">==</span> <span class="n">STANDARD_DAB</span><span class="p">)</span>
				<span class="n">adc_error</span> <span class="o">-=</span> <span class="mi">10</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_STANDARD_DVBT</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">delivery_system</span> <span class="o">==</span> <span class="n">STANDARD_DVBT</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">QAM_64</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">QAM_16</span><span class="p">))</span>
				<span class="n">adc_error</span> <span class="o">+=</span> <span class="mi">60</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_SYS_ISDBT</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">delivery_system</span> <span class="o">==</span> <span class="n">SYS_ISDBT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">&gt;</span>
								<span class="mi">0</span><span class="p">)</span>
							<span class="o">&amp;&amp;</span>
							<span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span>
							  <span class="n">QAM_64</span><span class="p">)</span>
							 <span class="o">||</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span>
								 <span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">QAM_16</span><span class="p">)))</span>
						<span class="o">||</span>
						<span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">&gt;</span>
						  <span class="mi">0</span><span class="p">)</span>
						 <span class="o">&amp;&amp;</span>
						 <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span>
						   <span class="n">QAM_64</span><span class="p">)</span>
						  <span class="o">||</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span>
							  <span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">QAM_16</span><span class="p">)))</span>
						<span class="o">||</span>
						<span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">&gt;</span>
						  <span class="mi">0</span><span class="p">)</span>
						 <span class="o">&amp;&amp;</span>
						 <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span>
						   <span class="n">QAM_64</span><span class="p">)</span>
						  <span class="o">||</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span>
							  <span class="n">layer</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">QAM_16</span><span class="p">)))</span>
						<span class="p">)</span>
				<span class="p">)</span>
				<span class="n">adc_error</span> <span class="o">+=</span> <span class="mi">60</span><span class="p">;</span>
<span class="cp">#endif</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tune_state</span> <span class="o">==</span> <span class="n">CT_AGC_STEP_1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* quickly go to the correct range of the ADC power */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ABS</span><span class="p">(</span><span class="n">adc_error</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">agc_step</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>

<span class="cp">#ifdef CONFIG_STANDARD_DAB</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">delivery_system</span> <span class="o">==</span> <span class="n">STANDARD_DAB</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">15</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">31</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">63</span><span class="p">));</span>	<span class="cm">/* cap value = 63 : narrow BB filter : Fc = 1.8MHz */</span>
						<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
					<span class="p">{</span>
						<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">32</span><span class="p">));</span>
						<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>	<span class="cm">/*0 = 1KHz ; 1 = 150Hz ; 2 = 50Hz ; 3 = 50KHz ; 4 = servo fast */</span>
					<span class="p">}</span>

					<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_AGC_STOP</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* everything higher than or equal to CT_AGC_STOP means tracking */</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>	<span class="cm">/* 10ms interval */</span>
				<span class="n">apply_gain_immediatly</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#ifdef DEBUG_AGC</span>
		<span class="n">dprintk</span>
			<span class="p">(</span><span class="s">&quot;tune state %d, ADC = %3ddB (ADC err %3d) WBD %3ddB (WBD err %3d, WBD val SADC: %4d), RFGainLimit (TOP): %3d, signal: %3ddBm&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span><span class="n">tune_state</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">adc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">adc_error</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">wbd</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">wbd_error</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">wbd_val</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_gain_limit</span> <span class="o">&gt;&gt;</span> <span class="n">WBD_ALPHA</span><span class="p">,</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="mi">200</span> <span class="o">+</span> <span class="n">adc</span> <span class="o">-</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_gain</span> <span class="o">&gt;&gt;</span> <span class="n">GAIN_ALPHA</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* apply gain */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">agc_freeze</span><span class="p">)</span>
		<span class="n">dib0090_gain_apply</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">adc_error</span><span class="p">,</span> <span class="n">wbd_error</span><span class="p">,</span> <span class="n">apply_gain_immediatly</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib0090_gain_control</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">dib0090_get_current_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">rf</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">bb</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">rf_gain_limit</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">rflt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rf</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">gain</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bb</span><span class="p">)</span>
		<span class="o">*</span><span class="n">bb</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">gain</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rf_gain_limit</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rf_gain_limit</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_gain_limit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rflt</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rflt</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_lt_def</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib0090_get_current_gain</span><span class="p">);</span>

<span class="n">u16</span> <span class="nf">dib0090_get_wbd_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">f_MHz</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">current_temp</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">temperature</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">wbd_thot</span><span class="p">,</span> <span class="n">wbd_tcold</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_wbd_slope</span> <span class="o">*</span><span class="n">wbd</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_wbd_table</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">f_MHz</span> <span class="o">&gt;</span> <span class="n">wbd</span><span class="o">-&gt;</span><span class="n">max_freq</span><span class="p">)</span>
		<span class="n">wbd</span><span class="o">++</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;using wbd-table-entry with max freq %d&quot;</span><span class="p">,</span> <span class="n">wbd</span><span class="o">-&gt;</span><span class="n">max_freq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_temp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">current_temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current_temp</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span>
		<span class="n">current_temp</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">wbdmux</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wbd</span><span class="o">-&gt;</span><span class="n">wbd_gain</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">wbdmux</span> <span class="o">|=</span> <span class="p">(</span><span class="n">wbd</span><span class="o">-&gt;</span><span class="n">wbd_gain</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">wbdmux</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>

	<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">wbdmux</span><span class="p">);</span>

	<span class="n">wbd_thot</span> <span class="o">=</span> <span class="n">wbd</span><span class="o">-&gt;</span><span class="n">offset_hot</span> <span class="o">-</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="n">wbd</span><span class="o">-&gt;</span><span class="n">slope_hot</span> <span class="o">*</span> <span class="n">f_MHz</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">wbd_tcold</span> <span class="o">=</span> <span class="n">wbd</span><span class="o">-&gt;</span><span class="n">offset_cold</span> <span class="o">-</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="n">wbd</span><span class="o">-&gt;</span><span class="n">slope_cold</span> <span class="o">*</span> <span class="n">f_MHz</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>

	<span class="n">wbd_tcold</span> <span class="o">+=</span> <span class="p">((</span><span class="n">wbd_thot</span> <span class="o">-</span> <span class="n">wbd_tcold</span><span class="p">)</span> <span class="o">*</span> <span class="n">current_temp</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_target</span> <span class="o">=</span> <span class="n">dib0090_wbd_to_db</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_offset</span> <span class="o">+</span> <span class="n">wbd_tcold</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;wbd-target: %d dB&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_target</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;wbd offset applied is %d&quot;</span><span class="p">,</span> <span class="n">wbd_tcold</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_offset</span> <span class="o">+</span> <span class="n">wbd_tcold</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib0090_get_wbd_target</span><span class="p">);</span>

<span class="n">u16</span> <span class="nf">dib0090_get_wbd_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_offset</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib0090_get_wbd_offset</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib0090_set_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sw1</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sw2</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sw3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>

	<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="p">(</span><span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff8</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">((</span><span class="n">sw3</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">sw2</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sw1</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib0090_set_switch</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib0090_set_vga</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>

	<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="p">(</span><span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">((</span><span class="n">onoff</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib0090_set_vga</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib0090_update_rframp_7090</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cfg_sensitivity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">p1g</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">in_soc</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">version</span> <span class="o">!=</span> <span class="n">SOC_7090_P1G_21R1</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">version</span> <span class="o">!=</span> <span class="n">SOC_7090_P1G_11R1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() function can only be used for dib7090P&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg_sensitivity</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_ramp</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rf_ramp_pwm_cband_7090e_sensitivity</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_ramp</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rf_ramp_pwm_cband_7090e_aci</span><span class="p">;</span>
	<span class="n">dib0090_pwm_gain_reset</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib0090_update_rframp_7090</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">dib0090_defaults</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>

	<span class="mi">25</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0x99a0</span><span class="p">,</span>
	<span class="mh">0x6008</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0x8bcb</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0x0405</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0xb802</span><span class="p">,</span>
	<span class="mh">0x0300</span><span class="p">,</span>
	<span class="mh">0x2d12</span><span class="p">,</span>
	<span class="mh">0xbac0</span><span class="p">,</span>
	<span class="mh">0x7c00</span><span class="p">,</span>
	<span class="mh">0xdbb9</span><span class="p">,</span>
	<span class="mh">0x0954</span><span class="p">,</span>
	<span class="mh">0x0743</span><span class="p">,</span>
	<span class="mh">0x8000</span><span class="p">,</span>
	<span class="mh">0x0001</span><span class="p">,</span>
	<span class="mh">0x0040</span><span class="p">,</span>
	<span class="mh">0x0100</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0xe910</span><span class="p">,</span>
	<span class="mh">0x149e</span><span class="p">,</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span>
	<span class="mh">0xff2d</span><span class="p">,</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span>

	<span class="mi">2</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span>
	<span class="mh">0x07FF</span><span class="p">,</span>
	<span class="mh">0x0007</span><span class="p">,</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span>
	<span class="n">EN_UHF</span> <span class="o">|</span> <span class="n">EN_CRYSTAL</span><span class="p">,</span>

	<span class="mi">2</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span>
	<span class="mh">0x3ff</span><span class="p">,</span>
	<span class="mh">0x111</span><span class="p">,</span>
	<span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">dib0090_p1g_additionnal_defaults</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span>
	<span class="mh">0xabcd</span><span class="p">,</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>
	<span class="mh">0x00b4</span><span class="p">,</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span>
	<span class="mh">0xfffd</span><span class="p">,</span>

	<span class="mi">1</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x108</span><span class="p">,</span>
	<span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib0090_set_default_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">const</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">pgm_read_word</span><span class="p">(</span><span class="n">n</span><span class="o">++</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">pgm_read_word</span><span class="p">(</span><span class="n">n</span><span class="o">++</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">pgm_read_word</span><span class="p">(</span><span class="n">n</span><span class="o">++</span><span class="p">));</span>
			<span class="n">r</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">l</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">pgm_read_word</span><span class="p">(</span><span class="n">n</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define CAP_VALUE_MIN (u8)  9</span>
<span class="cp">#define CAP_VALUE_MAX (u8) 40</span>
<span class="cp">#define HR_MIN	      (u8) 25</span>
<span class="cp">#define HR_MAX	      (u8) 40</span>
<span class="cp">#define POLY_MIN      (u8)  0</span>
<span class="cp">#define POLY_MAX      (u8)  8</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib0090_set_EFUSE</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">e2</span><span class="p">,</span> <span class="n">e4</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cal</span><span class="p">;</span>

	<span class="n">e2</span> <span class="o">=</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">);</span>
	<span class="n">e4</span> <span class="o">=</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">P1D_E_F</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">P1G</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">e2</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="n">cal</span> <span class="o">=</span> <span class="p">(</span><span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">cal</span> <span class="o">&lt;</span> <span class="mi">670</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cal</span> <span class="o">==</span> <span class="mi">1023</span><span class="p">))</span>
			<span class="n">cal</span> <span class="o">=</span> <span class="mi">850</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="mi">165</span> <span class="o">-</span> <span class="p">((</span><span class="n">cal</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">6</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">e2</span> <span class="o">=</span> <span class="n">e4</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">34</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">n</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">e2</span> <span class="o">!=</span> <span class="n">e4</span><span class="p">)</span>
		<span class="n">e2</span> <span class="o">&amp;=</span> <span class="n">e4</span><span class="p">;</span> <span class="cm">/* Remove the redundancy  */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">e2</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">e2</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">e2</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">e2</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="n">CAP_VALUE_MAX</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="n">CAP_VALUE_MIN</span><span class="p">))</span>
			<span class="n">c</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">h</span> <span class="o">&gt;=</span> <span class="n">HR_MAX</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;=</span> <span class="n">HR_MIN</span><span class="p">))</span>
			<span class="n">h</span> <span class="o">=</span> <span class="mi">34</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">POLY_MAX</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="n">POLY_MIN</span><span class="p">))</span>
			<span class="n">n</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">))</span> <span class="p">;</span>
		<span class="n">e2</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">h</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="n">e2</span><span class="p">)</span> <span class="p">;</span> <span class="cm">/* Load the BB_2 */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0090_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>

	<span class="n">dib0090_reset_digital</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dib0090_identify</span><span class="p">(</span><span class="n">fe</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_TUNER_DIB0090_P1B_SUPPORT</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span>	<span class="cm">/* it is P1B - reset is already done */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">in_soc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span>
			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="p">(</span><span class="n">EN_IQADC</span> <span class="o">|</span> <span class="n">EN_BB</span> <span class="o">|</span> <span class="n">EN_BIAS</span> <span class="o">|</span> <span class="n">EN_DIGCLK</span> <span class="o">|</span> <span class="n">EN_PLL</span> <span class="o">|</span> <span class="n">EN_CRYSTAL</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="p">(</span><span class="n">EN_DIGCLK</span> <span class="o">|</span> <span class="n">EN_PLL</span> <span class="o">|</span> <span class="n">EN_CRYSTAL</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">dib0090_set_default_config</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dib0090_defaults</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">in_soc</span><span class="p">)</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x2910</span><span class="p">);</span>  <span class="cm">/* charge pump current = 0 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">p1g</span><span class="p">)</span>
		<span class="n">dib0090_set_default_config</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dib0090_p1g_additionnal_defaults</span><span class="p">);</span>

	<span class="cm">/* Update the efuse : Only available for KROSUS &gt; P1C  and SOC as well*/</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">P1D_E_F</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">in_soc</span><span class="p">))</span>
		<span class="n">dib0090_set_EFUSE</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="cm">/* Congigure in function of the crystal */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">force_crystal_mode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">force_crystal_mode</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">clock_khz</span> <span class="o">&gt;=</span> <span class="mi">24000</span><span class="p">)</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Pll lock : %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">calibrate</span> <span class="o">=</span> <span class="n">DC_CAL</span> <span class="o">|</span> <span class="n">WBD_CAL</span> <span class="o">|</span> <span class="n">TEMP_CAL</span><span class="p">;</span>	<span class="cm">/* enable iq-offset-calibration and wbd-calibration when tuning next time */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define steps(u) (((u) &gt; 15) ? ((u)-16) : (u))</span>
<span class="cp">#define INTERN_WAIT 10</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0090_get_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">enum</span> <span class="n">frontend_tune_state</span> <span class="o">*</span><span class="n">tune_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">INTERN_WAIT</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">tune_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CT_TUNER_STEP_2</span>:
		<span class="cm">/* Turns to positive */</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STEP_3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CT_TUNER_STEP_3</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">adc_diff</span> <span class="o">=</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">);</span>

		<span class="cm">/* Turns to negative */</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STEP_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CT_TUNER_STEP_4</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">adc_diff</span> <span class="o">-=</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STEP_5</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">dc_calibration</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pga</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bb1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dc_calibration</span> <span class="n">dc_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Step1 BB gain1= 26 with boost 1, gain 2 = 0 */</span>
	<span class="p">{</span><span class="mh">0x06</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">26</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">26</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/* Step 2 BB gain 1 = 26 with boost = 1 &amp; gain 2 = 29 */</span>
	<span class="p">{</span><span class="mh">0x06</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">29</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">26</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x06</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">29</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">26</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dc_calibration</span> <span class="n">dc_p1g_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Step1 BB gain1= 26 with boost 1, gain 2 = 0 */</span>
	<span class="cm">/* addr ; trim reg offset ; pga ; CTRL_BB1 value ; i or q */</span>
	<span class="p">{</span><span class="mh">0x06</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">15</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">15</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/* Step 2 BB gain 1 = 26 with boost = 1 &amp; gain 2 = 29 */</span>
	<span class="p">{</span><span class="mh">0x06</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">29</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">15</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x06</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">29</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">15</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib0090_set_trim</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">==</span> <span class="mh">0x07</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">bb7</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">bb6</span><span class="p">;</span>

	<span class="o">*</span><span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1f</span> <span class="o">&lt;&lt;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">|=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">&lt;&lt;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

	<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0090_dc_offset_calibration</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">enum</span> <span class="n">frontend_tune_state</span> <span class="o">*</span><span class="n">tune_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">tune_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CT_TUNER_START</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Start DC offset calibration&quot;</span><span class="p">);</span>

		<span class="cm">/* force vcm2 = 0.8V */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">bb6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">bb7</span> <span class="o">=</span> <span class="mh">0x040d</span><span class="p">;</span>

		<span class="cm">/* the LNA AND LO are off */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0ffb</span><span class="p">;</span>	<span class="cm">/* shutdown lna and lo */</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">wbdmux</span> <span class="o">=</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">wbdmux</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">dc</span> <span class="o">=</span> <span class="n">dc_table</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">p1g</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">dc</span> <span class="o">=</span> <span class="n">dc_p1g_table</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STEP_0</span><span class="p">;</span>

		<span class="cm">/* fall through */</span>

	<span class="k">case</span> <span class="n">CT_TUNER_STEP_0</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Sart/continue DC calibration for %s path&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;I&quot;</span> <span class="o">:</span> <span class="s">&quot;Q&quot;</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">bb1</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">bb7</span> <span class="o">|</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">));</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">min_adc_diff</span> <span class="o">=</span> <span class="mi">1023</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STEP_1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CT_TUNER_STEP_1</span>:
		<span class="n">dib0090_set_trim</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STEP_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CT_TUNER_STEP_2</span>:
	<span class="k">case</span> <span class="n">CT_TUNER_STEP_3</span>:
	<span class="k">case</span> <span class="n">CT_TUNER_STEP_4</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dib0090_get_offset</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">tune_state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CT_TUNER_STEP_5</span>:	<span class="cm">/* found an offset */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;adc_diff = %d, current step= %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">adc_diff</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">step</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">adc_diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">min_adc_diff</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1023</span><span class="p">;</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Change of sign of the minimum adc diff&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;adc_diff = %d, min_adc_diff = %d current_step = %d&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">adc_diff</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">min_adc_diff</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">step</span><span class="p">);</span>

		<span class="cm">/* first turn for this frequency */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">pga</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">adc_diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">pga</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">adc_diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Look for a change of Sign in the Adc_diff.min_adc_diff is used to STORE the setp N-1 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">adc_diff</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">min_adc_diff</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">steps</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">step</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* stop search when the delta the sign is changing and Steps =15 and Step=0 is force for continuance */</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">step</span><span class="o">++</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">min_adc_diff</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">adc_diff</span><span class="p">;</span>
			<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STEP_1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* the minimum was what we have seen in the step before */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ABS</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">adc_diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ABS</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">min_adc_diff</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Since adc_diff N = %d  &gt; adc_diff step N-1 = %d, Come back one step&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">adc_diff</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">min_adc_diff</span><span class="p">);</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">step</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">dib0090_set_trim</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;BB Offset Cal, BBreg=%hd,Offset=%hd,Value Set=%hd&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">adc_diff</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">step</span><span class="p">);</span>

			<span class="n">state</span><span class="o">-&gt;</span><span class="n">dc</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* done */</span>
				<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STEP_6</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STEP_0</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CT_TUNER_STEP_6</span>:
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">bb7</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0008</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_START</span><span class="p">;</span>	<span class="cm">/* reset done -&gt; real tuning can now begin */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">calibrate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DC_CAL</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0090_wbd_calibration</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">enum</span> <span class="n">frontend_tune_state</span> <span class="o">*</span><span class="n">tune_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">wbd_gain</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_wbd_slope</span> <span class="o">*</span><span class="n">wbd</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_wbd_table</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">tune_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CT_TUNER_START</span>:
		<span class="k">while</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_rf</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">&gt;</span> <span class="n">wbd</span><span class="o">-&gt;</span><span class="n">max_freq</span><span class="p">)</span>
			<span class="n">wbd</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wbd</span><span class="o">-&gt;</span><span class="n">wbd_gain</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">wbd_gain</span> <span class="o">=</span> <span class="n">wbd</span><span class="o">-&gt;</span><span class="n">wbd_gain</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">wbd_gain</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_BAND_LBAND) || defined(CONFIG_BAND_SBAND)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">==</span> <span class="n">BAND_LBAND</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">==</span> <span class="n">BAND_SBAND</span><span class="p">))</span>
				<span class="n">wbd_gain</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wbd_gain</span> <span class="o">==</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_calibration_gain</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* the WBD calibration has already been done */</span>
			<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_START</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">calibrate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WBD_CAL</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x1b81</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">wbd_gain</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>

		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="p">((</span><span class="n">EN_UHF</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)));</span>
		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STEP_0</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_calibration_gain</span> <span class="o">=</span> <span class="n">wbd_gain</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">90</span><span class="p">;</span>	<span class="cm">/* wait for the WBDMUX to switch and for the ADC to sample */</span>

	<span class="k">case</span> <span class="n">CT_TUNER_STEP_0</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_offset</span> <span class="o">=</span> <span class="n">dib0090_get_slow_adc_val</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;WBD calibration offset = %d&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">wbd_offset</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_START</span><span class="p">;</span>	<span class="cm">/* reset done -&gt; real tuning can now begin */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">calibrate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WBD_CAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib0090_set_bandwidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">bandwidth_hz</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">&lt;=</span> <span class="mi">5000</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">bandwidth_hz</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">&lt;=</span> <span class="mi">6000</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">bandwidth_hz</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">&lt;=</span> <span class="mi">7000</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">bb_1_def</span> <span class="o">&amp;=</span> <span class="mh">0x3fff</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">bb_1_def</span> <span class="o">|=</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">bb_1_def</span><span class="p">);</span>	<span class="cm">/* be sure that we have the right bb-filter */</span>

	<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x6008</span><span class="p">);</span>	<span class="cm">/* = 0x6008 : vcm3_trim = 1 ; filter2_gm1_trim = 8 ; filter2_cutoff_freq = 0 */</span>
	<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>	<span class="cm">/* 0 = 1KHz ; 1 = 50Hz ; 2 = 150Hz ; 3 = 50KHz ; 4 = servo fast */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">in_soc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x9bcf</span><span class="p">);</span> <span class="cm">/* attenuator_ibias_tri = 2 ; input_stage_ibias_tr = 1 ; nc = 11 ; ext_gm_trim = 1 ; obuf_ibias_trim = 4 ; filter13_gm2_ibias_t = 15 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">22</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">));</span>	<span class="cm">/* 22 = cap_value */</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xabcd</span><span class="p">);</span>	<span class="cm">/* = 0xabcd : attenuator_ibias_tri = 2 ; input_stage_ibias_tr = 2 ; nc = 11 ; ext_gm_trim = 1 ; obuf_ibias_trim = 4 ; filter13_gm2_ibias_t = 13 */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_pll</span> <span class="n">dib0090_pll_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_BAND_CBAND</span>
	<span class="p">{</span><span class="mi">56000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">70000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">87000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">105000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">115000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">140000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">170000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_VHF</span>
	<span class="p">{</span><span class="mi">200000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">230000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">280000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">340000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">380000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">450000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_UHF</span>
	<span class="p">{</span><span class="mi">580000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">700000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">860000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_LBAND</span>
	<span class="p">{</span><span class="mi">1800000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_SBAND</span>
	<span class="p">{</span><span class="mi">2900000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_tuning</span> <span class="n">dib0090_tuning_table_fm_vhf_on_cband</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>

<span class="cp">#ifdef CONFIG_BAND_CBAND</span>
	<span class="p">{</span><span class="mi">184000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x2912</span><span class="p">,</span> <span class="mh">0xb94e</span><span class="p">,</span> <span class="n">EN_CAB</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">227000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x2912</span><span class="p">,</span> <span class="mh">0xb94e</span><span class="p">,</span> <span class="n">EN_CAB</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">380000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x2912</span><span class="p">,</span> <span class="mh">0xb94e</span><span class="p">,</span> <span class="n">EN_CAB</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_UHF</span>
	<span class="p">{</span><span class="mi">520000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">550000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">650000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">750000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">850000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">900000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_LBAND</span>
	<span class="p">{</span><span class="mi">1500000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1912</span><span class="p">,</span> <span class="mh">0x82c9</span><span class="p">,</span> <span class="n">EN_LBD</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1600000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1912</span><span class="p">,</span> <span class="mh">0x82c9</span><span class="p">,</span> <span class="n">EN_LBD</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1800000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1912</span><span class="p">,</span> <span class="mh">0x82c9</span><span class="p">,</span> <span class="n">EN_LBD</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_SBAND</span>
	<span class="p">{</span><span class="mi">2300000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x2d2A</span><span class="p">,</span> <span class="mh">0x82c7</span><span class="p">,</span> <span class="n">EN_SBD</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">2900000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x2deb</span><span class="p">,</span> <span class="mh">0x8347</span><span class="p">,</span> <span class="n">EN_SBD</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_tuning</span> <span class="n">dib0090_tuning_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>

<span class="cp">#ifdef CONFIG_BAND_CBAND</span>
	<span class="p">{</span><span class="mi">170000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x2912</span><span class="p">,</span> <span class="mh">0xb94e</span><span class="p">,</span> <span class="n">EN_CAB</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_VHF</span>
	<span class="p">{</span><span class="mi">184000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x4d12</span><span class="p">,</span> <span class="mh">0xb94e</span><span class="p">,</span> <span class="n">EN_VHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">227000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x4d12</span><span class="p">,</span> <span class="mh">0xb94e</span><span class="p">,</span> <span class="n">EN_VHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">380000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x4d12</span><span class="p">,</span> <span class="mh">0xb94e</span><span class="p">,</span> <span class="n">EN_VHF</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_UHF</span>
	<span class="p">{</span><span class="mi">520000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">550000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">650000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">750000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">850000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">900000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_LBAND</span>
	<span class="p">{</span><span class="mi">1500000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1912</span><span class="p">,</span> <span class="mh">0x82c9</span><span class="p">,</span> <span class="n">EN_LBD</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1600000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1912</span><span class="p">,</span> <span class="mh">0x82c9</span><span class="p">,</span> <span class="n">EN_LBD</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1800000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1912</span><span class="p">,</span> <span class="mh">0x82c9</span><span class="p">,</span> <span class="n">EN_LBD</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_SBAND</span>
	<span class="p">{</span><span class="mi">2300000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x2d2A</span><span class="p">,</span> <span class="mh">0x82c7</span><span class="p">,</span> <span class="n">EN_SBD</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">2900000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x2deb</span><span class="p">,</span> <span class="mh">0x8347</span><span class="p">,</span> <span class="n">EN_SBD</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_tuning</span> <span class="n">dib0090_p1g_tuning_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_BAND_CBAND</span>
	<span class="p">{</span><span class="mi">170000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x820f</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x2d22</span><span class="p">,</span> <span class="mh">0x82cb</span><span class="p">,</span> <span class="n">EN_CAB</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_VHF</span>
	<span class="p">{</span><span class="mi">184000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x4d12</span><span class="p">,</span> <span class="mh">0xb94e</span><span class="p">,</span> <span class="n">EN_VHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">227000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x4d12</span><span class="p">,</span> <span class="mh">0xb94e</span><span class="p">,</span> <span class="n">EN_VHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">380000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x4d12</span><span class="p">,</span> <span class="mh">0xb94e</span><span class="p">,</span> <span class="n">EN_VHF</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_UHF</span>
	<span class="p">{</span><span class="mi">510000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">540000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">600000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">630000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">680000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">720000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">900000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_LBAND</span>
	<span class="p">{</span><span class="mi">1500000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1912</span><span class="p">,</span> <span class="mh">0x82c9</span><span class="p">,</span> <span class="n">EN_LBD</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1600000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1912</span><span class="p">,</span> <span class="mh">0x82c9</span><span class="p">,</span> <span class="n">EN_LBD</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1800000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1912</span><span class="p">,</span> <span class="mh">0x82c9</span><span class="p">,</span> <span class="n">EN_LBD</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_SBAND</span>
	<span class="p">{</span><span class="mi">2300000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x2d2A</span><span class="p">,</span> <span class="mh">0x82c7</span><span class="p">,</span> <span class="n">EN_SBD</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">2900000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x2deb</span><span class="p">,</span> <span class="mh">0x8347</span><span class="p">,</span> <span class="n">EN_SBD</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_pll</span> <span class="n">dib0090_p1g_pll_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_BAND_CBAND</span>
	<span class="p">{</span><span class="mi">57000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">70000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">86000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">105000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">115000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">140000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">170000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_VHF</span>
	<span class="p">{</span><span class="mi">200000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">230000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">280000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">340000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">380000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">455000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_UHF</span>
	<span class="p">{</span><span class="mi">580000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">680000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">860000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_LBAND</span>
	<span class="p">{</span><span class="mi">1800000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_SBAND</span>
	<span class="p">{</span><span class="mi">2900000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_tuning</span> <span class="n">dib0090_p1g_tuning_table_fm_vhf_on_cband</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_BAND_CBAND</span>
	<span class="p">{</span><span class="mi">184000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x4187</span><span class="p">,</span> <span class="mh">0x2c0</span><span class="p">,</span> <span class="mh">0x2d22</span><span class="p">,</span> <span class="mh">0x81cb</span><span class="p">,</span> <span class="n">EN_CAB</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">227000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x4187</span><span class="p">,</span> <span class="mh">0x2c0</span><span class="p">,</span> <span class="mh">0x2d22</span><span class="p">,</span> <span class="mh">0x81cb</span><span class="p">,</span> <span class="n">EN_CAB</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">380000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x4187</span><span class="p">,</span> <span class="mh">0x2c0</span><span class="p">,</span> <span class="mh">0x2d22</span><span class="p">,</span> <span class="mh">0x81cb</span><span class="p">,</span> <span class="n">EN_CAB</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_UHF</span>
	<span class="p">{</span><span class="mi">520000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">550000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">650000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">750000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">850000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">900000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1d12</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_UHF</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_LBAND</span>
	<span class="p">{</span><span class="mi">1500000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1912</span><span class="p">,</span> <span class="mh">0x82c9</span><span class="p">,</span> <span class="n">EN_LBD</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1600000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1912</span><span class="p">,</span> <span class="mh">0x82c9</span><span class="p">,</span> <span class="n">EN_LBD</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1800000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x1912</span><span class="p">,</span> <span class="mh">0x82c9</span><span class="p">,</span> <span class="n">EN_LBD</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BAND_SBAND</span>
	<span class="p">{</span><span class="mi">2300000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x2d2A</span><span class="p">,</span> <span class="mh">0x82c7</span><span class="p">,</span> <span class="n">EN_SBD</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">2900000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x2deb</span><span class="p">,</span> <span class="mh">0x8347</span><span class="p">,</span> <span class="n">EN_SBD</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_tuning</span> <span class="n">dib0090_tuning_table_cband_7090</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_BAND_CBAND</span>
	<span class="p">{</span><span class="mi">300000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x018F</span><span class="p">,</span> <span class="mh">0x2c0</span><span class="p">,</span> <span class="mh">0x2d22</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_CAB</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">380000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mh">0x018F</span><span class="p">,</span> <span class="mh">0x2c0</span><span class="p">,</span> <span class="mh">0x2d22</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_CAB</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">570000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mh">0x8190</span><span class="p">,</span> <span class="mh">0x2c0</span><span class="p">,</span> <span class="mh">0x2d22</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_CAB</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">858000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mh">0x8190</span><span class="p">,</span> <span class="mh">0x2c0</span><span class="p">,</span> <span class="mh">0x2d22</span><span class="p">,</span> <span class="mh">0xb9ce</span><span class="p">,</span> <span class="n">EN_CAB</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_tuning</span> <span class="n">dib0090_tuning_table_cband_7090e_sensitivity</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_BAND_CBAND</span>
	<span class="p">{</span> <span class="mi">300000</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mh">0x8105</span><span class="p">,</span> <span class="mh">0x2c0</span><span class="p">,</span> <span class="mh">0x2d12</span><span class="p">,</span> <span class="mh">0xb84e</span><span class="p">,</span> <span class="n">EN_CAB</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">380000</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">,</span>  <span class="mi">10</span><span class="p">,</span> <span class="mh">0x810F</span><span class="p">,</span> <span class="mh">0x2c0</span><span class="p">,</span> <span class="mh">0x2d12</span><span class="p">,</span> <span class="mh">0xb84e</span><span class="p">,</span> <span class="n">EN_CAB</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">600000</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">,</span>  <span class="mi">10</span><span class="p">,</span> <span class="mh">0x815E</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x2d12</span><span class="p">,</span> <span class="mh">0xb84e</span><span class="p">,</span> <span class="n">EN_CAB</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">660000</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mh">0x85E3</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x2d12</span><span class="p">,</span> <span class="mh">0xb84e</span><span class="p">,</span> <span class="n">EN_CAB</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">720000</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mh">0x852E</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x2d12</span><span class="p">,</span> <span class="mh">0xb84e</span><span class="p">,</span> <span class="n">EN_CAB</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">860000</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mh">0x85E5</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x2d12</span><span class="p">,</span> <span class="mh">0xb84e</span><span class="p">,</span> <span class="n">EN_CAB</span> <span class="p">},</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">dib0090_update_tuning_table_7090</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">cfg_sensitivity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_tuning</span> <span class="o">*</span><span class="n">tune</span> <span class="o">=</span>
		<span class="n">dib0090_tuning_table_cband_7090e_sensitivity</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_tuning</span> <span class="n">dib0090_tuning_table_cband_7090e_aci</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">300000</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mh">0x8165</span><span class="p">,</span> <span class="mh">0x2c0</span><span class="p">,</span> <span class="mh">0x2d12</span><span class="p">,</span> <span class="mh">0xb84e</span><span class="p">,</span> <span class="n">EN_CAB</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">650000</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mh">0x815B</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x2d12</span><span class="p">,</span> <span class="mh">0xb84e</span><span class="p">,</span> <span class="n">EN_CAB</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">860000</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mh">0x84EF</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x2d12</span><span class="p">,</span> <span class="mh">0xb84e</span><span class="p">,</span> <span class="n">EN_CAB</span> <span class="p">},</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">p1g</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">in_soc</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">version</span> <span class="o">!=</span> <span class="n">SOC_7090_P1G_21R1</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">version</span> <span class="o">!=</span> <span class="n">SOC_7090_P1G_11R1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() function can only be used for dib7090&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg_sensitivity</span><span class="p">)</span>
		<span class="n">tune</span> <span class="o">=</span> <span class="n">dib0090_tuning_table_cband_7090e_sensitivity</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tune</span> <span class="o">=</span> <span class="n">dib0090_tuning_table_cband_7090e_aci</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_request</span> <span class="o">&gt;</span> <span class="n">tune</span><span class="o">-&gt;</span><span class="n">max_freq</span><span class="p">)</span>
		<span class="n">tune</span><span class="o">++</span><span class="p">;</span>

	<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="p">(</span><span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">tune</span><span class="o">-&gt;</span><span class="n">lna_bias</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">));</span>
	<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="p">(</span><span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf83f</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">((</span><span class="n">tune</span><span class="o">-&gt;</span><span class="n">lna_tune</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07c0</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib0090_update_tuning_table_7090</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0090_captrim_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">enum</span> <span class="n">frontend_tune_state</span> <span class="o">*</span><span class="n">tune_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">lo4</span> <span class="o">=</span> <span class="mh">0xe900</span><span class="p">;</span>

	<span class="n">s16</span> <span class="n">adc_target</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">adc</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">step_sign</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">force_soft_search</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC_8090_P1G_11R1</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC_8090_P1G_21R1</span><span class="p">)</span>
		<span class="n">force_soft_search</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tune_state</span> <span class="o">==</span> <span class="n">CT_TUNER_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Start Captrim search : %s&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">force_soft_search</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;FORCE SOFT SEARCH&quot;</span> <span class="o">:</span> <span class="s">&quot;AUTO&quot;</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x2B1</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x0032</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_is_tuned</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* prepare a complete captrim */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">p1g</span> <span class="o">||</span> <span class="n">force_soft_search</span><span class="p">)</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">captrim</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fcaptrim</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

			<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_rf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_request</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* we are already tuned to this frequency - the configuration is correct  */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">p1g</span> <span class="o">||</span> <span class="n">force_soft_search</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* do a minimal captrim even if the frequency has not changed */</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">captrim</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fcaptrim</span> <span class="o">=</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">adc_diff</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STEP_0</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tune_state</span> <span class="o">==</span> <span class="n">CT_TUNER_STEP_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">p1g</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">force_soft_search</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">ratio</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>

			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">lo4</span> <span class="o">|</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">captrim</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">in_soc</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STEP_1</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tune_state</span> <span class="o">==</span> <span class="n">CT_TUNER_STEP_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">p1g</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">force_soft_search</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x18c</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>

			<span class="n">state</span><span class="o">-&gt;</span><span class="n">fcaptrim</span> <span class="o">=</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;***Final Captrim= 0x%x&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fcaptrim</span><span class="p">);</span>
			<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STEP_3</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* MERGE for all krosus before P1G */</span>
			<span class="n">adc</span> <span class="o">=</span> <span class="n">dib0090_get_slow_adc_val</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;CAPTRIM=%d; ADC = %d (ADC) &amp; %dmV&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">captrim</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">adc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">adc</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mi">1800</span> <span class="o">/</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mi">1024</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rest</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">in_soc</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Just for 8090P SOCS where auto captrim HW bug : TO CHECK IN ACI for SOCS !!! if 400 for 8090p SOC =&gt; tune issue !!! */</span>
				<span class="n">adc_target</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">adc_target</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">adc</span> <span class="o">&gt;=</span> <span class="n">adc_target</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">adc</span> <span class="o">-=</span> <span class="n">adc_target</span><span class="p">;</span>
				<span class="n">step_sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">adc</span> <span class="o">=</span> <span class="n">adc_target</span> <span class="o">-</span> <span class="n">adc</span><span class="p">;</span>
				<span class="n">step_sign</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">adc</span> <span class="o">&lt;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">adc_diff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;CAPTRIM=%d is closer to target (%d/%d)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">captrim</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">adc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">adc_diff</span><span class="p">);</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">adc_diff</span> <span class="o">=</span> <span class="n">adc</span><span class="p">;</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">fcaptrim</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">captrim</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">state</span><span class="o">-&gt;</span><span class="n">captrim</span> <span class="o">+=</span> <span class="n">step_sign</span> <span class="o">*</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">step</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STEP_0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STEP_2</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tune_state</span> <span class="o">==</span> <span class="n">CT_TUNER_STEP_2</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* this step is only used by krosus &lt; P1G */</span>
		<span class="cm">/*write the final cptrim config */</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">lo4</span> <span class="o">|</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fcaptrim</span><span class="p">);</span>

		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STEP_3</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tune_state</span> <span class="o">==</span> <span class="n">CT_TUNER_STEP_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">calibrate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CAPTRIM_CAL</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STEP_0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0090_get_temperature</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="k">enum</span> <span class="n">frontend_tune_state</span> <span class="o">*</span><span class="n">tune_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">tune_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CT_TUNER_START</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">wbdmux</span> <span class="o">=</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">wbdmux</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x8</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">bias</span> <span class="o">=</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">bias</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>

		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STEP_0</span><span class="p">;</span>
		<span class="cm">/* wait for the WBDMUX to switch and for the ADC to sample */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CT_TUNER_STEP_0</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">adc_diff</span> <span class="o">=</span> <span class="n">dib0090_get_slow_adc_val</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">bias</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STEP_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CT_TUNER_STEP_1</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">dib0090_get_slow_adc_val</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">temperature</span> <span class="o">=</span> <span class="p">((</span><span class="n">s16</span><span class="p">)</span> <span class="p">((</span><span class="n">val</span> <span class="o">-</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">adc_diff</span><span class="p">)</span> <span class="o">*</span> <span class="mi">180</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">55</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;temperature: %d C&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">temperature</span> <span class="o">-</span> <span class="mi">30</span><span class="p">);</span>

		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STEP_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CT_TUNER_STEP_2</span>:
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">bias</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">wbdmux</span><span class="p">);</span>	<span class="cm">/* write back original WBDMUX */</span>

		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_START</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">calibrate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TEMP_CAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">analog_output</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define WBD     0x781		</span><span class="cm">/* 1 1 1 1 0000 0 0 1 */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0090_tune</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_tuning</span> <span class="o">*</span><span class="n">tune</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_tune_table_index</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_pll</span> <span class="o">*</span><span class="n">pll</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_pll_table_index</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">frontend_tune_state</span> <span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tune_state</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">lo5</span><span class="p">,</span> <span class="n">lo6</span><span class="p">,</span> <span class="n">Den</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">FBDiv</span><span class="p">,</span> <span class="n">Rest</span><span class="p">,</span> <span class="n">FREF</span><span class="p">,</span> <span class="n">VCOF_kHz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>		<span class="cm">/* 1ms is the default delay most of the time */</span>
	<span class="n">u8</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/************************* VCO ***************************/</span>
	<span class="cm">/* Default values for FG                                 */</span>
	<span class="cm">/* from these are needed :                               */</span>
	<span class="cm">/* Cp,HFdiv,VCOband,SD,Num,Den,FB and REFDiv             */</span>

	<span class="cm">/* in any case we first need to do a calibration if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tune_state</span> <span class="o">==</span> <span class="n">CT_TUNER_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* deactivate DataTX before some calibrations */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">calibrate</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DC_CAL</span> <span class="o">|</span> <span class="n">TEMP_CAL</span> <span class="o">|</span> <span class="n">WBD_CAL</span><span class="p">))</span>
			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="cm">/* Activate DataTX in case a calibration has been done before */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">analog_output</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">calibrate</span> <span class="o">&amp;</span> <span class="n">DC_CAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dib0090_dc_offset_calibration</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">tune_state</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">calibrate</span> <span class="o">&amp;</span> <span class="n">WBD_CAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_rf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_rf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">dib0090_wbd_calibration</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">tune_state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">calibrate</span> <span class="o">&amp;</span> <span class="n">TEMP_CAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dib0090_get_temperature</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">tune_state</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">calibrate</span> <span class="o">&amp;</span> <span class="n">CAPTRIM_CAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dib0090_captrim_search</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">tune_state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tune_state</span> <span class="o">==</span> <span class="n">CT_TUNER_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if soc and AGC pwm control, disengage mux to be able to R/W access to 0x01 register to set the right filter (cutoff_freq_select) during the tune sequence, otherwise, SOC SERPAR error when accessing to 0x01 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">use_pwm_agc</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">in_soc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
				<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">BAND_OF_FREQUENCY</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_request</span> <span class="o">=</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">+</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">==</span>
					<span class="n">BAND_UHF</span> <span class="o">?</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">freq_offset_khz_uhf</span> <span class="o">:</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span>
					<span class="n">freq_offset_khz_vhf</span><span class="p">);</span>

		<span class="cm">/* in ISDB-T 1seg we shift tuning frequency */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">delivery_system</span> <span class="o">==</span> <span class="n">SYS_ISDBT</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_sb_mode</span> <span class="o">==</span> <span class="mi">1</span>
					<span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">isdbt_partial_reception</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_low_if_offset_table</span> <span class="o">*</span><span class="n">LUT_offset</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">low_if</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">found_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">margin_khz</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">LUT_offset</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">LUT_offset</span><span class="o">-&gt;</span><span class="n">RF_freq</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_request</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">LUT_offset</span><span class="o">-&gt;</span><span class="n">RF_freq</span> <span class="o">-</span> <span class="n">margin_khz</span><span class="p">))</span>
								<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_request</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">LUT_offset</span><span class="o">-&gt;</span><span class="n">RF_freq</span> <span class="o">+</span> <span class="n">margin_khz</span><span class="p">)))</span>
							<span class="o">&amp;&amp;</span> <span class="n">LUT_offset</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">==</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">delivery_system</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_request</span> <span class="o">+=</span> <span class="n">LUT_offset</span><span class="o">-&gt;</span><span class="n">offset_khz</span><span class="p">;</span>
						<span class="n">found_offset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">LUT_offset</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">found_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_request</span> <span class="o">+=</span> <span class="mi">400</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_rf</span> <span class="o">!=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_request</span> <span class="o">||</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_standard</span> <span class="o">!=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">delivery_system</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_is_tuned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_rf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_standard</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">tune</span> <span class="o">=</span> <span class="n">dib0090_tuning_table</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">p1g</span><span class="p">)</span>
				<span class="n">tune</span> <span class="o">=</span> <span class="n">dib0090_p1g_tuning_table</span><span class="p">;</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">version</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">in_soc</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">force_cband_input</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Use the CBAND input for all band */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">&amp;</span> <span class="n">BAND_CBAND</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">&amp;</span> <span class="n">BAND_FM</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">&amp;</span> <span class="n">BAND_VHF</span>
							<span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">&amp;</span> <span class="n">BAND_UHF</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">=</span> <span class="n">BAND_CBAND</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">is_dib7090e</span><span class="p">)</span>
							<span class="n">tune</span> <span class="o">=</span> <span class="n">dib0090_tuning_table_cband_7090e_sensitivity</span><span class="p">;</span>
						<span class="k">else</span>
							<span class="n">tune</span> <span class="o">=</span> <span class="n">dib0090_tuning_table_cband_7090</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* Use the CBAND input for all band under UHF */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">&amp;</span> <span class="n">BAND_CBAND</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">&amp;</span> <span class="n">BAND_FM</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">&amp;</span> <span class="n">BAND_VHF</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">=</span> <span class="n">BAND_CBAND</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">is_dib7090e</span><span class="p">)</span>
							<span class="n">tune</span> <span class="o">=</span> <span class="n">dib0090_tuning_table_cband_7090e_sensitivity</span><span class="p">;</span>
						<span class="k">else</span>
							<span class="n">tune</span> <span class="o">=</span> <span class="n">dib0090_tuning_table_cband_7090</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
			 <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mh">0x4</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">==</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* CBAND tuner version for VHF */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">==</span> <span class="n">BAND_FM</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">==</span> <span class="n">BAND_CBAND</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">==</span> <span class="n">BAND_VHF</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_band</span> <span class="o">=</span> <span class="n">BAND_CBAND</span><span class="p">;</span>	<span class="cm">/* Force CBAND */</span>

					<span class="n">tune</span> <span class="o">=</span> <span class="n">dib0090_tuning_table_fm_vhf_on_cband</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">p1g</span><span class="p">)</span>
						<span class="n">tune</span> <span class="o">=</span> <span class="n">dib0090_p1g_tuning_table_fm_vhf_on_cband</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">pll</span> <span class="o">=</span> <span class="n">dib0090_pll_table</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">p1g</span><span class="p">)</span>
				<span class="n">pll</span> <span class="o">=</span> <span class="n">dib0090_p1g_pll_table</span><span class="p">;</span>

			<span class="cm">/* Look for the interval */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_request</span> <span class="o">&gt;</span> <span class="n">tune</span><span class="o">-&gt;</span><span class="n">max_freq</span><span class="p">)</span>
				<span class="n">tune</span><span class="o">++</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_request</span> <span class="o">&gt;</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">max_freq</span><span class="p">)</span>
				<span class="n">pll</span><span class="o">++</span><span class="p">;</span>

			<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_tune_table_index</span> <span class="o">=</span> <span class="n">tune</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_pll_table_index</span> <span class="o">=</span> <span class="n">pll</span><span class="p">;</span>

			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0xb800</span> <span class="o">|</span> <span class="p">(</span><span class="n">tune</span><span class="o">-&gt;</span><span class="n">switch_trim</span><span class="p">));</span>

			<span class="n">VCOF_kHz</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">hfdiv</span> <span class="o">*</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_request</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

			<span class="n">FREF</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">clock_khz</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">fref_clock_ratio</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">FREF</span> <span class="o">/=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">fref_clock_ratio</span><span class="p">;</span>

			<span class="n">FBDiv</span> <span class="o">=</span> <span class="p">(</span><span class="n">VCOF_kHz</span> <span class="o">/</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">topresc</span> <span class="o">/</span> <span class="n">FREF</span><span class="p">);</span>
			<span class="n">Rest</span> <span class="o">=</span> <span class="p">(</span><span class="n">VCOF_kHz</span> <span class="o">/</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">topresc</span><span class="p">)</span> <span class="o">-</span> <span class="n">FBDiv</span> <span class="o">*</span> <span class="n">FREF</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Rest</span> <span class="o">&lt;</span> <span class="n">LPF</span><span class="p">)</span>
				<span class="n">Rest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Rest</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">LPF</span><span class="p">)</span>
				<span class="n">Rest</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">LPF</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Rest</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">FREF</span> <span class="o">-</span> <span class="n">LPF</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">Rest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">FBDiv</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Rest</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">FREF</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">LPF</span><span class="p">))</span>
				<span class="n">Rest</span> <span class="o">=</span> <span class="n">FREF</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">LPF</span><span class="p">;</span>
			<span class="n">Rest</span> <span class="o">=</span> <span class="p">(</span><span class="n">Rest</span> <span class="o">*</span> <span class="mi">6528</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">FREF</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">rest</span> <span class="o">=</span> <span class="n">Rest</span><span class="p">;</span>

			<span class="cm">/* external loop filter, otherwise:</span>
<span class="cm">			 * lo5 = (0 &lt;&lt; 15) | (0 &lt;&lt; 12) | (0 &lt;&lt; 11) | (3 &lt;&lt; 9) | (4 &lt;&lt; 6) | (3 &lt;&lt; 4) | 4;</span>
<span class="cm">			 * lo6 = 0x0e34 */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Rest</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">vco_band</span><span class="p">)</span>
					<span class="n">lo5</span> <span class="o">=</span> <span class="mh">0x049f</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">lo5</span> <span class="o">=</span> <span class="mh">0x041f</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">vco_band</span><span class="p">)</span>
					<span class="n">lo5</span> <span class="o">=</span> <span class="mh">0x049e</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">analog_output</span><span class="p">)</span>
					<span class="n">lo5</span> <span class="o">=</span> <span class="mh">0x041d</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">lo5</span> <span class="o">=</span> <span class="mh">0x041c</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">p1g</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Bias is done automatically in P1G */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">in_soc</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">SOC_8090_P1G_11R1</span><span class="p">)</span>
						<span class="n">lo5</span> <span class="o">=</span> <span class="mh">0x46f</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">lo5</span> <span class="o">=</span> <span class="mh">0x42f</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">lo5</span> <span class="o">=</span> <span class="mh">0x42c</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">lo5</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">hfdiv_code</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">vco_band</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>	<span class="cm">/* bit 15 is the split to the slave, we do not do it here */</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pll_int_loop_filt</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">in_soc</span><span class="p">)</span>
					<span class="n">lo6</span> <span class="o">=</span> <span class="mh">0xff98</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">p1g</span> <span class="o">||</span> <span class="p">(</span><span class="n">Rest</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
					<span class="n">lo6</span> <span class="o">=</span> <span class="mh">0xfff8</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">lo6</span> <span class="o">=</span> <span class="mh">0xff28</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">lo6</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">pll_int_loop_filt</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>

			<span class="n">Den</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Rest</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">analog_output</span><span class="p">)</span>
					<span class="n">lo6</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">in_soc</span><span class="p">)</span>
						<span class="n">lo6</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">lo6</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">Den</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">FBDiv</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">fref_clock_ratio</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="p">(</span><span class="n">Den</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">fref_clock_ratio</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="p">(</span><span class="n">Den</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">Rest</span><span class="p">);</span>
			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="n">lo5</span><span class="p">);</span>
			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="n">lo6</span><span class="p">);</span>

			<span class="n">lo6</span> <span class="o">=</span> <span class="n">tune</span><span class="o">-&gt;</span><span class="n">tuner_enable</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">analog_output</span><span class="p">)</span>
				<span class="n">lo6</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo6</span> <span class="o">&amp;</span> <span class="mh">0xff9f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">;</span>

			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="n">lo6</span> <span class="o">|</span> <span class="n">EN_LO</span> <span class="o">|</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">use_pwm_agc</span> <span class="o">*</span> <span class="n">EN_CRYSTAL</span><span class="p">);</span>

		<span class="p">}</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_rf</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_request</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">current_standard</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">delivery_system</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">calibrate</span> <span class="o">=</span> <span class="n">CAPTRIM_CAL</span><span class="p">;</span>	<span class="cm">/* captrim serach now */</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tune_state</span> <span class="o">==</span> <span class="n">CT_TUNER_STEP_0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Warning : because of captrim cal, if you change this step, change it also in _cal.c file because it is the step following captrim cal state machine */</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_wbd_slope</span> <span class="o">*</span><span class="n">wbd</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_wbd_table</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">current_rf</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">&gt;</span> <span class="n">wbd</span><span class="o">-&gt;</span><span class="n">max_freq</span><span class="p">)</span>
			<span class="n">wbd</span><span class="o">++</span><span class="p">;</span>

		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x07ff</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Final Captrim: %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">fcaptrim</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;HFDIV code: %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">hfdiv_code</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;VCO = %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">vco_band</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;VCOF in kHz: %d ((%d*%d) &lt;&lt; 1))&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">hfdiv</span> <span class="o">*</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_request</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">hfdiv</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_request</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;REFDIV: %d, FREF: %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">clock_khz</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;FBDIV: %d, Rest: %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">));</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Num: %d, Den: %d, SD: %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dib0090_read_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>

<span class="cp">#define WBD     0x781		</span><span class="cm">/* 1 1 1 1 0000 0 0 1 */</span><span class="cp"></span>
		<span class="n">c</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wbd</span><span class="o">-&gt;</span><span class="n">wbd_gain</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">wbd</span><span class="o">-&gt;</span><span class="n">wbd_gain</span><span class="p">;</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">wbdmux</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">WBD</span> <span class="o">|</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">use_pwm_agc</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">wbdmux</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">tune</span><span class="o">-&gt;</span><span class="n">tuner_enable</span> <span class="o">==</span> <span class="n">EN_CAB</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">.</span><span class="n">p1g</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;P1G : The cable band is selected and lna_tune = %d&quot;</span><span class="p">,</span> <span class="n">tune</span><span class="o">-&gt;</span><span class="n">lna_tune</span><span class="p">);</span>
			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="n">tune</span><span class="o">-&gt;</span><span class="n">lna_bias</span><span class="p">);</span>
			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0xb800</span> <span class="o">|</span> <span class="p">(</span><span class="n">tune</span><span class="o">-&gt;</span><span class="n">lna_tune</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tune</span><span class="o">-&gt;</span><span class="n">switch_trim</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="p">(</span><span class="n">tune</span><span class="o">-&gt;</span><span class="n">lna_tune</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="n">tune</span><span class="o">-&gt;</span><span class="n">lna_bias</span><span class="p">);</span>

		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="n">tune</span><span class="o">-&gt;</span><span class="n">v2i</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="n">tune</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">);</span>
		<span class="n">dib0090_write_reg</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="n">tune</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">);</span>
		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STEP_1</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tune_state</span> <span class="o">==</span> <span class="n">CT_TUNER_STEP_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* initialize the lt gain register */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">rf_lt_def</span> <span class="o">=</span> <span class="mh">0x7c00</span><span class="p">;</span>

		<span class="n">dib0090_set_bandwidth</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_is_tuned</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">calibrate</span> <span class="o">|=</span> <span class="n">WBD_CAL</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">calibrate</span> <span class="o">|=</span> <span class="n">TEMP_CAL</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_STOP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">FE_CALLBACK_TIME_NEVER</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0090_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">);</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">frontend_tune_state</span> <span class="nf">dib0090_get_tune_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">tune_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib0090_get_tune_state</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dib0090_set_tune_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">enum</span> <span class="n">frontend_tune_state</span> <span class="n">tune_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">tune_state</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib0090_set_tune_state</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0090_get_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">frequency</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>

	<span class="o">*</span><span class="n">frequency</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">current_rf</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0090_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">tune_state</span> <span class="o">=</span> <span class="n">CT_TUNER_START</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dib0090_tune</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">FE_CALLBACK_TIME_NEVER</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">ret</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">tune_state</span> <span class="o">!=</span> <span class="n">CT_TUNER_STOP</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dvb_tuner_ops</span> <span class="n">dib0090_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DiBcom DiB0090&quot;</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_min</span> <span class="o">=</span> <span class="mi">45000000</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_max</span> <span class="o">=</span> <span class="mi">860000000</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_step</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
		 <span class="p">},</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">dib0090_release</span><span class="p">,</span>

	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">dib0090_wakeup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">dib0090_sleep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="n">dib0090_set_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frequency</span> <span class="o">=</span> <span class="n">dib0090_get_frequency</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dvb_tuner_ops</span> <span class="n">dib0090_fw_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DiBcom DiB0090&quot;</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_min</span> <span class="o">=</span> <span class="mi">45000000</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_max</span> <span class="o">=</span> <span class="mi">860000000</span><span class="p">,</span>
		 <span class="p">.</span><span class="n">frequency_step</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
		 <span class="p">},</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">dib0090_release</span><span class="p">,</span>

	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_params</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_frequency</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_wbd_slope</span> <span class="n">dib0090_wbd_table_default</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">470</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">860</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">866</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">375</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">1700</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">850</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">2900</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0xFFFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="nf">dib0090_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_config</span> <span class="o">*</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">fe</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">);</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span> <span class="o">=</span> <span class="n">st</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">wbd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">current_wbd_table</span> <span class="o">=</span> <span class="n">dib0090_wbd_table_default</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">current_wbd_table</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">wbd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dib0090_reset</span><span class="p">(</span><span class="n">fe</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_mem</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DiB0090: successfully identified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dib0090_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_tuner_ops</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">fe</span><span class="p">;</span>
 <span class="nl">free_mem:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib0090_register</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="nf">dib0090_fw_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dib0090_config</span> <span class="o">*</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0090_fw_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dib0090_fw_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">fe</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_buffer_lock</span><span class="p">);</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span> <span class="o">=</span> <span class="n">st</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dib0090_fw_reset_digital</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_mem</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;DiB0090 FW: successfully identified&quot;</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dib0090_fw_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_tuner_ops</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">fe</span><span class="p">;</span>
<span class="nl">free_mem:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">tuner_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dib0090_fw_register</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Patrick Boettcher &lt;pboettcher@dibcom.fr&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Olivier Grenie &lt;olivier.grenie@dibcom.fr&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for the DiBcom 0090 base-band RF Tuner&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
