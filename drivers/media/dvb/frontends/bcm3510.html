<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › frontends › bcm3510.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>bcm3510.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Support for the Broadcom BCM3510 ATSC demodulator (1st generation Air2PC)</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2001-5, B2C2 inc.</span>
<span class="cm"> *</span>
<span class="cm"> *  GPL/Linux driver written by Patrick Boettcher &lt;patrick.boettcher@desy.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This driver is &quot;hard-coded&quot; to be used with the 1st generation of</span>
<span class="cm"> *  Technisat/B2C2&#39;s Air2PC ATSC PCI/USB cards/boxes. The pll-programming</span>
<span class="cm"> *  (Panasonic CT10S) is located here, which is actually wrong. Unless there is</span>
<span class="cm"> *  another device with a BCM3510, this is no problem.</span>
<span class="cm"> *</span>
<span class="cm"> *  The driver works also with QAM64 DVB-C, but had an unreasonable high</span>
<span class="cm"> *  UNC. (Tested with the Air2PC ATSC 1st generation)</span>
<span class="cm"> *</span>
<span class="cm"> *  You&#39;ll need a firmware for this driver in order to get it running. It is</span>
<span class="cm"> *  called &quot;dvb-fe-bcm3510-01.fw&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the Free</span>
<span class="cm"> * Software Foundation; either version 2 of the License, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc., 675 Mass</span>
<span class="cm"> * Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &quot;dvb_frontend.h&quot;</span>
<span class="cp">#include &quot;bcm3510.h&quot;</span>
<span class="cp">#include &quot;bcm3510_priv.h&quot;</span>

<span class="k">struct</span> <span class="n">bcm3510_state</span> <span class="p">{</span>

	<span class="k">struct</span> <span class="n">i2c_adapter</span><span class="o">*</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">bcm3510_config</span><span class="o">*</span> <span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="n">frontend</span><span class="p">;</span>

	<span class="cm">/* demodulator private data */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">hab_mutex</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">firmware_loaded</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next_status_check</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">status_check_interval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bcm3510_hab_cmd_status1</span> <span class="n">status1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bcm3510_hab_cmd_status2</span> <span class="n">status2</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;set debugging level (1=info,2=i2c (|-able)).&quot;</span><span class="p">);</span>

<span class="cp">#define dprintk(level,x...) if (level &amp; debug) printk(x)</span>
<span class="cp">#define dbufout(b,l,m) {\</span>
<span class="cp">	    int i; \</span>
<span class="cp">	    for (i = 0; i &lt; l; i++) \</span>
<span class="cp">		m(&quot;%02x &quot;,b[i]); \</span>
<span class="cp">}</span>
<span class="cp">#define deb_info(args...) dprintk(0x01,args)</span>
<span class="cp">#define deb_i2c(args...)  dprintk(0x02,args)</span>
<span class="cp">#define deb_hab(args...)  dprintk(0x04,args)</span>

<span class="cm">/* transfer functions */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_writebytes</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bcm3510_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">b</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">};</span>

	<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">buf</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>

	<span class="n">deb_i2c</span><span class="p">(</span><span class="s">&quot;i2c wr %02x: &quot;</span><span class="p">,</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">dbufout</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">len</span><span class="p">,</span><span class="n">deb_i2c</span><span class="p">);</span>
	<span class="n">deb_i2c</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">i2c_transfer</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s: i2c write error (addr %02x, reg %02x, err == %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>  <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_readbytes</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bcm3510_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>        <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span> <span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span>  <span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">i2c_transfer</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s: i2c read error (addr %02x, reg %02x, err == %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">demod_address</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>  <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">deb_i2c</span><span class="p">(</span><span class="s">&quot;i2c rd %02x: &quot;</span><span class="p">,</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">dbufout</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">len</span><span class="p">,</span><span class="n">deb_i2c</span><span class="p">);</span>
	<span class="n">deb_i2c</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_writeB</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm3510_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">bcm3510_register_value</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bcm3510_writebytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="n">reg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="p">.</span><span class="n">raw</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_readB</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm3510_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">bcm3510_register_value</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bcm3510_readbytes</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="n">reg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Host Access Buffer transfers */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_hab_get_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm3510_state</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bcm3510_register_value</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span><span class="n">i</span><span class="p">;</span>

	<span class="n">v</span><span class="p">.</span><span class="n">HABADR_a6</span><span class="p">.</span><span class="n">HABADR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_writeB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xa6</span><span class="p">,</span><span class="n">v</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_readB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xa7</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">HABDATA_a7</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_hab_send_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm3510_state</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bcm3510_register_value</span> <span class="n">v</span><span class="p">,</span><span class="n">hab</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span><span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>

<span class="cm">/* Check if any previous HAB request still needs to be serviced by the</span>
<span class="cm"> * Acquisition Processor before sending new request */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_readB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xa8</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">HABSTAT_a8</span><span class="p">.</span><span class="n">HABR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;HAB is running already - clearing it.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">v</span><span class="p">.</span><span class="n">HABSTAT_a8</span><span class="p">.</span><span class="n">HABR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bcm3510_writeB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xa8</span><span class="p">,</span><span class="n">v</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><pre><code>return -EBUSY;
</code></pre></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>

<span class="cm">/* Send the start HAB Address (automatically incremented after write of</span>
<span class="cm"> * HABDATA) and write the HAB Data */</span>
	<span class="n">hab</span><span class="p">.</span><span class="n">HABADR_a6</span><span class="p">.</span><span class="n">HABADR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_writeB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xa6</span><span class="p">,</span><span class="n">hab</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hab</span><span class="p">.</span><span class="n">HABDATA_a7</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_writeB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xa7</span><span class="p">,</span><span class="n">hab</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/* Set the HABR bit to indicate AP request in progress (LBHABR allows HABR to</span>
<span class="cm"> * be written) */</span>
	<span class="n">v</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">v</span><span class="p">.</span><span class="n">HABSTAT_a8</span><span class="p">.</span><span class="n">HABR</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">v</span><span class="p">.</span><span class="n">HABSTAT_a8</span><span class="p">.</span><span class="n">LDHABR</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_writeB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xa8</span><span class="p">,</span><span class="n">v</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="cm">/* Polling method: Wait until the AP finishes processing the HAB request */</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;waiting for HAB to complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_readB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xa8</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v</span><span class="p">.</span><span class="n">HABSTAT_a8</span><span class="p">.</span><span class="n">HABR</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;send_request execution timed out.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_do_hab_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm3510_state</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">msgid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">obuf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">olen</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ibuf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ilen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ob</span><span class="p">[</span><span class="n">olen</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span><span class="n">ib</span><span class="p">[</span><span class="n">ilen</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ob</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">ob</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">msgid</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ob</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">obuf</span><span class="p">,</span><span class="n">olen</span><span class="p">);</span>

	<span class="n">deb_hab</span><span class="p">(</span><span class="s">&quot;hab snd: &quot;</span><span class="p">);</span>
	<span class="n">dbufout</span><span class="p">(</span><span class="n">ob</span><span class="p">,</span><span class="n">olen</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">deb_hab</span><span class="p">);</span>
	<span class="n">deb_hab</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">hab_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_hab_send_request</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">ob</span><span class="p">,</span> <span class="n">olen</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_hab_get_response</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ilen</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">deb_hab</span><span class="p">(</span><span class="s">&quot;hab get: &quot;</span><span class="p">);</span>
	<span class="n">dbufout</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="n">ilen</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">deb_hab</span><span class="p">);</span>
	<span class="n">deb_hab</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ibuf</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ib</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">ilen</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">hab_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/* not needed, we use a semaphore to prevent HAB races */</span>
<span class="c">static int bcm3510_is_ap_ready(struct bcm3510_state *st)</span>
<span class="c">{</span>
<span class="c">	bcm3510_register_value ap,hab;</span>
<span class="c">	int ret;</span>

<span class="c">	if ((ret = bcm3510_readB(st,0xa8,&amp;hab)) &lt; 0 ||</span>
<span class="c">		(ret = bcm3510_readB(st,0xa2,&amp;ap) &lt; 0))</span>
<span class="c">		return ret;</span>

<span class="c">	if (ap.APSTAT1_a2.RESET || ap.APSTAT1_a2.IDLE || ap.APSTAT1_a2.STOP || hab.HABSTAT_a8.HABR) {</span>
<span class="c">		deb_info(&quot;AP is busy\n&quot;);</span>
<span class="c">		return -EBUSY;</span>
<span class="c">	}</span>

<span class="c">	return 0;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_bert_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm3510_state</span> <span class="o">*</span><span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bcm3510_register_value</span> <span class="n">b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_readB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xfa</span><span class="p">,</span><span class="o">&amp;</span><span class="n">b</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">b</span><span class="p">.</span><span class="n">BERCTL_fa</span><span class="p">.</span><span class="n">RESYNC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bcm3510_writeB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xfa</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>
	<span class="n">b</span><span class="p">.</span><span class="n">BERCTL_fa</span><span class="p">.</span><span class="n">RESYNC</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">bcm3510_writeB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xfa</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>
	<span class="n">b</span><span class="p">.</span><span class="n">BERCTL_fa</span><span class="p">.</span><span class="n">RESYNC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bcm3510_writeB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xfa</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>
	<span class="n">b</span><span class="p">.</span><span class="n">BERCTL_fa</span><span class="p">.</span><span class="n">CNTCTL</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">b</span><span class="p">.</span><span class="n">BERCTL_fa</span><span class="p">.</span><span class="n">BITCNT</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">bcm3510_writeB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xfa</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>

	<span class="cm">/* clear residual bit counter TODO  */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_refresh_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm3510_state</span> <span class="o">*</span><span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">next_status_check</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bcm3510_do_hab_cmd</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">CMD_STATUS</span><span class="p">,</span> <span class="n">MSGID_STATUS1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">status1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">status1</span><span class="p">));</span>
		<span class="n">bcm3510_do_hab_cmd</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">CMD_STATUS</span><span class="p">,</span> <span class="n">MSGID_STATUS2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">status2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">status2</span><span class="p">));</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">next_status_check</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">status_check_interval</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_status_t</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm3510_state</span><span class="o">*</span> <span class="n">st</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">bcm3510_refresh_state</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>

	<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">status1</span><span class="p">.</span><span class="n">STATUS1</span><span class="p">.</span><span class="n">RECEIVER_LOCK</span><span class="p">)</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_LOCK</span> <span class="o">|</span> <span class="n">FE_HAS_SYNC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">status1</span><span class="p">.</span><span class="n">STATUS1</span><span class="p">.</span><span class="n">FEC_LOCK</span><span class="p">)</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_VITERBI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">status1</span><span class="p">.</span><span class="n">STATUS1</span><span class="p">.</span><span class="n">OUT_PLL_LOCK</span><span class="p">)</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">|=</span> <span class="n">FE_HAS_SIGNAL</span> <span class="o">|</span> <span class="n">FE_HAS_CARRIER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FE_HAS_LOCK</span><span class="p">)</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">status_check_interval</span> <span class="o">=</span> <span class="mi">1500</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* more frequently checks if no lock has been achieved yet */</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">status_check_interval</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;real_status: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_read_ber</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">u32</span><span class="o">*</span> <span class="n">ber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm3510_state</span><span class="o">*</span> <span class="n">st</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">bcm3510_refresh_state</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>

	<span class="o">*</span><span class="n">ber</span> <span class="o">=</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">status2</span><span class="p">.</span><span class="n">LDBER0</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">status2</span><span class="p">.</span><span class="n">LDBER1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">status2</span><span class="p">.</span><span class="n">LDBER2</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_read_unc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">u32</span><span class="o">*</span> <span class="n">unc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm3510_state</span><span class="o">*</span> <span class="n">st</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">bcm3510_refresh_state</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="o">*</span><span class="n">unc</span> <span class="o">=</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">status2</span><span class="p">.</span><span class="n">LDUERC0</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">status2</span><span class="p">.</span><span class="n">LDUERC1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_read_signal_strength</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">u16</span><span class="o">*</span> <span class="n">strength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm3510_state</span><span class="o">*</span> <span class="n">st</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">t</span><span class="p">;</span>

	<span class="n">bcm3510_refresh_state</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">status2</span><span class="p">.</span><span class="n">SIGNAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="mi">190</span><span class="p">)</span>
		<span class="n">t</span> <span class="o">=</span> <span class="mi">190</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">)</span>
		<span class="n">t</span> <span class="o">=</span> <span class="mi">90</span><span class="p">;</span>

	<span class="n">t</span> <span class="o">-=</span> <span class="mi">90</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="mh">0xff</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
	<span class="cm">/* normalize if necessary */</span>
	<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">t</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_read_snr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="n">u16</span><span class="o">*</span> <span class="n">snr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm3510_state</span><span class="o">*</span> <span class="n">st</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">bcm3510_refresh_state</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>

	<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">status1</span><span class="p">.</span><span class="n">SNR_EST0</span><span class="o">*</span><span class="mi">1000</span> <span class="o">+</span> <span class="p">((</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">status1</span><span class="p">.</span><span class="n">SNR_EST1</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* tuner frontend programming */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_tuner_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm3510_state</span><span class="o">*</span> <span class="n">st</span><span class="p">,</span><span class="n">u8</span> <span class="n">bc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">n</span><span class="p">,</span> <span class="n">u8</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm3510_hab_cmd_tune</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm3510_hab_cmd_tune</span><span class="p">));</span>

<span class="cm">/* I2C Mode disabled,  set 16 control / Data pairs */</span>
	<span class="n">c</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">clock_width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/* CS1, CS0, DATA, CLK bits control the tuner RF_AGC_SEL pin is set to</span>
<span class="cm"> * logic high (as Configuration) */</span>
	<span class="n">c</span><span class="p">.</span><span class="n">misc</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
<span class="cm">/* Set duration of the initial state of TUNCTL = 3.34 micro Sec */</span>
	<span class="n">c</span><span class="p">.</span><span class="n">TUNCTL_state</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>

<span class="cm">/* PRESCALER DIVIDE RATIO | BC1_2_3_4; (band switch), 1stosc REFERENCE COUNTER REF_S12 and REF_S11 */</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">BITS_8</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">data</span>      <span class="o">=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="n">bc</span><span class="p">;</span>

<span class="cm">/* Control DATA pin, 1stosc REFERENCE COUNTER REF_S10 to REF_S3 */</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">BITS_8</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">data</span>      <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

<span class="cm">/* set CONTROL BIT 1 to 1, 1stosc REFERENCE COUNTER REF_S2 to REF_S1 */</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">BITS_3</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">data</span>      <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>

<span class="cm">/* control CS0 pin, pulse byte ? */</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">BITS_3</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">clk_off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">cs0</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">data</span>      <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>

<span class="cm">/* PGM_S18 to PGM_S11 */</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">BITS_8</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">data</span>      <span class="o">=</span> <span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

<span class="cm">/* PGM_S10 to PGM_S8, SWL_S7 to SWL_S3 */</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">BITS_8</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">data</span>      <span class="o">=</span> <span class="p">((</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

<span class="cm">/* SWL_S2 and SWL_S1, set CONTROL BIT 2 to 0 */</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">BITS_3</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">data</span>      <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xdf</span><span class="p">;</span>

<span class="cm">/* control CS0 pin, pulse byte ? */</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">BITS_3</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">clk_off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">cs0</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">data</span>      <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>

<span class="cm">/* PRESCALER DIVIDE RATIO, 2ndosc REFERENCE COUNTER REF_S12 and REF_S11 */</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">BITS_8</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">data</span>      <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>

<span class="cm">/* 2ndosc REFERENCE COUNTER REF_S10 to REF_S3 */</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">BITS_8</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">data</span>      <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>

<span class="cm">/* set CONTROL BIT 1 to 1, 2ndosc REFERENCE COUNTER REF_S2 to REF_S1 */</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">BITS_3</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">data</span>      <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>

<span class="cm">/* pulse byte */</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">BITS_3</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">clk_off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">cs1</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">11</span><span class="p">].</span><span class="n">data</span>      <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>

<span class="cm">/* PGM_S18 to PGM_S11 */</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">12</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">BITS_8</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">12</span><span class="p">].</span><span class="n">data</span>      <span class="o">=</span> <span class="mh">0x2a</span><span class="p">;</span>

<span class="cm">/* PGM_S10 to PGM_S8 and SWL_S7 to SWL_S3 */</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">13</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">BITS_8</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">13</span><span class="p">].</span><span class="n">data</span>      <span class="o">=</span> <span class="mh">0x8e</span><span class="p">;</span>

<span class="cm">/* SWL_S2 and SWL_S1 and set CONTROL BIT 2 to 0 */</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">14</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">BITS_3</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">14</span><span class="p">].</span><span class="n">data</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* Pulse Byte */</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">15</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">BITS_3</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">15</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">clk_off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">15</span><span class="p">].</span><span class="n">ctrl</span><span class="p">.</span><span class="n">cs1</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">ctl_dat</span><span class="p">[</span><span class="mi">15</span><span class="p">].</span><span class="n">data</span>      <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bcm3510_do_hab_cmd</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="n">CMD_TUNE</span><span class="p">,</span> <span class="n">MSGID_TUNE</span><span class="p">,(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_set_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm3510_state</span><span class="o">*</span> <span class="n">st</span><span class="p">,</span><span class="n">u32</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">bc</span><span class="p">,</span><span class="n">a</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">YIntercept</span><span class="p">,</span><span class="n">Tfvco1</span><span class="p">;</span>

	<span class="n">freq</span> <span class="o">/=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%dkHz:&quot;</span><span class="p">,</span><span class="n">freq</span><span class="p">);</span>
	<span class="cm">/* set Band Switch */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;=</span> <span class="mi">168000</span><span class="p">)</span>
		<span class="n">bc</span> <span class="o">=</span> <span class="mh">0x1c</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;=</span> <span class="mi">378000</span><span class="p">)</span>
		<span class="n">bc</span> <span class="o">=</span> <span class="mh">0x2c</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bc</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;=</span> <span class="mi">470000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">freq</span> <span class="o">-=</span> <span class="mi">470001</span><span class="p">;</span>
		<span class="n">YIntercept</span> <span class="o">=</span> <span class="mi">18805</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;=</span> <span class="mi">90000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">freq</span> <span class="o">-=</span> <span class="mi">90001</span><span class="p">;</span>
		<span class="n">YIntercept</span> <span class="o">=</span> <span class="mi">15005</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;=</span> <span class="mi">76000</span><span class="p">){</span>
		<span class="n">freq</span> <span class="o">-=</span> <span class="mi">76001</span><span class="p">;</span>
		<span class="n">YIntercept</span> <span class="o">=</span> <span class="mi">14865</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">freq</span> <span class="o">-=</span> <span class="mi">54001</span><span class="p">;</span>
		<span class="n">YIntercept</span> <span class="o">=</span> <span class="mi">14645</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">Tfvco1</span> <span class="o">=</span> <span class="p">(((</span><span class="n">freq</span><span class="o">/</span><span class="mi">6000</span><span class="p">)</span><span class="o">*</span><span class="mi">60</span> <span class="o">+</span> <span class="n">YIntercept</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">Tfvco1</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">a</span> <span class="o">=</span> <span class="n">Tfvco1</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot; BC1_2_3_4: %x, N: %x A: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bc</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">2047</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bcm3510_tuner_cmd</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="n">bc</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">a</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_set_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bcm3510_state</span><span class="o">*</span> <span class="n">st</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bcm3510_hab_cmd_ext_acquire</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bcm3510_hab_cmd_bert_control</span> <span class="n">bert</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QAM_256</span>:
			<span class="n">cmd</span><span class="p">.</span><span class="n">ACQUIRE0</span><span class="p">.</span><span class="n">MODE</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">ACQUIRE1</span><span class="p">.</span><span class="n">SYM_RATE</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">ACQUIRE1</span><span class="p">.</span><span class="n">IF_FREQ</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QAM_64</span>:
			<span class="n">cmd</span><span class="p">.</span><span class="n">ACQUIRE0</span><span class="p">.</span><span class="n">MODE</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">ACQUIRE1</span><span class="p">.</span><span class="n">SYM_RATE</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">ACQUIRE1</span><span class="p">.</span><span class="n">IF_FREQ</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		case QAM_256:</span>
<span class="c">			cmd.ACQUIRE0.MODE = 0x3;</span>
<span class="c">			break;</span>
<span class="c">		case QAM_128:</span>
<span class="c">			cmd.ACQUIRE0.MODE = 0x4;</span>
<span class="c">			break;</span>
<span class="c">		case QAM_64:</span>
<span class="c">			cmd.ACQUIRE0.MODE = 0x5;</span>
<span class="c">			break;</span>
<span class="c">		case QAM_32:</span>
<span class="c">			cmd.ACQUIRE0.MODE = 0x6;</span>
<span class="c">			break;</span>
<span class="c">		case QAM_16:</span>
<span class="c">			cmd.ACQUIRE0.MODE = 0x7;</span>
<span class="c">			break;</span>
<span class="cp">#endif</span>
		<span class="k">case</span> <span class="n">VSB_8</span>:
			<span class="n">cmd</span><span class="p">.</span><span class="n">ACQUIRE0</span><span class="p">.</span><span class="n">MODE</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">ACQUIRE1</span><span class="p">.</span><span class="n">SYM_RATE</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">ACQUIRE1</span><span class="p">.</span><span class="n">IF_FREQ</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VSB_16</span>:
			<span class="n">cmd</span><span class="p">.</span><span class="n">ACQUIRE0</span><span class="p">.</span><span class="n">MODE</span> <span class="o">=</span> <span class="mh">0x9</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">ACQUIRE1</span><span class="p">.</span><span class="n">SYM_RATE</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">ACQUIRE1</span><span class="p">.</span><span class="n">IF_FREQ</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">ACQUIRE0</span><span class="p">.</span><span class="n">OFFSET</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">ACQUIRE0</span><span class="p">.</span><span class="n">NTSCSWEEP</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">ACQUIRE0</span><span class="p">.</span><span class="n">FA</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">ACQUIRE0</span><span class="p">.</span><span class="n">BW</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/*	if (enableOffset) {</span>
<span class="cm">		cmd.IF_OFFSET0 = xx;</span>
<span class="cm">		cmd.IF_OFFSET1 = xx;</span>

<span class="cm">		cmd.SYM_OFFSET0 = xx;</span>
<span class="cm">		cmd.SYM_OFFSET1 = xx;</span>
<span class="cm">		if (enableNtscSweep) {</span>
<span class="cm">			cmd.NTSC_OFFSET0;</span>
<span class="cm">			cmd.NTSC_OFFSET1;</span>
<span class="cm">		}</span>
<span class="cm">	} */</span>
	<span class="n">bcm3510_do_hab_cmd</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">CMD_ACQUIRE</span><span class="p">,</span> <span class="n">MSGID_EXT_TUNER_ACQUIRE</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* doing it with different MSGIDs, data book and source differs */</span>
	<span class="n">bert</span><span class="p">.</span><span class="n">BE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bert</span><span class="p">.</span><span class="n">unused</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bcm3510_do_hab_cmd</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">CMD_STATE_CONTROL</span><span class="p">,</span> <span class="n">MSGID_BERT_CONTROL</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bert</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bert</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bcm3510_do_hab_cmd</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">CMD_STATE_CONTROL</span><span class="p">,</span> <span class="n">MSGID_BERT_SET</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bert</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bert</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bcm3510_bert_reset</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_set_freq</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">status1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">status1</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">status2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">status2</span><span class="p">));</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">status_check_interval</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>

<span class="cm">/* Give the AP some time */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_get_tune_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_frontend_tune_settings</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">step_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">max_drift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm3510_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm3510_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* firmware download:</span>
<span class="cm"> * firmware file is build up like this:</span>
<span class="cm"> * 16bit addr, 16bit length, 8byte of length</span>
<span class="cm"> */</span>
<span class="cp">#define BCM3510_DEFAULT_FIRMWARE &quot;dvb-fe-bcm3510-01.fw&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_write_ram</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm3510_state</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">;</span>
	<span class="n">bcm3510_register_value</span> <span class="n">vH</span><span class="p">,</span> <span class="n">vL</span><span class="p">,</span><span class="n">vD</span><span class="p">;</span>

	<span class="n">vH</span><span class="p">.</span><span class="n">MADRH_a9</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">vL</span><span class="p">.</span><span class="n">MADRL_aa</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_writeB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xa9</span><span class="p">,</span><span class="n">vH</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_writeB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xaa</span><span class="p">,</span><span class="n">vL</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vD</span><span class="p">.</span><span class="n">MDATA_ab</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_writeB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xab</span><span class="p">,</span><span class="n">vD</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_download_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm3510_state</span><span class="o">*</span> <span class="n">st</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">addr</span><span class="p">,</span><span class="n">len</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span><span class="n">i</span><span class="p">;</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;requesting firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">request_firmware</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">BCM3510_DEFAULT_FIRMWARE</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;could not load firmware (%s): %d&quot;</span><span class="p">,</span><span class="n">BCM3510_DEFAULT_FIRMWARE</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;got firmware: %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">b</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span> <span class="o">*</span><span class="p">(</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span> <span class="p">);</span>
		<span class="n">len</span>  <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span> <span class="o">*</span><span class="p">(</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span> <span class="p">);</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;firmware chunk, addr: 0x%04x, len: 0x%04x, total length: 0x%04zx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="n">len</span><span class="p">,</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_write_ram</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="o">&amp;</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">],</span><span class="n">len</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;firmware download failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;firmware download successfully completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_check_firmware_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm3510_state</span> <span class="o">*</span><span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm3510_hab_cmd_get_version_info</span> <span class="n">ver</span><span class="p">;</span>
	<span class="n">bcm3510_do_hab_cmd</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="n">CMD_GET_VERSION_INFO</span><span class="p">,</span><span class="n">MSGID_GET_VERSION_INFO</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ver</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ver</span><span class="p">));</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;Version information: 0x%02x 0x%02x 0x%02x 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ver</span><span class="p">.</span><span class="n">microcode_version</span><span class="p">,</span> <span class="n">ver</span><span class="p">.</span><span class="n">script_version</span><span class="p">,</span> <span class="n">ver</span><span class="p">.</span><span class="n">config_version</span><span class="p">,</span> <span class="n">ver</span><span class="p">.</span><span class="n">demod_version</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ver</span><span class="p">.</span><span class="n">script_version</span> <span class="o">==</span> <span class="n">BCM3510_DEF_SCRIPT_VERSION</span> <span class="o">&amp;&amp;</span>
		<span class="n">ver</span><span class="p">.</span><span class="n">config_version</span> <span class="o">==</span> <span class="n">BCM3510_DEF_CONFIG_VERSION</span> <span class="o">&amp;&amp;</span>
		<span class="n">ver</span><span class="p">.</span><span class="n">demod_version</span>  <span class="o">==</span> <span class="n">BCM3510_DEF_DEMOD_VERSION</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;version check failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* (un)resetting the AP */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm3510_state</span> <span class="o">*</span><span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">t</span><span class="p">;</span>
	<span class="n">bcm3510_register_value</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">bcm3510_readB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xa0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="p">);</span> <span class="n">v</span><span class="p">.</span><span class="n">HCTL1_a0</span><span class="p">.</span><span class="n">RESET</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_writeB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xa0</span><span class="p">,</span><span class="n">v</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_readB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xa2</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">APSTAT1_a2</span><span class="p">.</span><span class="n">RESET</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;reset timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_clear_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm3510_state</span> <span class="o">*</span><span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bcm3510_register_value</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>

	<span class="n">v</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_writeB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xa0</span><span class="p">,</span><span class="n">v</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_readB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xa2</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="cm">/* verify that reset is cleared */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v</span><span class="p">.</span><span class="n">APSTAT1_a2</span><span class="p">.</span><span class="n">RESET</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;reset clear timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_init_cold</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm3510_state</span> <span class="o">*</span><span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">bcm3510_register_value</span> <span class="n">v</span><span class="p">;</span>

	<span class="cm">/* read Acquisation Processor status register and check it is not in RUN mode */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_readB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xa2</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">APSTAT1_a2</span><span class="p">.</span><span class="n">RUN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;AP is already running - firmware already loaded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;reset?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_reset</span><span class="p">(</span><span class="n">st</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;tristate?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* tri-state */</span>
	<span class="n">v</span><span class="p">.</span><span class="n">TSTCTL_2e</span><span class="p">.</span><span class="n">CTL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_writeB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0x2e</span><span class="p">,</span><span class="n">v</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;firmware?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_download_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_clear_reset</span><span class="p">(</span><span class="n">st</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* anything left here to Let the acquisition processor begin execution at program counter 0000 ??? */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm3510_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm3510_state</span><span class="o">*</span> <span class="n">st</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">demodulator_priv</span><span class="p">;</span>
	<span class="n">bcm3510_register_value</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bcm3510_hab_cmd_set_agc</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_readB</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="mh">0xca</span><span class="p">,</span><span class="o">&amp;</span><span class="n">j</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;JDEC: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">j</span><span class="p">.</span><span class="n">raw</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">JDEC_ca</span><span class="p">.</span><span class="n">JDEC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">JDEC_WAIT_AT_RAM</span>:
			<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;attempting to download firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_init_cold</span><span class="p">(</span><span class="n">st</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">JDEC_EEPROM_LOAD_WAIT</span>: <span class="cm">/* fall-through is wanted */</span>
			<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;firmware is loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bcm3510_check_firmware_version</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">c</span><span class="p">.</span><span class="n">SEL</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bcm3510_do_hab_cmd</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="n">CMD_AUTO_PARAM</span><span class="p">,</span><span class="n">MSGID_SET_RF_AGC_SEL</span><span class="p">,(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">),</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">bcm3510_ops</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="nf">bcm3510_attach</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">bcm3510_config</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm3510_state</span><span class="o">*</span> <span class="n">state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">bcm3510_register_value</span> <span class="n">v</span><span class="p">;</span>

	<span class="cm">/* allocate memory for the internal state */</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm3510_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* setup the state */</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>

	<span class="cm">/* create dvb_frontend */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcm3510_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend_ops</span><span class="p">));</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">.</span><span class="n">demodulator_priv</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">hab_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bcm3510_readB</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="mh">0xe0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;Revision: 0x%1x, Layer: 0x%1x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">v</span><span class="p">.</span><span class="n">REVID_e0</span><span class="p">.</span><span class="n">REV</span><span class="p">,</span><span class="n">v</span><span class="p">.</span><span class="n">REVID_e0</span><span class="p">.</span><span class="n">LAYER</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">v</span><span class="p">.</span><span class="n">REVID_e0</span><span class="p">.</span><span class="n">REV</span> <span class="o">!=</span> <span class="mh">0x1</span> <span class="o">&amp;&amp;</span> <span class="n">v</span><span class="p">.</span><span class="n">REVID_e0</span><span class="p">.</span><span class="n">LAYER</span> <span class="o">!=</span> <span class="mh">0xb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="cm">/* cold */</span>
		<span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">REVID_e0</span><span class="p">.</span><span class="n">REV</span> <span class="o">!=</span> <span class="mh">0x8</span> <span class="o">&amp;&amp;</span> <span class="n">v</span><span class="p">.</span><span class="n">REVID_e0</span><span class="p">.</span><span class="n">LAYER</span> <span class="o">!=</span> <span class="mh">0x0</span><span class="p">))</span>   <span class="cm">/* warm */</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">info</span><span class="p">(</span><span class="s">&quot;Revision: 0x%1x, Layer: 0x%1x.&quot;</span><span class="p">,</span><span class="n">v</span><span class="p">.</span><span class="n">REVID_e0</span><span class="p">.</span><span class="n">REV</span><span class="p">,</span><span class="n">v</span><span class="p">.</span><span class="n">REVID_e0</span><span class="p">.</span><span class="n">LAYER</span><span class="p">);</span>

	<span class="n">bcm3510_reset</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">frontend</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">bcm3510_attach</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="n">bcm3510_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">delsys</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SYS_ATSC</span><span class="p">,</span> <span class="n">SYS_DVBC_ANNEX_B</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Broadcom BCM3510 VSB/QAM frontend&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_min</span> <span class="o">=</span>  <span class="mi">54000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">frequency_max</span> <span class="o">=</span> <span class="mi">803000000</span><span class="p">,</span>
		<span class="cm">/* stepsize is just a guess */</span>
		<span class="p">.</span><span class="n">frequency_stepsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">caps</span> <span class="o">=</span>
			<span class="n">FE_CAN_FEC_1_2</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_2_3</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_3_4</span> <span class="o">|</span>
			<span class="n">FE_CAN_FEC_5_6</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_7_8</span> <span class="o">|</span> <span class="n">FE_CAN_FEC_AUTO</span> <span class="o">|</span>
			<span class="n">FE_CAN_8VSB</span> <span class="o">|</span> <span class="n">FE_CAN_16VSB</span> <span class="o">|</span>
			<span class="n">FE_CAN_QAM_16</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_64</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_128</span> <span class="o">|</span> <span class="n">FE_CAN_QAM_256</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">bcm3510_release</span><span class="p">,</span>

	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">bcm3510_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">bcm3510_sleep</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_frontend</span> <span class="o">=</span> <span class="n">bcm3510_set_frontend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tune_settings</span> <span class="o">=</span> <span class="n">bcm3510_get_tune_settings</span><span class="p">,</span>

	<span class="p">.</span><span class="n">read_status</span> <span class="o">=</span> <span class="n">bcm3510_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ber</span> <span class="o">=</span> <span class="n">bcm3510_read_ber</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_signal_strength</span> <span class="o">=</span> <span class="n">bcm3510_read_signal_strength</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_snr</span> <span class="o">=</span> <span class="n">bcm3510_read_snr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_ucblocks</span> <span class="o">=</span> <span class="n">bcm3510_read_unc</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Broadcom BCM3510 ATSC (8VSB/16VSB &amp; ITU J83 AnnexB FEC QAM64/256) demodulator driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Patrick Boettcher &lt;patrick.boettcher@desy.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
