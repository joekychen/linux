<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › dvb-core › dvb_ca_en50221.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>dvb_ca_en50221.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * dvb_ca.c: generic DVB functions for EN50221 CAM interfaces</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004 Andrew de Quincey</span>
<span class="cm"> *</span>
<span class="cm"> * Parts of this file were based on sources as follows:</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2003 Ralph Metzler &lt;rjkm@metzlerbros.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * based on code:</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1999-2002 Ralph  Metzler</span>
<span class="cm"> *                       &amp; Marcus Metzler for convergence integrated media GmbH</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version 2</span>
<span class="cm"> * of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> * Or, point your browser to http://www.gnu.org/copyleft/gpl.html</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>

<span class="cp">#include &quot;dvb_ca_en50221.h&quot;</span>
<span class="cp">#include &quot;dvb_ringbuffer.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dvb_ca_en50221_debug</span><span class="p">;</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">cam_debug</span><span class="p">,</span> <span class="n">dvb_ca_en50221_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cam_debug</span><span class="p">,</span> <span class="s">&quot;enable verbose debug messages&quot;</span><span class="p">);</span>

<span class="cp">#define dprintk if (dvb_ca_en50221_debug) printk</span>

<span class="cp">#define INIT_TIMEOUT_SECS 10</span>

<span class="cp">#define HOST_LINK_BUF_SIZE 0x200</span>

<span class="cp">#define RX_BUFFER_SIZE 65535</span>

<span class="cp">#define MAX_RX_PACKETS_PER_ITERATION 10</span>

<span class="cp">#define CTRLIF_DATA      0</span>
<span class="cp">#define CTRLIF_COMMAND   1</span>
<span class="cp">#define CTRLIF_STATUS    1</span>
<span class="cp">#define CTRLIF_SIZE_LOW  2</span>
<span class="cp">#define CTRLIF_SIZE_HIGH 3</span>

<span class="cp">#define CMDREG_HC        1	</span><span class="cm">/* Host control */</span><span class="cp"></span>
<span class="cp">#define CMDREG_SW        2	</span><span class="cm">/* Size write */</span><span class="cp"></span>
<span class="cp">#define CMDREG_SR        4	</span><span class="cm">/* Size read */</span><span class="cp"></span>
<span class="cp">#define CMDREG_RS        8	</span><span class="cm">/* Reset interface */</span><span class="cp"></span>
<span class="cp">#define CMDREG_FRIE   0x40	</span><span class="cm">/* Enable FR interrupt */</span><span class="cp"></span>
<span class="cp">#define CMDREG_DAIE   0x80	</span><span class="cm">/* Enable DA interrupt */</span><span class="cp"></span>
<span class="cp">#define IRQEN (CMDREG_DAIE)</span>

<span class="cp">#define STATUSREG_RE     1	</span><span class="cm">/* read error */</span><span class="cp"></span>
<span class="cp">#define STATUSREG_WE     2	</span><span class="cm">/* write error */</span><span class="cp"></span>
<span class="cp">#define STATUSREG_FR  0x40	</span><span class="cm">/* module free */</span><span class="cp"></span>
<span class="cp">#define STATUSREG_DA  0x80	</span><span class="cm">/* data available */</span><span class="cp"></span>
<span class="cp">#define STATUSREG_TXERR (STATUSREG_RE|STATUSREG_WE)	</span><span class="cm">/* general transfer error */</span><span class="cp"></span>


<span class="cp">#define DVB_CA_SLOTSTATE_NONE           0</span>
<span class="cp">#define DVB_CA_SLOTSTATE_UNINITIALISED  1</span>
<span class="cp">#define DVB_CA_SLOTSTATE_RUNNING        2</span>
<span class="cp">#define DVB_CA_SLOTSTATE_INVALID        3</span>
<span class="cp">#define DVB_CA_SLOTSTATE_WAITREADY      4</span>
<span class="cp">#define DVB_CA_SLOTSTATE_VALIDATE       5</span>
<span class="cp">#define DVB_CA_SLOTSTATE_WAITFR         6</span>
<span class="cp">#define DVB_CA_SLOTSTATE_LINKINIT       7</span>


<span class="cm">/* Information on a CA slot */</span>
<span class="k">struct</span> <span class="n">dvb_ca_slot</span> <span class="p">{</span>

	<span class="cm">/* current state of the CAM */</span>
	<span class="kt">int</span> <span class="n">slot_state</span><span class="p">;</span>

	<span class="cm">/* mutex used for serializing access to one CI slot */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">slot_lock</span><span class="p">;</span>

	<span class="cm">/* Number of CAMCHANGES that have occurred since last processing */</span>
	<span class="n">atomic_t</span> <span class="n">camchange_count</span><span class="p">;</span>

	<span class="cm">/* Type of last CAMCHANGE */</span>
	<span class="kt">int</span> <span class="n">camchange_type</span><span class="p">;</span>

	<span class="cm">/* base address of CAM config */</span>
	<span class="n">u32</span> <span class="n">config_base</span><span class="p">;</span>

	<span class="cm">/* value to write into Config Control register */</span>
	<span class="n">u8</span> <span class="n">config_option</span><span class="p">;</span>

	<span class="cm">/* if 1, the CAM supports DA IRQs */</span>
	<span class="n">u8</span> <span class="n">da_irq_supported</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* size of the buffer to use when talking to the CAM */</span>
	<span class="kt">int</span> <span class="n">link_buf_size</span><span class="p">;</span>

	<span class="cm">/* buffer for incoming packets */</span>
	<span class="k">struct</span> <span class="n">dvb_ringbuffer</span> <span class="n">rx_buffer</span><span class="p">;</span>

	<span class="cm">/* timer used during various states of the slot */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Private CA-interface information */</span>
<span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="p">{</span>

	<span class="cm">/* pointer back to the public data structure */</span>
	<span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">pub</span><span class="p">;</span>

	<span class="cm">/* the DVB device */</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span><span class="p">;</span>

	<span class="cm">/* Flags describing the interface (DVB_CA_FLAG_*) */</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* number of slots supported by this CA interface */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">slot_count</span><span class="p">;</span>

	<span class="cm">/* information on each slot */</span>
	<span class="k">struct</span> <span class="n">dvb_ca_slot</span> <span class="o">*</span><span class="n">slot_info</span><span class="p">;</span>

	<span class="cm">/* wait queues for read() and write() operations */</span>
	<span class="n">wait_queue_head_t</span> <span class="n">wait_queue</span><span class="p">;</span>

	<span class="cm">/* PID of the monitoring thread */</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="kr">thread</span><span class="p">;</span>

	<span class="cm">/* Flag indicating if the CA device is open */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">open</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Flag indicating the thread should wake up now */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wakeup</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Delay the main thread should use */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span><span class="p">;</span>

	<span class="cm">/* Slot to start looking for data to read from in the next user-space read operation */</span>
	<span class="kt">int</span> <span class="n">next_read_slot</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">dvb_ca_en50221_thread_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dvb_ca_en50221_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">ebuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ecount</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dvb_ca_en50221_write_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">ebuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ecount</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> * Safely find needle in haystack.</span>
<span class="cm"> *</span>
<span class="cm"> * @param haystack Buffer to look in.</span>
<span class="cm"> * @param hlen Number of bytes in haystack.</span>
<span class="cm"> * @param needle Buffer to find.</span>
<span class="cm"> * @param nlen Number of bytes in needle.</span>
<span class="cm"> * @return Pointer into haystack needle was found at, or NULL if not found.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">findstr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">haystack</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hlen</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">needle</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hlen</span> <span class="o">&lt;</span> <span class="n">nlen</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">hlen</span> <span class="o">-</span> <span class="n">nlen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">haystack</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">needle</span><span class="p">,</span> <span class="n">nlen</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">haystack</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/* ******************************************************************************** */</span>
<span class="cm">/* EN50221 physical interface functions */</span>


<span class="cm">/**</span>
<span class="cm"> * Check CAM status.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_ca_en50221_check_camstatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">slot_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cam_present_now</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cam_changed</span><span class="p">;</span>

	<span class="cm">/* IRQ mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DVB_CA_EN50221_FLAG_IRQ_CAMCHANGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">camchange_count</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* poll mode */</span>
	<span class="n">slot_status</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">poll_slot_status</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">);</span>

	<span class="n">cam_present_now</span> <span class="o">=</span> <span class="p">(</span><span class="n">slot_status</span> <span class="o">&amp;</span> <span class="n">DVB_CA_EN50221_POLL_CAM_PRESENT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cam_changed</span> <span class="o">=</span> <span class="p">(</span><span class="n">slot_status</span> <span class="o">&amp;</span> <span class="n">DVB_CA_EN50221_POLL_CAM_CHANGED</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cam_changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">cam_present_old</span> <span class="o">=</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">!=</span> <span class="n">DVB_CA_SLOTSTATE_NONE</span><span class="p">);</span>
		<span class="n">cam_changed</span> <span class="o">=</span> <span class="p">(</span><span class="n">cam_present_now</span> <span class="o">!=</span> <span class="n">cam_present_old</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cam_changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cam_present_now</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">camchange_type</span> <span class="o">=</span> <span class="n">DVB_CA_EN50221_CAMCHANGE_REMOVED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">camchange_type</span> <span class="o">=</span> <span class="n">DVB_CA_EN50221_CAMCHANGE_INSERTED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">camchange_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">==</span> <span class="n">DVB_CA_SLOTSTATE_WAITREADY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">slot_status</span> <span class="o">&amp;</span> <span class="n">DVB_CA_EN50221_POLL_CAM_READY</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>move to validate state if reset is completed</p></td><td class="code"><div class="highlight"><pre>			<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_VALIDATE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cam_changed</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Wait for flags to become set on the STATUS register on a CAM interface,</span>
<span class="cm"> * checking for errors and timeout.</span>
<span class="cm"> *</span>
<span class="cm"> * @param ca CA instance.</span>
<span class="cm"> * @param slot Slot on interface.</span>
<span class="cm"> * @param waitfor Flags to wait for.</span>
<span class="cm"> * @param timeout_ms Timeout in milliseconds.</span>
<span class="cm"> *</span>
<span class="cm"> * @return 0 on success, nonzero on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_ca_en50221_wait_if_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="n">waitfor</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout_hz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* loop until timeout elapsed */</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">timeout_hz</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* read the status and check for error */</span>
		<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">read_cam_control</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">CTRLIF_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="cm">/* if we got the flags, it was successful! */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&amp;</span> <span class="n">waitfor</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s succeeded timeout:%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* check for timeout */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* wait for a bit */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s failed timeout:%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>

	<span class="cm">/* if we get here, we&#39;ve timed out */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Initialise the link layer connection to a CAM.</span>
<span class="cm"> *</span>
<span class="cm"> * @param ca CA instance.</span>
<span class="cm"> * @param slot Slot id.</span>
<span class="cm"> *</span>
<span class="cm"> * @return 0 on success, nonzero on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_ca_en50221_link_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buf_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* we&#39;ll be determining these during this function */</span>
	<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">da_irq_supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set the host link buffer size temporarily. it will be overwritten with the</span>
<span class="cm">	 * real negotiated size later. */</span>
	<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">link_buf_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* read the buffer size from the CAM */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">write_cam_control</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">CTRLIF_COMMAND</span><span class="p">,</span> <span class="n">IRQEN</span> <span class="o">|</span> <span class="n">CMDREG_SR</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_ca_en50221_wait_if_status</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">STATUSREG_DA</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_ca_en50221_read_data</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">write_cam_control</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">CTRLIF_COMMAND</span><span class="p">,</span> <span class="n">IRQEN</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* store it, and choose the minimum of our buffer and the CAM&#39;s buffer size */</span>
	<span class="n">buf_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf_size</span> <span class="o">&gt;</span> <span class="n">HOST_LINK_BUF_SIZE</span><span class="p">)</span>
		<span class="n">buf_size</span> <span class="o">=</span> <span class="n">HOST_LINK_BUF_SIZE</span><span class="p">;</span>
	<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">link_buf_size</span> <span class="o">=</span> <span class="n">buf_size</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf_size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf_size</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Chosen link buffer size of %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">);</span>

	<span class="cm">/* write the buffer size to the CAM */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">write_cam_control</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">CTRLIF_COMMAND</span><span class="p">,</span> <span class="n">IRQEN</span> <span class="o">|</span> <span class="n">CMDREG_SW</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_ca_en50221_wait_if_status</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">STATUSREG_FR</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_ca_en50221_write_data</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">write_cam_control</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">CTRLIF_COMMAND</span><span class="p">,</span> <span class="n">IRQEN</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* success */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Read a tuple from attribute memory.</span>
<span class="cm"> *</span>
<span class="cm"> * @param ca CA instance.</span>
<span class="cm"> * @param slot Slot id.</span>
<span class="cm"> * @param address Address to read from. Updated.</span>
<span class="cm"> * @param tupleType Tuple id byte. Updated.</span>
<span class="cm"> * @param tupleLength Tuple length. Updated.</span>
<span class="cm"> * @param tuple Dest buffer for tuple (must be 256 bytes). Updated.</span>
<span class="cm"> *</span>
<span class="cm"> * @return 0 on success, nonzero on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_ca_en50221_read_tuple</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">tupleType</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">tupleLength</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">tuple</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">_tupleType</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">_tupleLength</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">_address</span> <span class="o">=</span> <span class="o">*</span><span class="n">address</span><span class="p">;</span>

	<span class="cm">/* grab the next tuple length and type */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">_tupleType</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">read_attribute_mem</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">_address</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">_tupleType</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_tupleType</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;END OF CHAIN TUPLE type:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_tupleType</span><span class="p">);</span>
		<span class="o">*</span><span class="n">address</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tupleType</span> <span class="o">=</span> <span class="n">_tupleType</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tupleLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">_tupleLength</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">read_attribute_mem</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">_address</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">_tupleLength</span><span class="p">;</span>
	<span class="n">_address</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;TUPLE type:0x%x length:%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_tupleType</span><span class="p">,</span> <span class="n">_tupleLength</span><span class="p">);</span>

	<span class="cm">/* read in the whole tuple */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_tupleLength</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tuple</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">read_attribute_mem</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">_address</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;  0x%02x: 0x%02x %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i</span><span class="p">,</span> <span class="n">tuple</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
			<span class="p">((</span><span class="n">tuple</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">127</span><span class="p">))</span> <span class="o">?</span> <span class="n">tuple</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="sc">&#39;.&#39;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">_address</span> <span class="o">+=</span> <span class="p">(</span><span class="n">_tupleLength</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>success</p></td><td class="code"><div class="highlight"><pre>	<span class="o">*</span><span class="n">tupleType</span> <span class="o">=</span> <span class="n">_tupleType</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tupleLength</span> <span class="o">=</span> <span class="n">_tupleLength</span><span class="p">;</span>
	<span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="n">_address</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Parse attribute memory of a CAM module, extracting Config register, and checking</span>
<span class="cm"> * it is a DVB CAM module.</span>
<span class="cm"> *</span>
<span class="cm"> * @param ca CA instance.</span>
<span class="cm"> * @param slot Slot id.</span>
<span class="cm"> *</span>
<span class="cm"> * @return 0 on success, &lt;0 on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_ca_en50221_parse_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tupleLength</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tupleType</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tuple</span><span class="p">[</span><span class="mi">257</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dvb_str</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rasz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">got_cftableentry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">end_chain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">manfid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">devid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>CISTPL<em>DEVICE</em>0A</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span>
	     <span class="n">dvb_ca_en50221_read_tuple</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tupleType</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tupleLength</span><span class="p">,</span> <span class="n">tuple</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tupleType</span> <span class="o">!=</span> <span class="mh">0x1D</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>CISTPL<em>DEVICE</em>0C</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span>
	     <span class="n">dvb_ca_en50221_read_tuple</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tupleType</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tupleLength</span><span class="p">,</span> <span class="n">tuple</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tupleType</span> <span class="o">!=</span> <span class="mh">0x1C</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>CISTPL<em>VERS</em>1</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span>
	     <span class="n">dvb_ca_en50221_read_tuple</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tupleType</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tupleLength</span><span class="p">,</span> <span class="n">tuple</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tupleType</span> <span class="o">!=</span> <span class="mh">0x15</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>CISTPL_MANFID</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">dvb_ca_en50221_read_tuple</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tupleType</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">tupleLength</span><span class="p">,</span> <span class="n">tuple</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tupleType</span> <span class="o">!=</span> <span class="mh">0x20</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tupleLength</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">manfid</span> <span class="o">=</span> <span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">devid</span> <span class="o">=</span> <span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tuple</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>CISTPL_CONFIG</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">dvb_ca_en50221_read_tuple</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tupleType</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">tupleLength</span><span class="p">,</span> <span class="n">tuple</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tupleType</span> <span class="o">!=</span> <span class="mh">0x1A</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tupleLength</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* extract the configbase */</span>
	<span class="n">rasz</span> <span class="o">=</span> <span class="n">tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tupleLength</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">rasz</span> <span class="o">+</span> <span class="mi">14</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">config_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rasz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">config_base</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* check it contains the correct DVB string */</span>
	<span class="n">dvb_str</span> <span class="o">=</span> <span class="n">findstr</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">tuple</span><span class="p">,</span> <span class="n">tupleLength</span><span class="p">,</span> <span class="s">&quot;DVB_CI_V&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dvb_str</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tupleLength</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">dvb_str</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">tuple</span><span class="p">)</span> <span class="o">+</span> <span class="mi">12</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* is it a version we support? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">dvb_str</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;1.00&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb_ca adapter %d: Unsupported DVB CAM module version %c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ca</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">dvb_str</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">dvb_str</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">dvb_str</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">dvb_str</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* process the CFTABLE_ENTRY tuples, and any after those */</span>
	<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="n">end_chain</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">address</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">dvb_ca_en50221_read_tuple</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tupleType</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">tupleLength</span><span class="p">,</span> <span class="n">tuple</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">tupleType</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x1B</span>:	<span class="c1">// CISTPL_CFTABLE_ENTRY</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tupleLength</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">11</span> <span class="o">+</span> <span class="mi">17</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* if we&#39;ve already parsed one, just use it */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">got_cftableentry</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* get the config option */</span>
			<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">config_option</span> <span class="o">=</span> <span class="n">tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

			<span class="cm">/* OK, check it contains the correct strings */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">findstr</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">tuple</span><span class="p">,</span> <span class="n">tupleLength</span><span class="p">,</span> <span class="s">&quot;DVB_HOST&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">findstr</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">tuple</span><span class="p">,</span> <span class="n">tupleLength</span><span class="p">,</span> <span class="s">&quot;DVB_CI_MODULE&quot;</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">got_cftableentry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x14</span>:	<span class="c1">// CISTPL_NO_LINK</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0xFF</span>:	<span class="c1">// CISTPL_END</span>
			<span class="n">end_chain</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>	<span class="cm">/* Unknown tuple type - just skip this tuple and move to the next one */</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dvb_ca: Skipping unknown tuple type:0x%x length:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tupleType</span><span class="p">,</span>
				<span class="n">tupleLength</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">address</span> <span class="o">&gt;</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">got_cftableentry</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Valid DVB CAM detected MANID:%x DEVID:%x CONFIGBASE:0x%x CONFIGOPTION:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">manfid</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">config_base</span><span class="p">,</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">config_option</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>success!</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Set CAM&#39;s configoption correctly.</span>
<span class="cm"> *</span>
<span class="cm"> * @param ca CA instance.</span>
<span class="cm"> * @param slot Slot containing the CAM.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_ca_en50221_set_configoption</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">configoption</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* set the config option */</span>
	<span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">write_attribute_mem</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span>
				     <span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">config_base</span><span class="p">,</span>
				     <span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">config_option</span><span class="p">);</span>

	<span class="cm">/* check it */</span>
	<span class="n">configoption</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">read_attribute_mem</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">config_base</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Set configoption 0x%x, read configoption 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">config_option</span><span class="p">,</span> <span class="n">configoption</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>

	<span class="cm">/* fine! */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * This function talks to an EN50221 CAM control interface. It reads a buffer of</span>
<span class="cm"> * data from the CAM. The data can either be stored in a supplied buffer, or</span>
<span class="cm"> * automatically be added to the slot&#39;s rx_buffer.</span>
<span class="cm"> *</span>
<span class="cm"> * @param ca CA instance.</span>
<span class="cm"> * @param slot Slot to read from.</span>
<span class="cm"> * @param ebuf If non-NULL, the data will be written to this buffer. If NULL,</span>
<span class="cm"> * the data will be added into the buffering system as a normal fragment.</span>
<span class="cm"> * @param ecount Size of ebuf. Ignored if ebuf is NULL.</span>
<span class="cm"> *</span>
<span class="cm"> * @return Number of bytes read, or &lt; 0 on error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_ca_en50221_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">ebuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ecount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bytes_read</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="n">HOST_LINK_BUF_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* check if we have space for a link buf in the rx_buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ebuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">buf_free</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">rx_buffer</span><span class="p">.</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buf_free</span> <span class="o">=</span> <span class="n">dvb_ringbuffer_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">rx_buffer</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buf_free</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">link_buf_size</span> <span class="o">+</span> <span class="n">DVB_RINGBUFFER_PKTHDRSIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* check if there is data available */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">read_cam_control</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">CTRLIF_STATUS</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUSREG_DA</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* no data */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read the amount of data */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">read_cam_control</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">CTRLIF_SIZE_HIGH</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="n">bytes_read</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">read_cam_control</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">CTRLIF_SIZE_LOW</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="n">bytes_read</span> <span class="o">|=</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* check it will fit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ebuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes_read</span> <span class="o">&gt;</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">link_buf_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb_ca adapter %d: CAM tried to send a buffer larger than the link buffer size (%i &gt; %i)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ca</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">bytes_read</span><span class="p">,</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">link_buf_size</span><span class="p">);</span>
			<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_LINKINIT</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes_read</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb_ca adapter %d: CAM sent a buffer that was less than 2 bytes!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ca</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
			<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_LINKINIT</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes_read</span> <span class="o">&gt;</span> <span class="n">ecount</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb_ca adapter %d: CAM tried to send a buffer larger than the ecount size!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ca</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* fill the buffer */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bytes_read</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* read byte and check */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">read_cam_control</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">CTRLIF_DATA</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

		<span class="cm">/* OK, store it in the buffer */</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check for read error (RE should now be 0) */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">read_cam_control</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">CTRLIF_STATUS</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUSREG_RE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_LINKINIT</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* OK, add it to the receive buffer, or copy into external buffer if supplied */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ebuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">rx_buffer</span><span class="p">.</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dvb_ringbuffer_pkt_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">rx_buffer</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bytes_read</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ebuf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bytes_read</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Received CA packet for slot %i connection id 0x%x last_frag:%i size:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bytes_read</span><span class="p">);</span>

	<span class="cm">/* wake up readers when a last_fragment is received */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">bytes_read</span><span class="p">;</span>

<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * This function talks to an EN50221 CAM control interface. It writes a buffer of data</span>
<span class="cm"> * to a CAM.</span>
<span class="cm"> *</span>
<span class="cm"> * @param ca CA instance.</span>
<span class="cm"> * @param slot Slot to write to.</span>
<span class="cm"> * @param ebuf The data in this buffer is treated as a complete link-level packet to</span>
<span class="cm"> * be written.</span>
<span class="cm"> * @param count Size of ebuf.</span>
<span class="cm"> *</span>
<span class="cm"> * @return Number of bytes written, or &lt; 0 on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_ca_en50221_write_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bytes_write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>


	<span class="cm">/* sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bytes_write</span> <span class="o">&gt;</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">link_buf_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* it is possible we are dealing with a single buffer implementation,</span>
<span class="cm">	   thus if there is data available for read or if there is even a read</span>
<span class="cm">	   already in progress, we do nothing but awake the kernel thread to</span>
<span class="cm">	   process the data if necessary. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">read_cam_control</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">CTRLIF_STATUS</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exitnowrite</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STATUSREG_DA</span> <span class="o">|</span> <span class="n">STATUSREG_RE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUSREG_DA</span><span class="p">)</span>
			<span class="n">dvb_ca_en50221_thread_wakeup</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exitnowrite</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* OK, set HC bit */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">write_cam_control</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">CTRLIF_COMMAND</span><span class="p">,</span>
						 <span class="n">IRQEN</span> <span class="o">|</span> <span class="n">CMDREG_HC</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="cm">/* check if interface is still free */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">read_cam_control</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">CTRLIF_STATUS</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUSREG_FR</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* it wasn&#39;t free =&gt; try again later */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* send the amount of data */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">write_cam_control</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">CTRLIF_SIZE_HIGH</span><span class="p">,</span> <span class="n">bytes_write</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">write_cam_control</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">CTRLIF_SIZE_LOW</span><span class="p">,</span>
						 <span class="n">bytes_write</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="cm">/* send the buffer */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bytes_write</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">write_cam_control</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">CTRLIF_DATA</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check for write error (WE should now be 0) */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">read_cam_control</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">CTRLIF_STATUS</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUSREG_WE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_LINKINIT</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">bytes_write</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Wrote CA packet for slot %i, connection id 0x%x last_frag:%i size:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bytes_write</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">write_cam_control</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">CTRLIF_COMMAND</span><span class="p">,</span> <span class="n">IRQEN</span><span class="p">);</span>

<span class="nl">exitnowrite:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dvb_ca_en50221_camchange_irq</span><span class="p">);</span>



<span class="cm">/* ******************************************************************************** */</span>
<span class="cm">/* EN50221 higher level functions */</span>


<span class="cm">/**</span>
<span class="cm"> * A CAM has been removed =&gt; shut it down.</span>
<span class="cm"> *</span>
<span class="cm"> * @param ca CA instance.</span>
<span class="cm"> * @param slot Slot to shut down.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_ca_en50221_slot_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">slot_shutdown</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_NONE</span><span class="p">;</span>

	<span class="cm">/* need to wake up all processes to check if they&#39;re now</span>
<span class="cm">	   trying to write to a defunct CAM */</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Slot %i shutdown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

	<span class="cm">/* success */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dvb_ca_en50221_camready_irq</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> * A CAMCHANGE IRQ has occurred.</span>
<span class="cm"> *</span>
<span class="cm"> * @param ca CA instance.</span>
<span class="cm"> * @param slot Slot concerned.</span>
<span class="cm"> * @param change_type One of the DVB_CA_CAMCHANGE_* values.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dvb_ca_en50221_camchange_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">pubca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">change_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span> <span class="o">=</span> <span class="n">pubca</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;CAMCHANGE IRQ slot:%i change_type:%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">change_type</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">change_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DVB_CA_EN50221_CAMCHANGE_REMOVED</span>:
	<span class="k">case</span> <span class="n">DVB_CA_EN50221_CAMCHANGE_INSERTED</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">camchange_type</span> <span class="o">=</span> <span class="n">change_type</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">camchange_count</span><span class="p">);</span>
	<span class="n">dvb_ca_en50221_thread_wakeup</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dvb_ca_en50221_frda_irq</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> * A CAMREADY IRQ has occurred.</span>
<span class="cm"> *</span>
<span class="cm"> * @param ca CA instance.</span>
<span class="cm"> * @param slot Slot concerned.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dvb_ca_en50221_camready_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">pubca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span> <span class="o">=</span> <span class="n">pubca</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;CAMREADY IRQ slot:%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">==</span> <span class="n">DVB_CA_SLOTSTATE_WAITREADY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_VALIDATE</span><span class="p">;</span>
		<span class="n">dvb_ca_en50221_thread_wakeup</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * An FR or DA IRQ has occurred.</span>
<span class="cm"> *</span>
<span class="cm"> * @param ca CA instance.</span>
<span class="cm"> * @param slot Slot concerned.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dvb_ca_en50221_frda_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">pubca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span> <span class="o">=</span> <span class="n">pubca</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;FR/DA IRQ slot:%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DVB_CA_SLOTSTATE_LINKINIT</span>:
		<span class="n">flags</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">read_cam_control</span><span class="p">(</span><span class="n">pubca</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">CTRLIF_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">STATUSREG_DA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;CAM supports DA IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">da_irq_supported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DVB_CA_SLOTSTATE_RUNNING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span>
			<span class="n">dvb_ca_en50221_thread_wakeup</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="cm">/* ******************************************************************************** */</span>
<span class="cm">/* EN50221 thread functions */</span>

<span class="cm">/**</span>
<span class="cm"> * Wake up the DVB CA thread</span>
<span class="cm"> *</span>
<span class="cm"> * @param ca CA instance.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dvb_ca_en50221_thread_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ca</span><span class="o">-&gt;</span><span class="n">wakeup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">wake_up_process</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Update the delay used by the thread.</span>
<span class="cm"> *</span>
<span class="cm"> * @param ca CA instance.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dvb_ca_en50221_thread_update_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">delay</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">curdelay</span> <span class="o">=</span> <span class="mi">100000000</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>

	<span class="cm">/* Beware of too high polling frequency, because one polling</span>
<span class="cm">	 * call might take several hundred milliseconds until timeout!</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_count</span><span class="p">;</span> <span class="n">slot</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">DVB_CA_SLOTSTATE_NONE</span>:
			<span class="n">delay</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>  <span class="cm">/* 60s */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DVB_CA_EN50221_FLAG_IRQ_CAMCHANGE</span><span class="p">))</span>
				<span class="n">delay</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>  <span class="cm">/* 5s */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DVB_CA_SLOTSTATE_INVALID</span>:
			<span class="n">delay</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>  <span class="cm">/* 60s */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DVB_CA_EN50221_FLAG_IRQ_CAMCHANGE</span><span class="p">))</span>
				<span class="n">delay</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>  <span class="cm">/* 100ms */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DVB_CA_SLOTSTATE_UNINITIALISED</span>:
		<span class="k">case</span> <span class="n">DVB_CA_SLOTSTATE_WAITREADY</span>:
		<span class="k">case</span> <span class="n">DVB_CA_SLOTSTATE_VALIDATE</span>:
		<span class="k">case</span> <span class="n">DVB_CA_SLOTSTATE_WAITFR</span>:
		<span class="k">case</span> <span class="n">DVB_CA_SLOTSTATE_LINKINIT</span>:
			<span class="n">delay</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>  <span class="cm">/* 100ms */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DVB_CA_SLOTSTATE_RUNNING</span>:
			<span class="n">delay</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>  <span class="cm">/* 60s */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DVB_CA_EN50221_FLAG_IRQ_CAMCHANGE</span><span class="p">))</span>
				<span class="n">delay</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>  <span class="cm">/* 100ms */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">da_irq_supported</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DVB_CA_EN50221_FLAG_IRQ_DA</span><span class="p">)))</span>
					<span class="n">delay</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>  <span class="cm">/* 100ms */</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&lt;</span> <span class="n">curdelay</span><span class="p">)</span>
			<span class="n">curdelay</span> <span class="o">=</span> <span class="n">delay</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ca</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="n">curdelay</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/**</span>
<span class="cm"> * Kernel thread which monitors CA slots for CAM changes, and performs data transfers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_ca_en50221_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pktcount</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">rxbuf</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* choose the correct initial delay */</span>
	<span class="n">dvb_ca_en50221_thread_update_delay</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>

	<span class="cm">/* main loop */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
		<span class="cm">/* sleep for a bit */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">wakeup</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
			<span class="n">schedule_timeout</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ca</span><span class="o">-&gt;</span><span class="n">wakeup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* go through all the slots processing them */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_count</span><span class="p">;</span> <span class="n">slot</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_lock</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>check the cam status + deal with CAMCHANGEs</p></td><td class="code"><div class="highlight"><pre>			<span class="k">while</span> <span class="p">(</span><span class="n">dvb_ca_en50221_check_camstatus</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* clear down an old CI slot if necessary */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">!=</span> <span class="n">DVB_CA_SLOTSTATE_NONE</span><span class="p">)</span>
					<span class="n">dvb_ca_en50221_slot_shutdown</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

				<span class="cm">/* if a CAM is NOW present, initialise it */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">camchange_type</span> <span class="o">==</span> <span class="n">DVB_CA_EN50221_CAMCHANGE_INSERTED</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_UNINITIALISED</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* we&#39;ve handled one CAMCHANGE */</span>
				<span class="n">dvb_ca_en50221_thread_update_delay</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">camchange_count</span><span class="p">);</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>CAM state machine</p></td><td class="code"><div class="highlight"><pre>			<span class="k">switch</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">DVB_CA_SLOTSTATE_NONE</span>:
			<span class="k">case</span> <span class="n">DVB_CA_SLOTSTATE_INVALID</span>:</pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>no action needed</p></td><td class="code"><div class="highlight"><pre>				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">DVB_CA_SLOTSTATE_UNINITIALISED</span>:
				<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_WAITREADY</span><span class="p">;</span>
				<span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">slot_reset</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
				<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">INIT_TIMEOUT_SECS</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">DVB_CA_SLOTSTATE_WAITREADY</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb_ca adaptor %d: PC card did not respond :(</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">ca</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
					<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_INVALID</span><span class="p">;</span>
					<span class="n">dvb_ca_en50221_thread_update_delay</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>no other action needed; will automatically change state when ready</p></td><td class="code"><div class="highlight"><pre>				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">DVB_CA_SLOTSTATE_VALIDATE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">dvb_ca_en50221_parse_attributes</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* we need this extra check for annoying interfaces like the budget-av */</span>
					<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DVB_CA_EN50221_FLAG_IRQ_CAMCHANGE</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
					    <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">poll_slot_status</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">status</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">poll_slot_status</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DVB_CA_EN50221_POLL_CAM_PRESENT</span><span class="p">))</span> <span class="p">{</span>
							<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_NONE</span><span class="p">;</span>
							<span class="n">dvb_ca_en50221_thread_update_delay</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>

					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb_ca adapter %d: Invalid PC card inserted :(</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">ca</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
					<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_INVALID</span><span class="p">;</span>
					<span class="n">dvb_ca_en50221_thread_update_delay</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dvb_ca_en50221_set_configoption</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb_ca adapter %d: Unable to initialise CAM :(</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">ca</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
					<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_INVALID</span><span class="p">;</span>
					<span class="n">dvb_ca_en50221_thread_update_delay</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">write_cam_control</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span>
							       <span class="n">CTRLIF_COMMAND</span><span class="p">,</span> <span class="n">CMDREG_RS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb_ca adapter %d: Unable to reset CAM IF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">ca</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
					<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_INVALID</span><span class="p">;</span>
					<span class="n">dvb_ca_en50221_thread_update_delay</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;DVB CAM validated successfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">INIT_TIMEOUT_SECS</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
				<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_WAITFR</span><span class="p">;</span>
				<span class="n">ca</span><span class="o">-&gt;</span><span class="n">wakeup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">DVB_CA_SLOTSTATE_WAITFR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb_ca adapter %d: DVB CAM did not respond :(</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">ca</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
					<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_INVALID</span><span class="p">;</span>
					<span class="n">dvb_ca_en50221_thread_update_delay</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">flags</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">read_cam_control</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">CTRLIF_STATUS</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">STATUSREG_FR</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_LINKINIT</span><span class="p">;</span>
					<span class="n">ca</span><span class="o">-&gt;</span><span class="n">wakeup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">DVB_CA_SLOTSTATE_LINKINIT</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">dvb_ca_en50221_link_init</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* we need this extra check for annoying interfaces like the budget-av */</span>
					<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DVB_CA_EN50221_FLAG_IRQ_CAMCHANGE</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
					    <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">poll_slot_status</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">status</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">poll_slot_status</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DVB_CA_EN50221_POLL_CAM_PRESENT</span><span class="p">))</span> <span class="p">{</span>
							<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_NONE</span><span class="p">;</span>
							<span class="n">dvb_ca_en50221_thread_update_delay</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>

					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb_ca adapter %d: DVB CAM link initialisation failed :(</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
					<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_INVALID</span><span class="p">;</span>
					<span class="n">dvb_ca_en50221_thread_update_delay</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">rx_buffer</span><span class="p">.</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rxbuf</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">RX_BUFFER_SIZE</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rxbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb_ca adapter %d: Unable to allocate CAM rx buffer :(</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
						<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_INVALID</span><span class="p">;</span>
						<span class="n">dvb_ca_en50221_thread_update_delay</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">dvb_ringbuffer_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">rx_buffer</span><span class="p">,</span> <span class="n">rxbuf</span><span class="p">,</span> <span class="n">RX_BUFFER_SIZE</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">slot_ts_enable</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
				<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_RUNNING</span><span class="p">;</span>
				<span class="n">dvb_ca_en50221_thread_update_delay</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb_ca adapter %d: DVB CAM detected and initialised successfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">DVB_CA_SLOTSTATE_RUNNING</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>poll slots for data</p></td><td class="code"><div class="highlight"><pre>				<span class="n">pktcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">dvb_ca_en50221_read_data</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>

					<span class="cm">/* if a CAMCHANGE occurred at some point, do not do any more processing of this slot */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dvb_ca_en50221_check_camstatus</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>we dont want to sleep on the next iteration so we can handle the cam change</p></td><td class="code"><div class="highlight"><pre>						<span class="n">ca</span><span class="o">-&gt;</span><span class="n">wakeup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="cm">/* check if we&#39;ve hit our limit this time */</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">pktcount</span> <span class="o">&gt;=</span> <span class="n">MAX_RX_PACKETS_PER_ITERATION</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>dont sleep; there is likely to be more data to read</p></td><td class="code"><div class="highlight"><pre>						<span class="n">ca</span><span class="o">-&gt;</span><span class="n">wakeup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/* ******************************************************************************** */</span>
<span class="cm">/* EN50221 IO interface functions */</span>

<span class="cm">/**</span>
<span class="cm"> * Real ioctl implementation.</span>
<span class="cm"> * NOTE: CA_SEND_MSG/CA_GET_MSG ioctls have userspace buffers passed to them.</span>
<span class="cm"> *</span>
<span class="cm"> * @param inode Inode concerned.</span>
<span class="cm"> * @param file File concerned.</span>
<span class="cm"> * @param cmd IOCTL command.</span>
<span class="cm"> * @param arg Associated argument.</span>
<span class="cm"> *</span>
<span class="cm"> * @return 0 on success, &lt;0 on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_ca_en50221_io_do_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">parg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CA_RESET</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_count</span><span class="p">;</span> <span class="n">slot</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">!=</span> <span class="n">DVB_CA_SLOTSTATE_NONE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dvb_ca_en50221_slot_shutdown</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DVB_CA_EN50221_FLAG_IRQ_CAMCHANGE</span><span class="p">)</span>
					<span class="n">dvb_ca_en50221_camchange_irq</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span>
								     <span class="n">slot</span><span class="p">,</span>
								     <span class="n">DVB_CA_EN50221_CAMCHANGE_INSERTED</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ca</span><span class="o">-&gt;</span><span class="n">next_read_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dvb_ca_en50221_thread_wakeup</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CA_GET_CAP</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ca_caps</span> <span class="o">*</span><span class="n">caps</span> <span class="o">=</span> <span class="n">parg</span><span class="p">;</span>

		<span class="n">caps</span><span class="o">-&gt;</span><span class="n">slot_num</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_count</span><span class="p">;</span>
		<span class="n">caps</span><span class="o">-&gt;</span><span class="n">slot_type</span> <span class="o">=</span> <span class="n">CA_CI_LINK</span><span class="p">;</span>
		<span class="n">caps</span><span class="o">-&gt;</span><span class="n">descr_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">caps</span><span class="o">-&gt;</span><span class="n">descr_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">CA_GET_SLOT_INFO</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ca_slot_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">parg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&gt;</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_count</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">CA_CI_LINK</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">!=</span> <span class="n">DVB_CA_SLOTSTATE_NONE</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">!=</span> <span class="n">DVB_CA_SLOTSTATE_INVALID</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CA_CI_MODULE_PRESENT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">==</span> <span class="n">DVB_CA_SLOTSTATE_RUNNING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CA_CI_MODULE_READY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Wrapper for ioctl implementation.</span>
<span class="cm"> *</span>
<span class="cm"> * @param inode Inode concerned.</span>
<span class="cm"> * @param file File concerned.</span>
<span class="cm"> * @param cmd IOCTL command.</span>
<span class="cm"> * @param arg Associated argument.</span>
<span class="cm"> *</span>
<span class="cm"> * @return 0 on success, &lt;0 on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">dvb_ca_en50221_io_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dvb_usercopy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">dvb_ca_en50221_io_do_ioctl</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Implementation of write() syscall.</span>
<span class="cm"> *</span>
<span class="cm"> * @param file File structure.</span>
<span class="cm"> * @param buf Source buffer.</span>
<span class="cm"> * @param count Size of source buffer.</span>
<span class="cm"> * @param ppos Position in file (ignored).</span>
<span class="cm"> *</span>
<span class="cm"> * @return Number of bytes read, or &lt;0 on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dvb_ca_en50221_io_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">slot</span><span class="p">,</span> <span class="n">connection_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fragbuf</span><span class="p">[</span><span class="n">HOST_LINK_BUF_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">fragpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fraglen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">written</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Incoming packet has a 2 byte header. hdr[0] = slot_id, hdr[1] = connection_id */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* extract slot &amp; connection id */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connection_id</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* check if the slot is actually running */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">!=</span> <span class="n">DVB_CA_SLOTSTATE_RUNNING</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* fragment the packets &amp; store in the buffer */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">fragpos</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fraglen</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">link_buf_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fraglen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fraglen</span> <span class="o">&gt;</span> <span class="n">HOST_LINK_BUF_SIZE</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">fraglen</span> <span class="o">=</span> <span class="n">HOST_LINK_BUF_SIZE</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">-</span> <span class="n">fragpos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">fraglen</span><span class="p">)</span>
			<span class="n">fraglen</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="n">fragpos</span><span class="p">;</span>

		<span class="n">fragbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection_id</span><span class="p">;</span>
		<span class="n">fragbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">fragpos</span> <span class="o">+</span> <span class="n">fraglen</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">fragbuf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">fragpos</span><span class="p">,</span> <span class="n">fraglen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* check the CAM hasn&#39;t been removed/reset in the meantime */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">!=</span> <span class="n">DVB_CA_SLOTSTATE_RUNNING</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_lock</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">dvb_ca_en50221_write_data</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">fragbuf</span><span class="p">,</span> <span class="n">fraglen</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="p">(</span><span class="n">fraglen</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">written</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">written</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fragpos</span> <span class="o">+=</span> <span class="n">fraglen</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Condition for waking up in dvb_ca_en50221_io_read_condition</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_ca_en50221_io_read_condition</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="o">*</span><span class="n">result</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">_slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">fraglen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">connection_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hdr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">slot</span> <span class="o">=</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">next_read_slot</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">slot_count</span> <span class="o">&lt;</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_count</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">!=</span> <span class="n">DVB_CA_SLOTSTATE_RUNNING</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">nextslot</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">rx_buffer</span><span class="p">.</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">idx</span> <span class="o">=</span> <span class="n">dvb_ringbuffer_pkt_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">rx_buffer</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fraglen</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dvb_ringbuffer_pkt_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">rx_buffer</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">connection_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">connection_id</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">hdr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">connection_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">hdr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">_slot</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">idx</span> <span class="o">=</span> <span class="n">dvb_ringbuffer_pkt_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">rx_buffer</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fraglen</span><span class="p">);</span>
		<span class="p">}</span>

<span class="nl">nextslot:</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="p">(</span><span class="n">slot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_count</span><span class="p">;</span>
		<span class="n">slot_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ca</span><span class="o">-&gt;</span><span class="n">next_read_slot</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Implementation of read() syscall.</span>
<span class="cm"> *</span>
<span class="cm"> * @param file File structure.</span>
<span class="cm"> * @param buf Destination buffer.</span>
<span class="cm"> * @param count Size of destination buffer.</span>
<span class="cm"> * @param ppos Position in file (ignored).</span>
<span class="cm"> *</span>
<span class="cm"> * @return Number of bytes read, or &lt;0 on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dvb_ca_en50221_io_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span>
				      <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hdr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">connection_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">idx</span><span class="p">,</span> <span class="n">idx2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">last_fragment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">fraglen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pktlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dispose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Outgoing packet has a 2 byte header. hdr[0] = slot_id, hdr[1] = connection_id */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* wait for some data */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">dvb_ca_en50221_io_read_condition</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* if we&#39;re in nonblocking mode, exit immediately */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EWOULDBLOCK</span><span class="p">;</span>

		<span class="cm">/* wait for some data */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">,</span>
						  <span class="n">dvb_ca_en50221_io_read_condition</span>
						  <span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">dvb_ringbuffer_pkt_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">rx_buffer</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fraglen</span><span class="p">);</span>
	<span class="n">pktlen</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb_ca adapter %d: BUG: read packet ended before last_fragment encountered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dvb_ringbuffer_pkt_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">rx_buffer</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connection_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">connection_id</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">connection_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pktlen</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">pktlen</span> <span class="o">+</span> <span class="n">fraglen</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">fraglen</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="n">pktlen</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">fraglen</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">dvb_ringbuffer_pkt_read_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">rx_buffer</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
								      <span class="n">buf</span> <span class="o">+</span> <span class="n">pktlen</span><span class="p">,</span> <span class="n">fraglen</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">pktlen</span> <span class="o">+=</span> <span class="n">fraglen</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">hdr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">last_fragment</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dispose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">idx2</span> <span class="o">=</span> <span class="n">dvb_ringbuffer_pkt_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">rx_buffer</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fraglen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dispose</span><span class="p">)</span>
			<span class="n">dvb_ringbuffer_pkt_dispose</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">rx_buffer</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">idx2</span><span class="p">;</span>
		<span class="n">dispose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">last_fragment</span><span class="p">);</span>

	<span class="n">hdr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection_id</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">pktlen</span><span class="p">;</span>

<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Implementation of file open syscall.</span>
<span class="cm"> *</span>
<span class="cm"> * @param inode Inode concerned.</span>
<span class="cm"> * @param file File concerned.</span>
<span class="cm"> *</span>
<span class="cm"> * @return 0 on success, &lt;0 on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_ca_en50221_io_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">dvb_generic_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">==</span> <span class="n">DVB_CA_SLOTSTATE_RUNNING</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_buffer</span><span class="p">.</span><span class="n">data</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* it is safe to call this here without locks because</span>
<span class="cm">				 * ca-&gt;open == 0. Data is not read in this case */</span>
				<span class="n">dvb_ringbuffer_flush</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_buffer</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ca</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dvb_ca_en50221_thread_update_delay</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>
	<span class="n">dvb_ca_en50221_thread_wakeup</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Implementation of file close syscall.</span>
<span class="cm"> *</span>
<span class="cm"> * @param inode Inode concerned.</span>
<span class="cm"> * @param file File concerned.</span>
<span class="cm"> *</span>
<span class="cm"> * @return 0 on success, &lt;0 on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_ca_en50221_io_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* mark the CA device as closed */</span>
	<span class="n">ca</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dvb_ca_en50221_thread_update_delay</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">dvb_generic_release</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>

	<span class="n">module_put</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Implementation of poll() syscall.</span>
<span class="cm"> *</span>
<span class="cm"> * @param file File concerned.</span>
<span class="cm"> * @param wait poll wait table.</span>
<span class="cm"> *</span>
<span class="cm"> * @return Standard poll mask.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dvb_ca_en50221_io_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dvb_ca_en50221_io_read_condition</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if there is something, return now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>

	<span class="cm">/* wait for something to happen */</span>
	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dvb_ca_en50221_io_read_condition</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dvb_ca_en50221_init</span><span class="p">);</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">dvb_ca_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">dvb_ca_en50221_io_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">dvb_ca_en50221_io_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">dvb_ca_en50221_io_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">dvb_ca_en50221_io_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">dvb_ca_en50221_io_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span> <span class="o">=</span> <span class="n">dvb_ca_en50221_io_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_device</span> <span class="n">dvbdev_ca</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">users</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">readers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">writers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_ca_fops</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/* ******************************************************************************** */</span>
<span class="cm">/* Initialisation/shutdown functions */</span>


<span class="cm">/**</span>
<span class="cm"> * Initialise a new DVB CA EN50221 interface device.</span>
<span class="cm"> *</span>
<span class="cm"> * @param dvb_adapter DVB adapter to attach the new CA device to.</span>
<span class="cm"> * @param ca The dvb_ca instance.</span>
<span class="cm"> * @param flags Flags describing the CA device (DVB_CA_FLAG_*).</span>
<span class="cm"> * @param slot_count Number of slots supported.</span>
<span class="cm"> *</span>
<span class="cm"> * @return 0 on success, nonzero on failure</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dvb_ca_en50221_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_adapter</span> <span class="o">*</span><span class="n">dvb_adapter</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">pubca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot_count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* initialise the system data */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ca</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_private</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ca</span><span class="o">-&gt;</span><span class="n">pub</span> <span class="o">=</span> <span class="n">pubca</span><span class="p">;</span>
	<span class="n">ca</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_count</span> <span class="o">=</span> <span class="n">slot_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">slot_count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_slot</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">);</span>
	<span class="n">ca</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ca</span><span class="o">-&gt;</span><span class="n">wakeup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ca</span><span class="o">-&gt;</span><span class="n">next_read_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pubca</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">ca</span><span class="p">;</span>

	<span class="cm">/* register the DVB device */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_register_device</span><span class="p">(</span><span class="n">dvb_adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dvbdev_ca</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">DVB_DEVICE_CA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* now initialise each slot */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">slot_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_slot</span><span class="p">));</span>
		<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">slot_state</span> <span class="o">=</span> <span class="n">DVB_CA_SLOTSTATE_NONE</span><span class="p">;</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">camchange_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">camchange_type</span> <span class="o">=</span> <span class="n">DVB_CA_EN50221_CAMCHANGE_REMOVED</span><span class="p">;</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">slot_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="cm">/* create a kthread for monitoring this CA device */</span>
	<span class="n">ca</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">dvb_ca_en50221_thread</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="s">&quot;kdvb-ca-%i:%i&quot;</span><span class="p">,</span>
				 <span class="n">ca</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb_ca_init: failed to start kernel_thread (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ca</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">dvbdev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dvb_unregister_device</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pubca</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dvb_ca_en50221_release</span><span class="p">);</span>



<span class="cm">/**</span>
<span class="cm"> * Release a DVB CA EN50221 interface device.</span>
<span class="cm"> *</span>
<span class="cm"> * @param ca_dev The dvb_device_t instance for the CA device.</span>
<span class="cm"> * @param ca The associated dvb_ca instance.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dvb_ca_en50221_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">pubca</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_ca_private</span> <span class="o">*</span><span class="n">ca</span> <span class="o">=</span> <span class="n">pubca</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* shutdown the thread if there was one */</span>
	<span class="n">kthread_stop</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dvb_ca_en50221_slot_shutdown</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_buffer</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">slot_info</span><span class="p">);</span>
	<span class="n">dvb_unregister_device</span><span class="p">(</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ca</span><span class="p">);</span>
	<span class="n">pubca</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
