<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › dvb-core › dvb_frontend.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>dvb_frontend.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * dvb_frontend.c: DVB frontend tuning interface/thread</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1999-2001 Ralph  Metzler</span>
<span class="cm"> *			   Marcus Metzler</span>
<span class="cm"> *			   Holger Waechtler</span>
<span class="cm"> *				      for convergence integrated media GmbH</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004 Andrew de Quincey (tuning thread cleanup)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version 2</span>
<span class="cm"> * of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	 See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> * Or, point your browser to http://www.gnu.org/copyleft/gpl.html</span>
<span class="cm"> */</span>

<span class="cm">/* Enables DVBv3 compatibility bits at the headers */</span>
<span class="cp">#define __DVB_CORE__</span>

<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/semaphore.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>

<span class="cp">#include &quot;dvb_frontend.h&quot;</span>
<span class="cp">#include &quot;dvbdev.h&quot;</span>
<span class="cp">#include &lt;linux/dvb/version.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dvb_frontend_debug</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dvb_shutdown_timeout</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dvb_force_auto_inversion</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dvb_override_tune_delay</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dvb_powerdown_on_sleep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dvb_mfe_wait_time</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">frontend_debug</span><span class="p">,</span> <span class="n">dvb_frontend_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">frontend_debug</span><span class="p">,</span> <span class="s">&quot;Turn on/off frontend core debugging (default:off).&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dvb_shutdown_timeout</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dvb_shutdown_timeout</span><span class="p">,</span> <span class="s">&quot;wait &lt;shutdown_timeout&gt; seconds after close() before suspending hardware&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dvb_force_auto_inversion</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dvb_force_auto_inversion</span><span class="p">,</span> <span class="s">&quot;0: normal (default), 1: INVERSION_AUTO forced always&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dvb_override_tune_delay</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dvb_override_tune_delay</span><span class="p">,</span> <span class="s">&quot;0: normal (default), &gt;0 =&gt; delay in milliseconds to wait for lock after a tune attempt&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dvb_powerdown_on_sleep</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dvb_powerdown_on_sleep</span><span class="p">,</span> <span class="s">&quot;0: do not power down, 1: turn LNB voltage off on sleep (default)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dvb_mfe_wait_time</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dvb_mfe_wait_time</span><span class="p">,</span> <span class="s">&quot;Wait up to &lt;mfe_wait_time&gt; seconds on open() for multi-frontend to become available (default:5 seconds)&quot;</span><span class="p">);</span>

<span class="cp">#define dprintk if (dvb_frontend_debug) printk</span>

<span class="cp">#define FESTATE_IDLE 1</span>
<span class="cp">#define FESTATE_RETUNE 2</span>
<span class="cp">#define FESTATE_TUNING_FAST 4</span>
<span class="cp">#define FESTATE_TUNING_SLOW 8</span>
<span class="cp">#define FESTATE_TUNED 16</span>
<span class="cp">#define FESTATE_ZIGZAG_FAST 32</span>
<span class="cp">#define FESTATE_ZIGZAG_SLOW 64</span>
<span class="cp">#define FESTATE_DISEQC 128</span>
<span class="cp">#define FESTATE_ERROR 256</span>
<span class="cp">#define FESTATE_WAITFORLOCK (FESTATE_TUNING_FAST | FESTATE_TUNING_SLOW | FESTATE_ZIGZAG_FAST | FESTATE_ZIGZAG_SLOW | FESTATE_DISEQC)</span>
<span class="cp">#define FESTATE_SEARCHING_FAST (FESTATE_TUNING_FAST | FESTATE_ZIGZAG_FAST)</span>
<span class="cp">#define FESTATE_SEARCHING_SLOW (FESTATE_TUNING_SLOW | FESTATE_ZIGZAG_SLOW)</span>
<span class="cp">#define FESTATE_LOSTLOCK (FESTATE_ZIGZAG_FAST | FESTATE_ZIGZAG_SLOW)</span>

<span class="cp">#define FE_ALGO_HW		1</span>
<span class="cm">/*</span>
<span class="cm"> * FESTATE_IDLE. No tuning parameters have been supplied and the loop is idling.</span>
<span class="cm"> * FESTATE_RETUNE. Parameters have been supplied, but we have not yet performed the first tune.</span>
<span class="cm"> * FESTATE_TUNING_FAST. Tuning parameters have been supplied and fast zigzag scan is in progress.</span>
<span class="cm"> * FESTATE_TUNING_SLOW. Tuning parameters have been supplied. Fast zigzag failed, so we&#39;re trying again, but slower.</span>
<span class="cm"> * FESTATE_TUNED. The frontend has successfully locked on.</span>
<span class="cm"> * FESTATE_ZIGZAG_FAST. The lock has been lost, and a fast zigzag has been initiated to try and regain it.</span>
<span class="cm"> * FESTATE_ZIGZAG_SLOW. The lock has been lost. Fast zigzag has been failed, so we&#39;re trying again, but slower.</span>
<span class="cm"> * FESTATE_DISEQC. A DISEQC command has just been issued.</span>
<span class="cm"> * FESTATE_WAITFORLOCK. When we&#39;re waiting for a lock.</span>
<span class="cm"> * FESTATE_SEARCHING_FAST. When we&#39;re searching for a signal using a fast zigzag scan.</span>
<span class="cm"> * FESTATE_SEARCHING_SLOW. When we&#39;re searching for a signal using a slow zigzag scan.</span>
<span class="cm"> * FESTATE_LOSTLOCK. When the lock has been lost, and we&#39;re searching it again.</span>
<span class="cm"> */</span>

<span class="cp">#define DVB_FE_NO_EXIT	0</span>
<span class="cp">#define DVB_FE_NORMAL_EXIT	1</span>
<span class="cp">#define DVB_FE_DEVICE_REMOVED	2</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">frontend_mutex</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="p">{</span>

	<span class="cm">/* thread/frontend values */</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_parameters</span> <span class="n">parameters_out</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_fe_events</span> <span class="n">events</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">semaphore</span> <span class="n">sem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list_head</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">wait_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="kr">thread</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">release_jiffies</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">exit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wakeup</span><span class="p">;</span>
	<span class="n">fe_status_t</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tune_mode_flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reinitialise</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tone</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">voltage</span><span class="p">;</span>

	<span class="cm">/* swzigzag values */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bending</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lnb_drift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inversion</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">auto_step</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">auto_sub_step</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">started_auto_step</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min_delay</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_drift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">step_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">quality</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">check_wrapped</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dvbfe_search</span> <span class="n">algo_status</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">dvb_frontend_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dtv_get_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">dvb_frontend_parameters</span> <span class="o">*</span><span class="n">p_out</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dtv_property_legacy_params_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">dvb_frontend_parameters</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">has_get_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_frontend</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Due to DVBv3 API calls, a delivery system should be mapped into one of</span>
<span class="cm"> * the 4 DVBv3 delivery systems (FE_QPSK, FE_QAM, FE_OFDM or FE_ATSC),</span>
<span class="cm"> * otherwise, a DVBv3 call will fail.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">dvbv3_emulation_type</span> <span class="p">{</span>
	<span class="n">DVBV3_UNKNOWN</span><span class="p">,</span>
	<span class="n">DVBV3_QPSK</span><span class="p">,</span>
	<span class="n">DVBV3_QAM</span><span class="p">,</span>
	<span class="n">DVBV3_OFDM</span><span class="p">,</span>
	<span class="n">DVBV3_ATSC</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">dvbv3_emulation_type</span> <span class="nf">dvbv3_type</span><span class="p">(</span><span class="n">u32</span> <span class="n">delivery_system</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">delivery_system</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_DVBC_ANNEX_A</span>:
	<span class="k">case</span> <span class="n">SYS_DVBC_ANNEX_C</span>:
		<span class="k">return</span> <span class="n">DVBV3_QAM</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_DVBS</span>:
	<span class="k">case</span> <span class="n">SYS_DVBS2</span>:
	<span class="k">case</span> <span class="n">SYS_TURBO</span>:
	<span class="k">case</span> <span class="n">SYS_ISDBS</span>:
	<span class="k">case</span> <span class="n">SYS_DSS</span>:
		<span class="k">return</span> <span class="n">DVBV3_QPSK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_DVBT</span>:
	<span class="k">case</span> <span class="n">SYS_DVBT2</span>:
	<span class="k">case</span> <span class="n">SYS_ISDBT</span>:
	<span class="k">case</span> <span class="n">SYS_DMBTH</span>:
		<span class="k">return</span> <span class="n">DVBV3_OFDM</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_ATSC</span>:
	<span class="k">case</span> <span class="n">SYS_ATSCMH</span>:
	<span class="k">case</span> <span class="n">SYS_DVBC_ANNEX_B</span>:
		<span class="k">return</span> <span class="n">DVBV3_ATSC</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_UNDEFINED</span>:
	<span class="k">case</span> <span class="n">SYS_ISDBC</span>:
	<span class="k">case</span> <span class="n">SYS_DVBH</span>:
	<span class="k">case</span> <span class="n">SYS_DAB</span>:
	<span class="nl">default:</span>
		<span class="cm">/*</span>
<span class="cm">		 * Doesn&#39;t know how to emulate those types and/or</span>
<span class="cm">		 * there&#39;s no frontend driver from this type yet</span>
<span class="cm">		 * with some emulation code, so, we&#39;re not sure yet how</span>
<span class="cm">		 * to handle them, or they&#39;re not compatible with a DVBv3 call.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">DVBV3_UNKNOWN</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dvb_frontend_add_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_status_t</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_fe_events</span> <span class="o">*</span><span class="n">events</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_event</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wp</span><span class="p">;</span>

	<span class="n">dprintk</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FE_HAS_LOCK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">has_get_frontend</span><span class="p">(</span><span class="n">fe</span><span class="p">))</span>
		<span class="n">dtv_get_frontend</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">parameters_out</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="n">wp</span> <span class="o">=</span> <span class="p">(</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">eventw</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">MAX_EVENT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wp</span> <span class="o">==</span> <span class="n">events</span><span class="o">-&gt;</span><span class="n">eventr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">events</span><span class="o">-&gt;</span><span class="n">overflow</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">events</span><span class="o">-&gt;</span><span class="n">eventr</span> <span class="o">=</span> <span class="p">(</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">eventr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">MAX_EVENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">e</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">eventw</span><span class="p">];</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">parameters_out</span><span class="p">;</span>

	<span class="n">events</span><span class="o">-&gt;</span><span class="n">eventw</span> <span class="o">=</span> <span class="n">wp</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="n">wake_up_interruptible</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_frontend_get_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">dvb_frontend_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_fe_events</span> <span class="o">*</span><span class="n">events</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">;</span>

	<span class="n">dprintk</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">overflow</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">events</span><span class="o">-&gt;</span><span class="n">overflow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">eventw</span> <span class="o">==</span> <span class="n">events</span><span class="o">-&gt;</span><span class="n">eventr</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EWOULDBLOCK</span><span class="p">;</span>

		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span> <span class="p">(</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">,</span>
						<span class="n">events</span><span class="o">-&gt;</span><span class="n">eventw</span> <span class="o">!=</span> <span class="n">events</span><span class="o">-&gt;</span><span class="n">eventr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="n">events</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">eventr</span><span class="p">];</span>
	<span class="n">events</span><span class="o">-&gt;</span><span class="n">eventr</span> <span class="o">=</span> <span class="p">(</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">eventr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">MAX_EVENT</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dvb_frontend_clear_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_fe_events</span> <span class="o">*</span><span class="n">events</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="n">events</span><span class="o">-&gt;</span><span class="n">eventr</span> <span class="o">=</span> <span class="n">events</span><span class="o">-&gt;</span><span class="n">eventw</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">events</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dvb_frontend_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span> <span class="p">(</span><span class="s">&quot;DVB: initialising adapter %i frontend %i (%s)...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span>
		 <span class="n">fe</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
		 <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">init</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dvb_frontend_reinitialise</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>

	<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">reinitialise</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dvb_frontend_wakeup</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dvb_frontend_reinitialise</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dvb_frontend_swzigzag_update_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">locked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">q2</span><span class="p">;</span>

	<span class="n">dprintk</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">locked</span><span class="p">)</span>
		<span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">quality</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">quality</span> <span class="o">*</span> <span class="mi">220</span> <span class="o">+</span> <span class="mi">36</span><span class="o">*</span><span class="mi">256</span><span class="p">)</span> <span class="o">/</span> <span class="mi">256</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">quality</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">quality</span> <span class="o">*</span> <span class="mi">220</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">256</span><span class="p">;</span>

	<span class="n">q2</span> <span class="o">=</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">quality</span> <span class="o">-</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">q2</span> <span class="o">*=</span> <span class="n">q2</span><span class="p">;</span>

	<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">min_delay</span> <span class="o">+</span> <span class="n">q2</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">128</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Performs automatic twiddling of frontend parameters.</span>
<span class="cm"> *</span>
<span class="cm"> * @param fe The frontend concerned.</span>
<span class="cm"> * @param check_wrapped Checks if an iteration has completed. DO NOT SET ON THE FIRST ATTEMPT</span>
<span class="cm"> * @returns Number of complete iterations that have been performed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_frontend_swzigzag_autotune</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">check_wrapped</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">autoinversion</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fe_set_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">original_inversion</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">inversion</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">original_frequency</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>

	<span class="cm">/* are we using autoinversion? */</span>
	<span class="n">autoinversion</span> <span class="o">=</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">FE_CAN_INVERSION_AUTO</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">==</span> <span class="n">INVERSION_AUTO</span><span class="p">));</span>

	<span class="cm">/* setup parameters correctly */</span>
	<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* calculate the lnb_drift */</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">lnb_drift</span> <span class="o">=</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">auto_step</span> <span class="o">*</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">step_size</span><span class="p">;</span>

		<span class="cm">/* wrap the auto_step if we&#39;ve exceeded the maximum drift */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">lnb_drift</span> <span class="o">&gt;</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">max_drift</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">auto_step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">auto_sub_step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">lnb_drift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* perform inversion and +/- zigzag */</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">auto_sub_step</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="cm">/* try with the current inversion and current drift setting */</span>
			<span class="n">ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">autoinversion</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">=</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">==</span> <span class="n">INVERSION_OFF</span><span class="p">)</span> <span class="o">?</span> <span class="n">INVERSION_ON</span> <span class="o">:</span> <span class="n">INVERSION_OFF</span><span class="p">;</span>
			<span class="n">ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">2</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">lnb_drift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">lnb_drift</span> <span class="o">=</span> <span class="o">-</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">lnb_drift</span><span class="p">;</span>
			<span class="n">ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">3</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">lnb_drift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">autoinversion</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">=</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">==</span> <span class="n">INVERSION_OFF</span><span class="p">)</span> <span class="o">?</span> <span class="n">INVERSION_ON</span> <span class="o">:</span> <span class="n">INVERSION_OFF</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">lnb_drift</span> <span class="o">=</span> <span class="o">-</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">lnb_drift</span><span class="p">;</span>
			<span class="n">ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">auto_step</span><span class="o">++</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">auto_sub_step</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* it&#39;ll be incremented to 0 in a moment */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ready</span><span class="p">)</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">auto_sub_step</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if this attempt would hit where we started, indicate a complete</span>
<span class="cm">	 * iteration has occurred */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">auto_step</span> <span class="o">==</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">started_auto_step</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">auto_sub_step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">check_wrapped</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: drift:%i inversion:%i auto_step:%i &quot;</span>
		<span class="s">&quot;auto_sub_step:%i started_auto_step:%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">lnb_drift</span><span class="p">,</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">inversion</span><span class="p">,</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">auto_step</span><span class="p">,</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">auto_sub_step</span><span class="p">,</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">started_auto_step</span><span class="p">);</span>

	<span class="cm">/* set the frontend itself */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">+=</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">lnb_drift</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">autoinversion</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">inversion</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_frontend</span><span class="p">)</span>
		<span class="n">fe_set_err</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_frontend</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe_set_err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FESTATE_ERROR</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">fe_set_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">original_frequency</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">original_inversion</span><span class="p">;</span>

	<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">auto_sub_step</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dvb_frontend_swzigzag</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fe_status_t</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* if we&#39;ve got no parameters, just keep idling */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FESTATE_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">quality</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* in SCAN mode, we just set the frontend when asked and leave it alone */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">tune_mode_flags</span> <span class="o">&amp;</span> <span class="n">FE_TUNE_MODE_ONESHOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FESTATE_RETUNE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_frontend</span><span class="p">)</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_frontend</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
			<span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FESTATE_ERROR</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FESTATE_TUNED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">quality</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get the frontend status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FESTATE_RETUNE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_status</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_status</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dvb_frontend_add_event</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* if we&#39;re not tuned, and we have a lock, move to the TUNED state */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FESTATE_WAITFORLOCK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">FE_HAS_LOCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dvb_frontend_swzigzag_update_delay</span><span class="p">(</span><span class="n">fepriv</span><span class="p">,</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="n">FE_HAS_LOCK</span><span class="p">);</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FESTATE_TUNED</span><span class="p">;</span>

		<span class="cm">/* if we&#39;re tuned, then we have determined the correct inversion */</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">FE_CAN_INVERSION_AUTO</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">==</span> <span class="n">INVERSION_AUTO</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">inversion</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if we are tuned already, check we&#39;re still locked */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FESTATE_TUNED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dvb_frontend_swzigzag_update_delay</span><span class="p">(</span><span class="n">fepriv</span><span class="p">,</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="n">FE_HAS_LOCK</span><span class="p">);</span>

		<span class="cm">/* we&#39;re tuned, and the lock is still good... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">FE_HAS_LOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* if we _WERE_ tuned, but now don&#39;t have a lock */</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FESTATE_ZIGZAG_FAST</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">started_auto_step</span> <span class="o">=</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">auto_step</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">check_wrapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* don&#39;t actually do anything if we&#39;re in the LOSTLOCK state,</span>
<span class="cm">	 * the frontend is set to FE_CAN_RECOVER, and the max_drift is 0 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FESTATE_LOSTLOCK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">FE_CAN_RECOVER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">max_drift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dvb_frontend_swzigzag_update_delay</span><span class="p">(</span><span class="n">fepriv</span><span class="p">,</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="n">FE_HAS_LOCK</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* don&#39;t do anything if we&#39;re in the DISEQC state, since this</span>
<span class="cm">	 * might be someone with a motorized dish controlled by DISEQC.</span>
<span class="cm">	 * If its actually a re-tune, there will be a SET_FRONTEND soon enough.	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FESTATE_DISEQC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dvb_frontend_swzigzag_update_delay</span><span class="p">(</span><span class="n">fepriv</span><span class="p">,</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="n">FE_HAS_LOCK</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if we&#39;re in the RETUNE state, set everything up for a brand</span>
<span class="cm">	 * new scan, keeping the current inversion setting, as the next</span>
<span class="cm">	 * tune is _very_ likely to require the same */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FESTATE_RETUNE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">lnb_drift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">auto_step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">auto_sub_step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">started_auto_step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">check_wrapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fast zigzag. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FESTATE_SEARCHING_FAST</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FESTATE_RETUNE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">min_delay</span><span class="p">;</span>

		<span class="cm">/* perform a tune */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">dvb_frontend_swzigzag_autotune</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span>
							<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">check_wrapped</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* OK, if we&#39;ve run out of trials at the fast speed.</span>
<span class="cm">			 * Drop back to slow for the _next_ attempt */</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FESTATE_SEARCHING_SLOW</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">started_auto_step</span> <span class="o">=</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">auto_step</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">check_wrapped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* if we&#39;ve just retuned, enter the ZIGZAG_FAST state.</span>
<span class="cm">		 * This ensures we cannot return from an</span>
<span class="cm">		 * FE_SET_FRONTEND ioctl before the first frontend tune</span>
<span class="cm">		 * occurs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FESTATE_RETUNE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FESTATE_TUNING_FAST</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* slow zigzag */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FESTATE_SEARCHING_SLOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dvb_frontend_swzigzag_update_delay</span><span class="p">(</span><span class="n">fepriv</span><span class="p">,</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="n">FE_HAS_LOCK</span><span class="p">);</span>

		<span class="cm">/* Note: don&#39;t bother checking for wrapping; we stay in this</span>
<span class="cm">		 * state until we get a lock */</span>
		<span class="n">dvb_frontend_swzigzag_autotune</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_frontend_is_exiting</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">exit</span> <span class="o">!=</span> <span class="n">DVB_FE_NO_EXIT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">writers</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">release_jiffies</span> <span class="o">+</span>
				  <span class="n">dvb_shutdown_timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_frontend_should_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">wakeup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">wakeup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">dvb_frontend_is_exiting</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dvb_frontend_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>

	<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">wakeup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_frontend_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>
	<span class="n">fe_status_t</span> <span class="n">s</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dvbfe_algo</span> <span class="n">algo</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">re_tune</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">check_wrapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">quality</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">wakeup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">reinitialise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dvb_frontend_init</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="n">set_freezable</span><span class="p">();</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>	    <span class="cm">/* is locked when we enter the thread... */</span>
<span class="nl">restart:</span>
		<span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">,</span>
			<span class="n">dvb_frontend_should_wakeup</span><span class="p">(</span><span class="n">fe</span><span class="p">)</span> <span class="o">||</span> <span class="n">kthread_should_stop</span><span class="p">()</span>
				<span class="o">||</span> <span class="n">freezing</span><span class="p">(</span><span class="n">current</span><span class="p">),</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">()</span> <span class="o">||</span> <span class="n">dvb_frontend_is_exiting</span><span class="p">(</span><span class="n">fe</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* got signal or quitting */</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">exit</span> <span class="o">=</span> <span class="n">DVB_FE_NORMAL_EXIT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">try_to_freeze</span><span class="p">())</span>
			<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">reinitialise</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dvb_frontend_init</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_tone</span> <span class="o">&amp;&amp;</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">tone</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_tone</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">tone</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_voltage</span> <span class="o">&amp;&amp;</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">voltage</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_voltage</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">voltage</span><span class="p">);</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">reinitialise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* do an iteration of the tuning loop */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_frontend_algo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">algo</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_frontend_algo</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">algo</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">DVBFE_ALGO_HW</span>:
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Frontend ALGO = DVBFE_ALGO_HW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FESTATE_RETUNE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Retune requested, FESTATE_RETUNE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
					<span class="n">re_tune</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FESTATE_TUNED</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">re_tune</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tune</span><span class="p">)</span>
					<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tune</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">re_tune</span><span class="p">,</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">tune_mode_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">tune_mode_flags</span> <span class="o">&amp;</span> <span class="n">FE_TUNE_MODE_ONESHOT</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: state changed, adding current state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
					<span class="n">dvb_frontend_add_event</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
					<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DVBFE_ALGO_SW</span>:
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Frontend ALGO = DVBFE_ALGO_SW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">dvb_frontend_swzigzag</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DVBFE_ALGO_CUSTOM</span>:
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Frontend ALGO = DVBFE_ALGO_CUSTOM, state=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FESTATE_RETUNE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: Retune requested, FESTAT_RETUNE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
					<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FESTATE_TUNED</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* Case where we are going to search for a carrier</span>
<span class="cm">				 * User asked us to retune again for some reason, possibly</span>
<span class="cm">				 * requesting a search with a new set of parameters</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">algo_status</span> <span class="o">&amp;</span> <span class="n">DVBFE_ALGO_SEARCH_AGAIN</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">search</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">algo_status</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
						<span class="cm">/* We did do a search as was requested, the flags are</span>
<span class="cm">						 * now unset as well and has the flags wrt to search.</span>
<span class="cm">						 */</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">algo_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DVBFE_ALGO_SEARCH_AGAIN</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="cm">/* Track the carrier if the search was successful */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">algo_status</span> <span class="o">!=</span> <span class="n">DVBFE_ALGO_SEARCH_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">algo_status</span> <span class="o">|=</span> <span class="n">DVBFE_ALGO_SEARCH_AGAIN</span><span class="p">;</span>
					<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">dtv_property_legacy_params_sync</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">parameters_out</span><span class="p">);</span>
				<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_status</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dvb_frontend_add_event</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span> <span class="cm">/* update event list */</span>
					<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">FE_HAS_LOCK</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
						<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">algo_status</span> <span class="o">|=</span> <span class="n">DVBFE_ALGO_SEARCH_AGAIN</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s: UNDEFINED ALGO !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dvb_frontend_swzigzag</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dvb_powerdown_on_sleep</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_voltage</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_voltage</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SEC_VOLTAGE_OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">sleep</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
				<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
				<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">sleep</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fepriv</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">exit</span> <span class="o">=</span> <span class="n">DVB_FE_DEVICE_REMOVED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">exit</span> <span class="o">=</span> <span class="n">DVB_FE_NO_EXIT</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="n">dvb_frontend_wakeup</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dvb_frontend_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>

	<span class="n">dprintk</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">exit</span> <span class="o">=</span> <span class="n">DVB_FE_NORMAL_EXIT</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">kthread_stop</span><span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>

	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FESTATE_IDLE</span><span class="p">;</span>

	<span class="cm">/* paranoia check in case a signal arrived */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb_frontend_stop: warning: thread %p won&#39;t exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fepriv</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">s32</span> <span class="nf">timeval_usec_diff</span><span class="p">(</span><span class="k">struct</span> <span class="n">timeval</span> <span class="n">lasttime</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="n">curtime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">curtime</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">&lt;</span> <span class="n">lasttime</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)</span> <span class="o">?</span>
		<span class="mi">1000000</span> <span class="o">-</span> <span class="n">lasttime</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">+</span> <span class="n">curtime</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">:</span>
		<span class="n">curtime</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">lasttime</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">timeval_usec_diff</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">timeval_usec_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">curtime</span><span class="p">,</span> <span class="n">u32</span> <span class="n">add_usec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">curtime</span><span class="o">-&gt;</span><span class="n">tv_usec</span> <span class="o">+=</span> <span class="n">add_usec</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">curtime</span><span class="o">-&gt;</span><span class="n">tv_usec</span> <span class="o">&gt;=</span> <span class="mi">1000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">curtime</span><span class="o">-&gt;</span><span class="n">tv_usec</span> <span class="o">-=</span> <span class="mi">1000000</span><span class="p">;</span>
		<span class="n">curtime</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sleep until gettimeofday() &gt; waketime + add_usec</span>
<span class="cm"> * This needs to be as precise as possible, but as the delay is</span>
<span class="cm"> * usually between 2ms and 32ms, it is done using a scheduled msleep</span>
<span class="cm"> * followed by usleep (normally a busy-wait loop) for the remainder</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dvb_frontend_sleep_until</span><span class="p">(</span><span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">waketime</span><span class="p">,</span> <span class="n">u32</span> <span class="n">add_usec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">lasttime</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">delta</span><span class="p">,</span> <span class="n">newdelta</span><span class="p">;</span>

	<span class="n">timeval_usec_add</span><span class="p">(</span><span class="n">waketime</span><span class="p">,</span> <span class="n">add_usec</span><span class="p">);</span>

	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lasttime</span><span class="p">);</span>
	<span class="n">delta</span> <span class="o">=</span> <span class="n">timeval_usec_diff</span><span class="p">(</span><span class="n">lasttime</span><span class="p">,</span> <span class="o">*</span><span class="n">waketime</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">2500</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">((</span><span class="n">delta</span> <span class="o">-</span> <span class="mi">1500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lasttime</span><span class="p">);</span>
		<span class="n">newdelta</span> <span class="o">=</span> <span class="n">timeval_usec_diff</span><span class="p">(</span><span class="n">lasttime</span><span class="p">,</span> <span class="o">*</span><span class="n">waketime</span><span class="p">);</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">newdelta</span> <span class="o">&gt;</span> <span class="n">delta</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">newdelta</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">delta</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dvb_frontend_sleep_until</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_frontend_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">fe_thread</span><span class="p">;</span>

	<span class="n">dprintk</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">exit</span> <span class="o">==</span> <span class="n">DVB_FE_NO_EXIT</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dvb_frontend_stop</span> <span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FESTATE_IDLE</span><span class="p">;</span>
	<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">exit</span> <span class="o">=</span> <span class="n">DVB_FE_NO_EXIT</span><span class="p">;</span>
	<span class="n">fepriv</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="n">fe_thread</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">dvb_frontend_thread</span><span class="p">,</span> <span class="n">fe</span><span class="p">,</span>
		<span class="s">&quot;kdvb-ad-%i-fe-%i&quot;</span><span class="p">,</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fe_thread</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fe_thread</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dvb_frontend_start: failed to start kthread (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fepriv</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">fe_thread</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dvb_frontend_get_frequency_limits</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
					<span class="n">u32</span> <span class="o">*</span><span class="n">freq_min</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">freq_max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">freq_min</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">frequency_min</span><span class="p">,</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">frequency_min</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">frequency_max</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">freq_max</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">frequency_max</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">frequency_max</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">freq_max</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">frequency_max</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">freq_max</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">frequency_max</span><span class="p">,</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">frequency_max</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">freq_min</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">*</span><span class="n">freq_max</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;DVB: adapter %i frontend %u frequency limits undefined - fix the driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_frontend_check_parameters</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freq_min</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freq_max</span><span class="p">;</span>

	<span class="cm">/* range check: frequency */</span>
	<span class="n">dvb_frontend_get_frequency_limits</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freq_min</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freq_max</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">freq_min</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="n">freq_min</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">freq_max</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;</span> <span class="n">freq_max</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;DVB: adapter %i frontend %i frequency %u out of range (%u..%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">,</span> <span class="n">freq_min</span><span class="p">,</span> <span class="n">freq_max</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* range check: symbol rate */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_DVBS</span>:
	<span class="k">case</span> <span class="n">SYS_DVBS2</span>:
	<span class="k">case</span> <span class="n">SYS_TURBO</span>:
	<span class="k">case</span> <span class="n">SYS_DVBC_ANNEX_A</span>:
	<span class="k">case</span> <span class="n">SYS_DVBC_ANNEX_C</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">symbol_rate_min</span> <span class="o">&amp;&amp;</span>
		     <span class="n">c</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">&lt;</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">symbol_rate_min</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">symbol_rate_max</span> <span class="o">&amp;&amp;</span>
		     <span class="n">c</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">&gt;</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">symbol_rate_max</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;DVB: adapter %i frontend %i symbol rate %u out of range (%u..%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">symbol_rate</span><span class="p">,</span>
			       <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">symbol_rate_min</span><span class="p">,</span>
			       <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">symbol_rate_max</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_frontend_clear_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">delsys</span><span class="p">;</span>

	<span class="n">delsys</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dtv_frontend_properties</span><span class="p">));</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span> <span class="o">=</span> <span class="n">delsys</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DTV_CLEAR</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() Clearing cache for delivery system %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">TRANSMISSION_MODE_AUTO</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* AUTO */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">GUARD_INTERVAL_AUTO</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">HIERARCHY_AUTO</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">FEC_AUTO</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_AUTO</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">fec_inner</span> <span class="o">=</span> <span class="n">FEC_AUTO</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">rolloff</span> <span class="o">=</span> <span class="n">ROLLOFF_AUTO</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">voltage</span> <span class="o">=</span> <span class="n">SEC_VOLTAGE_OFF</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">sectone</span> <span class="o">=</span> <span class="n">SEC_TONE_OFF</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">pilot</span> <span class="o">=</span> <span class="n">PILOT_AUTO</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_partial_reception</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_subchannel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_segment_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_segment_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_layer_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fec</span> <span class="o">=</span> <span class="n">FEC_AUTO</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_AUTO</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">interleaving</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbs_ts_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">dvbt2_plp_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_DVBS</span>:
	<span class="k">case</span> <span class="n">SYS_DVBS2</span>:
	<span class="k">case</span> <span class="n">SYS_TURBO</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QPSK</span><span class="p">;</span>   <span class="cm">/* implied for DVB-S in legacy API */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">rolloff</span> <span class="o">=</span> <span class="n">ROLLOFF_35</span><span class="p">;</span><span class="cm">/* implied for DVB-S */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_ATSC</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">VSB_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_AUTO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define _DTV_CMD(n, s, b) \</span>
<span class="cp">[n] = { \</span>
<span class="cp">	.name = #n, \</span>
<span class="cp">	.cmd  = n, \</span>
<span class="cp">	.set  = s,\</span>
<span class="cp">	.buffer = b \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dtv_cmds_h</span> <span class="n">dtv_cmds</span><span class="p">[</span><span class="n">DTV_MAX_COMMAND</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_TUNE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_CLEAR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="cm">/* Set */</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_FREQUENCY</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_BANDWIDTH_HZ</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_MODULATION</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_INVERSION</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_DISEQC_MASTER</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_SYMBOL_RATE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_INNER_FEC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_VOLTAGE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_TONE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_PILOT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ROLLOFF</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_DELIVERY_SYSTEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_HIERARCHY</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_CODE_RATE_HP</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_CODE_RATE_LP</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_GUARD_INTERVAL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_TRANSMISSION_MODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ISDBT_PARTIAL_RECEPTION</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ISDBT_SOUND_BROADCASTING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ISDBT_SB_SUBCHANNEL_ID</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ISDBT_SB_SEGMENT_IDX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ISDBT_SB_SEGMENT_COUNT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ISDBT_LAYER_ENABLED</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ISDBT_LAYERA_FEC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ISDBT_LAYERA_MODULATION</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ISDBT_LAYERA_SEGMENT_COUNT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ISDBT_LAYERA_TIME_INTERLEAVING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ISDBT_LAYERB_FEC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ISDBT_LAYERB_MODULATION</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ISDBT_LAYERB_SEGMENT_COUNT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ISDBT_LAYERB_TIME_INTERLEAVING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ISDBT_LAYERC_FEC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ISDBT_LAYERC_MODULATION</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ISDBT_LAYERC_SEGMENT_COUNT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ISDBT_LAYERC_TIME_INTERLEAVING</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ISDBS_TS_ID</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_DVBT2_PLP_ID</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="cm">/* Get */</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_DISEQC_SLAVE_REPLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_API_VERSION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_CODE_RATE_HP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_CODE_RATE_LP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_GUARD_INTERVAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_TRANSMISSION_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_HIERARCHY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ENUM_DELSYS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ATSCMH_PARADE_ID</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ATSCMH_RS_FRAME_ENSEMBLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ATSCMH_FIC_VER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ATSCMH_PARADE_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ATSCMH_NOG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ATSCMH_TNOG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ATSCMH_SGN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ATSCMH_PRC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ATSCMH_RS_FRAME_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ATSCMH_RS_FRAME_ENSEMBLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ATSCMH_RS_CODE_MODE_PRI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ATSCMH_RS_CODE_MODE_SEC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ATSCMH_SCCC_BLOCK_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ATSCMH_SCCC_CODE_MODE_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ATSCMH_SCCC_CODE_MODE_B</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ATSCMH_SCCC_CODE_MODE_C</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">_DTV_CMD</span><span class="p">(</span><span class="n">DTV_ATSCMH_SCCC_CODE_MODE_D</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dtv_property_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">dtv_property</span> <span class="o">*</span><span class="n">tvp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tvp</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">&gt;</span> <span class="n">DTV_MAX_COMMAND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: tvp.cmd = 0x%08x undefined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() tvp.cmd    = 0x%08x (%s)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="p">,</span><span class="n">__func__</span>
		<span class="p">,</span><span class="n">tvp</span><span class="o">-&gt;</span><span class="n">cmd</span>
		<span class="p">,</span><span class="n">dtv_cmds</span><span class="p">[</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="p">].</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">dtv_cmds</span><span class="p">[</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="p">].</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() tvp.u.buffer.len = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="p">,</span><span class="n">__func__</span>
			<span class="p">,</span><span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() tvp.u.buffer.data[0x%02x] = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="p">,</span><span class="n">__func__</span>
				<span class="p">,</span><span class="n">i</span>
				<span class="p">,</span><span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() tvp.u.data = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Synchronise the legacy tuning parameters into the cache, so that demodulator</span>
<span class="cm"> * drivers can use a single set_frontend tuning function, regardless of whether</span>
<span class="cm"> * it&#39;s being used for the legacy or new API, reducing code and complexity.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dtv_property_cache_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">dvb_frontend_parameters</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">inversion</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dvbv3_type</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DVBV3_QPSK</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() Preparing QPSK req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">qpsk</span><span class="p">.</span><span class="n">symbol_rate</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">fec_inner</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">qpsk</span><span class="p">.</span><span class="n">fec_inner</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DVBV3_QAM</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() Preparing QAM req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">qam</span><span class="p">.</span><span class="n">symbol_rate</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">fec_inner</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">qam</span><span class="p">.</span><span class="n">fec_inner</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">qam</span><span class="p">.</span><span class="n">modulation</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DVBV3_OFDM</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() Preparing OFDM req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ofdm</span><span class="p">.</span><span class="n">bandwidth</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BANDWIDTH_10_MHZ</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">10000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BANDWIDTH_8_MHZ</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">8000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BANDWIDTH_7_MHZ</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">7000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BANDWIDTH_6_MHZ</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">6000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BANDWIDTH_5_MHZ</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">5000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BANDWIDTH_1_712_MHZ</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">1712000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BANDWIDTH_AUTO</span>:
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">c</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ofdm</span><span class="p">.</span><span class="n">code_rate_HP</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ofdm</span><span class="p">.</span><span class="n">code_rate_LP</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ofdm</span><span class="p">.</span><span class="n">constellation</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ofdm</span><span class="p">.</span><span class="n">transmission_mode</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ofdm</span><span class="p">.</span><span class="n">guard_interval</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ofdm</span><span class="p">.</span><span class="n">hierarchy_information</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DVBV3_ATSC</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() Preparing ATSC req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vsb</span><span class="p">.</span><span class="n">modulation</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span> <span class="o">==</span> <span class="n">SYS_ATSCMH</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">VSB_8</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">VSB_16</span><span class="p">))</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span> <span class="o">=</span> <span class="n">SYS_ATSC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span> <span class="o">=</span> <span class="n">SYS_DVBC_ANNEX_B</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DVBV3_UNKNOWN</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;%s: doesn&#39;t know how to handle a DVBv3 call to delivery system %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Ensure the cached values are set correctly in the frontend</span>
<span class="cm"> * legacy tuning structures, for the advanced tuning API.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dtv_property_legacy_params_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">dvb_frontend_parameters</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">inversion</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dvbv3_type</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DVBV3_UNKNOWN</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;%s: doesn&#39;t know how to handle a DVBv3 call to delivery system %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DVBV3_QPSK</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() Preparing QPSK req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">qpsk</span><span class="p">.</span><span class="n">symbol_rate</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">symbol_rate</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">qpsk</span><span class="p">.</span><span class="n">fec_inner</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">fec_inner</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DVBV3_QAM</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() Preparing QAM req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">qam</span><span class="p">.</span><span class="n">symbol_rate</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">symbol_rate</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">qam</span><span class="p">.</span><span class="n">fec_inner</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">fec_inner</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">qam</span><span class="p">.</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DVBV3_OFDM</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() Preparing OFDM req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">10000000</span>:
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ofdm</span><span class="p">.</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="n">BANDWIDTH_10_MHZ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8000000</span>:
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ofdm</span><span class="p">.</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="n">BANDWIDTH_8_MHZ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">7000000</span>:
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ofdm</span><span class="p">.</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="n">BANDWIDTH_7_MHZ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">6000000</span>:
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ofdm</span><span class="p">.</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="n">BANDWIDTH_6_MHZ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5000000</span>:
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ofdm</span><span class="p">.</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="n">BANDWIDTH_5_MHZ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1712000</span>:
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ofdm</span><span class="p">.</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="n">BANDWIDTH_1_712_MHZ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">0</span>:
		<span class="nl">default:</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ofdm</span><span class="p">.</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="n">BANDWIDTH_AUTO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ofdm</span><span class="p">.</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ofdm</span><span class="p">.</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ofdm</span><span class="p">.</span><span class="n">constellation</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ofdm</span><span class="p">.</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">transmission_mode</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ofdm</span><span class="p">.</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">guard_interval</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ofdm</span><span class="p">.</span><span class="n">hierarchy_information</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">hierarchy</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DVBV3_ATSC</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() Preparing VSB req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vsb</span><span class="p">.</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dtv_get_frontend - calls a callback for retrieving DTV parameters</span>
<span class="cm"> * @fe:		struct dvb_frontend pointer</span>
<span class="cm"> * @c:		struct dtv_frontend_properties pointer (DVBv5 cache)</span>
<span class="cm"> * @p_out	struct dvb_frontend_parameters pointer (DVBv3 FE struct)</span>
<span class="cm"> *</span>
<span class="cm"> * This routine calls either the DVBv3 or DVBv5 get_frontend call.</span>
<span class="cm"> * If c is not null, it will update the DVBv5 cache struct pointed by it.</span>
<span class="cm"> * If p_out is not null, it will update the DVBv3 params pointed by it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dtv_get_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">dvb_frontend_parameters</span> <span class="o">*</span><span class="n">p_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_frontend</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_frontend</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_out</span><span class="p">)</span>
			<span class="n">dtv_property_legacy_params_sync</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">p_out</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* As everything is in cache, get_frontend fops are always supported */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dvb_frontend_ioctl_legacy</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">parg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dvb_frontend_ioctl_properties</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">parg</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dtv_property_process_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">dtv_property</span> <span class="o">*</span><span class="n">tvp</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">ncaps</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">tvp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DTV_ENUM_DELSYS</span>:
		<span class="n">ncaps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">delsys</span><span class="p">[</span><span class="n">ncaps</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">ncaps</span> <span class="o">&lt;</span> <span class="n">MAX_DELSYS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">ncaps</span><span class="p">]</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">delsys</span><span class="p">[</span><span class="n">ncaps</span><span class="p">];</span>
			<span class="n">ncaps</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ncaps</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_FREQUENCY</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_MODULATION</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_BANDWIDTH_HZ</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_INVERSION</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">inversion</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_SYMBOL_RATE</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">symbol_rate</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_INNER_FEC</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">fec_inner</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_PILOT</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">pilot</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ROLLOFF</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">rolloff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_DELIVERY_SYSTEM</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_VOLTAGE</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">voltage</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_TONE</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">sectone</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_API_VERSION</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">DVB_API_VERSION</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">DVB_API_VERSION_MINOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_CODE_RATE_HP</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_CODE_RATE_LP</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_GUARD_INTERVAL</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">guard_interval</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_TRANSMISSION_MODE</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">transmission_mode</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_HIERARCHY</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">hierarchy</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* ISDB-T Support here */</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_PARTIAL_RECEPTION</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_partial_reception</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_SOUND_BROADCASTING</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_mode</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_SB_SUBCHANNEL_ID</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_subchannel</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_SB_SEGMENT_IDX</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_segment_idx</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_SB_SEGMENT_COUNT</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_segment_count</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYER_ENABLED</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_layer_enabled</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERA_FEC</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fec</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERA_MODULATION</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">modulation</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERA_SEGMENT_COUNT</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">segment_count</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERA_TIME_INTERLEAVING</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">interleaving</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERB_FEC</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">fec</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERB_MODULATION</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">modulation</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERB_SEGMENT_COUNT</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">segment_count</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERB_TIME_INTERLEAVING</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">interleaving</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERC_FEC</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">fec</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERC_MODULATION</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">modulation</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERC_SEGMENT_COUNT</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">segment_count</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERC_TIME_INTERLEAVING</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">interleaving</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBS_TS_ID</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbs_ts_id</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_DVBT2_PLP_ID</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">dvbt2_plp_id</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* ATSC-MH */</span>
	<span class="k">case</span> <span class="n">DTV_ATSCMH_FIC_VER</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">atscmh_fic_ver</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ATSCMH_PARADE_ID</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">atscmh_parade_id</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ATSCMH_NOG</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">atscmh_nog</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ATSCMH_TNOG</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">atscmh_tnog</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ATSCMH_SGN</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">atscmh_sgn</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ATSCMH_PRC</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">atscmh_prc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ATSCMH_RS_FRAME_MODE</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">atscmh_rs_frame_mode</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ATSCMH_RS_FRAME_ENSEMBLE</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">atscmh_rs_frame_ensemble</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ATSCMH_RS_CODE_MODE_PRI</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">atscmh_rs_code_mode_pri</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ATSCMH_RS_CODE_MODE_SEC</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">atscmh_rs_code_mode_sec</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ATSCMH_SCCC_BLOCK_MODE</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">atscmh_sccc_block_mode</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ATSCMH_SCCC_CODE_MODE_A</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">atscmh_sccc_code_mode_a</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ATSCMH_SCCC_CODE_MODE_B</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">atscmh_sccc_code_mode_b</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ATSCMH_SCCC_CODE_MODE_C</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">atscmh_sccc_code_mode_c</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ATSCMH_SCCC_CODE_MODE_D</span>:
		<span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">atscmh_sccc_code_mode_d</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allow the frontend to override outgoing properties */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_property</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_property</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">tvp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dtv_property_dump</span><span class="p">(</span><span class="n">tvp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dtv_set_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_dvbv3_delsys</span><span class="p">(</span><span class="n">u32</span> <span class="n">delsys</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">delsys</span> <span class="o">==</span> <span class="n">SYS_DVBT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">delsys</span> <span class="o">==</span> <span class="n">SYS_DVBC_ANNEX_A</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">delsys</span> <span class="o">==</span> <span class="n">SYS_DVBS</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">delsys</span> <span class="o">==</span> <span class="n">SYS_ATSC</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_delivery_system</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">desired_system</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ncaps</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">delsys</span> <span class="o">=</span> <span class="n">SYS_UNDEFINED</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dvbv3_emulation_type</span> <span class="n">type</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * It was reported that some old DVBv5 applications were</span>
<span class="cm">	 * filling delivery_system with SYS_UNDEFINED. If this happens,</span>
<span class="cm">	 * assume that the application wants to use the first supported</span>
<span class="cm">	 * delivery system.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span> <span class="o">==</span> <span class="n">SYS_UNDEFINED</span><span class="p">)</span>
	        <span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">delsys</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">desired_system</span> <span class="o">==</span> <span class="n">SYS_UNDEFINED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * A DVBv3 call doesn&#39;t know what&#39;s the desired system.</span>
<span class="cm">		 * Also, DVBv3 applications don&#39;t know that ops.info-&gt;type</span>
<span class="cm">		 * could be changed, and they simply dies when it doesn&#39;t</span>
<span class="cm">		 * match.</span>
<span class="cm">		 * So, don&#39;t change the current delivery system, as it</span>
<span class="cm">		 * may be trying to do the wrong thing, like setting an</span>
<span class="cm">		 * ISDB-T frontend as DVB-T. Instead, find the closest</span>
<span class="cm">		 * DVBv3 system that matches the delivery system.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_dvbv3_delsys</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() Using delivery system to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">dvbv3_type</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DVBV3_QPSK</span>:
			<span class="n">desired_system</span> <span class="o">=</span> <span class="n">SYS_DVBS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DVBV3_QAM</span>:
			<span class="n">desired_system</span> <span class="o">=</span> <span class="n">SYS_DVBC_ANNEX_A</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DVBV3_ATSC</span>:
			<span class="n">desired_system</span> <span class="o">=</span> <span class="n">SYS_ATSC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DVBV3_OFDM</span>:
			<span class="n">desired_system</span> <span class="o">=</span> <span class="n">SYS_DVBT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s(): This frontend doesn&#39;t support DVBv3 calls</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Get a delivery system that is compatible with DVBv3</span>
<span class="cm">		 * NOTE: in order for this to work with softwares like Kaffeine that</span>
<span class="cm">		 *	uses a DVBv5 call for DVB-S2 and a DVBv3 call to go back to</span>
<span class="cm">		 *	DVB-S, drivers that support both should put the SYS_DVBS entry</span>
<span class="cm">		 *	before the SYS_DVBS2, otherwise it won&#39;t switch back to DVB-S.</span>
<span class="cm">		 *	The real fix is that userspace applications should not use DVBv3</span>
<span class="cm">		 *	and not trust on calling FE_SET_FRONTEND to switch the delivery</span>
<span class="cm">		 *	system.</span>
<span class="cm">		 */</span>
		<span class="n">ncaps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">delsys</span><span class="p">[</span><span class="n">ncaps</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">ncaps</span> <span class="o">&lt;</span> <span class="n">MAX_DELSYS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">delsys</span><span class="p">[</span><span class="n">ncaps</span><span class="p">]</span> <span class="o">==</span> <span class="n">desired_system</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">delsys</span> <span class="o">=</span> <span class="n">desired_system</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ncaps</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delsys</span> <span class="o">==</span> <span class="n">SYS_UNDEFINED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() Couldn&#39;t find a delivery system that matches %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">desired_system</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This is a DVBv5 call. So, it likely knows the supported</span>
<span class="cm">		 * delivery systems.</span>
<span class="cm">		 */</span>

		<span class="cm">/* Check if the desired delivery system is supported */</span>
		<span class="n">ncaps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">delsys</span><span class="p">[</span><span class="n">ncaps</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">ncaps</span> <span class="o">&lt;</span> <span class="n">MAX_DELSYS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">delsys</span><span class="p">[</span><span class="n">ncaps</span><span class="p">]</span> <span class="o">==</span> <span class="n">desired_system</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span> <span class="o">=</span> <span class="n">desired_system</span><span class="p">;</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() Changing delivery system to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">desired_system</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ncaps</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">dvbv3_type</span><span class="p">(</span><span class="n">desired_system</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * The delivery system is not supported. See if it can be</span>
<span class="cm">		 * emulated.</span>
<span class="cm">		 * The emulation only works if the desired system is one of the</span>
<span class="cm">		 * DVBv3 delivery systems</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_dvbv3_delsys</span><span class="p">(</span><span class="n">desired_system</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() can&#39;t use a DVBv3 FE_SET_FRONTEND call on this frontend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Get the last non-DVBv3 delivery system that has the same type</span>
<span class="cm">		 * of the desired system</span>
<span class="cm">		 */</span>
		<span class="n">ncaps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">delsys</span><span class="p">[</span><span class="n">ncaps</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">ncaps</span> <span class="o">&lt;</span> <span class="n">MAX_DELSYS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dvbv3_type</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">delsys</span><span class="p">[</span><span class="n">ncaps</span><span class="p">])</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">is_dvbv3_delsys</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">delsys</span><span class="p">[</span><span class="n">ncaps</span><span class="p">]))</span>
				<span class="n">delsys</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">delsys</span><span class="p">[</span><span class="n">ncaps</span><span class="p">];</span>
			<span class="n">ncaps</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* There&#39;s nothing compatible with the desired delivery system */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delsys</span> <span class="o">==</span> <span class="n">SYS_UNDEFINED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() Incompatible DVBv3 FE_SET_FRONTEND call for this frontend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span> <span class="o">=</span> <span class="n">delsys</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The DVBv3 or DVBv5 call is requesting a different system. So,</span>
<span class="cm">	 * emulation is needed.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Emulate newer delivery systems like ISDBT, DVBT and DMBTH</span>
<span class="cm">	 * for older DVBv5 applications. The emulation will try to use</span>
<span class="cm">	 * the auto mode for most things, and will assume that the desired</span>
<span class="cm">	 * delivery system is the last one at the ops.delsys[] array</span>
<span class="cm">	 */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() Using delivery system %d emulated as if it were a %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">delsys</span><span class="p">,</span> <span class="n">desired_system</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * For now, handles ISDB-T calls. More code may be needed here for the</span>
<span class="cm">	 * other emulated stuff</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">DVBV3_OFDM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span> <span class="o">==</span> <span class="n">SYS_ISDBT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() Using defaults for SYS_ISDBT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">)</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">6000000</span><span class="p">;</span>

			<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_partial_reception</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_subchannel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_segment_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_segment_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_layer_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fec</span> <span class="o">=</span> <span class="n">FEC_AUTO</span><span class="p">;</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">QAM_AUTO</span><span class="p">;</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">interleaving</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;change delivery system on cache to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dtv_property_process_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">dtv_property</span> <span class="o">*</span><span class="n">tvp</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>

	<span class="cm">/* Allow the frontend to validate incoming properties */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_property</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_property</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">tvp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">tvp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DTV_CLEAR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Reset a cache of data specific to the frontend here. This does</span>
<span class="cm">		 * not effect hardware.</span>
<span class="cm">		 */</span>
		<span class="n">dvb_frontend_clear_cache</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_TUNE</span>:
		<span class="cm">/* interpret the cache of data, build either a traditional frontend</span>
<span class="cm">		 * tunerequest so we can pass validation in the FE_SET_FRONTEND</span>
<span class="cm">		 * ioctl.</span>
<span class="cm">		 */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() Finalised property cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">dtv_set_frontend</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_FREQUENCY</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_MODULATION</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_BANDWIDTH_HZ</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_INVERSION</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_SYMBOL_RATE</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_INNER_FEC</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">fec_inner</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_PILOT</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">pilot</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ROLLOFF</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">rolloff</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_DELIVERY_SYSTEM</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">set_delivery_system</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_VOLTAGE</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">voltage</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">dvb_frontend_ioctl_legacy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">FE_SET_VOLTAGE</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">voltage</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_TONE</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">sectone</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">dvb_frontend_ioctl_legacy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">FE_SET_TONE</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">sectone</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_CODE_RATE_HP</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_CODE_RATE_LP</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_GUARD_INTERVAL</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_TRANSMISSION_MODE</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_HIERARCHY</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* ISDB-T Support here */</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_PARTIAL_RECEPTION</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_partial_reception</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_SOUND_BROADCASTING</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_mode</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_SB_SUBCHANNEL_ID</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_subchannel</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_SB_SEGMENT_IDX</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_segment_idx</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_SB_SEGMENT_COUNT</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_sb_segment_count</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYER_ENABLED</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbt_layer_enabled</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERA_FEC</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fec</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERA_MODULATION</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERA_SEGMENT_COUNT</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERA_TIME_INTERLEAVING</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">interleaving</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERB_FEC</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">fec</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERB_MODULATION</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERB_SEGMENT_COUNT</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERB_TIME_INTERLEAVING</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">interleaving</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERC_FEC</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">fec</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERC_MODULATION</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERC_SEGMENT_COUNT</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">segment_count</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBT_LAYERC_TIME_INTERLEAVING</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">layer</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">interleaving</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ISDBS_TS_ID</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">isdbs_ts_id</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_DVBT2_PLP_ID</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">dvbt2_plp_id</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* ATSC-MH */</span>
	<span class="k">case</span> <span class="n">DTV_ATSCMH_PARADE_ID</span>:
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">atscmh_parade_id</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTV_ATSCMH_RS_FRAME_ENSEMBLE</span>:
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">atscmh_rs_frame_ensemble</span> <span class="o">=</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_frontend_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">parg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">exit</span> <span class="o">!=</span> <span class="n">DVB_FE_NO_EXIT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_ACCMODE</span><span class="p">)</span> <span class="o">==</span> <span class="n">O_RDONLY</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">_IOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">_IOC_READ</span> <span class="o">||</span> <span class="n">cmd</span> <span class="o">==</span> <span class="n">FE_GET_EVENT</span> <span class="o">||</span>
	     <span class="n">cmd</span> <span class="o">==</span> <span class="n">FE_DISEQC_RECV_SLAVE_REPLY</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">FE_SET_PROPERTY</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">FE_GET_PROPERTY</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dvb_frontend_ioctl_properties</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">parg</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">DTV_UNDEFINED</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dvb_frontend_ioctl_legacy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">parg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_frontend_ioctl_properties</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">parg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dtv_properties</span> <span class="o">*</span><span class="n">tvps</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dtv_property</span> <span class="o">*</span><span class="n">tvp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">FE_SET_PROPERTY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tvps</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dtv_properties</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">parg</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() properties.num = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">tvps</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() properties.props = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">tvps</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">);</span>

		<span class="cm">/* Put an arbitrary limit on the number of messages that can</span>
<span class="cm">		 * be sent at once */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tvps</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tvps</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&gt;</span> <span class="n">DTV_IOCTL_MAX_MSGS</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">tvp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">tvps</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dtv_property</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tvp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">tvp</span><span class="p">,</span> <span class="n">tvps</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">,</span> <span class="n">tvps</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dtv_property</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tvps</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">dtv_property_process_set</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">tvp</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">(</span><span class="n">tvp</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DTV_TUNE</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() Property cache is full, tuning</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span>
	<span class="k">if</span><span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">FE_GET_PROPERTY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tvps</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dtv_properties</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">parg</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() properties.num = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">tvps</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s() properties.props = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">tvps</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">);</span>

		<span class="cm">/* Put an arbitrary limit on the number of messages that can</span>
<span class="cm">		 * be sent at once */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tvps</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tvps</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&gt;</span> <span class="n">DTV_IOCTL_MAX_MSGS</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">tvp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">tvps</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dtv_property</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tvp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">tvp</span><span class="p">,</span> <span class="n">tvps</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">,</span> <span class="n">tvps</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dtv_property</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Fills the cache out struct with the cache contents, plus</span>
<span class="cm">		 * the data retrieved from get_frontend, if the frontend</span>
<span class="cm">		 * is not idle. Otherwise, returns the cached content</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FESTATE_IDLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">dtv_get_frontend</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tvps</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">dtv_property_process_get</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">tvp</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">(</span><span class="n">tvp</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">tvps</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">,</span> <span class="n">tvp</span><span class="p">,</span> <span class="n">tvps</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dtv_property</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tvp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dtv_set_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_tune_settings</span> <span class="n">fetunesettings</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rolloff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dvb_frontend_check_parameters</span><span class="p">(</span><span class="n">fe</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize output parameters to match the values given by</span>
<span class="cm">	 * the user. FE_SET_FRONTEND triggers an initial frontend event</span>
<span class="cm">	 * with status = 0, which copies output parameters to userspace.</span>
<span class="cm">	 */</span>
	<span class="n">dtv_property_legacy_params_sync</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">parameters_out</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Be sure that the bandwidth will be filled for all</span>
<span class="cm">	 * non-satellite systems, as tuners need to know what</span>
<span class="cm">	 * low pass/Nyquist half filter should be applied, in</span>
<span class="cm">	 * order to avoid inter-channel noise.</span>
<span class="cm">	 *</span>
<span class="cm">	 * ISDB-T and DVB-T/T2 already sets bandwidth.</span>
<span class="cm">	 * ATSC and DVB-C don&#39;t set, so, the core should fill it.</span>
<span class="cm">	 *</span>
<span class="cm">	 * On DVB-C Annex A and C, the bandwidth is a function of</span>
<span class="cm">	 * the roll-off and symbol rate. Annex B defines different</span>
<span class="cm">	 * roll-off factors depending on the modulation. Fortunately,</span>
<span class="cm">	 * Annex B is only used with 6MHz, so there&#39;s no need to</span>
<span class="cm">	 * calculate it.</span>
<span class="cm">	 *</span>
<span class="cm">	 * While not officially supported, a side effect of handling it at</span>
<span class="cm">	 * the cache level is that a program could retrieve the bandwidth</span>
<span class="cm">	 * via DTV_BANDWIDTH_HZ, which may be useful for test programs.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_ATSC</span>:
	<span class="k">case</span> <span class="n">SYS_DVBC_ANNEX_B</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="mi">6000000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_DVBC_ANNEX_A</span>:
		<span class="n">rolloff</span> <span class="o">=</span> <span class="mi">115</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_DVBC_ANNEX_C</span>:
		<span class="n">rolloff</span> <span class="o">=</span> <span class="mi">113</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rolloff</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">*</span> <span class="n">rolloff</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>

	<span class="cm">/* force auto frequency inversion if requested */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dvb_force_auto_inversion</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">INVERSION_AUTO</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * without hierarchical coding code_rate_LP is irrelevant,</span>
<span class="cm">	 * so we tolerate the otherwise invalid FEC_NONE setting</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">==</span> <span class="n">HIERARCHY_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">==</span> <span class="n">FEC_NONE</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span> <span class="o">=</span> <span class="n">FEC_AUTO</span><span class="p">;</span>

	<span class="cm">/* get frontend-specific tuning settings */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fetunesettings</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend_tune_settings</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_tune_settings</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_tune_settings</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fetunesettings</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">min_delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">fetunesettings</span><span class="p">.</span><span class="n">min_delay_ms</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">max_drift</span> <span class="o">=</span> <span class="n">fetunesettings</span><span class="p">.</span><span class="n">max_drift</span><span class="p">;</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">step_size</span> <span class="o">=</span> <span class="n">fetunesettings</span><span class="p">.</span><span class="n">step_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* default values */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SYS_DVBS</span>:
		<span class="k">case</span> <span class="n">SYS_DVBS2</span>:
		<span class="k">case</span> <span class="n">SYS_ISDBS</span>:
		<span class="k">case</span> <span class="n">SYS_TURBO</span>:
		<span class="k">case</span> <span class="n">SYS_DVBC_ANNEX_A</span>:
		<span class="k">case</span> <span class="n">SYS_DVBC_ANNEX_C</span>:
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">min_delay</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">20</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">step_size</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">/</span> <span class="mi">16000</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">max_drift</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">/</span> <span class="mi">2000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SYS_DVBT</span>:
		<span class="k">case</span> <span class="n">SYS_DVBT2</span>:
		<span class="k">case</span> <span class="n">SYS_ISDBT</span>:
		<span class="k">case</span> <span class="n">SYS_DMBTH</span>:
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">min_delay</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">20</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">step_size</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">frequency_stepsize</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">max_drift</span> <span class="o">=</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">frequency_stepsize</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/*</span>
<span class="cm">			 * FIXME: This sounds wrong! if freqency_stepsize is</span>
<span class="cm">			 * defined by the frontend, why not use it???</span>
<span class="cm">			 */</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">min_delay</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">20</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">step_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* no zigzag */</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">max_drift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dvb_override_tune_delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">min_delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">dvb_override_tune_delay</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FESTATE_RETUNE</span><span class="p">;</span>

	<span class="cm">/* Request the search algorithm to search */</span>
	<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">algo_status</span> <span class="o">|=</span> <span class="n">DVBFE_ALGO_SEARCH_AGAIN</span><span class="p">;</span>

	<span class="n">dvb_frontend_clear_events</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="n">dvb_frontend_add_event</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dvb_frontend_wakeup</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_frontend_ioctl_legacy</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">parg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cb_err</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe_ioctl_override</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cb_err</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe_ioctl_override</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">parg</span><span class="p">,</span>
						    <span class="n">DVB_FE_IOCTL_PRE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cb_err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">cb_err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cb_err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* fe_ioctl_override returning 0 allows</span>
<span class="cm">		 * dvb-core to continue handling the ioctl */</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FE_GET_INFO</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dvb_frontend_info</span><span class="o">*</span> <span class="n">info</span> <span class="o">=</span> <span class="n">parg</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend_info</span><span class="p">));</span>
		<span class="n">dvb_frontend_get_frequency_limits</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">frequency_min</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">frequency_max</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Associate the 4 delivery systems supported by DVBv3</span>
<span class="cm">		 * API with their DVBv5 counterpart. For the other standards,</span>
<span class="cm">		 * use the closest type, assuming that it would hopefully</span>
<span class="cm">		 * work with a DVBv3 application.</span>
<span class="cm">		 * It should be noticed that, on multi-frontend devices with</span>
<span class="cm">		 * different types (terrestrial and cable, for example),</span>
<span class="cm">		 * a pure DVBv3 application won&#39;t be able to use all delivery</span>
<span class="cm">		 * systems. Yet, changing the DVBv5 cache to the other delivery</span>
<span class="cm">		 * system should be enough for making it work.</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dvbv3_type</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DVBV3_QPSK</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FE_QPSK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DVBV3_ATSC</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FE_ATSC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DVBV3_QAM</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FE_QAM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DVBV3_OFDM</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FE_OFDM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;%s: doesn&#39;t know how to handle a DVBv3 call to delivery system %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">);</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FE_OFDM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;current delivery system on cache: %d, V3 type: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">delivery_system</span><span class="p">,</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>

		<span class="cm">/* Force the CAN_INVERSION_AUTO bit on. If the frontend doesn&#39;t</span>
<span class="cm">		 * do it, it is done for it. */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">FE_CAN_INVERSION_AUTO</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">FE_READ_STATUS</span>: <span class="p">{</span>
		<span class="n">fe_status_t</span><span class="o">*</span> <span class="n">status</span> <span class="o">=</span> <span class="n">parg</span><span class="p">;</span>

		<span class="cm">/* if retune was requested but hasn&#39;t occurred yet, prevent</span>
<span class="cm">		 * that user get signal state from previous tuning */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FESTATE_RETUNE</span> <span class="o">||</span>
		    <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FESTATE_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
			<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_status</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_status</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">FE_READ_BER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_ber</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_ber</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="p">(</span><span class="n">__u32</span><span class="o">*</span><span class="p">)</span> <span class="n">parg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FE_READ_SIGNAL_STRENGTH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_signal_strength</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_signal_strength</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="p">(</span><span class="n">__u16</span><span class="o">*</span><span class="p">)</span> <span class="n">parg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FE_READ_SNR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_snr</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_snr</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="p">(</span><span class="n">__u16</span><span class="o">*</span><span class="p">)</span> <span class="n">parg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FE_READ_UNCORRECTED_BLOCKS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_ucblocks</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_ucblocks</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="p">(</span><span class="n">__u32</span><span class="o">*</span><span class="p">)</span> <span class="n">parg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>


	<span class="k">case</span> <span class="n">FE_DISEQC_RESET_OVERLOAD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_reset_overload</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_reset_overload</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FESTATE_DISEQC</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FE_DISEQC_SEND_MASTER_CMD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_master_cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_master_cmd</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dvb_diseqc_master_cmd</span><span class="o">*</span><span class="p">)</span> <span class="n">parg</span><span class="p">);</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FESTATE_DISEQC</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FE_DISEQC_SEND_BURST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_burst</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_send_burst</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="p">(</span><span class="n">fe_sec_mini_cmd_t</span><span class="p">)</span> <span class="n">parg</span><span class="p">);</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FESTATE_DISEQC</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FE_SET_TONE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_tone</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_tone</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="p">(</span><span class="n">fe_sec_tone_mode_t</span><span class="p">)</span> <span class="n">parg</span><span class="p">);</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">tone</span> <span class="o">=</span> <span class="p">(</span><span class="n">fe_sec_tone_mode_t</span><span class="p">)</span> <span class="n">parg</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FESTATE_DISEQC</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FE_SET_VOLTAGE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_voltage</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_voltage</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="p">(</span><span class="n">fe_sec_voltage_t</span><span class="p">)</span> <span class="n">parg</span><span class="p">);</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">voltage</span> <span class="o">=</span> <span class="p">(</span><span class="n">fe_sec_voltage_t</span><span class="p">)</span> <span class="n">parg</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FESTATE_DISEQC</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FE_DISHNETWORK_SEND_LEGACY_CMD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">dishnetwork_send_legacy_command</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">dishnetwork_send_legacy_command</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">parg</span><span class="p">);</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FESTATE_DISEQC</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_voltage</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * NOTE: This is a fallback condition.  Some frontends</span>
<span class="cm">			 * (stv0299 for instance) take longer than 8msec to</span>
<span class="cm">			 * respond to a set_voltage command.  Those switches</span>
<span class="cm">			 * need custom routines to switch properly.  For all</span>
<span class="cm">			 * other frontends, the following should work ok.</span>
<span class="cm">			 * Dish network legacy switches (as used by Dish500)</span>
<span class="cm">			 * are controlled by sending 9-bit command words</span>
<span class="cm">			 * spaced 8msec apart.</span>
<span class="cm">			 * the actual command word is switch/port dependent</span>
<span class="cm">			 * so it is up to the userspace application to send</span>
<span class="cm">			 * the right command.</span>
<span class="cm">			 * The command must always start with a &#39;0&#39; after</span>
<span class="cm">			 * initialization, so parg is 8 bits and does not</span>
<span class="cm">			 * include the initialization or start bit</span>
<span class="cm">			 */</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">swcmd</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">parg</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">timeval</span> <span class="n">nexttime</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">last</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dvb_frontend_debug</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s switch command: 0x%04lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">swcmd</span><span class="p">);</span>
			<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nexttime</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dvb_frontend_debug</span><span class="p">)</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">nexttime</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">timeval</span><span class="p">));</span>
			<span class="cm">/* before sending a command, initialize by sending</span>
<span class="cm">			 * a 32ms 18V to the switch</span>
<span class="cm">			 */</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_voltage</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SEC_VOLTAGE_18</span><span class="p">);</span>
			<span class="n">dvb_frontend_sleep_until</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nexttime</span><span class="p">,</span> <span class="mi">32000</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dvb_frontend_debug</span><span class="p">)</span>
					<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">swcmd</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">!=</span> <span class="n">last</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* set voltage to (last ? 13V : 18V) */</span>
					<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_voltage</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span> <span class="o">?</span> <span class="n">SEC_VOLTAGE_13</span> <span class="o">:</span> <span class="n">SEC_VOLTAGE_18</span><span class="p">);</span>
					<span class="n">last</span> <span class="o">=</span> <span class="p">(</span><span class="n">last</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">swcmd</span> <span class="o">=</span> <span class="n">swcmd</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span>
					<span class="n">dvb_frontend_sleep_until</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nexttime</span><span class="p">,</span> <span class="mi">8000</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dvb_frontend_debug</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d): switch delay (should be 32k followed by all 8k</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">timeval_usec_diff</span><span class="p">(</span><span class="n">tv</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">,</span> <span class="n">tv</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
			<span class="p">}</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FESTATE_DISEQC</span><span class="p">;</span>
			<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FE_DISEQC_RECV_SLAVE_REPLY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_recv_slave_reply</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">diseqc_recv_slave_reply</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dvb_diseqc_slave_reply</span><span class="o">*</span><span class="p">)</span> <span class="n">parg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FE_ENABLE_HIGH_LNB_VOLTAGE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">enable_high_lnb_voltage</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">enable_high_lnb_voltage</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">parg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FE_SET_FRONTEND</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">set_delivery_system</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SYS_UNDEFINED</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">dtv_property_cache_sync</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">parg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dtv_set_frontend</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FE_GET_EVENT</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">dvb_frontend_get_event</span> <span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">parg</span><span class="p">,</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FE_GET_FRONTEND</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">dtv_get_frontend</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">parg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FE_SET_FRONTEND_TUNE_MODE</span>:
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">tune_mode_flags</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">parg</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe_ioctl_override</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cb_err</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">fe_ioctl_override</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">parg</span><span class="p">,</span>
						    <span class="n">DVB_FE_IOCTL_POST</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cb_err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">cb_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dvb_frontend_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">poll_table_struct</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>

	<span class="n">dprintk</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">poll_wait</span> <span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">wait_queue</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">eventw</span> <span class="o">!=</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">eventr</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span> <span class="o">|</span> <span class="n">POLLPRI</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_frontend_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">exit</span> <span class="o">==</span> <span class="n">DVB_FE_DEVICE_REMOVED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mfe_shared</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mfe_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mfe_dvbdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mfe_dvbdev</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mfe_dvbdev</span> <span class="o">!=</span> <span class="n">dvbdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">dvb_device</span>
				<span class="o">*</span><span class="n">mfedev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mfe_dvbdev</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">dvb_frontend</span>
				<span class="o">*</span><span class="n">mfe</span> <span class="o">=</span> <span class="n">mfedev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">dvb_frontend_private</span>
				<span class="o">*</span><span class="n">mfepriv</span> <span class="o">=</span> <span class="n">mfe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">mferetry</span> <span class="o">=</span> <span class="p">(</span><span class="n">dvb_mfe_wait_time</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">mutex_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mfe_lock</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">mferetry</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mfedev</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span>
					<span class="n">mfepriv</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">500</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span><span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">mutex_lock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mfe_lock</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mfe_dvbdev</span> <span class="o">!=</span> <span class="n">dvbdev</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mfedev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mfe_dvbdev</span><span class="p">;</span>
				<span class="n">mfe</span> <span class="o">=</span> <span class="n">mfedev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
				<span class="n">mfepriv</span> <span class="o">=</span> <span class="n">mfe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mfedev</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span>
						<span class="n">mfepriv</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mutex_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mfe_lock</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mfe_dvbdev</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">ts_bus_ctrl</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">ts_bus_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>

		<span class="cm">/* If we took control of the bus, we need to force</span>
<span class="cm">		   reinitialization.  This is because many ts_bus_ctrl()</span>
<span class="cm">		   functions strobe the RESET pin on the demod, and if the</span>
<span class="cm">		   frontend thread already exists then the dvb_init() routine</span>
<span class="cm">		   won&#39;t get called (which is what usually does initial</span>
<span class="cm">		   register configuration). */</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">reinitialise</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_generic_open</span> <span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_ACCMODE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">O_RDONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* normal tune mode when opened R/W */</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">tune_mode_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FE_TUNE_MODE_ONESHOT</span><span class="p">;</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">tone</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">voltage</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_frontend_start</span> <span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>

		<span class="cm">/*  empty event queue */</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">eventr</span> <span class="o">=</span> <span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">eventw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mfe_shared</span><span class="p">)</span>
		<span class="n">mutex_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mfe_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">err2:</span>
	<span class="n">dvb_generic_release</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
<span class="nl">err1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">ts_bus_ctrl</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">ts_bus_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">err0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mfe_shared</span><span class="p">)</span>
		<span class="n">mutex_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mfe_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvb_frontend_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_device</span> <span class="o">*</span><span class="n">dvbdev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_ACCMODE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">O_RDONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">release_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_generic_release</span> <span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">exit</span> <span class="o">!=</span> <span class="n">DVB_FE_NO_EXIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fops_put</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="p">);</span>
			<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">ts_bus_ctrl</span><span class="p">)</span>
			<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">ts_bus_ctrl</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">dvb_frontend_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">dvb_generic_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">dvb_frontend_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">dvb_frontend_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">dvb_frontend_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">dvb_register_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_adapter</span><span class="o">*</span> <span class="n">dvb</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dvb_device</span> <span class="n">dvbdev_template</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">users</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">writers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">readers</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dvb_frontend_fops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">kernel_ioctl</span> <span class="o">=</span> <span class="n">dvb_frontend_ioctl</span>
	<span class="p">};</span>

	<span class="n">dprintk</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frontend_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend_private</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frontend_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fepriv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>

	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">wait_queue</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">mtx</span><span class="p">);</span>
	<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span> <span class="o">=</span> <span class="n">dvb</span><span class="p">;</span>
	<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">inversion</span> <span class="o">=</span> <span class="n">INVERSION_OFF</span><span class="p">;</span>

	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;DVB: registering adapter %i frontend %i (%s)...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="n">dvb_register_device</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dvbdev_template</span><span class="p">,</span>
			     <span class="n">fe</span><span class="p">,</span> <span class="n">DVB_DEVICE_FRONTEND</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the cache to the proper values according with the</span>
<span class="cm">	 * first supported delivery system (ops-&gt;delsys[0])</span>
<span class="cm">	 */</span>

        <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">delivery_system</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">delsys</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">dvb_frontend_clear_cache</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frontend_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dvb_register_frontend</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dvb_unregister_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_private</span> <span class="o">*</span><span class="n">fepriv</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">frontend_priv</span><span class="p">;</span>
	<span class="n">dprintk</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frontend_mutex</span><span class="p">);</span>
	<span class="n">dvb_frontend_stop</span> <span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frontend_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">,</span>
				<span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="o">-&gt;</span><span class="n">users</span><span class="o">==-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frontend_mutex</span><span class="p">);</span>
	<span class="n">dvb_unregister_device</span> <span class="p">(</span><span class="n">fepriv</span><span class="o">-&gt;</span><span class="n">dvbdev</span><span class="p">);</span>

	<span class="cm">/* fe is invalid now */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fepriv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frontend_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dvb_unregister_frontend</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MEDIA_ATTACH</span>
<span class="kt">void</span> <span class="nf">dvb_frontend_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">release_sec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">release_sec</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="n">symbol_put_addr</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">release_sec</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">release</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="n">symbol_put_addr</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">release</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">.</span><span class="n">release</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="n">symbol_put_addr</span><span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">.</span><span class="n">release</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
		<span class="n">symbol_put_addr</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="nf">dvb_frontend_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">release_sec</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">release_sec</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">release</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">.</span><span class="n">release</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">analog_ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">)</span>
		<span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dvb_frontend_detach</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
