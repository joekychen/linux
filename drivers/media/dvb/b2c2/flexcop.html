<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › b2c2 › flexcop.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>flexcop.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Linux driver for digital TV devices equipped with B2C2 FlexcopII(b)/III</span>
<span class="cm"> * flexcop.c - main module part</span>
<span class="cm"> * Copyright (C) 2004-9 Patrick Boettcher &lt;patrick.boettcher@desy.de&gt;</span>
<span class="cm"> * based on skystar2-driver Copyright (C) 2003 Vadim Catana, skystar@moldova.cc</span>
<span class="cm"> *</span>
<span class="cm"> * Acknowledgements:</span>
<span class="cm"> *   John Jurrius from BBTI, Inc. for extensive support</span>
<span class="cm"> *                    with code examples and data books</span>
<span class="cm"> *   Bjarne Steinsbo, bjarne at steinsbo.com (some ideas for rewriting)</span>
<span class="cm"> *</span>
<span class="cm"> * Contributions to the skystar2-driver have been done by</span>
<span class="cm"> *   Vincenzo Di Massa, hawk.it at tiscalinet.it (several DiSEqC fixes)</span>
<span class="cm"> *   Roberto Ragusa, r.ragusa at libero.it (polishing, restyling the code)</span>
<span class="cm"> *   Uwe Bugla, uwe.bugla at gmx.de (doing tests, restyling code, writing docu)</span>
<span class="cm"> *   Niklas Peinecke, peinecke at gdv.uni-hannover.de (hardware pid/mac</span>
<span class="cm"> *               filtering)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU Lesser General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version 2.1</span>
<span class="cm"> * of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU Lesser General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;flexcop.h&quot;</span>

<span class="cp">#define DRIVER_NAME &quot;B2C2 FlexcopII/II(b)/III digital TV receiver chip&quot;</span>
<span class="cp">#define DRIVER_AUTHOR &quot;Patrick Boettcher &lt;patrick.boettcher@desy.de&quot;</span>

<span class="cp">#ifdef CONFIG_DVB_B2C2_FLEXCOP_DEBUG</span>
<span class="cp">#define DEBSTATUS &quot;&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define DEBSTATUS &quot; (debugging is not enabled)&quot;</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="n">b2c2_flexcop_debug</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">b2c2_flexcop_debug</span><span class="p">,</span>  <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span>
		<span class="s">&quot;set debug level (1=info,2=tuner,4=i2c,8=ts,&quot;</span>
		<span class="s">&quot;16=sram,32=reg (|-able)).&quot;</span>
		<span class="n">DEBSTATUS</span><span class="p">);</span>
<span class="cp">#undef DEBSTATUS</span>

<span class="n">DVB_DEFINE_MOD_OPT_ADAPTER_NR</span><span class="p">(</span><span class="n">adapter_nr</span><span class="p">);</span>

<span class="cm">/* global zero for ibi values */</span>
<span class="n">flexcop_ibi_value</span> <span class="n">ibi_zero</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">flexcop_dvb_start_feed</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">dvbdmxfeed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span> <span class="o">=</span> <span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">flexcop_pid_feed_control</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">dvbdmxfeed</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">flexcop_dvb_stop_feed</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_demux_feed</span> <span class="o">*</span><span class="n">dvbdmxfeed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span> <span class="o">=</span> <span class="n">dvbdmxfeed</span><span class="o">-&gt;</span><span class="n">demux</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">flexcop_pid_feed_control</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">dvbdmxfeed</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">flexcop_dvb_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_register_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">,</span>
			<span class="s">&quot;FlexCop Digital TV device&quot;</span><span class="p">,</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">,</span>
			<span class="n">fc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">adapter_nr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;error registering DVB adapter&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fc</span><span class="p">;</span>

	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="p">(</span><span class="n">DMX_TS_FILTERING</span> <span class="o">|</span> <span class="n">DMX_SECTION_FILTERING</span>
			<span class="o">|</span> <span class="n">DMX_MEMORY_BASED_FILTERING</span><span class="p">);</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fc</span><span class="p">;</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">filternum</span> <span class="o">=</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">feednum</span> <span class="o">=</span> <span class="n">FC_MAX_FEED</span><span class="p">;</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">start_feed</span> <span class="o">=</span> <span class="n">flexcop_dvb_start_feed</span><span class="p">;</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">stop_feed</span> <span class="o">=</span> <span class="n">flexcop_dvb_stop_feed</span><span class="p">;</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">write_to_decoder</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_dmx_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;dvb_dmx failed: error %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_dmx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">hw_frontend</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">DMX_FRONTEND_0</span><span class="p">;</span>

	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">.</span><span class="n">filternum</span> <span class="o">=</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">feednum</span><span class="p">;</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">.</span><span class="n">demux</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">;</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_dmxdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;dvb_dmxdev_init failed: error %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_dmx_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">add_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">hw_frontend</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;adding hw_frontend to dmx failed: error %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_dmx_add_hw_frontend</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">mem_frontend</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">DMX_MEMORY_FE</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">add_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">mem_frontend</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;adding mem_frontend to dmx failed: error %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_dmx_add_mem_frontend</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">connect_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">hw_frontend</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;connect frontend failed: error %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_connect_frontend</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_net_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">dvbnet</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;dvb_net_init failed: error %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_net</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">init_state</span> <span class="o">|=</span> <span class="n">FC_STATE_DVB_INIT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_net:</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">disconnect_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">);</span>
<span class="nl">err_connect_frontend:</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">remove_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">mem_frontend</span><span class="p">);</span>
<span class="nl">err_dmx_add_mem_frontend:</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">remove_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">hw_frontend</span><span class="p">);</span>
<span class="nl">err_dmx_add_hw_frontend:</span>
	<span class="n">dvb_dmxdev_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">);</span>
<span class="nl">err_dmx_dev:</span>
	<span class="n">dvb_dmx_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">);</span>
<span class="nl">err_dmx:</span>
	<span class="n">dvb_unregister_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flexcop_dvb_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">init_state</span> <span class="o">&amp;</span> <span class="n">FC_STATE_DVB_INIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dvb_net_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">dvbnet</span><span class="p">);</span>

		<span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">);</span>
		<span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">remove_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">mem_frontend</span><span class="p">);</span>
		<span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">.</span><span class="n">remove_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">.</span><span class="n">dmx</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">hw_frontend</span><span class="p">);</span>
		<span class="n">dvb_dmxdev_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">dmxdev</span><span class="p">);</span>
		<span class="n">dvb_dmx_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">);</span>
		<span class="n">dvb_unregister_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">);</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;deinitialized dvb stuff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">init_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FC_STATE_DVB_INIT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* these methods are necessary to achieve the long-term-goal of hiding the</span>
<span class="cm"> * struct flexcop_device from the bus-parts */</span>
<span class="kt">void</span> <span class="nf">flexcop_pass_dmx_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dvb_dmx_swfilter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">flexcop_pass_dmx_data</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">flexcop_pass_dmx_packets</span><span class="p">(</span><span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">no</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dvb_dmx_swfilter_packets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">no</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">flexcop_pass_dmx_packets</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flexcop_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flexcop_ibi_value</span> <span class="n">v210</span><span class="p">,</span> <span class="n">v204</span><span class="p">;</span>

	<span class="cm">/* reset the flexcop itself */</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">write_ibi_reg</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span><span class="n">ctrl_208</span><span class="p">,</span><span class="n">ibi_zero</span><span class="p">);</span>

	<span class="n">v210</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">v210</span><span class="p">.</span><span class="n">sw_reset_210</span><span class="p">.</span><span class="n">reset_block_000</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">v210</span><span class="p">.</span><span class="n">sw_reset_210</span><span class="p">.</span><span class="n">reset_block_100</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">v210</span><span class="p">.</span><span class="n">sw_reset_210</span><span class="p">.</span><span class="n">reset_block_200</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">v210</span><span class="p">.</span><span class="n">sw_reset_210</span><span class="p">.</span><span class="n">reset_block_300</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">v210</span><span class="p">.</span><span class="n">sw_reset_210</span><span class="p">.</span><span class="n">reset_block_400</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">v210</span><span class="p">.</span><span class="n">sw_reset_210</span><span class="p">.</span><span class="n">reset_block_500</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">v210</span><span class="p">.</span><span class="n">sw_reset_210</span><span class="p">.</span><span class="n">reset_block_600</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">v210</span><span class="p">.</span><span class="n">sw_reset_210</span><span class="p">.</span><span class="n">reset_block_700</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">v210</span><span class="p">.</span><span class="n">sw_reset_210</span><span class="p">.</span><span class="n">Block_reset_enable</span> <span class="o">=</span> <span class="mh">0xb2</span><span class="p">;</span>
	<span class="n">v210</span><span class="p">.</span><span class="n">sw_reset_210</span><span class="p">.</span><span class="n">Special_controls</span> <span class="o">=</span> <span class="mh">0xc259</span><span class="p">;</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">write_ibi_reg</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span><span class="n">sw_reset_210</span><span class="p">,</span><span class="n">v210</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* reset the periphical devices */</span>

	<span class="n">v204</span> <span class="o">=</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">read_ibi_reg</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span><span class="n">misc_204</span><span class="p">);</span>
	<span class="n">v204</span><span class="p">.</span><span class="n">misc_204</span><span class="p">.</span><span class="n">Per_reset_sig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">write_ibi_reg</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span><span class="n">misc_204</span><span class="p">,</span><span class="n">v204</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">v204</span><span class="p">.</span><span class="n">misc_204</span><span class="p">.</span><span class="n">Per_reset_sig</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">write_ibi_reg</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span><span class="n">misc_204</span><span class="p">,</span><span class="n">v204</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">flexcop_reset_block_300</span><span class="p">(</span><span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flexcop_ibi_value</span> <span class="n">v208_save</span> <span class="o">=</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">read_ibi_reg</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">ctrl_208</span><span class="p">),</span>
			  <span class="n">v210</span> <span class="o">=</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">read_ibi_reg</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">sw_reset_210</span><span class="p">);</span>

	<span class="n">deb_rdump</span><span class="p">(</span><span class="s">&quot;208: %08x, 210: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">v208_save</span><span class="p">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">v210</span><span class="p">.</span><span class="n">raw</span><span class="p">);</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">write_ibi_reg</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span><span class="n">ctrl_208</span><span class="p">,</span><span class="n">ibi_zero</span><span class="p">);</span>

	<span class="n">v210</span><span class="p">.</span><span class="n">sw_reset_210</span><span class="p">.</span><span class="n">reset_block_300</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">v210</span><span class="p">.</span><span class="n">sw_reset_210</span><span class="p">.</span><span class="n">Block_reset_enable</span> <span class="o">=</span> <span class="mh">0xb2</span><span class="p">;</span>

	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">write_ibi_reg</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span><span class="n">sw_reset_210</span><span class="p">,</span><span class="n">v210</span><span class="p">);</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">write_ibi_reg</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span><span class="n">ctrl_208</span><span class="p">,</span><span class="n">v208_save</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="nf">flexcop_device_kmalloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">bus_specific_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">flexcop_device</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;no memory&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bus</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">bus_specific_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;no memory&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">bus_specific</span> <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">flexcop_device_kmalloc</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">flexcop_device_kfree</span><span class="p">(</span><span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">bus_specific</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">flexcop_device_kfree</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">flexcop_device_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ibi_zero</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">flexcop_reset</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
	<span class="n">flexcop_determine_revision</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
	<span class="n">flexcop_sram_init</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
	<span class="n">flexcop_hw_filter_init</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
	<span class="n">flexcop_smc_ctrl</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">flexcop_dvb_init</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* i2c has to be done before doing EEProm stuff -</span>
<span class="cm">	 * because the EEProm is accessed via i2c */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">flexcop_i2c_init</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* do the MAC address reading after initializing the dvb_adapter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">get_mac_addr</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">.</span><span class="n">proposed_mac</span><span class="p">;</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;MAC address = %pM&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
		<span class="n">flexcop_set_mac_filter</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>
		<span class="n">flexcop_mac_filter_ctrl</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">warn</span><span class="p">(</span><span class="s">&quot;reading of MAC address failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">flexcop_frontend_init</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">flexcop_device_name</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span><span class="s">&quot;initialization of&quot;</span><span class="p">,</span><span class="s">&quot;complete&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">flexcop_device_exit</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">flexcop_device_initialize</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">flexcop_device_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flexcop_frontend_exit</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
	<span class="n">flexcop_i2c_exit</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
	<span class="n">flexcop_dvb_exit</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">flexcop_device_exit</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">flexcop_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot; loaded successfully&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flexcop_module_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot; unloaded successfully&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">flexcop_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">flexcop_module_cleanup</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
