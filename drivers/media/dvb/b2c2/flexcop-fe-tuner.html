<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › b2c2 › flexcop-fe-tuner.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>flexcop-fe-tuner.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Linux driver for digital TV devices equipped with B2C2 FlexcopII(b)/III</span>
<span class="cm"> * flexcop-fe-tuner.c - methods for frontend attachment and DiSEqC controlling</span>
<span class="cm"> * see flexcop.c for copyright information</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;media/tuner.h&gt;</span>
<span class="cp">#include &quot;flexcop.h&quot;</span>
<span class="cp">#include &quot;mt312.h&quot;</span>
<span class="cp">#include &quot;stv0299.h&quot;</span>
<span class="cp">#include &quot;s5h1420.h&quot;</span>
<span class="cp">#include &quot;itd1000.h&quot;</span>
<span class="cp">#include &quot;cx24113.h&quot;</span>
<span class="cp">#include &quot;cx24123.h&quot;</span>
<span class="cp">#include &quot;isl6421.h&quot;</span>
<span class="cp">#include &quot;mt352.h&quot;</span>
<span class="cp">#include &quot;bcm3510.h&quot;</span>
<span class="cp">#include &quot;nxt200x.h&quot;</span>
<span class="cp">#include &quot;dvb-pll.h&quot;</span>
<span class="cp">#include &quot;lgdt330x.h&quot;</span>
<span class="cp">#include &quot;tuner-simple.h&quot;</span>
<span class="cp">#include &quot;stv0297.h&quot;</span>


<span class="cm">/* Can we use the specified front-end?  Remember that if we are compiled</span>
<span class="cm"> * into the kernel we can&#39;t call code that&#39;s in modules.  */</span>
<span class="cp">#define FE_SUPPORTED(fe) (defined(CONFIG_DVB_##fe) || \</span>
<span class="cp">	(defined(CONFIG_DVB_##fe##_MODULE) &amp;&amp; defined(MODULE)))</span>

<span class="cm">/* lnb control */</span>
<span class="cp">#if FE_SUPPORTED(MT312) || FE_SUPPORTED(STV0299)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">flexcop_set_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_sec_voltage_t</span> <span class="n">voltage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">flexcop_ibi_value</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">deb_tuner</span><span class="p">(</span><span class="s">&quot;polarity/voltage = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">voltage</span><span class="p">);</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">read_ibi_reg</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">misc_204</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">voltage</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEC_VOLTAGE_OFF</span>:
		<span class="n">v</span><span class="p">.</span><span class="n">misc_204</span><span class="p">.</span><span class="n">ACPI1_sig</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_VOLTAGE_13</span>:
		<span class="n">v</span><span class="p">.</span><span class="n">misc_204</span><span class="p">.</span><span class="n">ACPI1_sig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">v</span><span class="p">.</span><span class="n">misc_204</span><span class="p">.</span><span class="n">LNB_L_H_sig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_VOLTAGE_18</span>:
		<span class="n">v</span><span class="p">.</span><span class="n">misc_204</span><span class="p">.</span><span class="n">ACPI1_sig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">v</span><span class="p">.</span><span class="n">misc_204</span><span class="p">.</span><span class="n">LNB_L_H_sig</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;unknown SEC_VOLTAGE value&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">write_ibi_reg</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">misc_204</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#if FE_SUPPORTED(S5H1420) || FE_SUPPORTED(STV0299) || FE_SUPPORTED(MT312)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">flexcop_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe_sleep</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe_sleep</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* SkyStar2 DVB-S rev 2.3 */</span>
<span class="cp">#if FE_SUPPORTED(MT312) &amp;&amp; FE_SUPPORTED(PLL)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">flexcop_set_tone</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">fe_sec_tone_mode_t</span> <span class="n">tone</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* u16 wz_half_period_for_45_mhz[] = { 0x01ff, 0x0154, 0x00ff, 0x00cc }; */</span>
	<span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">flexcop_ibi_value</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ax</span><span class="p">;</span>
	<span class="n">v</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">deb_tuner</span><span class="p">(</span><span class="s">&quot;tone = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">tone</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tone</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEC_TONE_ON</span>:
		<span class="n">ax</span> <span class="o">=</span> <span class="mh">0x01ff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_TONE_OFF</span>:
		<span class="n">ax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;unknown SEC_TONE value&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v</span><span class="p">.</span><span class="n">lnb_switch_freq_200</span><span class="p">.</span><span class="n">LNB_CTLPrescaler_sig</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* divide by 2 */</span>
	<span class="n">v</span><span class="p">.</span><span class="n">lnb_switch_freq_200</span><span class="p">.</span><span class="n">LNB_CTLHighCount_sig</span> <span class="o">=</span> <span class="n">ax</span><span class="p">;</span>
	<span class="n">v</span><span class="p">.</span><span class="n">lnb_switch_freq_200</span><span class="p">.</span><span class="n">LNB_CTLLowCount_sig</span>  <span class="o">=</span> <span class="n">ax</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mh">0x1ff</span> <span class="o">:</span> <span class="n">ax</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">write_ibi_reg</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span><span class="n">lnb_switch_freq_200</span><span class="p">,</span><span class="n">v</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flexcop_diseqc_send_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flexcop_set_tone</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SEC_TONE_ON</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">data</span> <span class="o">?</span> <span class="mi">500</span> <span class="o">:</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">flexcop_set_tone</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SEC_TONE_OFF</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">data</span> <span class="o">?</span> <span class="mi">1000</span> <span class="o">:</span> <span class="mi">500</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flexcop_diseqc_send_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span><span class="o">*</span> <span class="n">fe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">par</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">par</span> <span class="o">^=</span> <span class="n">d</span><span class="p">;</span>
		<span class="n">flexcop_diseqc_send_bit</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">flexcop_diseqc_send_bit</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">flexcop_send_diseqc_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">burst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">flexcop_set_tone</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SEC_TONE_OFF</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">flexcop_diseqc_send_byte</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">burst</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">burst</span><span class="p">)</span>
			<span class="n">flexcop_diseqc_send_byte</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">flexcop_set_tone</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SEC_TONE_ON</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
			<span class="n">flexcop_set_tone</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">SEC_TONE_OFF</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">flexcop_diseqc_send_master_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">dvb_diseqc_master_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">flexcop_send_diseqc_msg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">flexcop_diseqc_send_burst</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="n">fe_sec_mini_cmd_t</span> <span class="n">minicmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">flexcop_send_diseqc_msg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">minicmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mt312_config</span> <span class="n">skystar23_samsung_tbdu18132_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x0e</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">skystar2_rev23_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_frontend_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>

	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">mt312_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skystar23_samsung_tbdu18132_config</span><span class="p">,</span> <span class="n">i2c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">dvb_pll_attach</span><span class="p">,</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="n">i2c</span><span class="p">,</span>
			<span class="n">DVB_PLL_SAMSUNG_TBDU18132</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">diseqc_send_master_cmd</span> <span class="o">=</span> <span class="n">flexcop_diseqc_send_master_cmd</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">diseqc_send_burst</span>      <span class="o">=</span> <span class="n">flexcop_diseqc_send_burst</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_tone</span>               <span class="o">=</span> <span class="n">flexcop_set_tone</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_voltage</span>            <span class="o">=</span> <span class="n">flexcop_set_voltage</span><span class="p">;</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe_sleep</span>                <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">sleep</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">sleep</span>                  <span class="o">=</span> <span class="n">flexcop_sleep</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define skystar2_rev23_attach NULL</span>
<span class="cp">#endif</span>

<span class="cm">/* SkyStar2 DVB-S rev 2.6 */</span>
<span class="cp">#if FE_SUPPORTED(STV0299) &amp;&amp; FE_SUPPORTED(PLL)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">samsung_tbmu24112_set_symbol_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">srate</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ratio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">aclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">1500000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aclk</span> <span class="o">=</span> <span class="mh">0xb7</span><span class="p">;</span> <span class="n">bclk</span> <span class="o">=</span> <span class="mh">0x47</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">3000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aclk</span> <span class="o">=</span> <span class="mh">0xb7</span><span class="p">;</span> <span class="n">bclk</span> <span class="o">=</span> <span class="mh">0x4b</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">7000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aclk</span> <span class="o">=</span> <span class="mh">0xb7</span><span class="p">;</span> <span class="n">bclk</span> <span class="o">=</span> <span class="mh">0x4f</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">14000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aclk</span> <span class="o">=</span> <span class="mh">0xb7</span><span class="p">;</span> <span class="n">bclk</span> <span class="o">=</span> <span class="mh">0x53</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">30000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aclk</span> <span class="o">=</span> <span class="mh">0xb6</span><span class="p">;</span> <span class="n">bclk</span> <span class="o">=</span> <span class="mh">0x53</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srate</span> <span class="o">&lt;</span> <span class="mi">45000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aclk</span> <span class="o">=</span> <span class="mh">0xb4</span><span class="p">;</span> <span class="n">bclk</span> <span class="o">=</span> <span class="mh">0x51</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="n">aclk</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">bclk</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">stv0299_writereg</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span>  <span class="n">ratio</span>        <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">samsung_tbmu24112_inittab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span>
	<span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span>
	<span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xC3</span><span class="p">,</span>
	<span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span>
	<span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span>
	<span class="mh">0x0F</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span>
	<span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x7E</span><span class="p">,</span>
	<span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span>
	<span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span>
	<span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span>
	<span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span>
	<span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xC9</span><span class="p">,</span>
	<span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span>
	<span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x1A</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x1C</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x1F</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span>
	<span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x2E</span><span class="p">,</span>
	<span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="mh">0x22</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
	<span class="mh">0x23</span><span class="p">,</span> <span class="mh">0xC1</span><span class="p">,</span>
	<span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span>
	<span class="mh">0x2A</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span>
	<span class="mh">0x2B</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span>
	<span class="mh">0x2C</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span>
	<span class="mh">0x2D</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span>
	<span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">,</span>
	<span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span>
	<span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">,</span>
	<span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stv0299_config</span> <span class="n">samsung_tbmu24112_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span>
	<span class="p">.</span><span class="n">inittab</span> <span class="o">=</span> <span class="n">samsung_tbmu24112_inittab</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mclk</span> <span class="o">=</span> <span class="mi">88000000UL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">skip_reinit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lock_output</span> <span class="o">=</span> <span class="n">STV0299_LOCKOUTPUT_LK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">volt13_op0_op1</span> <span class="o">=</span> <span class="n">STV0299_VOLT13_OP1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_symbol_rate</span> <span class="o">=</span> <span class="n">samsung_tbmu24112_set_symbol_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">skystar2_rev26_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">stv0299_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">samsung_tbmu24112_config</span><span class="p">,</span> <span class="n">i2c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">dvb_pll_attach</span><span class="p">,</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="n">i2c</span><span class="p">,</span>
			<span class="n">DVB_PLL_SAMSUNG_TBMU24112</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_voltage</span> <span class="o">=</span> <span class="n">flexcop_set_voltage</span><span class="p">;</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe_sleep</span> <span class="o">=</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">sleep</span><span class="p">;</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">flexcop_sleep</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define skystar2_rev26_attach NULL</span>
<span class="cp">#endif</span>

<span class="cm">/* SkyStar2 DVB-S rev 2.7 */</span>
<span class="cp">#if FE_SUPPORTED(S5H1420) &amp;&amp; FE_SUPPORTED(ISL6421) &amp;&amp; FE_SUPPORTED(TUNER_ITD1000)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">s5h1420_config</span> <span class="n">skystar2_rev2_7_s5h1420_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x53</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">repeated_start_workaround</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">serial_mpeg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">itd1000_config</span> <span class="n">skystar2_rev2_7_itd1000_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">i2c_address</span> <span class="o">=</span> <span class="mh">0x61</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">skystar2_rev27_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flexcop_ibi_value</span> <span class="n">r108</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_tuner</span><span class="p">;</span>

	<span class="cm">/* enable no_base_addr - no repeated start when reading */</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fc_i2c_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">no_base_addr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">s5h1420_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skystar2_rev2_7_s5h1420_config</span><span class="p">,</span>
			    <span class="n">i2c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">i2c_tuner</span> <span class="o">=</span> <span class="n">s5h1420_get_tuner_i2c_adapter</span><span class="p">(</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_tuner</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe_sleep</span> <span class="o">=</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">sleep</span><span class="p">;</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">flexcop_sleep</span><span class="p">;</span>

	<span class="cm">/* enable no_base_addr - no repeated start when reading */</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fc_i2c_adap</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">no_base_addr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">isl6421_attach</span><span class="p">,</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fc_i2c_adap</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">i2c_adap</span><span class="p">,</span>
			<span class="mh">0x08</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;ISL6421 could NOT be attached&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_isl</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="p">(</span><span class="s">&quot;ISL6421 successfully attached&quot;</span><span class="p">);</span>

	<span class="cm">/* the ITD1000 requires a lower i2c clock - is it a problem ? */</span>
	<span class="n">r108</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="mh">0x00000506</span><span class="p">;</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">write_ibi_reg</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">tw_sm_c_108</span><span class="p">,</span> <span class="n">r108</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">itd1000_attach</span><span class="p">,</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="n">i2c_tuner</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">skystar2_rev2_7_itd1000_config</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;ITD1000 could NOT be attached&quot;</span><span class="p">);</span>
		<span class="cm">/* Should i2c clock be restored? */</span>
		<span class="k">goto</span> <span class="n">fail_isl</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="p">(</span><span class="s">&quot;ITD1000 successfully attached&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">fail_isl:</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fc_i2c_adap</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">no_base_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="cm">/* for the next devices we need it again */</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fc_i2c_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">no_base_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define skystar2_rev27_attach NULL</span>
<span class="cp">#endif</span>

<span class="cm">/* SkyStar2 rev 2.8 */</span>
<span class="cp">#if FE_SUPPORTED(CX24123) &amp;&amp; FE_SUPPORTED(ISL6421) &amp;&amp; FE_SUPPORTED(TUNER_CX24113)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cx24123_config</span> <span class="n">skystar2_rev2_8_cx24123_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dont_use_pll</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc_callback</span> <span class="o">=</span> <span class="n">cx24113_agc_callback</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cx24113_config</span> <span class="n">skystar2_rev2_8_cx24113_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="mh">0x54</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xtal_khz</span> <span class="o">=</span> <span class="mi">10111</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">skystar2_rev28_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_tuner</span><span class="p">;</span>

	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">cx24123_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skystar2_rev2_8_cx24123_config</span><span class="p">,</span>
			    <span class="n">i2c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">i2c_tuner</span> <span class="o">=</span> <span class="n">cx24123_get_tuner_i2c_adapter</span><span class="p">(</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_tuner</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">cx24113_attach</span><span class="p">,</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skystar2_rev2_8_cx24113_config</span><span class="p">,</span>
			<span class="n">i2c_tuner</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;CX24113 could NOT be attached&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="p">(</span><span class="s">&quot;CX24113 successfully attached&quot;</span><span class="p">);</span>

	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fc_i2c_adap</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">no_base_addr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">isl6421_attach</span><span class="p">,</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fc_i2c_adap</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">i2c_adap</span><span class="p">,</span>
			<span class="mh">0x08</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;ISL6421 could NOT be attached&quot;</span><span class="p">);</span>
		<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fc_i2c_adap</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">no_base_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="p">(</span><span class="s">&quot;ISL6421 successfully attached&quot;</span><span class="p">);</span>
	<span class="cm">/* TODO on i2c_adap[1] addr 0x11 (EEPROM) there seems to be an</span>
<span class="cm">	 * IR-receiver (PIC16F818) - but the card has no input for that ??? */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define skystar2_rev28_attach NULL</span>
<span class="cp">#endif</span>

<span class="cm">/* AirStar DVB-T */</span>
<span class="cp">#if FE_SUPPORTED(MT352) &amp;&amp; FE_SUPPORTED(PLL)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">samsung_tdtc9251dh0_demod_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_clock_config</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x2d</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_reset</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x80</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_adc_ctl_1_cfg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x8E</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_agc_cfg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0xa1</span> <span class="p">};</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">mt352_capt_range_cfg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x32</span> <span class="p">};</span>

	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_clock_config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_clock_config</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_reset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_reset</span><span class="p">));</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_adc_ctl_1_cfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_adc_ctl_1_cfg</span><span class="p">));</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_agc_cfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_agc_cfg</span><span class="p">));</span>
	<span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">mt352_capt_range_cfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mt352_capt_range_cfg</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mt352_config</span> <span class="n">samsung_tdtc9251dh0_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">,</span>
	<span class="p">.</span><span class="n">demod_init</span>    <span class="o">=</span> <span class="n">samsung_tdtc9251dh0_demod_init</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">airstar_dvbt_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">mt352_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">samsung_tdtc9251dh0_config</span><span class="p">,</span> <span class="n">i2c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">!!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">dvb_pll_attach</span><span class="p">,</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="n">DVB_PLL_SAMSUNG_TDTC9251DH0</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define airstar_dvbt_attach NULL</span>
<span class="cp">#endif</span>

<span class="cm">/* AirStar ATSC 1st generation */</span>
<span class="cp">#if FE_SUPPORTED(BCM3510)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">flexcop_fe_request_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">**</span><span class="n">fw</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">request_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bcm3510_config</span> <span class="n">air2pc_atsc_first_gen_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span>    <span class="o">=</span> <span class="mh">0x0f</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_firmware</span> <span class="o">=</span> <span class="n">flexcop_fe_request_firmware</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">airstar_atsc1_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">bcm3510_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">air2pc_atsc_first_gen_config</span><span class="p">,</span> <span class="n">i2c</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define airstar_atsc1_attach NULL</span>
<span class="cp">#endif</span>

<span class="cm">/* AirStar ATSC 2nd generation */</span>
<span class="cp">#if FE_SUPPORTED(NXT200X) &amp;&amp; FE_SUPPORTED(PLL)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nxt200x_config</span> <span class="n">samsung_tbmv_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x0a</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">airstar_atsc2_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">nxt200x_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">samsung_tbmv_config</span><span class="p">,</span> <span class="n">i2c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">!!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">dvb_pll_attach</span><span class="p">,</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="n">DVB_PLL_SAMSUNG_TBMV</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define airstar_atsc2_attach NULL</span>
<span class="cp">#endif</span>

<span class="cm">/* AirStar ATSC 3rd generation */</span>
<span class="cp">#if FE_SUPPORTED(LGDT330X)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">lgdt330x_config</span> <span class="n">air2pc_atsc_hd5000_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span>       <span class="o">=</span> <span class="mh">0x59</span><span class="p">,</span>
	<span class="p">.</span><span class="n">demod_chip</span>          <span class="o">=</span> <span class="n">LGDT3303</span><span class="p">,</span>
	<span class="p">.</span><span class="n">serial_mpeg</span>         <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clock_polarity_flip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">airstar_atsc3_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">lgdt330x_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">air2pc_atsc_hd5000_config</span><span class="p">,</span> <span class="n">i2c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">!!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">simple_tuner_attach</span><span class="p">,</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="n">i2c</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span>
			    <span class="n">TUNER_LG_TDVS_H06XF</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define airstar_atsc3_attach NULL</span>
<span class="cp">#endif</span>

<span class="cm">/* CableStar2 DVB-C */</span>
<span class="cp">#if FE_SUPPORTED(STV0297) &amp;&amp; FE_SUPPORTED(PLL)</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">alps_tdee4_stv0297_inittab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span>
	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span>
	<span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span>
	<span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span>
	<span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span>
	<span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span>
	<span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span>
	<span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span>
	<span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span>
	<span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x44</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span>
	<span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span>
	<span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span>
	<span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span>
	<span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span>
	<span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span>
	<span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span>
	<span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span>
	<span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span>
	<span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span>
	<span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span>
	<span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span>
	<span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span>
	<span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span>
	<span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span>
	<span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stv0297_config</span> <span class="n">alps_tdee4_stv0297_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>
	<span class="p">.</span><span class="n">inittab</span> <span class="o">=</span> <span class="n">alps_tdee4_stv0297_inittab</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cablestar2_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fc_i2c_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">no_base_addr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">stv0297_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alps_tdee4_stv0297_config</span><span class="p">,</span> <span class="n">i2c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/* This tuner doesn&#39;t use the stv0297&#39;s I2C gate, but instead the</span>
<span class="cm">	 * tuner is connected to a different flexcop I2C adapter.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">)</span>
		<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span><span class="p">(</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">i2c_gate_ctrl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">dvb_pll_attach</span><span class="p">,</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fc_i2c_adap</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">DVB_PLL_TDEE4</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="cm">/* Reset for next frontend to try */</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fc_i2c_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">no_base_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define cablestar2_attach NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">flexcop_device_type_t</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">attach</span><span class="p">)(</span><span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="p">);</span>
<span class="p">}</span> <span class="n">flexcop_frontends</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">FC_SKY_REV27</span><span class="p">,</span> <span class="n">skystar2_rev27_attach</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">FC_SKY_REV28</span><span class="p">,</span> <span class="n">skystar2_rev28_attach</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">FC_SKY_REV26</span><span class="p">,</span> <span class="n">skystar2_rev26_attach</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">FC_AIR_DVBT</span><span class="p">,</span> <span class="n">airstar_dvbt_attach</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">FC_AIR_ATSC2</span><span class="p">,</span> <span class="n">airstar_atsc2_attach</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">FC_AIR_ATSC3</span><span class="p">,</span> <span class="n">airstar_atsc3_attach</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">FC_AIR_ATSC1</span><span class="p">,</span> <span class="n">airstar_atsc1_attach</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">FC_CABLE</span><span class="p">,</span> <span class="n">cablestar2_attach</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">FC_SKY_REV23</span><span class="p">,</span> <span class="n">skystar2_rev23_attach</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* try to figure out the frontend */</span>
<span class="kt">int</span> <span class="nf">flexcop_frontend_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">flexcop_frontends</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flexcop_frontends</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attach</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* type needs to be set before, because of some workarounds</span>
<span class="cm">		 * done based on the probed card type */</span>
		<span class="n">fc</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">=</span> <span class="n">flexcop_frontends</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flexcop_frontends</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attach</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fc_i2c_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">i2c_adap</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fe_found</span><span class="p">;</span>
		<span class="cm">/* Clean up partially attached frontend */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
			<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">=</span> <span class="n">FC_UNK</span><span class="p">;</span>
	<span class="n">err</span><span class="p">(</span><span class="s">&quot;no frontend driver found for this B2C2/FlexCop adapter&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="nl">fe_found:</span>
	<span class="n">info</span><span class="p">(</span><span class="s">&quot;found &#39;%s&#39; .&quot;</span><span class="p">,</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dvb_register_frontend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">dvb_adapter</span><span class="p">,</span> <span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;frontend registration failed!&quot;</span><span class="p">);</span>
		<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
		<span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">init_state</span> <span class="o">|=</span> <span class="n">FC_STATE_FE_INIT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">flexcop_frontend_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">flexcop_device</span> <span class="o">*</span><span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">init_state</span> <span class="o">&amp;</span> <span class="n">FC_STATE_FE_INIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dvb_unregister_frontend</span><span class="p">(</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
		<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">fc</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fc</span><span class="o">-&gt;</span><span class="n">init_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FC_STATE_FE_INIT</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
