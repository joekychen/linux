<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › dvb-usb › pctv452e.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>pctv452e.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * PCTV 452e DVB driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2006-2008 Dominik Kuhlen &lt;dkuhlen@gmx.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * TT connect S2-3650-CI Common Interface support, MAC readout</span>
<span class="cm"> * Copyright (C) 2008 Michael H. Schimek &lt;mschimek@gmx.at&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation; either version 2 of</span>
<span class="cm"> * the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cm">/* dvb usb framework */</span>
<span class="cp">#define DVB_USB_LOG_PREFIX &quot;pctv452e&quot;</span>
<span class="cp">#include &quot;dvb-usb.h&quot;</span>

<span class="cm">/* Demodulator */</span>
<span class="cp">#include &quot;stb0899_drv.h&quot;</span>
<span class="cp">#include &quot;stb0899_reg.h&quot;</span>
<span class="cp">#include &quot;stb0899_cfg.h&quot;</span>
<span class="cm">/* Tuner */</span>
<span class="cp">#include &quot;stb6100.h&quot;</span>
<span class="cp">#include &quot;stb6100_cfg.h&quot;</span>
<span class="cm">/* FE Power */</span>
<span class="cp">#include &quot;lnbp22.h&quot;</span>

<span class="cp">#include &quot;dvb_ca_en50221.h&quot;</span>
<span class="cp">#include &quot;ttpci-eeprom.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Turn on/off debugging (default:off).&quot;</span><span class="p">);</span>

<span class="n">DVB_DEFINE_MOD_OPT_ADAPTER_NR</span><span class="p">(</span><span class="n">adapter_nr</span><span class="p">);</span>

<span class="cp">#define ISOC_INTERFACE_ALTERNATIVE 3</span>

<span class="cp">#define SYNC_BYTE_OUT 0xaa</span>
<span class="cp">#define SYNC_BYTE_IN  0x55</span>

<span class="cm">/* guessed: (copied from ttusb-budget) */</span>
<span class="cp">#define PCTV_CMD_RESET 0x15</span>
<span class="cm">/* command to poll IR receiver */</span>
<span class="cp">#define PCTV_CMD_IR    0x1b</span>
<span class="cm">/* command to send I2C  */</span>
<span class="cp">#define PCTV_CMD_I2C   0x31</span>

<span class="cp">#define I2C_ADDR_STB0899 (0xd0 &gt;&gt; 1)</span>
<span class="cp">#define I2C_ADDR_STB6100 (0xc0 &gt;&gt; 1)</span>
<span class="cp">#define I2C_ADDR_LNBP22  (0x10 &gt;&gt; 1)</span>
<span class="cp">#define I2C_ADDR_24C16   (0xa0 &gt;&gt; 1)</span>
<span class="cp">#define I2C_ADDR_24C64   (0xa2 &gt;&gt; 1)</span>


<span class="cm">/* pctv452e sends us this amount of data for each issued usb-command */</span>
<span class="cp">#define PCTV_ANSWER_LEN 64</span>
<span class="cm">/* Wait up to 1000ms for device  */</span>
<span class="cp">#define PCTV_TIMEOUT 1000</span>


<span class="cp">#define PCTV_LED_GPIO   STB0899_GPIO01</span>
<span class="cp">#define PCTV_LED_GREEN  0x82</span>
<span class="cp">#define PCTV_LED_ORANGE 0x02</span>

<span class="cp">#define ci_dbg(format, arg...)				\</span>
<span class="cp">do {							\</span>
<span class="cp">	if (0)						\</span>
<span class="cp">		printk(KERN_DEBUG DVB_USB_LOG_PREFIX	\</span>
<span class="cp">			&quot;: &quot; format &quot;\n&quot; , ## arg);	\</span>
<span class="cp">} while (0)</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">TT3650_CMD_CI_TEST</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">TT3650_CMD_CI_RD_CTRL</span><span class="p">,</span>
	<span class="n">TT3650_CMD_CI_WR_CTRL</span><span class="p">,</span>
	<span class="n">TT3650_CMD_CI_RD_ATTR</span><span class="p">,</span>
	<span class="n">TT3650_CMD_CI_WR_ATTR</span><span class="p">,</span>
	<span class="n">TT3650_CMD_CI_RESET</span><span class="p">,</span>
	<span class="n">TT3650_CMD_CI_SET_VIDEO_PORT</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">stb0899_postproc</span> <span class="n">pctv45e_postproc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCTV_LED_GPIO</span><span class="p">,</span> <span class="n">STB0899_GPIOPULLUP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * stores all private variables for communication with the PCTV452e DVB-S2</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pctv452e_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="n">ca</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">ca_mutex</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">c</span><span class="p">;</span>	   <span class="cm">/* transaction counter, wraps around...  */</span>
	<span class="n">u8</span> <span class="n">initialized</span><span class="p">;</span> <span class="cm">/* set to 1 if 0x15 has been sent */</span>
	<span class="n">u16</span> <span class="n">last_rc_key</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tt3650_ci_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">write_len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">read_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pctv452e_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pctv452e_state</span> <span class="o">*</span><span class="p">)</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">write_len</span> <span class="o">|</span> <span class="n">read_len</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">write_len</span> <span class="o">&gt;</span> <span class="mi">64</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">read_len</span> <span class="o">&gt;</span> <span class="mi">64</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">c</span><span class="o">++</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SYNC_BYTE_OUT</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">write_len</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">write_len</span><span class="p">);</span>

	<span class="n">rlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">64</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_usb_generic_rw</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">write_len</span><span class="p">,</span>
				  <span class="n">buf</span><span class="p">,</span> <span class="n">rlen</span><span class="p">,</span> <span class="cm">/* delay_ms */</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SYNC_BYTE_IN</span> <span class="o">!=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">id</span> <span class="o">!=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">read_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="n">err</span><span class="p">(</span><span class="s">&quot;CI error %d; %02X %02X %02X -&gt; %02X %02X %02X.&quot;</span><span class="p">,</span>
	     <span class="n">ret</span><span class="p">,</span> <span class="n">SYNC_BYTE_OUT</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tt3650_ci_msg_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">write_len</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">read_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="p">)</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pctv452e_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pctv452e_state</span> <span class="o">*</span><span class="p">)</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ca_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">tt3650_ci_msg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">write_len</span><span class="p">,</span> <span class="n">read_len</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ca_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tt3650_ci_read_attribute_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">slot</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tt3650_ci_msg_locked</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">TT3650_CMD_CI_RD_ATTR</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">ci_dbg</span><span class="p">(</span><span class="s">&quot;%s %04x -&gt; %d 0x%02x&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tt3650_ci_write_attribute_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">address</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="n">ci_dbg</span><span class="p">(</span><span class="s">&quot;%s %d 0x%04x 0x%02x&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">slot</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tt3650_ci_msg_locked</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">TT3650_CMD_CI_WR_ATTR</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tt3650_ci_read_cam_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span>
				 <span class="kt">int</span>			<span class="n">slot</span><span class="p">,</span>
				 <span class="n">u8</span>			<span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">slot</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">address</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tt3650_ci_msg_locked</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">TT3650_CMD_CI_RD_CTRL</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">ci_dbg</span><span class="p">(</span><span class="s">&quot;%s 0x%02x -&gt; %d 0x%02x&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tt3650_ci_write_cam_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span>
				 <span class="kt">int</span>			<span class="n">slot</span><span class="p">,</span>
				 <span class="n">u8</span>			<span class="n">address</span><span class="p">,</span>
				 <span class="n">u8</span>			<span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">ci_dbg</span><span class="p">(</span><span class="s">&quot;%s %d 0x%02x 0x%02x&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">slot</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tt3650_ci_msg_locked</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">TT3650_CMD_CI_WR_CTRL</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tt3650_ci_set_video_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span>
				 <span class="kt">int</span>			<span class="n">slot</span><span class="p">,</span>
				 <span class="kt">int</span>			<span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ci_dbg</span><span class="p">(</span><span class="s">&quot;%s %d %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">slot</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">enable</span> <span class="o">=</span> <span class="o">!!</span><span class="n">enable</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tt3650_ci_msg_locked</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">TT3650_CMD_CI_SET_VIDEO_PORT</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">!=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;CI not %sabled.&quot;</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="s">&quot;en&quot;</span> <span class="o">:</span> <span class="s">&quot;dis&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tt3650_ci_slot_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tt3650_ci_set_video_port</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="cm">/* enable */</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tt3650_ci_slot_ts_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tt3650_ci_set_video_port</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="cm">/* enable */</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tt3650_ci_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="p">)</span><span class="n">ca</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pctv452e_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pctv452e_state</span> <span class="o">*</span><span class="p">)</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ci_dbg</span><span class="p">(</span><span class="s">&quot;%s %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">slot</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ca_mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tt3650_ci_msg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">TT3650_CMD_CI_RESET</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tt3650_ci_msg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">TT3650_CMD_CI_RESET</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* FTA */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tt3650_ci_msg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">TT3650_CMD_CI_SET_VIDEO_PORT</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

 <span class="nl">failed:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ca_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tt3650_ci_poll_slot_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_ca_en50221</span> <span class="o">*</span><span class="n">ca</span><span class="p">,</span>
				 <span class="kt">int</span>			<span class="n">slot</span><span class="p">,</span>
				 <span class="kt">int</span>			<span class="n">open</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">slot</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tt3650_ci_msg_locked</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">TT3650_CMD_CI_TEST</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">DVB_CA_EN50221_POLL_CAM_PRESENT</span> <span class="o">|</span>
			<span class="n">DVB_CA_EN50221_POLL_CAM_READY</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tt3650_ci_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pctv452e_state</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>

	<span class="n">ci_dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">d</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pctv452e_state</span> <span class="o">*</span><span class="p">)</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">state</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Error ignored. */</span>
	<span class="n">tt3650_ci_set_video_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="cm">/* slot */</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* enable */</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dvb_ca_en50221_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tt3650_ci_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pctv452e_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pctv452e_state</span> <span class="o">*</span><span class="p">)</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ci_dbg</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ca_mutex</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">read_attribute_mem</span> <span class="o">=</span> <span class="n">tt3650_ci_read_attribute_mem</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">write_attribute_mem</span> <span class="o">=</span> <span class="n">tt3650_ci_write_attribute_mem</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">read_cam_control</span> <span class="o">=</span> <span class="n">tt3650_ci_read_cam_control</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">write_cam_control</span> <span class="o">=</span> <span class="n">tt3650_ci_write_cam_control</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">slot_reset</span> <span class="o">=</span> <span class="n">tt3650_ci_slot_reset</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">slot_shutdown</span> <span class="o">=</span> <span class="n">tt3650_ci_slot_shutdown</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">slot_ts_enable</span> <span class="o">=</span> <span class="n">tt3650_ci_slot_ts_enable</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">poll_slot_status</span> <span class="o">=</span> <span class="n">tt3650_ci_poll_slot_status</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_ca_en50221_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">dvb_adap</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span>
				   <span class="cm">/* flags */</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="cm">/* n_slots */</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;Cannot initialize CI: Error %d.&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="p">(</span><span class="s">&quot;CI initialized.&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CMD_BUFFER_SIZE 0x28</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pctv452e_i2c_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span>
				<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">snd_buf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">snd_len</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">rcv_buf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rcv_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pctv452e_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pctv452e_state</span> <span class="o">*</span><span class="p">)</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">c</span><span class="o">++</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_len</span> <span class="o">&gt;</span> <span class="mi">64</span> <span class="o">-</span> <span class="mi">7</span> <span class="o">||</span> <span class="n">rcv_len</span> <span class="o">&gt;</span> <span class="mi">64</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SYNC_BYTE_OUT</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">PCTV_CMD_I2C</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_len</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcv_len</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="n">snd_buf</span><span class="p">,</span> <span class="n">snd_len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_usb_generic_rw</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">snd_len</span><span class="p">,</span>
				  <span class="n">buf</span><span class="p">,</span> <span class="cm">/* rcv_len */</span> <span class="mi">64</span><span class="p">,</span>
				  <span class="cm">/* delay_ms */</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="cm">/* TT USB protocol error. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SYNC_BYTE_IN</span> <span class="o">!=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">id</span> <span class="o">!=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="cm">/* I2C device didn&#39;t respond as expected. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">snd_len</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">rcv_len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">rcv_buf</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="n">rcv_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rcv_len</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="n">err</span><span class="p">(</span><span class="s">&quot;I2C error %d; %02X %02X  %02X %02X %02X -&gt; &quot;</span>
	     <span class="s">&quot;%02X %02X  %02X %02X %02X.&quot;</span><span class="p">,</span>
	     <span class="n">ret</span><span class="p">,</span> <span class="n">SYNC_BYTE_OUT</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">snd_len</span><span class="p">,</span> <span class="n">rcv_len</span><span class="p">,</span>
	     <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pctv452e_i2c_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">snd_len</span><span class="p">,</span> <span class="n">rcv_len</span><span class="p">,</span> <span class="o">*</span><span class="n">snd_buf</span><span class="p">,</span> <span class="o">*</span><span class="n">rcv_buf</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">snd_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">snd_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rcv_buf</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">;</span>
			<span class="n">rcv_len</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">snd_buf</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">;</span>
			<span class="n">snd_len</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
			<span class="n">rcv_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">rcv_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">pctv452e_i2c_msg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">snd_buf</span><span class="p">,</span> <span class="n">snd_len</span><span class="p">,</span> <span class="n">rcv_buf</span><span class="p">,</span>
					<span class="n">rcv_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="n">rcv_len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">pctv452e_i2c_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">I2C_FUNC_I2C</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pctv452e_power_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pctv452e_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pctv452e_state</span> <span class="o">*</span><span class="p">)</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">b0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCTV_CMD_RESET</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">rx</span><span class="p">[</span><span class="n">PCTV_ANSWER_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">info</span><span class="p">(</span><span class="s">&quot;%s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* hmm where shoud this should go? */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ISOC_INTERFACE_ALTERNATIVE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;%s: Warning set interface returned: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* this is a one-time initialization, dont know where to put */</span>
	<span class="n">b0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">c</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* reset board */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_usb_generic_rw</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">b0</span><span class="p">),</span> <span class="n">rx</span><span class="p">,</span> <span class="n">PCTV_ANSWER_LEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">b0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">c</span><span class="o">++</span><span class="p">;</span>
	<span class="n">b0</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* reset board (again?) */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_usb_generic_rw</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">b0</span><span class="p">),</span> <span class="n">rx</span><span class="p">,</span> <span class="n">PCTV_ANSWER_LEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pctv452e_rc_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pctv452e_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pctv452e_state</span> <span class="o">*</span><span class="p">)</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">b</span><span class="p">[</span><span class="n">CMD_BUFFER_SIZE</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">rx</span><span class="p">[</span><span class="n">PCTV_ANSWER_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">id</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">c</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* prepare command header  */</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SYNC_BYTE_OUT</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">PCTV_CMD_IR</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* send ir request */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_usb_generic_rw</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">PCTV_ANSWER_LEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;%s: read: %2d: %02x %02x %02x: &quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">,</span> <span class="n">rx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rx</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">PCTV_ANSWER_LEN</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">info</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">rx</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]);</span>

		<span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rx</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;&amp;</span>  <span class="p">(</span><span class="n">rx</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* got a &quot;press&quot; event */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">last_rc_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">rx</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">info</span><span class="p">(</span><span class="s">&quot;%s: cmd=0x%02x sys=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">rx</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">rx</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>

		<span class="n">rc_keydown</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_dev</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">last_rc_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">last_rc_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc_keyup</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_dev</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">last_rc_key</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pctv452e_read_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mac</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">mem_addr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0xcc</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">encoded_mac</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pctv452e_i2c_msg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">I2C_ADDR_24C16</span><span class="p">,</span>
				<span class="n">mem_addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="cm">/* snd_len */</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">encoded_mac</span><span class="p">,</span> <span class="cm">/* rcv_len */</span> <span class="mi">20</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">EREMOTEIO</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span>
		<span class="cm">/* Caution! A 24C16 interprets 0xA2 0x1F 0xCC as a</span>
<span class="cm">		   byte write if /WC is low. */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pctv452e_i2c_msg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">I2C_ADDR_24C64</span><span class="p">,</span>
					<span class="n">mem_addr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
					<span class="n">encoded_mac</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">20</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ttpci_eeprom_decode_mac</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">encoded_mac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">stb0899_s1_reg</span> <span class="n">pctv452e_init_dev</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">STB0899_DISCNTRL1</span><span class="p">,</span>	<span class="mh">0x26</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISCNTRL2</span><span class="p">,</span>	<span class="mh">0x80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISRX_ST0</span><span class="p">,</span>	<span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISRX_ST1</span><span class="p">,</span>	<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISPARITY</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISFIFO</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISF22</span><span class="p">,</span>	<span class="mh">0x99</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISF22RX</span><span class="p">,</span>	<span class="mh">0x85</span> <span class="p">},</span> <span class="cm">/* 0xa8 */</span>
	<span class="p">{</span> <span class="n">STB0899_ACRPRESC</span><span class="p">,</span>	<span class="mh">0x11</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ACRDIV1</span><span class="p">,</span>	<span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ACRDIV2</span><span class="p">,</span>	<span class="mh">0x05</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DACR1</span>	<span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DACR2</span>	<span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_OUTCFG</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_MODECFG</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span> <span class="cm">/* Inversion */</span>
	<span class="p">{</span> <span class="n">STB0899_IRQMSK_3</span><span class="p">,</span>	<span class="mh">0xf3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IRQMSK_2</span><span class="p">,</span>	<span class="mh">0xfc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IRQMSK_1</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IRQMSK_0</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_I2CCFG</span><span class="p">,</span>	<span class="mh">0x88</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_I2CRPT</span><span class="p">,</span>	<span class="mh">0x58</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO00CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO01CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span> <span class="cm">/* LED: 0x02 green, 0x82 orange */</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO02CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO03CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO04CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO05CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO06CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO07CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO08CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO09CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO10CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO11CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO12CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO13CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO14CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO15CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO16CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO17CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO18CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO19CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO20CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SDATCFG</span><span class="p">,</span>	<span class="mh">0xb8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SCLTCFG</span><span class="p">,</span>	<span class="mh">0xba</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGCRFCFG</span><span class="p">,</span>	<span class="mh">0x1c</span> <span class="p">},</span> <span class="cm">/* 0x11 DVB-S; 0x1c DVB-S2 (1c, rjkm) */</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO22</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_GPIO21</span><span class="p">,</span>	<span class="mh">0x91</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DIRCLKCFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CLKOUT27CFG</span><span class="p">,</span>	<span class="mh">0x7e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_STDBYCFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CS0CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CS1CFG</span><span class="p">,</span>	<span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DISEQCOCFG</span><span class="p">,</span>	<span class="mh">0x20</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_NCOARSE</span><span class="p">,</span>	<span class="mh">0x15</span> <span class="p">},</span> <span class="cm">/* 0x15 27Mhz, F/3 198MHz, F/6 108MHz */</span>
	<span class="p">{</span> <span class="n">STB0899_SYNTCTRL</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span> <span class="cm">/* 0x00 CLKI, 0x02 XTALI */</span>
	<span class="p">{</span> <span class="n">STB0899_FILTCTRL</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYSCTRL</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_STOPCLK1</span><span class="p">,</span>	<span class="mh">0x20</span> <span class="p">},</span> <span class="cm">/* orig: 0x00 budget-ci: 0x20 */</span>
	<span class="p">{</span> <span class="n">STB0899_STOPCLK2</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_INTBUFCTRL</span><span class="p">,</span>	<span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGC2I1</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGC2I2</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGCIQIN</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSTRES</span><span class="p">,</span>	<span class="mh">0x40</span> <span class="p">},</span> <span class="cm">/* rjkm */</span>
	<span class="p">{</span> <span class="mh">0xffff</span><span class="p">,</span>		<span class="mh">0xff</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">stb0899_s1_reg</span> <span class="n">pctv452e_init_s1_demod</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">STB0899_DEMOD</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_RCOMPC</span><span class="p">,</span>	<span class="mh">0xc9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGC1CN</span><span class="p">,</span>	<span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGC1REF</span><span class="p">,</span>	<span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_RTC</span><span class="p">,</span>		<span class="mh">0x23</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TMGCFG</span><span class="p">,</span>	<span class="mh">0x4e</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGC2REF</span><span class="p">,</span>	<span class="mh">0x34</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TLSR</span><span class="p">,</span>		<span class="mh">0x84</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CFD</span><span class="p">,</span>		<span class="mh">0xf7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ACLC</span><span class="p">,</span>		<span class="mh">0x87</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_BCLC</span><span class="p">,</span>		<span class="mh">0x94</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQON</span><span class="p">,</span>		<span class="mh">0x41</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_LDT</span><span class="p">,</span>		<span class="mh">0xf1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_LDT2</span><span class="p">,</span>		<span class="mh">0xe3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUALREF</span><span class="p">,</span>	<span class="mh">0xb4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TMGRAMP</span><span class="p">,</span>	<span class="mh">0x10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TMGTHD</span><span class="p">,</span>	<span class="mh">0x30</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IDCCOMP</span><span class="p">,</span>	<span class="mh">0xfd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_QDCCOMP</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_POWERI</span><span class="p">,</span>	<span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_POWERQ</span><span class="p">,</span>	<span class="mh">0x0f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_RCOMP</span><span class="p">,</span>	<span class="mh">0x6c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGCIQIN</span><span class="p">,</span>	<span class="mh">0x80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGC2I1</span><span class="p">,</span>	<span class="mh">0x06</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_AGC2I2</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TLIR</span><span class="p">,</span>		<span class="mh">0x30</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_RTF</span><span class="p">,</span>		<span class="mh">0x7f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DSTATUS</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_LDI</span><span class="p">,</span>		<span class="mh">0xbc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CFRM</span><span class="p">,</span>		<span class="mh">0xea</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CFRL</span><span class="p">,</span>		<span class="mh">0x31</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_NIRM</span><span class="p">,</span>		<span class="mh">0x2b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_NIRL</span><span class="p">,</span>		<span class="mh">0x80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ISYMB</span><span class="p">,</span>	<span class="mh">0x1d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_QSYMB</span><span class="p">,</span>	<span class="mh">0xa6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SFRH</span><span class="p">,</span>		<span class="mh">0x2f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SFRM</span><span class="p">,</span>		<span class="mh">0x68</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SFRL</span><span class="p">,</span>		<span class="mh">0x40</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SFRUPH</span><span class="p">,</span>	<span class="mh">0x2f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SFRUPM</span><span class="p">,</span>	<span class="mh">0x68</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SFRUPL</span><span class="p">,</span>	<span class="mh">0x40</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAI1</span><span class="p">,</span>	<span class="mh">0x02</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAQ1</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAI2</span><span class="p">,</span>	<span class="mh">0x04</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAQ2</span><span class="p">,</span>	<span class="mh">0x05</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAI3</span><span class="p">,</span>	<span class="mh">0x02</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAQ3</span><span class="p">,</span>	<span class="mh">0xfd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAI4</span><span class="p">,</span>	<span class="mh">0x03</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAQ4</span><span class="p">,</span>	<span class="mh">0x07</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAI5</span><span class="p">,</span>	<span class="mh">0x08</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_EQUAQ5</span><span class="p">,</span>	<span class="mh">0xf5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DSTATUS2</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VSTATUS</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VERROR</span><span class="p">,</span>	<span class="mh">0x86</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_IQSWAP</span><span class="p">,</span>	<span class="mh">0x2a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ECNT1M</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ECNT1L</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ECNT2M</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ECNT2L</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ECNT3M</span><span class="p">,</span>	<span class="mh">0x0a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ECNT3L</span><span class="p">,</span>	<span class="mh">0xad</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_FECAUTO1</span><span class="p">,</span>	<span class="mh">0x06</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_FECM</span><span class="p">,</span>		<span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VTH12</span><span class="p">,</span>	<span class="mh">0xb0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VTH23</span><span class="p">,</span>	<span class="mh">0x7a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VTH34</span><span class="p">,</span>	<span class="mh">0x58</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VTH56</span><span class="p">,</span>	<span class="mh">0x38</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VTH67</span><span class="p">,</span>	<span class="mh">0x34</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VTH78</span><span class="p">,</span>	<span class="mh">0x24</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_PRVIT</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_VITSYNC</span><span class="p">,</span>	<span class="mh">0x19</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_RSULC</span><span class="p">,</span>	<span class="mh">0xb1</span> <span class="p">},</span> <span class="cm">/* DVB = 0xb1, DSS = 0xa1 */</span>
	<span class="p">{</span> <span class="n">STB0899_TSULC</span><span class="p">,</span>	<span class="mh">0x42</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_RSLLC</span><span class="p">,</span>	<span class="mh">0x41</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSLPL</span><span class="p">,</span>	<span class="mh">0x12</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSCFGH</span><span class="p">,</span>	<span class="mh">0x0c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSCFGM</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSCFGL</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSOUT</span><span class="p">,</span>	<span class="mh">0x69</span> <span class="p">},</span> <span class="cm">/* 0x0d for CAM */</span>
	<span class="p">{</span> <span class="n">STB0899_RSSYNCDEL</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSINHDELH</span><span class="p">,</span>	<span class="mh">0x02</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSINHDELM</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSINHDELL</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSLLSTKM</span><span class="p">,</span>	<span class="mh">0x1b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSLLSTKL</span><span class="p">,</span>	<span class="mh">0xb3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSULSTKM</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSULSTKL</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_PCKLENUL</span><span class="p">,</span>	<span class="mh">0xbc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_PCKLENLL</span><span class="p">,</span>	<span class="mh">0xcc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_RSPCKLEN</span><span class="p">,</span>	<span class="mh">0xbd</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_TSSTATUS</span><span class="p">,</span>	<span class="mh">0x90</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ERRCTRL1</span><span class="p">,</span>	<span class="mh">0xb6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ERRCTRL2</span><span class="p">,</span>	<span class="mh">0x95</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ERRCTRL3</span><span class="p">,</span>	<span class="mh">0x8d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DMONMSK1</span><span class="p">,</span>	<span class="mh">0x27</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DMONMSK0</span><span class="p">,</span>	<span class="mh">0x03</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DEMAPVIT</span><span class="p">,</span>	<span class="mh">0x5c</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_PLPARM</span><span class="p">,</span>	<span class="mh">0x19</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_PDELCTRL</span><span class="p">,</span>	<span class="mh">0x48</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_PDELCTRL2</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_BBHCTRL1</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_BBHCTRL2</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_HYSTTHRESH</span><span class="p">,</span>	<span class="mh">0x77</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_MATCSTM</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_MATCSTL</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_UPLCSTM</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_UPLCSTL</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DFLCSTM</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DFLCSTL</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYNCCST</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYNCDCSTM</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYNCDCSTL</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ISI_ENTRY</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_ISI_BIT_EN</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_MATSTRM</span><span class="p">,</span>	<span class="mh">0xf0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_MATSTRL</span><span class="p">,</span>	<span class="mh">0x02</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_UPLSTRM</span><span class="p">,</span>	<span class="mh">0x45</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_UPLSTRL</span><span class="p">,</span>	<span class="mh">0x60</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DFLSTRM</span><span class="p">,</span>	<span class="mh">0xe3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_DFLSTRL</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYNCSTR</span><span class="p">,</span>	<span class="mh">0x47</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYNCDSTRM</span><span class="p">,</span>	<span class="mh">0x05</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_SYNCDSTRL</span><span class="p">,</span>	<span class="mh">0x18</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CFGPDELSTATUS1</span><span class="p">,</span> <span class="mh">0x19</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_CFGPDELSTATUS2</span><span class="p">,</span> <span class="mh">0x2b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_BBFERRORM</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_BBFERRORL</span><span class="p">,</span>	<span class="mh">0x01</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_UPKTERRORM</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STB0899_UPKTERRORL</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xffff</span><span class="p">,</span>		<span class="mh">0xff</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stb0899_config</span> <span class="n">stb0899_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init_dev</span>	<span class="o">=</span> <span class="n">pctv452e_init_dev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_s2_demod</span>	<span class="o">=</span> <span class="n">stb0899_s2_init_2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_s1_demod</span>	<span class="o">=</span> <span class="n">pctv452e_init_s1_demod</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_s2_fec</span>	<span class="o">=</span> <span class="n">stb0899_s2_init_4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_tst</span>	<span class="o">=</span> <span class="n">stb0899_s1_init_5</span><span class="p">,</span>

	<span class="p">.</span><span class="n">demod_address</span>   <span class="o">=</span> <span class="n">I2C_ADDR_STB0899</span><span class="p">,</span> <span class="cm">/* I2C Address */</span>
	<span class="p">.</span><span class="n">block_sync_mode</span> <span class="o">=</span> <span class="n">STB0899_SYNC_FORCED</span><span class="p">,</span> <span class="cm">/* ? */</span>

	<span class="p">.</span><span class="n">xtal_freq</span>       <span class="o">=</span> <span class="mi">27000000</span><span class="p">,</span>	 <span class="cm">/* Assume Hz ? */</span>
	<span class="p">.</span><span class="n">inversion</span>       <span class="o">=</span> <span class="n">IQ_SWAP_ON</span><span class="p">,</span>       <span class="cm">/* ? */</span>

	<span class="p">.</span><span class="n">lo_clk</span>	  <span class="o">=</span> <span class="mi">76500000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hi_clk</span>	  <span class="o">=</span> <span class="mi">99000000</span><span class="p">,</span>

	<span class="p">.</span><span class="n">ts_output_mode</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* Use parallel mode */</span>
	<span class="p">.</span><span class="n">clock_polarity</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">data_clk_parity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fec_mode</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

	<span class="p">.</span><span class="n">esno_ave</span>	    <span class="o">=</span> <span class="n">STB0899_DVBS2_ESNO_AVE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">esno_quant</span>	  <span class="o">=</span> <span class="n">STB0899_DVBS2_ESNO_QUANT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">avframes_coarse</span>     <span class="o">=</span> <span class="n">STB0899_DVBS2_AVFRAMES_COARSE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">avframes_fine</span>       <span class="o">=</span> <span class="n">STB0899_DVBS2_AVFRAMES_FINE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">miss_threshold</span>      <span class="o">=</span> <span class="n">STB0899_DVBS2_MISS_THRESHOLD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uwp_threshold_acq</span>   <span class="o">=</span> <span class="n">STB0899_DVBS2_UWP_THRESHOLD_ACQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uwp_threshold_track</span> <span class="o">=</span> <span class="n">STB0899_DVBS2_UWP_THRESHOLD_TRACK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uwp_threshold_sof</span>   <span class="o">=</span> <span class="n">STB0899_DVBS2_UWP_THRESHOLD_SOF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sof_search_timeout</span>  <span class="o">=</span> <span class="n">STB0899_DVBS2_SOF_SEARCH_TIMEOUT</span><span class="p">,</span>

	<span class="p">.</span><span class="n">btr_nco_bits</span>	  <span class="o">=</span> <span class="n">STB0899_DVBS2_BTR_NCO_BITS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">btr_gain_shift_offset</span> <span class="o">=</span> <span class="n">STB0899_DVBS2_BTR_GAIN_SHIFT_OFFSET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crl_nco_bits</span>	  <span class="o">=</span> <span class="n">STB0899_DVBS2_CRL_NCO_BITS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ldpc_max_iter</span>	 <span class="o">=</span> <span class="n">STB0899_DVBS2_LDPC_MAX_ITER</span><span class="p">,</span>

	<span class="p">.</span><span class="n">tuner_get_frequency</span>	<span class="o">=</span> <span class="n">stb6100_get_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner_set_frequency</span>	<span class="o">=</span> <span class="n">stb6100_set_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner_set_bandwidth</span>	<span class="o">=</span> <span class="n">stb6100_set_bandwidth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner_get_bandwidth</span>	<span class="o">=</span> <span class="n">stb6100_get_bandwidth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner_set_rfsiggain</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>

	<span class="cm">/* helper for switching LED green/orange */</span>
	<span class="p">.</span><span class="n">postproc</span> <span class="o">=</span> <span class="n">pctv45e_postproc</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stb6100_config</span> <span class="n">stb6100_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tuner_address</span> <span class="o">=</span> <span class="n">I2C_ADDR_STB6100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">refclock</span>      <span class="o">=</span> <span class="mi">27000000</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_algorithm</span> <span class="n">pctv452e_i2c_algo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">master_xfer</span>   <span class="o">=</span> <span class="n">pctv452e_i2c_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">functionality</span> <span class="o">=</span> <span class="n">pctv452e_i2c_func</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pctv452e_frontend_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>

	<span class="n">a</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">stb0899_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stb0899_config</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">lnbp22_attach</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;Cannot attach lnbp22</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">warm_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">USB_VID_TECHNOTREND</span> <span class="o">==</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">idVendor</span>
	    <span class="o">&amp;&amp;</span> <span class="n">USB_PID_TECHNOTREND_CONNECT_S2_3650_CI</span> <span class="o">==</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">idProduct</span><span class="p">)</span>
		<span class="cm">/* Error ignored. */</span>
		<span class="n">tt3650_ci_init</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pctv452e_tuner_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">stb6100_attach</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stb6100_config</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;%s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">pctv452e_usb_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_PINNACLE</span><span class="p">,</span> <span class="n">USB_PID_PCTV_452E</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_TECHNOTREND</span><span class="p">,</span> <span class="n">USB_PID_TECHNOTREND_CONNECT_S2_3600</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_TECHNOTREND</span><span class="p">,</span>
				<span class="n">USB_PID_TECHNOTREND_CONNECT_S2_3650_CI</span><span class="p">)},</span>
	<span class="p">{}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">pctv452e_usb_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="n">pctv452e_properties</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_IS_AN_I2C_ADAPTER</span><span class="p">,</span> <span class="cm">/* more ? */</span>
	<span class="p">.</span><span class="n">usb_ctrl</span> <span class="o">=</span> <span class="n">DEVICE_SPECIFIC</span><span class="p">,</span>

	<span class="p">.</span><span class="n">size_of_priv</span>     <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pctv452e_state</span><span class="p">),</span>

	<span class="p">.</span><span class="n">power_ctrl</span>       <span class="o">=</span> <span class="n">pctv452e_power_ctrl</span><span class="p">,</span>

	<span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rc_codes</span>	<span class="o">=</span> <span class="n">RC_MAP_DIB0700_RC5_TABLE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">allowed_protos</span>	<span class="o">=</span> <span class="n">RC_TYPE_UNKNOWN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rc_query</span>	<span class="o">=</span> <span class="n">pctv452e_rc_query</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rc_interval</span>	<span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">num_adapters</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">{{</span>
		<span class="p">.</span><span class="n">num_frontends</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fe</span> <span class="o">=</span> <span class="p">{{</span>
			<span class="p">.</span><span class="n">frontend_attach</span>  <span class="o">=</span> <span class="n">pctv452e_frontend_attach</span><span class="p">,</span>
			<span class="p">.</span><span class="n">tuner_attach</span>     <span class="o">=</span> <span class="n">pctv452e_tuner_attach</span><span class="p">,</span>

			<span class="cm">/* parameter for the MPEG2-data transfer */</span>
			<span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">type</span>     <span class="o">=</span> <span class="n">USB_ISOC</span><span class="p">,</span>
				<span class="p">.</span><span class="n">count</span>    <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
				<span class="p">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
				<span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">isoc</span> <span class="o">=</span> <span class="p">{</span>
						<span class="p">.</span><span class="n">framesperurb</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
						<span class="p">.</span><span class="n">framesize</span>    <span class="o">=</span> <span class="mi">940</span><span class="p">,</span>
						<span class="p">.</span><span class="n">interval</span>     <span class="o">=</span> <span class="mi">1</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">},</span>
		<span class="p">}</span> <span class="p">},</span>
	<span class="p">}</span> <span class="p">},</span>

	<span class="p">.</span><span class="n">i2c_algo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pctv452e_i2c_algo</span><span class="p">,</span>

	<span class="p">.</span><span class="n">generic_bulk_ctrl_endpoint</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="cm">/* allow generice rw function */</span>

	<span class="p">.</span><span class="n">num_device_descs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PCTV HDTV USB&quot;</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span> <span class="cm">/* this is a warm only device */</span>
		  <span class="p">.</span><span class="n">warm_ids</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">pctv452e_usb_table</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">NULL</span> <span class="p">}</span>
		<span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="n">tt_connect_s2_3600_properties</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_IS_AN_I2C_ADAPTER</span><span class="p">,</span> <span class="cm">/* more ? */</span>
	<span class="p">.</span><span class="n">usb_ctrl</span> <span class="o">=</span> <span class="n">DEVICE_SPECIFIC</span><span class="p">,</span>

	<span class="p">.</span><span class="n">size_of_priv</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pctv452e_state</span><span class="p">),</span>

	<span class="p">.</span><span class="n">power_ctrl</span>		<span class="o">=</span> <span class="n">pctv452e_power_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_mac_address</span>	<span class="o">=</span> <span class="n">pctv452e_read_mac_address</span><span class="p">,</span>

	<span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rc_codes</span>	<span class="o">=</span> <span class="n">RC_MAP_TT_1500</span><span class="p">,</span>
		<span class="p">.</span><span class="n">allowed_protos</span>	<span class="o">=</span> <span class="n">RC_TYPE_UNKNOWN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rc_query</span>	<span class="o">=</span> <span class="n">pctv452e_rc_query</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rc_interval</span>	<span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">num_adapters</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">{{</span>
		<span class="p">.</span><span class="n">num_frontends</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fe</span> <span class="o">=</span> <span class="p">{{</span>
			<span class="p">.</span><span class="n">frontend_attach</span> <span class="o">=</span> <span class="n">pctv452e_frontend_attach</span><span class="p">,</span>
			<span class="p">.</span><span class="n">tuner_attach</span> <span class="o">=</span> <span class="n">pctv452e_tuner_attach</span><span class="p">,</span>

			<span class="cm">/* parameter for the MPEG2-data transfer */</span>
			<span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_ISOC</span><span class="p">,</span>
				<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
				<span class="p">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
				<span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">isoc</span> <span class="o">=</span> <span class="p">{</span>
						<span class="p">.</span><span class="n">framesperurb</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
						<span class="p">.</span><span class="n">framesize</span> <span class="o">=</span> <span class="mi">940</span><span class="p">,</span>
						<span class="p">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">1</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">},</span>

		<span class="p">}</span> <span class="p">},</span>
	<span class="p">}</span> <span class="p">},</span>

	<span class="p">.</span><span class="n">i2c_algo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pctv452e_i2c_algo</span><span class="p">,</span>

	<span class="p">.</span><span class="n">generic_bulk_ctrl_endpoint</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="cm">/* allow generic rw function*/</span>

	<span class="p">.</span><span class="n">num_device_descs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Technotrend TT Connect S2-3600&quot;</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span> <span class="cm">/* this is a warm only device */</span>
		  <span class="p">.</span><span class="n">warm_ids</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">pctv452e_usb_table</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">NULL</span> <span class="p">}</span>
		<span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Technotrend TT Connect S2-3650-CI&quot;</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
		  <span class="p">.</span><span class="n">warm_ids</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">pctv452e_usb_table</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">NULL</span> <span class="p">}</span>
		<span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pctv452e_usb_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="n">tt3650_ci_uninit</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="n">dvb_usb_device_exit</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pctv452e_usb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">dvb_usb_device_init</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pctv452e_properties</span><span class="p">,</span>
					<span class="n">THIS_MODULE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">adapter_nr</span><span class="p">)</span> <span class="o">||</span>
	    <span class="mi">0</span> <span class="o">==</span> <span class="n">dvb_usb_device_init</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tt_connect_s2_3600_properties</span><span class="p">,</span>
					<span class="n">THIS_MODULE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">adapter_nr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">pctv452e_usb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;pctv452e&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>      <span class="o">=</span> <span class="n">pctv452e_usb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">pctv452e_usb_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>   <span class="o">=</span> <span class="n">pctv452e_usb_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">pctv452e_usb_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Dominik Kuhlen &lt;dkuhlen@gmx.net&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Andre Weidemann &lt;Andre.Weidemann@web.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Michael H. Schimek &lt;mschimek@gmx.at&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Pinnacle PCTV HDTV USB DVB / TT connect S2-3600 Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
