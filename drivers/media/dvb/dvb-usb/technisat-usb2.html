<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › dvb-usb › technisat-usb2.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>technisat-usb2.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Linux driver for Technisat DVB-S/S2 USB 2.0 device</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Patrick Boettcher,</span>
<span class="cm"> *                    Kernel Labs Inc. PO Box 745, St James, NY 11780</span>
<span class="cm"> *</span>
<span class="cm"> * Development was sponsored by Technisat Digital UK Limited, whose</span>
<span class="cm"> * registered office is Witan Gate House 500 - 600 Witan Gate West,</span>
<span class="cm"> * Milton Keynes, MK9 1SH</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation; either version 2 of the</span>
<span class="cm"> * License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS PROGRAM IS PROVIDED &quot;AS IS&quot; AND BOTH THE COPYRIGHT HOLDER AND</span>
<span class="cm"> * TECHNISAT DIGITAL UK LTD DISCLAIM ALL WARRANTIES WITH REGARD TO</span>
<span class="cm"> * THIS PROGRAM INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY OR</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  NEITHER THE COPYRIGHT HOLDER</span>
<span class="cm"> * NOR TECHNISAT DIGITAL UK LIMITED SHALL BE LIABLE FOR ANY SPECIAL,</span>
<span class="cm"> * DIRECT, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER</span>
<span class="cm"> * RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION</span>
<span class="cm"> * OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR</span>
<span class="cm"> * IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS PROGRAM. See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> */</span>

<span class="cp">#define DVB_USB_LOG_PREFIX &quot;technisat-usb2&quot;</span>
<span class="cp">#include &quot;dvb-usb.h&quot;</span>

<span class="cp">#include &quot;stv6110x.h&quot;</span>
<span class="cp">#include &quot;stv090x.h&quot;</span>

<span class="cm">/* module parameters */</span>
<span class="n">DVB_DEFINE_MOD_OPT_ADAPTER_NR</span><span class="p">(</span><span class="n">adapter_nr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span>
		<span class="s">&quot;set debugging level (bit-mask: 1=info,2=eeprom,4=i2c,8=rc).&quot;</span> \
		<span class="n">DVB_USB_DEBUG_STATUS</span><span class="p">);</span>

<span class="cm">/* disables all LED control command and</span>
<span class="cm"> * also does not start the signal polling thread */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">disable_led_control</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">disable_led_control</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">disable_led_control</span><span class="p">,</span>
		<span class="s">&quot;disable LED control of the device &quot;</span>
		<span class="s">&quot;(default: 0 - LED control is active).&quot;</span><span class="p">);</span>

<span class="cm">/* device private data */</span>
<span class="k">struct</span> <span class="n">technisat_usb2_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">green_led_work</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">power_state</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">last_scan_code</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* debug print helpers */</span>
<span class="cp">#define deb_info(args...)    dprintk(debug, 0x01, args)</span>
<span class="cp">#define deb_eeprom(args...)  dprintk(debug, 0x02, args)</span>
<span class="cp">#define deb_i2c(args...)     dprintk(debug, 0x04, args)</span>
<span class="cp">#define deb_rc(args...)      dprintk(debug, 0x08, args)</span>

<span class="cm">/* vendor requests */</span>
<span class="cp">#define SET_IFCLK_TO_EXTERNAL_TSCLK_VENDOR_REQUEST 0xB3</span>
<span class="cp">#define SET_FRONT_END_RESET_VENDOR_REQUEST         0xB4</span>
<span class="cp">#define GET_VERSION_INFO_VENDOR_REQUEST            0xB5</span>
<span class="cp">#define SET_GREEN_LED_VENDOR_REQUEST               0xB6</span>
<span class="cp">#define SET_RED_LED_VENDOR_REQUEST                 0xB7</span>
<span class="cp">#define GET_IR_DATA_VENDOR_REQUEST                 0xB8</span>
<span class="cp">#define SET_LED_TIMER_DIVIDER_VENDOR_REQUEST       0xB9</span>
<span class="cp">#define SET_USB_REENUMERATION                      0xBA</span>

<span class="cm">/* i2c-access methods */</span>
<span class="cp">#define I2C_SPEED_100KHZ_BIT 0x40</span>

<span class="cp">#define I2C_STATUS_NAK 7</span>
<span class="cp">#define I2C_STATUS_OK 8</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">technisat_usb2_i2c_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">device_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">txlen</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rxlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">b</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">actual_length</span><span class="p">;</span>

	<span class="n">deb_i2c</span><span class="p">(</span><span class="s">&quot;i2c-access: %02x, tx: &quot;</span><span class="p">,</span> <span class="n">device_addr</span><span class="p">);</span>
	<span class="n">debug_dump</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">txlen</span><span class="p">,</span> <span class="n">deb_i2c</span><span class="p">);</span>
	<span class="n">deb_i2c</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txlen</span> <span class="o">&gt;</span> <span class="mi">62</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;i2c TX buffer can&#39;t exceed 62 bytes (dev 0x%02x)&quot;</span><span class="p">,</span>
				<span class="n">device_addr</span><span class="p">);</span>
		<span class="n">txlen</span> <span class="o">=</span> <span class="mi">62</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxlen</span> <span class="o">&gt;</span> <span class="mi">62</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;i2c RX buffer can&#39;t exceed 62 bytes (dev 0x%02x)&quot;</span><span class="p">,</span>
				<span class="n">device_addr</span><span class="p">);</span>
		<span class="n">txlen</span> <span class="o">=</span> <span class="mi">62</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">I2C_SPEED_100KHZ_BIT</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">device_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">rxlen</span><span class="p">;</span>
		<span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">tx</span><span class="p">,</span> <span class="n">txlen</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span>
			<span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">),</span>
			<span class="n">b</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">txlen</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;i2c-error: out failed %02x = %d&quot;</span><span class="p">,</span> <span class="n">device_addr</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span>
			<span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">),</span>
			<span class="n">b</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">actual_length</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;i2c-error: in failed %02x = %d&quot;</span><span class="p">,</span> <span class="n">device_addr</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">I2C_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;i2c-error: %02x = %d&quot;</span><span class="p">,</span> <span class="n">device_addr</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="cm">/* handle tuner-i2c-nak */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">I2C_STATUS_NAK</span> <span class="o">&amp;&amp;</span>
				<span class="n">device_addr</span> <span class="o">==</span> <span class="mh">0x60</span>
				<span class="cm">/* &amp;&amp; device_is_technisat_usb2 */</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">deb_i2c</span><span class="p">(</span><span class="s">&quot;status: %d, &quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rxlen</span><span class="p">);</span>

		<span class="n">deb_i2c</span><span class="p">(</span><span class="s">&quot;rx (%d): &quot;</span><span class="p">,</span> <span class="n">rxlen</span><span class="p">);</span>
		<span class="n">debug_dump</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">rxlen</span><span class="p">,</span> <span class="n">deb_i2c</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">deb_i2c</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">technisat_usb2_i2c_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>

	<span class="cm">/* Ensure nobody else hits the i2c bus while we&#39;re sending our</span>
<span class="cm">	   sequence of messages, (such as the remote control thread) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">num</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">technisat_usb2_i2c_access</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
						<span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">,</span>
						<span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">technisat_usb2_i2c_access</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
						<span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">technisat_usb2_i2c_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">I2C_FUNC_I2C</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_algorithm</span> <span class="n">technisat_usb2_i2c_algo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">master_xfer</span>   <span class="o">=</span> <span class="n">technisat_usb2_i2c_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">functionality</span> <span class="o">=</span> <span class="n">technisat_usb2_i2c_func</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void technisat_usb2_frontend_reset(struct usb_device *udev)</span>
<span class="c">{</span>
<span class="c">	usb_control_msg(udev, usb_sndctrlpipe(udev, 0),</span>
<span class="c">			SET_FRONT_END_RESET_VENDOR_REQUEST,</span>
<span class="c">			USB_TYPE_VENDOR | USB_DIR_OUT,</span>
<span class="c">			10, 0,</span>
<span class="c">			NULL, 0, 500);</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/* LED control */</span>
<span class="k">enum</span> <span class="n">technisat_usb2_led_state</span> <span class="p">{</span>
	<span class="n">LED_OFF</span><span class="p">,</span>
	<span class="n">LED_BLINK</span><span class="p">,</span>
	<span class="n">LED_ON</span><span class="p">,</span>
	<span class="n">LED_UNDEFINED</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">technisat_usb2_set_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">int</span> <span class="n">red</span><span class="p">,</span> <span class="k">enum</span> <span class="n">technisat_usb2_led_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">led</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">red</span> <span class="o">?</span> <span class="n">SET_RED_LED_VENDOR_REQUEST</span> <span class="o">:</span> <span class="n">SET_GREEN_LED_VENDOR_REQUEST</span><span class="p">,</span>
		<span class="mi">0</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disable_led_control</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">!=</span> <span class="n">LED_OFF</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LED_ON</span>:
		<span class="n">led</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x82</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LED_BLINK</span>:
		<span class="n">led</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x82</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">red</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">led</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="n">led</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">led</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">led</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">led</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
			<span class="n">led</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">led</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">LED_OFF</span>:
		<span class="n">led</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">red</span> <span class="o">?</span> <span class="n">SET_RED_LED_VENDOR_REQUEST</span> <span class="o">:</span> <span class="n">SET_GREEN_LED_VENDOR_REQUEST</span><span class="p">,</span>
		<span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">led</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">led</span><span class="p">),</span> <span class="mi">500</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">technisat_usb2_set_led_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u8</span> <span class="n">red</span><span class="p">,</span> <span class="n">u8</span> <span class="n">green</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">SET_LED_TIMER_DIVIDER_VENDOR_REQUEST</span><span class="p">,</span>
		<span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span><span class="p">,</span>
		<span class="p">(</span><span class="n">red</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">green</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">technisat_usb2_green_led_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">technisat_usb2_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">technisat_usb2_state</span><span class="p">,</span> <span class="n">green_led_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">power_state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">schedule</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fe</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">fe_status</span> <span class="n">status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_status</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">schedule</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FE_HAS_LOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">ber</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_ber</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ber</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">schedule</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ber</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span>
				<span class="n">technisat_usb2_set_led</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LED_BLINK</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">technisat_usb2_set_led</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LED_ON</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">technisat_usb2_set_led</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LED_OFF</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">schedule:</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">green_led_work</span><span class="p">,</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">500</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* method to find out whether the firmware has to be downloaded or not */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">technisat_usb2_identify_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="o">*</span><span class="n">props</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dvb_usb_device_description</span> <span class="o">**</span><span class="n">desc</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">version</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="cm">/* first select the interface */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_set_interface</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;could not set alternate setting to 0&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;set alternate setting&quot;</span><span class="p">);</span>

	<span class="o">*</span><span class="n">cold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* by default do not download a firmware - just in case something is wrong */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">GET_VERSION_INFO_VENDOR_REQUEST</span><span class="p">,</span>
		<span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">version</span><span class="p">),</span> <span class="mi">500</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;firmware version: %d.%d&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">version</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="o">*</span><span class="n">cold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* power control */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">technisat_usb2_power_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">technisat_usb2_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disable_led_control</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* green led is turned off in any case - will be turned on when tuning */</span>
	<span class="n">technisat_usb2_set_led</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LED_OFF</span><span class="p">);</span>
	<span class="cm">/* red led is turned on all the time */</span>
	<span class="n">technisat_usb2_set_led</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LED_ON</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* mac address reading - from the eeprom */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void technisat_usb2_eeprom_dump(struct dvb_usb_device *d)</span>
<span class="c">{</span>
<span class="c">	u8 reg;</span>
<span class="c">	u8 b[16];</span>
<span class="c">	int i, j;</span>

<span class="c">	/* full EEPROM dump */</span>
<span class="c">	for (j = 0; j &lt; 256 * 4; j += 16) {</span>
<span class="c">		reg = j;</span>
<span class="c">		if (technisat_usb2_i2c_access(d-&gt;udev, 0x50 + j / 256, &amp;reg, 1, b, 16) != 0)</span>
<span class="c">			break;</span>

<span class="c">		deb_eeprom(&quot;EEPROM: %01x%02x: &quot;, j / 256, reg);</span>
<span class="c">		for (i = 0; i &lt; 16; i++)</span>
<span class="c">			deb_eeprom(&quot;%02x &quot;, b[i]);</span>
<span class="c">		deb_eeprom(&quot;\n&quot;);</span>
<span class="c">	}</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">technisat_usb2_calc_lrc</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="n">u16</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">lrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">length</span><span class="p">)</span>
		<span class="n">lrc</span> <span class="o">^=</span> <span class="o">*</span><span class="n">b</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">lrc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">technisat_usb2_eeprom_lrc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
	<span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="n">u16</span> <span class="n">length</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">bo</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x50</span> <span class="o">|</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">),</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bo</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="p">},</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x50</span> <span class="o">|</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">),</span>
			<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">length</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tries</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span>
			<span class="n">technisat_usb2_calc_lrc</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">b</span><span class="p">[</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define EEPROM_MAC_START 0x3f8</span>
<span class="cp">#define EEPROM_MAC_TOTAL 8</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">technisat_usb2_read_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">mac</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="n">EEPROM_MAC_TOTAL</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">technisat_usb2_eeprom_lrc_read</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">EEPROM_MAC_START</span><span class="p">,</span>
				<span class="n">buf</span><span class="p">,</span> <span class="n">EEPROM_MAC_TOTAL</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* frontend attach */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">technisat_usb2_set_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
		<span class="n">fe_sec_voltage_t</span> <span class="n">voltage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">gpio</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span> <span class="cm">/* 0 = 2, 1 = 3, 2 = 4 */</span>

	<span class="n">gpio</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* high - voltage ? */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">voltage</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEC_VOLTAGE_13</span>:
		<span class="n">gpio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEC_VOLTAGE_18</span>:
		<span class="n">gpio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">gpio</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">SEC_VOLTAGE_OFF</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stv090x_set_gpio</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gpio</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stv090x_config</span> <span class="n">technisat_usb2_stv090x_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">device</span>         <span class="o">=</span> <span class="n">STV0903</span><span class="p">,</span>
	<span class="p">.</span><span class="n">demod_mode</span>     <span class="o">=</span> <span class="n">STV090x_SINGLE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clk_mode</span>       <span class="o">=</span> <span class="n">STV090x_CLK_EXT</span><span class="p">,</span>

	<span class="p">.</span><span class="n">xtal</span>           <span class="o">=</span> <span class="mi">8000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">address</span>        <span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span>

	<span class="p">.</span><span class="n">ts1_mode</span>       <span class="o">=</span> <span class="n">STV090x_TSMODE_DVBCI</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ts1_clk</span>        <span class="o">=</span> <span class="mi">13400000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ts1_tei</span>        <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">repeater_level</span> <span class="o">=</span> <span class="n">STV090x_RPTLEVEL_64</span><span class="p">,</span>

	<span class="p">.</span><span class="n">tuner_bbgain</span>   <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stv6110x_config</span> <span class="n">technisat_usb2_stv6110x_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">addr</span>           <span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span>
	<span class="p">.</span><span class="n">refclk</span>         <span class="o">=</span> <span class="mi">16000000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clk_div</span>        <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">technisat_usb2_frontend_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">a</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">stv090x_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">technisat_usb2_stv090x_config</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">STV090x_DEMODULATOR_0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">stv6110x_devctl</span> <span class="o">*</span><span class="n">ctl</span><span class="p">;</span>

		<span class="n">ctl</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">stv6110x_attach</span><span class="p">,</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">technisat_usb2_stv6110x_config</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">technisat_usb2_stv090x_config</span><span class="p">.</span><span class="n">tuner_init</span>          <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">tuner_init</span><span class="p">;</span>
			<span class="n">technisat_usb2_stv090x_config</span><span class="p">.</span><span class="n">tuner_sleep</span>         <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">tuner_sleep</span><span class="p">;</span>
			<span class="n">technisat_usb2_stv090x_config</span><span class="p">.</span><span class="n">tuner_set_mode</span>      <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">tuner_set_mode</span><span class="p">;</span>
			<span class="n">technisat_usb2_stv090x_config</span><span class="p">.</span><span class="n">tuner_set_frequency</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">tuner_set_frequency</span><span class="p">;</span>
			<span class="n">technisat_usb2_stv090x_config</span><span class="p">.</span><span class="n">tuner_get_frequency</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">tuner_get_frequency</span><span class="p">;</span>
			<span class="n">technisat_usb2_stv090x_config</span><span class="p">.</span><span class="n">tuner_set_bandwidth</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">tuner_set_bandwidth</span><span class="p">;</span>
			<span class="n">technisat_usb2_stv090x_config</span><span class="p">.</span><span class="n">tuner_get_bandwidth</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">tuner_get_bandwidth</span><span class="p">;</span>
			<span class="n">technisat_usb2_stv090x_config</span><span class="p">.</span><span class="n">tuner_set_bbgain</span>    <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">tuner_set_bbgain</span><span class="p">;</span>
			<span class="n">technisat_usb2_stv090x_config</span><span class="p">.</span><span class="n">tuner_get_bbgain</span>    <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">tuner_get_bbgain</span><span class="p">;</span>
			<span class="n">technisat_usb2_stv090x_config</span><span class="p">.</span><span class="n">tuner_set_refclk</span>    <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">tuner_set_refclk</span><span class="p">;</span>
			<span class="n">technisat_usb2_stv090x_config</span><span class="p">.</span><span class="n">tuner_get_status</span>    <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">tuner_get_status</span><span class="p">;</span>

			<span class="cm">/* call the init function once to initialize</span>
<span class="cm">			   tuner&#39;s clock output divider and demod&#39;s</span>
<span class="cm">			   master clock */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">init</span><span class="p">)</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
					<span class="n">SET_IFCLK_TO_EXTERNAL_TSCLK_VENDOR_REQUEST</span><span class="p">,</span>
					<span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">err</span><span class="p">(</span><span class="s">&quot;could not set IF_CLK to external&quot;</span><span class="p">);</span>

			<span class="n">a</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_voltage</span> <span class="o">=</span> <span class="n">technisat_usb2_set_voltage</span><span class="p">;</span>

			<span class="cm">/* if everything was successful assign a nice name to the frontend */</span>
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">);</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">technisat_usb2_set_led_timer</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Remote control */</span>

<span class="cm">/* the device is giving providing raw IR-signals to the host mapping</span>
<span class="cm"> * it only to one remote control is just the default implementation</span>
<span class="cm"> */</span>
<span class="cp">#define NOMINAL_IR_BIT_TRANSITION_TIME_US 889</span>
<span class="cp">#define NOMINAL_IR_BIT_TIME_US (2 * NOMINAL_IR_BIT_TRANSITION_TIME_US)</span>

<span class="cp">#define FIRMWARE_CLOCK_TICK 83333</span>
<span class="cp">#define FIRMWARE_CLOCK_DIVISOR 256</span>

<span class="cp">#define IR_PERCENT_TOLERANCE 15</span>

<span class="cp">#define NOMINAL_IR_BIT_TRANSITION_TICKS ((NOMINAL_IR_BIT_TRANSITION_TIME_US * 1000 * 1000) / FIRMWARE_CLOCK_TICK)</span>
<span class="cp">#define NOMINAL_IR_BIT_TRANSITION_TICK_COUNT (NOMINAL_IR_BIT_TRANSITION_TICKS / FIRMWARE_CLOCK_DIVISOR)</span>

<span class="cp">#define NOMINAL_IR_BIT_TIME_TICKS ((NOMINAL_IR_BIT_TIME_US * 1000 * 1000) / FIRMWARE_CLOCK_TICK)</span>
<span class="cp">#define NOMINAL_IR_BIT_TIME_TICK_COUNT (NOMINAL_IR_BIT_TIME_TICKS / FIRMWARE_CLOCK_DIVISOR)</span>

<span class="cp">#define MINIMUM_IR_BIT_TRANSITION_TICK_COUNT (NOMINAL_IR_BIT_TRANSITION_TICK_COUNT - ((NOMINAL_IR_BIT_TRANSITION_TICK_COUNT * IR_PERCENT_TOLERANCE) / 100))</span>
<span class="cp">#define MAXIMUM_IR_BIT_TRANSITION_TICK_COUNT (NOMINAL_IR_BIT_TRANSITION_TICK_COUNT + ((NOMINAL_IR_BIT_TRANSITION_TICK_COUNT * IR_PERCENT_TOLERANCE) / 100))</span>

<span class="cp">#define MINIMUM_IR_BIT_TIME_TICK_COUNT (NOMINAL_IR_BIT_TIME_TICK_COUNT - ((NOMINAL_IR_BIT_TIME_TICK_COUNT * IR_PERCENT_TOLERANCE) / 100))</span>
<span class="cp">#define MAXIMUM_IR_BIT_TIME_TICK_COUNT (NOMINAL_IR_BIT_TIME_TICK_COUNT + ((NOMINAL_IR_BIT_TIME_TICK_COUNT * IR_PERCENT_TOLERANCE) / 100))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">technisat_usb2_get_ir</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">62</span><span class="p">],</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ir_raw_event</span> <span class="n">ev</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GET_IR_DATA_VENDOR_REQUEST</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8f</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MINIMUM_IR_BIT_TRANSITION_TICK_COUNT</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAXIMUM_IR_BIT_TIME_TICK_COUNT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">GET_IR_DATA_VENDOR_REQUEST</span><span class="p">,</span>
			<span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">buf</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">GET_IR_DATA_VENDOR_REQUEST</span><span class="p">,</span>
			<span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span><span class="p">,</span>
			<span class="mh">0x8080</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">500</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* no key pressed */</span>

	<span class="cm">/* decoding */</span>
	<span class="n">b</span> <span class="o">=</span> <span class="n">buf</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	deb_rc(&quot;RC: %d &quot;, ret);</span>
<span class="c">	debug_dump(b, ret, deb_rc);</span>
<span class="cp">#endif</span>

	<span class="n">ev</span><span class="p">.</span><span class="n">pulse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ev</span><span class="p">.</span><span class="n">pulse</span> <span class="o">=</span> <span class="o">!</span><span class="n">ev</span><span class="p">.</span><span class="n">pulse</span><span class="p">;</span>
		<span class="n">ev</span><span class="p">.</span><span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">b</span> <span class="o">*</span> <span class="n">FIRMWARE_CLOCK_DIVISOR</span> <span class="o">*</span> <span class="n">FIRMWARE_CLOCK_TICK</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">ir_raw_event_store</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">);</span>

		<span class="n">b</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">b</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ev</span><span class="p">.</span><span class="n">pulse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ev</span><span class="p">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">888888</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
			<span class="n">ir_raw_event_store</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ir_raw_event_handle</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">technisat_usb2_rc_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">technisat_usb2_get_ir</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disable_led_control</span><span class="p">)</span>
		<span class="n">technisat_usb2_set_led</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LED_BLINK</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* DVB-USB and USB stuff follows */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">technisat_usb2_id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_TECHNISAT</span><span class="p">,</span> <span class="n">USB_PID_TECHNISAT_USB2_DVB_S2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>		<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>

<span class="cm">/* device description */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="n">technisat_usb2_devices</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">caps</span>              <span class="o">=</span> <span class="n">DVB_USB_IS_AN_I2C_ADAPTER</span><span class="p">,</span>

	<span class="p">.</span><span class="n">usb_ctrl</span>          <span class="o">=</span> <span class="n">CYPRESS_FX2</span><span class="p">,</span>

	<span class="p">.</span><span class="n">identify_state</span>    <span class="o">=</span> <span class="n">technisat_usb2_identify_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">firmware</span>          <span class="o">=</span> <span class="s">&quot;dvb-usb-SkyStar_USB_HD_FW_v17_63.HEX.fw&quot;</span><span class="p">,</span>

	<span class="p">.</span><span class="n">size_of_priv</span>      <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">technisat_usb2_state</span><span class="p">),</span>

	<span class="p">.</span><span class="n">i2c_algo</span>          <span class="o">=</span> <span class="o">&amp;</span><span class="n">technisat_usb2_i2c_algo</span><span class="p">,</span>

	<span class="p">.</span><span class="n">power_ctrl</span>        <span class="o">=</span> <span class="n">technisat_usb2_power_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_mac_address</span>  <span class="o">=</span> <span class="n">technisat_usb2_read_mac_address</span><span class="p">,</span>

	<span class="p">.</span><span class="n">num_adapters</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
		<span class="p">.</span><span class="n">num_frontends</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fe</span> <span class="o">=</span> <span class="p">{{</span>
			<span class="p">.</span><span class="n">frontend_attach</span>  <span class="o">=</span> <span class="n">technisat_usb2_frontend_attach</span><span class="p">,</span>

			<span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_ISOC</span><span class="p">,</span>
				<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
				<span class="p">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
				<span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">isoc</span> <span class="o">=</span> <span class="p">{</span>
						<span class="p">.</span><span class="n">framesperurb</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
						<span class="p">.</span><span class="n">framesize</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">,</span>
						<span class="p">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">},</span>
		<span class="p">}},</span>
			<span class="p">.</span><span class="n">size_of_priv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">num_device_descs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>   <span class="s">&quot;Technisat SkyStar USB HD (DVB-S/S2)&quot;</span><span class="p">,</span>
			<span class="p">{</span> <span class="o">&amp;</span><span class="n">technisat_usb2_id_table</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">NULL</span> <span class="p">},</span>
			<span class="p">{</span> <span class="nb">NULL</span> <span class="p">},</span>
		<span class="p">},</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rc_interval</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rc_codes</span>    <span class="o">=</span> <span class="n">RC_MAP_TECHNISAT_USB2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">module_name</span> <span class="o">=</span> <span class="s">&quot;technisat-usb2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rc_query</span>    <span class="o">=</span> <span class="n">technisat_usb2_rc_query</span><span class="p">,</span>
		<span class="p">.</span><span class="n">allowed_protos</span> <span class="o">=</span> <span class="n">RC_TYPE_ALL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_type</span>    <span class="o">=</span> <span class="n">RC_DRIVER_IR_RAW</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">technisat_usb2_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dvb_usb_device_init</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">technisat_usb2_devices</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dev</span><span class="p">,</span> <span class="n">adapter_nr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">technisat_usb2_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disable_led_control</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">green_led_work</span><span class="p">,</span>
					<span class="n">technisat_usb2_green_led_control</span><span class="p">);</span>
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">green_led_work</span><span class="p">,</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">500</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">technisat_usb2_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="cm">/* work and stuff was only created when the device is is hot-state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">technisat_usb2_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">green_led_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dvb_usb_device_exit</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">technisat_usb2_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;dvb_usb_technisat_usb2&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>      <span class="o">=</span> <span class="n">technisat_usb2_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">technisat_usb2_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>   <span class="o">=</span> <span class="n">technisat_usb2_id_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">technisat_usb2_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Patrick Boettcher &lt;pboettcher@kernellabs.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for Technisat DVB-S/S2 USB 2.0 device&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;1.0&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
