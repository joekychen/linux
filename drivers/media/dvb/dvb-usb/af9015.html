<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › dvb-usb › af9015.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>af9015.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * DVB USB Linux driver for Afatech AF9015 DVB-T USB2.0 receiver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 Antti Palosaari &lt;crope@iki.fi&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to Afatech who kindly provided information.</span>
<span class="cm"> *</span>
<span class="cm"> *    This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *    it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *    (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *    This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *    GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *    You should have received a copy of the GNU General Public License</span>
<span class="cm"> *    along with this program; if not, write to the Free Software</span>
<span class="cm"> *    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/hash.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;af9015.h&quot;</span>
<span class="cp">#include &quot;af9013.h&quot;</span>
<span class="cp">#include &quot;mt2060.h&quot;</span>
<span class="cp">#include &quot;qt1010.h&quot;</span>
<span class="cp">#include &quot;tda18271.h&quot;</span>
<span class="cp">#include &quot;mxl5005s.h&quot;</span>
<span class="cp">#include &quot;mc44s803.h&quot;</span>
<span class="cp">#include &quot;tda18218.h&quot;</span>
<span class="cp">#include &quot;mxl5007t.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dvb_usb_af9015_debug</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">dvb_usb_af9015_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;set debugging level&quot;</span> <span class="n">DVB_USB_DEBUG_STATUS</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dvb_usb_af9015_remote</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="n">dvb_usb_af9015_remote</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="s">&quot;select remote&quot;</span><span class="p">);</span>
<span class="n">DVB_DEFINE_MOD_OPT_ADAPTER_NR</span><span class="p">(</span><span class="n">adapter_nr</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">af9015_usb_mutex</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">af9015_config</span> <span class="n">af9015_config</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="n">af9015_properties</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">af9015_properties_count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">af9015_properties</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">af9013_config</span> <span class="n">af9015_af9013_config</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">AF9015_I2C_DEMOD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ts_mode</span> <span class="o">=</span> <span class="n">AF9013_TS_USB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">api_version</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gpio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">AF9013_GPIO_HI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">AF9013_GPIO_TUNER_ON</span><span class="p">,</span>

	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ts_mode</span> <span class="o">=</span> <span class="n">AF9013_TS_SERIAL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">api_version</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">gpio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">AF9013_GPIO_TUNER_ON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">AF9013_GPIO_LO</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_rw_udev</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define BUF_LEN 63</span>
<span class="cp">#define REQ_HDR_LEN 8 </span><span class="cm">/* send header size */</span><span class="cp"></span>
<span class="cp">#define ACK_HDR_LEN 2 </span><span class="cm">/* rece header size */</span><span class="cp"></span>
	<span class="kt">int</span> <span class="n">act_len</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUF_LEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">write</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">msg_len</span> <span class="o">=</span> <span class="n">REQ_HDR_LEN</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">seq</span><span class="p">;</span> <span class="cm">/* packet sequence number */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">af9015_usb_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq</span><span class="o">++</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">i2c_addr</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GET_CONFIG</span>:
	<span class="k">case</span> <span class="n">READ_MEMORY</span>:
	<span class="k">case</span> <span class="n">RECONNECT_USB</span>:
		<span class="n">write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_I2C</span>:
		<span class="n">write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* set I2C direction */</span>
	<span class="k">case</span> <span class="n">WRITE_I2C</span>:
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">READ_WRITE_I2C</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_MEMORY</span>:
		<span class="k">if</span> <span class="p">(((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xae00</span><span class="p">))</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WRITE_VIRTUAL_MEMORY</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_VIRTUAL_MEMORY</span>:
	<span class="k">case</span> <span class="n">COPY_FIRMWARE</span>:
	<span class="k">case</span> <span class="n">DOWNLOAD_FIRMWARE</span>:
	<span class="k">case</span> <span class="n">BOOT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;unknown command:%d&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* buffer overflow check */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">write</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">&gt;</span> <span class="n">BUF_LEN</span> <span class="o">-</span> <span class="n">REQ_HDR_LEN</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">(</span><span class="o">!</span><span class="n">write</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">&gt;</span> <span class="n">BUF_LEN</span> <span class="o">-</span> <span class="n">ACK_HDR_LEN</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;too much data; cmd:%d len:%d&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* write requested */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">REQ_HDR_LEN</span><span class="p">],</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>
		<span class="n">msg_len</span> <span class="o">+=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">deb_xfer</span><span class="p">(</span><span class="s">&quot;&gt;&gt;&gt; &quot;</span><span class="p">);</span>
	<span class="n">debug_dump</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">msg_len</span><span class="p">,</span> <span class="n">deb_xfer</span><span class="p">);</span>

	<span class="cm">/* send req */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">msg_len</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">act_len</span><span class="p">,</span> <span class="n">AF9015_USB_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;bulk message failed:%d (%d/%d)&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">msg_len</span><span class="p">,</span> <span class="n">act_len</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">act_len</span> <span class="o">!=</span> <span class="n">msg_len</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* all data is not send */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_unlock</span><span class="p">;</span>

	<span class="cm">/* no ack for those packets */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">DOWNLOAD_FIRMWARE</span> <span class="o">||</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">RECONNECT_USB</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>

	<span class="cm">/* write receives seq + status = 2 bytes</span>
<span class="cm">	   read receives seq + status + data = 2 + N bytes */</span>
	<span class="n">msg_len</span> <span class="o">=</span> <span class="n">ACK_HDR_LEN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write</span><span class="p">)</span>
		<span class="n">msg_len</span> <span class="o">+=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">msg_len</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">act_len</span><span class="p">,</span> <span class="n">AF9015_USB_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;recv bulk message failed:%d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">deb_xfer</span><span class="p">(</span><span class="s">&quot;&lt;&lt;&lt; &quot;</span><span class="p">);</span>
	<span class="n">debug_dump</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">act_len</span><span class="p">,</span> <span class="n">deb_xfer</span><span class="p">);</span>

	<span class="cm">/* check status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;command failed:%d&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read request, copy returned data to return buf */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">ACK_HDR_LEN</span><span class="p">],</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>

<span class="nl">error_unlock:</span>
<span class="nl">exit_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">af9015_usb_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_ctrl_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">req_t</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">af9015_rw_udev</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_write_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">req_t</span> <span class="n">req</span> <span class="o">=</span> <span class="p">{</span><span class="n">WRITE_MEMORY</span><span class="p">,</span> <span class="n">AF9015_I2C_DEMOD</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
		<span class="n">val</span><span class="p">};</span>
	<span class="k">return</span> <span class="n">af9015_ctrl_msg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">af9015_write_regs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_read_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">req_t</span> <span class="n">req</span> <span class="o">=</span> <span class="p">{</span><span class="n">READ_MEMORY</span><span class="p">,</span> <span class="n">AF9015_I2C_DEMOD</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
		<span class="n">val</span><span class="p">};</span>
	<span class="k">return</span> <span class="n">af9015_ctrl_msg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">af9015_read_regs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_write_reg_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">req_t</span> <span class="n">req</span> <span class="o">=</span> <span class="p">{</span><span class="n">WRITE_I2C</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">af9015_af9013_config</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">i2c_addr</span> <span class="o">||</span>
	    <span class="n">addr</span> <span class="o">==</span> <span class="n">af9015_af9013_config</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">i2c_addr</span><span class="p">)</span>
		<span class="n">req</span><span class="p">.</span><span class="n">addr_len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">af9015_ctrl_msg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_read_reg_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">req_t</span> <span class="n">req</span> <span class="o">=</span> <span class="p">{</span><span class="n">READ_I2C</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">af9015_af9013_config</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">i2c_addr</span> <span class="o">||</span>
	    <span class="n">addr</span> <span class="o">==</span> <span class="n">af9015_af9013_config</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">i2c_addr</span><span class="p">)</span>
		<span class="n">req</span><span class="p">.</span><span class="n">addr_len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">af9015_ctrl_msg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_i2c_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[],</span>
	<span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">mbox</span><span class="p">),</span> <span class="n">addr_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_t</span> <span class="n">req</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">The bus lock is needed because there is two tuners both using same I2C-address.</span>
<span class="cm">Due to that the only way to select correct tuner is use demodulator I2C-gate.</span>

<span class="cm">................................................</span>
<span class="cm">. AF9015 includes integrated AF9013 demodulator.</span>
<span class="cm">. ____________                   ____________  .                ____________</span>
<span class="cm">.|     uC     |                 |   demod    | .               |    tuner   |</span>
<span class="cm">.|------------|                 |------------| .               |------------|</span>
<span class="cm">.|   AF9015   |                 |  AF9013/5  | .               |   MXL5003  |</span>
<span class="cm">.|            |--+----I2C-------|-----/ -----|-.-----I2C-------|            |</span>
<span class="cm">.|            |  |              | addr 0x38  | .               |  addr 0xc6 |</span>
<span class="cm">.|____________|  |              |____________| .               |____________|</span>
<span class="cm">.................|..............................</span>
<span class="cm">		 |               ____________                   ____________</span>
<span class="cm">		 |              |   demod    |                 |    tuner   |</span>
<span class="cm">		 |              |------------|                 |------------|</span>
<span class="cm">		 |              |   AF9013   |                 |   MXL5003  |</span>
<span class="cm">		 +----I2C-------|-----/ -----|-------I2C-------|            |</span>
<span class="cm">				| addr 0x3a  |                 |  addr 0xc6 |</span>
<span class="cm">				|____________|                 |____________|</span>
<span class="cm">*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">==</span> <span class="n">af9015_af9013_config</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">i2c_addr</span> <span class="o">||</span>
		    <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">==</span> <span class="n">af9015_af9013_config</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">i2c_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">addr</span> <span class="o">+=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">mbox</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">addr_len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">addr_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* mbox is don&#39;t care in that case */</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">61</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">==</span> <span class="n">af9015_af9013_config</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">i2c_addr</span><span class="p">)</span>
				<span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">READ_MEMORY</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">READ_I2C</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">mbox</span> <span class="o">=</span> <span class="n">mbox</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">addr_len</span> <span class="o">=</span> <span class="n">addr_len</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_ctrl_msg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">61</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">==</span>
				<span class="n">af9015_af9013_config</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">i2c_addr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">READ_I2C</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">mbox</span> <span class="o">=</span> <span class="n">mbox</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">addr_len</span> <span class="o">=</span> <span class="n">addr_len</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_ctrl_msg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">21</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">==</span> <span class="n">af9015_af9013_config</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">i2c_addr</span><span class="p">)</span>
				<span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">WRITE_MEMORY</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">WRITE_I2C</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">mbox</span> <span class="o">=</span> <span class="n">mbox</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">addr_len</span> <span class="o">=</span> <span class="n">addr_len</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="o">-</span><span class="n">addr_len</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="n">addr_len</span><span class="p">];</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_ctrl_msg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">af9015_i2c_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">I2C_FUNC_I2C</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_algorithm</span> <span class="n">af9015_i2c_algo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">master_xfer</span> <span class="o">=</span> <span class="n">af9015_i2c_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">functionality</span> <span class="o">=</span> <span class="n">af9015_i2c_func</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_do_reg_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bit</span><span class="p">,</span> <span class="n">u8</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_read_reg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="n">bit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set bit */</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* clear bit */</span>
		<span class="n">mask</span> <span class="o">^=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">af9015_write_reg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_set_reg_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">af9015_do_reg_bit</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_clear_reg_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">af9015_do_reg_bit</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_init_endpoint</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">frame_size</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">packet_size</span><span class="p">;</span>
	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s: USB speed:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>

	<span class="cm">/* Windows driver uses packet count 21 for USB1.1 and 348 for USB2.0.</span>
<span class="cm">	   We use smaller - about 1/4 from the original, 5 and 87. */</span>
<span class="cp">#define TS_PACKET_SIZE            188</span>

<span class="cp">#define TS_USB20_PACKET_COUNT      87</span>
<span class="cp">#define TS_USB20_FRAME_SIZE       (TS_PACKET_SIZE*TS_USB20_PACKET_COUNT)</span>

<span class="cp">#define TS_USB11_PACKET_COUNT       5</span>
<span class="cp">#define TS_USB11_FRAME_SIZE       (TS_PACKET_SIZE*TS_USB11_PACKET_COUNT)</span>

<span class="cp">#define TS_USB20_MAX_PACKET_SIZE  512</span>
<span class="cp">#define TS_USB11_MAX_PACKET_SIZE   64</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frame_size</span> <span class="o">=</span> <span class="n">TS_USB11_FRAME_SIZE</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
		<span class="n">packet_size</span> <span class="o">=</span> <span class="n">TS_USB11_MAX_PACKET_SIZE</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">frame_size</span> <span class="o">=</span> <span class="n">TS_USB20_FRAME_SIZE</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
		<span class="n">packet_size</span> <span class="o">=</span> <span class="n">TS_USB20_MAX_PACKET_SIZE</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_set_reg_bit</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0xd507</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* assert EP4 reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_set_reg_bit</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0xd50b</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* assert EP5 reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_clear_reg_bit</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0xdd11</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span> <span class="cm">/* disable EP4 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_clear_reg_bit</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0xdd11</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span> <span class="cm">/* disable EP5 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_set_reg_bit</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0xdd11</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span> <span class="cm">/* enable EP4 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">af9015_config</span><span class="p">.</span><span class="n">dual_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_set_reg_bit</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0xdd11</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span> <span class="cm">/* enable EP5 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_clear_reg_bit</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0xdd13</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span> <span class="cm">/* disable EP4 NAK */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">af9015_config</span><span class="p">.</span><span class="n">dual_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_clear_reg_bit</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0xdd13</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span> <span class="cm">/* disable EP5 NAK */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* EP4 xfer length */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_write_reg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0xdd88</span><span class="p">,</span> <span class="n">frame_size</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_write_reg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0xdd89</span><span class="p">,</span> <span class="n">frame_size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="cm">/* EP5 xfer length */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_write_reg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0xdd8a</span><span class="p">,</span> <span class="n">frame_size</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_write_reg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0xdd8b</span><span class="p">,</span> <span class="n">frame_size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_write_reg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0xdd0c</span><span class="p">,</span> <span class="n">packet_size</span><span class="p">);</span> <span class="cm">/* EP4 packet size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_write_reg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0xdd0d</span><span class="p">,</span> <span class="n">packet_size</span><span class="p">);</span> <span class="cm">/* EP5 packet size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_clear_reg_bit</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0xd507</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* negate EP4 reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">af9015_config</span><span class="p">.</span><span class="n">dual_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_clear_reg_bit</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0xd50b</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* negate EP5 reset */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* enable / disable mp2if2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">af9015_config</span><span class="p">.</span><span class="n">dual_mode</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_set_reg_bit</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0xd50b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_clear_reg_bit</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0xd50b</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;endpoint init failed:%d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_copy_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fw_params</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_t</span> <span class="n">req</span> <span class="o">=</span> <span class="p">{</span><span class="n">COPY_FIRMWARE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x5100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fw_params</span><span class="p">),</span>
		<span class="n">fw_params</span> <span class="p">};</span>
	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">fw_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">af9015_config</span><span class="p">.</span><span class="n">firmware_size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">fw_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">af9015_config</span><span class="p">.</span><span class="n">firmware_size</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">fw_params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">af9015_config</span><span class="p">.</span><span class="n">firmware_checksum</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">fw_params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">af9015_config</span><span class="p">.</span><span class="n">firmware_checksum</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* wait 2nd demodulator ready */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_read_reg_i2c</span><span class="p">(</span><span class="n">d</span><span class="p">,</span>
		<span class="n">af9015_af9013_config</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">i2c_addr</span><span class="p">,</span> <span class="mh">0x98be</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s: firmware status:%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="cm">/* fw is running, no need for download */</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="cm">/* set I2C master clock to fast (to speed up firmware copy) */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_write_reg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0xd416</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span> <span class="cm">/* 0x04 * 400ns */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/* copy firmware */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_ctrl_msg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;firmware copy cmd failed:%d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s: firmware copy done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* set I2C master clock back to normal */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_write_reg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0xd416</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span> <span class="cm">/* 0x14 * 400ns */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* request boot firmware */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_write_reg_i2c</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">af9015_af9013_config</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">i2c_addr</span><span class="p">,</span>
		<span class="mh">0xe205</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s: firmware boot cmd status:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="cm">/* check firmware status */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_read_reg_i2c</span><span class="p">(</span><span class="n">d</span><span class="p">,</span>
			<span class="n">af9015_af9013_config</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">i2c_addr</span><span class="p">,</span> <span class="mh">0x98be</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s: firmware status cmd status:%d fw status:%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mh">0x0c</span> <span class="o">||</span> <span class="n">val</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="cm">/* success or fail */</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;firmware did not run&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;firmware boot timeout&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">error:</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* hash (and dump) eeprom */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_eeprom_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">eeprom_size</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_t</span> <span class="n">req</span> <span class="o">=</span> <span class="p">{</span><span class="n">READ_I2C</span><span class="p">,</span> <span class="n">AF9015_I2C_EEPROM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">};</span>

	<span class="n">eeprom</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">eeprom_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="n">eeprom_size</span><span class="p">;</span> <span class="n">reg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_rw_udev</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="n">eeprom</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dvb_usb_af9015_debug</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span> <span class="n">eeprom</span><span class="p">,</span>
				<span class="n">eeprom_size</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">eeprom_size</span> <span class="o">%</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">af9015_config</span><span class="p">.</span><span class="n">eeprom_sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="n">eeprom_size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="n">reg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">af9015_config</span><span class="p">.</span><span class="n">eeprom_sum</span> <span class="o">*=</span> <span class="n">GOLDEN_RATIO_PRIME_32</span><span class="p">;</span>
		<span class="n">af9015_config</span><span class="p">.</span><span class="n">eeprom_sum</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">eeprom</span><span class="p">)[</span><span class="n">reg</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s: eeprom sum=%.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">af9015_config</span><span class="p">.</span><span class="n">eeprom_sum</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">eeprom</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* init RC canary */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_write_reg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x98e9</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_init_endpoint</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_pid_filter_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s: onoff:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">onoff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_set_reg_bit</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xd503</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_clear_reg_bit</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xd503</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_pid_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pid</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s: set pid filter, index %d, pid %x, onoff %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">onoff</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xd505</span><span class="p">,</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xd506</span><span class="p">,</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="p">((</span><span class="n">index</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_write_reg</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xd504</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_download_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">remaining</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_t</span> <span class="n">req</span> <span class="o">=</span> <span class="p">{</span><span class="n">DOWNLOAD_FIRMWARE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
	<span class="n">u16</span> <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* calc checksum */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">checksum</span> <span class="o">+=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">af9015_config</span><span class="p">.</span><span class="n">firmware_size</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">af9015_config</span><span class="p">.</span><span class="n">firmware_checksum</span> <span class="o">=</span> <span class="n">checksum</span><span class="p">;</span>

	<span class="cp">#define FW_ADDR 0x5100 </span><span class="cm">/* firmware start address */</span><span class="cp"></span>
	<span class="cp">#define LEN_MAX 55 </span><span class="cm">/* max packet size */</span><span class="cp"></span>
	<span class="k">for</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">remaining</span> <span class="o">-=</span> <span class="n">LEN_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">remaining</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">LEN_MAX</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">LEN_MAX</span><span class="p">;</span>

		<span class="n">req</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">req</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">remaining</span><span class="p">];</span>
		<span class="n">req</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">FW_ADDR</span> <span class="o">+</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">remaining</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_rw_udev</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;firmware download failed:%d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* firmware loaded, request boot */</span>
	<span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">BOOT</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_rw_udev</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;firmware boot failed:%d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">af9015_rc_setup</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">rc_codes</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">af9015_rc_setup_match</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">af9015_rc_setup</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">rc_codes</span><span class="p">;</span> <span class="n">table</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">rc_codes</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">af9015_rc_setup</span> <span class="n">af9015_rc_setup_modparam</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">AF9015_REMOTE_A_LINK_DTU_M</span><span class="p">,</span> <span class="n">RC_MAP_ALINK_DTU_M</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AF9015_REMOTE_MSI_DIGIVOX_MINI_II_V3</span><span class="p">,</span> <span class="n">RC_MAP_MSI_DIGIVOX_II</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AF9015_REMOTE_MYGICTV_U718</span><span class="p">,</span> <span class="n">RC_MAP_TOTAL_MEDIA_IN_HAND</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AF9015_REMOTE_DIGITTRADE_DVB_T</span><span class="p">,</span> <span class="n">RC_MAP_DIGITTRADE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AF9015_REMOTE_AVERMEDIA_KS</span><span class="p">,</span> <span class="n">RC_MAP_AVERMEDIA_RM_KS</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">af9015_rc_setup</span> <span class="n">af9015_rc_setup_hashes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0xb8feb708</span><span class="p">,</span> <span class="n">RC_MAP_MSI_DIGIVOX_II</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xa3703d00</span><span class="p">,</span> <span class="n">RC_MAP_ALINK_DTU_M</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x9b7dc64e</span><span class="p">,</span> <span class="n">RC_MAP_TOTAL_MEDIA_IN_HAND</span> <span class="p">},</span> <span class="cm">/* MYGICTV U718 */</span>
	<span class="p">{</span> <span class="mh">0x5d49e3db</span><span class="p">,</span> <span class="n">RC_MAP_DIGITTRADE</span> <span class="p">},</span> <span class="cm">/* LC-Power LC-USB-DVBT */</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">af9015_rc_setup</span> <span class="n">af9015_rc_setup_usbids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">USB_VID_TERRATEC</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">USB_PID_TERRATEC_CINERGY_T_STICK_RC</span><span class="p">,</span>
		<span class="n">RC_MAP_TERRATEC_SLIM_2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">USB_VID_TERRATEC</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">USB_PID_TERRATEC_CINERGY_T_STICK_DUAL_RC</span><span class="p">,</span>
		<span class="n">RC_MAP_TERRATEC_SLIM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">USB_VID_VISIONPLUS</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">USB_PID_AZUREWAVE_AD_TU700</span><span class="p">,</span>
		<span class="n">RC_MAP_AZUREWAVE_AD_TU700</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">USB_VID_VISIONPLUS</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">USB_PID_TINYTWIN</span><span class="p">,</span>
		<span class="n">RC_MAP_AZUREWAVE_AD_TU700</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">USB_VID_MSI_2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">USB_PID_MSI_DIGI_VOX_MINI_III</span><span class="p">,</span>
		<span class="n">RC_MAP_MSI_DIGIVOX_III</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">USB_VID_MSI_2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">USB_PID_MSI_DIGIVOX_DUO</span><span class="p">,</span>
		<span class="n">RC_MAP_MSI_DIGIVOX_III</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">USB_VID_LEADTEK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">USB_PID_WINFAST_DTV_DONGLE_GOLD</span><span class="p">,</span>
		<span class="n">RC_MAP_LEADTEK_Y04G0051</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">USB_VID_LEADTEK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">USB_PID_WINFAST_DTV2000DS</span><span class="p">,</span>
		<span class="n">RC_MAP_LEADTEK_Y04G0051</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">USB_VID_AVERMEDIA</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">USB_PID_AVERMEDIA_VOLAR_X</span><span class="p">,</span>
		<span class="n">RC_MAP_AVERMEDIA_M135A</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">USB_VID_AFATECH</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">USB_PID_TREKSTOR_DVBT</span><span class="p">,</span>
		<span class="n">RC_MAP_TREKSTOR</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">USB_VID_KWORLD_2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">USB_PID_TINYTWIN_2</span><span class="p">,</span>
		<span class="n">RC_MAP_DIGITALNOW_TINYTWIN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">USB_VID_GTEK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">USB_PID_TINYTWIN_3</span><span class="p">,</span>
		<span class="n">RC_MAP_DIGITALNOW_TINYTWIN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">(</span><span class="n">USB_VID_KWORLD_2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">USB_PID_SVEON_STV22</span><span class="p">,</span>
		<span class="n">RC_MAP_MSI_DIGIVOX_III</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">af9015_set_remote_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="o">*</span><span class="n">props</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">vid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">);</span>

	<span class="cm">/* try to load remote based module param */</span>
	<span class="n">props</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rc_codes</span> <span class="o">=</span> <span class="n">af9015_rc_setup_match</span><span class="p">(</span>
		<span class="n">dvb_usb_af9015_remote</span><span class="p">,</span> <span class="n">af9015_rc_setup_modparam</span><span class="p">);</span>

	<span class="cm">/* try to load remote based eeprom hash */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">props</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rc_codes</span><span class="p">)</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rc_codes</span> <span class="o">=</span> <span class="n">af9015_rc_setup_match</span><span class="p">(</span>
			<span class="n">af9015_config</span><span class="p">.</span><span class="n">eeprom_sum</span><span class="p">,</span> <span class="n">af9015_rc_setup_hashes</span><span class="p">);</span>

	<span class="cm">/* try to load remote based USB ID */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">props</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rc_codes</span><span class="p">)</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rc_codes</span> <span class="o">=</span> <span class="n">af9015_rc_setup_match</span><span class="p">(</span>
			<span class="p">(</span><span class="n">vid</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">pid</span><span class="p">,</span> <span class="n">af9015_rc_setup_usbids</span><span class="p">);</span>

	<span class="cm">/* try to load remote based USB iManufacturer string */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">props</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rc_codes</span> <span class="o">&amp;&amp;</span> <span class="n">vid</span> <span class="o">==</span> <span class="n">USB_VID_AFATECH</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check USB manufacturer and product strings and try</span>
<span class="cm">		   to determine correct remote in case of chip vendor</span>
<span class="cm">		   reference IDs are used.</span>
<span class="cm">		   DO NOT ADD ANYTHING NEW HERE. Use hashes instead. */</span>
		<span class="kt">char</span> <span class="n">manufacturer</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">manufacturer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">manufacturer</span><span class="p">));</span>
		<span class="n">usb_string</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">iManufacturer</span><span class="p">,</span>
			<span class="n">manufacturer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">manufacturer</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;MSI&quot;</span><span class="p">,</span> <span class="n">manufacturer</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* iManufacturer 1 MSI</span>
<span class="cm">			   iProduct      2 MSI K-VOX */</span>
			<span class="n">props</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rc_codes</span> <span class="o">=</span> <span class="n">af9015_rc_setup_match</span><span class="p">(</span>
				<span class="n">AF9015_REMOTE_MSI_DIGIVOX_MINI_II_V3</span><span class="p">,</span>
				<span class="n">af9015_rc_setup_modparam</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* finally load &quot;empty&quot; just for leaving IR receiver enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">props</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rc_codes</span><span class="p">)</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rc_codes</span> <span class="o">=</span> <span class="n">RC_MAP_EMPTY</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_read_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_t</span> <span class="n">req</span> <span class="o">=</span> <span class="p">{</span><span class="n">READ_I2C</span><span class="p">,</span> <span class="n">AF9015_I2C_EEPROM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">};</span>

	<span class="cm">/* IR remote controller */</span>
	<span class="n">req</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">AF9015_EEPROM_IR_MODE</span><span class="p">;</span>
	<span class="cm">/* first message will timeout often due to possible hw bug */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_rw_udev</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_eeprom_hash</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s: IR mode=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">af9015_properties_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">AF9015_IR_MODE_DISABLED</span><span class="p">)</span>
			<span class="n">af9015_properties</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rc_codes</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">af9015_set_remote_config</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">af9015_properties</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* TS mode - one or two receivers */</span>
	<span class="n">req</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">AF9015_EEPROM_TS_MODE</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_rw_udev</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">af9015_config</span><span class="p">.</span><span class="n">dual_mode</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s: TS mode=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">af9015_config</span><span class="p">.</span><span class="n">dual_mode</span><span class="p">);</span>

	<span class="cm">/* Set adapter0 buffer size according to USB port speed, adapter1 buffer</span>
<span class="cm">	   size can be static because it is enabled only USB2.0 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">af9015_properties_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* USB1.1 set smaller buffersize and disable 2nd adapter */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">USB_SPEED_FULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">af9015_properties</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adapter</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stream</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bulk</span><span class="p">.</span><span class="n">buffersize</span>
				<span class="o">=</span> <span class="n">TS_USB11_FRAME_SIZE</span><span class="p">;</span>
			<span class="cm">/* disable 2nd adapter because we don&#39;t have</span>
<span class="cm">			   PID-filters */</span>
			<span class="n">af9015_config</span><span class="p">.</span><span class="n">dual_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">af9015_properties</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adapter</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stream</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bulk</span><span class="p">.</span><span class="n">buffersize</span>
				<span class="o">=</span> <span class="n">TS_USB20_FRAME_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">af9015_config</span><span class="p">.</span><span class="n">dual_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* read 2nd demodulator I2C address */</span>
		<span class="n">req</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">AF9015_EEPROM_DEMOD2_I2C</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_rw_udev</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">af9015_af9013_config</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">i2c_addr</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

		<span class="cm">/* enable 2nd adapter */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">af9015_properties_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">af9015_properties</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num_adapters</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		 <span class="cm">/* disable 2nd adapter */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">af9015_properties_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">af9015_properties</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num_adapters</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">af9015_properties</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">num_adapters</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">AF9015_EEPROM_OFFSET</span><span class="p">;</span>
		<span class="cm">/* xtal */</span>
		<span class="n">req</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">AF9015_EEPROM_XTAL_TYPE1</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_rw_udev</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">af9015_af9013_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">28800000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">af9015_af9013_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">20480000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">af9015_af9013_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">28000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">af9015_af9013_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">25000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">};</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s: [%d] xtal=%d set clock=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			<span class="n">val</span><span class="p">,</span> <span class="n">af9015_af9013_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clock</span><span class="p">);</span>

		<span class="cm">/* IF frequency */</span>
		<span class="n">req</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">AF9015_EEPROM_IF1H</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_rw_udev</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">af9015_af9013_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">if_frequency</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">req</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">AF9015_EEPROM_IF1L</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_rw_udev</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="n">af9015_af9013_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">if_frequency</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">af9015_af9013_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">if_frequency</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s: [%d] IF frequency=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			<span class="n">af9015_af9013_config</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">if_frequency</span><span class="p">);</span>

		<span class="cm">/* MT2060 IF1 */</span>
		<span class="n">req</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">AF9015_EEPROM_MT2060_IF1H</span>  <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_rw_udev</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">af9015_config</span><span class="p">.</span><span class="n">mt2060_if1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">req</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">AF9015_EEPROM_MT2060_IF1L</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_rw_udev</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">af9015_config</span><span class="p">.</span><span class="n">mt2060_if1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s: [%d] MT2060 IF1=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			<span class="n">af9015_config</span><span class="p">.</span><span class="n">mt2060_if1</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="cm">/* tuner */</span>
		<span class="n">req</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span>  <span class="n">AF9015_EEPROM_TUNER_ID1</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_rw_udev</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AF9013_TUNER_ENV77H11D5</span>:
		<span class="k">case</span> <span class="n">AF9013_TUNER_MT2060</span>:
		<span class="k">case</span> <span class="n">AF9013_TUNER_QT1010</span>:
		<span class="k">case</span> <span class="n">AF9013_TUNER_UNKNOWN</span>:
		<span class="k">case</span> <span class="n">AF9013_TUNER_MT2060_2</span>:
		<span class="k">case</span> <span class="n">AF9013_TUNER_TDA18271</span>:
		<span class="k">case</span> <span class="n">AF9013_TUNER_QT1010A</span>:
		<span class="k">case</span> <span class="n">AF9013_TUNER_TDA18218</span>:
			<span class="n">af9015_af9013_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">spec_inv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AF9013_TUNER_MXL5003D</span>:
		<span class="k">case</span> <span class="n">AF9013_TUNER_MXL5005D</span>:
		<span class="k">case</span> <span class="n">AF9013_TUNER_MXL5005R</span>:
		<span class="k">case</span> <span class="n">AF9013_TUNER_MXL5007T</span>:
			<span class="n">af9015_af9013_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">spec_inv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AF9013_TUNER_MC44S803</span>:
			<span class="n">af9015_af9013_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gpio</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">AF9013_GPIO_LO</span><span class="p">;</span>
			<span class="n">af9015_af9013_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">spec_inv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">warn</span><span class="p">(</span><span class="s">&quot;tuner id=%d not supported, please report!&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">};</span>

		<span class="n">af9015_af9013_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tuner</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s: [%d] tuner id=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;eeprom read failed=%d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* AverMedia AVerTV Volar Black HD (A850) device have bad EEPROM</span>
<span class="cm">	   content :-( Override some wrong values here. Ditto for the</span>
<span class="cm">	   AVerTV Red HD+ (A850T) device. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">)</span> <span class="o">==</span> <span class="n">USB_VID_AVERMEDIA</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">USB_PID_AVERMEDIA_A850</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">USB_PID_AVERMEDIA_A850T</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s: AverMedia A850: overriding config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="cm">/* disable dual mode */</span>
		<span class="n">af9015_config</span><span class="p">.</span><span class="n">dual_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		 <span class="cm">/* disable 2nd adapter */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">af9015_properties_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">af9015_properties</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num_adapters</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* set correct IF */</span>
		<span class="n">af9015_af9013_config</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">if_frequency</span> <span class="o">=</span> <span class="mi">4570000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_identify_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="o">*</span><span class="n">props</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">dvb_usb_device_description</span> <span class="o">**</span><span class="n">desc</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="o">*</span><span class="n">cold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_t</span> <span class="n">req</span> <span class="o">=</span> <span class="p">{</span><span class="n">GET_CONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">};</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_rw_udev</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s: reply:%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reply</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">cold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_rc_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">af9015_state</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>

	<span class="cm">/* read registers needed to detect remote controller code */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_read_regs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x98d9</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* If any of these are non-zero, assume invalid data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Check for repeat of previous code */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rc_repeat</span> <span class="o">!=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
					<span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rc_last</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">deb_rc</span><span class="p">(</span><span class="s">&quot;%s: key repeated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc_keydown</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rc_keycode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rc_repeat</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Only process key if canary killed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deb_rc</span><span class="p">(</span><span class="s">&quot;%s: key pressed %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>

		<span class="cm">/* Reset the canary */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_write_reg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x98e9</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* Remember this key */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rc_last</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">~</span><span class="n">buf</span><span class="p">[</span><span class="mi">15</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">~</span><span class="n">buf</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span> <span class="p">{</span>
				<span class="cm">/* NEC */</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rc_keycode</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* NEC extended*/</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rc_keycode</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
					<span class="n">buf</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* 32 bit NEC */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rc_keycode</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
					<span class="n">buf</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">rc_keydown</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rc_keycode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">deb_rc</span><span class="p">(</span><span class="s">&quot;%s: no key press</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="cm">/* Invalidate last keypress */</span>
		<span class="cm">/* Not really needed, but helps with debug */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rc_last</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rc_last</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rc_repeat</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;%s: failed:%d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* override demod callbacks for resource locking */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_af9013_set_frontend</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">af9015_state</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">set_frontend</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">](</span><span class="n">fe</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* override demod callbacks for resource locking */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_af9013_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="n">fe_status_t</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">af9015_state</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">read_status</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">](</span><span class="n">fe</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* override demod callbacks for resource locking */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_af9013_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">af9015_state</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">](</span><span class="n">fe</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* override demod callbacks for resource locking */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_af9013_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">af9015_state</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sleep</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">](</span><span class="n">fe</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* override tuner callbacks for resource locking */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_tuner_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">af9015_state</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tuner_init</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">](</span><span class="n">fe</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* override tuner callbacks for resource locking */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_tuner_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">af9015_state</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tuner_sleep</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">](</span><span class="n">fe</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_af9013_frontend_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">af9015_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* copy firmware to 2nd demodulator */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">af9015_config</span><span class="p">.</span><span class="n">dual_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_copy_firmware</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span><span class="p">(</span><span class="s">&quot;firmware copy to 2nd frontend &quot;</span> \
					<span class="s">&quot;failed, will disable it&quot;</span><span class="p">);</span>
				<span class="n">af9015_config</span><span class="p">.</span><span class="n">dual_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* attach demodulator */</span>
	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">af9013_attach</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">af9015_af9013_config</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * AF9015 firmware does not like if it gets interrupted by I2C adapter</span>
<span class="cm">	 * request on some critical phases. During normal operation I2C adapter</span>
<span class="cm">	 * is used only 2nd demodulator and tuner on dual tuner devices.</span>
<span class="cm">	 * Override demodulator callbacks and use mutex for limit access to</span>
<span class="cm">	 * those &quot;critical&quot; paths to keep AF9015 happy.</span>
<span class="cm">	 * Note: we abuse unused usb_mutex here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">set_frontend</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_frontend</span><span class="p">;</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_frontend</span> <span class="o">=</span>
			<span class="n">af9015_af9013_set_frontend</span><span class="p">;</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">read_status</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_status</span><span class="p">;</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_status</span> <span class="o">=</span>
			<span class="n">af9015_af9013_read_status</span><span class="p">;</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">init</span><span class="p">;</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">af9015_af9013_init</span><span class="p">;</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">sleep</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">sleep</span><span class="p">;</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">af9015_af9013_sleep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mt2060_config</span> <span class="n">af9015_mt2060_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">i2c_address</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clock_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qt1010_config</span> <span class="n">af9015_qt1010_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">i2c_address</span> <span class="o">=</span> <span class="mh">0xc4</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tda18271_config</span> <span class="n">af9015_tda18271_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gate</span> <span class="o">=</span> <span class="n">TDA18271_GATE_DIGITAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">small_i2c</span> <span class="o">=</span> <span class="n">TDA18271_16_BYTE_CHUNK_INIT</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mxl5005s_config</span> <span class="n">af9015_mxl5003_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">i2c_address</span>     <span class="o">=</span> <span class="mh">0xc6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">if_freq</span>         <span class="o">=</span> <span class="n">IF_FREQ_4570000HZ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xtal_freq</span>       <span class="o">=</span> <span class="n">CRYSTAL_FREQ_16000000HZ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc_mode</span>        <span class="o">=</span> <span class="n">MXL_SINGLE_AGC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tracking_filter</span> <span class="o">=</span> <span class="n">MXL_TF_DEFAULT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rssi_enable</span>     <span class="o">=</span> <span class="n">MXL_RSSI_ENABLE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cap_select</span>      <span class="o">=</span> <span class="n">MXL_CAP_SEL_ENABLE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">div_out</span>         <span class="o">=</span> <span class="n">MXL_DIV_OUT_4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clock_out</span>       <span class="o">=</span> <span class="n">MXL_CLOCK_OUT_DISABLE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">output_load</span>     <span class="o">=</span> <span class="n">MXL5005S_IF_OUTPUT_LOAD_200_OHM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">top</span>		 <span class="o">=</span> <span class="n">MXL5005S_TOP_25P2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mod_mode</span>        <span class="o">=</span> <span class="n">MXL_DIGITAL_MODE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">if_mode</span>         <span class="o">=</span> <span class="n">MXL_ZERO_IF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">AgcMasterByte</span>   <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mxl5005s_config</span> <span class="n">af9015_mxl5005_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">i2c_address</span>     <span class="o">=</span> <span class="mh">0xc6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">if_freq</span>         <span class="o">=</span> <span class="n">IF_FREQ_4570000HZ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xtal_freq</span>       <span class="o">=</span> <span class="n">CRYSTAL_FREQ_16000000HZ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc_mode</span>        <span class="o">=</span> <span class="n">MXL_SINGLE_AGC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tracking_filter</span> <span class="o">=</span> <span class="n">MXL_TF_OFF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rssi_enable</span>     <span class="o">=</span> <span class="n">MXL_RSSI_ENABLE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cap_select</span>      <span class="o">=</span> <span class="n">MXL_CAP_SEL_ENABLE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">div_out</span>         <span class="o">=</span> <span class="n">MXL_DIV_OUT_4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clock_out</span>       <span class="o">=</span> <span class="n">MXL_CLOCK_OUT_DISABLE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">output_load</span>     <span class="o">=</span> <span class="n">MXL5005S_IF_OUTPUT_LOAD_200_OHM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">top</span>		 <span class="o">=</span> <span class="n">MXL5005S_TOP_25P2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mod_mode</span>        <span class="o">=</span> <span class="n">MXL_DIGITAL_MODE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">if_mode</span>         <span class="o">=</span> <span class="n">MXL_ZERO_IF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">AgcMasterByte</span>   <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mc44s803_config</span> <span class="n">af9015_mc44s803_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">i2c_address</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dig_out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tda18218_config</span> <span class="n">af9015_tda18218_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">i2c_address</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">i2c_wr_max</span> <span class="o">=</span> <span class="mi">21</span><span class="p">,</span> <span class="cm">/* max wr bytes AF9015 I2C adap can handle at once */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mxl5007t_config</span> <span class="n">af9015_mxl5007t_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xtal_freq_hz</span> <span class="o">=</span> <span class="n">MxL_XTAL_24_MHZ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">if_freq_hz</span> <span class="o">=</span> <span class="n">MxL_IF_4_57_MHZ</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_tuner_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">af9015_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">af9015_af9013_config</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">].</span><span class="n">tuner</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AF9013_TUNER_MT2060</span>:
	<span class="k">case</span> <span class="n">AF9013_TUNER_MT2060_2</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">mt2060_attach</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">af9015_mt2060_config</span><span class="p">,</span>
			<span class="n">af9015_config</span><span class="p">.</span><span class="n">mt2060_if1</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">])</span>
			<span class="o">==</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AF9013_TUNER_QT1010</span>:
	<span class="k">case</span> <span class="n">AF9013_TUNER_QT1010A</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">qt1010_attach</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">af9015_qt1010_config</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AF9013_TUNER_TDA18271</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda18271_attach</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">af9015_tda18271_config</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AF9013_TUNER_TDA18218</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda18218_attach</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">af9015_tda18218_config</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AF9013_TUNER_MXL5003D</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">mxl5005s_attach</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">af9015_mxl5003_config</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AF9013_TUNER_MXL5005D</span>:
	<span class="k">case</span> <span class="n">AF9013_TUNER_MXL5005R</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">mxl5005s_attach</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">af9015_mxl5005_config</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AF9013_TUNER_ENV77H11D5</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">dvb_pll_attach</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
			<span class="n">DVB_PLL_TDA665X</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AF9013_TUNER_MC44S803</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">mc44s803_attach</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">af9015_mc44s803_config</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AF9013_TUNER_MXL5007T</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">mxl5007t_attach</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
			<span class="mh">0xc0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">af9015_mxl5007t_config</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AF9013_TUNER_UNKNOWN</span>:
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;Unknown tuner id:%d&quot;</span><span class="p">,</span>
			<span class="n">af9015_af9013_config</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">].</span><span class="n">tuner</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_init</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">init</span><span class="p">;</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">af9015_tuner_init</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">sleep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">tuner_sleep</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">sleep</span><span class="p">;</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">tuner_ops</span><span class="p">.</span><span class="n">sleep</span> <span class="o">=</span> <span class="n">af9015_tuner_sleep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">af9015_usb_table_entry</span> <span class="p">{</span>
	<span class="n">AFATECH_9015</span><span class="p">,</span>
	<span class="n">AFATECH_9016</span><span class="p">,</span>
	<span class="n">WINFAST_DTV_GOLD</span><span class="p">,</span>
	<span class="n">PINNACLE_PCTV_71E</span><span class="p">,</span>
	<span class="n">KWORLD_PLUSTV_399U</span><span class="p">,</span>
	<span class="n">TINYTWIN</span><span class="p">,</span>
	<span class="n">AZUREWAVE_TU700</span><span class="p">,</span>
	<span class="n">TERRATEC_AF9015</span><span class="p">,</span>
	<span class="n">KWORLD_PLUSTV_PC160</span><span class="p">,</span>
	<span class="n">AVERTV_VOLAR_X</span><span class="p">,</span>
	<span class="n">XTENSIONS_380U</span><span class="p">,</span>
	<span class="n">MSI_DIGIVOX_DUO</span><span class="p">,</span>
	<span class="n">AVERTV_VOLAR_X_REV2</span><span class="p">,</span>
	<span class="n">TELESTAR_STARSTICK_2</span><span class="p">,</span>
	<span class="n">AVERMEDIA_A309_USB</span><span class="p">,</span>
	<span class="n">MSI_DIGIVOX_MINI_III</span><span class="p">,</span>
	<span class="n">KWORLD_E396</span><span class="p">,</span>
	<span class="n">KWORLD_E39B</span><span class="p">,</span>
	<span class="n">KWORLD_E395</span><span class="p">,</span>
	<span class="n">TREKSTOR_DVBT</span><span class="p">,</span>
	<span class="n">AVERTV_A850</span><span class="p">,</span>
	<span class="n">AVERTV_A805</span><span class="p">,</span>
	<span class="n">CONCEPTRONIC_CTVDIGRCU</span><span class="p">,</span>
	<span class="n">KWORLD_MC810</span><span class="p">,</span>
	<span class="n">GENIUS_TVGO_DVB_T03</span><span class="p">,</span>
	<span class="n">KWORLD_399U_2</span><span class="p">,</span>
	<span class="n">KWORLD_PC160_T</span><span class="p">,</span>
	<span class="n">SVEON_STV20</span><span class="p">,</span>
	<span class="n">TINYTWIN_2</span><span class="p">,</span>
	<span class="n">WINFAST_DTV2000DS</span><span class="p">,</span>
	<span class="n">KWORLD_UB383_T</span><span class="p">,</span>
	<span class="n">KWORLD_E39A</span><span class="p">,</span>
	<span class="n">AVERMEDIA_A815M</span><span class="p">,</span>
	<span class="n">CINERGY_T_STICK_RC</span><span class="p">,</span>
	<span class="n">CINERGY_T_DUAL_RC</span><span class="p">,</span>
	<span class="n">AVERTV_A850T</span><span class="p">,</span>
	<span class="n">TINYTWIN_3</span><span class="p">,</span>
	<span class="n">SVEON_STV22</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">af9015_usb_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">AFATECH_9015</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_AFATECH</span><span class="p">,</span> <span class="n">USB_PID_AFATECH_AF9015_9015</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">AFATECH_9016</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_AFATECH</span><span class="p">,</span> <span class="n">USB_PID_AFATECH_AF9015_9016</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">WINFAST_DTV_GOLD</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_LEADTEK</span><span class="p">,</span> <span class="n">USB_PID_WINFAST_DTV_DONGLE_GOLD</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">PINNACLE_PCTV_71E</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_PINNACLE</span><span class="p">,</span> <span class="n">USB_PID_PINNACLE_PCTV71E</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">KWORLD_PLUSTV_399U</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_KWORLD_2</span><span class="p">,</span> <span class="n">USB_PID_KWORLD_399U</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">TINYTWIN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_VISIONPLUS</span><span class="p">,</span> <span class="n">USB_PID_TINYTWIN</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">AZUREWAVE_TU700</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_VISIONPLUS</span><span class="p">,</span> <span class="n">USB_PID_AZUREWAVE_AD_TU700</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">TERRATEC_AF9015</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_TERRATEC</span><span class="p">,</span>
				<span class="n">USB_PID_TERRATEC_CINERGY_T_USB_XE_REV2</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">KWORLD_PLUSTV_PC160</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_KWORLD_2</span><span class="p">,</span> <span class="n">USB_PID_KWORLD_PC160_2T</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">AVERTV_VOLAR_X</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_AVERMEDIA</span><span class="p">,</span> <span class="n">USB_PID_AVERMEDIA_VOLAR_X</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">XTENSIONS_380U</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_XTENSIONS</span><span class="p">,</span> <span class="n">USB_PID_XTENSIONS_XD_380</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">MSI_DIGIVOX_DUO</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_MSI_2</span><span class="p">,</span> <span class="n">USB_PID_MSI_DIGIVOX_DUO</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">AVERTV_VOLAR_X_REV2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_AVERMEDIA</span><span class="p">,</span> <span class="n">USB_PID_AVERMEDIA_VOLAR_X_2</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">TELESTAR_STARSTICK_2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_TELESTAR</span><span class="p">,</span>  <span class="n">USB_PID_TELESTAR_STARSTICK_2</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">AVERMEDIA_A309_USB</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_AVERMEDIA</span><span class="p">,</span> <span class="n">USB_PID_AVERMEDIA_A309</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">MSI_DIGIVOX_MINI_III</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_MSI_2</span><span class="p">,</span> <span class="n">USB_PID_MSI_DIGI_VOX_MINI_III</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">KWORLD_E396</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_KWORLD_2</span><span class="p">,</span> <span class="n">USB_PID_KWORLD_395U</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">KWORLD_E39B</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_KWORLD_2</span><span class="p">,</span> <span class="n">USB_PID_KWORLD_395U_2</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">KWORLD_E395</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_KWORLD_2</span><span class="p">,</span> <span class="n">USB_PID_KWORLD_395U_3</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">TREKSTOR_DVBT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_AFATECH</span><span class="p">,</span> <span class="n">USB_PID_TREKSTOR_DVBT</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">AVERTV_A850</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_AVERMEDIA</span><span class="p">,</span> <span class="n">USB_PID_AVERMEDIA_A850</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">AVERTV_A805</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_AVERMEDIA</span><span class="p">,</span> <span class="n">USB_PID_AVERMEDIA_A805</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">CONCEPTRONIC_CTVDIGRCU</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_KWORLD_2</span><span class="p">,</span> <span class="n">USB_PID_CONCEPTRONIC_CTVDIGRCU</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">KWORLD_MC810</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_KWORLD_2</span><span class="p">,</span> <span class="n">USB_PID_KWORLD_MC810</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">GENIUS_TVGO_DVB_T03</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_KYE</span><span class="p">,</span> <span class="n">USB_PID_GENIUS_TVGO_DVB_T03</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">KWORLD_399U_2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_KWORLD_2</span><span class="p">,</span> <span class="n">USB_PID_KWORLD_399U_2</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">KWORLD_PC160_T</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_KWORLD_2</span><span class="p">,</span> <span class="n">USB_PID_KWORLD_PC160_T</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">SVEON_STV20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_KWORLD_2</span><span class="p">,</span> <span class="n">USB_PID_SVEON_STV20</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">TINYTWIN_2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_KWORLD_2</span><span class="p">,</span> <span class="n">USB_PID_TINYTWIN_2</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">WINFAST_DTV2000DS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_LEADTEK</span><span class="p">,</span> <span class="n">USB_PID_WINFAST_DTV2000DS</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">KWORLD_UB383_T</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_KWORLD_2</span><span class="p">,</span> <span class="n">USB_PID_KWORLD_UB383_T</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">KWORLD_E39A</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_KWORLD_2</span><span class="p">,</span> <span class="n">USB_PID_KWORLD_395U_4</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">AVERMEDIA_A815M</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_AVERMEDIA</span><span class="p">,</span> <span class="n">USB_PID_AVERMEDIA_A815M</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">CINERGY_T_STICK_RC</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_TERRATEC</span><span class="p">,</span>
				<span class="n">USB_PID_TERRATEC_CINERGY_T_STICK_RC</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">CINERGY_T_DUAL_RC</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_TERRATEC</span><span class="p">,</span>
				<span class="n">USB_PID_TERRATEC_CINERGY_T_STICK_DUAL_RC</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">AVERTV_A850T</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_AVERMEDIA</span><span class="p">,</span> <span class="n">USB_PID_AVERMEDIA_A850T</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">TINYTWIN_3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_GTEK</span><span class="p">,</span> <span class="n">USB_PID_TINYTWIN_3</span><span class="p">)},</span>
	<span class="p">[</span><span class="n">SVEON_STV22</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_KWORLD_2</span><span class="p">,</span> <span class="n">USB_PID_SVEON_STV22</span><span class="p">)},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">af9015_usb_table</span><span class="p">);</span>

<span class="cp">#define AF9015_RC_INTERVAL 500</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="n">af9015_properties</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_IS_AN_I2C_ADAPTER</span><span class="p">,</span>

		<span class="p">.</span><span class="n">usb_ctrl</span> <span class="o">=</span> <span class="n">DEVICE_SPECIFIC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">download_firmware</span> <span class="o">=</span> <span class="n">af9015_download_firmware</span><span class="p">,</span>
		<span class="p">.</span><span class="n">firmware</span> <span class="o">=</span> <span class="s">&quot;dvb-usb-af9015.fw&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">no_reconnect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

		<span class="p">.</span><span class="n">size_of_priv</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">af9015_state</span><span class="p">),</span>

		<span class="p">.</span><span class="n">num_adapters</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span>
				<span class="p">.</span><span class="n">num_frontends</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
				<span class="p">.</span><span class="n">fe</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">{</span>
						<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_ADAP_HAS_PID_FILTER</span> <span class="o">|</span>
							<span class="n">DVB_USB_ADAP_PID_FILTER_CAN_BE_TURNED_OFF</span><span class="p">,</span>

						<span class="p">.</span><span class="n">pid_filter_count</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
						<span class="p">.</span><span class="n">pid_filter</span>       <span class="o">=</span> <span class="n">af9015_pid_filter</span><span class="p">,</span>
						<span class="p">.</span><span class="n">pid_filter_ctrl</span>  <span class="o">=</span> <span class="n">af9015_pid_filter_ctrl</span><span class="p">,</span>

						<span class="p">.</span><span class="n">frontend_attach</span> <span class="o">=</span> <span class="n">af9015_af9013_frontend_attach</span><span class="p">,</span>
						<span class="p">.</span><span class="n">tuner_attach</span>    <span class="o">=</span> <span class="n">af9015_tuner_attach</span><span class="p">,</span>
						<span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="p">{</span>
							<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_BULK</span><span class="p">,</span>
							<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
							<span class="p">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">,</span>
						<span class="p">},</span>
					<span class="p">}</span>
				<span class="p">},</span>
			<span class="p">},</span>
			<span class="p">{</span>
				<span class="p">.</span><span class="n">num_frontends</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
				<span class="p">.</span><span class="n">fe</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">{</span>
						<span class="p">.</span><span class="n">frontend_attach</span> <span class="o">=</span> <span class="n">af9015_af9013_frontend_attach</span><span class="p">,</span>
						<span class="p">.</span><span class="n">tuner_attach</span>    <span class="o">=</span> <span class="n">af9015_tuner_attach</span><span class="p">,</span>
						<span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="p">{</span>
							<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_BULK</span><span class="p">,</span>
							<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
							<span class="p">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="mh">0x85</span><span class="p">,</span>
							<span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="p">{</span>
								<span class="p">.</span><span class="n">bulk</span> <span class="o">=</span> <span class="p">{</span>
									<span class="p">.</span><span class="n">buffersize</span> <span class="o">=</span> <span class="n">TS_USB20_FRAME_SIZE</span><span class="p">,</span>
								<span class="p">}</span>
							<span class="p">}</span>
						<span class="p">},</span>
					<span class="p">}</span>
				<span class="p">},</span>
			<span class="p">}</span>
		<span class="p">},</span>

		<span class="p">.</span><span class="n">identify_state</span> <span class="o">=</span> <span class="n">af9015_identify_state</span><span class="p">,</span>

		<span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">protocol</span>         <span class="o">=</span> <span class="n">RC_TYPE_NEC</span><span class="p">,</span>
			<span class="p">.</span><span class="n">module_name</span>      <span class="o">=</span> <span class="s">&quot;af9015&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">rc_query</span>         <span class="o">=</span> <span class="n">af9015_rc_query</span><span class="p">,</span>
			<span class="p">.</span><span class="n">rc_interval</span>      <span class="o">=</span> <span class="n">AF9015_RC_INTERVAL</span><span class="p">,</span>
			<span class="p">.</span><span class="n">allowed_protos</span>   <span class="o">=</span> <span class="n">RC_TYPE_NEC</span><span class="p">,</span>
		<span class="p">},</span>

		<span class="p">.</span><span class="n">i2c_algo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">af9015_i2c_algo</span><span class="p">,</span>

		<span class="p">.</span><span class="n">num_device_descs</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="cm">/* check max from dvb-usb.h */</span>
		<span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Afatech AF9015 DVB-T USB2.0 stick&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">AFATECH_9015</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">AFATECH_9016</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Leadtek WinFast DTV Dongle Gold&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">WINFAST_DTV_GOLD</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Pinnacle PCTV 71e&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">PINNACLE_PCTV_71E</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;KWorld PlusTV Dual DVB-T Stick &quot;</span> \
					<span class="s">&quot;(DVB-T 399U)&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">KWORLD_PLUSTV_399U</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">KWORLD_399U_2</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DigitalNow TinyTwin DVB-T Receiver&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">TINYTWIN</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">TINYTWIN_2</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">TINYTWIN_3</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;TwinHan AzureWave AD-TU700(704J)&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">AZUREWAVE_TU700</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;TerraTec Cinergy T USB XE&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">TERRATEC_AF9015</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;KWorld PlusTV Dual DVB-T PCI &quot;</span> \
					<span class="s">&quot;(DVB-T PC160-2T)&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">KWORLD_PLUSTV_PC160</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;AVerMedia AVerTV DVB-T Volar X&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">AVERTV_VOLAR_X</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;TerraTec Cinergy T Stick RC&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">CINERGY_T_STICK_RC</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;TerraTec Cinergy T Stick Dual RC&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">CINERGY_T_DUAL_RC</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;AverMedia AVerTV Red HD+ (A850T)&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">AVERTV_A850T</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span>
		<span class="p">}</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_IS_AN_I2C_ADAPTER</span><span class="p">,</span>

		<span class="p">.</span><span class="n">usb_ctrl</span> <span class="o">=</span> <span class="n">DEVICE_SPECIFIC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">download_firmware</span> <span class="o">=</span> <span class="n">af9015_download_firmware</span><span class="p">,</span>
		<span class="p">.</span><span class="n">firmware</span> <span class="o">=</span> <span class="s">&quot;dvb-usb-af9015.fw&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">no_reconnect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

		<span class="p">.</span><span class="n">size_of_priv</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">af9015_state</span><span class="p">),</span>

		<span class="p">.</span><span class="n">num_adapters</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span>
				<span class="p">.</span><span class="n">num_frontends</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
				<span class="p">.</span><span class="n">fe</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">{</span>
						<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_ADAP_HAS_PID_FILTER</span> <span class="o">|</span>
							<span class="n">DVB_USB_ADAP_PID_FILTER_CAN_BE_TURNED_OFF</span><span class="p">,</span>

						<span class="p">.</span><span class="n">pid_filter_count</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
						<span class="p">.</span><span class="n">pid_filter</span>       <span class="o">=</span> <span class="n">af9015_pid_filter</span><span class="p">,</span>
						<span class="p">.</span><span class="n">pid_filter_ctrl</span>  <span class="o">=</span> <span class="n">af9015_pid_filter_ctrl</span><span class="p">,</span>

						<span class="p">.</span><span class="n">frontend_attach</span> <span class="o">=</span> <span class="n">af9015_af9013_frontend_attach</span><span class="p">,</span>
						<span class="p">.</span><span class="n">tuner_attach</span>    <span class="o">=</span> <span class="n">af9015_tuner_attach</span><span class="p">,</span>
						<span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="p">{</span>
							<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_BULK</span><span class="p">,</span>
							<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
							<span class="p">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">,</span>
						<span class="p">},</span>
					<span class="p">}</span>
				<span class="p">},</span>
			<span class="p">},</span>
			<span class="p">{</span>
				<span class="p">.</span><span class="n">num_frontends</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
				<span class="p">.</span><span class="n">fe</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">{</span>
						<span class="p">.</span><span class="n">frontend_attach</span> <span class="o">=</span> <span class="n">af9015_af9013_frontend_attach</span><span class="p">,</span>
						<span class="p">.</span><span class="n">tuner_attach</span>    <span class="o">=</span> <span class="n">af9015_tuner_attach</span><span class="p">,</span>
						<span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="p">{</span>
							<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_BULK</span><span class="p">,</span>
							<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
							<span class="p">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="mh">0x85</span><span class="p">,</span>
							<span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="p">{</span>
								<span class="p">.</span><span class="n">bulk</span> <span class="o">=</span> <span class="p">{</span>
									<span class="p">.</span><span class="n">buffersize</span> <span class="o">=</span> <span class="n">TS_USB20_FRAME_SIZE</span><span class="p">,</span>
								<span class="p">}</span>
							<span class="p">}</span>
						<span class="p">},</span>
					<span class="p">}</span>
				<span class="p">},</span>
			<span class="p">}</span>
		<span class="p">},</span>

		<span class="p">.</span><span class="n">identify_state</span> <span class="o">=</span> <span class="n">af9015_identify_state</span><span class="p">,</span>

		<span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">protocol</span>         <span class="o">=</span> <span class="n">RC_TYPE_NEC</span><span class="p">,</span>
			<span class="p">.</span><span class="n">module_name</span>      <span class="o">=</span> <span class="s">&quot;af9015&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">rc_query</span>         <span class="o">=</span> <span class="n">af9015_rc_query</span><span class="p">,</span>
			<span class="p">.</span><span class="n">rc_interval</span>      <span class="o">=</span> <span class="n">AF9015_RC_INTERVAL</span><span class="p">,</span>
			<span class="p">.</span><span class="n">allowed_protos</span>   <span class="o">=</span> <span class="n">RC_TYPE_NEC</span><span class="p">,</span>
		<span class="p">},</span>

		<span class="p">.</span><span class="n">i2c_algo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">af9015_i2c_algo</span><span class="p">,</span>

		<span class="p">.</span><span class="n">num_device_descs</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="cm">/* check max from dvb-usb.h */</span>
		<span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Xtensions XD-380&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">XTENSIONS_380U</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MSI DIGIVOX Duo&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">MSI_DIGIVOX_DUO</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Fujitsu-Siemens Slim Mobile USB DVB-T&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">AVERTV_VOLAR_X_REV2</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Telestar Starstick 2&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">TELESTAR_STARSTICK_2</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;AVerMedia A309&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">AVERMEDIA_A309_USB</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MSI Digi VOX mini III&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">MSI_DIGIVOX_MINI_III</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;KWorld USB DVB-T TV Stick II &quot;</span> \
					<span class="s">&quot;(VS-DVB-T 395U)&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">KWORLD_E396</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">KWORLD_E39B</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">KWORLD_E395</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">KWORLD_E39A</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;TrekStor DVB-T USB Stick&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">TREKSTOR_DVBT</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;AverMedia AVerTV Volar Black HD &quot;</span> \
					<span class="s">&quot;(A850)&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">AVERTV_A850</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Sveon STV22 Dual USB DVB-T Tuner HDTV&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">SVEON_STV22</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span>
		<span class="p">}</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_IS_AN_I2C_ADAPTER</span><span class="p">,</span>

		<span class="p">.</span><span class="n">usb_ctrl</span> <span class="o">=</span> <span class="n">DEVICE_SPECIFIC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">download_firmware</span> <span class="o">=</span> <span class="n">af9015_download_firmware</span><span class="p">,</span>
		<span class="p">.</span><span class="n">firmware</span> <span class="o">=</span> <span class="s">&quot;dvb-usb-af9015.fw&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">no_reconnect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

		<span class="p">.</span><span class="n">size_of_priv</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">af9015_state</span><span class="p">),</span>

		<span class="p">.</span><span class="n">num_adapters</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span>
				<span class="p">.</span><span class="n">num_frontends</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
				<span class="p">.</span><span class="n">fe</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">{</span>
						<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_ADAP_HAS_PID_FILTER</span> <span class="o">|</span>
							<span class="n">DVB_USB_ADAP_PID_FILTER_CAN_BE_TURNED_OFF</span><span class="p">,</span>

						<span class="p">.</span><span class="n">pid_filter_count</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
						<span class="p">.</span><span class="n">pid_filter</span>       <span class="o">=</span> <span class="n">af9015_pid_filter</span><span class="p">,</span>
						<span class="p">.</span><span class="n">pid_filter_ctrl</span>  <span class="o">=</span> <span class="n">af9015_pid_filter_ctrl</span><span class="p">,</span>

						<span class="p">.</span><span class="n">frontend_attach</span> <span class="o">=</span> <span class="n">af9015_af9013_frontend_attach</span><span class="p">,</span>
						<span class="p">.</span><span class="n">tuner_attach</span>    <span class="o">=</span> <span class="n">af9015_tuner_attach</span><span class="p">,</span>
						<span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="p">{</span>
							<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_BULK</span><span class="p">,</span>
							<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
							<span class="p">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">,</span>
						<span class="p">},</span>
					<span class="p">}</span>
				<span class="p">},</span>
			<span class="p">},</span>
			<span class="p">{</span>
				<span class="p">.</span><span class="n">num_frontends</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
				<span class="p">.</span><span class="n">fe</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">{</span>
						<span class="p">.</span><span class="n">frontend_attach</span> <span class="o">=</span> <span class="n">af9015_af9013_frontend_attach</span><span class="p">,</span>
						<span class="p">.</span><span class="n">tuner_attach</span>    <span class="o">=</span> <span class="n">af9015_tuner_attach</span><span class="p">,</span>
						<span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="p">{</span>
							<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_BULK</span><span class="p">,</span>
							<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
							<span class="p">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="mh">0x85</span><span class="p">,</span>
							<span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="p">{</span>
								<span class="p">.</span><span class="n">bulk</span> <span class="o">=</span> <span class="p">{</span>
									<span class="p">.</span><span class="n">buffersize</span> <span class="o">=</span> <span class="n">TS_USB20_FRAME_SIZE</span><span class="p">,</span>
								<span class="p">}</span>
							<span class="p">}</span>
						<span class="p">},</span>
					<span class="p">}</span>
				<span class="p">},</span>
			<span class="p">}</span>
		<span class="p">},</span>

		<span class="p">.</span><span class="n">identify_state</span> <span class="o">=</span> <span class="n">af9015_identify_state</span><span class="p">,</span>

		<span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">protocol</span>         <span class="o">=</span> <span class="n">RC_TYPE_NEC</span><span class="p">,</span>
			<span class="p">.</span><span class="n">module_name</span>      <span class="o">=</span> <span class="s">&quot;af9015&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">rc_query</span>         <span class="o">=</span> <span class="n">af9015_rc_query</span><span class="p">,</span>
			<span class="p">.</span><span class="n">rc_interval</span>      <span class="o">=</span> <span class="n">AF9015_RC_INTERVAL</span><span class="p">,</span>
			<span class="p">.</span><span class="n">allowed_protos</span>   <span class="o">=</span> <span class="n">RC_TYPE_NEC</span><span class="p">,</span>
		<span class="p">},</span>

		<span class="p">.</span><span class="n">i2c_algo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">af9015_i2c_algo</span><span class="p">,</span>

		<span class="p">.</span><span class="n">num_device_descs</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="cm">/* check max from dvb-usb.h */</span>
		<span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;AverMedia AVerTV Volar GPS 805 (A805)&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">AVERTV_A805</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Conceptronic USB2.0 DVB-T CTVDIGRCU &quot;</span> \
					<span class="s">&quot;V3.0&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">CONCEPTRONIC_CTVDIGRCU</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;KWorld Digial MC-810&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">KWORLD_MC810</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Genius TVGo DVB-T03&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">GENIUS_TVGO_DVB_T03</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;KWorld PlusTV DVB-T PCI Pro Card &quot;</span> \
					<span class="s">&quot;(DVB-T PC160-T)&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">KWORLD_PC160_T</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Sveon STV20 Tuner USB DVB-T HDTV&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">SVEON_STV20</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Leadtek WinFast DTV2000DS&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">WINFAST_DTV2000DS</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;KWorld USB DVB-T Stick Mobile &quot;</span> \
					<span class="s">&quot;(UB383-T)&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">KWORLD_UB383_T</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;AverMedia AVerTV Volar M (A815Mac)&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span>
					<span class="o">&amp;</span><span class="n">af9015_usb_table</span><span class="p">[</span><span class="n">AVERMEDIA_A815M</span><span class="p">],</span>
				<span class="p">},</span>
			<span class="p">},</span>
		<span class="p">}</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">af9015_usb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s: interface:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>

	<span class="cm">/* interface 0 is used by DVB-T receiver and</span>
<span class="cm">	   interface 1 is for remote controller (HID) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_read_config</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">af9015_properties_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_usb_device_init</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">af9015_properties</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">THIS_MODULE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">,</span> <span class="n">adapter_nr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">af9015_init</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* usb specific object needed to register this driver with the usb subsystem */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">af9015_usb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dvb_usb_af9015&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">af9015_usb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">dvb_usb_device_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">af9015_usb_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">af9015_usb_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Antti Palosaari &lt;crope@iki.fi&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Afatech AF9015 driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
