<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › dvb-usb › dvb-usb-remote.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>dvb-usb-remote.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* dvb-usb-remote.c is part of the DVB USB library.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004-6 Patrick Boettcher (patrick.boettcher@desy.de)</span>
<span class="cm"> * see dvb-usb-init.c for copyright information.</span>
<span class="cm"> *</span>
<span class="cm"> * This file contains functions for initializing the input-device and for handling remote-control-queries.</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;dvb-usb-common.h&quot;</span>
<span class="cp">#include &lt;linux/usb/input.h&gt;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">legacy_dvb_usb_get_keymap_index</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">input_keymap_entry</span> <span class="o">*</span><span class="n">ke</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">rc_map_table</span> <span class="o">*</span><span class="n">keymap</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">keymap_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scancode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ke</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">INPUT_KEYMAP_BY_INDEX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">ke</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">input_scancode_to_scalar</span><span class="p">(</span><span class="n">ke</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scancode</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">keymap_size</span><span class="p">;</span>

		<span class="cm">/* See if we can match the raw key code. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">keymap_size</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">keymap</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">scancode</span> <span class="o">==</span> <span class="n">scancode</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* See if there is an unused hole in the map */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">keymap_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">keymap_size</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">keymap</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">keycode</span> <span class="o">==</span> <span class="n">KEY_RESERVED</span> <span class="o">||</span>
				    <span class="n">keymap</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">keycode</span> <span class="o">==</span> <span class="n">KEY_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">legacy_dvb_usb_getkeycode</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">input_keymap_entry</span> <span class="o">*</span><span class="n">ke</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rc_map_table</span> <span class="o">*</span><span class="n">keymap</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_map_table</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">keymap_size</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_map_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">legacy_dvb_usb_get_keymap_index</span><span class="p">(</span><span class="n">ke</span><span class="p">,</span> <span class="n">keymap</span><span class="p">,</span> <span class="n">keymap_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">keymap_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ke</span><span class="o">-&gt;</span><span class="n">keycode</span> <span class="o">=</span> <span class="n">keymap</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">keycode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ke</span><span class="o">-&gt;</span><span class="n">keycode</span> <span class="o">==</span> <span class="n">KEY_UNKNOWN</span><span class="p">)</span>
		<span class="n">ke</span><span class="o">-&gt;</span><span class="n">keycode</span> <span class="o">=</span> <span class="n">KEY_RESERVED</span><span class="p">;</span>
	<span class="n">ke</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">keymap</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">scancode</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ke</span><span class="o">-&gt;</span><span class="n">scancode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">keymap</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">scancode</span><span class="p">,</span> <span class="n">ke</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">ke</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">legacy_dvb_usb_setkeycode</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">input_keymap_entry</span> <span class="o">*</span><span class="n">ke</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">old_keycode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rc_map_table</span> <span class="o">*</span><span class="n">keymap</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_map_table</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">keymap_size</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_map_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">legacy_dvb_usb_get_keymap_index</span><span class="p">(</span><span class="n">ke</span><span class="p">,</span> <span class="n">keymap</span><span class="p">,</span> <span class="n">keymap_size</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * FIXME: Currently, it is not possible to increase the size of</span>
<span class="cm">	 * scancode table. For it to happen, one possibility</span>
<span class="cm">	 * would be to allocate a table with key_map_size + 1,</span>
<span class="cm">	 * copying data, appending the new key on it, and freeing</span>
<span class="cm">	 * the old one - or maybe just allocating some spare space</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">keymap_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">old_keycode</span> <span class="o">=</span> <span class="n">keymap</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">keycode</span><span class="p">;</span>
	<span class="n">keymap</span><span class="o">-&gt;</span><span class="n">keycode</span> <span class="o">=</span> <span class="n">ke</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">;</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">ke</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">old_keycode</span> <span class="o">!=</span> <span class="n">KEY_RESERVED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__clear_bit</span><span class="p">(</span><span class="o">*</span><span class="n">old_keycode</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">keymap_size</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">keymap</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">keycode</span> <span class="o">==</span> <span class="o">*</span><span class="n">old_keycode</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">__set_bit</span><span class="p">(</span><span class="o">*</span><span class="n">old_keycode</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Remote-control poll function - called every dib-&gt;rc_query_interval ms to see</span>
<span class="cm"> * whether the remote control has received anything.</span>
<span class="cm"> *</span>
<span class="cm"> * TODO: Fix the repeat rate of the input device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">legacy_dvb_usb_read_remote_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_usb_device</span><span class="p">,</span> <span class="n">rc_query_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">;</span>

	<span class="cm">/* TODO: need a lock here.  We can simply skip checking for the remote control</span>
<span class="cm">	   if we&#39;re busy. */</span>

	<span class="cm">/* when the parameter has been set to 1 via sysfs while the driver was running */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dvb_usb_disable_rc_polling</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_query</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="o">&amp;</span><span class="n">event</span><span class="p">,</span><span class="o">&amp;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;error while querying for an remote control event.&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">schedule</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">REMOTE_NO_KEY_PRESSED</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">REMOTE_KEY_PRESSED</span>:
			<span class="n">deb_rc</span><span class="p">(</span><span class="s">&quot;key pressed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">last_event</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">REMOTE_KEY_REPEAT</span>:
			<span class="n">deb_rc</span><span class="p">(</span><span class="s">&quot;key repeated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">input_event</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">EV_KEY</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">);</span>
			<span class="n">input_event</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">EV_KEY</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">last_event</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/* improved repeat handling ???</span>
<span class="cm">	switch (state) {</span>
<span class="cm">		case REMOTE_NO_KEY_PRESSED:</span>
<span class="cm">			deb_rc(&quot;NO KEY PRESSED\n&quot;);</span>
<span class="cm">			if (d-&gt;last_state != REMOTE_NO_KEY_PRESSED) {</span>
<span class="cm">				deb_rc(&quot;releasing event %d\n&quot;,d-&gt;last_event);</span>
<span class="cm">				input_event(d-&gt;rc_input_dev, EV_KEY, d-&gt;last_event, 0);</span>
<span class="cm">				input_sync(d-&gt;rc_input_dev);</span>
<span class="cm">			}</span>
<span class="cm">			d-&gt;last_state = REMOTE_NO_KEY_PRESSED;</span>
<span class="cm">			d-&gt;last_event = 0;</span>
<span class="cm">			break;</span>
<span class="cm">		case REMOTE_KEY_PRESSED:</span>
<span class="cm">			deb_rc(&quot;KEY PRESSED\n&quot;);</span>
<span class="cm">			deb_rc(&quot;pressing event %d\n&quot;,event);</span>

<span class="cm">			input_event(d-&gt;rc_input_dev, EV_KEY, event, 1);</span>
<span class="cm">			input_sync(d-&gt;rc_input_dev);</span>

<span class="cm">			d-&gt;last_event = event;</span>
<span class="cm">			d-&gt;last_state = REMOTE_KEY_PRESSED;</span>
<span class="cm">			break;</span>
<span class="cm">		case REMOTE_KEY_REPEAT:</span>
<span class="cm">			deb_rc(&quot;KEY_REPEAT\n&quot;);</span>
<span class="cm">			if (d-&gt;last_state != REMOTE_NO_KEY_PRESSED) {</span>
<span class="cm">				deb_rc(&quot;repeating event %d\n&quot;,d-&gt;last_event);</span>
<span class="cm">				input_event(d-&gt;rc_input_dev, EV_KEY, d-&gt;last_event, 2);</span>
<span class="cm">				input_sync(d-&gt;rc_input_dev);</span>
<span class="cm">				d-&gt;last_state = REMOTE_KEY_REPEAT;</span>
<span class="cm">			}</span>
<span class="cm">		default:</span>
<span class="cm">			break;</span>
<span class="cm">	}</span>
<span class="cm">*/</span>

<span class="nl">schedule:</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_query_work</span><span class="p">,</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_interval</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">legacy_dvb_usb_remote_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">rc_interval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">;</span>

	<span class="n">input_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">);</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;IR-receiver inside an USB DVB receiver&quot;</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_phys</span><span class="p">;</span>
	<span class="n">usb_to_input_id</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">d</span><span class="o">-&gt;</span><span class="n">input_dev</span> <span class="o">=</span> <span class="n">input_dev</span><span class="p">;</span>
	<span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">getkeycode</span> <span class="o">=</span> <span class="n">legacy_dvb_usb_getkeycode</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">setkeycode</span> <span class="o">=</span> <span class="n">legacy_dvb_usb_setkeycode</span><span class="p">;</span>

	<span class="cm">/* set the bits for the keys */</span>
	<span class="n">deb_rc</span><span class="p">(</span><span class="s">&quot;key map size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_map_size</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_map_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deb_rc</span><span class="p">(</span><span class="s">&quot;setting bit for event %d item %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_map_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">keycode</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_map_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">keycode</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* setting these two values to non-zero, we have to manage key repeats */</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">[</span><span class="n">REP_PERIOD</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_interval</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">[</span><span class="n">REP_DELAY</span><span class="p">]</span>  <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_interval</span> <span class="o">+</span> <span class="mi">150</span><span class="p">;</span>

	<span class="n">input_set_drvdata</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">input_free_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>

	<span class="n">rc_interval</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_interval</span><span class="p">;</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_query_work</span><span class="p">,</span> <span class="n">legacy_dvb_usb_read_remote_control</span><span class="p">);</span>

	<span class="n">info</span><span class="p">(</span><span class="s">&quot;schedule remote query interval to %d msecs.&quot;</span><span class="p">,</span> <span class="n">rc_interval</span><span class="p">);</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_query_work</span><span class="p">,</span>
			      <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">rc_interval</span><span class="p">));</span>

	<span class="n">d</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">DVB_USB_STATE_REMOTE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Remote-control poll function - called every dib-&gt;rc_query_interval ms to see</span>
<span class="cm"> * whether the remote control has received anything.</span>
<span class="cm"> *</span>
<span class="cm"> * TODO: Fix the repeat rate of the input device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dvb_usb_read_remote_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_usb_device</span><span class="p">,</span> <span class="n">rc_query_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* TODO: need a lock here.  We can simply skip checking for the remote control</span>
<span class="cm">	   if we&#39;re busy. */</span>

	<span class="cm">/* when the parameter has been set to 1 via sysfs while the</span>
<span class="cm">	 * driver was running, or when bulk mode is enabled after IR init</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dvb_usb_disable_rc_polling</span> <span class="o">||</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">bulk_mode</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rc_query</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;error %d while querying for an remote control event.&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_query_work</span><span class="p">,</span>
			      <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rc_interval</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rc_core_dvb_usb_remote_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">rc_interval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">rc_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">module_name</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">map_name</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rc_codes</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">change_protocol</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">change_protocol</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">allowed_protos</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">allowed_protos</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver_type</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">driver_type</span><span class="p">;</span>
	<span class="n">usb_to_input_id</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input_name</span> <span class="o">=</span> <span class="s">&quot;IR-receiver inside an USB DVB receiver&quot;</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input_phys</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_phys</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rc_register_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc_free_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">d</span><span class="o">-&gt;</span><span class="n">input_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rc_query</span> <span class="o">||</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">bulk_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Polling mode - initialize a work queue for handling it */</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_query_work</span><span class="p">,</span> <span class="n">dvb_usb_read_remote_control</span><span class="p">);</span>

	<span class="n">rc_interval</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rc_interval</span><span class="p">;</span>

	<span class="n">info</span><span class="p">(</span><span class="s">&quot;schedule remote query interval to %d msecs.&quot;</span><span class="p">,</span> <span class="n">rc_interval</span><span class="p">);</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_query_work</span><span class="p">,</span>
			      <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">rc_interval</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dvb_usb_remote_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dvb_usb_disable_rc_polling</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_map_table</span> <span class="o">&amp;&amp;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_query</span><span class="p">)</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">DVB_RC_LEGACY</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rc_codes</span><span class="p">)</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">DVB_RC_CORE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">usb_make_path</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_phys</span><span class="p">));</span>
	<span class="n">strlcat</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_phys</span><span class="p">,</span> <span class="s">&quot;/ir0&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_phys</span><span class="p">));</span>

	<span class="cm">/* Start the remote-control polling. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_interval</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">)</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_interval</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="cm">/* default */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">DVB_RC_LEGACY</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">legacy_dvb_usb_remote_init</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rc_core_dvb_usb_remote_init</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">d</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">DVB_USB_STATE_REMOTE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dvb_usb_remote_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">DVB_USB_STATE_REMOTE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_query_work</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">DVB_RC_LEGACY</span><span class="p">)</span>
			<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc_unregister_device</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">d</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DVB_USB_STATE_REMOTE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DVB_USB_RC_NEC_EMPTY           0x00</span>
<span class="cp">#define DVB_USB_RC_NEC_KEY_PRESSED     0x01</span>
<span class="cp">#define DVB_USB_RC_NEC_KEY_REPEATED    0x02</span>
<span class="kt">int</span> <span class="nf">dvb_usb_nec_rc_key_to_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">keybuf</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">u32</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rc_map_table</span> <span class="o">*</span><span class="n">keymap</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_map_table</span><span class="p">;</span>
	<span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">REMOTE_NO_KEY_PRESSED</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">keybuf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DVB_USB_RC_NEC_EMPTY</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DVB_USB_RC_NEC_KEY_PRESSED</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">u8</span><span class="p">)</span> <span class="o">~</span><span class="n">keybuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">keybuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="o">~</span><span class="n">keybuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">keybuf</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">deb_err</span><span class="p">(</span><span class="s">&quot;remote control checksum failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* See if we can match the raw key code. */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_map_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc5_custom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keymap</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="n">keybuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
					<span class="n">rc5_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keymap</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="n">keybuf</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="n">keymap</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">keycode</span><span class="p">;</span>
					<span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">REMOTE_KEY_PRESSED</span><span class="p">;</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="n">deb_err</span><span class="p">(</span><span class="s">&quot;key mapping failed - no appropriate key found in keymapping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DVB_USB_RC_NEC_KEY_REPEATED</span>:
			<span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">REMOTE_KEY_REPEAT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">deb_err</span><span class="p">(</span><span class="s">&quot;unknown type of remote status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">keybuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dvb_usb_nec_rc_key_to_event</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
