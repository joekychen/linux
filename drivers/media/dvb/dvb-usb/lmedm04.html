<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › dvb-usb › lmedm04.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>lmedm04.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* DVB USB compliant linux driver for</span>
<span class="cm"> *</span>
<span class="cm"> * DM04/QQBOX DVB-S USB BOX	LME2510C + SHARP:BS2F7HZ7395</span>
<span class="cm"> *				LME2510C + LG TDQY-P001F</span>
<span class="cm"> *				LME2510C + BS2F7HZ0194</span>
<span class="cm"> *				LME2510 + LG TDQY-P001F</span>
<span class="cm"> *				LME2510 + BS2F7HZ0194</span>
<span class="cm"> *</span>
<span class="cm"> * MVB7395 (LME2510C+SHARP:BS2F7HZ7395)</span>
<span class="cm"> * SHARP:BS2F7HZ7395 = (STV0288+Sharp IX2505V)</span>
<span class="cm"> *</span>
<span class="cm"> * MV001F (LME2510+LGTDQY-P001F)</span>
<span class="cm"> * LG TDQY - P001F =(TDA8263 + TDA10086H)</span>
<span class="cm"> *</span>
<span class="cm"> * MVB0001F (LME2510C+LGTDQT-P001F)</span>
<span class="cm"> *</span>
<span class="cm"> * MV0194 (LME2510+SHARP:BS2F7HZ0194)</span>
<span class="cm"> * SHARP:BS2F7HZ0194 = (STV0299+IX2410)</span>
<span class="cm"> *</span>
<span class="cm"> * MVB0194 (LME2510C+SHARP0194)</span>
<span class="cm"> *</span>
<span class="cm"> * For firmware see Documentation/dvb/lmedm04.txt</span>
<span class="cm"> *</span>
<span class="cm"> * I2C addresses:</span>
<span class="cm"> * 0xd0 - STV0288	- Demodulator</span>
<span class="cm"> * 0xc0 - Sharp IX2505V	- Tuner</span>
<span class="cm"> * --</span>
<span class="cm"> * 0x1c - TDA10086   - Demodulator</span>
<span class="cm"> * 0xc0 - TDA8263    - Tuner</span>
<span class="cm"> * --</span>
<span class="cm"> * 0xd0 - STV0299	- Demodulator</span>
<span class="cm"> * 0xc0 - IX2410	- Tuner</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * VID = 3344  PID LME2510=1122 LME2510C=1120</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Malcolm Priestley (tvboxspy@gmail.com)</span>
<span class="cm"> * LME2510(C)(C) Leaguerme (Shenzhen) MicroElectronics Co., Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License Version 2, as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * see Documentation/dvb/README.dvb-usb for more information</span>
<span class="cm"> *</span>
<span class="cm"> * Known Issues :</span>
<span class="cm"> *	LME2510: Non Intel USB chipsets fail to maintain High Speed on</span>
<span class="cm"> * Boot or Hot Plug.</span>
<span class="cm"> *</span>
<span class="cm"> * QQbox suffers from noise on LNB voltage.</span>
<span class="cm"> *</span>
<span class="cm"> *	LME2510: SHARP:BS2F7HZ0194(MV0194) cannot cold reset and share system</span>
<span class="cm"> * with other tuners. After a cold reset streaming will not start.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#define DVB_USB_LOG_PREFIX &quot;LME2510(C)&quot;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/input.h&gt;</span>
<span class="cp">#include &lt;media/rc-core.h&gt;</span>

<span class="cp">#include &quot;dvb-usb.h&quot;</span>
<span class="cp">#include &quot;lmedm04.h&quot;</span>
<span class="cp">#include &quot;tda826x.h&quot;</span>
<span class="cp">#include &quot;tda10086.h&quot;</span>
<span class="cp">#include &quot;stv0288.h&quot;</span>
<span class="cp">#include &quot;ix2505v.h&quot;</span>
<span class="cp">#include &quot;stv0299.h&quot;</span>
<span class="cp">#include &quot;dvb-pll.h&quot;</span>
<span class="cp">#include &quot;z0194a.h&quot;</span>
<span class="cp">#include &quot;m88rs2000.h&quot;</span>



<span class="cm">/* debug */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dvb_usb_lme2510_debug</span><span class="p">;</span>
<span class="cp">#define l_dprintk(var, level, args...) do { \</span>
<span class="cp">	if ((var &gt;= level)) \</span>
<span class="cp">		printk(KERN_DEBUG DVB_USB_LOG_PREFIX &quot;: &quot; args); \</span>
<span class="cp">} while (0)</span>

<span class="cp">#define deb_info(level, args...) l_dprintk(dvb_usb_lme2510_debug, level, args)</span>
<span class="cp">#define debug_data_snipet(level, name, p) \</span>
<span class="cp">	 deb_info(level, name&quot; (%02x%02x%02x%02x%02x%02x%02x%02x)&quot;, \</span>
<span class="cp">		*p, *(p+1), *(p+2), *(p+3), *(p+4), \</span>
<span class="cp">			*(p+5), *(p+6), *(p+7));</span>


<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">dvb_usb_lme2510_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;set debugging level (1=info (or-able)).&quot;</span>
			<span class="n">DVB_USB_DEBUG_STATUS</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dvb_usb_lme2510_firmware</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">firmware</span><span class="p">,</span> <span class="n">dvb_usb_lme2510_firmware</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">firmware</span><span class="p">,</span> <span class="s">&quot;set default firmware 0=Sharp7395 1=LG&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pid_filter</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">pid_filter</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="s">&quot;set default 0=default 1=off 2=on&quot;</span><span class="p">);</span>


<span class="n">DVB_DEFINE_MOD_OPT_ADAPTER_NR</span><span class="p">(</span><span class="n">adapter_nr</span><span class="p">);</span>

<span class="cp">#define TUNER_DEFAULT	0x0</span>
<span class="cp">#define TUNER_LG	0x1</span>
<span class="cp">#define TUNER_S7395	0x2</span>
<span class="cp">#define TUNER_S0194	0x3</span>
<span class="cp">#define TUNER_RS2000	0x4</span>

<span class="k">struct</span> <span class="n">lme2510_state</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tuner_config</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">signal_lock</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">signal_level</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">signal_sn</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">time_key</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">last_key</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">key_timeout</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i2c_talk_onoff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i2c_gate</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i2c_tuner_gate_w</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i2c_tuner_gate_r</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i2c_tuner_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">stream_on</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pid_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pid_off</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">lme_urb</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">usb_buffer</span><span class="p">;</span>

<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lme2510_bulk_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">snd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">actual_l</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">),</span>
				<span class="n">snd</span><span class="p">,</span> <span class="n">len</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">actual_l</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lme2510_bulk_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">rev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">actual_l</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">),</span>
				 <span class="n">rev</span><span class="p">,</span> <span class="n">len</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">actual_l</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lme2510_usb_talk</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">wbuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wlen</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rbuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lme2510_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">usb_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">usb_buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">usb_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="p">(</span><span class="s">&quot;MEM Error no memory&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">buff</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">usb_buffer</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="cm">/* the read/write capped at 64 */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">wbuf</span><span class="p">,</span> <span class="p">(</span><span class="n">wlen</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">)</span> <span class="o">?</span> <span class="n">wlen</span> <span class="o">:</span> <span class="mi">64</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lme2510_bulk_write</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">wlen</span> <span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lme2510_bulk_read</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="p">(</span><span class="n">rlen</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">rlen</span> <span class="o">:</span> <span class="mi">64</span> <span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">rbuf</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">rlen</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lme2510_stream_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lme2510_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">all_pids</span><span class="p">[]</span> <span class="o">=</span> <span class="n">LME_ALL_PIDS</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">stream_on</span><span class="p">[]</span> <span class="o">=</span> <span class="n">LME_ST_ON_W</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rbuff</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">pid_off</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">lme2510_usb_talk</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">all_pids</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">all_pids</span><span class="p">),</span>
			<span class="n">rbuff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rbuff</span><span class="p">));</span>
	<span class="cm">/*Restart Stream Command*/</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lme2510_usb_talk</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">stream_on</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stream_on</span><span class="p">),</span>
			<span class="n">rbuff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rbuff</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lme2510_enable_pid</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pid_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lme2510_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">pid_buff</span><span class="p">[]</span> <span class="o">=</span> <span class="n">LME_ZERO_PID</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">pid_no</span> <span class="o">=</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pid_len</span> <span class="o">=</span> <span class="n">pid_no</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">deb_info</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;PID Setting Pid %04x&quot;</span><span class="p">,</span> <span class="n">pid_out</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">pid_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">lme2510_stream_restart</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">pid_buff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pid_no</span><span class="p">;</span>
	<span class="n">pid_buff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pid_out</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">pid_buff</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">pid_no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pid_buff</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">pid_out</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pid_len</span> <span class="o">&gt;</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">pid_size</span><span class="p">)</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">pid_size</span> <span class="o">=</span> <span class="n">pid_len</span><span class="p">;</span>
	<span class="n">pid_buff</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">+</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">pid_size</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lme2510_usb_talk</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">pid_buff</span> <span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">pid_buff</span><span class="p">)</span> <span class="p">,</span> <span class="n">rbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rbuf</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">stream_on</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">lme2510_stream_restart</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lme2510_int_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">lme_urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">lme_urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lme2510_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ibuf</span><span class="p">,</span> <span class="o">*</span><span class="n">rbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">key</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">lme_urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ETIMEDOUT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;Error %x&quot;</span><span class="p">,</span> <span class="n">lme_urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rbuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">lme_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="p">((</span><span class="n">lme_urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="p">(</span><span class="n">lme_urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span> <span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">offset</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ibuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rbuf</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">];</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;INT O/S C =%02x C/O=%02x Type =%02x%02x&quot;</span><span class="p">,</span>
		<span class="n">offset</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ibuf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ibuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ibuf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0xaa</span>:
			<span class="n">debug_data_snipet</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;INT Remote data snipet&quot;</span><span class="p">,</span> <span class="n">ibuf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ibuf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">ibuf</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">key</span> <span class="o">=</span> <span class="n">ibuf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
				<span class="n">key</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ibuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="o">?</span> <span class="p">(</span><span class="n">ibuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">^</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">key</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ibuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">^</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">deb_info</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;INT Key =%08x&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rc_dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">rc_keydown</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rc_dev</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xbb</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_config</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">TUNER_LG</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">ibuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_lock</span> <span class="o">=</span> <span class="n">ibuf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
				<span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_level</span> <span class="o">=</span> <span class="n">ibuf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
				<span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_sn</span> <span class="o">=</span> <span class="n">ibuf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
				<span class="n">st</span><span class="o">-&gt;</span><span class="n">time_key</span> <span class="o">=</span> <span class="n">ibuf</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TUNER_S7395</span>:
			<span class="k">case</span> <span class="n">TUNER_S0194</span>:
				<span class="cm">/* Tweak for earlier firmware*/</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ibuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ibuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
						<span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_lock</span> <span class="o">=</span> <span class="n">ibuf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
					<span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_level</span> <span class="o">=</span> <span class="n">ibuf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
					<span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_sn</span> <span class="o">=</span> <span class="n">ibuf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_level</span> <span class="o">=</span> <span class="n">ibuf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
					<span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_sn</span> <span class="o">=</span> <span class="n">ibuf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
					<span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_lock</span> <span class="o">=</span>
						<span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_lock</span> <span class="o">&amp;</span> <span class="mh">0xf7</span><span class="p">)</span> <span class="o">+</span>
						<span class="p">((</span><span class="n">ibuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x03</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TUNER_RS2000</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">ibuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_lock</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_lock</span> <span class="o">=</span> <span class="mh">0xf0</span><span class="p">;</span>
				<span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_level</span> <span class="o">=</span> <span class="n">ibuf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
				<span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_sn</span> <span class="o">=</span> <span class="n">ibuf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
				<span class="n">st</span><span class="o">-&gt;</span><span class="n">time_key</span> <span class="o">=</span> <span class="n">ibuf</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">debug_data_snipet</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;INT Remote data snipet in&quot;</span><span class="p">,</span> <span class="n">ibuf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xcc</span>:
			<span class="n">debug_data_snipet</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;INT Control data snipet&quot;</span><span class="p">,</span> <span class="n">ibuf</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">debug_data_snipet</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;INT Unknown data snipet&quot;</span><span class="p">,</span> <span class="n">ibuf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">lme_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lme2510_int_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lme2510_state</span> <span class="o">*</span><span class="n">lme_int</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">lme_int</span><span class="o">-&gt;</span><span class="n">lme_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lme_int</span><span class="o">-&gt;</span><span class="n">lme_urb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">lme_int</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">lme_int</span><span class="o">-&gt;</span><span class="n">lme_urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lme_int</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">lme_int</span><span class="o">-&gt;</span><span class="n">lme_urb</span><span class="p">,</span>
				<span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
				<span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">),</span>
				<span class="n">lme_int</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
				<span class="mi">128</span><span class="p">,</span>
				<span class="n">lme2510_int_response</span><span class="p">,</span>
				<span class="n">adap</span><span class="p">,</span>
				<span class="mi">8</span><span class="p">);</span>

	<span class="n">lme_int</span><span class="o">-&gt;</span><span class="n">lme_urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">|=</span> <span class="n">URB_NO_TRANSFER_DMA_MAP</span><span class="p">;</span>

	<span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">lme_int</span><span class="o">-&gt;</span><span class="n">lme_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">info</span><span class="p">(</span><span class="s">&quot;INT Interrupt Service Started&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lme2510_pid_filter_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lme2510_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">clear_pid_reg</span><span class="p">[]</span> <span class="o">=</span> <span class="n">LME_ALL_PIDS</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;PID Clearing Filter&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">onoff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">lme2510_usb_talk</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">clear_pid_reg</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">clear_pid_reg</span><span class="p">),</span> <span class="n">rbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rbuf</span><span class="p">));</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">pid_off</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">pid_off</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">pid_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lme2510_pid_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pid</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s PID=%04x Index=%04x onoff=%02x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">pid</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">onoff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">lme2510_enable_pid</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">lme2510_return_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x0302</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
	<span class="n">info</span><span class="p">(</span><span class="s">&quot;Firmware Status: %x (%x)&quot;</span><span class="p">,</span> <span class="n">ret</span> <span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">:</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lme2510_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">wbuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wlen</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rbuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lme2510_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_talk_onoff</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">lme2510_usb_talk</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">wbuf</span><span class="p">,</span> <span class="n">wlen</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">,</span> <span class="n">rlen</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_config</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TUNER_LG</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">wbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">wbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0e</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_lock</span> <span class="o">=</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">stream_on</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
						<span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_lock</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">lme2510_stream_restart</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
						<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_talk_onoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">msleep</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_S7395</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">wbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xd0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">wbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x24</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_lock</span> <span class="o">=</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">stream_on</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
						<span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_lock</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">lme2510_stream_restart</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
						<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_talk_onoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_S0194</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">wbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xd0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">wbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x1b</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_lock</span> <span class="o">=</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">stream_on</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
						<span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_lock</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">lme2510_stream_restart</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
						<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_talk_onoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_RS2000</span>:
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* TODO rewrite this section */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_config</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TUNER_LG</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">wbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x0e</span>:
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_lock</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x43</span>:
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_level</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x1c</span>:
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_sn</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x15</span>:
			<span class="k">case</span> <span class="mh">0x16</span>:
			<span class="k">case</span> <span class="mh">0x17</span>:
			<span class="k">case</span> <span class="mh">0x18</span>:
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">lme2510_usb_talk</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">wbuf</span><span class="p">,</span> <span class="n">wlen</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">,</span> <span class="n">rlen</span><span class="p">);</span>
				<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_talk_onoff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_S7395</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">wbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x10</span>:
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_level</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
						<span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_level</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x2d</span>:
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_sn</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x24</span>:
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_lock</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x2e</span>:
			<span class="k">case</span> <span class="mh">0x26</span>:
			<span class="k">case</span> <span class="mh">0x27</span>:
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">lme2510_usb_talk</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">wbuf</span><span class="p">,</span> <span class="n">wlen</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">,</span> <span class="n">rlen</span><span class="p">);</span>
				<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_talk_onoff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_S0194</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">wbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x18</span>:
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_level</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
						<span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_level</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x24</span>:
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_sn</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x1b</span>:
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_lock</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x19</span>:
			<span class="k">case</span> <span class="mh">0x25</span>:
			<span class="k">case</span> <span class="mh">0x1e</span>:
			<span class="k">case</span> <span class="mh">0x1d</span>:
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">lme2510_usb_talk</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">wbuf</span><span class="p">,</span> <span class="n">wlen</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">,</span> <span class="n">rlen</span><span class="p">);</span>
				<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_talk_onoff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_RS2000</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">wbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x8c</span>:
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
				<span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">last_key</span> <span class="o">==</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">time_key</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">st</span><span class="o">-&gt;</span><span class="n">key_timeout</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">key_timeout</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
						<span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">st</span><span class="o">-&gt;</span><span class="n">key_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">st</span><span class="o">-&gt;</span><span class="n">last_key</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">time_key</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">lme2510_usb_talk</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">wbuf</span><span class="p">,</span> <span class="n">wlen</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">,</span> <span class="n">rlen</span><span class="p">);</span>
				<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_talk_onoff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">deb_info</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;I2C From Interrupt Message out(%02x) in(%02x)&quot;</span><span class="p">,</span>
				<span class="n">wbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">lme2510_i2c_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[],</span>
				 <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lme2510_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">obuf</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span> <span class="n">ibuf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">read</span><span class="p">,</span> <span class="n">read_o</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">gate</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_gate</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">gate</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">warn</span><span class="p">(</span><span class="s">&quot;more than 2 i2c messages&quot;</span>
			<span class="s">&quot;at a time is not handled yet.	TODO.&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_o</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">);</span>
		<span class="n">read</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">num</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">);</span>
		<span class="n">read</span> <span class="o">|=</span> <span class="n">read_o</span><span class="p">;</span>
		<span class="n">gate</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">==</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_tuner_addr</span><span class="p">)</span>
			<span class="o">?</span> <span class="p">(</span><span class="n">read</span><span class="p">)</span>	<span class="o">?</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_tuner_gate_r</span>
					<span class="o">:</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_tuner_gate_w</span>
			<span class="o">:</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_gate</span><span class="p">;</span>
		<span class="n">obuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gate</span> <span class="o">|</span> <span class="p">(</span><span class="n">read</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gate</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">obuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">read</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">obuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">+</span> <span class="n">read</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">obuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">read_o</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obuf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
				<span class="n">obuf</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="o">+</span><span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obuf</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="o">+</span><span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lme2510_msg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">obuf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ibuf</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">deb_info</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;i2c transfer failed.&quot;</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">read_o</span><span class="p">)</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ibuf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ibuf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">lme2510_i2c_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">I2C_FUNC_I2C</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_algorithm</span> <span class="n">lme2510_i2c_algo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">master_xfer</span>   <span class="o">=</span> <span class="n">lme2510_i2c_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">functionality</span> <span class="o">=</span> <span class="n">lme2510_i2c_func</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Callbacks for DVB USB */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lme2510_identify_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="o">*</span><span class="n">props</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dvb_usb_device_description</span> <span class="o">**</span><span class="n">desc</span><span class="p">,</span>
		<span class="kt">int</span> <span class="o">*</span><span class="n">cold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pid_filter</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">caps</span> <span class="o">&amp;=</span>
			<span class="o">~</span><span class="n">DVB_USB_ADAP_NEED_PID_FILTERING</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lme2510_streaming_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lme2510_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">clear_reg_3</span><span class="p">[]</span> <span class="o">=</span> <span class="n">LME_ALL_PIDS</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rbuf</span><span class="p">);</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;STM  (%02x)&quot;</span><span class="p">,</span> <span class="n">onoff</span><span class="p">);</span>

	<span class="cm">/* Streaming is started by FE_HAS_LOCK */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">onoff</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">stream_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;STM Steam Off&quot;</span><span class="p">);</span>
		<span class="cm">/* mutex is here only to avoid collision with I2C */</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">lme2510_usb_talk</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">clear_reg_3</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">clear_reg_3</span><span class="p">),</span> <span class="n">rbuf</span><span class="p">,</span> <span class="n">rlen</span><span class="p">);</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">stream_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_talk_onoff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">check_sum</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lme2510_download_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">j</span><span class="p">,</span> <span class="n">wlen</span><span class="p">,</span> <span class="n">len_in</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">packet_size</span><span class="p">,</span> <span class="n">dlen</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">fw_data</span><span class="p">;</span>

	<span class="n">packet_size</span> <span class="o">=</span> <span class="mh">0x31</span><span class="p">;</span>
	<span class="n">len_in</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;FRM Could not start Firmware Download (Buffer allocation failed)&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="p">(</span><span class="s">&quot;FRM Starting Firmware Download&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">512</span><span class="p">;</span>
		<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">512</span> <span class="o">:</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="p">(</span><span class="n">packet_size</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fw_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">packet_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">dlen</span> <span class="o">=</span> <span class="n">packet_size</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="n">dlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">end</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlen</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fw_data</span><span class="p">,</span> <span class="n">dlen</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">wlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">dlen</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="n">wlen</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_sum</span><span class="p">(</span><span class="n">fw_data</span><span class="p">,</span> <span class="n">dlen</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">deb_info</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Data S=%02x:E=%02x CS= %02x&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
				<span class="n">data</span><span class="p">[</span><span class="n">dlen</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">dlen</span><span class="o">+</span><span class="mi">3</span><span class="p">]);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">lme2510_bulk_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>  <span class="n">wlen</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">lme2510_bulk_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len_in</span> <span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x88</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mh">0x0109</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>


	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8a</span><span class="p">;</span>
	<span class="n">len_in</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lme2510_bulk_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span> <span class="p">,</span> <span class="n">len_in</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/*Resetting*/</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lme2510_bulk_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len_in</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;FRM Firmware Download Failed (%04x)&quot;</span> <span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;FRM Firmware Download Completed - Resetting Device&quot;</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lme_coldreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len_in</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">512</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0a</span><span class="p">;</span>
	<span class="n">len_in</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="p">(</span><span class="s">&quot;FRM Firmware Cold Reset&quot;</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lme2510_bulk_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span> <span class="p">,</span> <span class="n">len_in</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/*Cold Resetting*/</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">lme2510_bulk_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len_in</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lme_firmware_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">fw_c_s7395</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;dvb-usb-lme2510c-s7395.fw&quot;</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">fw_c_lg</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;dvb-usb-lme2510c-lg.fw&quot;</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">fw_c_s0194</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;dvb-usb-lme2510c-s0194.fw&quot;</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">fw_c_rs2000</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;dvb-usb-lme2510c-rs2000.fw&quot;</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">fw_lg</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;dvb-usb-lme2510-lg.fw&quot;</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">fw_s0194</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;dvb-usb-lme2510-s0194.fw&quot;</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_lme</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cold_fw</span><span class="p">;</span>

	<span class="n">cold</span> <span class="o">=</span> <span class="p">(</span><span class="n">cold</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">cold</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cold_fw</span> <span class="o">=</span> <span class="o">!</span><span class="n">cold</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x1122</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">dvb_usb_lme2510_firmware</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="n">dvb_usb_lme2510_firmware</span> <span class="o">=</span> <span class="n">TUNER_S0194</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_S0194</span>:
			<span class="n">fw_lme</span> <span class="o">=</span> <span class="n">fw_s0194</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw_lme</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dvb_usb_lme2510_firmware</span> <span class="o">=</span> <span class="n">TUNER_LG</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_LG</span>:
			<span class="n">fw_lme</span> <span class="o">=</span> <span class="n">fw_lg</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw_lme</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">info</span><span class="p">(</span><span class="s">&quot;FRM No Firmware Found - please install&quot;</span><span class="p">);</span>
			<span class="n">dvb_usb_lme2510_firmware</span> <span class="o">=</span> <span class="n">TUNER_DEFAULT</span><span class="p">;</span>
			<span class="n">cold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cold_fw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1120</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">dvb_usb_lme2510_firmware</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="n">dvb_usb_lme2510_firmware</span> <span class="o">=</span> <span class="n">TUNER_S7395</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_S7395</span>:
			<span class="n">fw_lme</span> <span class="o">=</span> <span class="n">fw_c_s7395</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw_lme</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dvb_usb_lme2510_firmware</span> <span class="o">=</span> <span class="n">TUNER_LG</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_LG</span>:
			<span class="n">fw_lme</span> <span class="o">=</span> <span class="n">fw_c_lg</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw_lme</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">dvb_usb_lme2510_firmware</span> <span class="o">=</span> <span class="n">TUNER_S0194</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_S0194</span>:
			<span class="n">fw_lme</span> <span class="o">=</span> <span class="n">fw_c_s0194</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw_lme</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">info</span><span class="p">(</span><span class="s">&quot;FRM No Firmware Found - please install&quot;</span><span class="p">);</span>
			<span class="n">dvb_usb_lme2510_firmware</span> <span class="o">=</span> <span class="n">TUNER_DEFAULT</span><span class="p">;</span>
			<span class="n">cold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cold_fw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x22f0</span>:
		<span class="n">fw_lme</span> <span class="o">=</span> <span class="n">fw_c_rs2000</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw_lme</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dvb_usb_lme2510_firmware</span> <span class="o">=</span> <span class="n">TUNER_RS2000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">fw_lme</span> <span class="o">=</span> <span class="n">fw_c_s7395</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">cold_fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;FRM Loading %s file&quot;</span><span class="p">,</span> <span class="n">fw_lme</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">lme2510_download_firmware</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">fw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cold</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;FRM Changing to %s firmware&quot;</span><span class="p">,</span> <span class="n">fw_lme</span><span class="p">);</span>
		<span class="n">lme_coldreset</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lme2510_kill_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_data_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">urbs_submitted</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;killing URB no. %d.&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="cm">/* stop the URB */</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">urb_list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">urbs_submitted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tda10086_config</span> <span class="n">tda10086_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">diseqc_tone</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xtal_freq</span> <span class="o">=</span> <span class="n">TDA10086_XTAL_16M</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stv0288_config</span> <span class="n">lme_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0xd0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
	<span class="p">.</span><span class="n">inittab</span> <span class="o">=</span> <span class="n">s7395_inittab</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ix2505v_config</span> <span class="n">lme_tuner</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tuner_address</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner_gain</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner_chargepump</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stv0299_config</span> <span class="n">sharp_z0194_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0xd0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">inittab</span> <span class="o">=</span> <span class="n">sharp_z0194a_inittab</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mclk</span> <span class="o">=</span> <span class="mi">88000000UL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">skip_reinit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lock_output</span> <span class="o">=</span> <span class="n">STV0299_LOCKOUTPUT_1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">volt13_op0_op1</span> <span class="o">=</span> <span class="n">STV0299_VOLT13_OP1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min_delay_ms</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_symbol_rate</span> <span class="o">=</span> <span class="n">sharp_z0194a_set_symbol_rate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dm04_rs2000_set_ts_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">caller</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lme2510_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_talk_onoff</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">stream_on</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_talk_onoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lme2510_stream_restart</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">m88rs2000_config</span> <span class="n">m88rs2000_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_addr</span> <span class="o">=</span> <span class="mh">0xd0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner_addr</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ts_params</span> <span class="o">=</span> <span class="n">dm04_rs2000_set_ts_param</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dm04_lme2510_set_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
					<span class="n">fe_sec_voltage_t</span> <span class="n">voltage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">voltage_low</span><span class="p">[]</span>	<span class="o">=</span> <span class="n">LME_VOLTAGE_L</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">voltage_high</span><span class="p">[]</span> <span class="o">=</span> <span class="n">LME_VOLTAGE_H</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">rlen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">voltage</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEC_VOLTAGE_18</span>:
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">lme2510_usb_talk</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">voltage_high</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">,</span> <span class="n">rlen</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SEC_VOLTAGE_OFF</span>:
	<span class="k">case</span> <span class="n">SEC_VOLTAGE_13</span>:
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">lme2510_usb_talk</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">voltage_low</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">,</span> <span class="n">rlen</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dm04_rs2000_read_signal_strength</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">strength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lme2510_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="o">*</span><span class="n">strength</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)((</span><span class="n">u32</span><span class="p">)</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_level</span> <span class="o">*</span> <span class="mh">0xffff</span> <span class="o">/</span> <span class="mh">0x7f</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dm04_rs2000_read_snr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">snr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lme2510_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="o">*</span><span class="n">snr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)((</span><span class="n">u32</span><span class="p">)</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_sn</span> <span class="o">*</span> <span class="mh">0xffff</span> <span class="o">/</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lme_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lme2510_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">fe_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot; LG TDQY-P001F&quot;</span><span class="p">,</span> <span class="s">&quot; SHARP:BS2F7HZ7395&quot;</span><span class="p">,</span>
				<span class="s">&quot; SHARP:BS2F7HZ0194&quot;</span><span class="p">,</span> <span class="s">&quot; RS2000&quot;</span><span class="p">};</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
	<span class="n">strlcat</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fe_name</span><span class="p">[</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_config</span><span class="p">],</span> <span class="mi">128</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dm04_lme2510_frontend_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lme2510_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_talk_onoff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x1122</span>:
	<span class="k">case</span> <span class="mh">0x1120</span>:
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_gate</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda10086_attach</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">tda10086_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="p">(</span><span class="s">&quot;TUN Found Frontend TDA10086&quot;</span><span class="p">);</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_tuner_gate_w</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_tuner_gate_r</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_tuner_addr</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_config</span> <span class="o">=</span> <span class="n">TUNER_LG</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dvb_usb_lme2510_firmware</span> <span class="o">!=</span> <span class="n">TUNER_LG</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dvb_usb_lme2510_firmware</span> <span class="o">=</span> <span class="n">TUNER_LG</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">lme_firmware_switch</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_gate</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">stv0299_attach</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">sharp_z0194_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="p">(</span><span class="s">&quot;FE Found Stv0299&quot;</span><span class="p">);</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_tuner_gate_w</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_tuner_gate_r</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_tuner_addr</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_config</span> <span class="o">=</span> <span class="n">TUNER_S0194</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dvb_usb_lme2510_firmware</span> <span class="o">!=</span> <span class="n">TUNER_S0194</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dvb_usb_lme2510_firmware</span> <span class="o">=</span> <span class="n">TUNER_S0194</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">lme_firmware_switch</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_gate</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">stv0288_attach</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lme_config</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="p">(</span><span class="s">&quot;FE Found Stv0288&quot;</span><span class="p">);</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_tuner_gate_w</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_tuner_gate_r</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_tuner_addr</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_config</span> <span class="o">=</span> <span class="n">TUNER_S7395</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dvb_usb_lme2510_firmware</span> <span class="o">!=</span> <span class="n">TUNER_S7395</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dvb_usb_lme2510_firmware</span> <span class="o">=</span> <span class="n">TUNER_S7395</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">lme_firmware_switch</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="mh">0x22f0</span>:
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_gate</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">m88rs2000_attach</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">m88rs2000_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="p">(</span><span class="s">&quot;FE Found M88RS2000&quot;</span><span class="p">);</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_tuner_gate_w</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_tuner_gate_r</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_tuner_addr</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_config</span> <span class="o">=</span> <span class="n">TUNER_RS2000</span><span class="p">;</span>
			<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_signal_strength</span> <span class="o">=</span>
				<span class="n">dm04_rs2000_read_signal_strength</span><span class="p">;</span>
			<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_snr</span> <span class="o">=</span>
				<span class="n">dm04_rs2000_read_snr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="p">(</span><span class="s">&quot;DM04/QQBOX Not Powered up or not Supported&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dvb_frontend_detach</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">);</span>
			<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">rc_codes</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_voltage</span> <span class="o">=</span> <span class="n">dm04_lme2510_set_voltage</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lme_name</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dm04_lme2510_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lme2510_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tun_msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;TDA8263&quot;</span><span class="p">,</span> <span class="s">&quot;IX2505V&quot;</span><span class="p">,</span> <span class="s">&quot;DVB_PLL_OPERA&quot;</span><span class="p">,</span> <span class="s">&quot;RS2000&quot;</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_config</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TUNER_LG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda826x_attach</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_config</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_S7395</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">ix2505v_attach</span> <span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lme_tuner</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_config</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_S0194</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">dvb_pll_attach</span> <span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="n">DVB_PLL_OPERA1</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_config</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TUNER_RS2000</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">tuner_config</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;TUN Found %s tuner&quot;</span><span class="p">,</span> <span class="n">tun_msg</span><span class="p">[</span><span class="n">ret</span><span class="p">]);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;TUN No tuner found --- resetting device&quot;</span><span class="p">);</span>
		<span class="n">lme_coldreset</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Start the Interrupt*/</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lme2510_int_read</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;INT Unable to start Interrupt Service&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lme2510_powerup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lme2510_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">lnb_on</span><span class="p">[]</span> <span class="o">=</span> <span class="n">LNB_ON</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">lnb_off</span><span class="p">[]</span> <span class="o">=</span> <span class="n">LNB_OFF</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">rlen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">lme2510_usb_talk</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">lnb_on</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">,</span> <span class="n">rlen</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">lme2510_usb_talk</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">lnb_off</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">,</span> <span class="n">rlen</span><span class="p">);</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_talk_onoff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* DVB USB Driver stuff */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="n">lme2510_properties</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="n">lme2510c_properties</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lme2510_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="n">usb_reset_configuration</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>

	<span class="n">usb_set_interface</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">USB_SPEED_HIGH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_reset_device</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;DEV Failed to connect in HIGH SPEED mode&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lme2510_return_status</span><span class="p">(</span><span class="n">udev</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x44</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lme_firmware_switch</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">dvb_usb_device_init</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lme2510_properties</span><span class="p">,</span>
				     <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">adapter_nr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;DEV registering device driver&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">dvb_usb_device_init</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lme2510c_properties</span><span class="p">,</span>
				     <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">adapter_nr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;DEV registering device driver&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="p">(</span><span class="s">&quot;DEV lme2510 Error&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">lme2510_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x3344</span><span class="p">,</span> <span class="mh">0x1122</span><span class="p">)</span> <span class="p">},</span>  <span class="cm">/* LME2510 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x3344</span><span class="p">,</span> <span class="mh">0x1120</span><span class="p">)</span> <span class="p">},</span>  <span class="cm">/* LME2510C */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x3344</span><span class="p">,</span> <span class="mh">0x22f0</span><span class="p">)</span> <span class="p">},</span>  <span class="cm">/* LME2510C RS2000 */</span>
	<span class="p">{}</span>		<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">lme2510_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="n">lme2510_properties</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_IS_AN_I2C_ADAPTER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size_of_priv</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lme2510_state</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_adapters</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
		<span class="p">.</span><span class="n">num_frontends</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fe</span> <span class="o">=</span> <span class="p">{{</span>
			<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_ADAP_HAS_PID_FILTER</span><span class="o">|</span>
				<span class="n">DVB_USB_ADAP_NEED_PID_FILTERING</span><span class="o">|</span>
				<span class="n">DVB_USB_ADAP_PID_FILTER_CAN_BE_TURNED_OFF</span><span class="p">,</span>
			<span class="p">.</span><span class="n">streaming_ctrl</span>   <span class="o">=</span> <span class="n">lme2510_streaming_ctrl</span><span class="p">,</span>
			<span class="p">.</span><span class="n">pid_filter_count</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
			<span class="p">.</span><span class="n">pid_filter</span> <span class="o">=</span> <span class="n">lme2510_pid_filter</span><span class="p">,</span>
			<span class="p">.</span><span class="n">pid_filter_ctrl</span>  <span class="o">=</span> <span class="n">lme2510_pid_filter_ctrl</span><span class="p">,</span>
			<span class="p">.</span><span class="n">frontend_attach</span>  <span class="o">=</span> <span class="n">dm04_lme2510_frontend_attach</span><span class="p">,</span>
			<span class="p">.</span><span class="n">tuner_attach</span> <span class="o">=</span> <span class="n">dm04_lme2510_tuner</span><span class="p">,</span>
			<span class="cm">/* parameter for the MPEG2-data transfer */</span>
			<span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_BULK</span><span class="p">,</span>
				<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
				<span class="p">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
				<span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">bulk</span> <span class="o">=</span> <span class="p">{</span>
						<span class="p">.</span><span class="n">buffersize</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">,</span>

					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}},</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">protocol</span>	<span class="o">=</span> <span class="n">RC_TYPE_NEC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">module_name</span>	<span class="o">=</span> <span class="s">&quot;LME2510 Remote Control&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">allowed_protos</span>	<span class="o">=</span> <span class="n">RC_TYPE_NEC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rc_codes</span>	<span class="o">=</span> <span class="n">RC_MAP_LME2510</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">power_ctrl</span>       <span class="o">=</span> <span class="n">lme2510_powerup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">identify_state</span>   <span class="o">=</span> <span class="n">lme2510_identify_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">i2c_algo</span>         <span class="o">=</span> <span class="o">&amp;</span><span class="n">lme2510_i2c_algo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">generic_bulk_ctrl_endpoint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_device_descs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>   <span class="s">&quot;DM04_LME2510_DVB-S&quot;</span><span class="p">,</span>
			<span class="p">{</span> <span class="o">&amp;</span><span class="n">lme2510_table</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">NULL</span> <span class="p">},</span>
			<span class="p">},</span>

	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="n">lme2510c_properties</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_IS_AN_I2C_ADAPTER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size_of_priv</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lme2510_state</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_adapters</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
		<span class="p">.</span><span class="n">num_frontends</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fe</span> <span class="o">=</span> <span class="p">{{</span>
			<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_ADAP_HAS_PID_FILTER</span><span class="o">|</span>
				<span class="n">DVB_USB_ADAP_NEED_PID_FILTERING</span><span class="o">|</span>
				<span class="n">DVB_USB_ADAP_PID_FILTER_CAN_BE_TURNED_OFF</span><span class="p">,</span>
			<span class="p">.</span><span class="n">streaming_ctrl</span>   <span class="o">=</span> <span class="n">lme2510_streaming_ctrl</span><span class="p">,</span>
			<span class="p">.</span><span class="n">pid_filter_count</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
			<span class="p">.</span><span class="n">pid_filter</span> <span class="o">=</span> <span class="n">lme2510_pid_filter</span><span class="p">,</span>
			<span class="p">.</span><span class="n">pid_filter_ctrl</span>  <span class="o">=</span> <span class="n">lme2510_pid_filter_ctrl</span><span class="p">,</span>
			<span class="p">.</span><span class="n">frontend_attach</span>  <span class="o">=</span> <span class="n">dm04_lme2510_frontend_attach</span><span class="p">,</span>
			<span class="p">.</span><span class="n">tuner_attach</span> <span class="o">=</span> <span class="n">dm04_lme2510_tuner</span><span class="p">,</span>
			<span class="cm">/* parameter for the MPEG2-data transfer */</span>
			<span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_BULK</span><span class="p">,</span>
				<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
				<span class="p">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>
				<span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">bulk</span> <span class="o">=</span> <span class="p">{</span>
						<span class="p">.</span><span class="n">buffersize</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">,</span>

					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}},</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">protocol</span>	<span class="o">=</span> <span class="n">RC_TYPE_NEC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">module_name</span>	<span class="o">=</span> <span class="s">&quot;LME2510 Remote Control&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">allowed_protos</span>	<span class="o">=</span> <span class="n">RC_TYPE_NEC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rc_codes</span>	<span class="o">=</span> <span class="n">RC_MAP_LME2510</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">power_ctrl</span>       <span class="o">=</span> <span class="n">lme2510_powerup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">identify_state</span>   <span class="o">=</span> <span class="n">lme2510_identify_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">i2c_algo</span>         <span class="o">=</span> <span class="o">&amp;</span><span class="n">lme2510_i2c_algo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">generic_bulk_ctrl_endpoint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_device_descs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>   <span class="s">&quot;DM04_LME2510C_DVB-S&quot;</span><span class="p">,</span>
			<span class="p">{</span> <span class="o">&amp;</span><span class="n">lme2510_table</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">NULL</span> <span class="p">},</span>
			<span class="p">},</span>
		<span class="p">{</span>   <span class="s">&quot;DM04_LME2510C_DVB-S RS2000&quot;</span><span class="p">,</span>
			<span class="p">{</span> <span class="o">&amp;</span><span class="n">lme2510_table</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">NULL</span> <span class="p">},</span>
			<span class="p">},</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">lme2510_exit_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lme2510_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lme2510_kill_urb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stream</span><span class="p">);</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">feedcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">usb_buffer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">i2c_talk_onoff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">signal_sn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">usb_buffer</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">lme_urb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">lme_urb</span><span class="p">);</span>
		<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
				  <span class="n">st</span><span class="o">-&gt;</span><span class="n">lme_urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>
		<span class="n">info</span><span class="p">(</span><span class="s">&quot;Interrupt Service Stopped&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lme2510_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">usb_buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_buffer</span> <span class="o">=</span> <span class="n">lme2510_exit_int</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
		<span class="n">dvb_usb_device_exit</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usb_buffer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">usb_buffer</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">lme2510_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;LME2510C_DVB-S&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">lme2510_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>	<span class="o">=</span> <span class="n">lme2510_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">lme2510_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">lme2510_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Malcolm Priestley &lt;tvboxspy@gmail.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;LME2510(C) DVB-S USB2.0&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;1.99&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
