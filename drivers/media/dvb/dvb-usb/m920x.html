<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › dvb-usb › m920x.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>m920x.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* DVB USB compliant linux driver for MSI Mega Sky 580 DVB-T USB2.0 receiver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006 Aapo Tahkola (aet@rasterburn.org)</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> *	under the terms of the GNU General Public License as published by the</span>
<span class="cm"> *	Free Software Foundation, version 2.</span>
<span class="cm"> *</span>
<span class="cm"> * see Documentation/dvb/README.dvb-usb for more information</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;m920x.h&quot;</span>

<span class="cp">#include &quot;mt352.h&quot;</span>
<span class="cp">#include &quot;mt352_priv.h&quot;</span>
<span class="cp">#include &quot;qt1010.h&quot;</span>
<span class="cp">#include &quot;tda1004x.h&quot;</span>
<span class="cp">#include &quot;tda827x.h&quot;</span>

<span class="cp">#include &lt;media/tuner.h&gt;</span>
<span class="cp">#include &quot;tuner-simple.h&quot;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cm">/* debug */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dvb_usb_m920x_debug</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span><span class="n">dvb_usb_m920x_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;set debugging level (1=rc (or-able)).&quot;</span> <span class="n">DVB_USB_DEBUG_STATUS</span><span class="p">);</span>

<span class="n">DVB_DEFINE_MOD_OPT_ADAPTER_NR</span><span class="p">(</span><span class="n">adapter_nr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">m920x_set_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pid</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">m920x_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">request</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="n">request</span><span class="p">,</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span><span class="p">,</span>
			      <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;m920x_read = error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deb</span><span class="p">(</span><span class="s">&quot;m920x_read = no data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">m920x_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">request</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="n">request</span><span class="p">,</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span><span class="p">,</span>
			      <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m920x_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">m920x_inits</span> <span class="o">*</span><span class="n">rc_seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">epi</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">adap_enabled</span><span class="p">[</span><span class="n">M9206_MAX_ADAPTERS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="cm">/* Remote controller init. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_query</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deb</span><span class="p">(</span><span class="s">&quot;Initialising remote control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">rc_seq</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">m920x_write</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">M9206_CORE</span><span class="p">,</span>
					       <span class="n">rc_seq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					       <span class="n">rc_seq</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">deb</span><span class="p">(</span><span class="s">&quot;Initialising remote control failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">rc_seq</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">deb</span><span class="p">(</span><span class="s">&quot;Initialising remote control success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">num_adapters</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">props</span><span class="p">.</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">caps</span><span class="p">;</span>

	<span class="cm">/* Some devices(Dposh) might crash if we attempt touch at all. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DVB_USB_ADAP_HAS_PID_FILTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">num_adapters</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">epi</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">props</span><span class="p">.</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stream</span><span class="p">.</span><span class="n">endpoint</span> <span class="o">-</span> <span class="mh">0x81</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">epi</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">epi</span> <span class="o">&gt;=</span> <span class="n">M9206_MAX_ADAPTERS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;m920x: Unexpected adapter endpoint!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">adap_enabled</span><span class="p">[</span><span class="n">epi</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">M9206_MAX_ADAPTERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adap_enabled</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">m920x_set_filter</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x81</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">m920x_set_filter</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x81</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x02f5</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m920x_init_ep</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">alt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">alt</span> <span class="o">=</span> <span class="n">usb_altnum_to_altsetting</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deb</span><span class="p">(</span><span class="s">&quot;No alt found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">alt</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">,</span>
				 <span class="n">alt</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bAlternateSetting</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m920x_rc_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m920x_state</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rc_state</span><span class="p">;</span>

	<span class="n">rc_state</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc_state</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">m920x_read</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">M9206_CORE</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">M9206_RC_STATE</span><span class="p">,</span> <span class="n">rc_state</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">m920x_read</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">M9206_CORE</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">M9206_RC_KEY</span><span class="p">,</span> <span class="n">rc_state</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_map_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc5_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_map_table</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="n">rc_state</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">event</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span><span class="p">.</span><span class="n">rc_map_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">keycode</span><span class="p">;</span>

			<span class="k">switch</span><span class="p">(</span><span class="n">rc_state</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x80</span>:
				<span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">REMOTE_NO_KEY_PRESSED</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="k">case</span> <span class="mh">0x88</span>: <span class="cm">/* framing error or &quot;invalid code&quot; */</span>
			<span class="k">case</span> <span class="mh">0x99</span>:
			<span class="k">case</span> <span class="mh">0xc0</span>:
			<span class="k">case</span> <span class="mh">0xd8</span>:
				<span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">REMOTE_NO_KEY_PRESSED</span><span class="p">;</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">rep_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="k">case</span> <span class="mh">0x93</span>:
			<span class="k">case</span> <span class="mh">0x92</span>:
			<span class="k">case</span> <span class="mh">0x83</span>: <span class="cm">/* pinnacle PCTV310e */</span>
			<span class="k">case</span> <span class="mh">0x82</span>:
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">rep_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">REMOTE_KEY_PRESSED</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="k">case</span> <span class="mh">0x91</span>:
			<span class="k">case</span> <span class="mh">0x81</span>: <span class="cm">/* pinnacle PCTV310e */</span>
				<span class="cm">/* prevent immediate auto-repeat */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">rep_count</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">REMOTE_KEY_REPEAT</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">REMOTE_NO_KEY_PRESSED</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">deb</span><span class="p">(</span><span class="s">&quot;Unexpected rc state %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc_state</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">REMOTE_NO_KEY_PRESSED</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc_state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">deb</span><span class="p">(</span><span class="s">&quot;Unknown rc key %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc_state</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">REMOTE_NO_KEY_PRESSED</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rc_state</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* I2C */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">m920x_i2c_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">I2C_M_NO_RD_ACK</span> <span class="o">|</span> <span class="n">I2C_M_IGNORE_NAK</span> <span class="o">|</span> <span class="n">I2C_M_TEN</span><span class="p">)</span> <span class="o">||</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* For a 0 byte message, I think sending the address</span>
<span class="cm">			 * to index 0x80|0x40 would be the correct thing to</span>
<span class="cm">			 * do.  However, zero byte messages are only used for</span>
<span class="cm">			 * probing, and since we don&#39;t know how to get the</span>
<span class="cm">			 * slave&#39;s ack, we can&#39;t probe. */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Send START &amp; address/RW bit */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_NOSTART</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">m920x_write</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">M9206_I2C</span><span class="p">,</span>
					<span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span> <span class="o">?</span> <span class="mh">0x01</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x80</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
			<span class="cm">/* Should check for ack here, if we knew how. */</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Last byte of transaction?</span>
<span class="cm">				 * Send STOP, otherwise send ACK. */</span>
				<span class="kt">int</span> <span class="n">stop</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">num</span> <span class="o">&amp;&amp;</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x40</span> <span class="o">:</span> <span class="mh">0x01</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">m920x_read</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">M9206_I2C</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>
						      <span class="mh">0x20</span> <span class="o">|</span> <span class="n">stop</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Last byte of transaction? Then send STOP. */</span>
				<span class="kt">int</span> <span class="n">stop</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">num</span> <span class="o">&amp;&amp;</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x40</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">m920x_write</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">M9206_I2C</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">stop</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
				<span class="cm">/* Should check for ack here too. */</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>

 <span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">m920x_i2c_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">I2C_FUNC_I2C</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_algorithm</span> <span class="n">m920x_i2c_algo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">master_xfer</span>   <span class="o">=</span> <span class="n">m920x_i2c_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">functionality</span> <span class="o">=</span> <span class="n">m920x_i2c_func</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* pid filter */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">m920x_set_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&gt;=</span> <span class="mh">0x8000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pid</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">m920x_write</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">M9206_FILTER</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">idx</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">m920x_write</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">M9206_FILTER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">idx</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m920x_update_filters</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m920x_state</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enabled</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">filtering_enabled</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">filter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ep</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stream</span><span class="p">.</span><span class="n">endpoint</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">M9206_MAX_FILTERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8192</span><span class="p">)</span>
			<span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Disable all filters */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">m920x_set_filter</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">enabled</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">M9206_MAX_FILTERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">m920x_set_filter</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">M9206_MAX_FILTERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">m920x_set_filter</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span> <span class="n">filter</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">filter</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m920x_pid_filter_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m920x_state</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">m</span><span class="o">-&gt;</span><span class="n">filtering_enabled</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">onoff</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">m920x_update_filters</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m920x_pid_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">m920x_state</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">m</span><span class="o">-&gt;</span><span class="n">filters</span><span class="p">[</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">onoff</span> <span class="o">?</span> <span class="n">pid</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">m920x_update_filters</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m920x_firmware_download</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">read</span><span class="p">,</span> <span class="o">*</span><span class="n">buff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">pass</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">buff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">65536</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buff</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">read</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">read</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">m920x_read</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">M9206_FILTER</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="n">read</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">deb</span><span class="p">(</span><span class="s">&quot;%x %x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">read</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">read</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">read</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">read</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">m920x_read</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">M9206_FW</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">read</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">deb</span><span class="p">(</span><span class="s">&quot;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">read</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pass</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">pass</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;)</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>

			<span class="n">index</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>

			<span class="n">size</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pass</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Will stall if using fw-&gt;data ... */</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

				<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
						      <span class="n">M9206_FW</span><span class="p">,</span>
						      <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span><span class="p">,</span>
						      <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">deb</span><span class="p">(</span><span class="s">&quot;error while uploading fw!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">deb</span><span class="p">(</span><span class="s">&quot;bad firmware file!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">36</span><span class="p">);</span>

	<span class="cm">/* m920x will disconnect itself from the bus after this. */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">m920x_write</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">M9206_CORE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">M9206_FW_GO</span><span class="p">);</span>
	<span class="n">deb</span><span class="p">(</span><span class="s">&quot;firmware uploaded!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

 <span class="nl">done:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">read</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Callbacks for DVB USB */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">m920x_identify_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="o">*</span><span class="n">props</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">dvb_usb_device_description</span> <span class="o">**</span><span class="n">desc</span><span class="p">,</span>
				<span class="kt">int</span> <span class="o">*</span><span class="n">cold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">alt</span><span class="p">;</span>

	<span class="n">alt</span> <span class="o">=</span> <span class="n">usb_altnum_to_altsetting</span><span class="p">(</span><span class="n">usb_ifnum_to_if</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">cold</span> <span class="o">=</span> <span class="p">(</span><span class="n">alt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* demod configurations */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">m920x_mt352_demod_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_frontend</span> <span class="o">*</span><span class="n">fe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">config</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="mh">0x3d</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">clock</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">CLOCK_CTL</span><span class="p">,</span> <span class="mh">0x30</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">reset</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RESET</span><span class="p">,</span> <span class="mh">0x80</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">adc_ctl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ADC_CTL_1</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">agc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">AGC_TARGET</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x20</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">sec_agc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">unk1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x1a</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">unk2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x7a</span> <span class="p">};</span>

	<span class="n">deb</span><span class="p">(</span><span class="s">&quot;Demod init!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">config</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">clock</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">clock</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">reset</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">reset</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">adc_ctl</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">adc_ctl</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">agc</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">agc</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">sec_agc</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sec_agc</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">unk1</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">unk1</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">mt352_write</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">unk2</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">unk2</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mt352_config</span> <span class="n">m920x_mt352_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">,</span>
	<span class="p">.</span><span class="n">no_tuner</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">demod_init</span> <span class="o">=</span> <span class="n">m920x_mt352_demod_init</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tda1004x_config</span> <span class="n">m920x_tda10046_08_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert_oclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ts_mode</span> <span class="o">=</span> <span class="n">TDA10046_TS_SERIAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xtal_freq</span> <span class="o">=</span> <span class="n">TDA10046_XTAL_16M</span><span class="p">,</span>
	<span class="p">.</span><span class="n">if_freq</span> <span class="o">=</span> <span class="n">TDA10046_FREQ_045</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc_config</span> <span class="o">=</span> <span class="n">TDA10046_AGC_TDA827X</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_config</span> <span class="o">=</span> <span class="n">TDA10046_GPTRI</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_firmware</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tda1004x_config</span> <span class="n">m920x_tda10046_0b_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">demod_address</span> <span class="o">=</span> <span class="mh">0x0b</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invert_oclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ts_mode</span> <span class="o">=</span> <span class="n">TDA10046_TS_SERIAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xtal_freq</span> <span class="o">=</span> <span class="n">TDA10046_XTAL_16M</span><span class="p">,</span>
	<span class="p">.</span><span class="n">if_freq</span> <span class="o">=</span> <span class="n">TDA10046_FREQ_045</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc_config</span> <span class="o">=</span> <span class="n">TDA10046_AGC_TDA827X</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_config</span> <span class="o">=</span> <span class="n">TDA10046_GPTRI</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_firmware</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="cm">/* uses firmware EEPROM */</span>
<span class="p">};</span>

<span class="cm">/* tuner configurations */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">qt1010_config</span> <span class="n">m920x_qt1010_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">i2c_address</span> <span class="o">=</span> <span class="mh">0x62</span>
<span class="p">};</span>

<span class="cm">/* Callbacks for DVB USB */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">m920x_mt352_frontend_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">deb</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>

	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">mt352_attach</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">m920x_mt352_config</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m920x_tda10046_08_frontend_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">deb</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>

	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda10046_attach</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">m920x_tda10046_08_config</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m920x_tda10046_0b_frontend_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">deb</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>

	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda10046_attach</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">m920x_tda10046_0b_config</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m920x_qt1010_tuner_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">deb</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">qt1010_attach</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m920x_qt1010_config</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m920x_tda8275_60_tuner_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">deb</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda827x_attach</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m920x_tda8275_61_tuner_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">deb</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">tda827x_attach</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m920x_fmd1216me_tuner_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dvb_attach</span><span class="p">(</span><span class="n">simple_tuner_attach</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span>
		   <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span>
		   <span class="n">TUNER_PHILIPS_FMD1216ME_MK3</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* device-specific initialization */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">m920x_inits</span> <span class="n">megasky_rc_init</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">M9206_RC_INIT2</span><span class="p">,</span> <span class="mh">0xa8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">M9206_RC_INIT1</span><span class="p">,</span> <span class="mh">0x51</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* terminating entry */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">m920x_inits</span> <span class="n">tvwalkertwin_rc_init</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">M9206_RC_INIT2</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">M9206_RC_INIT1</span><span class="p">,</span> <span class="mh">0xef</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xff28</span><span class="p">,</span>         <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xff23</span><span class="p">,</span>         <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xff21</span><span class="p">,</span>         <span class="mh">0x30</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* terminating entry */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">m920x_inits</span> <span class="n">pinnacle310e_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* without these the tuner don&#39;t work */</span>
	<span class="p">{</span> <span class="mh">0xff20</span><span class="p">,</span>         <span class="mh">0x9b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xff22</span><span class="p">,</span>         <span class="mh">0x70</span> <span class="p">},</span>

	<span class="cm">/* rc settings */</span>
	<span class="p">{</span> <span class="mh">0xff50</span><span class="p">,</span>         <span class="mh">0x80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">M9206_RC_INIT1</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">M9206_RC_INIT2</span><span class="p">,</span> <span class="mh">0xff</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* terminating entry */</span>
<span class="p">};</span>

<span class="cm">/* ir keymaps */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rc_map_table</span> <span class="n">rc_map_megasky_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x0012</span><span class="p">,</span> <span class="n">KEY_POWER</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x001e</span><span class="p">,</span> <span class="n">KEY_CYCLEWINDOWS</span> <span class="p">},</span> <span class="cm">/* min/max */</span>
	<span class="p">{</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="n">KEY_CHANNELUP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0005</span><span class="p">,</span> <span class="n">KEY_CHANNELDOWN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="n">KEY_VOLUMEUP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="n">KEY_VOLUMEDOWN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0004</span><span class="p">,</span> <span class="n">KEY_MUTE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0007</span><span class="p">,</span> <span class="n">KEY_OK</span> <span class="p">},</span> <span class="cm">/* TS */</span>
	<span class="p">{</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="n">KEY_STOP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0009</span><span class="p">,</span> <span class="n">KEY_MENU</span> <span class="p">},</span> <span class="cm">/* swap */</span>
	<span class="p">{</span> <span class="mh">0x000a</span><span class="p">,</span> <span class="n">KEY_REWIND</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x001b</span><span class="p">,</span> <span class="n">KEY_PAUSE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x001f</span><span class="p">,</span> <span class="n">KEY_FASTFORWARD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000c</span><span class="p">,</span> <span class="n">KEY_RECORD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000d</span><span class="p">,</span> <span class="n">KEY_CAMERA</span> <span class="p">},</span> <span class="cm">/* screenshot */</span>
	<span class="p">{</span> <span class="mh">0x000e</span><span class="p">,</span> <span class="n">KEY_COFFEE</span> <span class="p">},</span> <span class="cm">/* &quot;MTS&quot; */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rc_map_table</span> <span class="n">rc_map_tvwalkertwin_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="n">KEY_ZOOM</span> <span class="p">},</span> <span class="cm">/* Full Screen */</span>
	<span class="p">{</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="n">KEY_CAMERA</span> <span class="p">},</span> <span class="cm">/* snapshot */</span>
	<span class="p">{</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="n">KEY_MUTE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0004</span><span class="p">,</span> <span class="n">KEY_REWIND</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0005</span><span class="p">,</span> <span class="n">KEY_PLAYPAUSE</span> <span class="p">},</span> <span class="cm">/* Play/Pause */</span>
	<span class="p">{</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="n">KEY_FASTFORWARD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0007</span><span class="p">,</span> <span class="n">KEY_RECORD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="n">KEY_STOP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0009</span><span class="p">,</span> <span class="n">KEY_TIME</span> <span class="p">},</span> <span class="cm">/* Timeshift */</span>
	<span class="p">{</span> <span class="mh">0x000c</span><span class="p">,</span> <span class="n">KEY_COFFEE</span> <span class="p">},</span> <span class="cm">/* Recall */</span>
	<span class="p">{</span> <span class="mh">0x000e</span><span class="p">,</span> <span class="n">KEY_CHANNELUP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0012</span><span class="p">,</span> <span class="n">KEY_POWER</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="n">KEY_MENU</span> <span class="p">},</span> <span class="cm">/* source */</span>
	<span class="p">{</span> <span class="mh">0x0018</span><span class="p">,</span> <span class="n">KEY_CYCLEWINDOWS</span> <span class="p">},</span> <span class="cm">/* TWIN PIP */</span>
	<span class="p">{</span> <span class="mh">0x001a</span><span class="p">,</span> <span class="n">KEY_CHANNELDOWN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x001b</span><span class="p">,</span> <span class="n">KEY_VOLUMEDOWN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x001e</span><span class="p">,</span> <span class="n">KEY_VOLUMEUP</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rc_map_table</span> <span class="n">rc_map_pinnacle310e_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x16</span><span class="p">,</span> <span class="n">KEY_POWER</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">KEY_FAVORITES</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">KEY_TEXT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x48</span><span class="p">,</span> <span class="n">KEY_PROGRAM</span> <span class="p">},</span>		<span class="cm">/* preview */</span>
	<span class="p">{</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="n">KEY_EPG</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">KEY_LIST</span> <span class="p">},</span>		<span class="cm">/* record list */</span>
	<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">KEY_1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">KEY_2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">KEY_3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="n">KEY_4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="n">KEY_5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">KEY_6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="n">KEY_7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x19</span><span class="p">,</span> <span class="n">KEY_8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="n">KEY_9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span> <span class="n">KEY_0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="n">KEY_CANCEL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="n">KEY_CLEAR</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x13</span><span class="p">,</span> <span class="n">KEY_BACK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">KEY_TAB</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="n">KEY_UP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="n">KEY_LEFT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x52</span><span class="p">,</span> <span class="n">KEY_RIGHT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x51</span><span class="p">,</span> <span class="n">KEY_DOWN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="n">KEY_ENTER</span> <span class="p">},</span>		<span class="cm">/* could also be KEY_OK */</span>
	<span class="p">{</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="n">KEY_VOLUMEUP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="n">KEY_VOLUMEDOWN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="n">KEY_CHANNELUP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">KEY_CHANNELDOWN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">KEY_RECORD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">KEY_PLAY</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="n">KEY_PAUSE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="n">KEY_STOP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">KEY_REWIND</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x12</span><span class="p">,</span> <span class="n">KEY_FASTFORWARD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x41</span><span class="p">,</span> <span class="n">KEY_PREVIOUSSONG</span> <span class="p">},</span>	<span class="cm">/* Replay */</span>
	<span class="p">{</span> <span class="mh">0x42</span><span class="p">,</span> <span class="n">KEY_NEXTSONG</span> <span class="p">},</span>		<span class="cm">/* Skip */</span>
	<span class="p">{</span> <span class="mh">0x54</span><span class="p">,</span> <span class="n">KEY_CAMERA</span> <span class="p">},</span>		<span class="cm">/* Capture */</span>
<span class="cm">/*	{ 0x50, KEY_SAP },	*/</span>		<span class="cm">/* Sap */</span>
	<span class="p">{</span> <span class="mh">0x47</span><span class="p">,</span> <span class="n">KEY_CYCLEWINDOWS</span> <span class="p">},</span>	<span class="cm">/* Pip */</span>
	<span class="p">{</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="n">KEY_SCREEN</span> <span class="p">},</span>		<span class="cm">/* FullScreen */</span>
	<span class="p">{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">KEY_SUBTITLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="n">KEY_MUTE</span> <span class="p">},</span>
<span class="cm">/*	{ 0x49, KEY_LR },	*/</span>		<span class="cm">/* L/R */</span>
	<span class="p">{</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">KEY_SLEEP</span> <span class="p">},</span>		<span class="cm">/* Hibernate */</span>
	<span class="p">{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">KEY_VIDEO</span> <span class="p">},</span>		<span class="cm">/* A/V */</span>
	<span class="p">{</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="n">KEY_MENU</span> <span class="p">},</span>		<span class="cm">/* Recall */</span>
	<span class="p">{</span> <span class="mh">0x45</span><span class="p">,</span> <span class="n">KEY_ZOOMIN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x46</span><span class="p">,</span> <span class="n">KEY_ZOOMOUT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">KEY_RED</span> <span class="p">},</span>		<span class="cm">/* Red */</span>
	<span class="p">{</span> <span class="mh">0x53</span><span class="p">,</span> <span class="n">KEY_GREEN</span> <span class="p">},</span>		<span class="cm">/* Green */</span>
	<span class="p">{</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="n">KEY_YELLOW</span> <span class="p">},</span>		<span class="cm">/* Yellow */</span>
	<span class="p">{</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="n">KEY_BLUE</span> <span class="p">},</span>		<span class="cm">/* Blue */</span>
<span class="p">};</span>

<span class="cm">/* DVB USB Driver stuff */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="n">megasky_properties</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="n">digivox_mini_ii_properties</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="n">tvwalkertwin_properties</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="n">dposh_properties</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="n">pinnacle_pctv310e_properties</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m920x_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">m920x_inits</span> <span class="o">*</span><span class="n">rc_init_seq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bInterfaceNumber</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>

	<span class="n">deb</span><span class="p">(</span><span class="s">&quot;Probing for m920x device at interface %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bInterfaceNumber</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bInterfaceNumber</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Single-tuner device, or first interface on</span>
<span class="cm">		 * multi-tuner device</span>
<span class="cm">		 */</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_usb_device_init</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">megasky_properties</span><span class="p">,</span>
					  <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">,</span> <span class="n">adapter_nr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc_init_seq</span> <span class="o">=</span> <span class="n">megasky_rc_init</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_usb_device_init</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">digivox_mini_ii_properties</span><span class="p">,</span>
					  <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">,</span> <span class="n">adapter_nr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* No remote control, so no rc_init_seq */</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* This configures both tuners on the TV Walker Twin */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_usb_device_init</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tvwalkertwin_properties</span><span class="p">,</span>
					  <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">,</span> <span class="n">adapter_nr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc_init_seq</span> <span class="o">=</span> <span class="n">tvwalkertwin_rc_init</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_usb_device_init</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dposh_properties</span><span class="p">,</span>
					  <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">,</span> <span class="n">adapter_nr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Remote controller not supported yet. */</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_usb_device_init</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pinnacle_pctv310e_properties</span><span class="p">,</span>
					  <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">,</span> <span class="n">adapter_nr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc_init_seq</span> <span class="o">=</span> <span class="n">pinnacle310e_init</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Another interface on a multi-tuner device */</span>

		<span class="cm">/* The LifeView TV Walker Twin gets here, but struct</span>
<span class="cm">		 * tvwalkertwin_properties already configured both</span>
<span class="cm">		 * tuners, so there is nothing for us to do here</span>
<span class="cm">		 */</span>
	<span class="p">}</span>

 <span class="nl">found:</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">m920x_init_ep</span><span class="p">(</span><span class="n">intf</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">m920x_init</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">rc_init_seq</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">m920x_table</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_MSI</span><span class="p">,</span> <span class="n">USB_PID_MSI_MEGASKY580</span><span class="p">)</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_ANUBIS_ELECTRONIC</span><span class="p">,</span>
			     <span class="n">USB_PID_MSI_DIGI_VOX_MINI_II</span><span class="p">)</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_ANUBIS_ELECTRONIC</span><span class="p">,</span>
			     <span class="n">USB_PID_LIFEVIEW_TV_WALKER_TWIN_COLD</span><span class="p">)</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_ANUBIS_ELECTRONIC</span><span class="p">,</span>
			     <span class="n">USB_PID_LIFEVIEW_TV_WALKER_TWIN_WARM</span><span class="p">)</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_DPOSH</span><span class="p">,</span> <span class="n">USB_PID_DPOSH_M9206_COLD</span><span class="p">)</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_DPOSH</span><span class="p">,</span> <span class="n">USB_PID_DPOSH_M9206_WARM</span><span class="p">)</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VID_VISIONPLUS</span><span class="p">,</span> <span class="n">USB_PID_PINNACLE_PCTV310E</span><span class="p">)</span> <span class="p">},</span>
		<span class="p">{</span> <span class="p">}</span>		<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span> <span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">m920x_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="n">megasky_properties</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_IS_AN_I2C_ADAPTER</span><span class="p">,</span>

	<span class="p">.</span><span class="n">usb_ctrl</span> <span class="o">=</span> <span class="n">DEVICE_SPECIFIC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">firmware</span> <span class="o">=</span> <span class="s">&quot;dvb-usb-megasky-02.fw&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">download_firmware</span> <span class="o">=</span> <span class="n">m920x_firmware_download</span><span class="p">,</span>

	<span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rc_interval</span>      <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rc_map_table</span>     <span class="o">=</span> <span class="n">rc_map_megasky_table</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rc_map_size</span>      <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rc_map_megasky_table</span><span class="p">),</span>
		<span class="p">.</span><span class="n">rc_query</span>         <span class="o">=</span> <span class="n">m920x_rc_query</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">size_of_priv</span>     <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">m920x_state</span><span class="p">),</span>

	<span class="p">.</span><span class="n">identify_state</span>   <span class="o">=</span> <span class="n">m920x_identify_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_adapters</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">{{</span>
		<span class="p">.</span><span class="n">num_frontends</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fe</span> <span class="o">=</span> <span class="p">{{</span>

		<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_ADAP_HAS_PID_FILTER</span> <span class="o">|</span>
			<span class="n">DVB_USB_ADAP_PID_FILTER_CAN_BE_TURNED_OFF</span><span class="p">,</span>

		<span class="p">.</span><span class="n">pid_filter_count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pid_filter</span>       <span class="o">=</span> <span class="n">m920x_pid_filter</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pid_filter_ctrl</span>  <span class="o">=</span> <span class="n">m920x_pid_filter_ctrl</span><span class="p">,</span>

		<span class="p">.</span><span class="n">frontend_attach</span>  <span class="o">=</span> <span class="n">m920x_mt352_frontend_attach</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tuner_attach</span>     <span class="o">=</span> <span class="n">m920x_qt1010_tuner_attach</span><span class="p">,</span>

		<span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_BULK</span><span class="p">,</span>
			<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
			<span class="p">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">,</span>
			<span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">bulk</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">buffersize</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">},</span>
		<span class="p">}},</span>
	<span class="p">}},</span>
	<span class="p">.</span><span class="n">i2c_algo</span>         <span class="o">=</span> <span class="o">&amp;</span><span class="n">m920x_i2c_algo</span><span class="p">,</span>

	<span class="p">.</span><span class="n">num_device_descs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>   <span class="s">&quot;MSI Mega Sky 580 DVB-T USB2.0&quot;</span><span class="p">,</span>
			<span class="p">{</span> <span class="o">&amp;</span><span class="n">m920x_table</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">NULL</span> <span class="p">},</span>
			<span class="p">{</span> <span class="nb">NULL</span> <span class="p">},</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="n">digivox_mini_ii_properties</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_IS_AN_I2C_ADAPTER</span><span class="p">,</span>

	<span class="p">.</span><span class="n">usb_ctrl</span> <span class="o">=</span> <span class="n">DEVICE_SPECIFIC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">firmware</span> <span class="o">=</span> <span class="s">&quot;dvb-usb-digivox-02.fw&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">download_firmware</span> <span class="o">=</span> <span class="n">m920x_firmware_download</span><span class="p">,</span>

	<span class="p">.</span><span class="n">size_of_priv</span>     <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">m920x_state</span><span class="p">),</span>

	<span class="p">.</span><span class="n">identify_state</span>   <span class="o">=</span> <span class="n">m920x_identify_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_adapters</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">{{</span>
		<span class="p">.</span><span class="n">num_frontends</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fe</span> <span class="o">=</span> <span class="p">{{</span>

		<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_ADAP_HAS_PID_FILTER</span> <span class="o">|</span>
			<span class="n">DVB_USB_ADAP_PID_FILTER_CAN_BE_TURNED_OFF</span><span class="p">,</span>

		<span class="p">.</span><span class="n">pid_filter_count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pid_filter</span>       <span class="o">=</span> <span class="n">m920x_pid_filter</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pid_filter_ctrl</span>  <span class="o">=</span> <span class="n">m920x_pid_filter_ctrl</span><span class="p">,</span>

		<span class="p">.</span><span class="n">frontend_attach</span>  <span class="o">=</span> <span class="n">m920x_tda10046_08_frontend_attach</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tuner_attach</span>     <span class="o">=</span> <span class="n">m920x_tda8275_60_tuner_attach</span><span class="p">,</span>

		<span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_BULK</span><span class="p">,</span>
			<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
			<span class="p">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">,</span>
			<span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">bulk</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">buffersize</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">,</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">},</span>
		<span class="p">}},</span>
	<span class="p">}},</span>
	<span class="p">.</span><span class="n">i2c_algo</span>         <span class="o">=</span> <span class="o">&amp;</span><span class="n">m920x_i2c_algo</span><span class="p">,</span>

	<span class="p">.</span><span class="n">num_device_descs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>   <span class="s">&quot;MSI DIGI VOX mini II DVB-T USB2.0&quot;</span><span class="p">,</span>
			<span class="p">{</span> <span class="o">&amp;</span><span class="n">m920x_table</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">NULL</span> <span class="p">},</span>
			<span class="p">{</span> <span class="nb">NULL</span> <span class="p">},</span>
		<span class="p">},</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* LifeView TV Walker Twin support by Nick Andrew &lt;nick@nick-andrew.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * LifeView TV Walker Twin has 1 x M9206, 2 x TDA10046, 2 x TDA8275A</span>
<span class="cm"> * TDA10046 #0 is located at i2c address 0x08</span>
<span class="cm"> * TDA10046 #1 is located at i2c address 0x0b</span>
<span class="cm"> * TDA8275A #0 is located at i2c address 0x60</span>
<span class="cm"> * TDA8275A #1 is located at i2c address 0x61</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="n">tvwalkertwin_properties</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_IS_AN_I2C_ADAPTER</span><span class="p">,</span>

	<span class="p">.</span><span class="n">usb_ctrl</span> <span class="o">=</span> <span class="n">DEVICE_SPECIFIC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">firmware</span> <span class="o">=</span> <span class="s">&quot;dvb-usb-tvwalkert.fw&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">download_firmware</span> <span class="o">=</span> <span class="n">m920x_firmware_download</span><span class="p">,</span>

	<span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rc_interval</span>      <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rc_map_table</span>     <span class="o">=</span> <span class="n">rc_map_tvwalkertwin_table</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rc_map_size</span>      <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rc_map_tvwalkertwin_table</span><span class="p">),</span>
		<span class="p">.</span><span class="n">rc_query</span>         <span class="o">=</span> <span class="n">m920x_rc_query</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">size_of_priv</span>     <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">m920x_state</span><span class="p">),</span>

	<span class="p">.</span><span class="n">identify_state</span>   <span class="o">=</span> <span class="n">m920x_identify_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_adapters</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">{{</span>
		<span class="p">.</span><span class="n">num_frontends</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fe</span> <span class="o">=</span> <span class="p">{{</span>

		<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_ADAP_HAS_PID_FILTER</span> <span class="o">|</span>
			<span class="n">DVB_USB_ADAP_PID_FILTER_CAN_BE_TURNED_OFF</span><span class="p">,</span>

		<span class="p">.</span><span class="n">pid_filter_count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pid_filter</span>       <span class="o">=</span> <span class="n">m920x_pid_filter</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pid_filter_ctrl</span>  <span class="o">=</span> <span class="n">m920x_pid_filter_ctrl</span><span class="p">,</span>

		<span class="p">.</span><span class="n">frontend_attach</span>  <span class="o">=</span> <span class="n">m920x_tda10046_08_frontend_attach</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tuner_attach</span>     <span class="o">=</span> <span class="n">m920x_tda8275_60_tuner_attach</span><span class="p">,</span>

		<span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_BULK</span><span class="p">,</span>
			<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
			<span class="p">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">,</span>
			<span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="p">{</span>
				 <span class="p">.</span><span class="n">bulk</span> <span class="o">=</span> <span class="p">{</span>
					 <span class="p">.</span><span class="n">buffersize</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
				 <span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}},</span>
		<span class="p">}},{</span>
		<span class="p">.</span><span class="n">num_frontends</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fe</span> <span class="o">=</span> <span class="p">{{</span>

		<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_ADAP_HAS_PID_FILTER</span> <span class="o">|</span>
			<span class="n">DVB_USB_ADAP_PID_FILTER_CAN_BE_TURNED_OFF</span><span class="p">,</span>

		<span class="p">.</span><span class="n">pid_filter_count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pid_filter</span>       <span class="o">=</span> <span class="n">m920x_pid_filter</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pid_filter_ctrl</span>  <span class="o">=</span> <span class="n">m920x_pid_filter_ctrl</span><span class="p">,</span>

		<span class="p">.</span><span class="n">frontend_attach</span>  <span class="o">=</span> <span class="n">m920x_tda10046_0b_frontend_attach</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tuner_attach</span>     <span class="o">=</span> <span class="n">m920x_tda8275_61_tuner_attach</span><span class="p">,</span>

		<span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_BULK</span><span class="p">,</span>
			<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
			<span class="p">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="mh">0x82</span><span class="p">,</span>
			<span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="p">{</span>
				 <span class="p">.</span><span class="n">bulk</span> <span class="o">=</span> <span class="p">{</span>
					 <span class="p">.</span><span class="n">buffersize</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
				 <span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}},</span>
		<span class="p">},</span>
	<span class="p">}},</span>
	<span class="p">.</span><span class="n">i2c_algo</span>         <span class="o">=</span> <span class="o">&amp;</span><span class="n">m920x_i2c_algo</span><span class="p">,</span>

	<span class="p">.</span><span class="n">num_device_descs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>   <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;LifeView TV Walker Twin DVB-T USB2.0&quot;</span><span class="p">,</span>
		    <span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">m920x_table</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">NULL</span> <span class="p">},</span>
		    <span class="p">.</span><span class="n">warm_ids</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">m920x_table</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nb">NULL</span> <span class="p">},</span>
		<span class="p">},</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="n">dposh_properties</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_IS_AN_I2C_ADAPTER</span><span class="p">,</span>

	<span class="p">.</span><span class="n">usb_ctrl</span> <span class="o">=</span> <span class="n">DEVICE_SPECIFIC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">firmware</span> <span class="o">=</span> <span class="s">&quot;dvb-usb-dposh-01.fw&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">download_firmware</span> <span class="o">=</span> <span class="n">m920x_firmware_download</span><span class="p">,</span>

	<span class="p">.</span><span class="n">size_of_priv</span>     <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">m920x_state</span><span class="p">),</span>

	<span class="p">.</span><span class="n">identify_state</span>   <span class="o">=</span> <span class="n">m920x_identify_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_adapters</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">{{</span>
		<span class="p">.</span><span class="n">num_frontends</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fe</span> <span class="o">=</span> <span class="p">{{</span>
		<span class="cm">/* Hardware pid filters don&#39;t work with this device/firmware */</span>

		<span class="p">.</span><span class="n">frontend_attach</span>  <span class="o">=</span> <span class="n">m920x_mt352_frontend_attach</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tuner_attach</span>     <span class="o">=</span> <span class="n">m920x_qt1010_tuner_attach</span><span class="p">,</span>

		<span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_BULK</span><span class="p">,</span>
			<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
			<span class="p">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">,</span>
			<span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="p">{</span>
				 <span class="p">.</span><span class="n">bulk</span> <span class="o">=</span> <span class="p">{</span>
					 <span class="p">.</span><span class="n">buffersize</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
				 <span class="p">}</span>
			<span class="p">}</span>
		<span class="p">},</span>
		<span class="p">}},</span>
	<span class="p">}},</span>
	<span class="p">.</span><span class="n">i2c_algo</span>         <span class="o">=</span> <span class="o">&amp;</span><span class="n">m920x_i2c_algo</span><span class="p">,</span>

	<span class="p">.</span><span class="n">num_device_descs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="p">{</span>
		 <span class="p">{</span>   <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Dposh DVB-T USB2.0&quot;</span><span class="p">,</span>
		     <span class="p">.</span><span class="n">cold_ids</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">m920x_table</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nb">NULL</span> <span class="p">},</span>
		     <span class="p">.</span><span class="n">warm_ids</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">m920x_table</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="nb">NULL</span> <span class="p">},</span>
		 <span class="p">},</span>
	 <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="n">pinnacle_pctv310e_properties</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_IS_AN_I2C_ADAPTER</span><span class="p">,</span>

	<span class="p">.</span><span class="n">usb_ctrl</span> <span class="o">=</span> <span class="n">DEVICE_SPECIFIC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">download_firmware</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>

	<span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">legacy</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rc_interval</span>      <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rc_map_table</span>     <span class="o">=</span> <span class="n">rc_map_pinnacle310e_table</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rc_map_size</span>      <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rc_map_pinnacle310e_table</span><span class="p">),</span>
		<span class="p">.</span><span class="n">rc_query</span>         <span class="o">=</span> <span class="n">m920x_rc_query</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">size_of_priv</span>     <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">m920x_state</span><span class="p">),</span>

	<span class="p">.</span><span class="n">identify_state</span>   <span class="o">=</span> <span class="n">m920x_identify_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_adapters</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">{{</span>
		<span class="p">.</span><span class="n">num_frontends</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fe</span> <span class="o">=</span> <span class="p">{{</span>

		<span class="p">.</span><span class="n">caps</span> <span class="o">=</span> <span class="n">DVB_USB_ADAP_HAS_PID_FILTER</span> <span class="o">|</span>
			<span class="n">DVB_USB_ADAP_PID_FILTER_CAN_BE_TURNED_OFF</span><span class="p">,</span>

		<span class="p">.</span><span class="n">pid_filter_count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pid_filter</span>       <span class="o">=</span> <span class="n">m920x_pid_filter</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pid_filter_ctrl</span>  <span class="o">=</span> <span class="n">m920x_pid_filter_ctrl</span><span class="p">,</span>

		<span class="p">.</span><span class="n">frontend_attach</span>  <span class="o">=</span> <span class="n">m920x_mt352_frontend_attach</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tuner_attach</span>     <span class="o">=</span> <span class="n">m920x_fmd1216me_tuner_attach</span><span class="p">,</span>

		<span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">USB_ISOC</span><span class="p">,</span>
			<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
			<span class="p">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">,</span>
			<span class="p">.</span><span class="n">u</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">isoc</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">framesperurb</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
					<span class="p">.</span><span class="n">framesize</span> <span class="o">=</span> <span class="mi">564</span><span class="p">,</span>
					<span class="p">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">},</span>
		<span class="p">}},</span>
	<span class="p">}</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">i2c_algo</span>         <span class="o">=</span> <span class="o">&amp;</span><span class="n">m920x_i2c_algo</span><span class="p">,</span>

	<span class="p">.</span><span class="n">num_device_descs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>   <span class="s">&quot;Pinnacle PCTV 310e&quot;</span><span class="p">,</span>
			<span class="p">{</span> <span class="o">&amp;</span><span class="n">m920x_table</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="nb">NULL</span> <span class="p">},</span>
			<span class="p">{</span> <span class="nb">NULL</span> <span class="p">},</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">m920x_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;dvb_usb_m920x&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">m920x_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>	<span class="o">=</span> <span class="n">dvb_usb_device_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">m920x_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">m920x_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Aapo Tahkola &lt;aet@rasterburn.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;DVB Driver for ULI M920x&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;0.1&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> * c-basic-offset: 8</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
