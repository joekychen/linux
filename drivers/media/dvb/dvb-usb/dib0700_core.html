<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › dvb-usb › dib0700_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>dib0700_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Linux driver for devices based on the DiBcom DiB0700 USB bridge</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> *	under the terms of the GNU General Public License as published by the Free</span>
<span class="cm"> *	Software Foundation, version 2.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2005-6 DiBcom, SA</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;dib0700.h&quot;</span>

<span class="cm">/* debug */</span>
<span class="kt">int</span> <span class="n">dvb_usb_dib0700_debug</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span><span class="n">dvb_usb_dib0700_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;set debugging level (1=info,2=fw,4=fwdata,8=data (or-able)).&quot;</span> <span class="n">DVB_USB_DEBUG_STATUS</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">nb_packet_buffer_size</span> <span class="o">=</span> <span class="mi">21</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nb_packet_buffer_size</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nb_packet_buffer_size</span><span class="p">,</span>
	<span class="s">&quot;Set the dib0700 driver data buffer size. This parameter &quot;</span>
	<span class="s">&quot;corresponds to the number of TS packets. The actual size of &quot;</span>
	<span class="s">&quot;the data buffer corresponds to this parameter &quot;</span>
	<span class="s">&quot;multiplied by 188 (default: 21)&quot;</span><span class="p">);</span>

<span class="n">DVB_DEFINE_MOD_OPT_ADAPTER_NR</span><span class="p">(</span><span class="n">adapter_nr</span><span class="p">);</span>


<span class="kt">int</span> <span class="nf">dib0700_get_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">hwversion</span><span class="p">,</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">romversion</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ramversion</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">fwtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0700_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;could not acquire lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				  <span class="n">REQUEST_GET_VERSION</span><span class="p">,</span>
				  <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">USB_CTRL_GET_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwversion</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">hwversion</span>  <span class="o">=</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>  <span class="o">|</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>  <span class="o">|</span>
			<span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>  <span class="o">|</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">romversion</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">romversion</span> <span class="o">=</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>  <span class="o">|</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>  <span class="o">|</span>
			<span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>  <span class="o">|</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ramversion</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ramversion</span> <span class="o">=</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>  <span class="o">|</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>  <span class="o">|</span>
			<span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fwtype</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">fwtype</span>     <span class="o">=</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* expecting rx buffer: request data[0] data[1] ... data[2] */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0700_ctrl_wr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">txlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">deb_data</span><span class="p">(</span><span class="s">&quot;&gt;&gt;&gt; &quot;</span><span class="p">);</span>
	<span class="n">debug_dump</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">txlen</span><span class="p">,</span> <span class="n">deb_data</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
		<span class="n">tx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">txlen</span><span class="p">,</span>
		<span class="n">USB_CTRL_GET_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">txlen</span><span class="p">)</span>
		<span class="n">deb_data</span><span class="p">(</span><span class="s">&quot;ep 0 write error (status = %d, len: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">status</span><span class="p">,</span><span class="n">txlen</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">status</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* expecting tx buffer: request data[0] ... data[n] (n &lt;= 4) */</span>
<span class="kt">int</span> <span class="nf">dib0700_ctrl_rd</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">txlen</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rxlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txlen</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;tx buffer length is smaller than 2. Makes no sense.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txlen</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;tx buffer length is larger than 4. Not supported.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">deb_data</span><span class="p">(</span><span class="s">&quot;&gt;&gt;&gt; &quot;</span><span class="p">);</span>
	<span class="n">debug_dump</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span><span class="n">txlen</span><span class="p">,</span><span class="n">deb_data</span><span class="p">);</span>

	<span class="n">value</span> <span class="o">=</span> <span class="p">((</span><span class="n">txlen</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tx</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txlen</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txlen</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">|=</span> <span class="n">tx</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">tx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">rxlen</span><span class="p">,</span>
			<span class="n">USB_CTRL_GET_TIMEOUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;ep 0 read error (status = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>

	<span class="n">deb_data</span><span class="p">(</span><span class="s">&quot;&lt;&lt;&lt; &quot;</span><span class="p">);</span>
	<span class="n">debug_dump</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">rxlen</span><span class="p">,</span> <span class="n">deb_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span> <span class="cm">/* length in case of success */</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dib0700_set_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dib07x0_gpios</span> <span class="n">gpio</span><span class="p">,</span> <span class="n">u8</span> <span class="n">gpio_dir</span><span class="p">,</span> <span class="n">u8</span> <span class="n">gpio_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0700_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;could not acquire lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">REQUEST_SET_GPIO</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpio</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">gpio_dir</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">gpio_val</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dib0700_ctrl_wr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0700_set_usb_xfer_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u16</span> <span class="n">nb_ts_packets</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0700_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">fw_version</span> <span class="o">&gt;=</span> <span class="mh">0x10201</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;could not acquire lock&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">REQUEST_SET_USB_XFER_LEN</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nb_ts_packets</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">nb_ts_packets</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;set the USB xfer len to %i Ts packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nb_ts_packets</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">dib0700_ctrl_wr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;this firmware does not allow to change the USB xfer len</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * I2C master xfer function (supported in 1.20 firmware)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0700_i2c_xfer_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The new i2c firmware messages are more reliable and in particular</span>
<span class="cm">	   properly support i2c read calls not preceded by a write */</span>

	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dib0700_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">bus_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* 0=eeprom bus, 1=frontend bus */</span>
	<span class="kt">uint8_t</span> <span class="n">gen_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* 0=master i2c, 1=gpio i2c */</span>
	<span class="kt">uint8_t</span> <span class="n">en_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">en_stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Ensure nobody else hits the i2c bus while we&#39;re sending our</span>
<span class="cm">	   sequence of messages, (such as the remote control thread) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* First message in the transaction */</span>
			<span class="n">en_start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_NOSTART</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Device supports repeated-start */</span>
			<span class="n">en_start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Not the first packet and device doesn&#39;t support</span>
<span class="cm">			   repeated start */</span>
			<span class="n">en_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Last message in the transaction */</span>
			<span class="n">en_stop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Read request */</span>
			<span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>
			<span class="kt">uint8_t</span> <span class="n">i2c_dest</span><span class="p">;</span>

			<span class="n">i2c_dest</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">value</span> <span class="o">=</span> <span class="p">((</span><span class="n">en_start</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">en_stop</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">i2c_dest</span><span class="p">;</span>
			<span class="cm">/* I2C ctrl + FE bus; */</span>
			<span class="n">index</span> <span class="o">=</span> <span class="p">((</span><span class="n">gen_mode</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">bus_mode</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">);</span>

			<span class="n">result</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
						 <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
						 <span class="n">REQUEST_NEW_I2C_READ</span><span class="p">,</span>
						 <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span><span class="p">,</span>
						 <span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span>
						 <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">,</span>
						 <span class="n">USB_CTRL_GET_TIMEOUT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;i2c read error (status = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">deb_data</span><span class="p">(</span><span class="s">&quot;&lt;&lt;&lt; &quot;</span><span class="p">);</span>
			<span class="n">debug_dump</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">,</span> <span class="n">deb_data</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Write request */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span><span class="p">(</span><span class="s">&quot;could not acquire lock&quot;</span><span class="p">);</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">REQUEST_NEW_I2C_WRITE</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">en_start</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">en_stop</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">);</span>
			<span class="cm">/* I2C ctrl + FE bus; */</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">gen_mode</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">|</span>
				 <span class="p">((</span><span class="n">bus_mode</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">);</span>
			<span class="cm">/* The Actual i2c payload */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>

			<span class="n">deb_data</span><span class="p">(</span><span class="s">&quot;&gt;&gt;&gt; &quot;</span><span class="p">);</span>
			<span class="n">debug_dump</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">deb_data</span><span class="p">);</span>

			<span class="n">result</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
						 <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
						 <span class="n">REQUEST_NEW_I2C_WRITE</span><span class="p">,</span>
						 <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span><span class="p">,</span>
						 <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
						 <span class="n">USB_CTRL_GET_TIMEOUT</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;i2c write error (status = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * I2C master xfer function (pre-1.20 firmware)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0700_i2c_xfer_legacy</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dib0700_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;could not acquire lock&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* fill in the address */</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* fill the buffer */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>

		<span class="cm">/* write/read request */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">num</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">REQUEST_I2C_READ</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* special thing in the current firmware: when length is zero the read-failed */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">dib0700_ctrl_rd</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
					<span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;I2C read failed on address 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">REQUEST_I2C_WRITE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dib0700_ctrl_wr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0700_i2c_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dib0700_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">fw_use_new_i2c_api</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* User running at least fw 1.20 */</span>
		<span class="k">return</span> <span class="n">dib0700_i2c_xfer_new</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Use legacy calls */</span>
		<span class="k">return</span> <span class="n">dib0700_i2c_xfer_legacy</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">dib0700_i2c_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">I2C_FUNC_I2C</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">i2c_algorithm</span> <span class="n">dib0700_i2c_algo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">master_xfer</span>   <span class="o">=</span> <span class="n">dib0700_i2c_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">functionality</span> <span class="o">=</span> <span class="n">dib0700_i2c_func</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">dib0700_identify_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dvb_usb_device_properties</span> <span class="o">*</span><span class="n">props</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">dvb_usb_device_description</span> <span class="o">**</span><span class="n">desc</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s16</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>

	<span class="n">b</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="p">)</span>
		<span class="k">return</span>	<span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>


	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">REQUEST_GET_VERSION</span><span class="p">,</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">USB_CTRL_GET_TIMEOUT</span><span class="p">);</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;FW GET_VERSION length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>

	<span class="o">*</span><span class="n">cold</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;cold: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">cold</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0700_set_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u8</span> <span class="n">en_pll</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">pll_src</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pll_range</span><span class="p">,</span> <span class="n">u8</span> <span class="n">clock_gpio3</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pll_prediv</span><span class="p">,</span>
	<span class="n">u16</span> <span class="n">pll_loopdiv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">free_div</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dsuScaler</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0700_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;could not acquire lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">REQUEST_SET_CLOCK</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">en_pll</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pll_src</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">pll_range</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">clock_gpio3</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll_prediv</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* MSB */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>  <span class="n">pll_prediv</span>        <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* LSB */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll_loopdiv</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* MSB */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>  <span class="n">pll_loopdiv</span>       <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* LSB */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">free_div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>    <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* MSB */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span>  <span class="n">free_div</span>          <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* LSB */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsuScaler</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>   <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* MSB */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span>  <span class="n">dsuScaler</span>         <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* LSB */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dib0700_ctrl_wr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dib0700_set_i2c_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u16</span> <span class="n">scl_kHz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0700_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">divider</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scl_kHz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;could not acquire lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">REQUEST_SET_I2C_PARAM</span><span class="p">;</span>
	<span class="n">divider</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="mi">30000</span> <span class="o">/</span> <span class="n">scl_kHz</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">divider</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">divider</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">divider</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="mi">72000</span> <span class="o">/</span> <span class="n">scl_kHz</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">divider</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">divider</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">divider</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="mi">72000</span> <span class="o">/</span> <span class="n">scl_kHz</span><span class="p">);</span> <span class="cm">/* clock: 72MHz */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">divider</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">divider</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;setting I2C speed: %04x %04x %04x (%d kHz).&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">scl_kHz</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dib0700_ctrl_wr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">dib0700_ctrl_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u32</span> <span class="n">clk_MHz</span><span class="p">,</span> <span class="n">u8</span> <span class="n">clock_out_gp3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">clk_MHz</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">72</span>: <span class="n">dib0700_set_clock</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">clock_out_gp3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0700_jumpram</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">actlen</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">REQUEST_JUMPRAM</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span>  <span class="n">address</span>        <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">),</span><span class="n">buf</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="o">&amp;</span><span class="n">actlen</span><span class="p">,</span><span class="mi">1000</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deb_fw</span><span class="p">(</span><span class="s">&quot;jumpram to 0x%x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">address</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">actlen</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deb_fw</span><span class="p">(</span><span class="s">&quot;jumpram to 0x%x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">address</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dib0700_download_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hexline</span> <span class="n">hx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">act_len</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">adap_num</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fw_version</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">260</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_usb_get_hexline</span><span class="p">(</span><span class="n">fw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deb_fwdata</span><span class="p">(</span><span class="s">&quot;writing to address 0x%08x (buffer: 0x%02x %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hx</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">hx</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">hx</span><span class="p">.</span><span class="n">chk</span><span class="p">);</span>

		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hx</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hx</span><span class="p">.</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">hx</span><span class="p">.</span><span class="n">addr</span>       <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">hx</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">hx</span><span class="p">.</span><span class="n">data</span><span class="p">,</span><span class="n">hx</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="o">+</span><span class="n">hx</span><span class="p">.</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="n">hx</span><span class="p">.</span><span class="n">chk</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span>
			<span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">),</span>
			<span class="n">buf</span><span class="p">,</span>
			<span class="n">hx</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">act_len</span><span class="p">,</span>
			<span class="mi">1000</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span><span class="p">(</span><span class="s">&quot;firmware download failed at %d with %d&quot;</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* start the firmware */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">dib0700_jumpram</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mh">0x70000000</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="p">(</span><span class="s">&quot;firmware started successfully.&quot;</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* the number of ts packet has to be at least 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nb_packet_buffer_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">nb_packet_buffer_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* get the fimware version */</span>
	<span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				  <span class="n">REQUEST_GET_VERSION</span><span class="p">,</span>
				  <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">USB_CTRL_GET_TIMEOUT</span><span class="p">);</span>
	<span class="n">fw_version</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>

	<span class="cm">/* set the buffer size - DVB-USB is allocating URB buffers</span>
<span class="cm">	 * only after the firwmare download was successful */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dib0700_device_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">adap_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">adap_num</span> <span class="o">&lt;</span> <span class="n">dib0700_devices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num_adapters</span><span class="p">;</span>
				<span class="n">adap_num</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fw_version</span> <span class="o">&gt;=</span> <span class="mh">0x10201</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dib0700_devices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adapter</span><span class="p">[</span><span class="n">adap_num</span><span class="p">].</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stream</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bulk</span><span class="p">.</span><span class="n">buffersize</span> <span class="o">=</span> <span class="mi">188</span><span class="o">*</span><span class="n">nb_packet_buffer_size</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* for fw version older than 1.20.1,</span>
<span class="cm">				 * the buffersize has to be n times 512 */</span>
				<span class="n">dib0700_devices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adapter</span><span class="p">[</span><span class="n">adap_num</span><span class="p">].</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stream</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bulk</span><span class="p">.</span><span class="n">buffersize</span> <span class="o">=</span> <span class="p">((</span><span class="mi">188</span><span class="o">*</span><span class="n">nb_packet_buffer_size</span><span class="o">+</span><span class="mi">188</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">512</span><span class="p">)</span><span class="o">*</span><span class="mi">512</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dib0700_devices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adapter</span><span class="p">[</span><span class="n">adap_num</span><span class="p">].</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stream</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bulk</span><span class="p">.</span><span class="n">buffersize</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">)</span>
					<span class="n">dib0700_devices</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adapter</span><span class="p">[</span><span class="n">adap_num</span><span class="p">].</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stream</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bulk</span><span class="p">.</span><span class="n">buffersize</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dib0700_streaming_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0700_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">onoff</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">fw_version</span> <span class="o">&gt;=</span> <span class="mh">0x10201</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* for firmware later than 1.20.1,</span>
<span class="cm">		 * the USB xfer length can be set  */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dib0700_set_usb_xfer_len</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">nb_packet_buffer_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;can not set the USB xfer len</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;could not acquire lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">REQUEST_ENABLE_VIDEO</span><span class="p">;</span>
	<span class="cm">/* this bit gives a kind of command,</span>
<span class="cm">	 * rather than enabling something or not */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">onoff</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">disable_streaming_master_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* Master mode */</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;modifying (%d) streaming state for %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">onoff</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">channel_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stream</span><span class="p">.</span><span class="n">props</span><span class="p">.</span><span class="n">endpoint</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stream</span><span class="p">.</span><span class="n">props</span><span class="p">.</span><span class="n">endpoint</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;the endpoint number (%i) is not correct, use the adapter id instead&quot;</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stream</span><span class="p">.</span><span class="n">props</span><span class="p">.</span><span class="n">endpoint</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">channel_state</span> <span class="o">|=</span>	<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">channel_state</span> <span class="o">|=</span>	<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="o">~</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">channel_state</span> <span class="o">|=</span>	<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stream</span><span class="p">.</span><span class="n">props</span><span class="p">.</span><span class="n">endpoint</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">channel_state</span> <span class="o">|=</span>	<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="o">-</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stream</span><span class="p">.</span><span class="n">props</span><span class="p">.</span><span class="n">endpoint</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">channel_state</span><span class="p">;</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;data for streaming: %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dib0700_ctrl_wr</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dib0700_change_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="n">u64</span> <span class="n">rc_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib0700_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_proto</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;could not acquire lock&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">REQUEST_SET_RC</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set the IR mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc_type</span> <span class="o">==</span> <span class="n">RC_TYPE_RC5</span><span class="p">)</span>
		<span class="n">new_proto</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc_type</span> <span class="o">==</span> <span class="n">RC_TYPE_NEC</span><span class="p">)</span>
		<span class="n">new_proto</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc_type</span> <span class="o">==</span> <span class="n">RC_TYPE_RC6</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">fw_version</span> <span class="o">&lt;</span> <span class="mh">0x10200</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">new_proto</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_proto</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dib0700_ctrl_wr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;ir protocol setup failed&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">rc_type</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">usb_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Number of keypresses to ignore before start repeating */</span>
<span class="cp">#define RC_REPEAT_DELAY_V1_20 10</span>

<span class="cm">/* This is the structure of the RC response packet starting in firmware 1.20 */</span>
<span class="k">struct</span> <span class="n">dib0700_rc_response</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">report_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data_state</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">system16</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">not_system</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">system</span><span class="p">;</span>
		<span class="p">};</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">not_data</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#define RC_MSG_SIZE_V1_20 6</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dib0700_rc_urb_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">purb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">purb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dib0700_rc_response</span> <span class="o">*</span><span class="n">poll_reply</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">keycode</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">toggle</span><span class="p">;</span>

	<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This will occur if disable_rc_polling=1 */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">purb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">purb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">poll_reply</span> <span class="o">=</span> <span class="n">purb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">purb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;discontinuing polling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">purb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">purb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">purb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">!=</span> <span class="n">RC_MSG_SIZE_V1_20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;malformed rc msg size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">purb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">resubmit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">deb_data</span><span class="p">(</span><span class="s">&quot;IR ID = %02X state = %02X System = %02X %02X Cmd = %02X %02X (len %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">report_id</span><span class="p">,</span> <span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">data_state</span><span class="p">,</span>
		 <span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">,</span> <span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">not_system</span><span class="p">,</span>
		 <span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">not_data</span><span class="p">,</span>
		 <span class="n">purb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RC_TYPE_NEC</span>:
		<span class="n">toggle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* NEC protocol sends repeat code as 0 0 0 FF */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">system</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">not_data</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">data_state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">system</span> <span class="o">^</span> <span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">not_system</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">deb_data</span><span class="p">(</span><span class="s">&quot;NEC extended protocol</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* NEC extended code - 24 bits */</span>
			<span class="n">keycode</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">system16</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">deb_data</span><span class="p">(</span><span class="s">&quot;NEC normal protocol</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* normal NEC code - 16 bits */</span>
			<span class="n">keycode</span> <span class="o">=</span> <span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">system</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">deb_data</span><span class="p">(</span><span class="s">&quot;RC5 protocol</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* RC5 Protocol */</span>
		<span class="n">toggle</span> <span class="o">=</span> <span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">report_id</span><span class="p">;</span>
		<span class="n">keycode</span> <span class="o">=</span> <span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">system</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">not_data</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Key failed integrity check */</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;key failed integrity check: %04x %02x %02x&quot;</span><span class="p">,</span>
		    <span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">system</span><span class="p">,</span>
		    <span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">poll_reply</span><span class="o">-&gt;</span><span class="n">not_data</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">resubmit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc_keydown</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">rc_dev</span><span class="p">,</span> <span class="n">keycode</span><span class="p">,</span> <span class="n">toggle</span><span class="p">);</span>

<span class="nl">resubmit:</span>
	<span class="cm">/* Clean the buffer before we requeue */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">purb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RC_MSG_SIZE_V1_20</span><span class="p">);</span>

	<span class="cm">/* Requeue URB */</span>
	<span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">purb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">dib0700_rc_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dib0700_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">purb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Poll-based. Don&#39;t initialize bulk mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">fw_version</span> <span class="o">&lt;</span> <span class="mh">0x10200</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Starting in firmware 1.20, the RC info is provided on a bulk pipe */</span>
	<span class="n">purb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">purb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;rc usb alloc urb failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">purb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">RC_MSG_SIZE_V1_20</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">purb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;rc kzalloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">purb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">purb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">purb</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
			  <span class="n">purb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span> <span class="n">RC_MSG_SIZE_V1_20</span><span class="p">,</span>
			  <span class="n">dib0700_rc_urb_completion</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">purb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;rc submit urb failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">purb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">purb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dib0700_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dib0700_device_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb_usb_device_init</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dib0700_devices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">dev</span><span class="p">,</span> <span class="n">adapter_nr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">dib0700_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">hwversion</span><span class="p">,</span> <span class="n">romversion</span><span class="p">,</span> <span class="n">fw_version</span><span class="p">,</span> <span class="n">fwtype</span><span class="p">;</span>

			<span class="n">dib0700_get_version</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hwversion</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">romversion</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">fw_version</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fwtype</span><span class="p">);</span>

			<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;Firmware version: %x, %d, 0x%x, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hwversion</span><span class="p">,</span> <span class="n">romversion</span><span class="p">,</span> <span class="n">fw_version</span><span class="p">,</span> <span class="n">fwtype</span><span class="p">);</span>

			<span class="n">st</span><span class="o">-&gt;</span><span class="n">fw_version</span> <span class="o">=</span> <span class="n">fw_version</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">nb_packet_buffer_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">nb_packet_buffer_size</span><span class="p">;</span>

			<span class="cm">/* Disable polling mode on newer firmwares */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">fw_version</span> <span class="o">&gt;=</span> <span class="mh">0x10200</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">bulk_mode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">bulk_mode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="n">dib0700_rc_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">dib0700_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;dvb_usb_dib0700&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>      <span class="o">=</span> <span class="n">dib0700_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">dvb_usb_device_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>   <span class="o">=</span> <span class="n">dib0700_usb_id_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">dib0700_driver</span><span class="p">);</span>

<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;dvb-usb-dib0700-1.20.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Patrick Boettcher &lt;pboettcher@dibcom.fr&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for devices based on DiBcom DiB0700 - USB bridge&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;1.0&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
