<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › dvb-usb › dibusb-common.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>dibusb-common.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Common methods for dibusb-based-receivers.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004-5 Patrick Boettcher (patrick.boettcher@desy.de)</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> *	under the terms of the GNU General Public License as published by the Free</span>
<span class="cm"> *	Software Foundation, version 2.</span>
<span class="cm"> *</span>
<span class="cm"> * see Documentation/dvb/README.dvb-usb for more information</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;dibusb.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;set debugging level (1=info (|-able)).&quot;</span> <span class="n">DVB_USB_DEBUG_STATUS</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cp">#define deb_info(args...) dprintk(debug,0x01,args)</span>

<span class="cm">/* common stuff used by the different dibusb modules */</span>
<span class="kt">int</span> <span class="nf">dibusb_streaming_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dibusb_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">fifo_ctrl</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">fifo_ctrl</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span> <span class="n">onoff</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span><span class="p">(</span><span class="s">&quot;error while controlling the fifo of the demod.&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dibusb_streaming_ctrl</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dibusb_pid_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dibusb_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">pid_ctrl</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">pid_ctrl</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span>
					 <span class="n">index</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">onoff</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dibusb_pid_filter</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dibusb_pid_filter_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dibusb_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">pid_parse</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">pid_parse</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span> <span class="n">onoff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">err</span><span class="p">(</span><span class="s">&quot;could not handle pid_parser&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dibusb_pid_filter_ctrl</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dibusb_power_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">DIBUSB_REQ_SET_IOCTL</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">DIBUSB_IOCTL_CMD_POWER_MODE</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">onoff</span> <span class="o">?</span> <span class="n">DIBUSB_IOCTL_POWER_WAKEUP</span> <span class="o">:</span> <span class="n">DIBUSB_IOCTL_POWER_SLEEP</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_usb_generic_write</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dibusb_power_ctrl</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dibusb2_0_streaming_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">dibusb_streaming_ctrl</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span><span class="n">onoff</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">DIBUSB_REQ_SET_STREAMING_MODE</span><span class="p">;</span>
		<span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">dvb_usb_generic_write</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">DIBUSB_REQ_SET_IOCTL</span><span class="p">;</span>
	<span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">onoff</span> <span class="o">?</span> <span class="n">DIBUSB_IOCTL_CMD_ENABLE_STREAM</span> <span class="o">:</span> <span class="n">DIBUSB_IOCTL_CMD_DISABLE_STREAM</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dvb_usb_generic_write</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dibusb2_0_streaming_ctrl</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dibusb2_0_power_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">DIBUSB_REQ_SET_IOCTL</span><span class="p">,</span> <span class="n">DIBUSB_IOCTL_CMD_POWER_MODE</span><span class="p">,</span> <span class="n">DIBUSB_IOCTL_POWER_WAKEUP</span> <span class="p">};</span>
		<span class="k">return</span> <span class="n">dvb_usb_generic_write</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dibusb2_0_power_ctrl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dibusb_i2c_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="o">*</span><span class="n">wbuf</span><span class="p">,</span> <span class="n">u16</span> <span class="n">wlen</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rbuf</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">sndbuf</span><span class="p">[</span><span class="n">wlen</span><span class="o">+</span><span class="mi">4</span><span class="p">];</span> <span class="cm">/* lead(1) devaddr,direction(1) addr(2) data(wlen) (len(2) (when reading)) */</span>
	<span class="cm">/* write only ? */</span>
	<span class="kt">int</span> <span class="n">wo</span> <span class="o">=</span> <span class="p">(</span><span class="n">rbuf</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">rlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">wlen</span> <span class="o">+</span> <span class="p">(</span><span class="n">wo</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">sndbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">wo</span> <span class="o">?</span> <span class="n">DIBUSB_REQ_I2C_WRITE</span> <span class="o">:</span> <span class="n">DIBUSB_REQ_I2C_READ</span><span class="p">;</span>
	<span class="n">sndbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">wo</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sndbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">wbuf</span><span class="p">,</span><span class="n">wlen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sndbuf</span><span class="p">[</span><span class="n">wlen</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rlen</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">sndbuf</span><span class="p">[</span><span class="n">wlen</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">rlen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dvb_usb_generic_rw</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">sndbuf</span><span class="p">,</span><span class="n">len</span><span class="p">,</span><span class="n">rbuf</span><span class="p">,</span><span class="n">rlen</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * I2C master xfer function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dibusb_i2c_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span><span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[],</span><span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* write/read request */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">num</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
					  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dibusb_i2c_msg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">,</span>
						<span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dibusb_i2c_msg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">!=</span> <span class="mh">0x50</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* 0x50 is the address of the eeprom - we need to protect it</span>
<span class="cm">			 * from dibusb&#39;s bad i2c implementation: reads without</span>
<span class="cm">			 * writing the offset before are forbidden */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dibusb_i2c_msg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">dibusb_i2c_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">I2C_FUNC_I2C</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">i2c_algorithm</span> <span class="n">dibusb_i2c_algo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">master_xfer</span>   <span class="o">=</span> <span class="n">dibusb_i2c_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">functionality</span> <span class="o">=</span> <span class="n">dibusb_i2c_func</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dibusb_i2c_algo</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dibusb_read_eeprom_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u8</span> <span class="n">offs</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">wbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">offs</span> <span class="p">};</span>
	<span class="k">return</span> <span class="n">dibusb_i2c_msg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="n">wbuf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dibusb_read_eeprom_byte</span><span class="p">);</span>

<span class="cm">/* 3000MC/P stuff */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Config Adjacent channels  Perf -cal22</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="k">struct</span> <span class="n">dibx000_agc_config</span> <span class="n">dib3000p_mt2060_agc_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">band_caps</span> <span class="o">=</span> <span class="n">BAND_VHF</span> <span class="o">|</span> <span class="n">BAND_UHF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span>     <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>

	<span class="p">.</span><span class="n">agc1_max</span> <span class="o">=</span> <span class="mi">48497</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc1_min</span> <span class="o">=</span> <span class="mi">23593</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc2_max</span> <span class="o">=</span> <span class="mi">46531</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc2_min</span> <span class="o">=</span> <span class="mi">24904</span><span class="p">,</span>

	<span class="p">.</span><span class="n">agc1_pt1</span> <span class="o">=</span> <span class="mh">0x65</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc1_pt2</span> <span class="o">=</span> <span class="mh">0x69</span><span class="p">,</span>

	<span class="p">.</span><span class="n">agc1_slope1</span> <span class="o">=</span> <span class="mh">0x51</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc1_slope2</span> <span class="o">=</span> <span class="mh">0x27</span><span class="p">,</span>

	<span class="p">.</span><span class="n">agc2_pt1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc2_pt2</span> <span class="o">=</span> <span class="mh">0x33</span><span class="p">,</span>

	<span class="p">.</span><span class="n">agc2_slope1</span> <span class="o">=</span> <span class="mh">0x35</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc2_slope2</span> <span class="o">=</span> <span class="mh">0x37</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dib3000mc_config</span> <span class="n">stk3000p_dib3000p_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dib3000p_mt2060_agc_config</span><span class="p">,</span>

	<span class="p">.</span><span class="n">max_time</span>     <span class="o">=</span> <span class="mh">0x196</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ln_adc_level</span> <span class="o">=</span> <span class="mh">0x1cc7</span><span class="p">,</span>

	<span class="p">.</span><span class="n">output_mpeg2_in_188_bytes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">agc_command1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc_command2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dibx000_agc_config</span> <span class="n">dib3000p_panasonic_agc_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">band_caps</span> <span class="o">=</span> <span class="n">BAND_VHF</span> <span class="o">|</span> <span class="n">BAND_UHF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup</span>     <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>

	<span class="p">.</span><span class="n">agc1_max</span> <span class="o">=</span> <span class="mi">56361</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc1_min</span> <span class="o">=</span> <span class="mi">22282</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc2_max</span> <span class="o">=</span> <span class="mi">47841</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc2_min</span> <span class="o">=</span> <span class="mi">36045</span><span class="p">,</span>

	<span class="p">.</span><span class="n">agc1_pt1</span> <span class="o">=</span> <span class="mh">0x3b</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc1_pt2</span> <span class="o">=</span> <span class="mh">0x6b</span><span class="p">,</span>

	<span class="p">.</span><span class="n">agc1_slope1</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc1_slope2</span> <span class="o">=</span> <span class="mh">0x1d</span><span class="p">,</span>

	<span class="p">.</span><span class="n">agc2_pt1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc2_pt2</span> <span class="o">=</span> <span class="mh">0x0a</span><span class="p">,</span>

	<span class="p">.</span><span class="n">agc2_slope1</span> <span class="o">=</span> <span class="mh">0x95</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc2_slope2</span> <span class="o">=</span> <span class="mh">0x1e</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#if defined(CONFIG_DVB_DIB3000MC) || 					\</span>
<span class="cp">	(defined(CONFIG_DVB_DIB3000MC_MODULE) &amp;&amp; defined(MODULE))</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dib3000mc_config</span> <span class="n">mod3000p_dib3000p_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dib3000p_panasonic_agc_config</span><span class="p">,</span>

	<span class="p">.</span><span class="n">max_time</span>     <span class="o">=</span> <span class="mh">0x51</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ln_adc_level</span> <span class="o">=</span> <span class="mh">0x1cc7</span><span class="p">,</span>

	<span class="p">.</span><span class="n">output_mpeg2_in_188_bytes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">agc_command1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">agc_command2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">dibusb_dib3000mc_frontend_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span>  <span class="o">==</span> <span class="n">USB_VID_LITEON</span> <span class="o">&amp;&amp;</span>
			<span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span> <span class="o">==</span>
			<span class="n">USB_PID_LITEON_DVB_T_WARM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">dib3000mc_attach</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
					 <span class="n">DEFAULT_DIB3000P_I2C_ADDRESS</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">mod3000p_dib3000p_config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span> <span class="o">=</span> <span class="n">dvb_attach</span><span class="p">(</span><span class="n">dib3000mc_attach</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
						 <span class="n">DEFAULT_DIB3000MC_I2C_ADDRESS</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">mod3000p_dib3000p_config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">dibusb_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">pid_parse</span> <span class="o">=</span> <span class="n">dib3000mc_pid_parse</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">pid_ctrl</span>  <span class="o">=</span> <span class="n">dib3000mc_pid_control</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dibusb_dib3000mc_frontend_attach</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mt2060_config</span> <span class="n">stk3000p_mt2060_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x60</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">dibusb_dib3000mc_tuner_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dibusb_state</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">if1</span> <span class="o">=</span> <span class="mi">1220</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">tun_i2c</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>First IF calibration for Liteon Sticks</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span>  <span class="o">==</span> <span class="n">USB_VID_LITEON</span> <span class="o">&amp;&amp;</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span> <span class="o">==</span> <span class="n">USB_PID_LITEON_DVB_T_WARM</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">dibusb_read_eeprom_byte</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="mh">0x7E</span><span class="p">,</span><span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>
		<span class="n">dibusb_read_eeprom_byte</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="mh">0x7F</span><span class="p">,</span><span class="o">&amp;</span><span class="n">b</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
			<span class="n">if1</span> <span class="o">+=</span> <span class="n">b</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">if1</span> <span class="o">-=</span> <span class="n">b</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">warn</span><span class="p">(</span><span class="s">&quot;LITE-ON DVB-T: Strange IF1 calibration :%2X %2X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span>  <span class="o">==</span> <span class="n">USB_VID_DIBCOM</span> <span class="o">&amp;&amp;</span>
		   <span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span> <span class="o">==</span> <span class="n">USB_PID_DIBCOM_MOD3001_WARM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">desc</span><span class="p">;</span>
		<span class="n">dibusb_read_eeprom_byte</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">a</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">dibusb_read_eeprom_byte</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="p">);</span>
				<span class="n">a</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">desc</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">||</span> <span class="n">desc</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">desc</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
				<span class="n">if1</span> <span class="o">-=</span> <span class="p">(</span><span class="mh">0xff</span> <span class="o">-</span> <span class="n">desc</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">if1</span> <span class="o">+=</span> <span class="n">desc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tun_i2c</span> <span class="o">=</span> <span class="n">dib3000mc_get_tuner_i2c_master</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">mt2060_attach</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span> <span class="n">tun_i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stk3000p_mt2060_config</span><span class="p">,</span> <span class="n">if1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* not found - use panasonic pll parameters */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dvb_attach</span><span class="p">(</span><span class="n">dvb_pll_attach</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="n">tun_i2c</span><span class="p">,</span> <span class="n">DVB_PLL_ENV57H1XD5</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">mt2060_present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* set the correct parameters for the dib3000p */</span>
		<span class="n">dib3000mc_set_config</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">fe_adap</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stk3000p_dib3000p_config</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dibusb_dib3000mc_tuner_attach</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * common remote control stuff</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rc_map_table</span> <span class="n">rc_map_dibusb_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Key codes for the little Artec T1/Twinhan/HAMA/ remote. */</span>
	<span class="p">{</span> <span class="mh">0x0016</span><span class="p">,</span> <span class="n">KEY_POWER</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="n">KEY_MUTE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="n">KEY_1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="n">KEY_2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="n">KEY_3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0009</span><span class="p">,</span> <span class="n">KEY_4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x001d</span><span class="p">,</span> <span class="n">KEY_5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x001f</span><span class="p">,</span> <span class="n">KEY_6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000d</span><span class="p">,</span> <span class="n">KEY_7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0019</span><span class="p">,</span> <span class="n">KEY_8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x001b</span><span class="p">,</span> <span class="n">KEY_9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="n">KEY_0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0005</span><span class="p">,</span> <span class="n">KEY_CHANNELUP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="n">KEY_CHANNELDOWN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x001e</span><span class="p">,</span> <span class="n">KEY_VOLUMEUP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000a</span><span class="p">,</span> <span class="n">KEY_VOLUMEDOWN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0011</span><span class="p">,</span> <span class="n">KEY_RECORD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0017</span><span class="p">,</span> <span class="n">KEY_FAVORITES</span> <span class="p">},</span> <span class="cm">/* Heart symbol - Channel list. */</span>
	<span class="p">{</span> <span class="mh">0x0014</span><span class="p">,</span> <span class="n">KEY_PLAY</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x001a</span><span class="p">,</span> <span class="n">KEY_STOP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0040</span><span class="p">,</span> <span class="n">KEY_REWIND</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0012</span><span class="p">,</span> <span class="n">KEY_FASTFORWARD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000e</span><span class="p">,</span> <span class="n">KEY_PREVIOUS</span> <span class="p">},</span> <span class="cm">/* Recall - Previous channel. */</span>
	<span class="p">{</span> <span class="mh">0x004c</span><span class="p">,</span> <span class="n">KEY_PAUSE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x004d</span><span class="p">,</span> <span class="n">KEY_SCREEN</span> <span class="p">},</span> <span class="cm">/* Full screen mode. */</span>
	<span class="p">{</span> <span class="mh">0x0054</span><span class="p">,</span> <span class="n">KEY_AUDIO</span> <span class="p">},</span> <span class="cm">/* MTS - Switch to secondary audio. */</span>
	<span class="cm">/* additional keys TwinHan VisionPlus, the Artec seemingly not have */</span>
	<span class="p">{</span> <span class="mh">0x000c</span><span class="p">,</span> <span class="n">KEY_CANCEL</span> <span class="p">},</span> <span class="cm">/* Cancel */</span>
	<span class="p">{</span> <span class="mh">0x001c</span><span class="p">,</span> <span class="n">KEY_EPG</span> <span class="p">},</span> <span class="cm">/* EPG */</span>
	<span class="p">{</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">KEY_TAB</span> <span class="p">},</span> <span class="cm">/* Tab */</span>
	<span class="p">{</span> <span class="mh">0x0048</span><span class="p">,</span> <span class="n">KEY_INFO</span> <span class="p">},</span> <span class="cm">/* Preview */</span>
	<span class="p">{</span> <span class="mh">0x0004</span><span class="p">,</span> <span class="n">KEY_LIST</span> <span class="p">},</span> <span class="cm">/* RecordList */</span>
	<span class="p">{</span> <span class="mh">0x000f</span><span class="p">,</span> <span class="n">KEY_TEXT</span> <span class="p">},</span> <span class="cm">/* Teletext */</span>
	<span class="cm">/* Key codes for the KWorld/ADSTech/JetWay remote. */</span>
	<span class="p">{</span> <span class="mh">0x8612</span><span class="p">,</span> <span class="n">KEY_POWER</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x860f</span><span class="p">,</span> <span class="n">KEY_SELECT</span> <span class="p">},</span> <span class="cm">/* source */</span>
	<span class="p">{</span> <span class="mh">0x860c</span><span class="p">,</span> <span class="n">KEY_UNKNOWN</span> <span class="p">},</span> <span class="cm">/* scan */</span>
	<span class="p">{</span> <span class="mh">0x860b</span><span class="p">,</span> <span class="n">KEY_EPG</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8610</span><span class="p">,</span> <span class="n">KEY_MUTE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8601</span><span class="p">,</span> <span class="n">KEY_1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8602</span><span class="p">,</span> <span class="n">KEY_2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8603</span><span class="p">,</span> <span class="n">KEY_3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8604</span><span class="p">,</span> <span class="n">KEY_4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8605</span><span class="p">,</span> <span class="n">KEY_5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8606</span><span class="p">,</span> <span class="n">KEY_6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8607</span><span class="p">,</span> <span class="n">KEY_7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8608</span><span class="p">,</span> <span class="n">KEY_8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8609</span><span class="p">,</span> <span class="n">KEY_9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x860a</span><span class="p">,</span> <span class="n">KEY_0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8618</span><span class="p">,</span> <span class="n">KEY_ZOOM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x861c</span><span class="p">,</span> <span class="n">KEY_UNKNOWN</span> <span class="p">},</span> <span class="cm">/* preview */</span>
	<span class="p">{</span> <span class="mh">0x8613</span><span class="p">,</span> <span class="n">KEY_UNKNOWN</span> <span class="p">},</span> <span class="cm">/* snap */</span>
	<span class="p">{</span> <span class="mh">0x8600</span><span class="p">,</span> <span class="n">KEY_UNDO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x861d</span><span class="p">,</span> <span class="n">KEY_RECORD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x860d</span><span class="p">,</span> <span class="n">KEY_STOP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x860e</span><span class="p">,</span> <span class="n">KEY_PAUSE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8616</span><span class="p">,</span> <span class="n">KEY_PLAY</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8611</span><span class="p">,</span> <span class="n">KEY_BACK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8619</span><span class="p">,</span> <span class="n">KEY_FORWARD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8614</span><span class="p">,</span> <span class="n">KEY_UNKNOWN</span> <span class="p">},</span> <span class="cm">/* pip */</span>
	<span class="p">{</span> <span class="mh">0x8615</span><span class="p">,</span> <span class="n">KEY_ESC</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x861a</span><span class="p">,</span> <span class="n">KEY_UP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x861e</span><span class="p">,</span> <span class="n">KEY_DOWN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x861f</span><span class="p">,</span> <span class="n">KEY_LEFT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x861b</span><span class="p">,</span> <span class="n">KEY_RIGHT</span> <span class="p">},</span>

	<span class="cm">/* Key codes for the DiBcom MOD3000 remote. */</span>
	<span class="p">{</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="n">KEY_MUTE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8001</span><span class="p">,</span> <span class="n">KEY_TEXT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8002</span><span class="p">,</span> <span class="n">KEY_HOME</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8003</span><span class="p">,</span> <span class="n">KEY_POWER</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mh">0x8004</span><span class="p">,</span> <span class="n">KEY_RED</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8005</span><span class="p">,</span> <span class="n">KEY_GREEN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8006</span><span class="p">,</span> <span class="n">KEY_YELLOW</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8007</span><span class="p">,</span> <span class="n">KEY_BLUE</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mh">0x8008</span><span class="p">,</span> <span class="n">KEY_DVD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8009</span><span class="p">,</span> <span class="n">KEY_AUDIO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x800a</span><span class="p">,</span> <span class="n">KEY_IMAGES</span> <span class="p">},</span>      <span class="cm">/* Pictures */</span>
	<span class="p">{</span> <span class="mh">0x800b</span><span class="p">,</span> <span class="n">KEY_VIDEO</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mh">0x800c</span><span class="p">,</span> <span class="n">KEY_BACK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x800d</span><span class="p">,</span> <span class="n">KEY_UP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x800e</span><span class="p">,</span> <span class="n">KEY_RADIO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x800f</span><span class="p">,</span> <span class="n">KEY_EPG</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mh">0x8010</span><span class="p">,</span> <span class="n">KEY_LEFT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8011</span><span class="p">,</span> <span class="n">KEY_OK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8012</span><span class="p">,</span> <span class="n">KEY_RIGHT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8013</span><span class="p">,</span> <span class="n">KEY_UNKNOWN</span> <span class="p">},</span>    <span class="cm">/* SAP */</span>

	<span class="p">{</span> <span class="mh">0x8014</span><span class="p">,</span> <span class="n">KEY_TV</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8015</span><span class="p">,</span> <span class="n">KEY_DOWN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8016</span><span class="p">,</span> <span class="n">KEY_MENU</span> <span class="p">},</span>       <span class="cm">/* DVD Menu */</span>
	<span class="p">{</span> <span class="mh">0x8017</span><span class="p">,</span> <span class="n">KEY_LAST</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mh">0x8018</span><span class="p">,</span> <span class="n">KEY_RECORD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8019</span><span class="p">,</span> <span class="n">KEY_STOP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x801a</span><span class="p">,</span> <span class="n">KEY_PAUSE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x801b</span><span class="p">,</span> <span class="n">KEY_PLAY</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mh">0x801c</span><span class="p">,</span> <span class="n">KEY_PREVIOUS</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x801d</span><span class="p">,</span> <span class="n">KEY_REWIND</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x801e</span><span class="p">,</span> <span class="n">KEY_FASTFORWARD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x801f</span><span class="p">,</span> <span class="n">KEY_NEXT</span><span class="p">},</span>

	<span class="p">{</span> <span class="mh">0x8040</span><span class="p">,</span> <span class="n">KEY_1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8041</span><span class="p">,</span> <span class="n">KEY_2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8042</span><span class="p">,</span> <span class="n">KEY_3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8043</span><span class="p">,</span> <span class="n">KEY_CHANNELUP</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mh">0x8044</span><span class="p">,</span> <span class="n">KEY_4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8045</span><span class="p">,</span> <span class="n">KEY_5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8046</span><span class="p">,</span> <span class="n">KEY_6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8047</span><span class="p">,</span> <span class="n">KEY_CHANNELDOWN</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mh">0x8048</span><span class="p">,</span> <span class="n">KEY_7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8049</span><span class="p">,</span> <span class="n">KEY_8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x804a</span><span class="p">,</span> <span class="n">KEY_9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x804b</span><span class="p">,</span> <span class="n">KEY_VOLUMEUP</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mh">0x804c</span><span class="p">,</span> <span class="n">KEY_CLEAR</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x804d</span><span class="p">,</span> <span class="n">KEY_0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x804e</span><span class="p">,</span> <span class="n">KEY_ENTER</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x804f</span><span class="p">,</span> <span class="n">KEY_VOLUMEDOWN</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rc_map_dibusb_table</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dibusb_rc_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">dvb_usb_device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">key</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">DIBUSB_REQ_POLL_REMOTE</span><span class="p">;</span>
	<span class="n">dvb_usb_generic_rw</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">dvb_usb_nec_rc_key_to_event</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">event</span><span class="p">,</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">deb_info</span><span class="p">(</span><span class="s">&quot;key: %x %x %x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dibusb_rc_query</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
