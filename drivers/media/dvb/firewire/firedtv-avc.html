<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › dvb › firewire › firedtv-avc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>firedtv-avc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * FireDTV driver (formerly known as FireSAT)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004 Andreas Monitzer &lt;andy@monitzer.com&gt;</span>
<span class="cm"> * Copyright (C) 2008 Ben Backx &lt;ben@bbackx.com&gt;</span>
<span class="cm"> * Copyright (C) 2008 Henrik Kurelid &lt;henrik@kurelid.se&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or</span>
<span class="cm"> *	modify it under the terms of the GNU General Public License as</span>
<span class="cm"> *	published by the Free Software Foundation; either version 2 of</span>
<span class="cm"> *	the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/bug.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/stringify.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>

<span class="cp">#include &lt;dvb_frontend.h&gt;</span>

<span class="cp">#include &quot;firedtv.h&quot;</span>

<span class="cp">#define FCP_COMMAND_REGISTER		0xfffff0000b00ULL</span>

<span class="cp">#define AVC_CTYPE_CONTROL		0x0</span>
<span class="cp">#define AVC_CTYPE_STATUS		0x1</span>
<span class="cp">#define AVC_CTYPE_NOTIFY		0x3</span>

<span class="cp">#define AVC_RESPONSE_ACCEPTED		0x9</span>
<span class="cp">#define AVC_RESPONSE_STABLE		0xc</span>
<span class="cp">#define AVC_RESPONSE_CHANGED		0xd</span>
<span class="cp">#define AVC_RESPONSE_INTERIM		0xf</span>

<span class="cp">#define AVC_SUBUNIT_TYPE_TUNER		(0x05 &lt;&lt; 3)</span>
<span class="cp">#define AVC_SUBUNIT_TYPE_UNIT		(0x1f &lt;&lt; 3)</span>

<span class="cp">#define AVC_OPCODE_VENDOR		0x00</span>
<span class="cp">#define AVC_OPCODE_READ_DESCRIPTOR	0x09</span>
<span class="cp">#define AVC_OPCODE_DSIT			0xc8</span>
<span class="cp">#define AVC_OPCODE_DSD			0xcb</span>

<span class="cp">#define DESCRIPTOR_TUNER_STATUS 	0x80</span>
<span class="cp">#define DESCRIPTOR_SUBUNIT_IDENTIFIER	0x00</span>

<span class="cp">#define SFE_VENDOR_DE_COMPANYID_0	0x00 </span><span class="cm">/* OUI of Digital Everywhere */</span><span class="cp"></span>
<span class="cp">#define SFE_VENDOR_DE_COMPANYID_1	0x12</span>
<span class="cp">#define SFE_VENDOR_DE_COMPANYID_2	0x87</span>

<span class="cp">#define SFE_VENDOR_OPCODE_REGISTER_REMOTE_CONTROL 0x0a</span>
<span class="cp">#define SFE_VENDOR_OPCODE_LNB_CONTROL		0x52</span>
<span class="cp">#define SFE_VENDOR_OPCODE_TUNE_QPSK		0x58 </span><span class="cm">/* for DVB-S */</span><span class="cp"></span>

<span class="cp">#define SFE_VENDOR_OPCODE_GET_FIRMWARE_VERSION	0x00</span>
<span class="cp">#define SFE_VENDOR_OPCODE_HOST2CA		0x56</span>
<span class="cp">#define SFE_VENDOR_OPCODE_CA2HOST		0x57</span>
<span class="cp">#define SFE_VENDOR_OPCODE_CISTATUS		0x59</span>
<span class="cp">#define SFE_VENDOR_OPCODE_TUNE_QPSK2		0x60 </span><span class="cm">/* for DVB-S2 */</span><span class="cp"></span>

<span class="cp">#define SFE_VENDOR_TAG_CA_RESET			0x00</span>
<span class="cp">#define SFE_VENDOR_TAG_CA_APPLICATION_INFO	0x01</span>
<span class="cp">#define SFE_VENDOR_TAG_CA_PMT			0x02</span>
<span class="cp">#define SFE_VENDOR_TAG_CA_DATE_TIME		0x04</span>
<span class="cp">#define SFE_VENDOR_TAG_CA_MMI			0x05</span>
<span class="cp">#define SFE_VENDOR_TAG_CA_ENTER_MENU		0x07</span>

<span class="cp">#define EN50221_LIST_MANAGEMENT_ONLY	0x03</span>
<span class="cp">#define EN50221_TAG_APP_INFO		0x9f8021</span>
<span class="cp">#define EN50221_TAG_CA_INFO		0x9f8031</span>

<span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">ctype</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">subunit</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">operand</span><span class="p">[</span><span class="mi">509</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">avc_response_frame</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">response</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">subunit</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">operand</span><span class="p">[</span><span class="mi">509</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define LAST_OPERAND (509 - 1)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">clear_operands</span><span class="p">(</span><span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">from</span><span class="p">,</span> <span class="kt">int</span> <span class="n">to</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">from</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">to</span> <span class="o">-</span> <span class="n">from</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pad_operands</span><span class="p">(</span><span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">to</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">from</span> <span class="o">&lt;=</span> <span class="n">to</span> <span class="o">&amp;&amp;</span> <span class="n">to</span> <span class="o">&lt;=</span> <span class="n">LAST_OPERAND</span><span class="p">)</span>
		<span class="n">clear_operands</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define AVC_DEBUG_READ_DESCRIPTOR              0x0001</span>
<span class="cp">#define AVC_DEBUG_DSIT                         0x0002</span>
<span class="cp">#define AVC_DEBUG_DSD                          0x0004</span>
<span class="cp">#define AVC_DEBUG_REGISTER_REMOTE_CONTROL      0x0008</span>
<span class="cp">#define AVC_DEBUG_LNB_CONTROL                  0x0010</span>
<span class="cp">#define AVC_DEBUG_TUNE_QPSK                    0x0020</span>
<span class="cp">#define AVC_DEBUG_TUNE_QPSK2                   0x0040</span>
<span class="cp">#define AVC_DEBUG_HOST2CA                      0x0080</span>
<span class="cp">#define AVC_DEBUG_CA2HOST                      0x0100</span>
<span class="cp">#define AVC_DEBUG_APPLICATION_PMT              0x4000</span>
<span class="cp">#define AVC_DEBUG_FCP_PAYLOADS                 0x8000</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">avc_debug</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">avc_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Verbose logging (none = 0&quot;</span>
	<span class="s">&quot;, FCP subactions&quot;</span>
	<span class="s">&quot;: READ DESCRIPTOR = &quot;</span>		<span class="n">__stringify</span><span class="p">(</span><span class="n">AVC_DEBUG_READ_DESCRIPTOR</span><span class="p">)</span>
	<span class="s">&quot;, DSIT = &quot;</span>			<span class="n">__stringify</span><span class="p">(</span><span class="n">AVC_DEBUG_DSIT</span><span class="p">)</span>
	<span class="s">&quot;, REGISTER_REMOTE_CONTROL = &quot;</span>	<span class="n">__stringify</span><span class="p">(</span><span class="n">AVC_DEBUG_REGISTER_REMOTE_CONTROL</span><span class="p">)</span>
	<span class="s">&quot;, LNB CONTROL = &quot;</span>		<span class="n">__stringify</span><span class="p">(</span><span class="n">AVC_DEBUG_LNB_CONTROL</span><span class="p">)</span>
	<span class="s">&quot;, TUNE QPSK = &quot;</span>		<span class="n">__stringify</span><span class="p">(</span><span class="n">AVC_DEBUG_TUNE_QPSK</span><span class="p">)</span>
	<span class="s">&quot;, TUNE QPSK2 = &quot;</span>		<span class="n">__stringify</span><span class="p">(</span><span class="n">AVC_DEBUG_TUNE_QPSK2</span><span class="p">)</span>
	<span class="s">&quot;, HOST2CA = &quot;</span>			<span class="n">__stringify</span><span class="p">(</span><span class="n">AVC_DEBUG_HOST2CA</span><span class="p">)</span>
	<span class="s">&quot;, CA2HOST = &quot;</span>			<span class="n">__stringify</span><span class="p">(</span><span class="n">AVC_DEBUG_CA2HOST</span><span class="p">)</span>
	<span class="s">&quot;; Application sent PMT = &quot;</span>	<span class="n">__stringify</span><span class="p">(</span><span class="n">AVC_DEBUG_APPLICATION_PMT</span><span class="p">)</span>
	<span class="s">&quot;, FCP payloads = &quot;</span>		<span class="n">__stringify</span><span class="p">(</span><span class="n">AVC_DEBUG_FCP_PAYLOADS</span><span class="p">)</span>
	<span class="s">&quot;, or a combination, or all = -1)&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This is a workaround since there is no vendor specific command to retrieve</span>
<span class="cm"> * ca_info using AVC. If this parameter is not used, ca_system_id will be</span>
<span class="cm"> * filled with application_manufacturer from ca_app_info.</span>
<span class="cm"> * Digital Everywhere have said that adding ca_info is on their TODO list.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_fake_ca_system_ids</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fake_ca_system_ids</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">fake_ca_system_ids</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_fake_ca_system_ids</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fake_ca_system_ids</span><span class="p">,</span> <span class="s">&quot;If your CAM application manufacturer &quot;</span>
		 <span class="s">&quot;does not have the same ca_system_id as your CAS, you can &quot;</span>
		 <span class="s">&quot;override what ca_system_ids are presented to the &quot;</span>
		 <span class="s">&quot;application by setting this field to an array of ids.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">debug_fcp_ctype</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ctypes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="mh">0x0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;CONTROL&quot;</span><span class="p">,</span>		<span class="p">[</span><span class="mh">0x1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;STATUS&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mh">0x2</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;SPECIFIC INQUIRY&quot;</span><span class="p">,</span>	<span class="p">[</span><span class="mh">0x3</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;NOTIFY&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mh">0x4</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;GENERAL INQUIRY&quot;</span><span class="p">,</span>	<span class="p">[</span><span class="mh">0x8</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;NOT IMPLEMENTED&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mh">0x9</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;ACCEPTED&quot;</span><span class="p">,</span>		<span class="p">[</span><span class="mh">0xa</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;REJECTED&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mh">0xb</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;IN TRANSITION&quot;</span><span class="p">,</span>	<span class="p">[</span><span class="mh">0xc</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;IMPLEMENTED/STABLE&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mh">0xd</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;CHANGED&quot;</span><span class="p">,</span>		<span class="p">[</span><span class="mh">0xf</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;INTERIM&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="n">ctype</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ctypes</span><span class="p">)</span> <span class="o">?</span> <span class="n">ctypes</span><span class="p">[</span><span class="n">ctype</span><span class="p">]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="s">&quot;?&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">debug_fcp_opcode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opcode</span><span class="p">,</span>
				    <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AVC_OPCODE_VENDOR</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AVC_OPCODE_READ_DESCRIPTOR</span>:
		<span class="k">return</span> <span class="n">avc_debug</span> <span class="o">&amp;</span> <span class="n">AVC_DEBUG_READ_DESCRIPTOR</span> <span class="o">?</span>
				<span class="s">&quot;ReadDescriptor&quot;</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AVC_OPCODE_DSIT</span>:
		<span class="k">return</span> <span class="n">avc_debug</span> <span class="o">&amp;</span> <span class="n">AVC_DEBUG_DSIT</span> <span class="o">?</span>
				<span class="s">&quot;DirectSelectInfo.Type&quot;</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AVC_OPCODE_DSD</span>:
		<span class="k">return</span> <span class="n">avc_debug</span> <span class="o">&amp;</span> <span class="n">AVC_DEBUG_DSD</span> <span class="o">?</span> <span class="s">&quot;DirectSelectData&quot;</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="o">||</span>
	    <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_0</span> <span class="o">||</span>
	    <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_1</span> <span class="o">||</span>
	    <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_2</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;Vendor/Unknown&quot;</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SFE_VENDOR_OPCODE_REGISTER_REMOTE_CONTROL</span>:
		<span class="k">return</span> <span class="n">avc_debug</span> <span class="o">&amp;</span> <span class="n">AVC_DEBUG_REGISTER_REMOTE_CONTROL</span> <span class="o">?</span>
				<span class="s">&quot;RegisterRC&quot;</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SFE_VENDOR_OPCODE_LNB_CONTROL</span>:
		<span class="k">return</span> <span class="n">avc_debug</span> <span class="o">&amp;</span> <span class="n">AVC_DEBUG_LNB_CONTROL</span> <span class="o">?</span> <span class="s">&quot;LNBControl&quot;</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SFE_VENDOR_OPCODE_TUNE_QPSK</span>:
		<span class="k">return</span> <span class="n">avc_debug</span> <span class="o">&amp;</span> <span class="n">AVC_DEBUG_TUNE_QPSK</span> <span class="o">?</span> <span class="s">&quot;TuneQPSK&quot;</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SFE_VENDOR_OPCODE_TUNE_QPSK2</span>:
		<span class="k">return</span> <span class="n">avc_debug</span> <span class="o">&amp;</span> <span class="n">AVC_DEBUG_TUNE_QPSK2</span> <span class="o">?</span> <span class="s">&quot;TuneQPSK2&quot;</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SFE_VENDOR_OPCODE_HOST2CA</span>:
		<span class="k">return</span> <span class="n">avc_debug</span> <span class="o">&amp;</span> <span class="n">AVC_DEBUG_HOST2CA</span> <span class="o">?</span> <span class="s">&quot;Host2CA&quot;</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SFE_VENDOR_OPCODE_CA2HOST</span>:
		<span class="k">return</span> <span class="n">avc_debug</span> <span class="o">&amp;</span> <span class="n">AVC_DEBUG_CA2HOST</span> <span class="o">?</span> <span class="s">&quot;CA2Host&quot;</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="s">&quot;Vendor/Unknown&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">debug_fcp</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">subunit_type</span><span class="p">,</span> <span class="n">subunit_id</span><span class="p">,</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">prefix</span><span class="p">;</span>

	<span class="n">prefix</span>       <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="o">?</span> <span class="s">&quot;FCP &lt;- &quot;</span> <span class="o">:</span> <span class="s">&quot;FCP -&gt; &quot;</span><span class="p">;</span>
	<span class="n">subunit_type</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">subunit_id</span>   <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">opcode</span>       <span class="o">=</span> <span class="n">subunit_type</span> <span class="o">==</span> <span class="mh">0x1e</span> <span class="o">||</span> <span class="n">subunit_id</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">?</span> <span class="o">~</span><span class="mi">0</span> <span class="o">:</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">op</span>           <span class="o">=</span> <span class="n">debug_fcp_opcode</span><span class="p">(</span><span class="n">opcode</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%ssu=%x.%x l=%d: %-8s - %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">prefix</span><span class="p">,</span> <span class="n">subunit_type</span><span class="p">,</span> <span class="n">subunit_id</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
		       <span class="n">debug_fcp_ctype</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">op</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">avc_debug</span> <span class="o">&amp;</span> <span class="n">AVC_DEBUG_FCP_PAYLOADS</span><span class="p">)</span>
			<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">DUMP_PREFIX_NONE</span><span class="p">,</span>
				       <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">debug_pmt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;APP PMT -&gt; l=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;APP PMT -&gt; &quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_NONE</span><span class="p">,</span>
		       <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">avc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">retry</span><span class="p">;</span>

	<span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_reply_received</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">retry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">avc_debug</span><span class="p">))</span>
			<span class="n">debug_fcp</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">,</span> <span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data_length</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">fdtv_write</span><span class="p">(</span><span class="n">fdtv</span><span class="p">,</span> <span class="n">FCP_COMMAND_REGISTER</span><span class="p">,</span>
				 <span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">,</span> <span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data_length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;FCP command write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * AV/C specs say that answers should be sent within 150 ms.</span>
<span class="cm">		 * Time out after 200 ms.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_wait</span><span class="p">,</span>
				       <span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_reply_received</span><span class="p">,</span>
				       <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">200</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;FCP response timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_register_rc</span><span class="p">(</span><span class="k">struct</span> <span class="n">avc_response_frame</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">opcode</span>     <span class="o">==</span> <span class="n">AVC_OPCODE_VENDOR</span> <span class="o">&amp;&amp;</span>
	       <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">SFE_VENDOR_DE_COMPANYID_0</span> <span class="o">&amp;&amp;</span>
	       <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">SFE_VENDOR_DE_COMPANYID_1</span> <span class="o">&amp;&amp;</span>
	       <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">SFE_VENDOR_DE_COMPANYID_2</span> <span class="o">&amp;&amp;</span>
	       <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">SFE_VENDOR_OPCODE_REGISTER_REMOTE_CONTROL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">avc_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">avc_response_frame</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">avc_debug</span><span class="p">))</span>
		<span class="n">debug_fcp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">is_register_rc</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AVC_RESPONSE_CHANGED</span>:
			<span class="n">fdtv_handle_rc</span><span class="p">(</span><span class="n">fdtv</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">remote_ctrl_work</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AVC_RESPONSE_INTERIM</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">is_register_rc</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">wake</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				 <span class="s">&quot;remote control result = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_reply_received</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;out-of-order AVC response, ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data_length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
<span class="nl">wake:</span>
	<span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_reply_received</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_wait</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_pid_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">operand</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">channel_active</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">operand</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">;</span> <span class="cm">/* flowfunction relay */</span>
			<span class="n">operand</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* dsd_sel_spec_valid_flags -&gt; PID */</span>
			<span class="n">operand</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">channel_pid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
			<span class="n">operand</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">channel_pid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">operand</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* tableID */</span>
			<span class="n">operand</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* filter_length */</span>
			<span class="n">n</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tuning command for setting the relative LNB frequency</span>
<span class="cm"> * (not supported by the AVC standard)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">avc_tuner_tuneqpsk</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">AVC_OPCODE_VENDOR</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_1</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FIREDTV_DVB_S2</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_OPCODE_TUNE_QPSK2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_OPCODE_TUNE_QPSK</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fec_inner</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FEC_1_2</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_2_3</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_3_4</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_5_6</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_7_8</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_4_5</span>:
	<span class="k">case</span> <span class="n">FEC_8_9</span>:
	<span class="k">case</span> <span class="n">FEC_AUTO</span>:
	<span class="nl">default:</span>	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">voltage</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">voltage</span> <span class="o">==</span> <span class="n">SEC_VOLTAGE_18</span><span class="p">)</span> <span class="cm">/* polarisation */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">tone</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">tone</span> <span class="o">==</span> <span class="n">SEC_TONE_ON</span><span class="p">)</span> <span class="cm">/* band */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FIREDTV_DVB_S2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">delivery_system</span> <span class="o">==</span> <span class="n">SYS_DVBS2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">QAM_16</span>:		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">QPSK</span>:		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PSK_8</span>:		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">rolloff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ROLLOFF_35</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ROLLOFF_20</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ROLLOFF_25</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ROLLOFF_AUTO</span>:
			<span class="nl">default:</span>		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="cm">/* case ROLLOFF_NONE:	c-&gt;operand[14] = 0xff; break; */</span>
			<span class="p">}</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">fe</span><span class="p">.</span><span class="n">dtv_property_cache</span><span class="p">.</span><span class="n">pilot</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PILOT_AUTO</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PILOT_OFF</span>:		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PILOT_ON</span>:		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>  <span class="cm">/* auto modulation */</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* disable rolloff */</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* disable pilot */</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">13</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">avc_tuner_dsd_dvb_c</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">AVC_OPCODE_DSD</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* source plug */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xd2</span><span class="p">;</span> <span class="cm">/* subfunction replace */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="cm">/* system id = DVB */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* antenna number */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span> <span class="cm">/* system_specific_multiplex selection_length */</span>

	<span class="cm">/* multiplex_valid_flags, high byte */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>   <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span> <span class="cm">/* reserved */</span>
			<span class="o">|</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span> <span class="cm">/* Polarisation */</span>
			<span class="o">|</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="cm">/* Orbital_Pos */</span>
			<span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="cm">/* Frequency */</span>
			<span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span> <span class="cm">/* Symbol_Rate */</span>
			<span class="o">|</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="cm">/* FEC_outer */</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fec_inner</span>  <span class="o">!=</span> <span class="n">FEC_AUTO</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">!=</span> <span class="n">QAM_AUTO</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* multiplex_valid_flags, low byte */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span>   <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span> <span class="cm">/* NetworkID */</span>
			<span class="o">|</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span> <span class="cm">/* reserved */</span> <span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">4000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">4000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">4000</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">symbol_rate</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">fec_inner</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FEC_1_2</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_2_3</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_3_4</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_5_6</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_7_8</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_8_9</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_4_5</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_AUTO</span>:
	<span class="nl">default:</span>	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QAM_16</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_32</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_64</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_128</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_256</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_AUTO</span>:
	<span class="nl">default:</span>	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">22</span> <span class="o">+</span> <span class="n">add_pid_filter</span><span class="p">(</span><span class="n">fdtv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">22</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">avc_tuner_dsd_dvb_t</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">AVC_OPCODE_DSD</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* source plug */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xd2</span><span class="p">;</span> <span class="cm">/* subfunction replace */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="cm">/* system id = DVB */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* antenna number */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">;</span> <span class="cm">/* system_specific_multiplex selection_length */</span>

	<span class="cm">/* multiplex_valid_flags, high byte */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>
	      <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span> <span class="cm">/* reserved */</span>
	    <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span> <span class="cm">/* CenterFrequency */</span>
	    <span class="o">|</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span> <span class="o">!=</span> <span class="mi">0</span>        <span class="o">?</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span>  <span class="o">!=</span> <span class="n">QAM_AUTO</span>              <span class="o">?</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">hierarchy</span> <span class="o">!=</span> <span class="n">HIERARCHY_AUTO</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span>   <span class="o">!=</span> <span class="n">FEC_AUTO</span>              <span class="o">?</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span>   <span class="o">!=</span> <span class="n">FEC_AUTO</span>              <span class="o">?</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">|</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">guard_interval</span> <span class="o">!=</span> <span class="n">GUARD_INTERVAL_AUTO</span>   <span class="o">?</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* multiplex_valid_flags, low byte */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span>
	      <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span> <span class="cm">/* NetworkID */</span>
	    <span class="o">|</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">transmission_mode</span> <span class="o">!=</span> <span class="n">TRANSMISSION_MODE_AUTO</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">|</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="cm">/* OtherFrequencyFlag */</span>
	    <span class="o">|</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span> <span class="cm">/* reserved */</span> <span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>  <span class="o">=</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bandwidth_hz</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">7000000</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8000000</span>:
	<span class="k">case</span> <span class="mi">6000000</span>:	<span class="cm">/* not defined by AVC spec */</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="nl">default:</span>		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QAM_16</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QAM_64</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QPSK</span>:
	<span class="nl">default:</span>	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">hierarchy</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HIERARCHY_1</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HIERARCHY_2</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HIERARCHY_4</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HIERARCHY_AUTO</span>:
	<span class="k">case</span> <span class="n">HIERARCHY_NONE</span>:
	<span class="nl">default:</span>		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">code_rate_HP</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FEC_2_3</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_3_4</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_5_6</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_7_8</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_1_2</span>:
	<span class="nl">default:</span>	<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">code_rate_LP</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FEC_2_3</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_3_4</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_5_6</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_7_8</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FEC_1_2</span>:
	<span class="nl">default:</span>	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">guard_interval</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_16</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_8</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_4</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_1_32</span>:
	<span class="k">case</span> <span class="n">GUARD_INTERVAL_AUTO</span>:
	<span class="nl">default:</span>			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">transmission_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_8K</span>:	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_2K</span>:
	<span class="k">case</span> <span class="n">TRANSMISSION_MODE_AUTO</span>:
	<span class="nl">default:</span>			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* network_ID[0] */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* network_ID[1] */</span>

	<span class="k">return</span> <span class="mi">17</span> <span class="o">+</span> <span class="n">add_pid_filter</span><span class="p">(</span><span class="n">fdtv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">17</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">avc_tuner_dsd</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">dtv_frontend_properties</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ctype</span>   <span class="o">=</span> <span class="n">AVC_CTYPE_CONTROL</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">subunit</span> <span class="o">=</span> <span class="n">AVC_SUBUNIT_TYPE_TUNER</span> <span class="o">|</span> <span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">subunit</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIREDTV_DVB_S</span>:
	<span class="k">case</span> <span class="n">FIREDTV_DVB_S2</span>: <span class="n">pos</span> <span class="o">=</span> <span class="n">avc_tuner_tuneqpsk</span><span class="p">(</span><span class="n">fdtv</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIREDTV_DVB_C</span>: <span class="n">pos</span> <span class="o">=</span> <span class="n">avc_tuner_dsd_dvb_c</span><span class="p">(</span><span class="n">fdtv</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIREDTV_DVB_T</span>: <span class="n">pos</span> <span class="o">=</span> <span class="n">avc_tuner_dsd_dvb_t</span><span class="p">(</span><span class="n">fdtv</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">pad_operands</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>

	<span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data_length</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">avc_write</span><span class="p">(</span><span class="n">fdtv</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/*</span>
<span class="c">	 * FIXME:</span>
<span class="c">	 * u8 *status was an out-parameter of avc_tuner_dsd, unused by caller.</span>
<span class="c">	 * Check for AVC_RESPONSE_ACCEPTED here instead?</span>
<span class="c">	 */</span>
<span class="c">	if (status)</span>
<span class="c">		*status = r-&gt;operand[2];</span>
<span class="cp">#endif</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">avc_tuner_set_pids</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pidc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pid</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pidc</span> <span class="o">&gt;</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">pidc</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ctype</span>   <span class="o">=</span> <span class="n">AVC_CTYPE_CONTROL</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">subunit</span> <span class="o">=</span> <span class="n">AVC_SUBUNIT_TYPE_TUNER</span> <span class="o">|</span> <span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">subunit</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">opcode</span>  <span class="o">=</span> <span class="n">AVC_OPCODE_DSD</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* source plug */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xd2</span><span class="p">;</span>	<span class="cm">/* subfunction replace */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>	<span class="cm">/* system id = DVB */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* antenna number */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* system_specific_multiplex selection_length */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">pidc</span><span class="p">;</span>	<span class="cm">/* Nr_of_dsd_sel_specs */</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pidc</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">pidc</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">;</span> <span class="cm">/* flowfunction relay */</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* dsd_sel_spec_valid_flags -&gt; PID */</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pid</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pid</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* tableID */</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* filter_length */</span>
		<span class="p">}</span>
	<span class="n">pad_operands</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>

	<span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data_length</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">avc_write</span><span class="p">(</span><span class="n">fdtv</span><span class="p">);</span>

	<span class="cm">/* FIXME: check response code? */</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">avc_tuner_get_ts</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">sl</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ctype</span>   <span class="o">=</span> <span class="n">AVC_CTYPE_CONTROL</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">subunit</span> <span class="o">=</span> <span class="n">AVC_SUBUNIT_TYPE_TUNER</span> <span class="o">|</span> <span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">subunit</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">opcode</span>  <span class="o">=</span> <span class="n">AVC_OPCODE_DSIT</span><span class="p">;</span>

	<span class="n">sl</span> <span class="o">=</span> <span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FIREDTV_DVB_T</span> <span class="o">?</span> <span class="mh">0x0c</span> <span class="o">:</span> <span class="mh">0x11</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* source plug */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xd2</span><span class="p">;</span>	<span class="cm">/* subfunction replace */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>	<span class="cm">/* status */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>	<span class="cm">/* system id = DVB */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* antenna number */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span> 	<span class="cm">/* system_specific_search_flags */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">sl</span><span class="p">;</span>	<span class="cm">/* system_specific_multiplex selection_length */</span>
	<span class="cm">/*</span>
<span class="cm">	 * operand[7]: valid_flags[0]</span>
<span class="cm">	 * operand[8]: valid_flags[1]</span>
<span class="cm">	 * operand[7 + sl]: nr_of_dsit_sel_specs (always 0)</span>
<span class="cm">	 */</span>
	<span class="n">clear_operands</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>

	<span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data_length</span> <span class="o">=</span> <span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FIREDTV_DVB_T</span> <span class="o">?</span> <span class="mi">24</span> <span class="o">:</span> <span class="mi">28</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">avc_write</span><span class="p">(</span><span class="n">fdtv</span><span class="p">);</span>

	<span class="cm">/* FIXME: check response code? */</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">avc_identify_subunit</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">avc_response_frame</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ctype</span>   <span class="o">=</span> <span class="n">AVC_CTYPE_CONTROL</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">subunit</span> <span class="o">=</span> <span class="n">AVC_SUBUNIT_TYPE_TUNER</span> <span class="o">|</span> <span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">subunit</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">opcode</span>  <span class="o">=</span> <span class="n">AVC_OPCODE_READ_DESCRIPTOR</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">DESCRIPTOR_SUBUNIT_IDENTIFIER</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* length highbyte */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span> <span class="cm">/* length lowbyte  */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* offset highbyte */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0d</span><span class="p">;</span> <span class="cm">/* offset lowbyte  */</span>
	<span class="n">clear_operands</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span> <span class="cm">/* padding */</span>

	<span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data_length</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">avc_write</span><span class="p">(</span><span class="n">fdtv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">response</span> <span class="o">!=</span> <span class="n">AVC_RESPONSE_STABLE</span> <span class="o">&amp;&amp;</span>
	     <span class="n">r</span><span class="o">-&gt;</span><span class="n">response</span> <span class="o">!=</span> <span class="n">AVC_RESPONSE_ACCEPTED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;cannot read subunit identifier</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SIZEOF_ANTENNA_INPUT_INFO 22</span>

<span class="kt">int</span> <span class="nf">avc_tuner_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">firedtv_tuner_status</span> <span class="o">*</span><span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">avc_response_frame</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ctype</span>   <span class="o">=</span> <span class="n">AVC_CTYPE_CONTROL</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">subunit</span> <span class="o">=</span> <span class="n">AVC_SUBUNIT_TYPE_TUNER</span> <span class="o">|</span> <span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">subunit</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">opcode</span>  <span class="o">=</span> <span class="n">AVC_OPCODE_READ_DESCRIPTOR</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">DESCRIPTOR_TUNER_STATUS</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>	<span class="cm">/* read_result_status */</span>
	<span class="cm">/*</span>
<span class="cm">	 * operand[2]: reserved</span>
<span class="cm">	 * operand[3]: SIZEOF_ANTENNA_INPUT_INFO &gt;&gt; 8</span>
<span class="cm">	 * operand[4]: SIZEOF_ANTENNA_INPUT_INFO &amp; 0xff</span>
<span class="cm">	 */</span>
	<span class="n">clear_operands</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>

	<span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data_length</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">avc_write</span><span class="p">(</span><span class="n">fdtv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">response</span> <span class="o">!=</span> <span class="n">AVC_RESPONSE_STABLE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">r</span><span class="o">-&gt;</span><span class="n">response</span> <span class="o">!=</span> <span class="n">AVC_RESPONSE_ACCEPTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;cannot read tuner status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x10</span> <span class="o">||</span> <span class="n">length</span> <span class="o">!=</span> <span class="n">SIZEOF_ANTENNA_INPUT_INFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;got invalid tuner status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">active_system</span>		<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">searching</span>			<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">moving</span>			<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">no_rf</span>			<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">input</span>			<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">selected_antenna</span>		<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">ber</span>			<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span>
					  <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
					  <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
					  <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">signal_strength</span>		<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">raster_frequency</span>		<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">rf_frequency</span>		<span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
					  <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
					  <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">man_dep_info_length</span>	<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">21</span><span class="p">];</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">front_end_error</span>		<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">antenna_error</span>		<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">front_end_power_status</span>	<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">power_supply</span>		<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">carrier_noise_ratio</span>	<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
					  <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">power_supply_voltage</span>	<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">27</span><span class="p">];</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">antenna_voltage</span>		<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">28</span><span class="p">];</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">firewire_bus_voltage</span>	<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">29</span><span class="p">];</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">ca_mmi</span>			<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">ca_pmt_reply</span>		<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">ca_date_time_request</span>	<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">ca_application_info</span>	<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">ca_module_present_status</span>	<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">ca_dvb_flag</span>		<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">ca_error_flag</span>		<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">stat</span><span class="o">-&gt;</span><span class="n">ca_initialization_status</span>	<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">avc_lnb_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">,</span> <span class="kt">char</span> <span class="n">voltage</span><span class="p">,</span> <span class="kt">char</span> <span class="n">burst</span><span class="p">,</span>
		    <span class="kt">char</span> <span class="n">conttone</span><span class="p">,</span> <span class="kt">char</span> <span class="n">nrdiseq</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">dvb_diseqc_master_cmd</span> <span class="o">*</span><span class="n">diseqcmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">avc_response_frame</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ctype</span>   <span class="o">=</span> <span class="n">AVC_CTYPE_CONTROL</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">subunit</span> <span class="o">=</span> <span class="n">AVC_SUBUNIT_TYPE_TUNER</span> <span class="o">|</span> <span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">subunit</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">opcode</span>  <span class="o">=</span> <span class="n">AVC_OPCODE_VENDOR</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_1</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_2</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_OPCODE_LNB_CONTROL</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">voltage</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrdiseq</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nrdiseq</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">diseqcmd</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">msg_len</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">diseqcmd</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">msg_len</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">diseqcmd</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">msg</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">burst</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">conttone</span><span class="p">;</span>
	<span class="n">pad_operands</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>

	<span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data_length</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">avc_write</span><span class="p">(</span><span class="n">fdtv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">response</span> <span class="o">!=</span> <span class="n">AVC_RESPONSE_ACCEPTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;LNB control failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">avc_register_remote_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ctype</span>   <span class="o">=</span> <span class="n">AVC_CTYPE_NOTIFY</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">subunit</span> <span class="o">=</span> <span class="n">AVC_SUBUNIT_TYPE_UNIT</span> <span class="o">|</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">opcode</span>  <span class="o">=</span> <span class="n">AVC_OPCODE_VENDOR</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_1</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_2</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_OPCODE_REGISTER_REMOTE_CONTROL</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* padding */</span>

	<span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data_length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">avc_write</span><span class="p">(</span><span class="n">fdtv</span><span class="p">);</span>

	<span class="cm">/* FIXME: check response code? */</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">avc_remote_ctrl_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">firedtv</span><span class="p">,</span> <span class="n">remote_ctrl_work</span><span class="p">);</span>

	<span class="cm">/* Should it be rescheduled in failure cases? */</span>
	<span class="n">avc_register_remote_control</span><span class="p">(</span><span class="n">fdtv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"> /* FIXME: unused */</span>
<span class="c">int avc_tuner_host2ca(struct firedtv *fdtv)</span>
<span class="c">{</span>
<span class="c">	struct avc_command_frame *c = (void *)fdtv-&gt;avc_data;</span>
<span class="c">	int ret;</span>

<span class="c">	mutex_lock(&amp;fdtv-&gt;avc_mutex);</span>

<span class="c">	c-&gt;ctype   = AVC_CTYPE_CONTROL;</span>
<span class="c">	c-&gt;subunit = AVC_SUBUNIT_TYPE_TUNER | fdtv-&gt;subunit;</span>
<span class="c">	c-&gt;opcode  = AVC_OPCODE_VENDOR;</span>

<span class="c">	c-&gt;operand[0] = SFE_VENDOR_DE_COMPANYID_0;</span>
<span class="c">	c-&gt;operand[1] = SFE_VENDOR_DE_COMPANYID_1;</span>
<span class="c">	c-&gt;operand[2] = SFE_VENDOR_DE_COMPANYID_2;</span>
<span class="c">	c-&gt;operand[3] = SFE_VENDOR_OPCODE_HOST2CA;</span>
<span class="c">	c-&gt;operand[4] = 0; /* slot */</span>
<span class="c">	c-&gt;operand[5] = SFE_VENDOR_TAG_CA_APPLICATION_INFO; /* ca tag */</span>
<span class="c">	clear_operands(c, 6, 8);</span>

<span class="c">	fdtv-&gt;avc_data_length = 12;</span>
<span class="c">	ret = avc_write(fdtv);</span>

<span class="c">	/* FIXME: check response code? */</span>

<span class="c">	mutex_unlock(&amp;fdtv-&gt;avc_mutex);</span>

<span class="c">	return ret;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_ca_object_pos</span><span class="p">(</span><span class="k">struct</span> <span class="n">avc_response_frame</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Check length of length field */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">length</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_ca_object_length</span><span class="p">(</span><span class="k">struct</span> <span class="n">avc_response_frame</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"> /* FIXME: unused */</span>
<span class="c">	int size = 0;</span>
<span class="c">	int i;</span>

<span class="c">	if (r-&gt;operand[7] &amp; 0x80)</span>
<span class="c">		for (i = 0; i &lt; (r-&gt;operand[7] &amp; 0x7f); i++) {</span>
<span class="c">			size &lt;&lt;= 8;</span>
<span class="c">			size += r-&gt;operand[8 + i];</span>
<span class="c">		}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">avc_ca_app_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">app_info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">avc_response_frame</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ctype</span>   <span class="o">=</span> <span class="n">AVC_CTYPE_STATUS</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">subunit</span> <span class="o">=</span> <span class="n">AVC_SUBUNIT_TYPE_TUNER</span> <span class="o">|</span> <span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">subunit</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">opcode</span>  <span class="o">=</span> <span class="n">AVC_OPCODE_VENDOR</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_1</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_2</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_OPCODE_CA2HOST</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* slot */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_TAG_CA_APPLICATION_INFO</span><span class="p">;</span> <span class="cm">/* ca tag */</span>
	<span class="n">clear_operands</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">LAST_OPERAND</span><span class="p">);</span>

	<span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data_length</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">avc_write</span><span class="p">(</span><span class="n">fdtv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* FIXME: check response code and validate response data */</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">get_ca_object_pos</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="n">app_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">EN50221_TAG_APP_INFO</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">app_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">EN50221_TAG_APP_INFO</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">app_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">EN50221_TAG_APP_INFO</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">app_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span><span class="p">];</span>
	<span class="n">app_info</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">app_info</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]);</span>
	<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">app_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">avc_ca_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">app_info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">avc_response_frame</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ctype</span>   <span class="o">=</span> <span class="n">AVC_CTYPE_STATUS</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">subunit</span> <span class="o">=</span> <span class="n">AVC_SUBUNIT_TYPE_TUNER</span> <span class="o">|</span> <span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">subunit</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">opcode</span>  <span class="o">=</span> <span class="n">AVC_OPCODE_VENDOR</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_1</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_2</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_OPCODE_CA2HOST</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* slot */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_TAG_CA_APPLICATION_INFO</span><span class="p">;</span> <span class="cm">/* ca tag */</span>
	<span class="n">clear_operands</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">LAST_OPERAND</span><span class="p">);</span>

	<span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data_length</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">avc_write</span><span class="p">(</span><span class="n">fdtv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* FIXME: check response code and validate response data */</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">get_ca_object_pos</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="n">app_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">EN50221_TAG_CA_INFO</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">app_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">EN50221_TAG_CA_INFO</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">app_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">EN50221_TAG_CA_INFO</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_fake_ca_system_ids</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">app_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">app_info</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">0</span><span class="p">];</span>
		<span class="n">app_info</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">app_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_fake_ca_system_ids</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_fake_ca_system_ids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">app_info</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">fake_ca_system_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">app_info</span><span class="p">[</span><span class="mi">5</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">fake_ca_system_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">app_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">avc_ca_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ctype</span>   <span class="o">=</span> <span class="n">AVC_CTYPE_CONTROL</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">subunit</span> <span class="o">=</span> <span class="n">AVC_SUBUNIT_TYPE_TUNER</span> <span class="o">|</span> <span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">subunit</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">opcode</span>  <span class="o">=</span> <span class="n">AVC_OPCODE_VENDOR</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_1</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_2</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_OPCODE_HOST2CA</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* slot */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_TAG_CA_RESET</span><span class="p">;</span> <span class="cm">/* ca tag */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* more/last */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* length */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* force hardware reset */</span>

	<span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data_length</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">avc_write</span><span class="p">(</span><span class="n">fdtv</span><span class="p">);</span>

	<span class="cm">/* FIXME: check response code? */</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">avc_ca_pmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">avc_response_frame</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">list_management</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">program_info_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pmt_cmd_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">read_pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">write_pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">es_info_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">crc32_csum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">avc_debug</span> <span class="o">&amp;</span> <span class="n">AVC_DEBUG_APPLICATION_PMT</span><span class="p">))</span>
		<span class="n">debug_pmt</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ctype</span>   <span class="o">=</span> <span class="n">AVC_CTYPE_CONTROL</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">subunit</span> <span class="o">=</span> <span class="n">AVC_SUBUNIT_TYPE_TUNER</span> <span class="o">|</span> <span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">subunit</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">opcode</span>  <span class="o">=</span> <span class="n">AVC_OPCODE_VENDOR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">EN50221_LIST_MANAGEMENT_ONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;forcing list_management to ONLY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">EN50221_LIST_MANAGEMENT_ONLY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* We take the cmd_id from the programme level only! */</span>
	<span class="n">list_management</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">program_info_length</span> <span class="o">=</span> <span class="p">((</span><span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">program_info_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">program_info_length</span><span class="o">--</span><span class="p">;</span> <span class="cm">/* Remove pmt_cmd_id */</span>
	<span class="n">pmt_cmd_id</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_1</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_2</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_OPCODE_HOST2CA</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* slot */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_TAG_CA_PMT</span><span class="p">;</span> <span class="cm">/* ca tag */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* more/last */</span>
	<span class="cm">/* Use three bytes for length field in case length &gt; 127 */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_management</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* pmt_cmd=OK_descramble */</span>

	<span class="cm">/* TS program map table */</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span> <span class="cm">/* Table id=2 */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* Section syntax + length */</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="cm">/* Program number */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* Version number and current/next */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* Section number=0 */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* Last section number=0 */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span> <span class="cm">/* PCR_PID=1FFF */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">program_info_length</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span> <span class="cm">/* Program info length */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">program_info_length</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="cm">/* CA descriptors at programme level */</span>
	<span class="n">read_pos</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">write_pos</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">program_info_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pmt_cmd_id</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">read_pos</span><span class="o">++</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmt_cmd_id</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">pmt_cmd_id</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				<span class="s">&quot;invalid pmt_cmd_id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pmt_cmd_id</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="n">read_pos</span><span class="p">],</span>
		       <span class="n">program_info_length</span><span class="p">);</span>
		<span class="n">read_pos</span> <span class="o">+=</span> <span class="n">program_info_length</span><span class="p">;</span>
		<span class="n">write_pos</span> <span class="o">+=</span> <span class="n">program_info_length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">read_pos</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">read_pos</span><span class="o">++</span><span class="p">];</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">read_pos</span><span class="o">++</span><span class="p">];</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">read_pos</span><span class="o">++</span><span class="p">];</span>
		<span class="n">es_info_length</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">msg</span><span class="p">[</span><span class="n">read_pos</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="n">read_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">read_pos</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es_info_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">es_info_length</span><span class="o">--</span><span class="p">;</span> <span class="cm">/* Remove pmt_cmd_id */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">es_info_length</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">es_info_length</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es_info_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pmt_cmd_id</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">read_pos</span><span class="o">++</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pmt_cmd_id</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">pmt_cmd_id</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;invalid pmt_cmd_id %d &quot;</span>
					<span class="s">&quot;at stream level</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pmt_cmd_id</span><span class="p">);</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="n">read_pos</span><span class="p">],</span>
			       <span class="n">es_info_length</span><span class="p">);</span>
			<span class="n">read_pos</span> <span class="o">+=</span> <span class="n">es_info_length</span><span class="p">;</span>
			<span class="n">write_pos</span> <span class="o">+=</span> <span class="n">es_info_length</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">write_pos</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* CRC */</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x82</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">write_pos</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">write_pos</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">write_pos</span> <span class="o">-</span> <span class="mi">15</span><span class="p">;</span>

	<span class="n">crc32_csum</span> <span class="o">=</span> <span class="n">crc32_be</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc32_csum</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc32_csum</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc32_csum</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc32_csum</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">pad_operands</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">write_pos</span><span class="p">);</span>

	<span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data_length</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">write_pos</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">avc_write</span><span class="p">(</span><span class="n">fdtv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">response</span> <span class="o">!=</span> <span class="n">AVC_RESPONSE_ACCEPTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
			<span class="s">&quot;CA PMT failed with response 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">avc_ca_get_time_date</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">interval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">avc_response_frame</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ctype</span>   <span class="o">=</span> <span class="n">AVC_CTYPE_STATUS</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">subunit</span> <span class="o">=</span> <span class="n">AVC_SUBUNIT_TYPE_TUNER</span> <span class="o">|</span> <span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">subunit</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">opcode</span>  <span class="o">=</span> <span class="n">AVC_OPCODE_VENDOR</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_1</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_2</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_OPCODE_CA2HOST</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* slot */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_TAG_CA_DATE_TIME</span><span class="p">;</span> <span class="cm">/* ca tag */</span>
	<span class="n">clear_operands</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">LAST_OPERAND</span><span class="p">);</span>

	<span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data_length</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">avc_write</span><span class="p">(</span><span class="n">fdtv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* FIXME: check response code and validate response data */</span>

	<span class="o">*</span><span class="n">interval</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">get_ca_object_pos</span><span class="p">(</span><span class="n">r</span><span class="p">)];</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">avc_ca_enter_menu</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ctype</span>   <span class="o">=</span> <span class="n">AVC_CTYPE_STATUS</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">subunit</span> <span class="o">=</span> <span class="n">AVC_SUBUNIT_TYPE_TUNER</span> <span class="o">|</span> <span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">subunit</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">opcode</span>  <span class="o">=</span> <span class="n">AVC_OPCODE_VENDOR</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_1</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_2</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_OPCODE_HOST2CA</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* slot */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_TAG_CA_ENTER_MENU</span><span class="p">;</span>
	<span class="n">clear_operands</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data_length</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">avc_write</span><span class="p">(</span><span class="n">fdtv</span><span class="p">);</span>

	<span class="cm">/* FIXME: check response code? */</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">avc_ca_get_mmi</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mmi_object</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">avc_response_frame</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ctype</span>   <span class="o">=</span> <span class="n">AVC_CTYPE_STATUS</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">subunit</span> <span class="o">=</span> <span class="n">AVC_SUBUNIT_TYPE_TUNER</span> <span class="o">|</span> <span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">subunit</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">opcode</span>  <span class="o">=</span> <span class="n">AVC_OPCODE_VENDOR</span><span class="p">;</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_1</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_2</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_OPCODE_CA2HOST</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* slot */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_TAG_CA_MMI</span><span class="p">;</span>
	<span class="n">clear_operands</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">LAST_OPERAND</span><span class="p">);</span>

	<span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data_length</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">avc_write</span><span class="p">(</span><span class="n">fdtv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* FIXME: check response code and validate response data */</span>

	<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">get_ca_object_length</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mmi_object</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">get_ca_object_pos</span><span class="p">(</span><span class="n">r</span><span class="p">)],</span> <span class="o">*</span><span class="n">len</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CMP_OUTPUT_PLUG_CONTROL_REG_0	0xfffff0000904ULL</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmp_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">,</span> <span class="n">u64</span> <span class="n">addr</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fdtv_read</span><span class="p">(</span><span class="n">fdtv</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CMP: read I/O error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmp_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">,</span> <span class="n">u64</span> <span class="n">addr</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">data</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fdtv_lock</span><span class="p">(</span><span class="n">fdtv</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CMP: lock I/O error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">get_opcr</span><span class="p">(</span><span class="n">__be32</span> <span class="n">opcr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">shift</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">opcr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_opcr</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="n">opcr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">shift</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">opcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="o">*</span><span class="n">opcr</span> <span class="o">|=</span> <span class="n">cpu_to_be32</span><span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define get_opcr_online(v)		get_opcr((v), 0x1, 31)</span>
<span class="cp">#define get_opcr_p2p_connections(v)	get_opcr((v), 0x3f, 24)</span>
<span class="cp">#define get_opcr_channel(v)		get_opcr((v), 0x3f, 16)</span>

<span class="cp">#define set_opcr_p2p_connections(p, v)	set_opcr((p), (v), 0x3f, 24)</span>
<span class="cp">#define set_opcr_channel(p, v)		set_opcr((p), (v), 0x3f, 16)</span>
<span class="cp">#define set_opcr_data_rate(p, v)	set_opcr((p), (v), 0x3, 14)</span>
<span class="cp">#define set_opcr_overhead_id(p, v)	set_opcr((p), (v), 0xf, 10)</span>

<span class="kt">int</span> <span class="nf">cmp_establish_pp_connection</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">plug</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">old_opcr</span><span class="p">,</span> <span class="n">opcr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">opcr_address</span> <span class="o">=</span> <span class="n">CMP_OUTPUT_PLUG_CONTROL_REG_0</span> <span class="o">+</span> <span class="p">(</span><span class="n">plug</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cmp_read</span><span class="p">(</span><span class="n">fdtv</span><span class="p">,</span> <span class="n">opcr_address</span><span class="p">,</span> <span class="n">opcr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">repeat:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_opcr_online</span><span class="p">(</span><span class="o">*</span><span class="n">opcr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CMP: output offline</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">old_opcr</span> <span class="o">=</span> <span class="o">*</span><span class="n">opcr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_opcr_p2p_connections</span><span class="p">(</span><span class="o">*</span><span class="n">opcr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_opcr_channel</span><span class="p">(</span><span class="o">*</span><span class="n">opcr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CMP: cannot change channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CMP: overlaying connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* We don&#39;t allocate isochronous resources. */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">set_opcr_channel</span><span class="p">(</span><span class="n">opcr</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="n">set_opcr_data_rate</span><span class="p">(</span><span class="n">opcr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* S400 */</span>

		<span class="cm">/* FIXME: this is for the worst case - optimize */</span>
		<span class="n">set_opcr_overhead_id</span><span class="p">(</span><span class="n">opcr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* FIXME: allocate isochronous channel and bandwidth at IRM */</span>
	<span class="p">}</span>

	<span class="n">set_opcr_p2p_connections</span><span class="p">(</span><span class="n">opcr</span><span class="p">,</span> <span class="n">get_opcr_p2p_connections</span><span class="p">(</span><span class="o">*</span><span class="n">opcr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">opcr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">opcr</span><span class="p">;</span>
	<span class="n">opcr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_opcr</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cmp_lock</span><span class="p">(</span><span class="n">fdtv</span><span class="p">,</span> <span class="n">opcr_address</span><span class="p">,</span> <span class="n">opcr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_opcr</span> <span class="o">!=</span> <span class="o">*</span><span class="n">opcr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * FIXME: if old_opcr.P2P_Connections &gt; 0,</span>
<span class="cm">		 * deallocate isochronous channel and bandwidth at IRM</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">attempts</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="cm">/* arbitrary limit */</span>
			<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cmp_break_pp_connection</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">plug</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">old_opcr</span><span class="p">,</span> <span class="n">opcr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">opcr_address</span> <span class="o">=</span> <span class="n">CMP_OUTPUT_PLUG_CONTROL_REG_0</span> <span class="o">+</span> <span class="p">(</span><span class="n">plug</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmp_read</span><span class="p">(</span><span class="n">fdtv</span><span class="p">,</span> <span class="n">opcr_address</span><span class="p">,</span> <span class="n">opcr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

<span class="nl">repeat:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_opcr_online</span><span class="p">(</span><span class="o">*</span><span class="n">opcr</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">get_opcr_p2p_connections</span><span class="p">(</span><span class="o">*</span><span class="n">opcr</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">get_opcr_channel</span><span class="p">(</span><span class="o">*</span><span class="n">opcr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;CMP: no connection to break</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">old_opcr</span> <span class="o">=</span> <span class="o">*</span><span class="n">opcr</span><span class="p">;</span>
	<span class="n">set_opcr_p2p_connections</span><span class="p">(</span><span class="n">opcr</span><span class="p">,</span> <span class="n">get_opcr_p2p_connections</span><span class="p">(</span><span class="o">*</span><span class="n">opcr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">opcr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">opcr</span><span class="p">;</span>
	<span class="n">opcr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_opcr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmp_lock</span><span class="p">(</span><span class="n">fdtv</span><span class="p">,</span> <span class="n">opcr_address</span><span class="p">,</span> <span class="n">opcr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_opcr</span> <span class="o">!=</span> <span class="o">*</span><span class="n">opcr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * FIXME: if old_opcr.P2P_Connections == 1, i.e. we were last</span>
<span class="cm">		 * owner, deallocate isochronous channel and bandwidth at IRM</span>
<span class="cm">		 * if (...)</span>
<span class="cm">		 *	fdtv-&gt;backend-&gt;dealloc_resources(fdtv, channel, bw);</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">attempts</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="cm">/* arbitrary limit */</span>
			<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
