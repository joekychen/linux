<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hysdn › hysdn_boot.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>hysdn_boot.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: hysdn_boot.c,v 1.4.6.4 2001/09/23 22:24:54 kai Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * Linux driver for HYSDN cards</span>
<span class="cm"> * specific routines for booting and pof handling</span>
<span class="cm"> *</span>
<span class="cm"> * Author    Werner Cornelius (werner@titro.de) for Hypercope GmbH</span>
<span class="cm"> * Copyright 1999 by Werner Cornelius (werner@titro.de)</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;hysdn_defs.h&quot;</span>
<span class="cp">#include &quot;hysdn_pof.h&quot;</span>

<span class="cm">/********************************/</span>
<span class="cm">/* defines for pof read handler */</span>
<span class="cm">/********************************/</span>
<span class="cp">#define POF_READ_FILE_HEAD  0</span>
<span class="cp">#define POF_READ_TAG_HEAD   1</span>
<span class="cp">#define POF_READ_TAG_DATA   2</span>

<span class="cm">/************************************************************/</span>
<span class="cm">/* definition of boot specific data area. This data is only */</span>
<span class="cm">/* needed during boot and so allocated dynamically.         */</span>
<span class="cm">/************************************************************/</span>
<span class="k">struct</span> <span class="n">boot_data</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">Cryptor</span><span class="p">;</span>	<span class="cm">/* for use with Decrypt function */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">Nrecs</span><span class="p">;</span>	<span class="cm">/* records remaining in file */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pof_state</span><span class="p">;</span><span class="cm">/* actual state of read handler */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">is_crypted</span><span class="p">;</span><span class="cm">/* card data is crypted */</span>
	<span class="kt">int</span> <span class="n">BufSize</span><span class="p">;</span>		<span class="cm">/* actual number of bytes bufferd */</span>
	<span class="kt">int</span> <span class="n">last_error</span><span class="p">;</span>		<span class="cm">/* last occurred error */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pof_recid</span><span class="p">;</span><span class="cm">/* actual pof recid */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pof_reclen</span><span class="p">;</span><span class="cm">/* total length of pof record data */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pof_recoffset</span><span class="p">;</span><span class="cm">/* actual offset inside pof record */</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">BootBuf</span><span class="p">[</span><span class="n">BOOT_BUF_SIZE</span><span class="p">];</span><span class="cm">/* buffer as byte count */</span>
		<span class="n">tPofRecHdr</span> <span class="n">PofRecHdr</span><span class="p">;</span>	<span class="cm">/* header for actual record/chunk */</span>
		<span class="n">tPofFileHdr</span> <span class="n">PofFileHdr</span><span class="p">;</span>		<span class="cm">/* header from POF file */</span>
		<span class="n">tPofTimeStamp</span> <span class="n">PofTime</span><span class="p">;</span>	<span class="cm">/* time information */</span>
	<span class="p">}</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*****************************************************/</span>
<span class="cm">/*  start decryption of successive POF file chuncks.  */</span>
<span class="cm">/*                                                   */</span>
<span class="cm">/*  to be called at start of POF file reading,       */</span>
<span class="cm">/*  before starting any decryption on any POF record. */</span>
<span class="cm">/*****************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">StartDecryption</span><span class="p">(</span><span class="k">struct</span> <span class="n">boot_data</span> <span class="o">*</span><span class="n">boot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">boot</span><span class="o">-&gt;</span><span class="n">Cryptor</span> <span class="o">=</span> <span class="n">CRYPT_STARTTERM</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* StartDecryption */</span>


<span class="cm">/***************************************************************/</span>
<span class="cm">/* decrypt complete BootBuf                                    */</span>
<span class="cm">/* NOTE: decryption must be applied to all or none boot tags - */</span>
<span class="cm">/*       to HI and LO boot loader and (all) seq tags, because  */</span>
<span class="cm">/*       global Cryptor is started for whole POF.              */</span>
<span class="cm">/***************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">DecryptBuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">boot_data</span> <span class="o">*</span><span class="n">boot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bufp</span> <span class="o">=</span> <span class="n">boot</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">BootBuf</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">boot</span><span class="o">-&gt;</span><span class="n">Cryptor</span> <span class="o">=</span> <span class="p">(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">Cryptor</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">Cryptor</span> <span class="o">&amp;</span> <span class="mi">1U</span><span class="p">)</span> <span class="o">?</span> <span class="n">CRYPT_FEEDTERM</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="o">*</span><span class="n">bufp</span><span class="o">++</span> <span class="o">^=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">Cryptor</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>				<span class="cm">/* DecryptBuf */</span>

<span class="cm">/********************************************************************************/</span>
<span class="cm">/* pof_handle_data executes the required actions dependent on the active record */</span>
<span class="cm">/* id. If successful 0 is returned, a negative value shows an error.           */</span>
<span class="cm">/********************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pof_handle_data</span><span class="p">(</span><span class="n">hysdn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">datlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">boot_data</span> <span class="o">*</span><span class="n">boot</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">boot</span><span class="p">;</span>	<span class="cm">/* pointer to boot specific data */</span>
	<span class="kt">long</span> <span class="n">l</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">imgp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">img_len</span><span class="p">;</span>

	<span class="cm">/* handle the different record types */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_recid</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">TAG_TIMESTMP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debug_flags</span> <span class="o">&amp;</span> <span class="n">LOG_POF_RECORD</span><span class="p">)</span>
			<span class="n">hysdn_addlog</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;POF created %s&quot;</span><span class="p">,</span> <span class="n">boot</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">PofTime</span><span class="p">.</span><span class="n">DateTimeText</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TAG_CBOOTDTA</span>:
		<span class="n">DecryptBuf</span><span class="p">(</span><span class="n">boot</span><span class="p">,</span> <span class="n">datlen</span><span class="p">);</span>	<span class="cm">/* we need to encrypt the buffer */</span>
	<span class="k">case</span> <span class="n">TAG_BOOTDTA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debug_flags</span> <span class="o">&amp;</span> <span class="n">LOG_POF_RECORD</span><span class="p">)</span>
			<span class="n">hysdn_addlog</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;POF got %s len=%d offs=0x%lx&quot;</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_recid</span> <span class="o">==</span> <span class="n">TAG_CBOOTDTA</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;CBOOTDATA&quot;</span> <span class="o">:</span> <span class="s">&quot;BOOTDTA&quot;</span><span class="p">,</span>
				     <span class="n">datlen</span><span class="p">,</span> <span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_recoffset</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_reclen</span> <span class="o">!=</span> <span class="n">POF_BOOT_LOADER_TOTAL_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span> <span class="o">=</span> <span class="n">EPOF_BAD_IMG_SIZE</span><span class="p">;</span>	<span class="cm">/* invalid length */</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">imgp</span> <span class="o">=</span> <span class="n">boot</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">BootBuf</span><span class="p">;</span>	<span class="cm">/* start of buffer */</span>
		<span class="n">img_len</span> <span class="o">=</span> <span class="n">datlen</span><span class="p">;</span>	<span class="cm">/* maximum length to transfer */</span>

		<span class="n">l</span> <span class="o">=</span> <span class="n">POF_BOOT_LOADER_OFF_IN_PAGE</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_recoffset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">POF_BOOT_LOADER_PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* buffer needs to be truncated */</span>
			<span class="n">imgp</span> <span class="o">+=</span> <span class="n">l</span><span class="p">;</span>	<span class="cm">/* advance pointer */</span>
			<span class="n">img_len</span> <span class="o">-=</span> <span class="n">l</span><span class="p">;</span>	<span class="cm">/* adjust len */</span>
		<span class="p">}</span>
		<span class="cm">/* at this point no special handling for data wrapping over buffer */</span>
		<span class="cm">/* is necessary, because the boot image always will be adjusted to */</span>
		<span class="cm">/* match a page boundary inside the buffer.                        */</span>
		<span class="cm">/* The buffer for the boot image on the card is filled in 2 cycles */</span>
		<span class="cm">/* first the 1024 hi-words are put in the buffer, then the low 1024 */</span>
		<span class="cm">/* word are handled in the same way with different offset.         */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">img_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* data available for copy */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span> <span class="o">=</span>
			     <span class="n">card</span><span class="o">-&gt;</span><span class="n">writebootimg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">imgp</span><span class="p">,</span>
						<span class="p">(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_recoffset</span> <span class="o">&gt;</span> <span class="n">POF_BOOT_LOADER_PAGE_SIZE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>	<span class="cm">/* end of case boot image hi/lo */</span>

	<span class="k">case</span> <span class="n">TAG_CABSDATA</span>:
		<span class="n">DecryptBuf</span><span class="p">(</span><span class="n">boot</span><span class="p">,</span> <span class="n">datlen</span><span class="p">);</span>	<span class="cm">/* we need to encrypt the buffer */</span>
	<span class="k">case</span> <span class="n">TAG_ABSDATA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debug_flags</span> <span class="o">&amp;</span> <span class="n">LOG_POF_RECORD</span><span class="p">)</span>
			<span class="n">hysdn_addlog</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;POF got %s len=%d offs=0x%lx&quot;</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_recid</span> <span class="o">==</span> <span class="n">TAG_CABSDATA</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;CABSDATA&quot;</span> <span class="o">:</span> <span class="s">&quot;ABSDATA&quot;</span><span class="p">,</span>
				     <span class="n">datlen</span><span class="p">,</span> <span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_recoffset</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">writebootseq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">boot</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">BootBuf</span><span class="p">,</span> <span class="n">datlen</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span><span class="p">);</span>	<span class="cm">/* error writing data */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_recoffset</span> <span class="o">+</span> <span class="n">datlen</span> <span class="o">&gt;=</span> <span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_reclen</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">waitpofready</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>	<span class="cm">/* data completely spooled, wait for ready */</span>

		<span class="k">break</span><span class="p">;</span>	<span class="cm">/* end of case boot seq data */</span>

	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debug_flags</span> <span class="o">&amp;</span> <span class="n">LOG_POF_RECORD</span><span class="p">)</span>
			<span class="n">hysdn_addlog</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;POF got data(id=0x%lx) len=%d offs=0x%lx&quot;</span><span class="p">,</span> <span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_recid</span><span class="p">,</span>
				     <span class="n">datlen</span><span class="p">,</span> <span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_recoffset</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>	<span class="cm">/* simply skip record */</span>
	<span class="p">}</span>			<span class="cm">/* switch boot-&gt;pof_recid */</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>				<span class="cm">/* pof_handle_data */</span>


<span class="cm">/******************************************************************************/</span>
<span class="cm">/* pof_write_buffer is called when the buffer has been filled with the needed */</span>
<span class="cm">/* number of data bytes. The number delivered is additionally supplied for    */</span>
<span class="cm">/* verification. The functions handles the data and returns the needed number */</span>
<span class="cm">/* of bytes for the next action. If the returned value is 0 or less an error  */</span>
<span class="cm">/* occurred and booting must be aborted.                                       */</span>
<span class="cm">/******************************************************************************/</span>
<span class="kt">int</span>
<span class="nf">pof_write_buffer</span><span class="p">(</span><span class="n">hysdn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">datlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">boot_data</span> <span class="o">*</span><span class="n">boot</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">boot</span><span class="p">;</span>	<span class="cm">/* pointer to boot specific data */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boot</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>	<span class="cm">/* invalid call */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span><span class="p">);</span>	<span class="cm">/* repeated error */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debug_flags</span> <span class="o">&amp;</span> <span class="n">LOG_POF_WRITE</span><span class="p">)</span>
		<span class="n">hysdn_addlog</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;POF write: got %d bytes &quot;</span><span class="p">,</span> <span class="n">datlen</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">POF_READ_FILE_HEAD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debug_flags</span> <span class="o">&amp;</span> <span class="n">LOG_POF_WRITE</span><span class="p">)</span>
			<span class="n">hysdn_addlog</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;POF write: checking file header&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">datlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tPofFileHdr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPOF_INTERNAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">PofFileHdr</span><span class="p">.</span><span class="n">Magic</span> <span class="o">!=</span> <span class="n">TAGFILEMAGIC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPOF_BAD_MAGIC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Setup the new state and vars */</span>
		<span class="n">boot</span><span class="o">-&gt;</span><span class="n">Nrecs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">PofFileHdr</span><span class="p">.</span><span class="n">N_PofRecs</span><span class="p">);</span>	<span class="cm">/* limited to 65535 */</span>
		<span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_state</span> <span class="o">=</span> <span class="n">POF_READ_TAG_HEAD</span><span class="p">;</span>	<span class="cm">/* now start with single tags */</span>
		<span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tPofRecHdr</span><span class="p">);</span>	<span class="cm">/* new length */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">POF_READ_TAG_HEAD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debug_flags</span> <span class="o">&amp;</span> <span class="n">LOG_POF_WRITE</span><span class="p">)</span>
			<span class="n">hysdn_addlog</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;POF write: checking tag header&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">datlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tPofRecHdr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPOF_INTERNAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_recid</span> <span class="o">=</span> <span class="n">boot</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">PofRecHdr</span><span class="p">.</span><span class="n">PofRecId</span><span class="p">;</span>		<span class="cm">/* actual pof recid */</span>
		<span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_reclen</span> <span class="o">=</span> <span class="n">boot</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">PofRecHdr</span><span class="p">.</span><span class="n">PofRecDataLen</span><span class="p">;</span>	<span class="cm">/* total length */</span>
		<span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_recoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no starting offset */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debug_flags</span> <span class="o">&amp;</span> <span class="n">LOG_POF_RECORD</span><span class="p">)</span>
			<span class="n">hysdn_addlog</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;POF: got record id=0x%lx length=%ld &quot;</span><span class="p">,</span>
				     <span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_recid</span><span class="p">,</span> <span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_reclen</span><span class="p">);</span>

		<span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_state</span> <span class="o">=</span> <span class="n">POF_READ_TAG_DATA</span><span class="p">;</span>	<span class="cm">/* now start with tag data */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_reclen</span> <span class="o">&lt;</span> <span class="n">BOOT_BUF_SIZE</span><span class="p">)</span>
			<span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span> <span class="o">=</span> <span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_reclen</span><span class="p">;</span>	<span class="cm">/* limit size */</span>
		<span class="k">else</span>
			<span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span> <span class="o">=</span> <span class="n">BOOT_BUF_SIZE</span><span class="p">;</span>	<span class="cm">/* maximum */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* no data inside record */</span>
			<span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_state</span> <span class="o">=</span> <span class="n">POF_READ_TAG_HEAD</span><span class="p">;</span>	<span class="cm">/* now start with single tags */</span>
			<span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tPofRecHdr</span><span class="p">);</span>	<span class="cm">/* new length */</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">POF_READ_TAG_DATA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debug_flags</span> <span class="o">&amp;</span> <span class="n">LOG_POF_WRITE</span><span class="p">)</span>
			<span class="n">hysdn_addlog</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;POF write: getting tag data&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">datlen</span> <span class="o">!=</span> <span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPOF_INTERNAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span> <span class="o">=</span> <span class="n">pof_handle_data</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">datlen</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span><span class="p">);</span>	<span class="cm">/* an error occurred */</span>
		<span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_recoffset</span> <span class="o">+=</span> <span class="n">datlen</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_recoffset</span> <span class="o">&gt;=</span> <span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_reclen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_state</span> <span class="o">=</span> <span class="n">POF_READ_TAG_HEAD</span><span class="p">;</span>	<span class="cm">/* now start with single tags */</span>
			<span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tPofRecHdr</span><span class="p">);</span>	<span class="cm">/* new length */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_reclen</span> <span class="o">-</span> <span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_recoffset</span> <span class="o">&lt;</span> <span class="n">BOOT_BUF_SIZE</span><span class="p">)</span>
				<span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span> <span class="o">=</span> <span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_reclen</span> <span class="o">-</span> <span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_recoffset</span><span class="p">;</span>	<span class="cm">/* limit size */</span>
			<span class="k">else</span>
				<span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span> <span class="o">=</span> <span class="n">BOOT_BUF_SIZE</span><span class="p">;</span>	<span class="cm">/* maximum */</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPOF_INTERNAL</span><span class="p">;</span>	<span class="cm">/* unknown state */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>			<span class="cm">/* switch (boot-&gt;pof_state) */</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span><span class="p">);</span>
<span class="p">}</span>				<span class="cm">/* pof_write_buffer */</span>


<span class="cm">/*******************************************************************************/</span>
<span class="cm">/* pof_write_open is called when an open for boot on the cardlog device occurs. */</span>
<span class="cm">/* The function returns the needed number of bytes for the next operation. If  */</span>
<span class="cm">/* the returned number is less or equal 0 an error specified by this code      */</span>
<span class="cm">/* occurred. Additionally the pointer to the buffer data area is set on success */</span>
<span class="cm">/*******************************************************************************/</span>
<span class="kt">int</span>
<span class="nf">pof_write_open</span><span class="p">(</span><span class="n">hysdn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">bufp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">boot_data</span> <span class="o">*</span><span class="n">boot</span><span class="p">;</span>	<span class="cm">/* pointer to boot specific data */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">boot</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debug_flags</span> <span class="o">&amp;</span> <span class="n">LOG_POF_OPEN</span><span class="p">)</span>
			<span class="n">hysdn_addlog</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;POF open: already opened for boot&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ERR_ALREADY_BOOT</span><span class="p">);</span>	<span class="cm">/* boot already active */</span>
	<span class="p">}</span>
	<span class="cm">/* error no mem available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">boot</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">boot_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debug_flags</span> <span class="o">&amp;</span> <span class="n">LOG_MEM_ERR</span><span class="p">)</span>
			<span class="n">hysdn_addlog</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;POF open: unable to allocate mem&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">boot</span> <span class="o">=</span> <span class="n">boot</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CARD_STATE_BOOTING</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">stopcard</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>	<span class="cm">/* first stop the card */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">testram</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debug_flags</span> <span class="o">&amp;</span> <span class="n">LOG_POF_OPEN</span><span class="p">)</span>
			<span class="n">hysdn_addlog</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;POF open: DPRAM test failure&quot;</span><span class="p">);</span>
		<span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERR_BOARD_DPRAM</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CARD_STATE_BOOTERR</span><span class="p">;</span>	<span class="cm">/* show boot error */</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">boot</span><span class="o">-&gt;</span><span class="n">last_error</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">boot</span><span class="o">-&gt;</span><span class="n">BufSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Buffer is empty */</span>
	<span class="n">boot</span><span class="o">-&gt;</span><span class="n">pof_state</span> <span class="o">=</span> <span class="n">POF_READ_FILE_HEAD</span><span class="p">;</span>	<span class="cm">/* read file header */</span>
	<span class="n">StartDecryption</span><span class="p">(</span><span class="n">boot</span><span class="p">);</span>	<span class="cm">/* if POF File should be encrypted */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debug_flags</span> <span class="o">&amp;</span> <span class="n">LOG_POF_OPEN</span><span class="p">)</span>
		<span class="n">hysdn_addlog</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;POF open: success&quot;</span><span class="p">);</span>

	<span class="o">*</span><span class="n">bufp</span> <span class="o">=</span> <span class="n">boot</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">BootBuf</span><span class="p">;</span>	<span class="cm">/* point to buffer */</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">tPofFileHdr</span><span class="p">));</span>
<span class="p">}</span>				<span class="cm">/* pof_write_open */</span>

<span class="cm">/********************************************************************************/</span>
<span class="cm">/* pof_write_close is called when an close of boot on the cardlog device occurs. */</span>
<span class="cm">/* The return value must be 0 if everything has happened as desired.            */</span>
<span class="cm">/********************************************************************************/</span>
<span class="kt">int</span>
<span class="nf">pof_write_close</span><span class="p">(</span><span class="n">hysdn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">boot_data</span> <span class="o">*</span><span class="n">boot</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">boot</span><span class="p">;</span>	<span class="cm">/* pointer to boot specific data */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boot</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>	<span class="cm">/* invalid call */</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">boot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* no boot active */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">boot</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CARD_STATE_RUN</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">set_errlog_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* activate error log */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debug_flags</span> <span class="o">&amp;</span> <span class="n">LOG_POF_OPEN</span><span class="p">)</span>
		<span class="n">hysdn_addlog</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;POF close: success&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>				<span class="cm">/* pof_write_close */</span>

<span class="cm">/*********************************************************************************/</span>
<span class="cm">/* EvalSysrTokData checks additional records delivered with the Sysready Message */</span>
<span class="cm">/* when POF has been booted. A return value of 0 is used if no error occurred.    */</span>
<span class="cm">/*********************************************************************************/</span>
<span class="kt">int</span>
<span class="nf">EvalSysrTokData</span><span class="p">(</span><span class="n">hysdn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">crc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debug_flags</span> <span class="o">&amp;</span> <span class="n">LOG_POF_RECORD</span><span class="p">)</span>
		<span class="n">hysdn_addlog</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;SysReady Token data length %d&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hysdn_addlog</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;SysReady Token Data to short&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">cp</span><span class="p">,</span> <span class="n">crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
			<span class="n">crc</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u_char</span><span class="p">)</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">crc</span> <span class="o">=</span> <span class="p">((</span><span class="n">u_char</span><span class="p">)</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="o">~</span><span class="n">crc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crc</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hysdn_addlog</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;SysReady Token Data invalid CRC&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">len</span><span class="o">--</span><span class="p">;</span>			<span class="cm">/* don&#39;t check CRC byte */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="n">SYSR_TOK_END</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>	<span class="cm">/* End of Token stream */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hysdn_addlog</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;token 0x%x invalid length %d&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SYSR_TOK_B_CHAN</span>:	<span class="cm">/* 1 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* length invalid */</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">bchans</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SYSR_TOK_FAX_CHAN</span>:	<span class="cm">/* 2 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* length invalid */</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">faxchans</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SYSR_TOK_MAC_ADDR</span>:	<span class="cm">/* 3 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">)</span>
				<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* length invalid */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">cp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">hysdn_addlog</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;unknown token 0x%02x length %d&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>		<span class="cm">/* adjust len */</span>
		<span class="n">cp</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* and pointer */</span>
	<span class="p">}</span>

	<span class="n">hysdn_addlog</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;no end token found&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>				<span class="cm">/* EvalSysrTokData */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
