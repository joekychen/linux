<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hisax › hfc_pci.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>hfc_pci.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: hfc_pci.c,v 1.48.2.4 2004/02/11 13:21:33 keil Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * low level driver for CCD&#39;s hfc-pci based cards</span>
<span class="cm"> *</span>
<span class="cm"> * Author       Werner Cornelius</span>
<span class="cm"> *              based on existing driver for CCD hfc ISA cards</span>
<span class="cm"> * Copyright    by Werner Cornelius  &lt;werner@isdn4linux.de&gt;</span>
<span class="cm"> *              by Karsten Keil      &lt;keil@isdn4linux.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> * For changes and modifications please read</span>
<span class="cm"> * Documentation/isdn/HiSax.cert</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &quot;hisax.h&quot;</span>
<span class="cp">#include &quot;hfc_pci.h&quot;</span>
<span class="cp">#include &quot;isdnl1.h&quot;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hfcpci_revision</span> <span class="o">=</span> <span class="s">&quot;$Revision: 1.48.2.4 $&quot;</span><span class="p">;</span>

<span class="cm">/* table entry in the PCI devices list */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">vendor_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">vendor_name</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">card_name</span><span class="p">;</span>
<span class="p">}</span> <span class="n">PCI_ENTRY</span><span class="p">;</span>

<span class="cp">#define NT_T1_COUNT	20	</span><span class="cm">/* number of 3.125ms interrupts for G2 timeout */</span><span class="cp"></span>
<span class="cp">#define CLKDEL_TE	0x0e	</span><span class="cm">/* CLKDEL in TE mode */</span><span class="cp"></span>
<span class="cp">#define CLKDEL_NT	0x6c	</span><span class="cm">/* CLKDEL in NT mode */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="n">PCI_ENTRY</span> <span class="n">id_list</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_2BD0</span><span class="p">,</span> <span class="s">&quot;CCD/Billion/Asuscom&quot;</span><span class="p">,</span> <span class="s">&quot;2BD0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B000</span><span class="p">,</span> <span class="s">&quot;Billion&quot;</span><span class="p">,</span> <span class="s">&quot;B000&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B006</span><span class="p">,</span> <span class="s">&quot;Billion&quot;</span><span class="p">,</span> <span class="s">&quot;B006&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B007</span><span class="p">,</span> <span class="s">&quot;Billion&quot;</span><span class="p">,</span> <span class="s">&quot;B007&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B008</span><span class="p">,</span> <span class="s">&quot;Billion&quot;</span><span class="p">,</span> <span class="s">&quot;B008&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B009</span><span class="p">,</span> <span class="s">&quot;Billion&quot;</span><span class="p">,</span> <span class="s">&quot;B009&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B00A</span><span class="p">,</span> <span class="s">&quot;Billion&quot;</span><span class="p">,</span> <span class="s">&quot;B00A&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B00B</span><span class="p">,</span> <span class="s">&quot;Billion&quot;</span><span class="p">,</span> <span class="s">&quot;B00B&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B00C</span><span class="p">,</span> <span class="s">&quot;Billion&quot;</span><span class="p">,</span> <span class="s">&quot;B00C&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B100</span><span class="p">,</span> <span class="s">&quot;Seyeon&quot;</span><span class="p">,</span> <span class="s">&quot;B100&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B700</span><span class="p">,</span> <span class="s">&quot;Primux II S0&quot;</span><span class="p">,</span> <span class="s">&quot;B700&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B701</span><span class="p">,</span> <span class="s">&quot;Primux II S0 NT&quot;</span><span class="p">,</span> <span class="s">&quot;B701&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_ABOCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ABOCOM_2BD1</span><span class="p">,</span> <span class="s">&quot;Abocom/Magitek&quot;</span><span class="p">,</span> <span class="s">&quot;2BD1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_ASUSTEK</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ASUSTEK_0675</span><span class="p">,</span> <span class="s">&quot;Asuscom/Askey&quot;</span><span class="p">,</span> <span class="s">&quot;675&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_BERKOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_BERKOM_T_CONCEPT</span><span class="p">,</span> <span class="s">&quot;German telekom&quot;</span><span class="p">,</span> <span class="s">&quot;T-Concept&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_BERKOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_BERKOM_A1T</span><span class="p">,</span> <span class="s">&quot;German telekom&quot;</span><span class="p">,</span> <span class="s">&quot;A1T&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_ANIGMA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ANIGMA_MC145575</span><span class="p">,</span> <span class="s">&quot;Motorola MC145575&quot;</span><span class="p">,</span> <span class="s">&quot;MC145575&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_ZOLTRIX</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ZOLTRIX_2BD0</span><span class="p">,</span> <span class="s">&quot;Zoltrix&quot;</span><span class="p">,</span> <span class="s">&quot;2BD0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_DIGI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_DIGI_DF_M_IOM2_E</span><span class="p">,</span> <span class="s">&quot;Digi International&quot;</span><span class="p">,</span> <span class="s">&quot;Digi DataFire Micro V IOM2 (Europe)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_DIGI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_DIGI_DF_M_E</span><span class="p">,</span> <span class="s">&quot;Digi International&quot;</span><span class="p">,</span> <span class="s">&quot;Digi DataFire Micro V (Europe)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_DIGI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_DIGI_DF_M_IOM2_A</span><span class="p">,</span> <span class="s">&quot;Digi International&quot;</span><span class="p">,</span> <span class="s">&quot;Digi DataFire Micro V IOM2 (North America)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_DIGI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_DIGI_DF_M_A</span><span class="p">,</span> <span class="s">&quot;Digi International&quot;</span><span class="p">,</span> <span class="s">&quot;Digi DataFire Micro V (North America)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_SITECOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_SITECOM_DC105V2</span><span class="p">,</span> <span class="s">&quot;Sitecom Europe&quot;</span><span class="p">,</span> <span class="s">&quot;DC-105 ISDN PCI&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
<span class="p">};</span>


<span class="cm">/******************************************/</span>
<span class="cm">/* free hardware resources used by driver */</span>
<span class="cm">/******************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">release_io_hfcpci</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax: release hfcpci at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">pci_io</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>					<span class="cm">/* interrupt output off ! */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_INT_M2</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m2</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_CIRM</span><span class="p">,</span> <span class="n">HFCPCI_RESET</span><span class="p">);</span>			<span class="cm">/* Reset On */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_CIRM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>					<span class="cm">/* Reset Off */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_INT_M2</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m2</span><span class="p">);</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* disable memory mapped ports + busmaster */</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span>
			    <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">pci_io</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/********************************************************************************/</span>
<span class="cm">/* function called to reset the HFC PCI chip. A complete software reset of chip */</span>
<span class="cm">/* and fifos is done.                                                           */</span>
<span class="cm">/********************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">reset_hfcpci</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">PCI_ENA_MEMIO</span><span class="p">);</span>	<span class="cm">/* enable memory mapped ports, disable busmaster */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* interrupt output off ! */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_INT_M2</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m2</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HFC_PCI: resetting card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">PCI_ENA_MEMIO</span> <span class="o">+</span> <span class="n">PCI_ENA_MASTER</span><span class="p">);</span>	<span class="cm">/* enable memory ports + busmaster */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_CIRM</span><span class="p">,</span> <span class="n">HFCPCI_RESET</span><span class="p">);</span>	<span class="cm">/* Reset On */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_CIRM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Reset Off */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFC-PCI init bit busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>	<span class="cm">/* only D fifos enabled */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_FIFO_EN</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span><span class="p">);</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">trm</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">HFCPCI_BTRANS_THRESMASK</span><span class="p">;</span>	<span class="cm">/* no echo connect , threshold */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_TRM</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">trm</span><span class="p">);</span>

	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_CLKDEL</span><span class="p">,</span> <span class="n">CLKDEL_TE</span><span class="p">);</span> <span class="cm">/* ST-Bit delay for TE-Mode */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl_e</span> <span class="o">=</span> <span class="n">HFCPCI_AUTO_AWAKE</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_SCTRL_E</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl_e</span><span class="p">);</span>	<span class="cm">/* S/T Auto awake */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no exchange */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">nt_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* we are in TE mode */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">=</span> <span class="n">HFCPCI_TIM3_125</span> <span class="o">|</span> <span class="n">HFCPCI_AUTO_TIMER</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_CTMT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">ctmt</span><span class="p">);</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">=</span> <span class="n">HFCPCI_INTS_DTRANS</span> <span class="o">|</span> <span class="n">HFCPCI_INTS_DREC</span> <span class="o">|</span>
		<span class="n">HFCPCI_INTS_L1STATE</span> <span class="o">|</span> <span class="n">HFCPCI_INTS_TIMER</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_INT_M1</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>

	<span class="cm">/* Clear already pending ints */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_INT_S1</span><span class="p">));</span>

	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="n">HFCPCI_LOAD_STATE</span> <span class="o">|</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* HFC ST 2 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* HFC ST 2 */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">mst_m</span> <span class="o">=</span> <span class="n">HFCPCI_MASTER</span><span class="p">;</span>	<span class="cm">/* HFC Master Mode */</span>

	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_MST_MODE</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">mst_m</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>	<span class="cm">/* set tx_lo mode, error in datasheet ! */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_SCTRL</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_SCTRL_R</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl_r</span><span class="p">);</span>

	<span class="cm">/* Init GCI/IOM2 in master mode */</span>
	<span class="cm">/* Slots 0 and 1 are set for B-chan 1 and 2 */</span>
	<span class="cm">/* D- and monitor/CI channel are not enabled */</span>
	<span class="cm">/* STIO1 is used as output for data, B1+B2 from ST-&gt;IOM+HFC */</span>
	<span class="cm">/* STIO2 is used as data input, B1+B2 from IOM-&gt;ST */</span>
	<span class="cm">/* ST B-channel send disabled -&gt; continuous 1s */</span>
	<span class="cm">/* The IOM slots are always enabled */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="mh">0x36</span><span class="p">;</span>	<span class="cm">/* set data flow directions */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_CONNECT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">conn</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_B1_SSL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>	<span class="cm">/* B1-Slot 0 STIO1 out enabled */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_B2_SSL</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">);</span>	<span class="cm">/* B2-Slot 1 STIO1 out enabled */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_B1_RSL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>	<span class="cm">/* B1-Slot 0 STIO2 in enabled */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_B2_RSL</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">);</span>	<span class="cm">/* B2-Slot 1 STIO2 in enabled */</span>

	<span class="cm">/* Finally enable IRQ output */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m2</span> <span class="o">=</span> <span class="n">HFCPCI_IRQ_ENABLE</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_INT_M2</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_INT_S1</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/***************************************************/</span>
<span class="cm">/* Timer function called when kernel timer expires */</span>
<span class="cm">/***************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcpci_Timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">75</span><span class="p">;</span>
	<span class="cm">/* WD RESET */</span>
<span class="cm">/*      WriteReg(cs, HFCD_DATA, HFCD_CTMT, cs-&gt;hw.hfcpci.ctmt | 0x80);</span>
<span class="cm">	add_timer(&amp;cs-&gt;hw.hfcpci.timer);</span>
<span class="cm">*/</span>
<span class="p">}</span>


<span class="cm">/*********************************/</span>
<span class="cm">/* schedule a new D-channel task */</span>
<span class="cm">/*********************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sched_event_D_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tqueue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*********************************/</span>
<span class="cm">/* schedule a new b_channel task */</span>
<span class="cm">/*********************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcpci_sched_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tqueue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/************************************************/</span>
<span class="cm">/* select a b-channel entry matching and active */</span>
<span class="cm">/************************************************/</span>
<span class="k">static</span>
<span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span>
<span class="nf">Sel_BCS</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mode</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">channel</span> <span class="o">==</span> <span class="n">channel</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">mode</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">channel</span> <span class="o">==</span> <span class="n">channel</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************/</span>
<span class="cm">/* clear the desired B-channel rx fifo */</span>
<span class="cm">/***************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hfcpci_clear_fifo_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fifo</span><span class="p">)</span>
<span class="p">{</span>       <span class="n">u_char</span> <span class="n">fifo_state</span><span class="p">;</span>
	<span class="n">bzfifo_type</span> <span class="o">*</span><span class="n">bzr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bzr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">fifo_area</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">rxbz_b2</span><span class="p">;</span>
		<span class="n">fifo_state</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">&amp;</span> <span class="n">HFCPCI_FIFOEN_B2RX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bzr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">fifo_area</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">rxbz_b1</span><span class="p">;</span>
		<span class="n">fifo_state</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">&amp;</span> <span class="n">HFCPCI_FIFOEN_B1RX</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo_state</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">^=</span> <span class="n">fifo_state</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_FIFO_EN</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">last_bfifo_cnt</span><span class="p">[</span><span class="n">fifo</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bzr</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">MAX_B_FRAMES</span><span class="p">].</span><span class="n">z1</span> <span class="o">=</span> <span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bzr</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">MAX_B_FRAMES</span><span class="p">].</span><span class="n">z2</span> <span class="o">=</span> <span class="n">bzr</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">MAX_B_FRAMES</span><span class="p">].</span><span class="n">z1</span><span class="p">;</span>
	<span class="n">bzr</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">=</span> <span class="n">MAX_B_FRAMES</span><span class="p">;</span>
	<span class="n">bzr</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">=</span> <span class="n">bzr</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">;</span>	<span class="cm">/* init F pointers to remain constant */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo_state</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">|=</span> <span class="n">fifo_state</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_FIFO_EN</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************/</span>
<span class="cm">/* clear the desired B-channel tx fifo */</span>
<span class="cm">/***************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hfcpci_clear_fifo_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fifo</span><span class="p">)</span>
<span class="p">{</span>       <span class="n">u_char</span> <span class="n">fifo_state</span><span class="p">;</span>
	<span class="n">bzfifo_type</span> <span class="o">*</span><span class="n">bzt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bzt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">fifo_area</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">txbz_b2</span><span class="p">;</span>
		<span class="n">fifo_state</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">&amp;</span> <span class="n">HFCPCI_FIFOEN_B2TX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bzt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">fifo_area</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">txbz_b1</span><span class="p">;</span>
		<span class="n">fifo_state</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">&amp;</span> <span class="n">HFCPCI_FIFOEN_B1TX</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo_state</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">^=</span> <span class="n">fifo_state</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_FIFO_EN</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span><span class="p">);</span>
	<span class="n">bzt</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">MAX_B_FRAMES</span><span class="p">].</span><span class="n">z1</span> <span class="o">=</span> <span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bzt</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">MAX_B_FRAMES</span><span class="p">].</span><span class="n">z2</span> <span class="o">=</span> <span class="n">bzt</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">MAX_B_FRAMES</span><span class="p">].</span><span class="n">z1</span><span class="p">;</span>
	<span class="n">bzt</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">=</span> <span class="n">MAX_B_FRAMES</span><span class="p">;</span>
	<span class="n">bzt</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">=</span> <span class="n">bzt</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">;</span>	<span class="cm">/* init F pointers to remain constant */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo_state</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">|=</span> <span class="n">fifo_state</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_FIFO_EN</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*********************************************/</span>
<span class="cm">/* read a complete B-frame out of the buffer */</span>
<span class="cm">/*********************************************/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span>
<span class="o">*</span>
<span class="nf">hfcpci_empty_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span> <span class="n">bzfifo_type</span> <span class="o">*</span><span class="n">bz</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">bdata</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr1</span><span class="p">,</span> <span class="n">new_f2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">,</span> <span class="n">new_z2</span><span class="p">;</span>
	<span class="n">z_type</span> <span class="o">*</span><span class="n">zp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX_FIFO</span><span class="p">))</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci_empty_fifo&quot;</span><span class="p">);</span>
	<span class="n">zp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">];</span>	<span class="cm">/* point to Z-Regs */</span>
	<span class="n">new_z2</span> <span class="o">=</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>	<span class="cm">/* new position in fifo */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_z2</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span><span class="p">))</span>
		<span class="n">new_z2</span> <span class="o">-=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>	<span class="cm">/* buffer wrap */</span>
	<span class="n">new_f2</span> <span class="o">=</span> <span class="p">(</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX_B_FRAMES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">HSCX_BUFMAX</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">bdata</span> <span class="o">+</span> <span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z1</span> <span class="o">-</span> <span class="n">B_SUB_VAL</span><span class="p">))))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci_empty_fifo: incoming packet invalid length %d or crc&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="cp">#ifdef ERROR_STATISTIC</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">err_inv</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">new_f2</span><span class="p">].</span><span class="n">z2</span> <span class="o">=</span> <span class="n">new_z2</span><span class="p">;</span>
		<span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">=</span> <span class="n">new_f2</span><span class="p">;</span>	<span class="cm">/* next buffer */</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFCPCI: receive out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">total</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span><span class="p">)</span>
			<span class="n">maxlen</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>		<span class="cm">/* complete transfer */</span>
		<span class="k">else</span>
			<span class="n">maxlen</span> <span class="o">=</span> <span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span> <span class="o">-</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">;</span>	<span class="cm">/* maximum */</span>

		<span class="n">ptr1</span> <span class="o">=</span> <span class="n">bdata</span> <span class="o">+</span> <span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span> <span class="o">-</span> <span class="n">B_SUB_VAL</span><span class="p">);</span>	<span class="cm">/* start of data */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ptr1</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">);</span>	<span class="cm">/* copy data */</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">maxlen</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* rest remaining */</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="n">maxlen</span><span class="p">;</span>
			<span class="n">ptr1</span> <span class="o">=</span> <span class="n">bdata</span><span class="p">;</span>	<span class="cm">/* start of buffer */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ptr1</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>	<span class="cm">/* rest */</span>
		<span class="p">}</span>
		<span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">new_f2</span><span class="p">].</span><span class="n">z2</span> <span class="o">=</span> <span class="n">new_z2</span><span class="p">;</span>
		<span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">=</span> <span class="n">new_f2</span><span class="p">;</span>	<span class="cm">/* next buffer */</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*******************************/</span>
<span class="cm">/* D-channel receive procedure */</span>
<span class="cm">/*******************************/</span>
<span class="k">static</span>
<span class="kt">int</span>
<span class="nf">receive_dmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rcnt</span><span class="p">,</span> <span class="n">total</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr1</span><span class="p">;</span>
	<span class="n">dfifo_type</span> <span class="o">*</span><span class="n">df</span><span class="p">;</span>
	<span class="n">z_type</span> <span class="o">*</span><span class="n">zp</span><span class="p">;</span>

	<span class="n">df</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">fifo_area</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">d_chan</span><span class="p">.</span><span class="n">d_rx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;rec_dmsg blocked&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">];</span>
		<span class="n">rcnt</span> <span class="o">=</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">z1</span> <span class="o">-</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rcnt</span> <span class="o">+=</span> <span class="n">D_FIFO_SIZE</span><span class="p">;</span>
		<span class="n">rcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci recd f1(%d) f2(%d) z1(%x) z2(%x) cnt(%d)&quot;</span><span class="p">,</span>
				<span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">,</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">,</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">z1</span><span class="p">,</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">,</span> <span class="n">rcnt</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rcnt</span> <span class="o">&gt;</span> <span class="n">MAX_DFRAME_LEN</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rcnt</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z1</span><span class="p">]))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;empty_fifo hfcpci paket inv. len %d or crc %d&quot;</span><span class="p">,</span> <span class="n">rcnt</span><span class="p">,</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z1</span><span class="p">]);</span>
<span class="cp">#ifdef ERROR_STATISTIC</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">err_rx</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX_D_FRAMES</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">MAX_D_FRAMES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* next buffer */</span>
			<span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">].</span><span class="n">z2</span> <span class="o">=</span> <span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span> <span class="o">+</span> <span class="n">rcnt</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">D_FIFO_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">rcnt</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">total</span> <span class="o">=</span> <span class="n">rcnt</span><span class="p">;</span>
			<span class="n">rcnt</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rcnt</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span> <span class="o">+</span> <span class="n">rcnt</span> <span class="o">&lt;=</span> <span class="n">D_FIFO_SIZE</span><span class="p">)</span>
				<span class="n">maxlen</span> <span class="o">=</span> <span class="n">rcnt</span><span class="p">;</span>	<span class="cm">/* complete transfer */</span>
			<span class="k">else</span>
				<span class="n">maxlen</span> <span class="o">=</span> <span class="n">D_FIFO_SIZE</span> <span class="o">-</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">;</span>	<span class="cm">/* maximum */</span>

			<span class="n">ptr1</span> <span class="o">=</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">;</span>	<span class="cm">/* start of data */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ptr1</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">);</span>	<span class="cm">/* copy data */</span>
			<span class="n">rcnt</span> <span class="o">-=</span> <span class="n">maxlen</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rcnt</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* rest remaining */</span>
				<span class="n">ptr</span> <span class="o">+=</span> <span class="n">maxlen</span><span class="p">;</span>
				<span class="n">ptr1</span> <span class="o">=</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>	<span class="cm">/* start of buffer */</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ptr1</span><span class="p">,</span> <span class="n">rcnt</span><span class="p">);</span>	<span class="cm">/* rest */</span>
			<span class="p">}</span>
			<span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX_D_FRAMES</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">MAX_D_FRAMES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* next buffer */</span>
			<span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">].</span><span class="n">z2</span> <span class="o">=</span> <span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span> <span class="o">+</span> <span class="n">total</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">D_FIFO_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">sched_event_D_pci</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_RCVBUFREADY</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFC-PCI: D receive out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*******************************************************************************/</span>
<span class="cm">/* check for transparent receive data and read max one threshold size if avail */</span>
<span class="cm">/*******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfcpci_empty_fifo_trans</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span> <span class="n">bzfifo_type</span> <span class="o">*</span><span class="n">bz</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">bdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">z1r</span><span class="p">,</span> <span class="o">*</span><span class="n">z2r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_z2</span><span class="p">,</span> <span class="n">fcnt</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr1</span><span class="p">;</span>

	<span class="n">z1r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">MAX_B_FRAMES</span><span class="p">].</span><span class="n">z1</span><span class="p">;</span>		<span class="cm">/* pointer to z reg */</span>
	<span class="n">z2r</span> <span class="o">=</span> <span class="n">z1r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fcnt</span> <span class="o">=</span> <span class="o">*</span><span class="n">z1r</span> <span class="o">-</span> <span class="o">*</span><span class="n">z2r</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>	<span class="cm">/* no data avail */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fcnt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fcnt</span> <span class="o">+=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>	<span class="cm">/* bytes actually buffered */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcnt</span> <span class="o">&gt;</span> <span class="n">HFCPCI_BTRANS_THRESHOLD</span><span class="p">)</span>
		<span class="n">fcnt</span> <span class="o">=</span> <span class="n">HFCPCI_BTRANS_THRESHOLD</span><span class="p">;</span>		<span class="cm">/* limit size */</span>

	<span class="n">new_z2</span> <span class="o">=</span> <span class="o">*</span><span class="n">z2r</span> <span class="o">+</span> <span class="n">fcnt</span><span class="p">;</span>	<span class="cm">/* new position in fifo */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_z2</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span><span class="p">))</span>
		<span class="n">new_z2</span> <span class="o">-=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>	<span class="cm">/* buffer wrap */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">fcnt</span><span class="p">)))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFCPCI: receive out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">fcnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">z2r</span> <span class="o">+</span> <span class="n">fcnt</span> <span class="o">&lt;=</span> <span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span><span class="p">)</span>
			<span class="n">maxlen</span> <span class="o">=</span> <span class="n">fcnt</span><span class="p">;</span>	<span class="cm">/* complete transfer */</span>
		<span class="k">else</span>
			<span class="n">maxlen</span> <span class="o">=</span> <span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span> <span class="o">-</span> <span class="o">*</span><span class="n">z2r</span><span class="p">;</span>	<span class="cm">/* maximum */</span>

		<span class="n">ptr1</span> <span class="o">=</span> <span class="n">bdata</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">z2r</span> <span class="o">-</span> <span class="n">B_SUB_VAL</span><span class="p">);</span>	<span class="cm">/* start of data */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ptr1</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">);</span>	<span class="cm">/* copy data */</span>
		<span class="n">fcnt</span> <span class="o">-=</span> <span class="n">maxlen</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fcnt</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* rest remaining */</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="n">maxlen</span><span class="p">;</span>
			<span class="n">ptr1</span> <span class="o">=</span> <span class="n">bdata</span><span class="p">;</span>	<span class="cm">/* start of buffer */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ptr1</span><span class="p">,</span> <span class="n">fcnt</span><span class="p">);</span>	<span class="cm">/* rest */</span>
		<span class="p">}</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rqueue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">hfcpci_sched_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_RCVBUFREADY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">z2r</span> <span class="o">=</span> <span class="n">new_z2</span><span class="p">;</span>		<span class="cm">/* new position */</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>				<span class="cm">/* hfcpci_empty_fifo_trans */</span>

<span class="cm">/**********************************/</span>
<span class="cm">/* B-channel main receive routine */</span>
<span class="cm">/**********************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">main_rec_hfcpci</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rcnt</span><span class="p">,</span> <span class="n">real_fifo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">receive</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">bzfifo_type</span> <span class="o">*</span><span class="n">bz</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">bdata</span><span class="p">;</span>
	<span class="n">z_type</span> <span class="o">*</span><span class="n">zp</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">((</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">bswapped</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bz</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">fifo_area</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">rxbz_b2</span><span class="p">;</span>
		<span class="n">bdata</span> <span class="o">=</span> <span class="p">((</span><span class="n">fifo_area</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">rxdat_b2</span><span class="p">;</span>
		<span class="n">real_fifo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bz</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">fifo_area</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">rxbz_b1</span><span class="p">;</span>
		<span class="n">bdata</span> <span class="o">=</span> <span class="p">((</span><span class="n">fifo_area</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">rxdat_b1</span><span class="p">;</span>
		<span class="n">real_fifo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">Begin:</span>
	<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;rec_data %d blocked&quot;</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">!=</span> <span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci rec %d f1(%d) f2(%d)&quot;</span><span class="p">,</span>
				<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">,</span> <span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">);</span>
		<span class="n">zp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">];</span>

		<span class="n">rcnt</span> <span class="o">=</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">z1</span> <span class="o">-</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rcnt</span> <span class="o">+=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>
		<span class="n">rcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci rec %d z1(%x) z2(%x) cnt(%d)&quot;</span><span class="p">,</span>
				<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">z1</span><span class="p">,</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">,</span> <span class="n">rcnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">hfcpci_empty_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">bz</span><span class="p">,</span> <span class="n">bdata</span><span class="p">,</span> <span class="n">rcnt</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rqueue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">hfcpci_sched_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_RCVBUFREADY</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rcnt</span> <span class="o">=</span> <span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">-</span> <span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rcnt</span> <span class="o">+=</span> <span class="n">MAX_B_FRAMES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">last_bfifo_cnt</span><span class="p">[</span><span class="n">real_fifo</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rcnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hfcpci_clear_fifo_rx</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">real_fifo</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">last_bfifo_cnt</span><span class="p">[</span><span class="n">real_fifo</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">receive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">receive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">L1_MODE_TRANS</span><span class="p">)</span>
		<span class="n">receive</span> <span class="o">=</span> <span class="n">hfcpci_empty_fifo_trans</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">bz</span><span class="p">,</span> <span class="n">bdata</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">receive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="n">receive</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Begin</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************/</span>
<span class="cm">/* D-channel send routine */</span>
<span class="cm">/**************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcpci_fill_dfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fcnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">new_z1</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">;</span>
	<span class="n">dfifo_type</span> <span class="o">*</span><span class="n">df</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">new_f1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">df</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">fifo_area</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">d_chan</span><span class="p">.</span><span class="n">d_tx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci_fill_Dfifo f1(%d) f2(%d) z1(f1)(%x)&quot;</span><span class="p">,</span>
			<span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">,</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">,</span>
			<span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">].</span><span class="n">z1</span><span class="p">);</span>
	<span class="n">fcnt</span> <span class="o">=</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">-</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">;</span>	<span class="cm">/* frame count actually buffered */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fcnt</span> <span class="o">+=</span> <span class="p">(</span><span class="n">MAX_D_FRAMES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* if wrap around */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcnt</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">MAX_D_FRAMES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci_fill_Dfifo more as 14 frames&quot;</span><span class="p">);</span>
<span class="cp">#ifdef ERROR_STATISTIC</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">err_tx</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* now determine free bytes in FIFO buffer */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">].</span><span class="n">z2</span> <span class="o">-</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">].</span><span class="n">z1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">D_FIFO_SIZE</span><span class="p">;</span>	<span class="cm">/* count now contains available bytes */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci_fill_Dfifo count(%u/%d)&quot;</span><span class="p">,</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci_fill_Dfifo no fifo mem&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>	<span class="cm">/* get frame len */</span>
	<span class="n">new_z1</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">].</span><span class="n">z1</span> <span class="o">+</span> <span class="n">count</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">D_FIFO_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">new_f1</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">D_FREG_MASK</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">src</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>	<span class="cm">/* source pointer */</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">].</span><span class="n">z1</span><span class="p">;</span>
	<span class="n">maxlen</span> <span class="o">=</span> <span class="n">D_FIFO_SIZE</span> <span class="o">-</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">].</span><span class="n">z1</span><span class="p">;</span>		<span class="cm">/* end fifo */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxlen</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
		<span class="n">maxlen</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>	<span class="cm">/* limit size */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">);</span>	<span class="cm">/* first copy */</span>

	<span class="n">count</span> <span class="o">-=</span> <span class="n">maxlen</span><span class="p">;</span>	<span class="cm">/* remaining bytes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>	<span class="cm">/* start of buffer */</span>
		<span class="n">src</span> <span class="o">+=</span> <span class="n">maxlen</span><span class="p">;</span>	<span class="cm">/* new position */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">new_f1</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">].</span><span class="n">z1</span> <span class="o">=</span> <span class="n">new_z1</span><span class="p">;</span>	<span class="cm">/* for next buffer */</span>
	<span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">].</span><span class="n">z1</span> <span class="o">=</span> <span class="n">new_z1</span><span class="p">;</span>	<span class="cm">/* new pos actual buffer */</span>
	<span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">=</span> <span class="n">new_f1</span><span class="p">;</span>	<span class="cm">/* next frame */</span>

	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************/</span>
<span class="cm">/* B-channel send routine */</span>
<span class="cm">/**************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcpci_fill_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxlen</span><span class="p">,</span> <span class="n">fcnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">new_z1</span><span class="p">;</span>
	<span class="n">bzfifo_type</span> <span class="o">*</span><span class="n">bz</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">bdata</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">new_f1</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">z1t</span><span class="p">,</span> <span class="o">*</span><span class="n">z2t</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">bswapped</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bz</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">fifo_area</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">txbz_b2</span><span class="p">;</span>
		<span class="n">bdata</span> <span class="o">=</span> <span class="p">((</span><span class="n">fifo_area</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">txdat_b2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bz</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">fifo_area</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">txbz_b1</span><span class="p">;</span>
		<span class="n">bdata</span> <span class="o">=</span> <span class="p">((</span><span class="n">fifo_area</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">txdat_b1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">L1_MODE_TRANS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">z1t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">MAX_B_FRAMES</span><span class="p">].</span><span class="n">z1</span><span class="p">;</span>
		<span class="n">z2t</span> <span class="o">=</span> <span class="n">z1t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci_fill_fifo_trans %d z1(%x) z2(%x)&quot;</span><span class="p">,</span>
				<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="o">*</span><span class="n">z1t</span><span class="p">,</span> <span class="o">*</span><span class="n">z2t</span><span class="p">);</span>
		<span class="n">fcnt</span> <span class="o">=</span> <span class="o">*</span><span class="n">z2t</span> <span class="o">-</span> <span class="o">*</span><span class="n">z1t</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcnt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fcnt</span> <span class="o">+=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>	<span class="cm">/* fcnt contains available bytes in fifo */</span>
		<span class="n">fcnt</span> <span class="o">=</span> <span class="n">B_FIFO_SIZE</span> <span class="o">-</span> <span class="n">fcnt</span><span class="p">;</span>	<span class="cm">/* remaining bytes to send */</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">fcnt</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HFCPCI_BTRANS_THRESHOLD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">B_FIFO_SIZE</span> <span class="o">-</span> <span class="n">fcnt</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* data is suitable for fifo */</span>
				<span class="n">count</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

				<span class="n">new_z1</span> <span class="o">=</span> <span class="o">*</span><span class="n">z1t</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>	<span class="cm">/* new buffer Position */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">new_z1</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span><span class="p">))</span>
					<span class="n">new_z1</span> <span class="o">-=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>	<span class="cm">/* buffer wrap */</span>
				<span class="n">src</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>	<span class="cm">/* source pointer */</span>
				<span class="n">dst</span> <span class="o">=</span> <span class="n">bdata</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">z1t</span> <span class="o">-</span> <span class="n">B_SUB_VAL</span><span class="p">);</span>
				<span class="n">maxlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span><span class="p">)</span> <span class="o">-</span> <span class="o">*</span><span class="n">z1t</span><span class="p">;</span>	<span class="cm">/* end of fifo */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">maxlen</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
					<span class="n">maxlen</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>		<span class="cm">/* limit size */</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">);</span>	<span class="cm">/* first copy */</span>

				<span class="n">count</span> <span class="o">-=</span> <span class="n">maxlen</span><span class="p">;</span>	<span class="cm">/* remaining bytes */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dst</span> <span class="o">=</span> <span class="n">bdata</span><span class="p">;</span>	<span class="cm">/* start of buffer */</span>
					<span class="n">src</span> <span class="o">+=</span> <span class="n">maxlen</span><span class="p">;</span>	<span class="cm">/* new position */</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">-=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
				<span class="n">fcnt</span> <span class="o">+=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
				<span class="o">*</span><span class="n">z1t</span> <span class="o">=</span> <span class="n">new_z1</span><span class="p">;</span>	<span class="cm">/* now send data */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci_fill_fifo_trans %d frame length %d discarded&quot;</span><span class="p">,</span>
					<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_LLI_L1WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">flag</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">PACKET_NOACK</span> <span class="o">!=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">u_long</span>	<span class="n">flags</span><span class="p">;</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aclock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ackcnt</span> <span class="o">+=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aclock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">schedule_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_ACKPENDING</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>	<span class="cm">/* fetch next data */</span>
		<span class="p">}</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci_fill_fifo_hdlc %d f1(%d) f2(%d) z1(f1)(%x)&quot;</span><span class="p">,</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">,</span> <span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">,</span>
			<span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">].</span><span class="n">z1</span><span class="p">);</span>

	<span class="n">fcnt</span> <span class="o">=</span> <span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">-</span> <span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">;</span>	<span class="cm">/* frame count actually buffered */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fcnt</span> <span class="o">+=</span> <span class="p">(</span><span class="n">MAX_B_FRAMES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* if wrap around */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcnt</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">MAX_B_FRAMES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci_fill_Bfifo more as 14 frames&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* now determine free bytes in FIFO buffer */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">].</span><span class="n">z2</span> <span class="o">-</span> <span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">].</span><span class="n">z1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>	<span class="cm">/* count now contains available bytes */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci_fill_fifo %d count(%u/%d),%lx&quot;</span><span class="p">,</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			<span class="n">count</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci_fill_fifo no fifo mem&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>	<span class="cm">/* get frame len */</span>
	<span class="n">new_z1</span> <span class="o">=</span> <span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">].</span><span class="n">z1</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>	<span class="cm">/* new buffer Position */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_z1</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span><span class="p">))</span>
		<span class="n">new_z1</span> <span class="o">-=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>	<span class="cm">/* buffer wrap */</span>

	<span class="n">new_f1</span> <span class="o">=</span> <span class="p">((</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX_B_FRAMES</span><span class="p">);</span>
	<span class="n">src</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>	<span class="cm">/* source pointer */</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="n">bdata</span> <span class="o">+</span> <span class="p">(</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">].</span><span class="n">z1</span> <span class="o">-</span> <span class="n">B_SUB_VAL</span><span class="p">);</span>
	<span class="n">maxlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span><span class="p">)</span> <span class="o">-</span> <span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">].</span><span class="n">z1</span><span class="p">;</span>		<span class="cm">/* end fifo */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxlen</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
		<span class="n">maxlen</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>	<span class="cm">/* limit size */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">);</span>	<span class="cm">/* first copy */</span>

	<span class="n">count</span> <span class="o">-=</span> <span class="n">maxlen</span><span class="p">;</span>	<span class="cm">/* remaining bytes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">bdata</span><span class="p">;</span>	<span class="cm">/* start of buffer */</span>
		<span class="n">src</span> <span class="o">+=</span> <span class="n">maxlen</span><span class="p">;</span>	<span class="cm">/* new position */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">-=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_LLI_L1WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">flag</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">PACKET_NOACK</span> <span class="o">!=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u_long</span>	<span class="n">flags</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aclock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ackcnt</span> <span class="o">+=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aclock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">schedule_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_ACKPENDING</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">new_f1</span><span class="p">].</span><span class="n">z1</span> <span class="o">=</span> <span class="n">new_z1</span><span class="p">;</span>	<span class="cm">/* for next buffer */</span>
	<span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">=</span> <span class="n">new_f1</span><span class="p">;</span>	<span class="cm">/* next frame */</span>

	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**********************************************/</span>
<span class="cm">/* D-channel l1 state call for leased NT-mode */</span>
<span class="cm">/**********************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dch_nt_l2l1</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="p">)</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1hw</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_ACTIVATE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_ACTIVATE</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_TESTLOOP</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">arg</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;PH_TEST_LOOP B1&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">arg</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;PH_TEST_LOOP B2&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="mi">3</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;PH_TEST_LOOP DISABLED&quot;</span><span class="p">);</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1hw</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">HW_TESTLOOP</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;dch_nt_l2l1 msg %04X unhandled&quot;</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="cm">/***********************/</span>
<span class="cm">/* set/reset echo mode */</span>
<span class="cm">/***********************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfcpci_auxcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">isdn_ctrl</span> <span class="o">*</span><span class="n">ic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">==</span> <span class="mi">98</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HFCPCI_INTS_B2TRANS</span> <span class="o">+</span> <span class="n">HFCPCI_INTS_B2REC</span> <span class="o">+</span> <span class="n">HFCPCI_INTS_B1TRANS</span> <span class="o">+</span> <span class="n">HFCPCI_INTS_B1REC</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_CLKDEL</span><span class="p">,</span> <span class="n">CLKDEL_NT</span><span class="p">);</span> <span class="cm">/* ST-Bit delay for NT-Mode */</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="n">HFCPCI_LOAD_STATE</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* HFC ST G0 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">SCTRL_MODE_NT</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_SCTRL</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl</span><span class="p">);</span>	<span class="cm">/* set NT-mode */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="n">HFCPCI_LOAD_STATE</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* HFC ST G1 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">HFCPCI_ACTIVATE</span> <span class="o">|</span> <span class="n">HFCPCI_DO_ACTION</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">ph_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">nt_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">stlist</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2l1</span> <span class="o">=</span> <span class="n">dch_nt_l2l1</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;NT mode activated&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">chanlimit</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">bswapped</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">nt_mode</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">!=</span> <span class="mi">12</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">logecho</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">trm</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>	<span class="cm">/* enable echo chan */</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="n">HFCPCI_INTS_B2REC</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">|=</span> <span class="n">HFCPCI_FIFOEN_B2RX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">logecho</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">trm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">;</span>	<span class="cm">/* disable echo chan */</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_INTS_B2REC</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_FIFOEN_B2RX</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">conn</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>	<span class="cm">/* B2-IOM -&gt; B2-ST */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_CTMT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">ctmt</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_SCTRL_R</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl_r</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_SCTRL</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_CONNECT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">conn</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_TRM</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">trm</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_FIFO_EN</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_INT_M1</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>				<span class="cm">/* hfcpci_auxcmd */</span>

<span class="cm">/*****************************/</span>
<span class="cm">/* E-channel receive routine */</span>
<span class="cm">/*****************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">receive_emsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rcnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">receive</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">bzfifo_type</span> <span class="o">*</span><span class="n">bz</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">bdata</span><span class="p">;</span>
	<span class="n">z_type</span> <span class="o">*</span><span class="n">zp</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr1</span><span class="p">,</span> <span class="n">new_f2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">,</span> <span class="n">new_z2</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">e_buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

	<span class="n">bz</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">fifo_area</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">rxbz_b2</span><span class="p">;</span>
	<span class="n">bdata</span> <span class="o">=</span> <span class="p">((</span><span class="n">fifo_area</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">rxdat_b2</span><span class="p">;</span>
<span class="nl">Begin:</span>
	<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;echo_rec_data blocked&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">!=</span> <span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci e_rec f1(%d) f2(%d)&quot;</span><span class="p">,</span>
				<span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">,</span> <span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">);</span>
		<span class="n">zp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">];</span>

		<span class="n">rcnt</span> <span class="o">=</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">z1</span> <span class="o">-</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rcnt</span> <span class="o">+=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>
		<span class="n">rcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci e_rec z1(%x) z2(%x) cnt(%d)&quot;</span><span class="p">,</span>
				<span class="n">zp</span><span class="o">-&gt;</span><span class="n">z1</span><span class="p">,</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">,</span> <span class="n">rcnt</span><span class="p">);</span>
		<span class="n">new_z2</span> <span class="o">=</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span> <span class="o">+</span> <span class="n">rcnt</span><span class="p">;</span>		<span class="cm">/* new position in fifo */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_z2</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span><span class="p">))</span>
			<span class="n">new_z2</span> <span class="o">-=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>	<span class="cm">/* buffer wrap */</span>
		<span class="n">new_f2</span> <span class="o">=</span> <span class="p">(</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX_B_FRAMES</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rcnt</span> <span class="o">&gt;</span> <span class="mi">256</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">bdata</span> <span class="o">+</span> <span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z1</span> <span class="o">-</span> <span class="n">B_SUB_VAL</span><span class="p">))))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci_empty_echan: incoming packet invalid length %d or crc&quot;</span><span class="p">,</span> <span class="n">rcnt</span><span class="p">);</span>
			<span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">new_f2</span><span class="p">].</span><span class="n">z2</span> <span class="o">=</span> <span class="n">new_z2</span><span class="p">;</span>
			<span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">=</span> <span class="n">new_f2</span><span class="p">;</span>	<span class="cm">/* next buffer */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">total</span> <span class="o">=</span> <span class="n">rcnt</span><span class="p">;</span>
			<span class="n">rcnt</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">e_buffer</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span> <span class="o">&lt;=</span> <span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span><span class="p">)</span>
				<span class="n">maxlen</span> <span class="o">=</span> <span class="n">rcnt</span><span class="p">;</span>	<span class="cm">/* complete transfer */</span>
			<span class="k">else</span>
				<span class="n">maxlen</span> <span class="o">=</span> <span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span> <span class="o">-</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">;</span>	<span class="cm">/* maximum */</span>

			<span class="n">ptr1</span> <span class="o">=</span> <span class="n">bdata</span> <span class="o">+</span> <span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span> <span class="o">-</span> <span class="n">B_SUB_VAL</span><span class="p">);</span>	<span class="cm">/* start of data */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ptr1</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">);</span>	<span class="cm">/* copy data */</span>
			<span class="n">rcnt</span> <span class="o">-=</span> <span class="n">maxlen</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rcnt</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* rest remaining */</span>
				<span class="n">ptr</span> <span class="o">+=</span> <span class="n">maxlen</span><span class="p">;</span>
				<span class="n">ptr1</span> <span class="o">=</span> <span class="n">bdata</span><span class="p">;</span>	<span class="cm">/* start of buffer */</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ptr1</span><span class="p">,</span> <span class="n">rcnt</span><span class="p">);</span>	<span class="cm">/* rest */</span>
			<span class="p">}</span>
			<span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">new_f2</span><span class="p">].</span><span class="n">z2</span> <span class="o">=</span> <span class="n">new_z2</span><span class="p">;</span>
			<span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">=</span> <span class="n">new_f2</span><span class="p">;</span>	<span class="cm">/* next buffer */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_HEX</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dlog</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">total</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MAX_DLOG_SPACE</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;E&#39;</span><span class="p">;</span>
					<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;C&#39;</span><span class="p">;</span>
					<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;H&#39;</span><span class="p">;</span>
					<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;O&#39;</span><span class="p">;</span>
					<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
					<span class="n">ptr</span> <span class="o">+=</span> <span class="n">QuickHex</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">e_buffer</span><span class="p">,</span> <span class="n">total</span> <span class="o">-</span> <span class="mi">3</span><span class="p">);</span>
					<span class="n">ptr</span><span class="o">--</span><span class="p">;</span>
					<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
					<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">HiSax_putstatus</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dlog</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">HiSax_putstatus</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;LogEcho: &quot;</span><span class="p">,</span> <span class="s">&quot;warning Frame too big (%d)&quot;</span><span class="p">,</span> <span class="n">total</span> <span class="o">-</span> <span class="mi">3</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">rcnt</span> <span class="o">=</span> <span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">-</span> <span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rcnt</span> <span class="o">+=</span> <span class="n">MAX_B_FRAMES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">receive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">receive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">receive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="n">receive</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Begin</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* receive_emsg */</span>

<span class="cm">/*********************/</span>
<span class="cm">/* Interrupt handler */</span>
<span class="cm">/*********************/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">hfcpci_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">intno</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">exval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">val</span><span class="p">,</span> <span class="n">stat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m2</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;HFC-PCI: int_m2 %x not initialised&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m2</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>	<span class="cm">/* not initialised */</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HFCPCI_ANYINT</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">stat</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_STATUS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_INT_S1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;HFC-PCI: stat(%02x) s1(%02x)&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;HFC-PCI irq %x %s&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>
			<span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">)</span> <span class="o">?</span>
			<span class="s">&quot;locked&quot;</span> <span class="o">:</span> <span class="s">&quot;unlocked&quot;</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* state machine irq */</span>
		<span class="n">exval</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;ph_state chg %d-&gt;%d&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">ph_state</span><span class="p">,</span>
				<span class="n">exval</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">ph_state</span> <span class="o">=</span> <span class="n">exval</span><span class="p">;</span>
		<span class="n">sched_event_D_pci</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_L1STATECHANGE</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* timer irq */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">nt_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">--</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">nt_timer</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">sched_event_D_pci</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_L1STATECHANGE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_CTMT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">|</span> <span class="n">HFCPCI_CLTIMER</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_s1</span> <span class="o">|=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_s1</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">exval</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_s1</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_s1</span> <span class="o">=</span> <span class="n">exval</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">Sel_BCS</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">)</span>
					<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci spurious 0x08 IRQ&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">main_rec_hfcpci</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">logecho</span><span class="p">)</span>
				<span class="n">receive_emsg</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">Sel_BCS</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">)</span>
					<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci spurious 0x10 IRQ&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">main_rec_hfcpci</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">Sel_BCS</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">)</span>
					<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci spurious 0x01 IRQ&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">hfcpci_fill_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
						<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;fill_data %d blocked&quot;</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">)))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
							<span class="n">hfcpci_fill_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
							<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
						<span class="p">}</span> <span class="k">else</span>
							<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;fill_data %d blocked&quot;</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">hfcpci_sched_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_XMTBUFREADY</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">Sel_BCS</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">)</span>
					<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci spurious 0x02 IRQ&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">hfcpci_fill_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
						<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;fill_data %d blocked&quot;</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">)))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
							<span class="n">hfcpci_fill_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
							<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
						<span class="p">}</span> <span class="k">else</span>
							<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;fill_data %d blocked&quot;</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">hfcpci_sched_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_XMTBUFREADY</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* receive dframe */</span>
			<span class="n">receive_dmsg</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* dframe transmitted */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_DBUSY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
				<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L1_DBUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
				<span class="n">sched_event_D_pci</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_CLEARBUSY</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">hfcpci_fill_dfifo</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
						<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci_fill_dfifo irq blocked&quot;</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">goto</span> <span class="n">afterXPR</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
					<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">hfcpci_fill_dfifo</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
					<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci_fill_dfifo irq blocked&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">sched_event_D_pci</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_XMTBUFREADY</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="nl">afterXPR:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_s1</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_s1</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_s1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;HFC-PCI irq %x loop %d&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">15</span> <span class="o">-</span> <span class="n">count</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********************************************************************/</span>
<span class="cm">/* timer callback for D-chan busy resolution. Currently no function */</span>
<span class="cm">/********************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcpci_dbusy_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*************************************/</span>
<span class="cm">/* Layer 1 D-channel hardware access */</span>
<span class="cm">/*************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">HFCPCI_l1hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="p">)</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_HEX</span><span class="p">)</span>
			<span class="n">LogFrame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_VERBOSE</span><span class="p">)</span>
			<span class="n">dlogframe</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="cp">#ifdef L2FRAME_DEBUG		</span><span class="cm">/* psa */</span><span class="cp"></span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_LAPD</span><span class="p">)</span>
				<span class="n">Logl2Frame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="s">&quot;PH_DATA Queued&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef L2FRAME_DEBUG		</span><span class="cm">/* psa */</span><span class="cp"></span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_LAPD</span><span class="p">)</span>
				<span class="n">Logl2Frame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="s">&quot;PH_DATA&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">hfcpci_fill_dfifo</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
				<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci_fill_dfifo blocked&quot;</span><span class="p">);</span>

		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot; l2l1 tx_skb exist this shouldn&#39;t happen&quot;</span><span class="p">);</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_HEX</span><span class="p">)</span>
			<span class="n">LogFrame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_VERBOSE</span><span class="p">)</span>
			<span class="n">dlogframe</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef L2FRAME_DEBUG		</span><span class="cm">/* psa */</span><span class="cp"></span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_LAPD</span><span class="p">)</span>
			<span class="n">Logl2Frame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="s">&quot;PH_DATA_PULLED&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hfcpci_fill_dfifo</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci_fill_dfifo blocked&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
<span class="cp">#ifdef L2FRAME_DEBUG		</span><span class="cm">/* psa */</span><span class="cp"></span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_LAPD</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;-&gt; PH_REQUEST_PULL&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L1_PULL_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_L1_PULL_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">HW_RESET</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="n">HFCPCI_LOAD_STATE</span> <span class="o">|</span> <span class="mi">3</span><span class="p">);</span>	<span class="cm">/* HFC ST 3 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>	<span class="cm">/* HFC ST 2 */</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">mst_m</span> <span class="o">|=</span> <span class="n">HFCPCI_MASTER</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_MST_MODE</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">mst_m</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="n">HFCPCI_ACTIVATE</span> <span class="o">|</span> <span class="n">HFCPCI_DO_ACTION</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_POWERUP</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">HW_ENABLE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="n">HFCPCI_DO_ACTION</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">HW_DEACTIVATE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">mst_m</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_MASTER</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_MST_MODE</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">mst_m</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">HW_INFO3</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">mst_m</span> <span class="o">|=</span> <span class="n">HFCPCI_MASTER</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_MST_MODE</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">mst_m</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">HW_TESTLOOP</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>:
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_B1_SSL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>	<span class="cm">/* tx slot */</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_B1_RSL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>	<span class="cm">/* rx slot */</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_CONNECT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">conn</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>:
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_B2_SSL</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">);</span>	<span class="cm">/* tx slot */</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_B2_RSL</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">);</span>	<span class="cm">/* rx slot */</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x38</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_CONNECT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">conn</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci_l1hw loop invalid %4lx&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">trm</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>	<span class="cm">/* enable IOM-loop */</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_TRM</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">trm</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcpci_l1hw unknown pr %4x&quot;</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/***********************************************/</span>
<span class="cm">/* called during init setting l1 stack pointer */</span>
<span class="cm">/***********************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">setstack_hfcpci</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1hw</span> <span class="o">=</span> <span class="n">HFCPCI_l1hw</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************/</span>
<span class="cm">/* send B-channel data if not blocked */</span>
<span class="cm">/**************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcpci_send_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hfcpci_fill_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;send_data %d blocked&quot;</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************/</span>
<span class="cm">/* activate/deactivate hardware for selected channels and mode */</span>
<span class="cm">/***************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mode_hfcpci</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fifo2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;HFCPCI bchannel mode %d bchan %d/%d&quot;</span><span class="p">,</span>
			<span class="n">mode</span><span class="p">,</span> <span class="n">bc</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">bc</span><span class="p">;</span>
	<span class="n">fifo2</span> <span class="o">=</span> <span class="n">bc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">chanlimit</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* B1 and B2 normal mode */</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl_e</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">L1_MODE_NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* B1 and B2 exchanged */</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl_e</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* B1 and B2 normal mode */</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl_e</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">fifo2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* B1 and B2 normal mode */</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl_e</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">L1_MODE_NULL</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fifo2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_FIFOEN_B2</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HFCPCI_INTS_B2TRANS</span> <span class="o">+</span> <span class="n">HFCPCI_INTS_B2REC</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_FIFOEN_B1</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HFCPCI_INTS_B1TRANS</span> <span class="o">+</span> <span class="n">HFCPCI_INTS_B1REC</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">L1_MODE_TRANS</span><span class="p">)</span>:
		<span class="n">hfcpci_clear_fifo_rx</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">fifo2</span><span class="p">);</span>
		<span class="n">hfcpci_clear_fifo_tx</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">fifo2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">|=</span> <span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">|=</span> <span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fifo2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">|=</span> <span class="n">HFCPCI_FIFOEN_B2</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HFCPCI_INTS_B2TRANS</span> <span class="o">+</span> <span class="n">HFCPCI_INTS_B2REC</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x18</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">|=</span> <span class="n">HFCPCI_FIFOEN_B1</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HFCPCI_INTS_B1TRANS</span> <span class="o">+</span> <span class="n">HFCPCI_INTS_B1REC</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">L1_MODE_HDLC</span><span class="p">)</span>:
		<span class="n">hfcpci_clear_fifo_rx</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">fifo2</span><span class="p">);</span>
		<span class="n">hfcpci_clear_fifo_tx</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">fifo2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">|=</span> <span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">|=</span> <span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fifo2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">last_bfifo_cnt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">|=</span> <span class="n">HFCPCI_FIFOEN_B2</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HFCPCI_INTS_B2TRANS</span> <span class="o">+</span> <span class="n">HFCPCI_INTS_B2REC</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">2</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x18</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">last_bfifo_cnt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">|=</span> <span class="n">HFCPCI_FIFOEN_B1</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HFCPCI_INTS_B1TRANS</span> <span class="o">+</span> <span class="n">HFCPCI_INTS_B1REC</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">L1_MODE_EXTRN</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">conn</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">|=</span> <span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_FIFOEN_B2</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HFCPCI_INTS_B2TRANS</span> <span class="o">+</span> <span class="n">HFCPCI_INTS_B2REC</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">conn</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">|=</span> <span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_FIFOEN_B1</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HFCPCI_INTS_B1TRANS</span> <span class="o">+</span> <span class="n">HFCPCI_INTS_B1REC</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_SCTRL_E</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl_e</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_INT_M1</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_FIFO_EN</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo_en</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_SCTRL</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_SCTRL_R</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">sctrl_r</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_CTMT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">ctmt</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_CONNECT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">conn</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************/</span>
<span class="cm">/* Layer2 -&gt; Layer 1 Transfer */</span>
<span class="cm">/******************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcpci_l2l1</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BCState</span>	<span class="o">*</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bcs</span><span class="p">;</span>
	<span class="n">u_long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><pre><code>        test_and_set_bit(BC_FLG_BUSY, &amp;bcs-&gt;Flag);
</code></pre></td><td class="code"><div class="highlight"><pre>			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Send_Data</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;hfc_l2l1: this shouldn&#39;t happen</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><pre><code>    test_and_set_bit(BC_FLG_BUSY, &amp;bcs-&gt;Flag);
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Send_Data</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L1_PULL_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_L1_PULL_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_ACTIVATE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">BC_FLG_ACTIV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="n">mode_hfcpci</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bc</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">l1_msg_b</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">l1_msg_b</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_ACTIV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="n">mode_hfcpci</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bc</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/******************************************/</span>
<span class="cm">/* deactivate B-channel access and queues */</span>
<span class="cm">/******************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">close_hfcpci</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mode_hfcpci</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rqueue</span><span class="p">);</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*************************************/</span>
<span class="cm">/* init B-channel queues and control */</span>
<span class="cm">/*************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">open_hfcpcistate</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">BC_FLG_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rqueue</span><span class="p">);</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*********************************/</span>
<span class="cm">/* inits the stack for B-channel */</span>
<span class="cm">/*********************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">setstack_2b</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">open_hfcpcistate</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">,</span> <span class="n">bcs</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">bcs</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2l1</span> <span class="o">=</span> <span class="n">hfcpci_l2l1</span><span class="p">;</span>
	<span class="n">setstack_manager</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="p">;</span>
	<span class="n">setstack_l1_B</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************/</span>
<span class="cm">/* handle L1 state changes */</span>
<span class="cm">/***************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcpci_bh</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">IsdnCardState</span><span class="p">,</span> <span class="n">tqueue</span><span class="p">);</span>
	<span class="n">u_long</span>	<span class="n">flags</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><pre><code> struct PStack *stptr;
</code></pre></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">D_L1STATECHANGE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">nt_mode</span><span class="p">)</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">ph_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
				<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_RESET</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>:
				<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_DEACTIVATE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">8</span><span class="p">)</span>:
				<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_RSYNC</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span>:
				<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_INFO2</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">7</span><span class="p">)</span>:
				<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_INFO4_P8</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">ph_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">nt_timer</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_INTS_TIMER</span><span class="p">;</span>
					<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_INT_M1</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
					<span class="cm">/* Clear already pending ints */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_INT_S1</span><span class="p">));</span>
					<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">HFCPCI_LOAD_STATE</span><span class="p">);</span>
					<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
					<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
					<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">ph_state</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="n">HFCPCI_INTS_TIMER</span><span class="p">;</span>
					<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_INT_M1</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
					<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_AUTO_TIMER</span><span class="p">;</span>
					<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">|=</span> <span class="n">HFCPCI_TIM3_125</span><span class="p">;</span>
					<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_CTMT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">|</span> <span class="n">HFCPCI_CLTIMER</span><span class="p">);</span>
					<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_CTMT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">|</span> <span class="n">HFCPCI_CLTIMER</span><span class="p">);</span>
					<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="n">NT_T1_COUNT</span><span class="p">;</span>
					<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">HFCPCI_NT_G2_G3</span><span class="p">);</span>	<span class="cm">/* allow G2 -&gt; G3 transition */</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>:
			<span class="k">case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>:
			<span class="k">case</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>:
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_INTS_TIMER</span><span class="p">;</span>
				<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_INT_M1</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">D_RCVBUFREADY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">))</span>
		<span class="n">DChannel_proc_rcv</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">D_XMTBUFREADY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">))</span>
		<span class="n">DChannel_proc_xmt</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/********************************/</span>
<span class="cm">/* called for card init message */</span>
<span class="cm">/********************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">inithfcpci</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">BC_SetStack</span> <span class="o">=</span> <span class="n">setstack_2b</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">BC_SetStack</span> <span class="o">=</span> <span class="n">setstack_2b</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">BC_Close</span> <span class="o">=</span> <span class="n">close_hfcpci</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">BC_Close</span> <span class="o">=</span> <span class="n">close_hfcpci</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hfcpci_dbusy_timer</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">cs</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">);</span>
	<span class="n">mode_hfcpci</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mode_hfcpci</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/*******************************************/</span>
<span class="cm">/* handle card messages from control layer */</span>
<span class="cm">/*******************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfcpci_card_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;HFCPCI: card_msg %x&quot;</span><span class="p">,</span> <span class="n">mt</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CARD_RESET</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">reset_hfcpci</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CARD_RELEASE</span>:
		<span class="n">release_io_hfcpci</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CARD_INIT</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">inithfcpci</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">reset_hfcpci</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>				<span class="cm">/* Timeout 80ms */</span>
		<span class="cm">/* now switch timer interrupt off */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_INTS_TIMER</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_INT_M1</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
		<span class="cm">/* reinit mode reg */</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_MST_MODE</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">mst_m</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CARD_TEST</span>:
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* this variable is used as card index when more than one cards are present */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev_hfcpci</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">setup_hfcpci</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">tmp_hfcpci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#ifdef __BIG_ENDIAN</span>
<span class="cp">#error &quot;not running on big endian machines now&quot;</span>
<span class="cp">#endif</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">hfcpci_revision</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax: HFC-PCI driver Rev. %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HiSax_getrev</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_s1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">ph_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifo</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">typ</span> <span class="o">!=</span> <span class="n">ISDN_CTYPE_HFC_PCI</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">id_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp_hfcpci</span> <span class="o">=</span> <span class="n">hisax_find_pci_device</span><span class="p">(</span><span class="n">id_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor_id</span><span class="p">,</span>
						   <span class="n">id_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">device_id</span><span class="p">,</span>
						   <span class="n">dev_hfcpci</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_hfcpci</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_addr_t</span>	<span class="n">dma_mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x7fffUL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">tmp_hfcpci</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">tmp_hfcpci</span><span class="p">,</span> <span class="n">dma_mask</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				       <span class="s">&quot;HiSax hfc_pci: No suitable DMA available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">tmp_hfcpci</span><span class="p">,</span> <span class="n">dma_mask</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				       <span class="s">&quot;HiSax hfc_pci: No suitable consistent DMA available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pci_set_master</span><span class="p">(</span><span class="n">tmp_hfcpci</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="n">tmp_hfcpci</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_IO_MASK</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_hfcpci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFC-PCI: No PCI card found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i</span><span class="o">--</span><span class="p">;</span>
	<span class="n">dev_hfcpci</span> <span class="o">=</span> <span class="n">tmp_hfcpci</span><span class="p">;</span>	<span class="cm">/* old device */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_hfcpci</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">dev_hfcpci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFC-PCI: No IRQ for PCI card found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">pci_io</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev_hfcpci</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax: HFC-PCI card manufacturer: %s card name: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor_name</span><span class="p">,</span> <span class="n">id_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">card_name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">pci_io</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFC-PCI: No IO-Mem for PCI card found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate memory for FIFOS */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
						   <span class="mh">0x8000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFC-PCI: Error allocating FIFO memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">dma</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;HFC-PCI: Error DMA memory not on 32K boundary (%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span>
				    <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">pci_io</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">pci_io</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;HFC-PCI: defined at mem %p fifo %p(%lx) IRQ %d HZ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">pci_io</span><span class="p">,</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">fifos</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">PCI_ENA_MEMIO</span><span class="p">);</span>	<span class="cm">/* enable memory mapped ports, disable busmaster */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* disable alle interrupts */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_INT_M1</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCPCI_INT_M2</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">int_m2</span><span class="p">);</span>
	<span class="cm">/* At this point the needed PCI config is done */</span>
	<span class="cm">/* fifos are still not enabled */</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tqueue</span><span class="p">,</span>  <span class="n">hfcpci_bh</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">setstack_d</span> <span class="o">=</span> <span class="n">setstack_hfcpci</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Send_Data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hfcpci_send_data</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisac</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisacfifo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisacfifo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Read_Reg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hfcpci_interrupt</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq_flags</span> <span class="o">|=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hfcpci_Timer</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">cs</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcpci</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hfcpci_card_msg</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">auxcmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hfcpci_auxcmd</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
