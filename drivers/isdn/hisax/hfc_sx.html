<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hisax › hfc_sx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>hfc_sx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: hfc_sx.c,v 1.12.2.5 2004/02/11 13:21:33 keil Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * level driver for Cologne Chip Designs hfc-s+/sp based cards</span>
<span class="cm"> *</span>
<span class="cm"> * Author       Werner Cornelius</span>
<span class="cm"> *              based on existing driver for CCD HFC PCI cards</span>
<span class="cm"> * Copyright    by Werner Cornelius  &lt;werner@isdn4linux.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &quot;hisax.h&quot;</span>
<span class="cp">#include &quot;hfc_sx.h&quot;</span>
<span class="cp">#include &quot;isdnl1.h&quot;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/isapnp.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hfcsx_revision</span> <span class="o">=</span> <span class="s">&quot;$Revision: 1.12.2.5 $&quot;</span><span class="p">;</span>

<span class="cm">/***************************************/</span>
<span class="cm">/* IRQ-table for CCDs demo board       */</span>
<span class="cm">/* IRQs 6,5,10,11,12,15 are supported  */</span>
<span class="cm">/***************************************/</span>

<span class="cm">/* Teles 16.3c Vendor Id TAG2620, Version 1.0, Vendor version 2.1</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to Uwe Wisniewski</span>
<span class="cm"> *</span>
<span class="cm"> * ISA-SLOT  Signal      PIN</span>
<span class="cm"> * B25        IRQ3     92 IRQ_G</span>
<span class="cm"> * B23        IRQ5     94 IRQ_A</span>
<span class="cm"> * B4         IRQ2/9   95 IRQ_B</span>
<span class="cm"> * D3         IRQ10    96 IRQ_C</span>
<span class="cm"> * D4         IRQ11    97 IRQ_D</span>
<span class="cm"> * D5         IRQ12    98 IRQ_E</span>
<span class="cm"> * D6         IRQ15    99 IRQ_F</span>
<span class="cm"> */</span>

<span class="cp">#undef CCD_DEMO_BOARD</span>
<span class="cp">#ifdef CCD_DEMO_BOARD</span>
<span class="k">static</span> <span class="n">u_char</span> <span class="n">ccd_sp_irqtab</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span>
<span class="p">};</span>
<span class="cp">#else </span><span class="cm">/* Teles 16.3c */</span><span class="cp"></span>
<span class="k">static</span> <span class="n">u_char</span> <span class="n">ccd_sp_irqtab</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span>
<span class="p">};</span>
<span class="cp">#endif</span>
<span class="cp">#define NT_T1_COUNT 20		</span><span class="cm">/* number of 3.125ms interrupts for G2 timeout */</span><span class="cp"></span>

<span class="cp">#define byteout(addr, val) outb(val, addr)</span>
<span class="cp">#define bytein(addr) inb(addr)</span>

<span class="cm">/******************************/</span>
<span class="cm">/* In/Out access to registers */</span>
<span class="cm">/******************************/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">Write_hfc</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">regnum</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">regnum</span><span class="p">);</span>
	<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u_char</span>
<span class="nf">Read_hfc</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">regnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">regnum</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">bytein</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**************************************************/</span>
<span class="cm">/* select a fifo and remember which one for reuse */</span>
<span class="cm">/**************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fifo_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">==</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">last_fifo</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* still valid */</span>

	<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">HFCSX_FIF_SEL</span><span class="p">);</span>
	<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bytein</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* wait for busy */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bytein</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* wait for busy */</span>
<span class="p">}</span>

<span class="cm">/******************************************/</span>
<span class="cm">/* reset the specified fifo to defaults.  */</span>
<span class="cm">/* If its a send fifo init needed markers */</span>
<span class="cm">/******************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">reset_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fifo_select</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span> <span class="cm">/* first select the fifo */</span>
	<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">HFCSX_CIRM</span><span class="p">);</span>
	<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">cirm</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span> <span class="cm">/* reset cmd */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bytein</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* wait for busy */</span>
<span class="p">}</span>


<span class="cm">/*************************************************************/</span>
<span class="cm">/* write_fifo writes the skb contents to the desired fifo    */</span>
<span class="cm">/* if no space is available or an error occurs 0 is returned */</span>
<span class="cm">/* the skb is not released in any way.                       */</span>
<span class="cm">/*************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">write_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">fifo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">trans_max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">msp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fifo_size</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">f_msk</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* no write fifo */</span>

	<span class="n">fifo_select</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fifo_size</span> <span class="o">=</span> <span class="n">D_FIFO_SIZE</span><span class="p">;</span> <span class="cm">/* D-channel */</span>
		<span class="n">f_msk</span> <span class="o">=</span> <span class="n">MAX_D_FRAMES</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trans_max</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* only HDLC */</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">fifo_size</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">b_fifo_size</span><span class="p">;</span> <span class="cm">/* B-channel */</span>
		<span class="n">f_msk</span> <span class="o">=</span> <span class="n">MAX_B_FRAMES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">z1</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_Z1H</span><span class="p">);</span>
	<span class="n">z1</span> <span class="o">=</span> <span class="p">((</span><span class="n">z1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_Z1L</span><span class="p">));</span>

	<span class="cm">/* Check for transparent mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trans_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">z2</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_Z2H</span><span class="p">);</span>
		<span class="n">z2</span> <span class="o">=</span> <span class="p">((</span><span class="n">z2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_Z2L</span><span class="p">));</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">z2</span> <span class="o">-</span> <span class="n">z1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="n">fifo_size</span><span class="p">;</span> <span class="cm">/* free bytes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* no room */</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">fifo_size</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span> <span class="cm">/* bytes still not send */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">trans_max</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* delay to long */</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_DWR</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* success */</span>
	<span class="p">}</span>

	<span class="n">msp</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">hfcsx_extra</span> <span class="o">*</span><span class="p">)(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">extra</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">marker</span><span class="p">;</span>
	<span class="n">msp</span> <span class="o">+=</span> <span class="p">(((</span><span class="n">fifo</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">MAX_B_FRAMES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">f1</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_F1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">f_msk</span><span class="p">;</span>
	<span class="n">f2</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_F2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">f_msk</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">f1</span> <span class="o">-</span> <span class="n">f2</span><span class="p">;</span> <span class="cm">/* frame count actually buffered */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="p">(</span><span class="n">f_msk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* if wrap around */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">f_msk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC_FIFO</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcsx_write_fifo %d more as %d frames&quot;</span><span class="p">,</span> <span class="n">fifo</span><span class="p">,</span> <span class="n">f_msk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="p">(</span><span class="n">msp</span> <span class="o">+</span> <span class="n">f1</span><span class="p">)</span> <span class="o">=</span> <span class="n">z1</span><span class="p">;</span> <span class="cm">/* remember marker */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC_FIFO</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcsx_write_fifo %d f1(%x) f2(%x) z1(f1)(%x)&quot;</span><span class="p">,</span>
			<span class="n">fifo</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">z1</span><span class="p">);</span>
	<span class="cm">/* now determine free bytes in FIFO buffer */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">msp</span> <span class="o">+</span> <span class="n">f2</span><span class="p">)</span> <span class="o">-</span> <span class="n">z1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">fifo_size</span><span class="p">;</span>	<span class="cm">/* count now contains available bytes */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC_FIFO</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcsx_write_fifo %d count(%u/%d)&quot;</span><span class="p">,</span>
			<span class="n">fifo</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC_FIFO</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcsx_write_fifo %d no fifo mem&quot;</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="cm">/* get frame len */</span>
	<span class="n">src</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>	<span class="cm">/* source pointer */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_DWR</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">);</span>

	<span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_INCF1</span><span class="p">);</span> <span class="cm">/* increment F1 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bytein</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* wait for busy */</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************/</span>
<span class="cm">/* read_fifo reads data to an skb from the desired fifo        */</span>
<span class="cm">/* if no data is available or an error occurs NULL is returned */</span>
<span class="cm">/* the skb is not released in any way.                         */</span>
<span class="cm">/***************************************************************/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">read_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">fifo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">trans_max</span><span class="p">)</span>
<span class="p">{</span>       <span class="kt">int</span> <span class="n">fifo_size</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">f_msk</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fifo</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span> <span class="cm">/* no read fifo */</span>
	<span class="n">fifo_select</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fifo_size</span> <span class="o">=</span> <span class="n">D_FIFO_SIZE</span><span class="p">;</span> <span class="cm">/* D-channel */</span>
		<span class="n">f_msk</span> <span class="o">=</span> <span class="n">MAX_D_FRAMES</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trans_max</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span> <span class="cm">/* only hdlc */</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">fifo_size</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">b_fifo_size</span><span class="p">;</span> <span class="cm">/* B-channel */</span>
		<span class="n">f_msk</span> <span class="o">=</span> <span class="n">MAX_B_FRAMES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* transparent mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trans_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">z1</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_Z1H</span><span class="p">);</span>
		<span class="n">z1</span> <span class="o">=</span> <span class="p">((</span><span class="n">z1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_Z1L</span><span class="p">));</span>
		<span class="n">z2</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_Z2H</span><span class="p">);</span>
		<span class="n">z2</span> <span class="o">=</span> <span class="p">((</span><span class="n">z2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_Z2L</span><span class="p">));</span>
		<span class="cm">/* now determine bytes in actual FIFO buffer */</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">z1</span> <span class="o">-</span> <span class="n">z2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="n">fifo_size</span><span class="p">;</span>	<span class="cm">/* count now contains buffered bytes */</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">trans_max</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">trans_max</span><span class="p">;</span> <span class="cm">/* limit length */</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dst</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_DRD</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* no memory */</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">f1</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_F1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">f_msk</span><span class="p">;</span>
		<span class="n">f2</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_F2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">f_msk</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">f1</span> <span class="o">==</span> <span class="n">f2</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span> <span class="cm">/* no frame available */</span>

		<span class="n">z1</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_Z1H</span><span class="p">);</span>
		<span class="n">z1</span> <span class="o">=</span> <span class="p">((</span><span class="n">z1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_Z1L</span><span class="p">));</span>
		<span class="n">z2</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_Z2H</span><span class="p">);</span>
		<span class="n">z2</span> <span class="o">=</span> <span class="p">((</span><span class="n">z2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_Z2L</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC_FIFO</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcsx_read_fifo %d f1(%x) f2(%x) z1(f2)(%x) z2(f2)(%x)&quot;</span><span class="p">,</span>
				<span class="n">fifo</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">);</span>
		<span class="cm">/* now determine bytes in actual FIFO buffer */</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">z1</span> <span class="o">-</span> <span class="n">z2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="n">fifo_size</span><span class="p">;</span>	<span class="cm">/* count now contains buffered bytes */</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC_FIFO</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcsx_read_fifo %d count %u)&quot;</span><span class="p">,</span>
				<span class="n">fifo</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">fifo_size</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcsx_read_fifo %d paket inv. len %d &quot;</span><span class="p">,</span> <span class="n">fifo</span> <span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">count</span><span class="o">--</span><span class="p">;</span> <span class="cm">/* empty fifo */</span>
				<span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_DRD</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">count</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">dst</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

				<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span>
					<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_DRD</span><span class="p">);</span>

				<span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_DRD</span><span class="p">);</span> <span class="cm">/* CRC 1 */</span>
				<span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_DRD</span><span class="p">);</span> <span class="cm">/* CRC 2 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_DRD</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC_FIFO</span><span class="p">)</span>
						<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcsx_read_fifo %d crc error&quot;</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>
					<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFC-SX: receive out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_FIF_INCF2</span><span class="p">);</span> <span class="cm">/* increment F2 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">bytein</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* wait for busy */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">);</span> <span class="cm">/* retry in case of crc error */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************/</span>
<span class="cm">/* free hardware resources used by driver */</span>
<span class="cm">/******************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">release_io_hfcsx</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* interrupt output off ! */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_INT_M2</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m2</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_CIRM</span><span class="p">,</span> <span class="n">HFCSX_RESET</span><span class="p">);</span>	<span class="cm">/* Reset On */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>				<span class="cm">/* Timeout 30ms */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_CIRM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Reset Off */</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* release IO-Block */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">extra</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">extra</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**********************************************************/</span>
<span class="cm">/* set_fifo_size determines the size of the RAM and FIFOs */</span>
<span class="cm">/* returning 0 -&gt; need to reset the chip again.           */</span>
<span class="cm">/**********************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_fifo_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">b_fifo_size</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* already determined */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">chip</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">b_fifo_size</span> <span class="o">=</span> <span class="n">B_FIFO_SIZE_32K</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">b_fifo_size</span> <span class="o">=</span> <span class="n">B_FIFO_SIZE_8K</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">cirm</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="cm">/* only 8K of ram */</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/********************************************************************************/</span>
<span class="cm">/* function called to reset the HFC SX chip. A complete software reset of chip */</span>
<span class="cm">/* and fifos is done.                                                           */</span>
<span class="cm">/********************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">reset_hfcsx</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* interrupt output off ! */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_INT_M2</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m2</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HFC_SX: resetting card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_CIRM</span><span class="p">,</span> <span class="n">HFCSX_RESET</span> <span class="o">|</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">cirm</span><span class="p">);</span> <span class="cm">/* Reset */</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_CIRM</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">cirm</span><span class="p">);</span> <span class="cm">/* Reset Off */</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFC-SX init bit busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">last_fifo</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* invalidate */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set_fifo_size</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">trm</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">HFCSX_BTRANS_THRESMASK</span><span class="p">;</span>	<span class="cm">/* no echo connect , threshold */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_TRM</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">trm</span><span class="p">);</span>

	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_CLKDEL</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">);</span>	<span class="cm">/* ST-Bit delay for TE-Mode */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl_e</span> <span class="o">=</span> <span class="n">HFCSX_AUTO_AWAKE</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_SCTRL_E</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl_e</span><span class="p">);</span>	<span class="cm">/* S/T Auto awake */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no exchange */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">nt_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* we are in TE mode */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">=</span> <span class="n">HFCSX_TIM3_125</span> <span class="o">|</span> <span class="n">HFCSX_AUTO_TIMER</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_CTMT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">ctmt</span><span class="p">);</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">=</span> <span class="n">HFCSX_INTS_DTRANS</span> <span class="o">|</span> <span class="n">HFCSX_INTS_DREC</span> <span class="o">|</span>
		<span class="n">HFCSX_INTS_L1STATE</span> <span class="o">|</span> <span class="n">HFCSX_INTS_TIMER</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_INT_M1</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>

	<span class="cm">/* Clear already pending ints */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_INT_S1</span><span class="p">));</span>

	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_STATES</span><span class="p">,</span> <span class="n">HFCSX_LOAD_STATE</span> <span class="o">|</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* HFC ST 2 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_STATES</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* HFC ST 2 */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">mst_m</span> <span class="o">=</span> <span class="n">HFCSX_MASTER</span><span class="p">;</span>	<span class="cm">/* HFC Master Mode */</span>

	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_MST_MODE</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">mst_m</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>	<span class="cm">/* set tx_lo mode, error in datasheet ! */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_SCTRL</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_SCTRL_R</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl_r</span><span class="p">);</span>

	<span class="cm">/* Init GCI/IOM2 in master mode */</span>
	<span class="cm">/* Slots 0 and 1 are set for B-chan 1 and 2 */</span>
	<span class="cm">/* D- and monitor/CI channel are not enabled */</span>
	<span class="cm">/* STIO1 is used as output for data, B1+B2 from ST-&gt;IOM+HFC */</span>
	<span class="cm">/* STIO2 is used as data input, B1+B2 from IOM-&gt;ST */</span>
	<span class="cm">/* ST B-channel send disabled -&gt; continuous 1s */</span>
	<span class="cm">/* The IOM slots are always enabled */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="mh">0x36</span><span class="p">;</span>	<span class="cm">/* set data flow directions */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_CONNECT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">conn</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_B1_SSL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>	<span class="cm">/* B1-Slot 0 STIO1 out enabled */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_B2_SSL</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">);</span>	<span class="cm">/* B2-Slot 1 STIO1 out enabled */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_B1_RSL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>	<span class="cm">/* B1-Slot 0 STIO2 in enabled */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_B2_RSL</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">);</span>	<span class="cm">/* B2-Slot 1 STIO2 in enabled */</span>

	<span class="cm">/* Finally enable IRQ output */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m2</span> <span class="o">=</span> <span class="n">HFCSX_IRQ_ENABLE</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_INT_M2</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_INT_S2</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/***************************************************/</span>
<span class="cm">/* Timer function called when kernel timer expires */</span>
<span class="cm">/***************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcsx_Timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">75</span><span class="p">;</span>
	<span class="cm">/* WD RESET */</span>
<span class="cm">/*      WriteReg(cs, HFCD_DATA, HFCD_CTMT, cs-&gt;hw.hfcsx.ctmt | 0x80);</span>
<span class="cm">	add_timer(&amp;cs-&gt;hw.hfcsx.timer);</span>
<span class="cm">*/</span>
<span class="p">}</span>

<span class="cm">/************************************************/</span>
<span class="cm">/* select a b-channel entry matching and active */</span>
<span class="cm">/************************************************/</span>
<span class="k">static</span>
<span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span>
<span class="nf">Sel_BCS</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mode</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">channel</span> <span class="o">==</span> <span class="n">channel</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">mode</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">channel</span> <span class="o">==</span> <span class="n">channel</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*******************************/</span>
<span class="cm">/* D-channel receive procedure */</span>
<span class="cm">/*******************************/</span>
<span class="k">static</span>
<span class="kt">int</span>
<span class="nf">receive_dmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;rec_dmsg blocked&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">read_fifo</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_SEL_D_RX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_RCVBUFREADY</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**********************************/</span>
<span class="cm">/* B-channel main receive routine */</span>
<span class="cm">/**********************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">main_rec_hfcsx</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

<span class="nl">Begin:</span>
	<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;rec_data %d blocked&quot;</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">read_fifo</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="p">((</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">bswapped</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">HFCSX_SEL_B2_RX</span> <span class="o">:</span> <span class="n">HFCSX_SEL_B1_RX</span><span class="p">,</span>
			<span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">L1_MODE_TRANS</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">HFCSX_BTRANS_THRESHOLD</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rqueue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">schedule_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_RCVBUFREADY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Begin</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************/</span>
<span class="cm">/* D-channel send routine */</span>
<span class="cm">/**************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcsx_fill_dfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_fifo</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span> <span class="n">HFCSX_SEL_D_TX</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************/</span>
<span class="cm">/* B-channel send routine */</span>
<span class="cm">/**************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcsx_fill_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_fifo</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span>
		       <span class="p">((</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">bswapped</span><span class="p">))</span> <span class="o">?</span>
		       <span class="n">HFCSX_SEL_B2_TX</span> <span class="o">:</span> <span class="n">HFCSX_SEL_B1_TX</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">L1_MODE_TRANS</span><span class="p">)</span> <span class="o">?</span>
		       <span class="n">HFCSX_BTRANS_THRESHOLD</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">-=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_LLI_L1WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">flag</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">PACKET_NOACK</span> <span class="o">!=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u_long</span>	<span class="n">flags</span><span class="p">;</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aclock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ackcnt</span> <span class="o">+=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aclock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">schedule_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_ACKPENDING</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**********************************************/</span>
<span class="cm">/* D-channel l1 state call for leased NT-mode */</span>
<span class="cm">/**********************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dch_nt_l2l1</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="p">)</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1hw</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_ACTIVATE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_ACTIVATE</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_TESTLOOP</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">arg</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;PH_TEST_LOOP B1&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">arg</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;PH_TEST_LOOP B2&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="mi">3</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;PH_TEST_LOOP DISABLED&quot;</span><span class="p">);</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1hw</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">HW_TESTLOOP</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;dch_nt_l2l1 msg %04X unhandled&quot;</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="cm">/***********************/</span>
<span class="cm">/* set/reset echo mode */</span>
<span class="cm">/***********************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfcsx_auxcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">isdn_ctrl</span> <span class="o">*</span><span class="n">ic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">==</span> <span class="mi">98</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HFCSX_INTS_B2TRANS</span> <span class="o">+</span> <span class="n">HFCSX_INTS_B2REC</span> <span class="o">+</span> <span class="n">HFCSX_INTS_B1TRANS</span> <span class="o">+</span> <span class="n">HFCSX_INTS_B1REC</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_STATES</span><span class="p">,</span> <span class="n">HFCSX_LOAD_STATE</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* HFC ST G0 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">SCTRL_MODE_NT</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_SCTRL</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl</span><span class="p">);</span>	<span class="cm">/* set NT-mode */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_STATES</span><span class="p">,</span> <span class="n">HFCSX_LOAD_STATE</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* HFC ST G1 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_STATES</span><span class="p">,</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">HFCSX_ACTIVATE</span> <span class="o">|</span> <span class="n">HFCSX_DO_ACTION</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">ph_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">nt_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">stlist</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2l1</span> <span class="o">=</span> <span class="n">dch_nt_l2l1</span><span class="p">;</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;NT mode activated&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">chanlimit</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">bswapped</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">nt_mode</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">!=</span> <span class="mi">12</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">logecho</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">trm</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>	<span class="cm">/* enable echo chan */</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="n">HFCSX_INTS_B2REC</span><span class="p">;</span>
		<span class="cm">/* reset Channel !!!!! */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">logecho</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">trm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">;</span>	<span class="cm">/* disable echo chan */</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCSX_INTS_B2REC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">conn</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>	<span class="cm">/* B2-IOM -&gt; B2-ST */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_CTMT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">ctmt</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_SCTRL_R</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl_r</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_SCTRL</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_CONNECT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">conn</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_TRM</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">trm</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_INT_M1</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>				<span class="cm">/* hfcsx_auxcmd */</span>

<span class="cm">/*****************************/</span>
<span class="cm">/* E-channel receive routine */</span>
<span class="cm">/*****************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">receive_emsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;echo_rec_data blocked&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">read_fifo</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_SEL_B2_RX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_HEX</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dlog</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MAX_DLOG_SPACE</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;E&#39;</span><span class="p">;</span>
					<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;C&#39;</span><span class="p">;</span>
					<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;H&#39;</span><span class="p">;</span>
					<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;O&#39;</span><span class="p">;</span>
					<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
					<span class="n">ptr</span> <span class="o">+=</span> <span class="n">QuickHex</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
					<span class="n">ptr</span><span class="o">--</span><span class="p">;</span>
					<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
					<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">HiSax_putstatus</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dlog</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">HiSax_putstatus</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;LogEcho: &quot;</span><span class="p">,</span> <span class="s">&quot;warning Frame too big (%d)&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* receive_emsg */</span>


<span class="cm">/*********************/</span>
<span class="cm">/* Interrupt handler */</span>
<span class="cm">/*********************/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">hfcsx_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">intno</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">exval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">val</span><span class="p">,</span> <span class="n">stat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m2</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>		<span class="cm">/* not initialised */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HFCSX_ANYINT</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">stat</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_STATUS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_INT_S1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;HFC-SX: stat(%02x) s1(%02x)&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;HFC-SX irq %x %s&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>
			<span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">)</span> <span class="o">?</span>
			<span class="s">&quot;locked&quot;</span> <span class="o">:</span> <span class="s">&quot;unlocked&quot;</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* state machine irq */</span>
		<span class="n">exval</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_STATES</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;ph_state chg %d-&gt;%d&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">ph_state</span><span class="p">,</span>
				<span class="n">exval</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">ph_state</span> <span class="o">=</span> <span class="n">exval</span><span class="p">;</span>
		<span class="n">schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_L1STATECHANGE</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* timer irq */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">nt_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">--</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">nt_timer</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_L1STATECHANGE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_CTMT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">|</span> <span class="n">HFCSX_CLTIMER</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_s1</span> <span class="o">|=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_s1</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">exval</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_s1</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_s1</span> <span class="o">=</span> <span class="n">exval</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">Sel_BCS</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">)</span>
					<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcsx spurious 0x08 IRQ&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">main_rec_hfcsx</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">logecho</span><span class="p">)</span>
				<span class="n">receive_emsg</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">Sel_BCS</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">)</span>
					<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcsx spurious 0x10 IRQ&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">main_rec_hfcsx</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">Sel_BCS</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">)</span>
					<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcsx spurious 0x01 IRQ&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">hfcsx_fill_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
						<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;fill_data %d blocked&quot;</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">)))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
							<span class="n">hfcsx_fill_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
							<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
						<span class="p">}</span> <span class="k">else</span>
							<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;fill_data %d blocked&quot;</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">schedule_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_XMTBUFREADY</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">Sel_BCS</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">)</span>
					<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcsx spurious 0x02 IRQ&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">hfcsx_fill_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
						<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;fill_data %d blocked&quot;</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">)))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
							<span class="n">hfcsx_fill_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
							<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
						<span class="p">}</span> <span class="k">else</span>
							<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;fill_data %d blocked&quot;</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">schedule_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_XMTBUFREADY</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* receive dframe */</span>
			<span class="n">receive_dmsg</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* dframe transmitted */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_DBUSY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
				<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L1_DBUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
				<span class="n">schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_CLEARBUSY</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">hfcsx_fill_dfifo</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
						<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcsx_fill_dfifo irq blocked&quot;</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">goto</span> <span class="n">afterXPR</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
					<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">hfcsx_fill_dfifo</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
					<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcsx_fill_dfifo irq blocked&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_XMTBUFREADY</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="nl">afterXPR:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_s1</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_s1</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_s1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;HFC-SX irq %x loop %d&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">15</span> <span class="o">-</span> <span class="n">count</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********************************************************************/</span>
<span class="cm">/* timer callback for D-chan busy resolution. Currently no function */</span>
<span class="cm">/********************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcsx_dbusy_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*************************************/</span>
<span class="cm">/* Layer 1 D-channel hardware access */</span>
<span class="cm">/*************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">HFCSX_l1hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="p">)</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_HEX</span><span class="p">)</span>
			<span class="n">LogFrame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_VERBOSE</span><span class="p">)</span>
			<span class="n">dlogframe</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="cp">#ifdef L2FRAME_DEBUG		</span><span class="cm">/* psa */</span><span class="cp"></span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_LAPD</span><span class="p">)</span>
				<span class="n">Logl2Frame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="s">&quot;PH_DATA Queued&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef L2FRAME_DEBUG		</span><span class="cm">/* psa */</span><span class="cp"></span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_LAPD</span><span class="p">)</span>
				<span class="n">Logl2Frame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="s">&quot;PH_DATA&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">hfcsx_fill_dfifo</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
				<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcsx_fill_dfifo blocked&quot;</span><span class="p">);</span>

		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot; l2l1 tx_skb exist this shouldn&#39;t happen&quot;</span><span class="p">);</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_HEX</span><span class="p">)</span>
			<span class="n">LogFrame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_VERBOSE</span><span class="p">)</span>
			<span class="n">dlogframe</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef L2FRAME_DEBUG		</span><span class="cm">/* psa */</span><span class="cp"></span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_LAPD</span><span class="p">)</span>
			<span class="n">Logl2Frame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="s">&quot;PH_DATA_PULLED&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hfcsx_fill_dfifo</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcsx_fill_dfifo blocked&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
<span class="cp">#ifdef L2FRAME_DEBUG		</span><span class="cm">/* psa */</span><span class="cp"></span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_LAPD</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;-&gt; PH_REQUEST_PULL&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L1_PULL_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_L1_PULL_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">HW_RESET</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_STATES</span><span class="p">,</span> <span class="n">HFCSX_LOAD_STATE</span> <span class="o">|</span> <span class="mi">3</span><span class="p">);</span>	<span class="cm">/* HFC ST 3 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_STATES</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>	<span class="cm">/* HFC ST 2 */</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">mst_m</span> <span class="o">|=</span> <span class="n">HFCSX_MASTER</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_MST_MODE</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">mst_m</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_STATES</span><span class="p">,</span> <span class="n">HFCSX_ACTIVATE</span> <span class="o">|</span> <span class="n">HFCSX_DO_ACTION</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_POWERUP</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">HW_ENABLE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_STATES</span><span class="p">,</span> <span class="n">HFCSX_ACTIVATE</span> <span class="o">|</span> <span class="n">HFCSX_DO_ACTION</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">HW_DEACTIVATE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">mst_m</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCSX_MASTER</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_MST_MODE</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">mst_m</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">HW_INFO3</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">mst_m</span> <span class="o">|=</span> <span class="n">HFCSX_MASTER</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_MST_MODE</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">mst_m</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">HW_TESTLOOP</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>:
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_B1_SSL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>	<span class="cm">/* tx slot */</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_B1_RSL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>	<span class="cm">/* rx slot */</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_CONNECT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">conn</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>:
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_B2_SSL</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">);</span>	<span class="cm">/* tx slot */</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_B2_RSL</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">);</span>	<span class="cm">/* rx slot */</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x38</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_CONNECT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">conn</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcsx_l1hw loop invalid %4lx&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">trm</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>	<span class="cm">/* enable IOM-loop */</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_TRM</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">trm</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hfcsx_l1hw unknown pr %4x&quot;</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/***********************************************/</span>
<span class="cm">/* called during init setting l1 stack pointer */</span>
<span class="cm">/***********************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">setstack_hfcsx</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1hw</span> <span class="o">=</span> <span class="n">HFCSX_l1hw</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************/</span>
<span class="cm">/* send B-channel data if not blocked */</span>
<span class="cm">/**************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcsx_send_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hfcsx_fill_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LOCK_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;send_data %d blocked&quot;</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************/</span>
<span class="cm">/* activate/deactivate hardware for selected channels and mode */</span>
<span class="cm">/***************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mode_hfcsx</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fifo2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;HFCSX bchannel mode %d bchan %d/%d&quot;</span><span class="p">,</span>
			<span class="n">mode</span><span class="p">,</span> <span class="n">bc</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">bc</span><span class="p">;</span>
	<span class="n">fifo2</span> <span class="o">=</span> <span class="n">bc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">chanlimit</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* B1 and B2 normal mode */</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl_e</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">L1_MODE_NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* B1 and B2 exchanged */</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl_e</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* B1 and B2 normal mode */</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl_e</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">fifo2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* B1 and B2 normal mode */</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl_e</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">L1_MODE_NULL</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fifo2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HFCSX_INTS_B2TRANS</span> <span class="o">+</span> <span class="n">HFCSX_INTS_B2REC</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HFCSX_INTS_B1TRANS</span> <span class="o">+</span> <span class="n">HFCSX_INTS_B1REC</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">L1_MODE_TRANS</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">|=</span> <span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">|=</span> <span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fifo2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HFCSX_INTS_B2TRANS</span> <span class="o">+</span> <span class="n">HFCSX_INTS_B2REC</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x18</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HFCSX_INTS_B1TRANS</span> <span class="o">+</span> <span class="n">HFCSX_INTS_B1REC</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">L1_MODE_HDLC</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">|=</span> <span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">|=</span> <span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fifo2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HFCSX_INTS_B2TRANS</span> <span class="o">+</span> <span class="n">HFCSX_INTS_B2REC</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">2</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x18</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HFCSX_INTS_B1TRANS</span> <span class="o">+</span> <span class="n">HFCSX_INTS_B1REC</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">L1_MODE_EXTRN</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">conn</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">|=</span> <span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HFCSX_INTS_B2TRANS</span> <span class="o">+</span> <span class="n">HFCSX_INTS_B2REC</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">conn</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">|=</span> <span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HFCSX_INTS_B1TRANS</span> <span class="o">+</span> <span class="n">HFCSX_INTS_B1REC</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_SCTRL_E</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl_e</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_INT_M1</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_SCTRL</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_SCTRL_R</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">sctrl_r</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_CTMT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">ctmt</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_CONNECT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">conn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">L1_MODE_EXTRN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reset_fifo</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">fifo2</span> <span class="o">?</span> <span class="n">HFCSX_SEL_B2_RX</span> <span class="o">:</span> <span class="n">HFCSX_SEL_B1_RX</span><span class="p">);</span>
		<span class="n">reset_fifo</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">fifo2</span> <span class="o">?</span> <span class="n">HFCSX_SEL_B2_TX</span> <span class="o">:</span> <span class="n">HFCSX_SEL_B1_TX</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/******************************/</span>
<span class="cm">/* Layer2 -&gt; Layer 1 Transfer */</span>
<span class="cm">/******************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcsx_l2l1</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bcs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><pre><code>                         test_and_set_bit(BC_FLG_BUSY, &amp;bcs-&gt;Flag);
</code></pre></td><td class="code"><div class="highlight"><pre>			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Send_Data</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;hfc_l2l1: this shouldn&#39;t happen</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><pre><code>        test_and_set_bit(BC_FLG_BUSY, &amp;bcs-&gt;Flag);
</code></pre></td><td class="code"><div class="highlight"><pre>			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Send_Data</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L1_PULL_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_L1_PULL_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_ACTIVATE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">BC_FLG_ACTIV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="n">mode_hfcsx</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bc</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">l1_msg_b</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">l1_msg_b</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_ACTIV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="n">mode_hfcsx</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bc</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/******************************************/</span>
<span class="cm">/* deactivate B-channel access and queues */</span>
<span class="cm">/******************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">close_hfcsx</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mode_hfcsx</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rqueue</span><span class="p">);</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*************************************/</span>
<span class="cm">/* init B-channel queues and control */</span>
<span class="cm">/*************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">open_hfcsxstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">BC_FLG_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rqueue</span><span class="p">);</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*********************************/</span>
<span class="cm">/* inits the stack for B-channel */</span>
<span class="cm">/*********************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">setstack_2b</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">open_hfcsxstate</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">,</span> <span class="n">bcs</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">bcs</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2l1</span> <span class="o">=</span> <span class="n">hfcsx_l2l1</span><span class="p">;</span>
	<span class="n">setstack_manager</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="p">;</span>
	<span class="n">setstack_l1_B</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************/</span>
<span class="cm">/* handle L1 state changes */</span>
<span class="cm">/***************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcsx_bh</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">IsdnCardState</span><span class="p">,</span> <span class="n">tqueue</span><span class="p">);</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">D_L1STATECHANGE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">nt_mode</span><span class="p">)</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">ph_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
				<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_RESET</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>:
				<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_DEACTIVATE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">8</span><span class="p">)</span>:
				<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_RSYNC</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span>:
				<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_INFO2</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">7</span><span class="p">)</span>:
				<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_INFO4_P8</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">ph_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>:
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">nt_timer</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCSX_INTS_TIMER</span><span class="p">;</span>
					<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_INT_M1</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
					<span class="cm">/* Clear already pending ints */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_INT_S1</span><span class="p">));</span>

					<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_STATES</span><span class="p">,</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">HFCSX_LOAD_STATE</span><span class="p">);</span>
					<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
					<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_STATES</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
					<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">ph_state</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="n">HFCSX_INTS_TIMER</span><span class="p">;</span>
					<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_INT_M1</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
					<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCSX_AUTO_TIMER</span><span class="p">;</span>
					<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">|=</span> <span class="n">HFCSX_TIM3_125</span><span class="p">;</span>
					<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_CTMT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">|</span> <span class="n">HFCSX_CLTIMER</span><span class="p">);</span>
					<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_CTMT</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">|</span> <span class="n">HFCSX_CLTIMER</span><span class="p">);</span>
					<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="n">NT_T1_COUNT</span><span class="p">;</span>
					<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_STATES</span><span class="p">,</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">HFCSX_NT_G2_G3</span><span class="p">);</span>	<span class="cm">/* allow G2 -&gt; G3 transition */</span>
				<span class="p">}</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>:
			<span class="k">case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>:
			<span class="k">case</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>:
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCSX_INTS_TIMER</span><span class="p">;</span>
				<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_INT_M1</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">D_RCVBUFREADY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">))</span>
		<span class="n">DChannel_proc_rcv</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">D_XMTBUFREADY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">))</span>
		<span class="n">DChannel_proc_xmt</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/********************************/</span>
<span class="cm">/* called for card init message */</span>
<span class="cm">/********************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">inithfcsx</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">setstack_d</span> <span class="o">=</span> <span class="n">setstack_hfcsx</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Send_Data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hfcsx_send_data</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">BC_SetStack</span> <span class="o">=</span> <span class="n">setstack_2b</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">BC_SetStack</span> <span class="o">=</span> <span class="n">setstack_2b</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">BC_Close</span> <span class="o">=</span> <span class="n">close_hfcsx</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">BC_Close</span> <span class="o">=</span> <span class="n">close_hfcsx</span><span class="p">;</span>
	<span class="n">mode_hfcsx</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mode_hfcsx</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/*******************************************/</span>
<span class="cm">/* handle card messages from control layer */</span>
<span class="cm">/*******************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfcsx_card_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;HFCSX: card_msg %x&quot;</span><span class="p">,</span> <span class="n">mt</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CARD_RESET</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">reset_hfcsx</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CARD_RELEASE</span>:
		<span class="n">release_io_hfcsx</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CARD_INIT</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">inithfcsx</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>				<span class="cm">/* Timeout 80ms */</span>
		<span class="cm">/* now switch timer interrupt off */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCSX_INTS_TIMER</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_INT_M1</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
		<span class="cm">/* reinit mode reg */</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_MST_MODE</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">mst_m</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CARD_TEST</span>:
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef __ISAPNP__</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">isapnp_device_id</span> <span class="n">hfc_ids</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;G&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x2620</span><span class="p">),</span>
	  <span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;G&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x2620</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="s">&quot;Teles 16.3c2&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isapnp_device_id</span> <span class="o">*</span><span class="n">ipid</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hfc_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_card</span> <span class="o">*</span><span class="n">pnp_c</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">setup_hfcsx</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">hfcsx_revision</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax: HFC-SX driver Rev. %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HiSax_getrev</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
<span class="cp">#ifdef __ISAPNP__</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">isapnp_present</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pnp_d</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">ipid</span><span class="o">-&gt;</span><span class="n">card_vendor</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pnp_c</span> <span class="o">=</span> <span class="n">pnp_find_card</span><span class="p">(</span><span class="n">ipid</span><span class="o">-&gt;</span><span class="n">card_vendor</span><span class="p">,</span>
						   <span class="n">ipid</span><span class="o">-&gt;</span><span class="n">card_device</span><span class="p">,</span> <span class="n">pnp_c</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">pnp_d</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">pnp_d</span> <span class="o">=</span> <span class="n">pnp_find_dev</span><span class="p">(</span><span class="n">pnp_c</span><span class="p">,</span>
							  <span class="n">ipid</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">ipid</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span> <span class="n">pnp_d</span><span class="p">)))</span> <span class="p">{</span>
					<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax: %s detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ipid</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">);</span>
					<span class="n">pnp_disable_dev</span><span class="p">(</span><span class="n">pnp_d</span><span class="p">);</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">pnp_activate_dev</span><span class="p">(</span><span class="n">pnp_d</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: pnp_activate_dev ret(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
						<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">pnp_d</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_irq</span><span class="p">(</span><span class="n">pnp_d</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;HFC PnP:some resources are missing %ld/%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
						<span class="n">pnp_disable_dev</span><span class="p">(</span><span class="n">pnp_d</span><span class="p">);</span>
						<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;HFC PnP: PnP error card found, no device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">ipid</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pnp_c</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipid</span><span class="o">-&gt;</span><span class="n">card_vendor</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HFC PnP: no ISAPnP card found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xfffe</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_s1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">ph_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">fifo</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">typ</span> <span class="o">==</span> <span class="n">ISDN_CTYPE_HFC_SX</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">typ</span> <span class="o">==</span> <span class="n">ISDN_CTYPE_HFC_SP_PCMCIA</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;HFCSX isdn&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;HiSax: HFC-SX io-base %#lx already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x54</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">chip</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_CHIP_ID</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">chip</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;+&#39;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">9</span>:
			<span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;P&#39;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;HFC-SX: invalid chip id 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">chip</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ccd_sp_irqtab</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;HFC_SX: invalid irq %d specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">);</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">extra</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span>
		      <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsx_extra</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFC-SX: unable to allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HFC-S%c chip detected at base 0x%x IRQ %d HZ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* disable alle interrupts */</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_INT_M1</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HFCSX_INT_M2</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">int_m2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>	<span class="cm">/* no valid card type */</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hfcsx_dbusy_timer</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">cs</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tqueue</span><span class="p">,</span> <span class="n">hfcsx_bh</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisac</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisacfifo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisacfifo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Read_Reg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hfcsx_interrupt</span><span class="p">;</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hfcsx_Timer</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">cs</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">b_fifo_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* fifo size still unknown */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">cirm</span> <span class="o">=</span> <span class="n">ccd_sp_irqtab</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">];</span> <span class="cm">/* RAM not evaluated */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hfcsx</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">reset_hfcsx</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hfcsx_card_msg</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">auxcmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hfcsx_auxcmd</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
