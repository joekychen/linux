<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hisax › config.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>config.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: config.c,v 2.84.2.5 2004/02/11 13:21:33 keil Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * Author       Karsten Keil</span>
<span class="cm"> * Copyright    by Karsten Keil      &lt;keil@isdn4linux.de&gt;</span>
<span class="cm"> *              by Kai Germaschewski &lt;kai.germaschewski@gmx.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> * For changes and modifications please read</span>
<span class="cm"> * Documentation/isdn/HiSax.cert</span>
<span class="cm"> *</span>
<span class="cm"> * based on the teles driver from Jan den Ouden</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &quot;hisax.h&quot;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel_stat.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#define HISAX_STATUS_BUFSIZE 4096</span>

<span class="cm">/*</span>
<span class="cm"> * This structure array contains one entry per card. An entry looks</span>
<span class="cm"> * like this:</span>
<span class="cm"> *</span>
<span class="cm"> * { type, protocol, p0, p1, p2, NULL }</span>
<span class="cm"> *</span>
<span class="cm"> * type</span>
<span class="cm"> *    1 Teles 16.0       p0=irq p1=membase p2=iobase</span>
<span class="cm"> *    2 Teles  8.0       p0=irq p1=membase</span>
<span class="cm"> *    3 Teles 16.3       p0=irq p1=iobase</span>
<span class="cm"> *    4 Creatix PNP      p0=irq p1=IO0 (ISAC)  p2=IO1 (HSCX)</span>
<span class="cm"> *    5 AVM A1 (Fritz)   p0=irq p1=iobase</span>
<span class="cm"> *    6 ELSA PC          [p0=iobase] or nothing (autodetect)</span>
<span class="cm"> *    7 ELSA Quickstep   p0=irq p1=iobase</span>
<span class="cm"> *    8 Teles PCMCIA     p0=irq p1=iobase</span>
<span class="cm"> *    9 ITK ix1-micro    p0=irq p1=iobase</span>
<span class="cm"> *   10 ELSA PCMCIA      p0=irq p1=iobase</span>
<span class="cm"> *   11 Eicon.Diehl Diva p0=irq p1=iobase</span>
<span class="cm"> *   12 Asuscom ISDNLink p0=irq p1=iobase</span>
<span class="cm"> *   13 Teleint          p0=irq p1=iobase</span>
<span class="cm"> *   14 Teles 16.3c      p0=irq p1=iobase</span>
<span class="cm"> *   15 Sedlbauer speed  p0=irq p1=iobase</span>
<span class="cm"> *   15 Sedlbauer PC/104	p0=irq p1=iobase</span>
<span class="cm"> *   15 Sedlbauer speed pci	no parameter</span>
<span class="cm"> *   16 USR Sportster internal  p0=irq  p1=iobase</span>
<span class="cm"> *   17 MIC card                p0=irq  p1=iobase</span>
<span class="cm"> *   18 ELSA Quickstep 1000PCI  no parameter</span>
<span class="cm"> *   19 Compaq ISDN S0 ISA card p0=irq  p1=IO0 (HSCX)  p2=IO1 (ISAC) p3=IO2</span>
<span class="cm"> *   20 Travers Technologies NETjet-S PCI card</span>
<span class="cm"> *   21 TELES PCI               no parameter</span>
<span class="cm"> *   22 Sedlbauer Speed Star    p0=irq p1=iobase</span>
<span class="cm"> *   23 reserved</span>
<span class="cm"> *   24 Dr Neuhaus Niccy PnP/PCI card p0=irq p1=IO0 p2=IO1 (PnP only)</span>
<span class="cm"> *   25 Teles S0Box             p0=irq p1=iobase (from isapnp setup)</span>
<span class="cm"> *   26 AVM A1 PCMCIA (Fritz)   p0=irq p1=iobase</span>
<span class="cm"> *   27 AVM PnP/PCI		p0=irq p1=iobase (PCI no parameter)</span>
<span class="cm"> *   28 Sedlbauer Speed Fax+	p0=irq p1=iobase (from isapnp setup)</span>
<span class="cm"> *   29 Siemens I-Surf          p0=irq p1=iobase p2=memory (from isapnp setup)</span>
<span class="cm"> *   30 ACER P10                p0=irq p1=iobase (from isapnp setup)</span>
<span class="cm"> *   31 HST Saphir              p0=irq  p1=iobase</span>
<span class="cm"> *   32 Telekom A4T             none</span>
<span class="cm"> *   33 Scitel Quadro		p0=subcontroller (4*S0, subctrl 1...4)</span>
<span class="cm"> *   34	Gazel ISDN cards</span>
<span class="cm"> *   35 HFC 2BDS0 PCI           none</span>
<span class="cm"> *   36 Winbond 6692 PCI        none</span>
<span class="cm"> *   37 HFC 2BDS0 S+/SP         p0=irq p1=iobase</span>
<span class="cm"> *   38 Travers Technologies NETspider-U PCI card</span>
<span class="cm"> *   39 HFC 2BDS0-SP PCMCIA     p0=irq p1=iobase</span>
<span class="cm"> *   40 hotplug interface</span>
<span class="cm"> *   41 Formula-n enter:now ISDN PCI a/b   none</span>
<span class="cm"> *</span>
<span class="cm"> * protocol can be either ISDN_PTYPE_EURO or ISDN_PTYPE_1TR6 or ISDN_PTYPE_NI1</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">CardType</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;No Card&quot;</span><span class="p">,</span> <span class="s">&quot;Teles 16.0&quot;</span><span class="p">,</span> <span class="s">&quot;Teles 8.0&quot;</span><span class="p">,</span> <span class="s">&quot;Teles 16.3&quot;</span><span class="p">,</span>
	<span class="s">&quot;Creatix/Teles PnP&quot;</span><span class="p">,</span> <span class="s">&quot;AVM A1&quot;</span><span class="p">,</span> <span class="s">&quot;Elsa ML&quot;</span><span class="p">,</span> <span class="s">&quot;Elsa Quickstep&quot;</span><span class="p">,</span>
	<span class="s">&quot;Teles PCMCIA&quot;</span><span class="p">,</span>	<span class="s">&quot;ITK ix1-micro Rev.2&quot;</span><span class="p">,</span> <span class="s">&quot;Elsa PCMCIA&quot;</span><span class="p">,</span>
	<span class="s">&quot;Eicon.Diehl Diva&quot;</span><span class="p">,</span> <span class="s">&quot;ISDNLink&quot;</span><span class="p">,</span>	<span class="s">&quot;TeleInt&quot;</span><span class="p">,</span> <span class="s">&quot;Teles 16.3c&quot;</span><span class="p">,</span>
	<span class="s">&quot;Sedlbauer Speed Card&quot;</span><span class="p">,</span> <span class="s">&quot;USR Sportster&quot;</span><span class="p">,</span> <span class="s">&quot;ith mic Linux&quot;</span><span class="p">,</span>
	<span class="s">&quot;Elsa PCI&quot;</span><span class="p">,</span> <span class="s">&quot;Compaq ISA&quot;</span><span class="p">,</span> <span class="s">&quot;NETjet-S&quot;</span><span class="p">,</span> <span class="s">&quot;Teles PCI&quot;</span><span class="p">,</span>
	<span class="s">&quot;Sedlbauer Speed Star (PCMCIA)&quot;</span><span class="p">,</span> <span class="s">&quot;AMD 7930&quot;</span><span class="p">,</span> <span class="s">&quot;NICCY&quot;</span><span class="p">,</span> <span class="s">&quot;S0Box&quot;</span><span class="p">,</span>
	<span class="s">&quot;AVM A1 (PCMCIA)&quot;</span><span class="p">,</span> <span class="s">&quot;AVM Fritz PnP/PCI&quot;</span><span class="p">,</span> <span class="s">&quot;Sedlbauer Speed Fax +&quot;</span><span class="p">,</span>
	<span class="s">&quot;Siemens I-Surf&quot;</span><span class="p">,</span> <span class="s">&quot;Acer P10&quot;</span><span class="p">,</span> <span class="s">&quot;HST Saphir&quot;</span><span class="p">,</span> <span class="s">&quot;Telekom A4T&quot;</span><span class="p">,</span>
	<span class="s">&quot;Scitel Quadro&quot;</span><span class="p">,</span> <span class="s">&quot;Gazel&quot;</span><span class="p">,</span> <span class="s">&quot;HFC 2BDS0 PCI&quot;</span><span class="p">,</span> <span class="s">&quot;Winbond 6692&quot;</span><span class="p">,</span>
	<span class="s">&quot;HFC 2BDS0 SX&quot;</span><span class="p">,</span> <span class="s">&quot;NETspider-U&quot;</span><span class="p">,</span> <span class="s">&quot;HFC-2BDS0-SP PCMCIA&quot;</span><span class="p">,</span>
	<span class="s">&quot;Hotplug&quot;</span><span class="p">,</span> <span class="s">&quot;Formula-n enter:now PCI a/b&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_HISAX_ELSA</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_ELSA</span>
<span class="cp">#define DEFAULT_CFG {0, 0, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_AVM_A1</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_A1</span>
<span class="cp">#define DEFAULT_CFG {10, 0x340, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_AVM_A1_PCMCIA</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_A1_PCMCIA</span>
<span class="cp">#define DEFAULT_CFG {11, 0x170, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_FRITZPCI</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_FRITZPCI</span>
<span class="cp">#define DEFAULT_CFG {0, 0, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_16_3</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_16_3</span>
<span class="cp">#define DEFAULT_CFG {15, 0x180, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_S0BOX</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_S0BOX</span>
<span class="cp">#define DEFAULT_CFG {7, 0x378, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_16_0</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_16_0</span>
<span class="cp">#define DEFAULT_CFG {15, 0xd0000, 0xd80, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_TELESPCI</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_TELESPCI</span>
<span class="cp">#define DEFAULT_CFG {0, 0, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_IX1MICROR2</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_IX1MICROR2</span>
<span class="cp">#define DEFAULT_CFG {5, 0x390, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_DIEHLDIVA</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_DIEHLDIVA</span>
<span class="cp">#define DEFAULT_CFG {0, 0x0, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_ASUSCOM</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_ASUSCOM</span>
<span class="cp">#define DEFAULT_CFG {5, 0x200, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_TELEINT</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_TELEINT</span>
<span class="cp">#define DEFAULT_CFG {5, 0x300, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_SEDLBAUER</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_SEDLBAUER</span>
<span class="cp">#define DEFAULT_CFG {11, 0x270, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_SPORTSTER</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_SPORTSTER</span>
<span class="cp">#define DEFAULT_CFG {7, 0x268, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_MIC</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_MIC</span>
<span class="cp">#define DEFAULT_CFG {12, 0x3e0, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_NETJET</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_NETJET_S</span>
<span class="cp">#define DEFAULT_CFG {0, 0, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_HFCS</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_TELES3C</span>
<span class="cp">#define DEFAULT_CFG {5, 0x500, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_HFC_PCI</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_HFC_PCI</span>
<span class="cp">#define DEFAULT_CFG {0, 0, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_HFC_SX</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_HFC_SX</span>
<span class="cp">#define DEFAULT_CFG {5, 0x2E0, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_NICCY</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_NICCY</span>
<span class="cp">#define DEFAULT_CFG {0, 0x0, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_ISURF</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_ISURF</span>
<span class="cp">#define DEFAULT_CFG {5, 0x100, 0xc8000, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_HSTSAPHIR</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_HSTSAPHIR</span>
<span class="cp">#define DEFAULT_CFG {5, 0x250, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_BKM_A4T</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_BKM_A4T</span>
<span class="cp">#define DEFAULT_CFG {0, 0x0, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_SCT_QUADRO</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_SCT_QUADRO</span>
<span class="cp">#define DEFAULT_CFG {1, 0x0, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_GAZEL</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_GAZEL</span>
<span class="cp">#define DEFAULT_CFG {15, 0x180, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_W6692</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_W6692</span>
<span class="cp">#define DEFAULT_CFG {0, 0, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_NETJET_U</span>
<span class="cp">#undef DEFAULT_CARD</span>
<span class="cp">#undef DEFAULT_CFG</span>
<span class="cp">#define DEFAULT_CARD ISDN_CTYPE_NETJET_U</span>
<span class="cp">#define DEFAULT_CFG {0, 0, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HISAX_1TR6</span>
<span class="cp">#define DEFAULT_PROTO ISDN_PTYPE_1TR6</span>
<span class="cp">#define DEFAULT_PROTO_NAME &quot;1TR6&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_HISAX_NI1</span>
<span class="cp">#undef DEFAULT_PROTO</span>
<span class="cp">#define DEFAULT_PROTO ISDN_PTYPE_NI1</span>
<span class="cp">#undef DEFAULT_PROTO_NAME</span>
<span class="cp">#define DEFAULT_PROTO_NAME &quot;NI1&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_HISAX_EURO</span>
<span class="cp">#undef DEFAULT_PROTO</span>
<span class="cp">#define DEFAULT_PROTO ISDN_PTYPE_EURO</span>
<span class="cp">#undef DEFAULT_PROTO_NAME</span>
<span class="cp">#define DEFAULT_PROTO_NAME &quot;EURO&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef DEFAULT_PROTO</span>
<span class="cp">#define DEFAULT_PROTO ISDN_PTYPE_UNKNOWN</span>
<span class="cp">#define DEFAULT_PROTO_NAME &quot;UNKNOWN&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef DEFAULT_CARD</span>
<span class="cp">#define DEFAULT_CARD 0</span>
<span class="cp">#define DEFAULT_CFG {0, 0, 0, 0}</span>
<span class="cp">#endif</span>

<span class="cp">#define FIRST_CARD {				\</span>
<span class="cp">		DEFAULT_CARD,			\</span>
<span class="cp">			DEFAULT_PROTO,		\</span>
<span class="cp">			DEFAULT_CFG,		\</span>
<span class="cp">			NULL,			\</span>
<span class="cp">			}</span>

<span class="k">struct</span> <span class="n">IsdnCard</span> <span class="n">cards</span><span class="p">[</span><span class="n">HISAX_MAX_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">FIRST_CARD</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define HISAX_IDSIZE (HISAX_MAX_CARDS * 8)</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">HiSaxID</span><span class="p">[</span><span class="n">HISAX_IDSIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">HiSax_id</span> <span class="o">=</span> <span class="n">HiSaxID</span><span class="p">;</span>
<span class="cp">#ifdef MODULE</span>
<span class="cm">/* Variables for insmod */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">type</span><span class="p">[</span><span class="n">HISAX_MAX_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">[</span><span class="n">HISAX_MAX_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">io</span><span class="p">[</span><span class="n">HISAX_MAX_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
<span class="cp">#undef IO0_IO1</span>
<span class="cp">#ifdef CONFIG_HISAX_16_3</span>
<span class="cp">#define IO0_IO1</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_HISAX_NICCY</span>
<span class="cp">#undef IO0_IO1</span>
<span class="cp">#define IO0_IO1</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef IO0_IO1</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">io0</span><span class="p">[</span><span class="n">HISAX_MAX_CARDS</span><span class="p">]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">io1</span><span class="p">[</span><span class="n">HISAX_MAX_CARDS</span><span class="p">]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">[</span><span class="n">HISAX_MAX_CARDS</span><span class="p">]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mem</span><span class="p">[</span><span class="n">HISAX_MAX_CARDS</span><span class="p">]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">HiSaxID</span><span class="p">;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ISDN4Linux: Driver for passive ISDN cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Karsten Keil&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifdef IO0_IO1</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">io0</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">io1</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>

<span class="kt">int</span> <span class="n">nrcards</span><span class="p">;</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">HiSax_getrev</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">revision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">rev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">revision</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rev</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="sc">&#39;$&#39;</span><span class="p">);</span>
		<span class="o">*--</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rev</span> <span class="o">=</span> <span class="s">&quot;???&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">HiSaxVersion</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax: Linux Driver for passive ISDN cards</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifdef MODULE</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax: Version 3.5 (module)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax: Version 3.5 (kernel)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">l1_revision</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax: Layer1 Revision %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HiSax_getrev</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">l2_revision</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax: Layer2 Revision %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HiSax_getrev</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">tei_revision</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax: TeiMgr Revision %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HiSax_getrev</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">l3_revision</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax: Layer3 Revision %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HiSax_getrev</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">lli_revision</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax: LinkLayer Revision %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">HiSax_getrev</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="cp">#define MAX_ARG	(HISAX_MAX_CARDS * 5)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">HiSax_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">argc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="n">MAX_ARG</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>

	<span class="n">str</span> <span class="o">=</span> <span class="n">get_options</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">MAX_ARG</span><span class="p">,</span> <span class="n">ints</span><span class="p">);</span>
	<span class="n">argc</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HiSax_setup: argc(%d) str(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">HISAX_MAX_CARDS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">DEFAULT_PROTO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">typ</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="n">argc</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="n">argc</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="n">argc</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="n">argc</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="n">argc</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">HISAX_IDSIZE</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">HiSaxID</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HiSax: ID too long!&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">HiSaxID</span><span class="p">,</span> <span class="s">&quot;HiSax&quot;</span><span class="p">);</span>

	<span class="n">HiSax_id</span> <span class="o">=</span> <span class="n">HiSaxID</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;hisax=&quot;</span><span class="p">,</span> <span class="n">HiSax_setup</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* MODULES */</span><span class="cp"></span>

<span class="cp">#if CARD_TELES0</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_teles0</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_TELES3</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_teles3</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_S0BOX</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_s0box</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_TELESPCI</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_telespci</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_AVM_A1</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_avm_a1</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_AVM_A1_PCMCIA</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_avm_a1_pcmcia</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_FRITZPCI</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_avm_pcipnp</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_ELSA</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_elsa</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_IX1MICROR2</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_ix1micro</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_DIEHLDIVA</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_diva</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_ASUSCOM</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_asuscom</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_TELEINT</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_TeleInt</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_SEDLBAUER</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_sedlbauer</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_SPORTSTER</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_sportster</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_MIC</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_mic</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_NETJET_S</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_netjet_s</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_HFCS</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_hfcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_HFC_PCI</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_hfcpci</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_HFC_SX</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_hfcsx</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_NICCY</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_niccy</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_ISURF</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_isurf</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_HSTSAPHIR</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_saphir</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_BKM_A4T</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_bkm_a4t</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_SCT_QUADRO</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_sct_quadro</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_GAZEL</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_gazel</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_W6692</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_w6692</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_NETJET_U</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_netjet_u</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if CARD_FN_ENTERNOW_PCI</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">setup_enternow_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Find card with given driverId</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="nf">hisax_findcard</span><span class="p">(</span><span class="kt">int</span> <span class="n">driverid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nrcards</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cs</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span> <span class="o">==</span> <span class="n">driverid</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find card with given card number</span>
<span class="cm"> */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">struct IsdnCardState *hisax_get_card(int cardnr)</span>
<span class="c">{</span>
<span class="c">	if ((cardnr &lt;= nrcards) &amp;&amp; (cardnr &gt; 0))</span>
<span class="c">		if (cards[cardnr - 1].cs)</span>
<span class="c">			return cards[cardnr - 1].cs;</span>
<span class="c">	return NULL;</span>
<span class="c">}</span>
<span class="cp">#endif  /*  0  */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">HiSax_readstatus</span><span class="p">(</span><span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">hisax_findcard</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">HISAX_STATUS_BUFSIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;HiSax: status overflow readstat %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">len</span><span class="p">,</span> <span class="n">HISAX_STATUS_BUFSIZE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_end</span> <span class="o">-</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_read</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_read</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_read</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_read</span> <span class="o">&gt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_end</span><span class="p">)</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_read</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_buf</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">HISAX_STATUS_BUFSIZE</span><span class="p">)</span>
				<span class="n">cnt</span> <span class="o">=</span> <span class="n">HISAX_STATUS_BUFSIZE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">cnt</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_read</span><span class="p">,</span> <span class="n">cnt</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_read</span> <span class="o">+=</span> <span class="n">cnt</span> <span class="o">%</span> <span class="n">HISAX_STATUS_BUFSIZE</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">-=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;HiSax: if_readstatus called with invalid driverId!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">jiftime</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">long</span> <span class="n">mark</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="o">*</span><span class="n">s</span><span class="o">--</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="o">*</span><span class="n">s</span><span class="o">--</span> <span class="o">=</span> <span class="n">mark</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="n">mark</span> <span class="o">/=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="o">*</span><span class="n">s</span><span class="o">--</span> <span class="o">=</span> <span class="n">mark</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="n">mark</span> <span class="o">/=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="o">*</span><span class="n">s</span><span class="o">--</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
	<span class="o">*</span><span class="n">s</span><span class="o">--</span> <span class="o">=</span> <span class="n">mark</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="n">mark</span> <span class="o">/=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="o">*</span><span class="n">s</span><span class="o">--</span> <span class="o">=</span> <span class="n">mark</span> <span class="o">%</span> <span class="mi">6</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="n">mark</span> <span class="o">/=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="o">*</span><span class="n">s</span><span class="o">--</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
	<span class="o">*</span><span class="n">s</span><span class="o">--</span> <span class="o">=</span> <span class="n">mark</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="n">mark</span> <span class="o">/=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="o">*</span><span class="n">s</span><span class="o">--</span> <span class="o">=</span> <span class="n">mark</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_char</span> <span class="n">tmpbuf</span><span class="p">[</span><span class="n">HISAX_STATUS_BUFSIZE</span><span class="p">];</span>

<span class="kt">void</span> <span class="nf">VHiSax_putstatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
		      <span class="kt">va_list</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* if head == NULL the fmt contains the full info */</span>

	<span class="n">u_long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u_char</span>		<span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span>	<span class="n">ic</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HiSax: No CardStatus for message&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">statlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">tmpbuf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">jiftime</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">vsprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">tmpbuf</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">tmpbuf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">fmt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">HISAX_STATUS_BUFSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">statlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HiSax: status overflow %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">len</span><span class="p">,</span> <span class="n">HISAX_STATUS_BUFSIZE</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_end</span> <span class="o">-</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_write</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_write</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_write</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_write</span> <span class="o">&gt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_end</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_write</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_buf</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_write</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_write</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef KERNELSTACK_DEBUG</span>
	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">len</span> <span class="o">-</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">kernel_stack_page</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">tmpbuf</span><span class="p">,</span> <span class="s">&quot;kstack %s %lx use %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="n">kernel_stack_page</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">tmpbuf</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">tmpbuf</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_write</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_write</span> <span class="o">&gt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_end</span><span class="p">)</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_write</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_buf</span><span class="p">;</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">statlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_STAVAIL</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">HiSax_putstatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">VHiSax_putstatus</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ll_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addfeatures</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_ctrl</span> <span class="n">ic</span><span class="p">;</span>

	<span class="n">ic</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_RUN</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">features</span> <span class="o">|=</span> <span class="n">addfeatures</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ll_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_ctrl</span> <span class="n">ic</span><span class="p">;</span>

	<span class="n">ic</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_STOP</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><pre><code> CallcFreeChan(cs);
</code></pre></td><td class="code"><div class="highlight"><pre><span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ll_unload</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_ctrl</span> <span class="n">ic</span><span class="p">;</span>

	<span class="n">ic</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_UNLOAD</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_buf</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_read</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_write</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_end</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dlog</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dlog</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">closecard</span><span class="p">(</span><span class="kt">int</span> <span class="n">cardnr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">csta</span> <span class="o">=</span> <span class="n">cards</span><span class="p">[</span><span class="n">cardnr</span><span class="p">].</span><span class="n">cs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">BC_Close</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">csta</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">BC_Close</span><span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">csta</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">BC_Close</span><span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">);</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">);</span>
	<span class="n">csta</span><span class="o">-&gt;</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
		<span class="n">csta</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">DC_Close</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">csta</span><span class="o">-&gt;</span><span class="n">DC_Close</span><span class="p">(</span><span class="n">csta</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">)</span>
		<span class="n">csta</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">(</span><span class="n">csta</span><span class="p">,</span> <span class="n">CARD_RELEASE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">.</span><span class="n">function</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="c1">// FIXME?</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">);</span>
	<span class="n">ll_unload</span><span class="p">(</span><span class="n">csta</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">card_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">intno</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq_func</span><span class="p">(</span><span class="n">intno</span><span class="p">,</span> <span class="n">cs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">IRQ_HANDLED</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">irq_cnt</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">CARD_INIT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">irq_cnt</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: IRQ %d count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CardType</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">typ</span><span class="p">],</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">irq_cnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">card_irq</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">,</span> <span class="s">&quot;HiSax&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HiSax: couldn&#39;t get interrupt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">CARD_INIT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="cm">/* Timeout 10ms */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: IRQ %d count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">CardType</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">typ</span><span class="p">],</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">==</span> <span class="n">irq_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;%s: IRQ(%d) getting no interrupts during init %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">CardType</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">typ</span><span class="p">],</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">cnt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">free_irq</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">cs</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">CARD_RESET</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="n">cnt</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">CARD_TEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">hisax_cs_setup_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">typ</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if CARD_TELES0</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_16_0</span>:
	<span class="k">case</span> <span class="n">ISDN_CTYPE_8_0</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_teles0</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_TELES3</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_16_3</span>:
	<span class="k">case</span> <span class="n">ISDN_CTYPE_PNP</span>:
	<span class="k">case</span> <span class="n">ISDN_CTYPE_TELESPCMCIA</span>:
	<span class="k">case</span> <span class="n">ISDN_CTYPE_COMPAQ_ISA</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_teles3</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_S0BOX</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_S0BOX</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_s0box</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_TELESPCI</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_TELESPCI</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_telespci</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_AVM_A1</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_A1</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_avm_a1</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_AVM_A1_PCMCIA</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_A1_PCMCIA</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_avm_a1_pcmcia</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_FRITZPCI</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_FRITZPCI</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_avm_pcipnp</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_ELSA</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_ELSA</span>:
	<span class="k">case</span> <span class="n">ISDN_CTYPE_ELSA_PNP</span>:
	<span class="k">case</span> <span class="n">ISDN_CTYPE_ELSA_PCMCIA</span>:
	<span class="k">case</span> <span class="n">ISDN_CTYPE_ELSA_PCI</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_elsa</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_IX1MICROR2</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_IX1MICROR2</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_ix1micro</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_DIEHLDIVA</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_DIEHLDIVA</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_diva</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_ASUSCOM</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_ASUSCOM</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_asuscom</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_TELEINT</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_TELEINT</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_TeleInt</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_SEDLBAUER</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_SEDLBAUER</span>:
	<span class="k">case</span> <span class="n">ISDN_CTYPE_SEDLBAUER_PCMCIA</span>:
	<span class="k">case</span> <span class="n">ISDN_CTYPE_SEDLBAUER_FAX</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_sedlbauer</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_SPORTSTER</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_SPORTSTER</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_sportster</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_MIC</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_MIC</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_mic</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_NETJET_S</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_NETJET_S</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_netjet_s</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_HFCS</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_TELES3C</span>:
	<span class="k">case</span> <span class="n">ISDN_CTYPE_ACERP10</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_hfcs</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_HFC_PCI</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_HFC_PCI</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_hfcpci</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_HFC_SX</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_HFC_SX</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_hfcsx</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_NICCY</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_NICCY</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_niccy</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_ISURF</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_ISURF</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_isurf</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_HSTSAPHIR</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_HSTSAPHIR</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_saphir</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if	CARD_BKM_A4T</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_BKM_A4T</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_bkm_a4t</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if	CARD_SCT_QUADRO</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_SCT_QUADRO</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_sct_quadro</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_GAZEL</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_GAZEL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_gazel</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_W6692</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_W6692</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_w6692</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_NETJET_U</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_NETJET_U</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_netjet_u</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if CARD_FN_ENTERNOW_PCI</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_ENTERNOW</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_enternow_pci</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_DYNAMIC</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;HiSax: Support for %s Card not selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">CardType</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">typ</span><span class="p">]);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hisax_cs_new</span><span class="p">(</span><span class="kt">int</span> <span class="n">cardnr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">**</span><span class="n">cs_out</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">busy_flag</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">lockowner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">;</span>

	<span class="o">*</span><span class="n">cs_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">cs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;HiSax: No memory for IsdnCardState(card %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cardnr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">cs</span> <span class="o">=</span> <span class="n">cs</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">statlock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">chanlimit</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* maximum B-channel number */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">logecho</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* No echo logging */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardnr</span> <span class="o">=</span> <span class="n">cardnr</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">L1_DEB_WARN</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">busy_flag</span> <span class="o">=</span> <span class="n">busy_flag</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq_flags</span> <span class="o">=</span> <span class="n">I4L_IRQ_FLAG</span><span class="p">;</span>
<span class="cp">#if TEI_PER_CARD</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_PTYPE_NI1</span><span class="p">)</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_TWO_DCHAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_TWO_DCHAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">typ</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">typ</span> <span class="o">&gt;</span> <span class="n">ISDN_CTYPE_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;HiSax: Card Type %d out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">typ</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">outf_cs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dlog</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MAX_DLOG_SPACE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;HiSax: No memory for dlog(card %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cardnr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">outf_cs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">HISAX_STATUS_BUFSIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;HiSax: No memory for status_buf(card %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cardnr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">outf_dlog</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">stlist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_read</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_buf</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_write</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_buf</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_end</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">status_buf</span> <span class="o">+</span> <span class="n">HISAX_STATUS_BUFSIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">typ</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">typ</span><span class="p">;</span>
<span class="cp">#ifdef MODULE</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">lockowner</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">maxbufsize</span> <span class="o">=</span> <span class="n">MAX_DATA_SIZE</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">hl_hdrlen</span> <span class="o">=</span> <span class="n">MAX_HEADER_LEN</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span>
		<span class="n">ISDN_FEATURE_L2_X75I</span> <span class="o">|</span>
		<span class="n">ISDN_FEATURE_L2_HDLC</span> <span class="o">|</span>
		<span class="n">ISDN_FEATURE_L2_HDLC_56K</span> <span class="o">|</span>
		<span class="n">ISDN_FEATURE_L2_TRANS</span> <span class="o">|</span>
		<span class="n">ISDN_FEATURE_L3_TRANS</span> <span class="o">|</span>
<span class="cp">#ifdef	CONFIG_HISAX_1TR6</span>
		<span class="n">ISDN_FEATURE_P_1TR6</span> <span class="o">|</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef	CONFIG_HISAX_EURO</span>
		<span class="n">ISDN_FEATURE_P_EURO</span> <span class="o">|</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef	CONFIG_HISAX_NI1</span>
		<span class="n">ISDN_FEATURE_P_NI1</span> <span class="o">|</span>
<span class="cp">#endif</span>
		<span class="mi">0</span><span class="p">;</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">HiSax_command</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">writecmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">writebuf_skb</span> <span class="o">=</span> <span class="n">HiSax_writebuf_skb</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">readstat</span> <span class="o">=</span> <span class="n">HiSax_readstatus</span><span class="p">;</span>
	<span class="n">register_isdn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">channels</span><span class="p">;</span>

	<span class="o">*</span><span class="n">cs_out</span> <span class="o">=</span> <span class="n">cs</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* success */</span>

<span class="nl">outf_dlog:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dlog</span><span class="p">);</span>
<span class="nl">outf_cs:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">cs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* error */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hisax_cs_setup</span><span class="p">(</span><span class="kt">int</span> <span class="n">cardnr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MAX_DFRAME_LEN_L1</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HiSax: No memory for isac rcvbuf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ll_unload</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">outf_cs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">);</span>

	<span class="n">init_bcstate</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">init_bcstate</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* init_card only handles interrupts which are not */</span>
	<span class="cm">/* used here for the loadable driver */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">typ</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISDN_CTYPE_DYNAMIC</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">init_card</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">closecard</span><span class="p">(</span><span class="n">cardnr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">outf_cs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">init_tei</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">CallcNewChan</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">closecard</span><span class="p">(</span><span class="n">cardnr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">outf_cs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* ISAR needs firmware download first */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HW_ISAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
		<span class="n">ll_run</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">outf_cs:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">cs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Used from an exported function but calls __devinit functions.</span>
<span class="cm"> * Tell modpost not to warn (__ref)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__ref</span> <span class="nf">checkcard</span><span class="p">(</span><span class="kt">int</span> <span class="n">cardnr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">busy_flag</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">lockowner</span><span class="p">,</span>
			   <span class="n">hisax_setup_func_t</span> <span class="n">card_setup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">cards</span> <span class="o">+</span> <span class="n">cardnr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hisax_cs_new</span><span class="p">(</span><span class="n">cardnr</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">,</span> <span class="n">busy_flag</span><span class="p">,</span> <span class="n">lockowner</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;HiSax: Card %d Protocol %s Id=%s (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cardnr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_PTYPE_1TR6</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;1TR6&quot;</span> <span class="o">:</span>
	       <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_PTYPE_EURO</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;EDSS1&quot;</span> <span class="o">:</span>
	       <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_PTYPE_LEASED</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;LEASED&quot;</span> <span class="o">:</span>
	       <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_PTYPE_NI1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;NI1&quot;</span> <span class="o">:</span>
	       <span class="s">&quot;NONE&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">card_setup</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ll_unload</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">outf_cs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hisax_cs_setup</span><span class="p">(</span><span class="n">cardnr</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">cs</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">outf_cs:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">cs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">HiSax_shiftcards</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">HISAX_MAX_CARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">HiSax_inithardware</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">busy_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">foundcards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="sc">&#39;,&#39;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">next_id</span> <span class="o">=</span> <span class="n">HiSax_id</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">ids</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="n">HiSax_id</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">))</span>
		<span class="n">t</span> <span class="o">=</span> <span class="sc">&#39;,&#39;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="n">HiSax_id</span><span class="p">,</span> <span class="sc">&#39;%&#39;</span><span class="p">))</span>
		<span class="n">t</span> <span class="o">=</span> <span class="sc">&#39;%&#39;</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">nrcards</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">typ</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">next_id</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">next_id</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">t</span><span class="p">)))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">next_id</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
			<span class="n">flg</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">next_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flg</span> <span class="o">&gt;=</span> <span class="n">i</span><span class="p">)</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="s">&quot;%s%d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">checkcard</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">busy_flag</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			      <span class="n">hisax_cs_setup_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">foundcards</span><span class="o">++</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* make sure we don&#39;t oops the module */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">typ</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">typ</span> <span class="o">&lt;=</span> <span class="n">ISDN_CTYPE_COUNT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				       <span class="s">&quot;HiSax: Card %s not installed !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">CardType</span><span class="p">[</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">typ</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="n">HiSax_shiftcards</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
			<span class="n">nrcards</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">foundcards</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">HiSax_closecard</span><span class="p">(</span><span class="kt">int</span> <span class="n">cardnr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="n">nrcards</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cardnr</span> <span class="o">&gt;</span> <span class="n">last</span> <span class="o">||</span> <span class="n">cardnr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">cardnr</span><span class="p">].</span><span class="n">cs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ll_stop</span><span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">cardnr</span><span class="p">].</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">release_tei</span><span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">cardnr</span><span class="p">].</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">CallcFreeChan</span><span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">cardnr</span><span class="p">].</span><span class="n">cs</span><span class="p">);</span>

		<span class="n">closecard</span><span class="p">(</span><span class="n">cardnr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">cardnr</span><span class="p">].</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">cardnr</span><span class="p">].</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">cards</span><span class="p">[</span><span class="n">cardnr</span><span class="p">].</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">cards</span><span class="p">[</span><span class="n">cardnr</span><span class="p">].</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">cards</span><span class="p">[</span><span class="n">cardnr</span><span class="p">].</span><span class="n">cs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">cardnr</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cards</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nrcards</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">HiSax_reportcard</span><span class="p">(</span><span class="kt">int</span> <span class="n">cardnr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">cards</span><span class="p">[</span><span class="n">cardnr</span><span class="p">].</span><span class="n">cs</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HiSax: reportcard No %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cardnr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HiSax: Type %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CardType</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">typ</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HiSax: debuglevel %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HiSax: HiSax_reportcard address 0x%lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HiSax_reportcard</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HiSax: cs 0x%lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">cs</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HiSax: HW_Flags %lx bc0 flg %lx bc1 flg %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Flag</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">Flag</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HiSax: bcs 0 mode %d ch%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mode</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HiSax: bcs 1 mode %d ch%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">mode</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">channel</span><span class="p">);</span>
<span class="cp">#ifdef ERROR_STATISTIC</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HiSax: dc errors(rx,crc,tx) %d,%d,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">err_rx</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">err_crc</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">err_tx</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	       <span class="s">&quot;HiSax: bc0 errors(inv,rdo,crc,tx) %d,%d,%d,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">err_inv</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">err_rdo</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">err_crc</span><span class="p">,</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">err_tx</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	       <span class="s">&quot;HiSax: bc1 errors(inv,rdo,crc,tx) %d,%d,%d,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">err_inv</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">err_rdo</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">err_crc</span><span class="p">,</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">err_tx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sel</span> <span class="o">==</span> <span class="mi">99</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">err_rx</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">err_crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">err_tx</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">err_inv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">err_rdo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">err_crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">err_tx</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">err_inv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">err_rdo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">err_crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">err_tx</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">HiSax_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>
<span class="cp">#ifdef MODULE</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nzproto</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">HiSaxVersion</span><span class="p">();</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">CallcNew</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">Isdnl3New</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_callc</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">Isdnl2New</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_isdnl3</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">TeiNew</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_isdnl2</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">Isdnl1New</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_tei</span><span class="p">;</span>

<span class="cp">#ifdef MODULE</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* We &#39;ll register drivers later, but init basic functions */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HISAX_MAX_CARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">typ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_HISAX_ELSA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ISDN_CTYPE_ELSA_PCMCIA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we have exported  and return in this case */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_HISAX_SEDLBAUER</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ISDN_CTYPE_SEDLBAUER_PCMCIA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we have to export  and return in this case */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_HISAX_AVM_A1_PCMCIA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ISDN_CTYPE_A1_PCMCIA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we have to export  and return in this case */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_HISAX_HFC_SX</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ISDN_CTYPE_HFC_SP_PCMCIA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we have to export  and return in this case */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
	<span class="n">nrcards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef MODULE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>			<span class="cm">/* If id= string used */</span>
		<span class="n">HiSax_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">HISAX_MAX_CARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">typ</span> <span class="o">=</span> <span class="n">type</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">protocol</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">nzproto</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">DEFAULT_PROTO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISDN_CTYPE_16_0</span>:
			<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ISDN_CTYPE_8_0</span>:
			<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef IO0_IO1</span>
		<span class="k">case</span> <span class="n">ISDN_CTYPE_PNP</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_NICCY</span>:
			<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">io0</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">io1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_CTYPE_COMPAQ_ISA</span>:
			<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">io0</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">io1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">case</span> <span class="n">ISDN_CTYPE_ELSA</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_HFC_PCI</span>:
			<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_CTYPE_16_3</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_TELESPCMCIA</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_A1</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_A1_PCMCIA</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_ELSA_PNP</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_ELSA_PCMCIA</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_IX1MICROR2</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_DIEHLDIVA</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_ASUSCOM</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_TELEINT</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_SEDLBAUER</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_SEDLBAUER_PCMCIA</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_SEDLBAUER_FAX</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_SPORTSTER</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_MIC</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_TELES3C</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_ACERP10</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_S0BOX</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_FRITZPCI</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_HSTSAPHIR</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_GAZEL</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_HFC_SX</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_HFC_SP_PCMCIA</span>:
			<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_CTYPE_ISURF</span>:
			<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_CTYPE_ELSA_PCI</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_NETJET_S</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_TELESPCI</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_W6692</span>:
		<span class="k">case</span> <span class="n">ISDN_CTYPE_NETJET_U</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_CTYPE_BKM_A4T</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_CTYPE_SCT_QUADRO</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* QUADRO is a 4 BRI card */</span>
				<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="cm">/* we need to check if further cards can be added */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">HISAX_MAX_CARDS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">typ</span> <span class="o">=</span> <span class="n">ISDN_CTYPE_SCT_QUADRO</span><span class="p">;</span>
					<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
					<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">HISAX_MAX_CARDS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">typ</span> <span class="o">=</span> <span class="n">ISDN_CTYPE_SCT_QUADRO</span><span class="p">;</span>
					<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
					<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">HISAX_MAX_CARDS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">typ</span> <span class="o">=</span> <span class="n">ISDN_CTYPE_SCT_QUADRO</span><span class="p">;</span>
					<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
					<span class="n">cards</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nzproto</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;HiSax: Warning - no protocol specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HiSax: using protocol %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">DEFAULT_PROTO_NAME</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HiSax_id</span><span class="p">)</span>
		<span class="n">HiSax_id</span> <span class="o">=</span> <span class="n">HiSaxID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HiSaxID</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">HiSaxID</span><span class="p">,</span> <span class="s">&quot;HiSax&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HISAX_MAX_CARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">typ</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">nrcards</span><span class="o">++</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HiSax: Total %d card%s defined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">nrcards</span><span class="p">,</span> <span class="p">(</span><span class="n">nrcards</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;s&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="cm">/* Install only, if at least one card found */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HiSax_inithardware</span><span class="p">(</span><span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_tei:</span>
	<span class="n">TeiFree</span><span class="p">();</span>
<span class="nl">out_isdnl2:</span>
	<span class="n">Isdnl2Free</span><span class="p">();</span>
<span class="nl">out_isdnl3:</span>
	<span class="n">Isdnl3Free</span><span class="p">();</span>
<span class="nl">out_callc:</span>
	<span class="n">CallcFree</span><span class="p">();</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">HiSax_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cardnr</span> <span class="o">=</span> <span class="n">nrcards</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cardnr</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">HiSax_closecard</span><span class="p">(</span><span class="n">cardnr</span><span class="o">--</span><span class="p">);</span>
	<span class="n">Isdnl1Free</span><span class="p">();</span>
	<span class="n">TeiFree</span><span class="p">();</span>
	<span class="n">Isdnl2Free</span><span class="p">();</span>
	<span class="n">Isdnl3Free</span><span class="p">();</span>
	<span class="n">CallcFree</span><span class="p">();</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax module removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_HOTPLUG</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">hisax_init_pcmcia</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pcm_iob</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">busy_flag</span><span class="p">,</span> <span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">ids</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">cards</span><span class="p">[</span><span class="n">nrcards</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nrcards</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="s">&quot;HiSax%d&quot;</span><span class="p">,</span> <span class="n">nrcards</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="s">&quot;HiSax&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">checkcard</span><span class="p">(</span><span class="n">nrcards</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">busy_flag</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		       <span class="n">hisax_cs_setup_card</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nrcards</span><span class="p">;</span>
	<span class="n">nrcards</span><span class="o">++</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hisax_init_pcmcia</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">HiSax_closecard</span><span class="p">);</span>

<span class="cp">#include &quot;hisax_if.h&quot;</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hisax_register</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hisax_unregister</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">hisax_d_l1l2</span><span class="p">(</span><span class="k">struct</span> <span class="n">hisax_if</span> <span class="o">*</span><span class="n">ifc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hisax_b_l1l2</span><span class="p">(</span><span class="k">struct</span> <span class="n">hisax_if</span> <span class="o">*</span><span class="n">ifc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hisax_d_l2l1</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hisax_b_l2l1</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hisax_cardmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hisax_bc_setstack</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hisax_bc_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hisax_bh</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">EChannel_proc_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">hisax_d_if</span> <span class="o">*</span><span class="n">d_if</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hisax_setup_card_dynamic</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hisax_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">hisax_d_if</span> <span class="o">*</span><span class="n">hisax_d_if</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hisax_b_if</span> <span class="o">*</span><span class="n">b_if</span><span class="p">[],</span>
		   <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">id</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HISAX_MAX_CARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">typ</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">HISAX_MAX_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">typ</span> <span class="o">=</span> <span class="n">ISDN_CTYPE_DYNAMIC</span><span class="p">;</span>
	<span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;%s%d&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">nrcards</span><span class="o">++</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">checkcard</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hisax_d_if</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">,</span>
			   <span class="n">hisax_setup_card_dynamic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// yuck</span>
		<span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">typ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nrcards</span><span class="o">--</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cs</span> <span class="o">=</span> <span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cs</span><span class="p">;</span>
	<span class="n">hisax_d_if</span><span class="o">-&gt;</span><span class="n">cs</span> <span class="o">=</span> <span class="n">cs</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hisax_d_if</span> <span class="o">=</span> <span class="n">hisax_d_if</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span> <span class="o">=</span> <span class="n">hisax_cardmsg</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tqueue</span><span class="p">,</span> <span class="n">hisax_bh</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2l1</span> <span class="o">=</span> <span class="n">hisax_d_l2l1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BC_SetStack</span> <span class="o">=</span> <span class="n">hisax_bc_setstack</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BC_Close</span> <span class="o">=</span> <span class="n">hisax_bc_close</span><span class="p">;</span>

		<span class="n">b_if</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ifc</span><span class="p">.</span><span class="n">l1l2</span> <span class="o">=</span> <span class="n">hisax_b_l1l2</span><span class="p">;</span>

		<span class="n">hisax_d_if</span><span class="o">-&gt;</span><span class="n">b_if</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_if</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">hisax_d_if</span><span class="o">-&gt;</span><span class="n">ifc</span><span class="p">.</span><span class="n">l1l2</span> <span class="o">=</span> <span class="n">hisax_d_l1l2</span><span class="p">;</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hisax_d_if</span><span class="o">-&gt;</span><span class="n">erq</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hisax_d_if</span><span class="o">-&gt;</span><span class="n">ph_state</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hisax_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">hisax_d_if</span> <span class="o">*</span><span class="n">hisax_d_if</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cards</span><span class="p">[</span><span class="n">hisax_d_if</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardnr</span><span class="p">].</span><span class="n">typ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">HiSax_closecard</span><span class="p">(</span><span class="n">hisax_d_if</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardnr</span><span class="p">);</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hisax_d_if</span><span class="o">-&gt;</span><span class="n">erq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#include &quot;isdnl1.h&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hisax_sched_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tqueue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hisax_bh</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">IsdnCardState</span><span class="p">,</span> <span class="n">tqueue</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">D_RCVBUFREADY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">))</span>
		<span class="n">DChannel_proc_rcv</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">E_RCVBUFREADY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">))</span>
		<span class="n">EChannel_proc_rcv</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hisax_d_if</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">D_L1STATECHANGE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hisax_d_if</span><span class="o">-&gt;</span><span class="n">ph_state</span><span class="p">))</span>
			<span class="n">pr</span> <span class="o">=</span> <span class="n">PH_ACTIVATE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pr</span> <span class="o">=</span> <span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">st</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">stlist</span><span class="p">;</span> <span class="n">st</span><span class="p">;</span> <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hisax_b_sched_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tqueue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">D_L2L1</span><span class="p">(</span><span class="k">struct</span> <span class="n">hisax_d_if</span> <span class="o">*</span><span class="n">d_if</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hisax_if</span> <span class="o">*</span><span class="n">ifc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hisax_if</span> <span class="o">*</span><span class="p">)</span> <span class="n">d_if</span><span class="p">;</span>
	<span class="n">ifc</span><span class="o">-&gt;</span><span class="n">l2l1</span><span class="p">(</span><span class="n">ifc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">B_L2L1</span><span class="p">(</span><span class="k">struct</span> <span class="n">hisax_b_if</span> <span class="o">*</span><span class="n">b_if</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hisax_if</span> <span class="o">*</span><span class="n">ifc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hisax_if</span> <span class="o">*</span><span class="p">)</span> <span class="n">b_if</span><span class="p">;</span>
	<span class="n">ifc</span><span class="o">-&gt;</span><span class="n">l2l1</span><span class="p">(</span><span class="n">ifc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hisax_d_l1l2</span><span class="p">(</span><span class="k">struct</span> <span class="n">hisax_if</span> <span class="o">*</span><span class="n">ifc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hisax_d_if</span> <span class="o">*</span><span class="n">d_if</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hisax_d_if</span> <span class="o">*</span><span class="p">)</span> <span class="n">ifc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">d_if</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PH_ACTIVATE</span> <span class="o">|</span> <span class="n">INDICATION</span>:
		<span class="n">set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d_if</span><span class="o">-&gt;</span><span class="n">ph_state</span><span class="p">);</span>
		<span class="n">hisax_sched_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_L1STATECHANGE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">INDICATION</span>:
		<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d_if</span><span class="o">-&gt;</span><span class="n">ph_state</span><span class="p">);</span>
		<span class="n">hisax_sched_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_L1STATECHANGE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">INDICATION</span>:
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="n">hisax_sched_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_RCVBUFREADY</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">CONFIRM</span>:
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">D_L2L1</span><span class="p">(</span><span class="n">d_if</span><span class="p">,</span> <span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FLG_L1_DBUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">st</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">stlist</span><span class="p">;</span> <span class="n">st</span><span class="p">;</span> <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L1_PULL_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_DATA_E</span> <span class="o">|</span> <span class="n">INDICATION</span>:
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_if</span><span class="o">-&gt;</span><span class="n">erq</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="n">hisax_sched_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">E_RCVBUFREADY</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pr %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hisax_b_l1l2</span><span class="p">(</span><span class="k">struct</span> <span class="n">hisax_if</span> <span class="o">*</span><span class="n">ifc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hisax_b_if</span> <span class="o">*</span><span class="n">b_if</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hisax_b_if</span> <span class="o">*</span><span class="p">)</span> <span class="n">ifc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">b_if</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>FIXME use isdnl1?</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span> <span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PH_ACTIVATE</span> <span class="o">|</span> <span class="n">INDICATION</span>:
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">INDICATION</span>:
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">b_if</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">INDICATION</span>:
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rqueue</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="n">hisax_b_sched_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_RCVBUFREADY</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">CONFIRM</span>:
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">-=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_LLI_L1WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u_long</span>	<span class="n">flags</span><span class="p">;</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aclock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ackcnt</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aclock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">schedule_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_ACKPENDING</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">B_L2L1</span><span class="p">(</span><span class="n">b_if</span><span class="p">,</span> <span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L1_PULL_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hisax_b_l1l2 pr %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hisax_d_l2l1</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hisax_d_if</span> <span class="o">*</span><span class="n">hisax_d_if</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hisax_d_if</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span>:
	<span class="k">case</span> <span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">INDICATION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_HEX</span><span class="p">)</span>
			<span class="n">LogFrame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_VERBOSE</span><span class="p">)</span>
			<span class="n">dlogframe</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">Logl2Frame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="s">&quot;PH_DATA_REQ&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>FIXME lock?</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_L1_DBUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
			<span class="n">D_L2L1</span><span class="p">(</span><span class="n">hisax_d_if</span><span class="p">,</span> <span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">REQUEST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_L1_DBUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">FLG_L1_PULL_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">D_L2L1</span><span class="p">(</span><span class="n">hisax_d_if</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hisax_cardmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hisax_b_l2l1</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bcs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hisax_b_if</span> <span class="o">*</span><span class="n">b_if</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">b_if</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PH_ACTIVATE</span> <span class="o">|</span> <span class="n">REQUEST</span>:
		<span class="n">B_L2L1</span><span class="p">(</span><span class="n">b_if</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span>:
	<span class="k">case</span> <span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">INDICATION</span>:</pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>FIXME lock?</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">B_L2L1</span><span class="p">(</span><span class="n">b_if</span><span class="p">,</span> <span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">REQUEST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">))</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">FLG_L1_PULL_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">REQUEST</span>:
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">B_L2L1</span><span class="p">(</span><span class="n">b_if</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hisax_bc_setstack</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hisax_d_if</span> <span class="o">*</span><span class="n">hisax_d_if</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hisax_d_if</span><span class="p">;</span>

	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bc</span><span class="p">;</span>

	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">b_if</span> <span class="o">=</span> <span class="n">hisax_d_if</span><span class="o">-&gt;</span><span class="n">b_if</span><span class="p">[</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bc</span><span class="p">];</span>
	<span class="n">hisax_d_if</span><span class="o">-&gt;</span><span class="n">b_if</span><span class="p">[</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bc</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">bcs</span><span class="p">;</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">bcs</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2l1</span> <span class="o">=</span> <span class="n">hisax_b_l2l1</span><span class="p">;</span>
	<span class="n">setstack_manager</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="p">;</span>
	<span class="n">setstack_l1_B</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rqueue</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hisax_bc_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hisax_b_if</span> <span class="o">*</span><span class="n">b_if</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">b_if</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_if</span><span class="p">)</span>
		<span class="n">B_L2L1</span><span class="p">(</span><span class="n">b_if</span><span class="p">,</span> <span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">EChannel_proc_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">hisax_d_if</span> <span class="o">*</span><span class="n">d_if</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">d_if</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d_if</span><span class="o">-&gt;</span><span class="n">erq</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_HEX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dlog</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MAX_DLOG_SPACE</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;E&#39;</span><span class="p">;</span>
				<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;C&#39;</span><span class="p">;</span>
				<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;H&#39;</span><span class="p">;</span>
				<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;O&#39;</span><span class="p">;</span>
				<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
				<span class="n">ptr</span> <span class="o">+=</span> <span class="n">QuickHex</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
				<span class="n">ptr</span><span class="o">--</span><span class="p">;</span>
				<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
				<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">HiSax_putstatus</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dlog</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">HiSax_putstatus</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;LogEcho: &quot;</span><span class="p">,</span>
						<span class="s">&quot;warning Frame too big (%d)&quot;</span><span class="p">,</span>
						<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">hisax_pci_tbl</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="n">__used</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_HISAX_FRITZPCI</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">AVM</span><span class="p">,</span>      <span class="n">PCI_DEVICE_ID_AVM_A1</span><span class="p">)</span>			<span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_HISAX_DIEHLDIVA</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">EICON</span><span class="p">,</span>    <span class="n">PCI_DEVICE_ID_EICON_DIVA20</span><span class="p">)</span>		<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">EICON</span><span class="p">,</span>    <span class="n">PCI_DEVICE_ID_EICON_DIVA20_U</span><span class="p">)</span>	<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">EICON</span><span class="p">,</span>    <span class="n">PCI_DEVICE_ID_EICON_DIVA201</span><span class="p">)</span>		<span class="p">},</span>
<span class="cm">/*##########################################################################*/</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">EICON</span><span class="p">,</span>    <span class="n">PCI_DEVICE_ID_EICON_DIVA202</span><span class="p">)</span>		<span class="p">},</span>
<span class="cm">/*##########################################################################*/</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_HISAX_ELSA</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ELSA</span><span class="p">,</span>     <span class="n">PCI_DEVICE_ID_ELSA_MICROLINK</span><span class="p">)</span>	<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ELSA</span><span class="p">,</span>     <span class="n">PCI_DEVICE_ID_ELSA_QS3000</span><span class="p">)</span>		<span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_HISAX_GAZEL</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">PLX</span><span class="p">,</span>      <span class="n">PCI_DEVICE_ID_PLX_R685</span><span class="p">)</span>			<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">PLX</span><span class="p">,</span>      <span class="n">PCI_DEVICE_ID_PLX_R753</span><span class="p">)</span>			<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">PLX</span><span class="p">,</span>      <span class="n">PCI_DEVICE_ID_PLX_DJINN_ITOO</span><span class="p">)</span>	<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">PLX</span><span class="p">,</span>      <span class="n">PCI_DEVICE_ID_PLX_OLITEC</span><span class="p">)</span>		<span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_HISAX_SCT_QUADRO</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">PLX</span><span class="p">,</span>      <span class="n">PCI_DEVICE_ID_PLX_9050</span><span class="p">)</span>			<span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_HISAX_NICCY</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">SATSAGEM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_SATSAGEM_NICCY</span><span class="p">)</span>	<span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_HISAX_SEDLBAUER</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">TIGERJET</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGERJET_100</span><span class="p">)</span>		<span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_HISAX_NETJET) || defined(CONFIG_HISAX_NETJET_U)</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">TIGERJET</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGERJET_300</span><span class="p">)</span>		<span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_HISAX_TELESPCI) || defined(CONFIG_HISAX_SCT_QUADRO)</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ZORAN</span><span class="p">,</span>    <span class="n">PCI_DEVICE_ID_ZORAN_36120</span><span class="p">)</span>		<span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_HISAX_W6692</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">DYNALINK</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_DYNALINK_IS64PH</span><span class="p">)</span>	<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">WINBOND2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_WINBOND2_6692</span><span class="p">)</span>		<span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_HISAX_HFC_PCI</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span>      <span class="n">PCI_DEVICE_ID_CCD_2BD0</span><span class="p">)</span>			<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span>      <span class="n">PCI_DEVICE_ID_CCD_B000</span><span class="p">)</span>			<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span>      <span class="n">PCI_DEVICE_ID_CCD_B006</span><span class="p">)</span>			<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span>      <span class="n">PCI_DEVICE_ID_CCD_B007</span><span class="p">)</span>			<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span>      <span class="n">PCI_DEVICE_ID_CCD_B008</span><span class="p">)</span>			<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span>      <span class="n">PCI_DEVICE_ID_CCD_B009</span><span class="p">)</span>			<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span>      <span class="n">PCI_DEVICE_ID_CCD_B00A</span><span class="p">)</span>			<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span>      <span class="n">PCI_DEVICE_ID_CCD_B00B</span><span class="p">)</span>			<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span>      <span class="n">PCI_DEVICE_ID_CCD_B00C</span><span class="p">)</span>			<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span>      <span class="n">PCI_DEVICE_ID_CCD_B100</span><span class="p">)</span>			<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span>      <span class="n">PCI_DEVICE_ID_CCD_B700</span><span class="p">)</span>			<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span>      <span class="n">PCI_DEVICE_ID_CCD_B701</span><span class="p">)</span>			<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ABOCOM</span><span class="p">,</span>   <span class="n">PCI_DEVICE_ID_ABOCOM_2BD1</span><span class="p">)</span>		<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ASUSTEK</span><span class="p">,</span>  <span class="n">PCI_DEVICE_ID_ASUSTEK_0675</span><span class="p">)</span>		<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BERKOM</span><span class="p">,</span>   <span class="n">PCI_DEVICE_ID_BERKOM_T_CONCEPT</span><span class="p">)</span>	<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BERKOM</span><span class="p">,</span>   <span class="n">PCI_DEVICE_ID_BERKOM_A1T</span><span class="p">)</span>		<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ANIGMA</span><span class="p">,</span>   <span class="n">PCI_DEVICE_ID_ANIGMA_MC145575</span><span class="p">)</span>	<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ZOLTRIX</span><span class="p">,</span>  <span class="n">PCI_DEVICE_ID_ZOLTRIX_2BD0</span><span class="p">)</span>		<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">DIGI</span><span class="p">,</span>     <span class="n">PCI_DEVICE_ID_DIGI_DF_M_IOM2_E</span><span class="p">)</span>	<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">DIGI</span><span class="p">,</span>     <span class="n">PCI_DEVICE_ID_DIGI_DF_M_E</span><span class="p">)</span>		<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">DIGI</span><span class="p">,</span>     <span class="n">PCI_DEVICE_ID_DIGI_DF_M_IOM2_A</span><span class="p">)</span>	<span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">DIGI</span><span class="p">,</span>     <span class="n">PCI_DEVICE_ID_DIGI_DF_M_A</span><span class="p">)</span>		<span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{</span> <span class="p">}</span>				<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">hisax_pci_tbl</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="n">module_init</span><span class="p">(</span><span class="n">HiSax_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">HiSax_exit</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">FsmNew</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">FsmFree</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">FsmEvent</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">FsmChangeState</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">FsmInitTimer</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">FsmDelTimer</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">FsmRestartTimer</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
