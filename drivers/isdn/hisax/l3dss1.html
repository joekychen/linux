<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hisax › l3dss1.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>l3dss1.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: l3dss1.c,v 2.32.2.3 2004/01/13 14:31:25 keil Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * EURO/DSS1 D-channel protocol</span>
<span class="cm"> *</span>
<span class="cm"> * German 1TR6 D-channel protocol</span>
<span class="cm"> *</span>
<span class="cm"> * Author       Karsten Keil</span>
<span class="cm"> *              based on the teles driver from Jan den Ouden</span>
<span class="cm"> * Copyright    by Karsten Keil      &lt;keil@isdn4linux.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> * For changes and modifications please read</span>
<span class="cm"> * Documentation/isdn/HiSax.cert</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to    Jan den Ouden</span>
<span class="cm"> *              Fritz Elfert</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;hisax.h&quot;</span>
<span class="cp">#include &quot;isdnl3.h&quot;</span>
<span class="cp">#include &quot;l3dss1.h&quot;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="k">extern</span> <span class="kt">char</span> <span class="o">*</span><span class="n">HiSax_getrev</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">revision</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dss1_revision</span> <span class="o">=</span> <span class="s">&quot;$Revision: 2.32.2.3 $&quot;</span><span class="p">;</span>

<span class="cp">#define EXT_BEARER_CAPS 1</span>

<span class="cp">#define	MsgHead(ptr, cref, mty)			\</span>
<span class="cp">	*ptr++ = 0x8;				\</span>
<span class="cp">	if (cref == -1) {			\</span>
<span class="cp">		*ptr++ = 0x0;			\</span>
<span class="cp">	} else {				\</span>
<span class="cp">		*ptr++ = 0x1;			\</span>
<span class="cp">		*ptr++ = cref^0x80;		\</span>
<span class="cp">	}					\</span>
<span class="cp">	*ptr++ = mty</span>


<span class="cm">/**********************************************/</span>
<span class="cm">/* get a new invoke id for remote operations. */</span>
<span class="cm">/* Only a return value != 0 is valid          */</span>
<span class="cm">/**********************************************/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">new_invoke_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span> <span class="cm">/* maximum search depth */</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">last_invoke_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* try new id */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">i</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_used</span><span class="p">[</span><span class="n">retval</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">last_invoke_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&amp;</span> <span class="mh">0xF8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_used</span><span class="p">[</span><span class="n">retval</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)))</span>
			<span class="n">retval</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">last_invoke_id</span> <span class="o">=</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_used</span><span class="p">[</span><span class="n">retval</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">retval</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* new_invoke_id */</span>

<span class="cm">/*************************/</span>
<span class="cm">/* free a used invoke id */</span>
<span class="cm">/*************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_invoke_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="cm">/* 0 = invalid value */</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_used</span><span class="p">[</span><span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>
<span class="p">}</span> <span class="cm">/* free_invoke_id */</span>


<span class="cm">/**********************************************************/</span>
<span class="cm">/* create a new l3 process and fill in dss1 specific data */</span>
<span class="cm">/**********************************************************/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">l3_process</span>
<span class="o">*</span><span class="nf">dss1_new_l3_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cr</span><span class="p">)</span>
<span class="p">{</span>  <span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">proc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">proc</span> <span class="o">=</span> <span class="n">new_l3_process</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">cr</span><span class="p">)))</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

	<span class="n">proc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">proc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">remote_operation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">proc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">uus1_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">proc</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* dss1_new_l3_process */</span>

<span class="cm">/************************************************/</span>
<span class="cm">/* free a l3 process and all dss1 specific data */</span>
<span class="cm">/************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dss1_release_l3_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_invoke_id</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span><span class="p">);</span>
	<span class="n">release_l3_process</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* dss1_release_l3_process */</span>

<span class="cm">/********************************************************/</span>
<span class="cm">/* search a process with invoke id id and dummy callref */</span>
<span class="cm">/********************************************************/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span>
<span class="nf">l3dss1_search_dummy_proc</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span> <span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">proc</span><span class="p">;</span> <span class="cm">/* start of processes */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pc</span><span class="p">)</span>
	<span class="p">{</span> <span class="k">if</span> <span class="p">((</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">callref</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span> <span class="o">==</span> <span class="n">id</span><span class="p">))</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">pc</span><span class="p">);</span>
		<span class="n">pc</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* l3dss1_search_dummy_proc */</span>

<span class="cm">/*******************************************************************/</span>
<span class="cm">/* called when a facility message with a dummy callref is received */</span>
<span class="cm">/* and a return result is delivered. id specifies the invoke id.   */</span>
<span class="cm">/*******************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_dummy_return_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">nlen</span><span class="p">)</span>
<span class="p">{</span> <span class="n">isdn_ctrl</span> <span class="n">ic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pc</span> <span class="o">=</span> <span class="n">l3dss1_search_dummy_proc</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">id</span><span class="p">)))</span>
	<span class="p">{</span> <span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span> <span class="cm">/* remove timer */</span>

		<span class="n">cs</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_PROT</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">DSS1_STAT_INVOKE_RES</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">hl_id</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">ll_id</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">ll_id</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">proc</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">proc</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">datalen</span> <span class="o">=</span> <span class="n">nlen</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
		<span class="n">free_invoke_id</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span><span class="p">);</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* reset id */</span>

		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">);</span>
		<span class="n">dss1_release_l3_process</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;dummy return result id=0x%x result len=%d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">nlen</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* l3dss1_dummy_return_result */</span>

<span class="cm">/*******************************************************************/</span>
<span class="cm">/* called when a facility message with a dummy callref is received */</span>
<span class="cm">/* and a return error is delivered. id specifies the invoke id.    */</span>
<span class="cm">/*******************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_dummy_error_return</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span> <span class="n">isdn_ctrl</span> <span class="n">ic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pc</span> <span class="o">=</span> <span class="n">l3dss1_search_dummy_proc</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">id</span><span class="p">)))</span>
	<span class="p">{</span> <span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span> <span class="cm">/* remove timer */</span>

		<span class="n">cs</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_PROT</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">DSS1_STAT_INVOKE_ERR</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">hl_id</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">ll_id</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">ll_id</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">proc</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">proc</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">datalen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">free_invoke_id</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span><span class="p">);</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* reset id */</span>

		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">);</span>
		<span class="n">dss1_release_l3_process</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;dummy return error id=0x%x error=0x%lx&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* l3dss1_error_return */</span>

<span class="cm">/*******************************************************************/</span>
<span class="cm">/* called when a facility message with a dummy callref is received */</span>
<span class="cm">/* and a invoke is delivered. id specifies the invoke id.          */</span>
<span class="cm">/*******************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_dummy_invoke</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">ident</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">nlen</span><span class="p">)</span>
<span class="p">{</span> <span class="n">isdn_ctrl</span> <span class="n">ic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">;</span>

	<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;dummy invoke %s id=0x%x ident=0x%x datalen=%d&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">cr</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;local&quot;</span> <span class="o">:</span> <span class="s">&quot;broadcast&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">nlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cr</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="cm">/* ignore local data */</span>

	<span class="n">cs</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_PROT</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">DSS1_STAT_INVOKE_BRD</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">hl_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">ll_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">proc</span> <span class="o">=</span> <span class="n">ident</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">datalen</span> <span class="o">=</span> <span class="n">nlen</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* l3dss1_dummy_invoke */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_parse_facility</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">cr</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">qd_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ilen</span><span class="p">,</span> <span class="n">cp_tag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ident</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">err_ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="p">)</span>
		<span class="n">st</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">;</span> <span class="cm">/* valid Stack */</span>
	<span class="k">else</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">st</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cr</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span> <span class="cm">/* neither pc nor st specified */</span>

	<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="n">qd_len</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qd_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;qd_len == 0&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x11</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Service discriminator, supplementary service */</span>
		<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;supplementary service != 0x11&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">qd_len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* extension ? */</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">qd_len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qd_len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;qd_len &lt; 2&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="n">qd_len</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0xE0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xA0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* class and form */</span>
		<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;class and form != 0xA0&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cp_tag</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">;</span> <span class="cm">/* remember tag value */</span>

	<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="n">qd_len</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qd_len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span> <span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;qd_len &lt; 1&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
	<span class="p">{</span> <span class="cm">/* length format indefinite or limited */</span>
		<span class="n">nlen</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span> <span class="cm">/* number of len bytes or indefinite */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">qd_len</span><span class="o">--</span> <span class="o">&lt;</span> <span class="p">((</span><span class="o">!</span><span class="n">nlen</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nlen</span><span class="p">)))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">nlen</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="p">{</span> <span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;length format error or not implemented&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nlen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="p">{</span> <span class="n">nlen</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* complete length */</span>
			<span class="n">qd_len</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span> <span class="n">qd_len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* trailing null bytes */</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">qd_len</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">qd_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
			<span class="p">{</span> <span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;length format indefinite error&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">nlen</span> <span class="o">=</span> <span class="n">qd_len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span> <span class="n">nlen</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">qd_len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qd_len</span> <span class="o">&lt;</span> <span class="n">nlen</span><span class="p">)</span>
	<span class="p">{</span> <span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;qd_len &lt; nlen&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qd_len</span> <span class="o">-=</span> <span class="n">nlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nlen</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
	<span class="p">{</span> <span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;nlen &lt; 2&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="mh">0x02</span><span class="p">)</span>
	<span class="p">{</span>  <span class="cm">/* invoke identifier tag */</span>
		<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;invoke identifier tag !=0x02&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="n">nlen</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
	<span class="p">{</span> <span class="cm">/* length format */</span>
		<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;invoke id length format 2&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ilen</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="n">nlen</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ilen</span> <span class="o">&gt;</span> <span class="n">nlen</span> <span class="o">||</span> <span class="n">ilen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span> <span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;ilen &gt; nlen || ilen == 0&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nlen</span> <span class="o">-=</span> <span class="n">ilen</span><span class="p">;</span>
	<span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ilen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span> <span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>	<span class="cm">/* invoke identifier */</span>
		<span class="n">ilen</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cp_tag</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* component tag */</span>
	<span class="k">case</span> <span class="mi">1</span>:	<span class="cm">/* invoke */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nlen</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;nlen &lt; 2 22&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* operation value */</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;operation value !=0x02&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">nlen</span><span class="o">--</span><span class="p">;</span>
		<span class="n">ilen</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">nlen</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ilen</span> <span class="o">&gt;</span> <span class="n">nlen</span> <span class="o">||</span> <span class="n">ilen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;ilen &gt; nlen || ilen == 0 22&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nlen</span> <span class="o">-=</span> <span class="n">ilen</span><span class="p">;</span>
		<span class="n">ident</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">ilen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ident</span> <span class="o">=</span> <span class="p">(</span><span class="n">ident</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
			<span class="n">ilen</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pc</span><span class="p">)</span>
		<span class="p">{</span> <span class="n">l3dss1_dummy_invoke</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">nlen</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef CONFIG_DE_AOC</span>
		<span class="p">{</span>

<span class="cp">#define FOO1(s, a, b)							\</span>
<span class="cp">			while (nlen &gt; 1) {				\</span>
<span class="cp">				int ilen = p[1];			\</span>
<span class="cp">				if (nlen &lt; ilen + 2) {			\</span>
<span class="cp">					l3_debug(st, &quot;FOO1  nlen &lt; ilen+2&quot;); \</span>
<span class="cp">					return;				\</span>
<span class="cp">				}					\</span>
<span class="cp">				nlen -= ilen + 2;			\</span>
<span class="cp">				if ((*p &amp; 0xFF) == (a)) {		\</span>
<span class="cp">					int nlen = ilen;		\</span>
<span class="cp">					p += 2;				\</span>
<span class="cp">					b;				\</span>
<span class="cp">				} else {				\</span>
<span class="cp">					p += ilen + 2;			\</span>
<span class="cp">				}					\</span>
<span class="cp">			}</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">ident</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x22</span>:	<span class="cm">/* during */</span>
				<span class="n">FOO1</span><span class="p">(</span><span class="s">&quot;1A&quot;</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">FOO1</span><span class="p">(</span><span class="s">&quot;1C&quot;</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="n">FOO1</span><span class="p">(</span><span class="s">&quot;1D&quot;</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">FOO1</span><span class="p">(</span><span class="s">&quot;1E&quot;</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="p">(</span> <span class="p">{</span>
										<span class="n">ident</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
										<span class="n">nlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">nlen</span><span class="p">)</span> <span class="o">?</span> <span class="n">nlen</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Make gcc happy */</span>
										<span class="k">while</span> <span class="p">(</span><span class="n">ilen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
											<span class="n">ident</span> <span class="o">=</span> <span class="p">(</span><span class="n">ident</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
											<span class="n">ilen</span><span class="o">--</span><span class="p">;</span>
										<span class="p">}</span>
										<span class="k">if</span> <span class="p">(</span><span class="n">ident</span> <span class="o">&gt;</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">chargeinfo</span><span class="p">)</span> <span class="p">{</span>
											<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">chargeinfo</span> <span class="o">=</span> <span class="n">ident</span><span class="p">;</span>
											<span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_CHARGE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
										<span class="p">}</span>
										<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_CHARGE</span><span class="p">)</span> <span class="p">{</span>
											<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
												<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;charging info during %d&quot;</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">chargeinfo</span><span class="p">);</span>
											<span class="p">}</span>
											<span class="k">else</span> <span class="p">{</span>
												<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;charging info final %d&quot;</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">chargeinfo</span><span class="p">);</span>
											<span class="p">}</span>
										<span class="p">}</span>
									<span class="p">}</span>
									<span class="p">)))))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x24</span>:	<span class="cm">/* final */</span>
				<span class="n">FOO1</span><span class="p">(</span><span class="s">&quot;2A&quot;</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">FOO1</span><span class="p">(</span><span class="s">&quot;2B&quot;</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">FOO1</span><span class="p">(</span><span class="s">&quot;2C&quot;</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="n">FOO1</span><span class="p">(</span><span class="s">&quot;2D&quot;</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">FOO1</span><span class="p">(</span><span class="s">&quot;2E&quot;</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="p">(</span> <span class="p">{</span>
											<span class="n">ident</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
											<span class="n">nlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">nlen</span><span class="p">)</span> <span class="o">?</span> <span class="n">nlen</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Make gcc happy */</span>
											<span class="k">while</span> <span class="p">(</span><span class="n">ilen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
												<span class="n">ident</span> <span class="o">=</span> <span class="p">(</span><span class="n">ident</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
												<span class="n">ilen</span><span class="o">--</span><span class="p">;</span>
											<span class="p">}</span>
											<span class="k">if</span> <span class="p">(</span><span class="n">ident</span> <span class="o">&gt;</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">chargeinfo</span><span class="p">)</span> <span class="p">{</span>
												<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">chargeinfo</span> <span class="o">=</span> <span class="n">ident</span><span class="p">;</span>
												<span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_CHARGE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
											<span class="p">}</span>
											<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_CHARGE</span><span class="p">)</span> <span class="p">{</span>
												<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;charging info final %d&quot;</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">chargeinfo</span><span class="p">);</span>
											<span class="p">}</span>
										<span class="p">}</span>
										<span class="p">))))))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;invoke break invalid ident %02x&quot;</span><span class="p">,</span> <span class="n">ident</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#undef FOO1</span>

		<span class="p">}</span>
<span class="cp">#else  </span><span class="cm">/* not CONFIG_DE_AOC */</span><span class="cp"></span>
		<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;invoke break&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* not CONFIG_DE_AOC */</span><span class="cp"></span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:	<span class="cm">/* return result */</span>
		<span class="cm">/* if no process available handle separately */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pc</span><span class="p">)</span>
		<span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="n">cr</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">l3dss1_dummy_return_result</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">nlen</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span> <span class="o">==</span> <span class="n">id</span><span class="p">))</span>
		<span class="p">{</span> <span class="cm">/* Diversion successful */</span>
			<span class="n">free_invoke_id</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span><span class="p">);</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">remote_result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* success */</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">redir_result</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">remote_result</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_REDIR</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>                                  <span class="p">}</span> <span class="cm">/* Diversion successful */</span>
		<span class="k">else</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;return error unknown identifier&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:	<span class="cm">/* return error */</span>
		<span class="n">err_ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nlen</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="p">{</span> <span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;return error nlen &lt; 2&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="mh">0x02</span><span class="p">)</span>
		<span class="p">{</span> <span class="cm">/* result tag */</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;invoke error tag !=0x02&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">nlen</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="p">{</span> <span class="cm">/* length format */</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;invoke return errlen &gt; 4 &quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ilen</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">nlen</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ilen</span> <span class="o">&gt;</span> <span class="n">nlen</span> <span class="o">||</span> <span class="n">ilen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span> <span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;error return ilen &gt; nlen || ilen == 0&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nlen</span> <span class="o">-=</span> <span class="n">ilen</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">ilen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span> <span class="n">err_ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">err_ret</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>	<span class="cm">/* error value */</span>
			<span class="n">ilen</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* if no process available handle separately */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pc</span><span class="p">)</span>
		<span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="n">cr</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">l3dss1_dummy_error_return</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">err_ret</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span> <span class="o">==</span> <span class="n">id</span><span class="p">))</span>
		<span class="p">{</span> <span class="cm">/* Deflection error */</span>
			<span class="n">free_invoke_id</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span><span class="p">);</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">remote_result</span> <span class="o">=</span> <span class="n">err_ret</span><span class="p">;</span> <span class="cm">/* result */</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">redir_result</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">remote_result</span><span class="p">;</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_REDIR</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
		<span class="p">}</span> <span class="cm">/* Deflection error */</span>
		<span class="k">else</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;return result unknown identifier&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;facility default break tag=0x%02x&quot;</span><span class="p">,</span> <span class="n">cp_tag</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">mt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">l3_alloc_skb</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">MsgHead</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">callref</span><span class="p">,</span> <span class="n">mt</span><span class="p">);</span>
	<span class="n">l3_msg</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_message_cause</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">mt</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">cause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">MsgHead</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">callref</span><span class="p">,</span> <span class="n">mt</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_CAUSE</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">cause</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">l3_alloc_skb</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
	<span class="n">l3_msg</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_status_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">MsgHead</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">callref</span><span class="p">,</span> <span class="n">MT_STATUS</span><span class="p">);</span>

	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_CAUSE</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_CALL_STATE</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">l3_alloc_skb</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
	<span class="n">l3_msg</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_msg_without_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This routine is called if here was no SETUP made (checks in dss1up and in</span>
<span class="cm">	 * l3dss1_setup) and a RELEASE_COMPLETE have to be sent with an error code</span>
<span class="cm">	 * MT_STATUS_ENQUIRE in the NULL state is handled too</span>
<span class="cm">	 */</span>
	<span class="n">u_char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">81</span>:	<span class="cm">/* invalid callreference */</span>
	<span class="k">case</span> <span class="mi">88</span>:	<span class="cm">/* incomp destination */</span>
	<span class="k">case</span> <span class="mi">96</span>:	<span class="cm">/* mandory IE missing */</span>
	<span class="k">case</span> <span class="mi">100</span>:       <span class="cm">/* invalid IE contents */</span>
	<span class="k">case</span> <span class="mi">101</span>:	<span class="cm">/* incompatible Callstate */</span>
		<span class="n">MsgHead</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">callref</span><span class="p">,</span> <span class="n">MT_RELEASE_COMPLETE</span><span class="p">);</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_CAUSE</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;HiSax l3dss1_msg_without_setup wrong cause %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">l3_alloc_skb</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
	<span class="n">l3_msg</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">dss1_release_l3_process</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ie_ALERTING</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">IE_BEARER</span><span class="p">,</span> <span class="n">IE_CHANNEL_ID</span> <span class="o">|</span> <span class="n">IE_MANDATORY_1</span><span class="p">,</span>
			    <span class="n">IE_FACILITY</span><span class="p">,</span> <span class="n">IE_PROGRESS</span><span class="p">,</span> <span class="n">IE_DISPLAY</span><span class="p">,</span> <span class="n">IE_SIGNAL</span><span class="p">,</span> <span class="n">IE_HLC</span><span class="p">,</span>
			    <span class="n">IE_USER_USER</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ie_CALL_PROCEEDING</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">IE_BEARER</span><span class="p">,</span> <span class="n">IE_CHANNEL_ID</span> <span class="o">|</span> <span class="n">IE_MANDATORY_1</span><span class="p">,</span>
				   <span class="n">IE_FACILITY</span><span class="p">,</span> <span class="n">IE_PROGRESS</span><span class="p">,</span> <span class="n">IE_DISPLAY</span><span class="p">,</span> <span class="n">IE_HLC</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ie_CONNECT</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">IE_BEARER</span><span class="p">,</span> <span class="n">IE_CHANNEL_ID</span> <span class="o">|</span> <span class="n">IE_MANDATORY_1</span><span class="p">,</span>
			   <span class="n">IE_FACILITY</span><span class="p">,</span> <span class="n">IE_PROGRESS</span><span class="p">,</span> <span class="n">IE_DISPLAY</span><span class="p">,</span> <span class="n">IE_DATE</span><span class="p">,</span> <span class="n">IE_SIGNAL</span><span class="p">,</span>
			   <span class="n">IE_CONNECT_PN</span><span class="p">,</span> <span class="n">IE_CONNECT_SUB</span><span class="p">,</span> <span class="n">IE_LLC</span><span class="p">,</span> <span class="n">IE_HLC</span><span class="p">,</span> <span class="n">IE_USER_USER</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ie_CONNECT_ACKNOWLEDGE</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">IE_CHANNEL_ID</span><span class="p">,</span> <span class="n">IE_DISPLAY</span><span class="p">,</span> <span class="n">IE_SIGNAL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ie_DISCONNECT</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">IE_CAUSE</span> <span class="o">|</span> <span class="n">IE_MANDATORY</span><span class="p">,</span> <span class="n">IE_FACILITY</span><span class="p">,</span>
			      <span class="n">IE_PROGRESS</span><span class="p">,</span> <span class="n">IE_DISPLAY</span><span class="p">,</span> <span class="n">IE_SIGNAL</span><span class="p">,</span> <span class="n">IE_USER_USER</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ie_INFORMATION</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">IE_COMPLETE</span><span class="p">,</span> <span class="n">IE_DISPLAY</span><span class="p">,</span> <span class="n">IE_KEYPAD</span><span class="p">,</span> <span class="n">IE_SIGNAL</span><span class="p">,</span>
			       <span class="n">IE_CALLED_PN</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ie_NOTIFY</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">IE_BEARER</span><span class="p">,</span> <span class="n">IE_NOTIFY</span> <span class="o">|</span> <span class="n">IE_MANDATORY</span><span class="p">,</span> <span class="n">IE_DISPLAY</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ie_PROGRESS</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">IE_BEARER</span><span class="p">,</span> <span class="n">IE_CAUSE</span><span class="p">,</span> <span class="n">IE_FACILITY</span><span class="p">,</span> <span class="n">IE_PROGRESS</span> <span class="o">|</span>
			    <span class="n">IE_MANDATORY</span><span class="p">,</span> <span class="n">IE_DISPLAY</span><span class="p">,</span> <span class="n">IE_HLC</span><span class="p">,</span> <span class="n">IE_USER_USER</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ie_RELEASE</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">IE_CAUSE</span> <span class="o">|</span> <span class="n">IE_MANDATORY_1</span><span class="p">,</span> <span class="n">IE_FACILITY</span><span class="p">,</span> <span class="n">IE_DISPLAY</span><span class="p">,</span>
			   <span class="n">IE_SIGNAL</span><span class="p">,</span> <span class="n">IE_USER_USER</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="cm">/* a RELEASE_COMPLETE with errors don&#39;t require special actions</span>
<span class="cm">   static int ie_RELEASE_COMPLETE[] = {IE_CAUSE | IE_MANDATORY_1, IE_DISPLAY, IE_SIGNAL, IE_USER_USER, -1};</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ie_RESUME_ACKNOWLEDGE</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">IE_CHANNEL_ID</span> <span class="o">|</span> <span class="n">IE_MANDATORY</span><span class="p">,</span> <span class="n">IE_FACILITY</span><span class="p">,</span>
				      <span class="n">IE_DISPLAY</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ie_RESUME_REJECT</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">IE_CAUSE</span> <span class="o">|</span> <span class="n">IE_MANDATORY</span><span class="p">,</span> <span class="n">IE_DISPLAY</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ie_SETUP</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">IE_COMPLETE</span><span class="p">,</span> <span class="n">IE_BEARER</span>  <span class="o">|</span> <span class="n">IE_MANDATORY</span><span class="p">,</span>
			 <span class="n">IE_CHANNEL_ID</span> <span class="o">|</span> <span class="n">IE_MANDATORY</span><span class="p">,</span> <span class="n">IE_FACILITY</span><span class="p">,</span> <span class="n">IE_PROGRESS</span><span class="p">,</span>
			 <span class="n">IE_NET_FAC</span><span class="p">,</span> <span class="n">IE_DISPLAY</span><span class="p">,</span> <span class="n">IE_KEYPAD</span><span class="p">,</span> <span class="n">IE_SIGNAL</span><span class="p">,</span> <span class="n">IE_CALLING_PN</span><span class="p">,</span>
			 <span class="n">IE_CALLING_SUB</span><span class="p">,</span> <span class="n">IE_CALLED_PN</span><span class="p">,</span> <span class="n">IE_CALLED_SUB</span><span class="p">,</span> <span class="n">IE_REDIR_NR</span><span class="p">,</span>
			 <span class="n">IE_LLC</span><span class="p">,</span> <span class="n">IE_HLC</span><span class="p">,</span> <span class="n">IE_USER_USER</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ie_SETUP_ACKNOWLEDGE</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">IE_CHANNEL_ID</span> <span class="o">|</span> <span class="n">IE_MANDATORY</span><span class="p">,</span> <span class="n">IE_FACILITY</span><span class="p">,</span>
				     <span class="n">IE_PROGRESS</span><span class="p">,</span> <span class="n">IE_DISPLAY</span><span class="p">,</span> <span class="n">IE_SIGNAL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ie_STATUS</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">IE_CAUSE</span> <span class="o">|</span> <span class="n">IE_MANDATORY</span><span class="p">,</span> <span class="n">IE_CALL_STATE</span> <span class="o">|</span>
			  <span class="n">IE_MANDATORY</span><span class="p">,</span> <span class="n">IE_DISPLAY</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ie_STATUS_ENQUIRY</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">IE_DISPLAY</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ie_SUSPEND_ACKNOWLEDGE</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">IE_DISPLAY</span><span class="p">,</span> <span class="n">IE_FACILITY</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ie_SUSPEND_REJECT</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">IE_CAUSE</span> <span class="o">|</span> <span class="n">IE_MANDATORY</span><span class="p">,</span> <span class="n">IE_DISPLAY</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="cm">/* not used</span>
<span class="cm"> * static int ie_CONGESTION_CONTROL[] = {IE_CONGESTION | IE_MANDATORY,</span>
<span class="cm"> *		IE_CAUSE | IE_MANDATORY, IE_DISPLAY, -1};</span>
<span class="cm"> * static int ie_USER_INFORMATION[] = {IE_MORE_DATA, IE_USER_USER | IE_MANDATORY, -1};</span>
<span class="cm"> * static int ie_RESTART[] = {IE_CHANNEL_ID, IE_DISPLAY, IE_RESTART_IND |</span>
<span class="cm"> *		IE_MANDATORY, -1};</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ie_FACILITY</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">IE_FACILITY</span> <span class="o">|</span> <span class="n">IE_MANDATORY</span><span class="p">,</span> <span class="n">IE_DISPLAY</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">comp_required</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">l3_valid_states</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>

<span class="k">struct</span> <span class="n">ie_len</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">ie</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span>
<span class="k">struct</span> <span class="n">ie_len</span> <span class="n">max_ie_len</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">IE_SEGMENT</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_BEARER</span><span class="p">,</span> <span class="mi">12</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_CAUSE</span><span class="p">,</span> <span class="mi">32</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_CALL_ID</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_CALL_STATE</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_CHANNEL_ID</span><span class="p">,</span>	<span class="mi">34</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_FACILITY</span><span class="p">,</span> <span class="mi">255</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_PROGRESS</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_NET_FAC</span><span class="p">,</span> <span class="mi">255</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_NOTIFY</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_DISPLAY</span><span class="p">,</span> <span class="mi">82</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_DATE</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_KEYPAD</span><span class="p">,</span> <span class="mi">34</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_SIGNAL</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_INFORATE</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_E2E_TDELAY</span><span class="p">,</span> <span class="mi">11</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_TDELAY_SEL</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_PACK_BINPARA</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_PACK_WINSIZE</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_PACK_SIZE</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_CUG</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_REV_CHARGE</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_CALLING_PN</span><span class="p">,</span> <span class="mi">24</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_CALLING_SUB</span><span class="p">,</span> <span class="mi">23</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_CALLED_PN</span><span class="p">,</span> <span class="mi">24</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_CALLED_SUB</span><span class="p">,</span> <span class="mi">23</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_REDIR_NR</span><span class="p">,</span> <span class="mi">255</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_TRANS_SEL</span><span class="p">,</span> <span class="mi">255</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_RESTART_IND</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_LLC</span><span class="p">,</span> <span class="mi">18</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_HLC</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span>
	<span class="p">{</span><span class="n">IE_USER_USER</span><span class="p">,</span> <span class="mi">131</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">getmax_ie_len</span><span class="p">(</span><span class="n">u_char</span> <span class="n">ie</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">max_ie_len</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ie</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max_ie_len</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ie</span> <span class="o">==</span> <span class="n">ie</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">max_ie_len</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">255</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ie_in_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">ie</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">checklist</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">checklist</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">checklist</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="n">ie</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ie</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
				<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ret</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ret</span><span class="o">++</span><span class="p">;</span>
		<span class="n">checklist</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">check_infoelements</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">checklist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">cl</span> <span class="o">=</span> <span class="n">checklist</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">mt</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">ie</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="n">newpos</span><span class="p">,</span> <span class="n">oldpos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err_compr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err_ureg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">codeset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">old_codeset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">codelock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="cm">/* skip cr */</span>
	<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">l</span><span class="p">;</span>
	<span class="n">mt</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="n">oldpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">p</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x90</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* shift codeset */</span>
			<span class="n">old_codeset</span> <span class="o">=</span> <span class="n">codeset</span><span class="p">;</span>
			<span class="n">codeset</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
				<span class="n">codelock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">codelock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_CHECK</span><span class="p">)</span>
				<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;check IE shift%scodeset %d-&gt;%d&quot;</span><span class="p">,</span>
					 <span class="n">codelock</span> <span class="o">?</span> <span class="s">&quot; locking &quot;</span> <span class="o">:</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">old_codeset</span><span class="p">,</span> <span class="n">codeset</span><span class="p">);</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codeset</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* only codeset 0 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">newpos</span> <span class="o">=</span> <span class="n">ie_in_set</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">cl</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">newpos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">newpos</span> <span class="o">&lt;</span> <span class="n">oldpos</span><span class="p">)</span>
						<span class="n">err_seq</span><span class="o">++</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">oldpos</span> <span class="o">=</span> <span class="n">newpos</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ie_in_set</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">comp_required</span><span class="p">))</span>
					<span class="n">err_compr</span><span class="o">++</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">err_ureg</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ie</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ie</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">l</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">l</span><span class="p">;</span>
			<span class="n">l</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codeset</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;</span> <span class="n">getmax_ie_len</span><span class="p">(</span><span class="n">ie</span><span class="p">)))</span>
			<span class="n">err_len</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codelock</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_CHECK</span><span class="p">)</span>
				<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;check IE shift back codeset %d-&gt;%d&quot;</span><span class="p">,</span>
					 <span class="n">codeset</span><span class="p">,</span> <span class="n">old_codeset</span><span class="p">);</span>
			<span class="n">codeset</span> <span class="o">=</span> <span class="n">old_codeset</span><span class="p">;</span>
			<span class="n">codelock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_compr</span> <span class="o">|</span> <span class="n">err_ureg</span> <span class="o">|</span> <span class="n">err_len</span> <span class="o">|</span> <span class="n">err_seq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_CHECK</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;check IE MT(%x) %d/%d/%d/%d&quot;</span><span class="p">,</span>
				 <span class="n">mt</span><span class="p">,</span> <span class="n">err_compr</span><span class="p">,</span> <span class="n">err_ureg</span><span class="p">,</span> <span class="n">err_len</span><span class="p">,</span> <span class="n">err_seq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err_compr</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">ERR_IE_COMPREHENSION</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err_ureg</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">ERR_IE_UNRECOGNIZED</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err_len</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">ERR_IE_LENGTH</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err_seq</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">ERR_IE_SEQUENCE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* verify if a message type exists and contain no IE error */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">l3dss1_check_messagetype_validity</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MT_ALERTING</span>:
	<span class="k">case</span> <span class="n">MT_CALL_PROCEEDING</span>:
	<span class="k">case</span> <span class="n">MT_CONNECT</span>:
	<span class="k">case</span> <span class="n">MT_CONNECT_ACKNOWLEDGE</span>:
	<span class="k">case</span> <span class="n">MT_DISCONNECT</span>:
	<span class="k">case</span> <span class="n">MT_INFORMATION</span>:
	<span class="k">case</span> <span class="n">MT_FACILITY</span>:
	<span class="k">case</span> <span class="n">MT_NOTIFY</span>:
	<span class="k">case</span> <span class="n">MT_PROGRESS</span>:
	<span class="k">case</span> <span class="n">MT_RELEASE</span>:
	<span class="k">case</span> <span class="n">MT_RELEASE_COMPLETE</span>:
	<span class="k">case</span> <span class="n">MT_SETUP</span>:
	<span class="k">case</span> <span class="n">MT_SETUP_ACKNOWLEDGE</span>:
	<span class="k">case</span> <span class="n">MT_RESUME_ACKNOWLEDGE</span>:
	<span class="k">case</span> <span class="n">MT_RESUME_REJECT</span>:
	<span class="k">case</span> <span class="n">MT_SUSPEND_ACKNOWLEDGE</span>:
	<span class="k">case</span> <span class="n">MT_SUSPEND_REJECT</span>:
	<span class="k">case</span> <span class="n">MT_USER_INFORMATION</span>:
	<span class="k">case</span> <span class="n">MT_RESTART</span>:
	<span class="k">case</span> <span class="n">MT_RESTART_ACKNOWLEDGE</span>:
	<span class="k">case</span> <span class="n">MT_CONGESTION_CONTROL</span>:
	<span class="k">case</span> <span class="n">MT_STATUS</span>:
	<span class="k">case</span> <span class="n">MT_STATUS_ENQUIRY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_CHECK</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;l3dss1_check_messagetype_validity mt(%x) OK&quot;</span><span class="p">,</span> <span class="n">mt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MT_RESUME</span>: <span class="cm">/* RESUME only in user-&gt;net */</span>
	<span class="k">case</span> <span class="n">MT_SUSPEND</span>: <span class="cm">/* SUSPEND only in user-&gt;net */</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">L3_DEB_CHECK</span> <span class="o">|</span> <span class="n">L3_DEB_WARN</span><span class="p">))</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;l3dss1_check_messagetype_validity mt(%x) fail&quot;</span><span class="p">,</span> <span class="n">mt</span><span class="p">);</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">97</span><span class="p">;</span>
		<span class="n">l3dss1_status_send</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_std_ie_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_CHECK</span><span class="p">)</span>
		<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;check_infoelements ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ERR_IE_COMPREHENSION</span>:
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="n">l3dss1_status_send</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ERR_IE_UNRECOGNIZED</span>:
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">99</span><span class="p">;</span>
		<span class="n">l3dss1_status_send</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ERR_IE_LENGTH</span>:
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">l3dss1_status_send</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ERR_IE_SEQUENCE</span>:
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">l3dss1_get_channel_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">IE_CHANNEL_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* len for BRI = 1 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
				<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;wrong chid len %d&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* only base rate interface */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
				<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;wrong chid %x&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">l3dss1_get_cause</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">u_char</span> <span class="n">l</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">loc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">IE_CAUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">loc</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="n">l</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">loc</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">l</span><span class="o">--</span><span class="p">;</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* skip recommendation */</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="n">l</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
				<span class="k">return</span> <span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">l</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">diag</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="n">l</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_msg_with_uus</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">16</span> <span class="o">+</span> <span class="mi">40</span><span class="p">];</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">MsgHead</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">callref</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">uus1_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="p">{</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_USER_USER</span><span class="p">;</span> <span class="cm">/* UUS info element */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">uus1_data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span> <span class="cm">/* IA5 chars */</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">uus1_data</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">uus1_data</span><span class="p">);</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">uus1_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">l3_alloc_skb</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
	<span class="n">l3_msg</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* l3dss1_msg_with_uus */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_release_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">StopAllL3Timer</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">uus1_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">l3dss1_message</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">MT_RELEASE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">l3dss1_msg_with_uus</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">MT_RELEASE</span><span class="p">);</span>
	<span class="n">L3AddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">T308</span><span class="p">,</span> <span class="n">CC_T308_1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_release_cmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">l3dss1_get_cause</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;RELCMPL get_cause ret(%d)&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="n">NO_CAUSE</span><span class="p">;</span>
	<span class="n">StopAllL3Timer</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_RELEASE</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
	<span class="n">dss1_release_l3_process</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef EXT_BEARER_CAPS</span>

<span class="k">static</span> <span class="n">u_char</span> <span class="o">*</span>
<span class="nf">EncodeASyncParams</span><span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">si2</span><span class="p">)</span>
<span class="p">{</span>				<span class="c1">// 7c 06 88  90 21 42 00 bb</span>

	<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>		<span class="c1">// Intermediate rate: 16 kbit/s jj 2000.02.19</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">si2</span> <span class="o">&amp;</span> <span class="mi">32</span><span class="p">)</span>		<span class="c1">// 7 data bits</span>

		<span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span>			<span class="c1">// 8 data bits</span>

		<span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">24</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">si2</span> <span class="o">&amp;</span> <span class="mi">16</span><span class="p">)</span>		<span class="c1">// 2 stop bits</span>

		<span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">96</span><span class="p">;</span>
	<span class="k">else</span>			<span class="c1">// 1 stop bit</span>

		<span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">si2</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span>		<span class="c1">// even parity</span>

		<span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>			<span class="c1">// no parity</span>

		<span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">si2</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">66</span><span class="p">;</span>	<span class="c1">// 1200 bit/s</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">88</span><span class="p">;</span>	<span class="c1">// 1200/75 bit/s</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">87</span><span class="p">;</span>	<span class="c1">// 75/1200 bit/s</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">67</span><span class="p">;</span>	<span class="c1">// 2400 bit/s</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">69</span><span class="p">;</span>	<span class="c1">// 4800 bit/s</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">72</span><span class="p">;</span>	<span class="c1">// 9600 bit/s</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">73</span><span class="p">;</span>	<span class="c1">// 14400 bit/s</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">75</span><span class="p">;</span>	<span class="c1">// 19200 bit/s</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span>  <span class="n">u_char</span>
<span class="nf">EncodeSyncParams</span><span class="p">(</span><span class="n">u_char</span> <span class="n">si2</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">si2</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">ai</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>	<span class="c1">// 1200 bit/s</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">ai</span> <span class="o">+</span> <span class="mi">24</span><span class="p">;</span>		<span class="c1">// 1200/75 bit/s</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="n">ai</span> <span class="o">+</span> <span class="mi">23</span><span class="p">;</span>		<span class="c1">// 75/1200 bit/s</span>

	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">return</span> <span class="n">ai</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>	<span class="c1">// 2400 bit/s</span>

	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">return</span> <span class="n">ai</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>	<span class="c1">// 4800 bit/s</span>

	<span class="k">case</span> <span class="mi">5</span>:
		<span class="k">return</span> <span class="n">ai</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>	<span class="c1">// 9600 bit/s</span>

	<span class="k">case</span> <span class="mi">6</span>:
		<span class="k">return</span> <span class="n">ai</span> <span class="o">+</span> <span class="mi">9</span><span class="p">;</span>	<span class="c1">// 14400 bit/s</span>

	<span class="k">case</span> <span class="mi">7</span>:
		<span class="k">return</span> <span class="n">ai</span> <span class="o">+</span> <span class="mi">11</span><span class="p">;</span>		<span class="c1">// 19200 bit/s</span>

	<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">return</span> <span class="n">ai</span> <span class="o">+</span> <span class="mi">14</span><span class="p">;</span>		<span class="c1">// 48000 bit/s</span>

	<span class="k">case</span> <span class="mi">9</span>:
		<span class="k">return</span> <span class="n">ai</span> <span class="o">+</span> <span class="mi">15</span><span class="p">;</span>		<span class="c1">// 56000 bit/s</span>

	<span class="k">case</span> <span class="mi">15</span>:
		<span class="k">return</span> <span class="n">ai</span> <span class="o">+</span> <span class="mi">40</span><span class="p">;</span>		<span class="c1">// negotiate bit/s</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ai</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">u_char</span>
<span class="nf">DecodeASyncParams</span><span class="p">(</span><span class="n">u_char</span> <span class="n">si2</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">66</span>:	<span class="c1">// 1200 bit/s</span>

		<span class="k">break</span><span class="p">;</span>	<span class="c1">// si2 don&#39;t change</span>

	<span class="k">case</span> <span class="mi">88</span>:	<span class="c1">// 1200/75 bit/s</span>

		<span class="n">si2</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">87</span>:	<span class="c1">// 75/1200 bit/s</span>

		<span class="n">si2</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">67</span>:	<span class="c1">// 2400 bit/s</span>

		<span class="n">si2</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">69</span>:	<span class="c1">// 4800 bit/s</span>

		<span class="n">si2</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">72</span>:	<span class="c1">// 9600 bit/s</span>

		<span class="n">si2</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">73</span>:	<span class="c1">// 14400 bit/s</span>

		<span class="n">si2</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">75</span>:	<span class="c1">// 19200 bit/s</span>

		<span class="n">si2</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span> <span class="o">&amp;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)))</span>	<span class="c1">// 7 data bits</span>

		<span class="n">si2</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>	<span class="c1">// else 8 data bits</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span> <span class="o">&amp;</span> <span class="mi">96</span><span class="p">)</span> <span class="o">==</span> <span class="mi">96</span><span class="p">)</span>	<span class="c1">// 2 stop bits</span>

		<span class="n">si2</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>	<span class="c1">// else 1 stop bit</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)))</span>	<span class="c1">// even parity</span>

		<span class="n">si2</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>	<span class="c1">// else no parity</span>

	<span class="k">return</span> <span class="n">si2</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">u_char</span>
<span class="nf">DecodeSyncParams</span><span class="p">(</span><span class="n">u_char</span> <span class="n">si2</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">40</span>:	<span class="c1">// bit/s negotiation failed  ai := 165 not 175!</span>

		<span class="k">return</span> <span class="n">si2</span> <span class="o">+</span> <span class="mi">15</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">15</span>:	<span class="c1">// 56000 bit/s failed, ai := 0 not 169 !</span>

		<span class="k">return</span> <span class="n">si2</span> <span class="o">+</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">14</span>:	<span class="c1">// 48000 bit/s</span>

		<span class="k">return</span> <span class="n">si2</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11</span>:	<span class="c1">// 19200 bit/s</span>

		<span class="k">return</span> <span class="n">si2</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">9</span>:	<span class="c1">// 14400 bit/s</span>

		<span class="k">return</span> <span class="n">si2</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:	<span class="c1">// 9600  bit/s</span>

		<span class="k">return</span> <span class="n">si2</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:	<span class="c1">// 4800  bit/s</span>

		<span class="k">return</span> <span class="n">si2</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:	<span class="c1">// 2400  bit/s</span>

		<span class="k">return</span> <span class="n">si2</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">23</span>:	<span class="c1">// 75/1200 bit/s</span>

		<span class="k">return</span> <span class="n">si2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:	<span class="c1">// 1200/75 bit/s</span>

		<span class="k">return</span> <span class="n">si2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="nl">default:</span>	<span class="c1">// 1200 bit/s</span>

		<span class="k">return</span> <span class="n">si2</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_char</span>
<span class="nf">DecodeSI2</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>		<span class="c1">//, *pend=skb-&gt;data + skb-&gt;len;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x01</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span>	<span class="c1">// sync. Bitratenadaption</span>

				<span class="k">return</span> <span class="n">DecodeSyncParams</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>	<span class="c1">// V.110/X.30</span>

			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x06</span><span class="p">)</span>	<span class="c1">// async. Bitratenadaption</span>

				<span class="k">return</span> <span class="n">DecodeASyncParams</span><span class="p">(</span><span class="mi">192</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>	<span class="c1">// V.110/X.30</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08</span>:	<span class="c1">// if (p[5] == 0x02) // sync. Bitratenadaption</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">DecodeSyncParams</span><span class="p">(</span><span class="mi">176</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>	<span class="c1">// V.120</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_setup_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span>
		 <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">u_char</span> <span class="n">send_keypad</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">screen</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">teln</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">msn</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">sub</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">MsgHead</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">callref</span><span class="p">,</span> <span class="n">MT_SETUP</span><span class="p">);</span>

	<span class="n">teln</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">;</span>
<span class="cp">#ifndef CONFIG_HISAX_NO_KEYPAD</span>
	<span class="n">send_keypad</span> <span class="o">=</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="n">teln</span><span class="p">,</span> <span class="sc">&#39;*&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="n">strchr</span><span class="p">(</span><span class="n">teln</span><span class="p">,</span> <span class="sc">&#39;#&#39;</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">send_keypad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef CONFIG_HISAX_NO_SENDCOMPLETE</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">send_keypad</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xa1</span><span class="p">;</span>		<span class="cm">/* complete indicator */</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set Bearer Capability, Map info from 1TR6-convention to EDSS1</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:	                  <span class="cm">/* Telephony                                */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_BEARER</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>	  <span class="cm">/* Length                                   */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">;</span>	  <span class="cm">/* Coding Std. CCITT, 3.1 kHz audio         */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">;</span>	  <span class="cm">/* Circuit-Mode 64kbps                      */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xa3</span><span class="p">;</span>	  <span class="cm">/* A-Law Audio                              */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:	                  <span class="cm">/* Datatransmission 64k, BTX                */</span>
	<span class="k">case</span> <span class="mi">7</span>:	                  <span class="cm">/* Datatransmission 64k                     */</span>
	<span class="nl">default:</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_BEARER</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>	  <span class="cm">/* Length                                   */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>	  <span class="cm">/* Coding Std. CCITT, unrestr. dig. Inform. */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">;</span>	  <span class="cm">/* Circuit-Mode 64kbps                      */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">send_keypad</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_KEYPAD</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">teln</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">teln</span><span class="p">)</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">teln</span><span class="o">++</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * What about info2? Mapping to High-Layer-Compatibility?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">teln</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">send_keypad</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* parse number for special things */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">teln</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="mh">0x5f</span> <span class="o">&amp;</span> <span class="o">*</span><span class="n">teln</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;C&#39;</span>:
				<span class="n">channel</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;P&#39;</span>:
				<span class="n">channel</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="n">teln</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">teln</span> <span class="o">==</span> <span class="sc">&#39;1&#39;</span><span class="p">)</span>
					<span class="n">channel</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">channel</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;R&#39;</span>:
				<span class="n">screen</span> <span class="o">=</span> <span class="mh">0xA0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;D&#39;</span>:
				<span class="n">screen</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
					<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;Wrong MSN Code&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">teln</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_CHANNEL_ID</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">msn</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">;</span>
	<span class="n">sub</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="n">msn</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="sc">&#39;.&#39;</span> <span class="o">==</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sub</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>
			<span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">sp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">msn</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_CALLING_PN</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msn</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">screen</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Classify as AnyPref. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">screen</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>	<span class="cm">/* Ext = &#39;0&#39;B, Type = &#39;000&#39;B, Plan = &#39;0001&#39;B. */</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">screen</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">;</span>	<span class="cm">/* Ext = &#39;1&#39;B, Type = &#39;000&#39;B, Plan = &#39;0001&#39;B. */</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">msn</span><span class="p">)</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">msn</span><span class="o">++</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sub</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">sub</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_CALLING_SUB</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>	<span class="cm">/* NSAP coded */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>	<span class="cm">/* local IDI format */</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">sub</span><span class="p">)</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">sub</span><span class="o">++</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sub</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="n">teln</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="sc">&#39;.&#39;</span> <span class="o">==</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sub</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>
			<span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">sp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">send_keypad</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_CALLED_PN</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">teln</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Classify as AnyPref. */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">;</span>		<span class="cm">/* Ext = &#39;1&#39;B, Type = &#39;000&#39;B, Plan = &#39;0001&#39;B. */</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">teln</span><span class="p">)</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">teln</span><span class="o">++</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sub</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">sub</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_CALLED_SUB</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>	<span class="cm">/* NSAP coded */</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>	<span class="cm">/* local IDI format */</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">sub</span><span class="p">)</span>
				<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">sub</span><span class="o">++</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifdef EXT_BEARER_CAPS</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span> <span class="o">&gt;=</span> <span class="mi">160</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span> <span class="o">&lt;=</span> <span class="mi">175</span><span class="p">))</span> <span class="p">{</span>	<span class="c1">// sync. Bitratenadaption, V.110/X.30</span>

		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_LLC</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x21</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">EncodeSyncParams</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span> <span class="o">-</span> <span class="mi">160</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span> <span class="o">&gt;=</span> <span class="mi">176</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span> <span class="o">&lt;=</span> <span class="mi">191</span><span class="p">))</span> <span class="p">{</span>	<span class="c1">// sync. Bitratenadaption, V.120</span>

		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_LLC</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">EncodeSyncParams</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span> <span class="o">-</span> <span class="mi">176</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x82</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span> <span class="o">&gt;=</span> <span class="mi">192</span><span class="p">)</span> <span class="p">{</span>		<span class="c1">// async. Bitratenadaption, V.110/X.30</span>

		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_LLC</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x21</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">EncodeASyncParams</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span> <span class="o">-</span> <span class="mi">192</span><span class="p">);</span>
<span class="cp">#ifndef CONFIG_HISAX_NO_LLC</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:	                <span class="cm">/* Telephony                                */</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_LLC</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>	<span class="cm">/* Length                                   */</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">;</span>	<span class="cm">/* Coding Std. CCITT, 3.1 kHz audio         */</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">;</span>	<span class="cm">/* Circuit-Mode 64kbps                      */</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xa3</span><span class="p">;</span>	<span class="cm">/* A-Law Audio                              */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:	                <span class="cm">/* Datatransmission 64k, BTX                */</span>
		<span class="k">case</span> <span class="mi">7</span>:	                <span class="cm">/* Datatransmission 64k                     */</span>
		<span class="nl">default:</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_LLC</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>	<span class="cm">/* Length                                   */</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>	<span class="cm">/* Coding Std. CCITT, unrestr. dig. Inform. */</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">;</span>	<span class="cm">/* Circuit-Mode 64kbps                      */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">l3_alloc_skb</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">L3AddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">T303</span><span class="p">,</span> <span class="n">CC_T303</span><span class="p">);</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">l3_msg</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_call_proc</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">=</span> <span class="n">l3dss1_get_channel_id</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="mi">0</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="mi">3</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">==</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">moderate</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
				<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;setup answer with wrong chid %x&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
			<span class="n">l3dss1_status_send</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">bchannel</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;setup answer wrong chid (ret %d)&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">l3dss1_status_send</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Now we are on none mandatory IEs */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_infoelements</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ie_CALL_PROCEEDING</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ERR_IE_COMPREHENSION</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">L3AddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">T310</span><span class="p">,</span> <span class="n">CC_T310</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="cm">/* STATUS for none mandatory IE errors after actions are taken */</span>
		<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_PROCEEDING</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_setup_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">=</span> <span class="n">l3dss1_get_channel_id</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="mi">0</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="mi">3</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">==</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">moderate</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
				<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;setup answer with wrong chid %x&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
			<span class="n">l3dss1_status_send</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">bchannel</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;setup answer wrong chid (ret %d)&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">l3dss1_status_send</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Now we are on none mandatory IEs */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_infoelements</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ie_SETUP_ACKNOWLEDGE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ERR_IE_COMPREHENSION</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">L3AddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">T304</span><span class="p">,</span> <span class="n">CC_T304</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="cm">/* STATUS for none mandatory IE errors after actions are taken */</span>
		<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_MORE_INFO</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">cause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">StopAllL3Timer</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">l3dss1_get_cause</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;DISC get_cause ret(%d)&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cause</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">IE_FACILITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="n">l3dss1_parse_facility</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">callref</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_infoelements</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ie_DISCONNECT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ERR_IE_COMPREHENSION</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span>
		<span class="n">cause</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">cause</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ERR_IE_UNRECOGNIZED</span> <span class="o">==</span> <span class="n">ret</span><span class="p">))</span>
		<span class="n">cause</span> <span class="o">=</span> <span class="mi">99</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span><span class="p">)</span>
		<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">11</span> <span class="o">!=</span> <span class="n">ret</span><span class="p">)</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_DISCONNECT</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cause</span><span class="p">)</span>
		<span class="n">l3dss1_release_req</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l3dss1_message_cause</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">MT_RELEASE</span><span class="p">,</span> <span class="n">cause</span><span class="p">);</span>
		<span class="n">L3AddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">T308</span><span class="p">,</span> <span class="n">CC_T308_1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_infoelements</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ie_CONNECT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ERR_IE_COMPREHENSION</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>	<span class="cm">/* T310 */</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">chargeinfo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* here should inserted COLP handling KKe */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_SETUP</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_alerting</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_infoelements</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ie_ALERTING</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ERR_IE_COMPREHENSION</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>	<span class="cm">/* T304 */</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_ALERTING</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bcfound</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Bearer Capabilities</span>
<span class="cm">	 */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="cm">/* only the first occurrence &#39;ll be detected ! */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">11</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x00</span>: <span class="cm">/* Speech */</span>
			<span class="k">case</span> <span class="mh">0x10</span>: <span class="cm">/* 3.1 Khz audio */</span>
				<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x08</span>: <span class="cm">/* Unrestricted digital information */</span>
				<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="cm">/* JIM, 05.11.97 I wanna set service indicator 2 */</span>
<span class="cp">#ifdef EXT_BEARER_CAPS</span>
				<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span> <span class="o">=</span> <span class="n">DecodeSI2</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x09</span>: <span class="cm">/* Restricted digital information */</span>
				<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x11</span>:
				<span class="cm">/* Unrestr. digital information  with</span>
<span class="cm">				 * tones/announcements ( or 7 kHz audio</span>
<span class="cm">				 */</span>
				<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x18</span>: <span class="cm">/* Video */</span>
				<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">err</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x40</span>: <span class="cm">/* packed mode */</span>
				<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x10</span>: <span class="cm">/* 64 kbit */</span>
			<span class="k">case</span> <span class="mh">0x11</span>: <span class="cm">/* 2*64 kbit */</span>
			<span class="k">case</span> <span class="mh">0x13</span>: <span class="cm">/* 384 kbit */</span>
			<span class="k">case</span> <span class="mh">0x15</span>: <span class="cm">/* 1536 kbit */</span>
			<span class="k">case</span> <span class="mh">0x17</span>: <span class="cm">/* 1920 kbit */</span>
				<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">moderate</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">err</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_SI</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;SI=%d, AI=%d&quot;</span><span class="p">,</span>
				 <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
				<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;setup with wrong bearer(l=%d:%x,%x)&quot;</span><span class="p">,</span>
					 <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
			<span class="n">l3dss1_msg_without_setup</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;setup without bearer capabilities&quot;</span><span class="p">);</span>
		<span class="cm">/* ETS 300-104 1.3.3 */</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="n">l3dss1_msg_without_setup</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Channel Identification</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">=</span> <span class="n">l3dss1_get_channel_id</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">bchannel</span> <span class="o">=</span> <span class="n">id</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="mi">3</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">==</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">moderate</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
					<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;setup with wrong chid %x&quot;</span><span class="p">,</span>
						 <span class="n">id</span><span class="p">);</span>
				<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
				<span class="n">l3dss1_msg_without_setup</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bcfound</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
		<span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
				<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;setup without bchannel, call waiting&quot;</span><span class="p">);</span>
			<span class="n">bcfound</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;setup with wrong chid ret %d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">l3dss1_msg_without_setup</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Now we are on none mandatory IEs */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">check_infoelements</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ie_SETUP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ERR_IE_COMPREHENSION</span> <span class="o">==</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="n">l3dss1_msg_without_setup</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="n">iecpy</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Called party subaddress */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x50</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
			<span class="n">iecpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;wrong called subaddress&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">plan</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iecpy</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">screen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">iecpy</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">screen</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">plan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">screen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Calling party subaddress */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x50</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
			<span class="n">iecpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;wrong calling subaddress&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="cm">/* STATUS for none mandatory IE errors after actions are taken */</span>
		<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_SETUP</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dss1_release_l3_process</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_disconnect_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">16</span> <span class="o">+</span> <span class="mi">40</span><span class="p">];</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">cause</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">!=</span> <span class="n">NO_CAUSE</span><span class="p">)</span>
		<span class="n">cause</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span><span class="p">;</span>

	<span class="n">StopAllL3Timer</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>

	<span class="n">MsgHead</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">callref</span><span class="p">,</span> <span class="n">MT_DISCONNECT</span><span class="p">);</span>

	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_CAUSE</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">cause</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">uus1_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="p">{</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_USER_USER</span><span class="p">;</span> <span class="cm">/* UUS info element */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">uus1_data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span> <span class="cm">/* IA5 chars */</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">uus1_data</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">uus1_data</span><span class="p">);</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">uus1_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">l3_alloc_skb</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
	<span class="n">l3_msg</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">L3AddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">T305</span><span class="p">,</span> <span class="n">CC_T305</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_setup_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span>
		 <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">bchannel</span><span class="p">)</span>
	<span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;D-chan connect for waiting call&quot;</span><span class="p">);</span>
		<span class="n">l3dss1_disconnect_req</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">l3dss1_message</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">MT_CONNECT</span><span class="p">);</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">L3AddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">T313</span><span class="p">,</span> <span class="n">CC_T313</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_connect_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_infoelements</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ie_CONNECT_ACKNOWLEDGE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ERR_IE_COMPREHENSION</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_SETUP_COMPL</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_reject_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">cause</span> <span class="o">=</span> <span class="mi">21</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">!=</span> <span class="n">NO_CAUSE</span><span class="p">)</span>
		<span class="n">cause</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span><span class="p">;</span>

	<span class="n">MsgHead</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">callref</span><span class="p">,</span> <span class="n">MT_RELEASE_COMPLETE</span><span class="p">);</span>

	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_CAUSE</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">cause</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">l3_alloc_skb</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
	<span class="n">l3_msg</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_RELEASE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dss1_release_l3_process</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">cause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">StopAllL3Timer</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">l3dss1_get_cause</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;REL get_cause ret(%d)&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="n">NO_CAUSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">IE_FACILITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">l3dss1_parse_facility</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">callref</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="mi">11</span><span class="p">))</span>
		<span class="n">cause</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_infoelements</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ie_RELEASE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ERR_IE_COMPREHENSION</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span>
		<span class="n">cause</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ERR_IE_UNRECOGNIZED</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">cause</span><span class="p">))</span>
		<span class="n">cause</span> <span class="o">=</span> <span class="mi">99</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span><span class="p">)</span>
		<span class="n">l3dss1_message_cause</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">MT_RELEASE_COMPLETE</span><span class="p">,</span> <span class="n">cause</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">l3dss1_message</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">MT_RELEASE_COMPLETE</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_RELEASE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dss1_release_l3_process</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_alert_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span>
		 <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">uus1_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">l3dss1_message</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">MT_ALERTING</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">l3dss1_msg_with_uus</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">MT_ALERTING</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_proceed_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span>
		   <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">l3dss1_message</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">MT_CALL_PROCEEDING</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_PROCEED_SEND</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_setup_ack_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span>
		     <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">L3AddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">T302</span><span class="p">,</span> <span class="n">CC_T302</span><span class="p">);</span>
	<span class="n">l3dss1_message</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">MT_SETUP_ACKNOWLEDGE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/********************************************/</span>
<span class="cm">/* deliver a incoming display message to HL */</span>
<span class="cm">/********************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_deliver_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">infp</span><span class="p">)</span>
<span class="p">{</span>       <span class="n">u_char</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">ic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">infp</span><span class="o">++</span> <span class="o">!=</span> <span class="n">IE_DISPLAY</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">=</span> <span class="o">*</span><span class="n">infp</span><span class="o">++</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">80</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="cm">/* total length &lt;= 82 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">display</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">infp</span><span class="o">++</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_DISPLAY</span><span class="p">;</span>
	<span class="n">cs</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* l3dss1_deliver_display */</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_progress</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">IE_PROGRESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x80</span>:
			<span class="k">case</span> <span class="mh">0x81</span>:
			<span class="k">case</span> <span class="mh">0x82</span>:
			<span class="k">case</span> <span class="mh">0x84</span>:
			<span class="k">case</span> <span class="mh">0x85</span>:
			<span class="k">case</span> <span class="mh">0x87</span>:
			<span class="k">case</span> <span class="mh">0x8a</span>:
				<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mh">0x81</span>:
				<span class="k">case</span> <span class="mh">0x82</span>:
				<span class="k">case</span> <span class="mh">0x83</span>:
				<span class="k">case</span> <span class="mh">0x84</span>:
				<span class="k">case</span> <span class="mh">0x88</span>:
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">err</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">err</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;progress error %d&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">l3dss1_status_send</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Now we are on none mandatory IEs */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">check_infoelements</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ie_PROGRESS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ERR_IE_COMPREHENSION</span> <span class="o">!=</span> <span class="n">err</span><span class="p">)</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_PROGRESS</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">IE_NOTIFY</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x80</span>:
			<span class="k">case</span> <span class="mh">0x81</span>:
			<span class="k">case</span> <span class="mh">0x82</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
				<span class="n">err</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;notify error %d&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">l3dss1_status_send</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Now we are on none mandatory IEs */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">check_infoelements</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ie_NOTIFY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ERR_IE_COMPREHENSION</span> <span class="o">!=</span> <span class="n">err</span><span class="p">)</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_NOTIFY</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_status_enq</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_infoelements</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ie_STATUS_ENQUIRY</span><span class="p">);</span>
	<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span> <span class="cm">/* response to STATUS_ENQUIRY */</span>
	<span class="n">l3dss1_status_send</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_information</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_infoelements</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ie_INFORMATION</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="mi">25</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* overlap receiving */</span>
		<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">iecpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_MORE_INFO</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">L3AddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">T302</span><span class="p">,</span> <span class="n">CC_T302</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/******************************/</span>
<span class="cm">/* handle deflection requests */</span>
<span class="cm">/******************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">l3dss1_redir_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">subp</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">len_phone</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">len_sub</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>


	<span class="n">strcpy</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">uus1_data</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">);</span> <span class="cm">/* copy uus element if available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="p">{</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">l3dss1_disconnect_req</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span> <span class="cm">/* disconnect immediately */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* only uus */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span><span class="p">)</span>
		<span class="n">free_invoke_id</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span> <span class="o">=</span> <span class="n">new_invoke_id</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">MsgHead</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">callref</span><span class="p">,</span> <span class="n">MT_FACILITY</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">subp</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">subp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">subp</span> <span class="o">!=</span> <span class="sc">&#39;.&#39;</span><span class="p">);</span> <span class="n">subp</span><span class="o">++</span><span class="p">)</span> <span class="n">len_phone</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* len of phone number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">subp</span><span class="o">++</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span> <span class="n">len_sub</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">subp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* length including info subaddress element */</span>

	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x1c</span><span class="p">;</span>   <span class="cm">/* Facility info element */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">len_phone</span> <span class="o">+</span> <span class="n">len_sub</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* length of element */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x91</span><span class="p">;</span>  <span class="cm">/* remote operations protocol */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xa1</span><span class="p">;</span>  <span class="cm">/* invoke component */</span>

	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">len_phone</span> <span class="o">+</span> <span class="n">len_sub</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* length of data */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>  <span class="cm">/* invoke id tag, integer */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>  <span class="cm">/* length */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span><span class="p">;</span>  <span class="cm">/* invoke id */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>  <span class="cm">/* operation value tag, integer */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>  <span class="cm">/* length */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x0D</span><span class="p">;</span>  <span class="cm">/* Call Deflect */</span>

	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>  <span class="cm">/* sequence phone number */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">len_phone</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">len_sub</span><span class="p">;</span> <span class="cm">/* length */</span>

	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>  <span class="cm">/* Deflected to UserNumber */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">len_phone</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">len_sub</span><span class="p">;</span> <span class="cm">/* length */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* NumberDigits */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">len_phone</span><span class="p">;</span> <span class="cm">/* length */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">len_phone</span><span class="p">;</span> <span class="n">l</span><span class="o">++</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">[</span><span class="n">l</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len_sub</span><span class="p">)</span>
	<span class="p">{</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span> <span class="cm">/* called party subaddress */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">len_sub</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">subp</span><span class="p">)</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">subp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* screening identifier */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">.</span><span class="n">screen</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">l3_alloc_skb</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span> <span class="k">return</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>

	<span class="n">l3_msg</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* l3dss1_redir_req */</span>

<span class="cm">/********************************************/</span>
<span class="cm">/* handle deflection request in early state */</span>
<span class="cm">/********************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">l3dss1_redir_req_early</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">l3dss1_proceed_req</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="n">l3dss1_redir_req</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* l3dss1_redir_req_early */</span>

<span class="cm">/***********************************************/</span>
<span class="cm">/* handle special commands for this protocol.  */</span>
<span class="cm">/* Examples are call independent services like */</span>
<span class="cm">/* remote operations with dummy  callref.      */</span>
<span class="cm">/***********************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">l3dss1_cmd_global</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="n">isdn_ctrl</span> <span class="o">*</span><span class="n">ic</span><span class="p">)</span>
<span class="p">{</span> <span class="n">u_char</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">temp</span><span class="p">[</span><span class="mi">265</span><span class="p">];</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">proc_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">)</span>
	<span class="p">{</span> <span class="k">case</span> <span class="n">DSS1_CMD_INVOKE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">datalen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span> <span class="cm">/* invalid parameter */</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">proc_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">proc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* add one byte */</span>
			<span class="n">l</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">datalen</span> <span class="o">+</span> <span class="n">proc_len</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* length excluding ie header */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
				<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span> <span class="cm">/* too long */</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="n">new_invoke_id</span><span class="p">(</span><span class="n">st</span><span class="p">)))</span>
				<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* first get a invoke id -&gt; return if no available */</span>

			<span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">MsgHead</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">MT_FACILITY</span><span class="p">);</span> <span class="cm">/* build message head */</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x1C</span><span class="p">;</span> <span class="cm">/* Facility IE */</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span> <span class="cm">/* length of ie */</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x91</span><span class="p">;</span> <span class="cm">/* remote operations */</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xA1</span><span class="p">;</span> <span class="cm">/* invoke */</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* length of invoke */</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span> <span class="cm">/* invoke id tag */</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* length is 1 */</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span> <span class="cm">/* invoke id */</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span> <span class="cm">/* operation */</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">proc_len</span><span class="p">;</span> <span class="cm">/* length of operation */</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">proc_len</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
				<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">proc</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">datalen</span><span class="p">);</span> <span class="cm">/* copy data */</span>
			<span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">temp</span><span class="p">)</span> <span class="o">+</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">datalen</span><span class="p">;</span> <span class="cm">/* total length */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pc</span> <span class="o">=</span> <span class="n">dss1_new_l3_process</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
				<span class="p">{</span> <span class="n">free_invoke_id</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
					<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">ll_id</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">ll_id</span><span class="p">;</span> <span class="cm">/* remember id */</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">proc</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">proc</span><span class="p">;</span> <span class="cm">/* and procedure */</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">l3_alloc_skb</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span>
			<span class="p">{</span> <span class="n">free_invoke_id</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="p">)</span> <span class="n">dss1_release_l3_process</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
				<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> <span class="n">temp</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="p">)</span>
			<span class="p">{</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span> <span class="cm">/* remember id */</span>
				<span class="n">L3AddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">CC_TDSS1_IO</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">l3_msg</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">hl_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span> <span class="cm">/* return id */</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">DSS1_CMD_INVOKE_ABORT</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">pc</span> <span class="o">=</span> <span class="n">l3dss1_search_dummy_proc</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">hl_id</span><span class="p">)))</span>
		<span class="p">{</span> <span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span> <span class="cm">/* remove timer */</span>
			<span class="n">dss1_release_l3_process</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span> <span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;l3dss1_cmd_global abort unknown id&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;l3dss1_cmd_global unknown cmd 0x%lx&quot;</span><span class="p">,</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="cm">/* switch ic-&gt; arg */</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* l3dss1_cmd_global */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_io_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">)</span>
<span class="p">{</span> <span class="n">isdn_ctrl</span> <span class="n">ic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">;</span>

	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span> <span class="cm">/* remove timer */</span>

	<span class="n">ic</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_PROT</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">DSS1_STAT_INVOKE_ERR</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">hl_id</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">ll_id</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">ll_id</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">proc</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">proc</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">datalen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">dss1_io</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">free_invoke_id</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* reset id */</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">);</span>

	<span class="n">dss1_release_l3_process</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* l3dss1_io_timer */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_release_ind</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">callState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">IE_CALL_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span>
			<span class="n">callState</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">callState</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ETS 300-104 7.6.1, 8.6.1, 10.6.1... and 16.1</span>
<span class="cm">		 * set down layer 3 without sending any message</span>
<span class="cm">		 */</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_RELEASE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
		<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dss1_release_l3_process</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_IGNORE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_dummy</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_t302</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">loc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">28</span><span class="p">;</span> <span class="cm">/* invalid number */</span>
	<span class="n">l3dss1_disconnect_req</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_SETUP_ERR</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_t303</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">N303</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">N303</span><span class="o">--</span><span class="p">;</span>
		<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">l3dss1_setup_req</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">l3dss1_message_cause</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">MT_RELEASE_COMPLETE</span><span class="p">,</span> <span class="mi">102</span><span class="p">);</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_NOSETUP_RSP</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
		<span class="n">dss1_release_l3_process</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_t304</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">loc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">102</span><span class="p">;</span>
	<span class="n">l3dss1_disconnect_req</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_SETUP_ERR</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_t305</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">cause</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">!=</span> <span class="n">NO_CAUSE</span><span class="p">)</span>
		<span class="n">cause</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span><span class="p">;</span>

	<span class="n">MsgHead</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">callref</span><span class="p">,</span> <span class="n">MT_RELEASE</span><span class="p">);</span>

	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_CAUSE</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">cause</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">l3_alloc_skb</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>
	<span class="n">l3_msg</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">L3AddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">T308</span><span class="p">,</span> <span class="n">CC_T308_1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_t310</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">loc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">102</span><span class="p">;</span>
	<span class="n">l3dss1_disconnect_req</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_SETUP_ERR</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_t313</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">loc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">102</span><span class="p">;</span>
	<span class="n">l3dss1_disconnect_req</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_CONNECT_ERR</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_t308_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">l3dss1_message</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">MT_RELEASE</span><span class="p">);</span>
	<span class="n">L3AddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">T308</span><span class="p">,</span> <span class="n">CC_T308_2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_t308_2</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_RELEASE_ERR</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
	<span class="n">dss1_release_l3_process</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_t318</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">102</span><span class="p">;</span>	<span class="cm">/* Timer expiry */</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">loc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* local */</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_RESUME_ERR</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>
	<span class="n">l3dss1_message</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">MT_RELEASE</span><span class="p">);</span>
	<span class="n">L3AddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">T308</span><span class="p">,</span> <span class="n">CC_T308_1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_t319</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">102</span><span class="p">;</span>	<span class="cm">/* Timer expiry */</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">loc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* local */</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_SUSPEND_ERR</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_RELEASE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
	<span class="n">dss1_release_l3_process</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">cause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">callState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">l3dss1_get_cause</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;STATUS get_cause ret(%d)&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cause</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">IE_CALL_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">callState</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ie_in_set</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">l3_valid_states</span><span class="p">))</span>
				<span class="n">cause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">cause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cause</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cause</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/*  no error before */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">check_infoelements</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ie_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ERR_IE_COMPREHENSION</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span>
			<span class="n">cause</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ERR_IE_UNRECOGNIZED</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span>
			<span class="n">cause</span> <span class="o">=</span> <span class="mi">99</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_char</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;STATUS error(%d/%d)&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">cause</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span><span class="p">;</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="n">cause</span><span class="p">;</span>
		<span class="n">l3dss1_status_send</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cause</span> <span class="o">==</span> <span class="mi">99</span><span class="p">)</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cause</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">111</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">callState</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* ETS 300-104 7.6.1, 8.6.1, 10.6.1...</span>
<span class="cm">		 * if received MT_STATUS with cause == 111 and call</span>
<span class="cm">		 * state == 0, then we must set down layer 3</span>
<span class="cm">		 */</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_RELEASE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
		<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dss1_release_l3_process</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_facility</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_infoelements</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ie_FACILITY</span><span class="p">);</span>
	<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">{</span>
		<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">IE_FACILITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
			<span class="n">l3dss1_parse_facility</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">callref</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_suspend_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">;</span>

	<span class="n">MsgHead</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">callref</span><span class="p">,</span> <span class="n">MT_SUSPEND</span><span class="p">);</span>
	<span class="n">l</span> <span class="o">=</span> <span class="o">*</span><span class="n">msg</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* Max length 10 octets */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_CALL_ID</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">l</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">msg</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;SUS wrong CALL_ID len %d&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">l3_alloc_skb</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
	<span class="n">l3_msg</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="n">L3AddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">T319</span><span class="p">,</span> <span class="n">CC_T319</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_suspend_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="n">NO_CAUSE</span><span class="p">;</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_SUSPEND</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
	<span class="cm">/* We don&#39;t handle suspend_ack for IE errors now */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">check_infoelements</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ie_SUSPEND_ACKNOWLEDGE</span><span class="p">)))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;SUSPACK check ie(%d)&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">dss1_release_l3_process</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_suspend_rej</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">l3dss1_get_cause</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;SUSP_REJ get_cause ret(%d)&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">l3dss1_status_send</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_infoelements</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ie_SUSPEND_REJECT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ERR_IE_COMPREHENSION</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_SUSPEND_ERR</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="cm">/* STATUS for none mandatory IE errors after actions are taken */</span>
		<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_resume_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">;</span>

	<span class="n">MsgHead</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">callref</span><span class="p">,</span> <span class="n">MT_RESUME</span><span class="p">);</span>

	<span class="n">l</span> <span class="o">=</span> <span class="o">*</span><span class="n">msg</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* Max length 10 octets */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_CALL_ID</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">l</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">msg</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;RES wrong CALL_ID len %d&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">l3_alloc_skb</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
	<span class="n">l3_msg</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">17</span><span class="p">);</span>
	<span class="n">L3AddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">T318</span><span class="p">,</span> <span class="n">CC_T318</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_resume_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">=</span> <span class="n">l3dss1_get_channel_id</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="mi">0</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="mi">3</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">==</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">moderate</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
				<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;resume ack with wrong chid %x&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
			<span class="n">l3dss1_status_send</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">bchannel</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;resume ack without chid (ret %d)&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="n">l3dss1_status_send</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_infoelements</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ie_RESUME_ACKNOWLEDGE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ERR_IE_COMPREHENSION</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_RESUME</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="cm">/* STATUS for none mandatory IE errors after actions are taken */</span>
		<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_resume_rej</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">l3dss1_get_cause</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;RES_REJ get_cause ret(%d)&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">l3dss1_status_send</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_infoelements</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ie_RESUME_REJECT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ERR_IE_COMPREHENSION</span> <span class="o">==</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_RESUME_ERR</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="cm">/* STATUS for none mandatory IE errors after actions are taken */</span>
		<span class="n">l3dss1_std_ie_err</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">dss1_release_l3_process</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_global_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">ri</span><span class="p">,</span> <span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">up</span><span class="p">;</span>

	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">IE_RESTART_IND</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ri</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;Restart %x&quot;</span><span class="p">,</span> <span class="n">ri</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;Restart without restart IE&quot;</span><span class="p">);</span>
		<span class="n">ri</span> <span class="o">=</span> <span class="mh">0x86</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">IE_CHANNEL_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;Restart for channel %d&quot;</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">up</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">proc</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ri</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_RESTART</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">bchannel</span> <span class="o">==</span> <span class="n">chan</span><span class="p">)</span>
			<span class="n">up</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_RESTART</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
		<span class="n">up</span> <span class="o">=</span> <span class="n">up</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">MsgHead</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">callref</span><span class="p">,</span> <span class="n">MT_RESTART_ACKNOWLEDGE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_CHANNEL_ID</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x79</span><span class="p">;</span>		<span class="cm">/* RESTART Ind */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">ri</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">l3_alloc_skb</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">l3_msg</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_dl_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mh">0x29</span><span class="p">;</span>          <span class="cm">/* Temporary failure */</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">loc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">l3dss1_disconnect_req</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_SETUP_ERR</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_dl_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">newl3state</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mh">0x1b</span><span class="p">;</span>          <span class="cm">/* Destination out of order */</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">loc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_RELEASE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
	<span class="n">release_l3_process</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_dl_reestablish</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">L3AddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">T309</span><span class="p">,</span> <span class="n">CC_T309</span><span class="p">);</span>
	<span class="n">l3_msg</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">DL_ESTABLISH</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l3dss1_dl_reest_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">L3DelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span> <span class="cm">/* normal, unspecified */</span>
	<span class="n">l3dss1_status_send</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* *INDENT-OFF* */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">stateentry</span> <span class="n">downstatelist</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
	 <span class="n">CC_SETUP</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">l3dss1_setup_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
	 <span class="n">CC_RESUME</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">l3dss1_resume_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span>
	 <span class="n">CC_DISCONNECT</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">l3dss1_disconnect_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span>
	 <span class="n">CC_RELEASE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">l3dss1_release_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ALL_STATES</span><span class="p">,</span>
	 <span class="n">CC_RESTART</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">l3dss1_restart</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span>
	 <span class="n">CC_IGNORE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">l3dss1_reset</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span>
	 <span class="n">CC_REJECT</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">l3dss1_reject_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span>
	 <span class="n">CC_PROCEED_SEND</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">l3dss1_proceed_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
	 <span class="n">CC_MORE_INFO</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">l3dss1_setup_ack_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span>
	 <span class="n">CC_MORE_INFO</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">l3dss1_dummy</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span>
	 <span class="n">CC_ALERTING</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">l3dss1_alert_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span>
	 <span class="n">CC_SETUP</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">,</span> <span class="n">l3dss1_setup_rsp</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="n">CC_SUSPEND</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">l3dss1_suspend_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span>
	 <span class="n">CC_REDIR</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">l3dss1_redir_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
	 <span class="n">CC_REDIR</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">l3dss1_redir_req_early</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span>
	 <span class="n">CC_DISCONNECT</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">l3dss1_disconnect_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span>
	 <span class="n">CC_T302</span><span class="p">,</span> <span class="n">l3dss1_t302</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	 <span class="n">CC_T303</span><span class="p">,</span> <span class="n">l3dss1_t303</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	 <span class="n">CC_T304</span><span class="p">,</span> <span class="n">l3dss1_t304</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
	 <span class="n">CC_T310</span><span class="p">,</span> <span class="n">l3dss1_t310</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
	 <span class="n">CC_T313</span><span class="p">,</span> <span class="n">l3dss1_t313</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span>
	 <span class="n">CC_T305</span><span class="p">,</span> <span class="n">l3dss1_t305</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span>
	 <span class="n">CC_T319</span><span class="p">,</span> <span class="n">l3dss1_t319</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span>
	 <span class="n">CC_T318</span><span class="p">,</span> <span class="n">l3dss1_t318</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">19</span><span class="p">),</span>
	 <span class="n">CC_T308_1</span><span class="p">,</span> <span class="n">l3dss1_t308_1</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">19</span><span class="p">),</span>
	 <span class="n">CC_T308_2</span><span class="p">,</span> <span class="n">l3dss1_t308_2</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="n">CC_T309</span><span class="p">,</span> <span class="n">l3dss1_dl_release</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stateentry</span> <span class="n">datastatelist</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span><span class="n">ALL_STATES</span><span class="p">,</span>
	 <span class="n">MT_STATUS_ENQUIRY</span><span class="p">,</span> <span class="n">l3dss1_status_enq</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ALL_STATES</span><span class="p">,</span>
	 <span class="n">MT_FACILITY</span><span class="p">,</span> <span class="n">l3dss1_facility</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">19</span><span class="p">),</span>
	 <span class="n">MT_STATUS</span><span class="p">,</span> <span class="n">l3dss1_release_ind</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ALL_STATES</span><span class="p">,</span>
	 <span class="n">MT_STATUS</span><span class="p">,</span> <span class="n">l3dss1_status</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
	 <span class="n">MT_SETUP</span><span class="p">,</span> <span class="n">l3dss1_setup</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span>
	 <span class="n">SBIT</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span>
	 <span class="n">MT_SETUP</span><span class="p">,</span> <span class="n">l3dss1_dummy</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	 <span class="n">MT_CALL_PROCEEDING</span><span class="p">,</span> <span class="n">l3dss1_call_proc</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	 <span class="n">MT_SETUP_ACKNOWLEDGE</span><span class="p">,</span> <span class="n">l3dss1_setup_ack</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
	 <span class="n">MT_ALERTING</span><span class="p">,</span> <span class="n">l3dss1_alerting</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
	 <span class="n">MT_PROGRESS</span><span class="p">,</span> <span class="n">l3dss1_progress</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">|</span>
	 <span class="n">SBIT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span>
	 <span class="n">MT_INFORMATION</span><span class="p">,</span> <span class="n">l3dss1_information</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span>
	 <span class="n">MT_NOTIFY</span><span class="p">,</span> <span class="n">l3dss1_notify</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">|</span>
	 <span class="n">SBIT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span>
	 <span class="n">MT_RELEASE_COMPLETE</span><span class="p">,</span> <span class="n">l3dss1_release_cmpl</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span>
	 <span class="n">MT_RELEASE</span><span class="p">,</span> <span class="n">l3dss1_release</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">19</span><span class="p">),</span>  <span class="n">MT_RELEASE</span><span class="p">,</span> <span class="n">l3dss1_release_ind</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span>
	 <span class="n">MT_DISCONNECT</span><span class="p">,</span> <span class="n">l3dss1_disconnect</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">19</span><span class="p">),</span>
	 <span class="n">MT_DISCONNECT</span><span class="p">,</span> <span class="n">l3dss1_dummy</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">SBIT</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
	 <span class="n">MT_CONNECT</span><span class="p">,</span> <span class="n">l3dss1_connect</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
	 <span class="n">MT_CONNECT_ACKNOWLEDGE</span><span class="p">,</span> <span class="n">l3dss1_connect_ack</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span>
	 <span class="n">MT_SUSPEND_ACKNOWLEDGE</span><span class="p">,</span> <span class="n">l3dss1_suspend_ack</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span>
	 <span class="n">MT_SUSPEND_REJECT</span><span class="p">,</span> <span class="n">l3dss1_suspend_rej</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span>
	 <span class="n">MT_RESUME_ACKNOWLEDGE</span><span class="p">,</span> <span class="n">l3dss1_resume_ack</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span>
	 <span class="n">MT_RESUME_REJECT</span><span class="p">,</span> <span class="n">l3dss1_resume_rej</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stateentry</span> <span class="n">globalmes_list</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span><span class="n">ALL_STATES</span><span class="p">,</span>
	 <span class="n">MT_STATUS</span><span class="p">,</span> <span class="n">l3dss1_status</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
	 <span class="n">MT_RESTART</span><span class="p">,</span> <span class="n">l3dss1_global_restart</span><span class="p">},</span>
<span class="cm">/*	{SBIT(1),</span>
<span class="cm">	MT_RESTART_ACKNOWLEDGE, l3dss1_restart_ack},</span>
<span class="cm">*/</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">stateentry</span> <span class="n">manstatelist</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	 <span class="n">DL_ESTABLISH</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">l3dss1_dl_reset</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="n">DL_ESTABLISH</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">l3dss1_dl_reest_status</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SBIT</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	 <span class="n">DL_RELEASE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">l3dss1_dl_reestablish</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ALL_STATES</span><span class="p">,</span>
	 <span class="n">DL_RELEASE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="n">l3dss1_dl_release</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* *INDENT-ON* */</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">global_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">proc</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">global</span><span class="p">;</span>

	<span class="n">proc</span><span class="o">-&gt;</span><span class="n">callref</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="cm">/* cr flag */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">globalmes_list</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mt</span> <span class="o">==</span> <span class="n">globalmes_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">primitive</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">globalmes_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">globalmes_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_STATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;dss1 global state %d mt %x unhandled&quot;</span><span class="p">,</span>
				 <span class="n">proc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">mt</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">MsgHead</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">callref</span><span class="p">,</span> <span class="n">MT_STATUS</span><span class="p">);</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">IE_CAUSE</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mi">81</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>	<span class="cm">/* invalid cr */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">;</span>		<span class="cm">/* CallState */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">l3_alloc_skb</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
		<span class="n">l3_msg</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_STATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;dss1 global %d mt %x&quot;</span><span class="p">,</span>
				 <span class="n">proc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">mt</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">globalmes_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rout</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dss1up</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">callState</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">proc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">DL_UNIT_DATA</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">DL_ESTABLISH</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">DL_ESTABLISH</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">DL_RELEASE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">DL_RELEASE</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">)</span>:
		<span class="n">l3_msg</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;HiSax dss1up unknown pr=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;dss1up frame too short(%d)&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">PROTO_DIS_EURO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_PROTERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;dss1up%sunexpected discriminator %x message len %d&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">pr</span> <span class="o">==</span> <span class="p">(</span><span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;(broadcast) &quot;</span><span class="p">,</span>
				 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cr</span> <span class="o">=</span> <span class="n">getcallref</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;dss1up frame too short(%d)&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mt</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_STATE</span><span class="p">)</span>
		<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;dss1up cr %d&quot;</span><span class="p">,</span> <span class="n">cr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cr</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* wrong Callref */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;dss1up wrong Callref&quot;</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cr</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Dummy Callref */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mt</span> <span class="o">==</span> <span class="n">MT_FACILITY</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">IE_FACILITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">l3dss1_parse_facility</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
						      <span class="p">(</span><span class="n">pr</span> <span class="o">==</span> <span class="p">(</span><span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_WARN</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;dss1up dummy Callref (no facility msg or ie)&quot;</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">cr</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)))</span> <span class="o">||</span>
		   <span class="p">(((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">cr</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">))))</span> <span class="p">{</span>	<span class="cm">/* Global CallRef */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_STATE</span><span class="p">)</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;dss1up Global CallRef&quot;</span><span class="p">);</span>
		<span class="n">global_handler</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">proc</span> <span class="o">=</span> <span class="n">getl3proc</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">cr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* No transaction process exist, that means no call with</span>
<span class="cm">		 * this callreference is active</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mt</span> <span class="o">==</span> <span class="n">MT_SETUP</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Setup creates a new transaction process */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Setup with wrong CREF flag */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_STATE</span><span class="p">)</span>
					<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;dss1up wrong CRef flag&quot;</span><span class="p">);</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">proc</span> <span class="o">=</span> <span class="n">dss1_new_l3_process</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">cr</span><span class="p">)))</span> <span class="p">{</span>
				<span class="cm">/* May be to answer with RELEASE_COMPLETE and</span>
<span class="cm">				 * CAUSE 0x2f &quot;Resource unavailable&quot;, but this</span>
<span class="cm">				 * need a new_l3_process too ... arghh</span>
<span class="cm">				 */</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mt</span> <span class="o">==</span> <span class="n">MT_STATUS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">IE_CAUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
					<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">callState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">IE_CALL_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
					<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
				<span class="n">callState</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* ETS 300-104 part 2.4.1</span>
<span class="cm">			 * if setup has not been made and a message type</span>
<span class="cm">			 * MT_STATUS is received with call state == 0,</span>
<span class="cm">			 * we must send nothing</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">callState</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* ETS 300-104 part 2.4.2</span>
<span class="cm">				 * if setup has not been made and a message type</span>
<span class="cm">				 * MT_STATUS is received with call state != 0,</span>
<span class="cm">				 * we must send MT_RELEASE_COMPLETE cause 101</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">proc</span> <span class="o">=</span> <span class="n">dss1_new_l3_process</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">cr</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">proc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">101</span><span class="p">;</span>
					<span class="n">l3dss1_msg_without_setup</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mt</span> <span class="o">==</span> <span class="n">MT_RELEASE_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* ETS 300-104 part 2</span>
<span class="cm">			 * if setup has not been made and a message type</span>
<span class="cm">			 * (except MT_SETUP and RELEASE_COMPLETE) is received,</span>
<span class="cm">			 * we must send MT_RELEASE_COMPLETE cause 81 */</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">proc</span> <span class="o">=</span> <span class="n">dss1_new_l3_process</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">cr</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">proc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">81</span><span class="p">;</span>
				<span class="n">l3dss1_msg_without_setup</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l3dss1_check_messagetype_validity</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">findie</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">IE_DISPLAY</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">l3dss1_deliver_display</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span> <span class="cm">/* Display IE included */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">datastatelist</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mt</span> <span class="o">==</span> <span class="n">datastatelist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">primitive</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">datastatelist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">datastatelist</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_STATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;dss1up%sstate %d mt %#x unhandled&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">pr</span> <span class="o">==</span> <span class="p">(</span><span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;(broadcast) &quot;</span><span class="p">,</span>
				 <span class="n">proc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">mt</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">MT_RELEASE_COMPLETE</span> <span class="o">!=</span> <span class="n">mt</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">MT_RELEASE</span> <span class="o">!=</span> <span class="n">mt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">proc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">101</span><span class="p">;</span>
			<span class="n">l3dss1_status_send</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_STATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;dss1up%sstate %d mt %x&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">pr</span> <span class="o">==</span> <span class="p">(</span><span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;(broadcast) &quot;</span><span class="p">,</span>
				 <span class="n">proc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">mt</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">datastatelist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rout</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dss1down</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">proc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">DL_ESTABLISH</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span> <span class="o">==</span> <span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l3_msg</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">CC_SETUP</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span> <span class="o">==</span> <span class="n">pr</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">CC_RESUME</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span> <span class="o">==</span> <span class="n">pr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="n">cr</span> <span class="o">=</span> <span class="n">newcallref</span><span class="p">();</span>
		<span class="n">cr</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">proc</span> <span class="o">=</span> <span class="n">dss1_new_l3_process</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">cr</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">proc</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">=</span> <span class="n">proc</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">setup_parm</span><span class="p">));</span>
			<span class="n">proc</span><span class="o">-&gt;</span><span class="n">callref</span> <span class="o">=</span> <span class="n">cr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">proc</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">proc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;HiSax dss1down without proc pr=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">==</span> <span class="p">(</span><span class="n">CC_TDSS1_IO</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">l3dss1_io_timer</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span> <span class="cm">/* timer expires */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">downstatelist</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pr</span> <span class="o">==</span> <span class="n">downstatelist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">primitive</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">downstatelist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">downstatelist</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_STATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;dss1down state %d prim %#x unhandled&quot;</span><span class="p">,</span>
				 <span class="n">proc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_STATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;dss1down state %d prim %#x&quot;</span><span class="p">,</span>
				 <span class="n">proc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">downstatelist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rout</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dss1man</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">proc</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">proc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;HiSax dss1man without proc pr=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">manstatelist</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pr</span> <span class="o">==</span> <span class="n">manstatelist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">primitive</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">manstatelist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">manstatelist</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_STATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;cr %d dss1man state %d prim %#x unhandled&quot;</span><span class="p">,</span>
				 <span class="n">proc</span><span class="o">-&gt;</span><span class="n">callref</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L3_DEB_STATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l3_debug</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&quot;cr %d dss1man state %d prim %#x&quot;</span><span class="p">,</span>
				 <span class="n">proc</span><span class="o">-&gt;</span><span class="n">callref</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">proc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">manstatelist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rout</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">setstack_dss1</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span> <span class="o">=</span> <span class="n">dss1down</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3_proto</span> <span class="o">=</span> <span class="n">l3dss1_cmd_global</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2l3</span> <span class="o">=</span> <span class="n">dss1up</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3ml3</span> <span class="o">=</span> <span class="n">dss1man</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">N303</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">last_invoke_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_used</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Bit 0 must always be set to 1 */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_used</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">global</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">l3_process</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;HiSax can&#39;t get memory for dss1 global CR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">global</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">global</span><span class="o">-&gt;</span><span class="n">callref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">global</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">global</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">L3_DEB_WARN</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">global</span><span class="o">-&gt;</span><span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">global</span><span class="o">-&gt;</span><span class="n">N303</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">global</span><span class="o">-&gt;</span><span class="n">prot</span><span class="p">.</span><span class="n">dss1</span><span class="p">.</span><span class="n">invoke_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">L3InitTimer</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">global</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">global</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">dss1_revision</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax: DSS1 Rev. %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HiSax_getrev</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
