<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hisax › elsa_ser.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>elsa_ser.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: elsa_ser.c,v 2.14.2.3 2004/02/11 13:21:33 keil Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * stuff for the serial modem on ELSA cards</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/serial_reg.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#define MAX_MODEM_BUF	256</span>
<span class="cp">#define WAKEUP_CHARS	(MAX_MODEM_BUF / 2)</span>
<span class="cp">#define RS_ISR_PASS_LIMIT 256</span>
<span class="cp">#define BASE_BAUD (1843200 / 16)</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define SERIAL<em>DEBUG</em>OPEN 1</h1>

<h1>define SERIAL<em>DEBUG</em>INTR 1</h1>

<h1>define SERIAL<em>DEBUG</em>FLOW 1</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#undef SERIAL_DEBUG_OPEN</span>
<span class="cp">#undef SERIAL_DEBUG_INTR</span>
<span class="cp">#undef SERIAL_DEBUG_FLOW</span>
<span class="cp">#undef SERIAL_DEBUG_REG</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><h1>define SERIAL<em>DEBUG</em>REG 1</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef SERIAL_DEBUG_REG</span>
<span class="k">static</span> <span class="n">u_char</span> <span class="n">deb</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ModemIn</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;RBR&quot;</span><span class="p">,</span> <span class="s">&quot;IER&quot;</span><span class="p">,</span> <span class="s">&quot;IIR&quot;</span><span class="p">,</span> <span class="s">&quot;LCR&quot;</span><span class="p">,</span> <span class="s">&quot;MCR&quot;</span><span class="p">,</span> <span class="s">&quot;LSR&quot;</span><span class="p">,</span> <span class="s">&quot;MSR&quot;</span><span class="p">,</span> <span class="s">&quot;SCR&quot;</span><span class="p">};</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ModemOut</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;THR&quot;</span><span class="p">,</span> <span class="s">&quot;IER&quot;</span><span class="p">,</span> <span class="s">&quot;FCR&quot;</span><span class="p">,</span> <span class="s">&quot;LCR&quot;</span><span class="p">,</span> <span class="s">&quot;MCR&quot;</span><span class="p">,</span> <span class="s">&quot;LSR&quot;</span><span class="p">,</span> <span class="s">&quot;MSR&quot;</span><span class="p">,</span> <span class="s">&quot;SCR&quot;</span><span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">MInit_1</span> <span class="o">=</span> <span class="s">&quot;AT&amp;F&amp;C1E0&amp;D2</span><span class="se">\r\0</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">MInit_2</span> <span class="o">=</span> <span class="s">&quot;ATL2M1S64=13</span><span class="se">\r\0</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">MInit_3</span> <span class="o">=</span> <span class="s">&quot;AT+FCLASS=0</span><span class="se">\r\0</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">MInit_4</span> <span class="o">=</span> <span class="s">&quot;ATV1S2=128X1</span><span class="se">\r\0</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">MInit_5</span> <span class="o">=</span> <span class="s">&quot;AT</span><span class="se">\\</span><span class="s">V8</span><span class="se">\\</span><span class="s">N3</span><span class="se">\r\0</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">MInit_6</span> <span class="o">=</span> <span class="s">&quot;ATL0M0&amp;G0%E1</span><span class="se">\r\0</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">MInit_7</span> <span class="o">=</span> <span class="s">&quot;AT%L1%M0%C3</span><span class="se">\r\0</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">MInit_speed28800</span> <span class="o">=</span> <span class="s">&quot;AT%G0%B28800</span><span class="se">\r\0</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">MInit_dialout</span> <span class="o">=</span> <span class="s">&quot;ATs7=60 x1 d</span><span class="se">\r\0</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">MInit_dialin</span> <span class="o">=</span> <span class="s">&quot;ATs7=60 x1 a</span><span class="se">\r\0</span><span class="s">&quot;</span><span class="p">;</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">serial_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef SERIAL_DEBUG_REG</span>
	<span class="n">u_int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;in   %s %02x&quot;</span><span class="p">,</span> <span class="n">ModemIn</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">serial_inp</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef SERIAL_DEBUG_REG</span>
<span class="cp">#ifdef ELSA_SERIAL_NOPAUSE_IO</span>
	<span class="n">u_int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;inp  %s %02x&quot;</span><span class="p">,</span> <span class="n">ModemIn</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span> <span class="n">val</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">u_int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;inP  %s %02x&quot;</span><span class="p">,</span> <span class="n">ModemIn</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span> <span class="n">val</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#ifdef ELSA_SERIAL_NOPAUSE_IO</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="n">inb_p</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">serial_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef SERIAL_DEBUG_REG</span>
	<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;out  %s %02x&quot;</span><span class="p">,</span> <span class="n">ModemOut</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span> <span class="n">value</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">serial_outp</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef SERIAL_DEBUG_REG</span>
<span class="cp">#ifdef ELSA_SERIAL_NOPAUSE_IO</span>
	<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;outp %s %02x&quot;</span><span class="p">,</span> <span class="n">ModemOut</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span> <span class="n">value</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;outP %s %02x&quot;</span><span class="p">,</span> <span class="n">ModemOut</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span> <span class="n">value</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ELSA_SERIAL_NOPAUSE_IO</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called to set the UART divisor registers to match</span>
<span class="cm"> * the specified baud rate for a serial port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">baud</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">quot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">baud_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cval</span><span class="p">,</span> <span class="n">fcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="cm">/* byte size and parity */</span>
	<span class="n">cval</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="cm">/* Determine divisor based on baud rate */</span>
	<span class="n">baud_base</span> <span class="o">=</span> <span class="n">BASE_BAUD</span><span class="p">;</span>
	<span class="n">quot</span> <span class="o">=</span> <span class="n">baud_base</span> <span class="o">/</span> <span class="n">baud</span><span class="p">;</span>
	<span class="cm">/* If the quotient is ever zero, default to 9600 bps */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">quot</span><span class="p">)</span>
		<span class="n">quot</span> <span class="o">=</span> <span class="n">baud_base</span> <span class="o">/</span> <span class="mi">9600</span><span class="p">;</span>

	<span class="cm">/* Set up FIFO&#39;s */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">baud_base</span> <span class="o">/</span> <span class="n">quot</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2400</span><span class="p">)</span>
		<span class="n">fcr</span> <span class="o">=</span> <span class="n">UART_FCR_ENABLE_FIFO</span> <span class="o">|</span> <span class="n">UART_FCR_TRIGGER_1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fcr</span> <span class="o">=</span> <span class="n">UART_FCR_ENABLE_FIFO</span> <span class="o">|</span> <span class="n">UART_FCR_TRIGGER_8</span><span class="p">;</span>
	<span class="n">serial_outp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_FCR</span><span class="p">,</span> <span class="n">fcr</span><span class="p">);</span>
	<span class="cm">/* CTS flow control flag and modem status interrupts */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">IER</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_IER_MSI</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">UART_IER_MSI</span><span class="p">;</span>
	<span class="n">serial_outp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">IER</span><span class="p">);</span>

	<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;modem quot=0x%x&quot;</span><span class="p">,</span> <span class="n">quot</span><span class="p">);</span>
	<span class="n">serial_outp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">cval</span> <span class="o">|</span> <span class="n">UART_LCR_DLAB</span><span class="p">);</span><span class="cm">/* set DLAB */</span>
	<span class="n">serial_outp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_DLL</span><span class="p">,</span> <span class="n">quot</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>		<span class="cm">/* LS of divisor */</span>
	<span class="n">serial_outp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_DLM</span><span class="p">,</span> <span class="n">quot</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>		<span class="cm">/* MS of divisor */</span>
	<span class="n">serial_outp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">cval</span><span class="p">);</span>		<span class="cm">/* reset DLAB */</span>
	<span class="n">serial_inp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_RX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mstartup</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the FIFO buffers and disable them</span>
<span class="cm">	 * (they will be reenabled in change_speed())</span>
<span class="cm">	 */</span>
	<span class="n">serial_outp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_FCR</span><span class="p">,</span> <span class="p">(</span><span class="n">UART_FCR_CLEAR_RCVR</span> <span class="o">|</span> <span class="n">UART_FCR_CLEAR_XMIT</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * At this point there&#39;s no way the LSR could still be 0xFF;</span>
<span class="cm">	 * if it is, then bail out, because there&#39;s likely no UART</span>
<span class="cm">	 * here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serial_inp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_LSR</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the interrupt registers.</span>
<span class="cm">	 */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">serial_inp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_RX</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">serial_inp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_IIR</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">serial_inp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_MSR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now, initialize the UART</span>
<span class="cm">	 */</span>
	<span class="n">serial_outp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_WLEN8</span><span class="p">);</span>	<span class="cm">/* reset DLAB */</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">MCR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">MCR</span> <span class="o">=</span> <span class="n">UART_MCR_DTR</span> <span class="o">|</span> <span class="n">UART_MCR_RTS</span> <span class="o">|</span> <span class="n">UART_MCR_OUT2</span><span class="p">;</span>
	<span class="n">serial_outp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">MCR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Finally, enable interrupts</span>
<span class="cm">	 */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">IER</span> <span class="o">=</span> <span class="n">UART_IER_MSI</span> <span class="o">|</span> <span class="n">UART_IER_RLSI</span> <span class="o">|</span> <span class="n">UART_IER_RDI</span><span class="p">;</span>
	<span class="n">serial_outp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">IER</span><span class="p">);</span>	<span class="cm">/* enable interrupts */</span>

	<span class="cm">/*</span>
<span class="cm">	 * And clear the interrupt registers again for luck.</span>
<span class="cm">	 */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">serial_inp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_LSR</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">serial_inp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_RX</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">serial_inp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_IIR</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">serial_inp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_MSR</span><span class="p">);</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">rcvcnt</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">rcvp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * and set the speed of the serial port</span>
<span class="cm">	 */</span>
	<span class="n">change_speed</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">BASE_BAUD</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">MFlag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">errout:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine will shutdown a serial port; interrupts are disabled, and</span>
<span class="cm"> * DTR is dropped if the hangup on close termio flag is on.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mshutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>

<span class="cp">#ifdef SERIAL_DEBUG_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="s">&quot;Shutting down serial ....&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * clear delta_msr_wait queue to avoid mem leaks: we may free the irq</span>
<span class="cm">	 * here so the queue might never be waken up</span>
<span class="cm">	 */</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">IER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">serial_outp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* disable all intrs */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">MCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_MCR_OUT2</span><span class="p">;</span>

	<span class="cm">/* disable break condition */</span>
	<span class="n">serial_outp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">serial_inp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">UART_LCR_SBC</span><span class="p">);</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">MCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">UART_MCR_DTR</span> <span class="o">|</span> <span class="n">UART_MCR_RTS</span><span class="p">);</span>
	<span class="n">serial_outp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">MCR</span><span class="p">);</span>

	<span class="cm">/* disable FIFO&#39;s */</span>
	<span class="n">serial_outp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_FCR</span><span class="p">,</span> <span class="p">(</span><span class="n">UART_FCR_CLEAR_RCVR</span> <span class="o">|</span> <span class="n">UART_FCR_CLEAR_XMIT</span><span class="p">));</span>
	<span class="n">serial_inp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_RX</span><span class="p">);</span>    <span class="cm">/* read data port to reset things */</span>

<span class="cp">#ifdef SERIAL_DEBUG_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">write_modem</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">fp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">MAX_MODEM_BUF</span> <span class="o">-</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">MAX_MODEM_BUF</span> <span class="o">-</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span><span class="p">;</span>
	<span class="n">fp</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span> <span class="o">+</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transp</span><span class="p">;</span>
	<span class="n">fp</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">MAX_MODEM_BUF</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">MAX_MODEM_BUF</span> <span class="o">-</span> <span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">MAX_MODEM_BUF</span> <span class="o">-</span> <span class="n">fp</span><span class="p">;</span>
		<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span>
					  <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transbuf</span> <span class="o">+</span> <span class="n">fp</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span>
				  <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transbuf</span> <span class="o">+</span> <span class="n">fp</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">IER</span> <span class="o">&amp;</span> <span class="n">UART_IER_THRI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">UART_IER_THRI</span><span class="p">;</span>
		<span class="n">serial_outp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">IER</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">modem_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">write_modem</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_LLI_L1WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">flag</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">PACKET_NOACK</span> <span class="o">!=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">u_long</span>	<span class="n">flags</span><span class="p">;</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aclock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ackcnt</span> <span class="o">+=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aclock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">schedule_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_ACKPENDING</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="n">write_modem</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="n">schedule_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_XMTBUFREADY</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">receive_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="n">serial_in</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_RX</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">rcvcnt</span> <span class="o">&gt;=</span> <span class="n">MAX_MODEM_BUF</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">rcvbuf</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">rcvcnt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DR%02x:%02x...&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="o">*</span><span class="n">status</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UART_LSR_BI</span> <span class="o">|</span> <span class="n">UART_LSR_PE</span> <span class="o">|</span>
			       <span class="n">UART_LSR_FE</span> <span class="o">|</span> <span class="n">UART_LSR_OE</span><span class="p">))</span> <span class="p">{</span>

<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;handling exept....&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">serial_inp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_LSR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_DR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">MFlag</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">rcvcnt</span><span class="p">)))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ElsaSER: receive out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">rcvcnt</span><span class="p">),</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">rcvbuf</span><span class="p">,</span>
			       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">rcvcnt</span><span class="p">);</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rqueue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_RCVBUFREADY</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="n">t</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&quot;modem read cnt %d&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">rcvcnt</span><span class="p">);</span>
		<span class="n">QuickHex</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">rcvbuf</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">rcvcnt</span><span class="p">);</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">rcvcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">transmit_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">intr_done</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;transmit_chars: p(%x) cnt(%x)&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transp</span><span class="p">,</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">IER</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_IER_THRI</span><span class="p">;</span>
		<span class="n">serial_out</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">IER</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">serial_outp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_TX</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transbuf</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transp</span><span class="o">++</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transp</span> <span class="o">&gt;=</span> <span class="n">MAX_MODEM_BUF</span><span class="p">)</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">MFlag</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">modem_fill</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">bcs</span><span class="p">);</span>

<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;THRE...&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr_done</span><span class="p">)</span>
		<span class="o">*</span><span class="n">intr_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">IER</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_IER_THRI</span><span class="p">;</span>
		<span class="n">serial_outp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">IER</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs_interrupt_elsa</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">iir</span><span class="p">,</span> <span class="n">msr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pass_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;rs_interrupt_single(%d)...&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">serial_inp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_LSR</span><span class="p">);</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;rs LSR %02x&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;status = %x...&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_DR</span><span class="p">)</span>
			<span class="n">receive_chars</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_THRE</span><span class="p">)</span>
			<span class="n">transmit_chars</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pass_counter</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">RS_ISR_PASS_LIMIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;rs_single loop break.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">iir</span> <span class="o">=</span> <span class="n">serial_inp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_IIR</span><span class="p">);</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;rs IIR %02x&quot;</span><span class="p">,</span> <span class="n">iir</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msr</span> <span class="o">=</span> <span class="n">serial_inp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_MSR</span><span class="p">);</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;rs MSR %02x&quot;</span><span class="p">,</span> <span class="n">msr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">UART_IIR_NO_INT</span><span class="p">));</span>
<span class="cp">#ifdef SERIAL_DEBUG_INTR</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;end.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">open_hscxstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">modehscx</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bc</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">hscx_l2l1</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">close_elsastate</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">modehscx</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvbuf</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">L1_MODE_MODEM</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvbuf</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rqueue</span><span class="p">);</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">modem_write_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">fp</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">MAX_MODEM_BUF</span> <span class="o">-</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fp</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span> <span class="o">+</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transp</span><span class="p">;</span>
	<span class="n">fp</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">MAX_MODEM_BUF</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">MAX_MODEM_BUF</span> <span class="o">-</span> <span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">MAX_MODEM_BUF</span> <span class="o">-</span> <span class="n">fp</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transbuf</span> <span class="o">+</span> <span class="n">fp</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">msg</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transbuf</span> <span class="o">+</span> <span class="n">fp</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">IER</span> <span class="o">&amp;</span> <span class="n">UART_IER_THRI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">IER</span> <span class="o">|=</span> <span class="n">UART_IER_THRI</span><span class="p">;</span>
		<span class="n">serial_outp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">IER</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">modem_set_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

<span class="cp">#define RCV_DELAY 20</span>
	<span class="n">modem_write_cmd</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MInit_1</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">MInit_1</span><span class="p">));</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;msi tout=%d&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="n">RCV_DELAY</span><span class="p">);</span>
	<span class="n">modem_write_cmd</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MInit_2</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">MInit_2</span><span class="p">));</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;msi tout=%d&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="n">RCV_DELAY</span><span class="p">);</span>
	<span class="n">modem_write_cmd</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MInit_3</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">MInit_3</span><span class="p">));</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;msi tout=%d&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="n">RCV_DELAY</span><span class="p">);</span>
	<span class="n">modem_write_cmd</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MInit_4</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">MInit_4</span><span class="p">));</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;msi tout=%d&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="n">RCV_DELAY</span><span class="p">);</span>
	<span class="n">modem_write_cmd</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MInit_5</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">MInit_5</span><span class="p">));</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;msi tout=%d&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="n">RCV_DELAY</span><span class="p">);</span>
	<span class="n">modem_write_cmd</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MInit_6</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">MInit_6</span><span class="p">));</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;msi tout=%d&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="n">RCV_DELAY</span><span class="p">);</span>
	<span class="n">modem_write_cmd</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MInit_7</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">MInit_7</span><span class="p">));</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;msi tout=%d&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="n">RCV_DELAY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">modem_set_dial</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">outgoing</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
<span class="cp">#define RCV_DELAY 20</span>

	<span class="n">modem_write_cmd</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MInit_speed28800</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">MInit_speed28800</span><span class="p">));</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;msi tout=%d&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="n">RCV_DELAY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">outgoing</span><span class="p">)</span>
		<span class="n">modem_write_cmd</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MInit_dialout</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">MInit_dialout</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">modem_write_cmd</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MInit_dialin</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">MInit_dialin</span><span class="p">));</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transcnt</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;msi tout=%d&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="n">RCV_DELAY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">modem_l2l1</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bcs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">==</span> <span class="p">(</span><span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">write_modem</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">==</span> <span class="p">(</span><span class="n">PH_ACTIVATE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">BC_FLG_ACTIV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_ACTIVATE</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">set_arcofi</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bc</span><span class="p">);</span>
		<span class="n">mstartup</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">modem_set_dial</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ORIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">flag</span><span class="p">));</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">MFlag</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">==</span> <span class="p">(</span><span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_ACTIV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">arcofi_bc</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bc</span><span class="p">;</span>
		<span class="n">arcofi_fsm</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">ARCOFI_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ARCOFI_XOP_0</span><span class="p">);</span>
		<span class="n">interruptible_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">arcofi_wait</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">MFlag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ElsaSer: unknown pr %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">setstack_elsa</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bc</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L1_MODE_HDLC</span>:
	<span class="k">case</span> <span class="n">L1_MODE_TRANS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">open_hscxstate</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">,</span> <span class="n">bcs</span><span class="p">))</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2l1</span> <span class="o">=</span> <span class="n">hscx_l2l1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">L1_MODE_MODEM</span>:
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">L1_MODE_MODEM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">BC_FLG_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">rcvbuf</span><span class="p">;</span>
			<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rqueue</span><span class="p">);</span>
			<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">bcs</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2l1</span> <span class="o">=</span> <span class="n">modem_l2l1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">bcs</span><span class="p">;</span>
	<span class="n">setstack_manager</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="p">;</span>
	<span class="n">setstack_l1_B</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">init_modem</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">BC_SetStack</span> <span class="o">=</span> <span class="n">setstack_elsa</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">BC_SetStack</span> <span class="o">=</span> <span class="n">setstack_elsa</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">BC_Close</span> <span class="o">=</span> <span class="n">close_elsastate</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">BC_Close</span> <span class="o">=</span> <span class="n">close_elsastate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MAX_MODEM_BUF</span><span class="p">,</span>
					   <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;Elsa: No modem mem hw.elsa.rcvbuf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MAX_MODEM_BUF</span><span class="p">,</span>
					     <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;Elsa: No modem mem hw.elsa.transbuf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">rcvbuf</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mstartup</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Elsa: problem startup modem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">modem_set_init</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">release_modem</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">MFlag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">rcvbuf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mshutdown</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">rcvbuf</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transbuf</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">transbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
