<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hisax › st5481.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>st5481.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for ST5481 USB ISDN modem</span>
<span class="cm"> *</span>
<span class="cm"> * Author       Frode Isaksen</span>
<span class="cm"> * Copyright    2001 by Frode Isaksen      &lt;fisaksen@bewan.com&gt;</span>
<span class="cm"> *              2001 by Kai Germaschewski  &lt;kai.germaschewski@gmx.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _ST5481_H_</span>
<span class="cp">#define _ST5481_H_</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>USB IDs, the Product Id is in the range 0x4810-0x481F</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define ST_VENDOR_ID 0x0483</span>
<span class="cp">#define ST5481_PRODUCT_ID 0x4810</span>
<span class="cp">#define ST5481_PRODUCT_ID_MASK 0xFFF0</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>ST5481 endpoints when using alternative setting 3 (2B+D).
To get the endpoint address, OR with 0x80 for IN endpoints.</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define EP_CTRL   0x00U </span><span class="cm">/* Control endpoint */</span><span class="cp"></span>
<span class="cp">#define EP_INT    0x01U </span><span class="cm">/* Interrupt endpoint */</span><span class="cp"></span>
<span class="cp">#define EP_B1_OUT 0x02U </span><span class="cm">/* B1 channel out */</span><span class="cp"></span>
<span class="cp">#define EP_B1_IN  0x03U </span><span class="cm">/* B1 channel in */</span><span class="cp"></span>
<span class="cp">#define EP_B2_OUT 0x04U </span><span class="cm">/* B2 channel out */</span><span class="cp"></span>
<span class="cp">#define EP_B2_IN  0x05U </span><span class="cm">/* B2 channel in */</span><span class="cp"></span>
<span class="cp">#define EP_D_OUT  0x06U </span><span class="cm">/* D channel out */</span><span class="cp"></span>
<span class="cp">#define EP_D_IN   0x07U </span><span class="cm">/* D channel in */</span><span class="cp"></span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Number of isochronous packets. With 20 packets we get
50 interrupts/sec for each endpoint.</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define NUM_ISO_PACKETS_D      20</span>
<span class="cp">#define NUM_ISO_PACKETS_B      20</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Size of each isochronous packet.
In outgoing direction we need to match ISDN data rates:
D:  2 bytes / msec -> 16 kbit / s
B: 16 bytes / msec -> 64 kbit / s</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define SIZE_ISO_PACKETS_D_IN  16</span>
<span class="cp">#define SIZE_ISO_PACKETS_D_OUT 2</span>
<span class="cp">#define SIZE_ISO_PACKETS_B_IN  32</span>
<span class="cp">#define SIZE_ISO_PACKETS_B_OUT 8</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>If we overrun/underrun, we send one packet with +/- 2 bytes</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define B_FLOW_ADJUST 2</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Registers that are written using vendor specific device request
on endpoint 0.</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define LBA			0x02 </span><span class="cm">/* S loopback */</span><span class="cp"></span>
<span class="cp">#define SET_DEFAULT		0x06 </span><span class="cm">/* Soft reset */</span><span class="cp"></span>
<span class="cp">#define LBB			0x1D </span><span class="cm">/* S maintenance loopback */</span><span class="cp"></span>
<span class="cp">#define STT			0x1e </span><span class="cm">/* S force transmission signals */</span><span class="cp"></span>
<span class="cp">#define SDA_MIN			0x20 </span><span class="cm">/* SDA-sin minimal value */</span><span class="cp"></span>
<span class="cp">#define SDA_MAX			0x21 </span><span class="cm">/* SDA-sin maximal value */</span><span class="cp"></span>
<span class="cp">#define SDELAY_VALUE		0x22 </span><span class="cm">/* Delay between Tx and Rx clock */</span><span class="cp"></span>
<span class="cp">#define IN_D_COUNTER		0x36 </span><span class="cm">/* D receive channel fifo counter */</span><span class="cp"></span>
<span class="cp">#define OUT_D_COUNTER		0x37 </span><span class="cm">/* D transmit channel fifo counter */</span><span class="cp"></span>
<span class="cp">#define IN_B1_COUNTER		0x38 </span><span class="cm">/* B1 receive channel fifo counter */</span><span class="cp"></span>
<span class="cp">#define OUT_B1_COUNTER		0x39 </span><span class="cm">/* B1 transmit channel fifo counter */</span><span class="cp"></span>
<span class="cp">#define IN_B2_COUNTER		0x3a </span><span class="cm">/* B2 receive channel fifo counter */</span><span class="cp"></span>
<span class="cp">#define OUT_B2_COUNTER		0x3b </span><span class="cm">/* B2 transmit channel fifo counter */</span><span class="cp"></span>
<span class="cp">#define FFCTRL_IN_D		0x3C </span><span class="cm">/* D receive channel fifo threshold low */</span><span class="cp"></span>
<span class="cp">#define FFCTRH_IN_D		0x3D </span><span class="cm">/* D receive channel fifo threshold high */</span><span class="cp"></span>
<span class="cp">#define FFCTRL_OUT_D		0x3E </span><span class="cm">/* D transmit channel fifo threshold low */</span><span class="cp"></span>
<span class="cp">#define FFCTRH_OUT_D		0x3F </span><span class="cm">/* D transmit channel fifo threshold high */</span><span class="cp"></span>
<span class="cp">#define FFCTRL_IN_B1		0x40 </span><span class="cm">/* B1 receive channel fifo threshold low */</span><span class="cp"></span>
<span class="cp">#define FFCTRH_IN_B1		0x41 </span><span class="cm">/* B1 receive channel fifo threshold high */</span><span class="cp"></span>
<span class="cp">#define FFCTRL_OUT_B1		0x42 </span><span class="cm">/* B1 transmit channel fifo threshold low */</span><span class="cp"></span>
<span class="cp">#define FFCTRH_OUT_B1		0x43 </span><span class="cm">/* B1 transmit channel fifo threshold high */</span><span class="cp"></span>
<span class="cp">#define FFCTRL_IN_B2		0x44 </span><span class="cm">/* B2 receive channel fifo threshold low */</span><span class="cp"></span>
<span class="cp">#define FFCTRH_IN_B2		0x45 </span><span class="cm">/* B2 receive channel fifo threshold high */</span><span class="cp"></span>
<span class="cp">#define FFCTRL_OUT_B2		0x46 </span><span class="cm">/* B2 transmit channel fifo threshold low */</span><span class="cp"></span>
<span class="cp">#define FFCTRH_OUT_B2		0x47 </span><span class="cm">/* B2 transmit channel fifo threshold high */</span><span class="cp"></span>
<span class="cp">#define MPMSK			0x4A </span><span class="cm">/* Multi purpose interrupt MASK register */</span><span class="cp"></span>
<span class="cp">#define	FFMSK_D			0x4c </span><span class="cm">/* D fifo interrupt MASK register */</span><span class="cp"></span>
<span class="cp">#define	FFMSK_B1		0x4e </span><span class="cm">/* B1 fifo interrupt MASK register */</span><span class="cp"></span>
<span class="cp">#define	FFMSK_B2		0x50 </span><span class="cm">/* B2 fifo interrupt MASK register */</span><span class="cp"></span>
<span class="cp">#define GPIO_DIR		0x52 </span><span class="cm">/* GPIO pins direction registers */</span><span class="cp"></span>
<span class="cp">#define GPIO_OUT		0x53 </span><span class="cm">/* GPIO pins output register */</span><span class="cp"></span>
<span class="cp">#define GPIO_IN			0x54 </span><span class="cm">/* GPIO pins input register */</span><span class="cp"></span>
<span class="cp">#define TXCI			0x56 </span><span class="cm">/* CI command to be transmitted */</span><span class="cp"></span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Format of the interrupt packet received on endpoint 1:</p>

<p>+--------+--------+--------+--------+--------+--------+
!MPINT   !FFINT<em>D !FFINT</em>B1!FFINT<em>B2!CCIST   !GPIO</em>INT!
+--------+--------+--------+--------+--------+--------+</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Offsets in the interrupt packet</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define MPINT			0</span>
<span class="cp">#define FFINT_D			1</span>
<span class="cp">#define FFINT_B1		2</span>
<span class="cp">#define FFINT_B2		3</span>
<span class="cp">#define CCIST			4</span>
<span class="cp">#define GPIO_INT		5</span>
<span class="cp">#define INT_PKT_SIZE            6</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>MPINT</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define LSD_INT                 0x80 </span><span class="cm">/* S line activity detected */</span><span class="cp"></span>
<span class="cp">#define RXCI_INT		0x40 </span><span class="cm">/* Indicate primitive arrived */</span><span class="cp"></span>
<span class="cp">#define	DEN_INT			0x20 </span><span class="cm">/* Signal enabling data out of D Tx fifo */</span><span class="cp"></span>
<span class="cp">#define DCOLL_INT		0x10 </span><span class="cm">/* D channel collision */</span><span class="cp"></span>
<span class="cp">#define AMIVN_INT		0x04 </span><span class="cm">/* AMI violation number reached 2 */</span><span class="cp"></span>
<span class="cp">#define INFOI_INT		0x04 </span><span class="cm">/* INFOi changed */</span><span class="cp"></span>
<span class="cp">#define DRXON_INT               0x02 </span><span class="cm">/* Reception channel active */</span><span class="cp"></span>
<span class="cp">#define GPCHG_INT               0x01 </span><span class="cm">/* GPIO pin value changed */</span><span class="cp"></span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>FFINT_x</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define IN_OVERRUN		0x80 </span><span class="cm">/* In fifo overrun */</span><span class="cp"></span>
<span class="cp">#define OUT_UNDERRUN		0x40 </span><span class="cm">/* Out fifo underrun */</span><span class="cp"></span>
<span class="cp">#define IN_UP			0x20 </span><span class="cm">/* In fifo thresholdh up-crossed */</span><span class="cp"></span>
<span class="cp">#define IN_DOWN			0x10 </span><span class="cm">/* In fifo thresholdl down-crossed */</span><span class="cp"></span>
<span class="cp">#define OUT_UP			0x08 </span><span class="cm">/* Out fifo thresholdh up-crossed */</span><span class="cp"></span>
<span class="cp">#define OUT_DOWN		0x04 </span><span class="cm">/* Out fifo thresholdl down-crossed */</span><span class="cp"></span>
<span class="cp">#define IN_COUNTER_ZEROED	0x02 </span><span class="cm">/* In down-counter reached 0 */</span><span class="cp"></span>
<span class="cp">#define OUT_COUNTER_ZEROED	0x01 </span><span class="cm">/* Out down-counter reached 0 */</span><span class="cp"></span>

<span class="cp">#define ANY_REC_INT	(IN_OVERRUN + IN_UP + IN_DOWN + IN_COUNTER_ZEROED)</span>
<span class="cp">#define ANY_XMIT_INT	(OUT_UNDERRUN + OUT_UP + OUT_DOWN + OUT_COUNTER_ZEROED)</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Level 1 commands that are sent using the TXCI device request</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define ST5481_CMD_DR		 0x0 </span><span class="cm">/* Deactivation Request */</span><span class="cp"></span>
<span class="cp">#define ST5481_CMD_RES		 0x1 </span><span class="cm">/* state machine RESet */</span><span class="cp"></span>
<span class="cp">#define ST5481_CMD_TM1		 0x2 </span><span class="cm">/* Test Mode 1 */</span><span class="cp"></span>
<span class="cp">#define ST5481_CMD_TM2		 0x3 </span><span class="cm">/* Test Mode 2 */</span><span class="cp"></span>
<span class="cp">#define ST5481_CMD_PUP		 0x7 </span><span class="cm">/* Power UP */</span><span class="cp"></span>
<span class="cp">#define ST5481_CMD_AR8		 0x8 </span><span class="cm">/* Activation Request class 1 */</span><span class="cp"></span>
<span class="cp">#define ST5481_CMD_AR10		 0x9 </span><span class="cm">/* Activation Request class 2 */</span><span class="cp"></span>
<span class="cp">#define ST5481_CMD_ARL		 0xA </span><span class="cm">/* Activation Request Loopback */</span><span class="cp"></span>
<span class="cp">#define ST5481_CMD_PDN		 0xF </span><span class="cm">/* Power DoWn */</span><span class="cp"></span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Turn on/off the LEDs using the GPIO device request.
To use the B LEDs, number<em>of</em>leds must be set to 4</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define B1_LED		0x10U</span>
<span class="cp">#define B2_LED		0x20U</span>
<span class="cp">#define GREEN_LED	0x40U</span>
<span class="cp">#define RED_LED	        0x80U</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>D channel out states</p></td><td class="code"><div class="highlight"><pre><span class="k">enum</span> <span class="p">{</span>
	<span class="n">ST_DOUT_NONE</span><span class="p">,</span>

	<span class="n">ST_DOUT_SHORT_INIT</span><span class="p">,</span>
	<span class="n">ST_DOUT_SHORT_WAIT_DEN</span><span class="p">,</span>

	<span class="n">ST_DOUT_LONG_INIT</span><span class="p">,</span>
	<span class="n">ST_DOUT_LONG_WAIT_DEN</span><span class="p">,</span>
	<span class="n">ST_DOUT_NORMAL</span><span class="p">,</span>

	<span class="n">ST_DOUT_WAIT_FOR_UNDERRUN</span><span class="p">,</span>
	<span class="n">ST_DOUT_WAIT_FOR_NOT_BUSY</span><span class="p">,</span>
	<span class="n">ST_DOUT_WAIT_FOR_STOP</span><span class="p">,</span>
	<span class="n">ST_DOUT_WAIT_FOR_RESET</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define DOUT_STATE_COUNT (ST_DOUT_WAIT_FOR_RESET + 1)</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>D channel out events</p></td><td class="code"><div class="highlight"><pre><span class="k">enum</span> <span class="p">{</span>
	<span class="n">EV_DOUT_START_XMIT</span><span class="p">,</span>
	<span class="n">EV_DOUT_COMPLETE</span><span class="p">,</span>
	<span class="n">EV_DOUT_DEN</span><span class="p">,</span>
	<span class="n">EV_DOUT_RESETED</span><span class="p">,</span>
	<span class="n">EV_DOUT_STOPPED</span><span class="p">,</span>
	<span class="n">EV_DOUT_COLL</span><span class="p">,</span>
	<span class="n">EV_DOUT_UNDERRUN</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define DOUT_EVENT_COUNT (EV_DOUT_UNDERRUN + 1)</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><hr /></td><td class="code"><div class="highlight"><pre><span class="k">enum</span> <span class="p">{</span>
	<span class="n">ST_L1_F3</span><span class="p">,</span>
	<span class="n">ST_L1_F4</span><span class="p">,</span>
	<span class="n">ST_L1_F6</span><span class="p">,</span>
	<span class="n">ST_L1_F7</span><span class="p">,</span>
	<span class="n">ST_L1_F8</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define L1_STATE_COUNT (ST_L1_F8 + 1)</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>The first 16 entries match the Level 1 indications that
are found at offset 4 (CCIST) in the interrupt packet</p></td><td class="code"><div class="highlight"><pre><span class="k">enum</span> <span class="p">{</span>
	<span class="n">EV_IND_DP</span><span class="p">,</span>  <span class="c1">// 0000 Deactivation Pending</span>
	<span class="n">EV_IND_1</span><span class="p">,</span>   <span class="c1">// 0001</span>
	<span class="n">EV_IND_2</span><span class="p">,</span>   <span class="c1">// 0010</span>
	<span class="n">EV_IND_3</span><span class="p">,</span>   <span class="c1">// 0011</span>
	<span class="n">EV_IND_RSY</span><span class="p">,</span> <span class="c1">// 0100 ReSYnchronizing</span>
	<span class="n">EV_IND_5</span><span class="p">,</span>   <span class="c1">// 0101</span>
	<span class="n">EV_IND_6</span><span class="p">,</span>   <span class="c1">// 0110</span>
	<span class="n">EV_IND_7</span><span class="p">,</span>   <span class="c1">// 0111</span>
	<span class="n">EV_IND_AP</span><span class="p">,</span>  <span class="c1">// 1000 Activation Pending</span>
	<span class="n">EV_IND_9</span><span class="p">,</span>   <span class="c1">// 1001</span>
	<span class="n">EV_IND_10</span><span class="p">,</span>  <span class="c1">// 1010</span>
	<span class="n">EV_IND_11</span><span class="p">,</span>  <span class="c1">// 1011</span>
	<span class="n">EV_IND_AI8</span><span class="p">,</span> <span class="c1">// 1100 Activation Indication class 8</span>
	<span class="n">EV_IND_AI10</span><span class="p">,</span><span class="c1">// 1101 Activation Indication class 10</span>
	<span class="n">EV_IND_AIL</span><span class="p">,</span> <span class="c1">// 1110 Activation Indication Loopback</span>
	<span class="n">EV_IND_DI</span><span class="p">,</span>  <span class="c1">// 1111 Deactivation Indication</span>
	<span class="n">EV_PH_ACTIVATE_REQ</span><span class="p">,</span>
	<span class="n">EV_PH_DEACTIVATE_REQ</span><span class="p">,</span>
	<span class="n">EV_TIMER3</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define L1_EVENT_COUNT (EV_TIMER3 + 1)</span>

<span class="cp">#define ERR(format, arg...)						\</span>
<span class="cp">	printk(KERN_ERR &quot;%s:%s: &quot; format &quot;\n&quot; , __FILE__,  __func__ , ## arg)</span>

<span class="cp">#define WARNING(format, arg...)						\</span>
<span class="cp">	printk(KERN_WARNING &quot;%s:%s: &quot; format &quot;\n&quot; , __FILE__,  __func__ , ## arg)</span>

<span class="cp">#define INFO(format, arg...)						\</span>
<span class="cp">	printk(KERN_INFO &quot;%s:%s: &quot; format &quot;\n&quot; , __FILE__,  __func__ , ## arg)</span>

<span class="cp">#include &lt;linux/isdn/hdlc.h&gt;</span>
<span class="cp">#include &quot;fsm.h&quot;</span>
<span class="cp">#include &quot;hisax_if.h&quot;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>

<span class="cm">/* ======================================================================</span>
<span class="cm"> * FIFO handling</span>
<span class="cm"> */</span>

<span class="cm">/* Generic FIFO structure */</span>
<span class="k">struct</span> <span class="n">fifo</span> <span class="p">{</span>
	<span class="n">u_char</span> <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Init an FIFO</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fifo_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">r</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add an entry to the FIFO</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">fifo_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fifo</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>FIFO full</p></td><td class="code"><div class="highlight"><pre>		<span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Return index where to get the next data to add to the FIFO</p></td><td class="code"><div class="highlight"><pre>		<span class="n">index</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">w</span><span class="o">++</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Remove an entry from the FIFO with the index returned.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">fifo_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fifo</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>FIFO empty</p></td><td class="code"><div class="highlight"><pre>		<span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>Return index where to get the next data from the FIFO</p></td><td class="code"><div class="highlight"><pre>		<span class="n">index</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">r</span><span class="o">++</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ======================================================================</span>
<span class="cm"> * control pipe</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">ctrl_complete_t</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">ctrl_msg</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="n">dr</span><span class="p">;</span>
	<span class="n">ctrl_complete_t</span> <span class="n">complete</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ctrl_msg</span><span class="p">;</span>

<span class="cm">/* FIFO of ctrl messages waiting to be sent */</span>
<span class="cp">#define MAX_EP0_MSG 16</span>
<span class="k">struct</span> <span class="n">ctrl_msg_fifo</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fifo</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ctrl_msg</span> <span class="n">data</span><span class="p">[</span><span class="n">MAX_EP0_MSG</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define MAX_DFRAME_LEN_L1	300</span>
<span class="cp">#define HSCX_BUFMAX	4096</span>

<span class="k">struct</span> <span class="n">st5481_ctrl</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ctrl_msg_fifo</span> <span class="n">msg_fifo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">busy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">st5481_intr</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>struct evt<em>fifo evt</em>fifo;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">st5481_d_out</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">isdnhdlc_vars</span> <span class="n">hdlc_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="cm">/* double buffering */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">busy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tx_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">FsmInst</span> <span class="n">fsm</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">st5481_b_out</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">isdnhdlc_vars</span> <span class="n">hdlc_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="cm">/* double buffering */</span>
	<span class="n">u_char</span> <span class="n">flow_event</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">busy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tx_skb</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">st5481_in</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">isdnhdlc_vars</span> <span class="n">hdlc_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="cm">/* double buffering */</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bufsize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_packets</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">packet_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ep</span><span class="p">,</span> <span class="n">counter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rcvbuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st5481_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hisax_if</span> <span class="o">*</span><span class="n">hisax_if</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">st5481_setup_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">st5481_in</span> <span class="o">*</span><span class="n">in</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">st5481_release_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">st5481_in</span> <span class="o">*</span><span class="n">in</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">st5481_in_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">st5481_in</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">st5481_bcs</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hisax_b_if</span> <span class="n">b_if</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st5481_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st5481_in</span> <span class="n">b_in</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st5481_b_out</span> <span class="n">b_out</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">st5481_adapter</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">number_of_leds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hisax_d_if</span> <span class="n">hisax_d_if</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">st5481_ctrl</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st5481_intr</span> <span class="n">intr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st5481_in</span> <span class="n">d_in</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st5481_d_out</span> <span class="n">d_out</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">leds</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">led_counter</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">FsmInst</span> <span class="n">l1m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">FsmTimer</span> <span class="n">timer</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">st5481_bcs</span> <span class="n">bcs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define TIMER3_VALUE 7000</span>

<span class="cm">/* ======================================================================</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Submit an URB with error reporting. This is a macro so</span>
<span class="cm"> * the __func__ returns the caller function name.</span>
<span class="cm"> */</span>
<span class="cp">#define SUBMIT_URB(urb, mem_flags)					\</span>
<span class="cp">	({								\</span>
<span class="cp">		int status;						\</span>
<span class="cp">		if ((status = usb_submit_urb(urb, mem_flags)) &lt; 0) {	\</span>
<span class="cp">			WARNING(&quot;usb_submit_urb failed,status=%d&quot;, status); \</span>
<span class="cp">		}							\</span>
<span class="cp">		status;							\</span>
<span class="cp">	})</span>

<span class="cm">/*</span>
<span class="cm"> * USB double buffering, return the URB index (0 or 1).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get_buf_nr</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urbs</span><span class="p">[],</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">urbs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">urb</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>

<span class="cm">/* B Channel */</span>

<span class="kt">int</span>  <span class="n">st5481_setup_b</span><span class="p">(</span><span class="k">struct</span> <span class="n">st5481_bcs</span> <span class="o">*</span><span class="n">bcs</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">st5481_release_b</span><span class="p">(</span><span class="k">struct</span> <span class="n">st5481_bcs</span> <span class="o">*</span><span class="n">bcs</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">st5481_d_l2l1</span><span class="p">(</span><span class="k">struct</span> <span class="n">hisax_if</span> <span class="o">*</span><span class="n">hisax_d_if</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>

<span class="cm">/* D Channel */</span>

<span class="kt">int</span>  <span class="n">st5481_setup_d</span><span class="p">(</span><span class="k">struct</span> <span class="n">st5481_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">st5481_release_d</span><span class="p">(</span><span class="k">struct</span> <span class="n">st5481_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">st5481_b_l2l1</span><span class="p">(</span><span class="k">struct</span> <span class="n">hisax_if</span> <span class="o">*</span><span class="n">b_if</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="kt">int</span>  <span class="n">st5481_d_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">st5481_d_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* USB */</span>
<span class="kt">void</span> <span class="n">st5481_ph_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">st5481_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">command</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">st5481_setup_isocpipes</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_packets</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">packet_size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_size</span><span class="p">,</span>
			   <span class="n">usb_complete_t</span> <span class="n">complete</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">st5481_release_isocpipes</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

<span class="kt">void</span> <span class="n">st5481_usb_pipe_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">st5481_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			   <span class="n">u_char</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">ctrl_complete_t</span> <span class="n">complete</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">st5481_usb_device_ctrl_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">st5481_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">request</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span>
				<span class="n">ctrl_complete_t</span> <span class="n">complete</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">);</span>
<span class="kt">int</span>  <span class="n">st5481_setup_usb</span><span class="p">(</span><span class="k">struct</span> <span class="n">st5481_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">st5481_release_usb</span><span class="p">(</span><span class="k">struct</span> <span class="n">st5481_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">st5481_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">st5481_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">st5481_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">st5481_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><hr />

<p>debugging macros</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define __debug_variable st5481_debug</span>
<span class="cp">#include &quot;hisax_debug.h&quot;</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">st5481_debug</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_HISAX_DEBUG</span>

<span class="cp">#define DBG_ISO_PACKET(level, urb)					\</span>
<span class="cp">	if (level &amp; __debug_variable) dump_iso_packet(__func__, urb)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">unused</span><span class="p">))</span>
<span class="n">dump_iso_packet</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">ofs</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: packets=%d,errors=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">name</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">error_count</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span>  <span class="o">&lt;</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">actual_length</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ofs</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;len=%.2d,ofs=%.3d &quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">+</span> <span class="n">ofs</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%.2x&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ST5481_CMD_string</span><span class="p">(</span><span class="kt">int</span> <span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">evt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ST5481_CMD_DR</span>: <span class="k">return</span> <span class="s">&quot;DR&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ST5481_CMD_RES</span>: <span class="k">return</span> <span class="s">&quot;RES&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ST5481_CMD_TM1</span>: <span class="k">return</span> <span class="s">&quot;TM1&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ST5481_CMD_TM2</span>: <span class="k">return</span> <span class="s">&quot;TM2&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ST5481_CMD_PUP</span>: <span class="k">return</span> <span class="s">&quot;PUP&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ST5481_CMD_AR8</span>: <span class="k">return</span> <span class="s">&quot;AR8&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ST5481_CMD_AR10</span>: <span class="k">return</span> <span class="s">&quot;AR10&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ST5481_CMD_ARL</span>: <span class="k">return</span> <span class="s">&quot;ARL&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ST5481_CMD_PDN</span>: <span class="k">return</span> <span class="s">&quot;PDN&quot;</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;0x%x&quot;</span><span class="p">,</span> <span class="n">evt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cp">#define DBG_ISO_PACKET(level, urb) do {} while (0)</span>

<span class="cp">#endif</span>



<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
