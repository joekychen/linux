<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hisax › elsa.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>elsa.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: elsa.c,v 2.32.2.4 2004/01/24 20:47:21 keil Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * low level stuff for Elsa isdn cards</span>
<span class="cm"> *</span>
<span class="cm"> * Author       Karsten Keil</span>
<span class="cm"> * Copyright    by Karsten Keil      &lt;keil@isdn4linux.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> * For changes and modifications please read</span>
<span class="cm"> * Documentation/isdn/HiSax.cert</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to    Elsa GmbH for documents and information</span>
<span class="cm"> *</span>
<span class="cm"> *              Klaus Lichtenwalder (Klaus.Lichtenwalder@WebForum.DE)</span>
<span class="cm"> *              for ELSA PCMCIA support</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;hisax.h&quot;</span>
<span class="cp">#include &quot;arcofi.h&quot;</span>
<span class="cp">#include &quot;isac.h&quot;</span>
<span class="cp">#include &quot;ipac.h&quot;</span>
<span class="cp">#include &quot;hscx.h&quot;</span>
<span class="cp">#include &quot;isdnl1.h&quot;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/isapnp.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/serial_reg.h&gt;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Elsa_revision</span> <span class="o">=</span> <span class="s">&quot;$Revision: 2.32.2.4 $&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Elsa_Types</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span><span class="s">&quot;None&quot;</span><span class="p">,</span> <span class="s">&quot;PC&quot;</span><span class="p">,</span> <span class="s">&quot;PCC-8&quot;</span><span class="p">,</span> <span class="s">&quot;PCC-16&quot;</span><span class="p">,</span> <span class="s">&quot;PCF&quot;</span><span class="p">,</span> <span class="s">&quot;PCF-Pro&quot;</span><span class="p">,</span>
 <span class="s">&quot;PCMCIA&quot;</span><span class="p">,</span> <span class="s">&quot;QS 1000&quot;</span><span class="p">,</span> <span class="s">&quot;QS 3000&quot;</span><span class="p">,</span> <span class="s">&quot;Microlink PCI&quot;</span><span class="p">,</span> <span class="s">&quot;QS 3000 PCI&quot;</span><span class="p">,</span>
 <span class="s">&quot;PCMCIA-IPAC&quot;</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ITACVer</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span><span class="s">&quot;?0?&quot;</span><span class="p">,</span> <span class="s">&quot;?1?&quot;</span><span class="p">,</span> <span class="s">&quot;?2?&quot;</span><span class="p">,</span> <span class="s">&quot;?3?&quot;</span><span class="p">,</span> <span class="s">&quot;?4?&quot;</span><span class="p">,</span> <span class="s">&quot;V2.2&quot;</span><span class="p">,</span>
 <span class="s">&quot;B1&quot;</span><span class="p">,</span> <span class="s">&quot;A1&quot;</span><span class="p">};</span>

<span class="cp">#define byteout(addr, val) outb(val, addr)</span>
<span class="cp">#define bytein(addr) inb(addr)</span>

<span class="cp">#define ELSA_ISAC	0</span>
<span class="cp">#define ELSA_ISAC_PCM	1</span>
<span class="cp">#define ELSA_ITAC	1</span>
<span class="cp">#define ELSA_HSCX	2</span>
<span class="cp">#define ELSA_ALE	3</span>
<span class="cp">#define ELSA_ALE_PCM	4</span>
<span class="cp">#define ELSA_CONTROL	4</span>
<span class="cp">#define ELSA_CONFIG	5</span>
<span class="cp">#define ELSA_START_TIMER 6</span>
<span class="cp">#define ELSA_TRIG_IRQ	7</span>

<span class="cp">#define ELSA_PC      1</span>
<span class="cp">#define ELSA_PCC8    2</span>
<span class="cp">#define ELSA_PCC16   3</span>
<span class="cp">#define ELSA_PCF     4</span>
<span class="cp">#define ELSA_PCFPRO  5</span>
<span class="cp">#define ELSA_PCMCIA  6</span>
<span class="cp">#define ELSA_QS1000  7</span>
<span class="cp">#define ELSA_QS3000  8</span>
<span class="cp">#define ELSA_QS1000PCI 9</span>
<span class="cp">#define ELSA_QS3000PCI 10</span>
<span class="cp">#define ELSA_PCMCIA_IPAC 11</span>

<span class="cm">/* PCI stuff */</span>
<span class="cp">#define ELSA_PCI_IRQ_MASK	0x04</span>

<span class="cm">/* ITAC Registeradressen (only Microlink PC) */</span>
<span class="cp">#define ITAC_SYS	0x34</span>
<span class="cp">#define ITAC_ISEN	0x48</span>
<span class="cp">#define ITAC_RFIE	0x4A</span>
<span class="cp">#define ITAC_XFIE	0x4C</span>
<span class="cp">#define ITAC_SCIE	0x4E</span>
<span class="cp">#define ITAC_STIE	0x46</span>

<span class="cm">/***                                                                    ***</span>
<span class="cm"> ***   Makros als Befehle fuer die Kartenregister                       ***</span>
<span class="cm"> ***   (mehrere Befehle werden durch Bit-Oderung kombiniert)            ***</span>
<span class="cm"> ***                                                                    ***/</span>

<span class="cm">/* Config-Register (Read) */</span>
<span class="cp">#define ELIRQF_TIMER_RUN       0x02	</span><span class="cm">/* Bit 1 des Config-Reg     */</span><span class="cp"></span>
<span class="cp">#define ELIRQF_TIMER_RUN_PCC8  0x01	</span><span class="cm">/* Bit 0 des Config-Reg  bei PCC */</span><span class="cp"></span>
<span class="cp">#define ELSA_IRQ_IDX       0x38	</span><span class="cm">/* Bit 3,4,5 des Config-Reg */</span><span class="cp"></span>
<span class="cp">#define ELSA_IRQ_IDX_PCC8  0x30	</span><span class="cm">/* Bit 4,5 des Config-Reg */</span><span class="cp"></span>
<span class="cp">#define ELSA_IRQ_IDX_PC    0x0c	</span><span class="cm">/* Bit 2,3 des Config-Reg */</span><span class="cp"></span>

<span class="cm">/* Control-Register (Write) */</span>
<span class="cp">#define ELSA_LINE_LED        0x02	</span><span class="cm">/* Bit 1 Gelbe LED */</span><span class="cp"></span>
<span class="cp">#define ELSA_STAT_LED        0x08	</span><span class="cm">/* Bit 3 Gruene LED */</span><span class="cp"></span>
<span class="cp">#define ELSA_ISDN_RESET      0x20	</span><span class="cm">/* Bit 5 Reset-Leitung */</span><span class="cp"></span>
<span class="cp">#define ELSA_ENA_TIMER_INT   0x80	</span><span class="cm">/* Bit 7 Freigabe Timer Interrupt */</span><span class="cp"></span>

<span class="cm">/* ALE-Register (Read) */</span>
<span class="cp">#define ELSA_HW_RELEASE      0x07	</span><span class="cm">/* Bit 0-2 Hardwarerkennung */</span><span class="cp"></span>
<span class="cp">#define ELSA_S0_POWER_BAD    0x08	</span><span class="cm">/* Bit 3 S0-Bus Spannung fehlt */</span><span class="cp"></span>

<span class="cm">/* Status Flags */</span>
<span class="cp">#define ELIRQF_TIMER_AKTIV 1</span>
<span class="cp">#define ELSA_BAD_PWR     2</span>
<span class="cp">#define ELSA_ASSIGN      4</span>

<span class="cp">#define RS_ISR_PASS_LIMIT 256</span>
<span class="cp">#define FLG_MODEM_ACTIVE 1</span>
<span class="cm">/* IPAC AUX */</span>
<span class="cp">#define ELSA_IPAC_LINE_LED	0x40	</span><span class="cm">/* Bit 6 Gelbe LED */</span><span class="cp"></span>
<span class="cp">#define ELSA_IPAC_STAT_LED	0x80	</span><span class="cm">/* Bit 7 Gruene LED */</span><span class="cp"></span>

<span class="cp">#if ARCOFI_USE</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">arcofi_msg</span> <span class="n">ARCOFI_XOP_F</span> <span class="o">=</span>
<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,{</span><span class="mh">0xa1</span><span class="p">,</span><span class="mh">0x3f</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">}};</span> <span class="cm">/* Normal OP */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">arcofi_msg</span> <span class="n">ARCOFI_XOP_1</span> <span class="o">=</span>
<span class="p">{</span><span class="o">&amp;</span><span class="n">ARCOFI_XOP_F</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,{</span><span class="mh">0xa1</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">}};</span> <span class="cm">/* PWR UP */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">arcofi_msg</span> <span class="n">ARCOFI_SOP_F</span> <span class="o">=</span>
<span class="p">{</span><span class="o">&amp;</span><span class="n">ARCOFI_XOP_1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,{</span><span class="mh">0xa1</span><span class="p">,</span><span class="mh">0x1f</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x12</span><span class="p">}};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">arcofi_msg</span> <span class="n">ARCOFI_COP_9</span> <span class="o">=</span>
<span class="p">{</span><span class="o">&amp;</span><span class="n">ARCOFI_SOP_F</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,{</span><span class="mh">0xa1</span><span class="p">,</span><span class="mh">0x29</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0xcb</span><span class="p">,</span><span class="mh">0xe9</span><span class="p">,</span><span class="mh">0x88</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xc8</span><span class="p">,</span><span class="mh">0xd8</span><span class="p">,</span><span class="mh">0x80</span><span class="p">}};</span> <span class="cm">/* RX */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">arcofi_msg</span> <span class="n">ARCOFI_COP_8</span> <span class="o">=</span>
<span class="p">{</span><span class="o">&amp;</span><span class="n">ARCOFI_COP_9</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,{</span><span class="mh">0xa1</span><span class="p">,</span><span class="mh">0x28</span><span class="p">,</span><span class="mh">0x49</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mh">0x8</span><span class="p">,</span><span class="mh">0x13</span><span class="p">,</span><span class="mh">0x6e</span><span class="p">,</span><span class="mh">0x88</span><span class="p">,</span><span class="mh">0x2a</span><span class="p">,</span><span class="mh">0x61</span><span class="p">}};</span> <span class="cm">/* TX */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">arcofi_msg</span> <span class="n">ARCOFI_COP_7</span> <span class="o">=</span>
<span class="p">{</span><span class="o">&amp;</span><span class="n">ARCOFI_COP_8</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,{</span><span class="mh">0xa1</span><span class="p">,</span><span class="mh">0x27</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">}};</span> <span class="cm">/* GZ */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">arcofi_msg</span> <span class="n">ARCOFI_COP_6</span> <span class="o">=</span>
<span class="p">{</span><span class="o">&amp;</span><span class="n">ARCOFI_COP_7</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,{</span><span class="mh">0xa1</span><span class="p">,</span><span class="mh">0x26</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x82</span><span class="p">,</span><span class="mh">0x7c</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">}};</span> <span class="cm">/* GRL GRH */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">arcofi_msg</span> <span class="n">ARCOFI_COP_5</span> <span class="o">=</span>
<span class="p">{</span><span class="o">&amp;</span><span class="n">ARCOFI_COP_6</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,{</span><span class="mh">0xa1</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="mh">0xbb</span><span class="p">,</span><span class="mh">0x4a</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">}};</span> <span class="cm">/* GTX */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">arcofi_msg</span> <span class="n">ARCOFI_VERSION</span> <span class="o">=</span>
<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,{</span><span class="mh">0xa0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">}};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">arcofi_msg</span> <span class="n">ARCOFI_XOP_0</span> <span class="o">=</span>
<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,{</span><span class="mh">0xa1</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">}};</span> <span class="cm">/* PWR Down */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">set_arcofi</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bc</span><span class="p">);</span>

<span class="cp">#include &quot;elsa_ser.c&quot;</span>
<span class="cp">#endif </span><span class="cm">/* ARCOFI_USE */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u_char</span>
<span class="nf">readreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ale</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">adr</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="n">u_char</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">byteout</span><span class="p">(</span><span class="n">ale</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">bytein</span><span class="p">(</span><span class="n">adr</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">readfifo</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ale</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">adr</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">off</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">byteout</span><span class="p">(</span><span class="n">ale</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="n">insb</span><span class="p">(</span><span class="n">adr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">writereg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ale</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">adr</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">off</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">byteout</span><span class="p">(</span><span class="n">ale</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="n">byteout</span><span class="p">(</span><span class="n">adr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">writefifo</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ale</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">adr</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">off</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">byteout</span><span class="p">(</span><span class="n">ale</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="n">outsb</span><span class="p">(</span><span class="n">adr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Interface functions */</span>

<span class="k">static</span> <span class="n">u_char</span>
<span class="nf">ReadISAC</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">readreg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">offset</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">WriteISAC</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ReadISACfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">readfifo</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">WriteISACfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writefifo</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_char</span>
<span class="nf">ReadISAC_IPAC</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">readreg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">WriteISAC_IPAC</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">offset</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ReadISACfifo_IPAC</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">readfifo</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">WriteISACfifo_IPAC</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writefifo</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_char</span>
<span class="nf">ReadHSCX</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">readreg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">hscx</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">hscx</span> <span class="o">?</span> <span class="mh">0x40</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">WriteHSCX</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span>
		 <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">hscx</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">hscx</span> <span class="o">?</span> <span class="mh">0x40</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u_char</span>
<span class="nf">readitac</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="n">u_char</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">bytein</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">itac</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">writeitac</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">off</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">itac</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">TimerRun</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="n">u_char</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">bytein</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS1000</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS3000</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">ELIRQF_TIMER_RUN</span><span class="p">));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_PCC8</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">ELIRQF_TIMER_RUN_PCC8</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">ELIRQF_TIMER_RUN</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * fast interrupt HSCX stuff goes here</span>
<span class="cm"> */</span>

<span class="cp">#define READHSCX(cs, nr, reg) readreg(cs-&gt;hw.elsa.ale,			\</span>
<span class="cp">				      cs-&gt;hw.elsa.hscx, reg + (nr ? 0x40 : 0))</span>
<span class="cp">#define WRITEHSCX(cs, nr, reg, data) writereg(cs-&gt;hw.elsa.ale,		\</span>
<span class="cp">					      cs-&gt;hw.elsa.hscx, reg + (nr ? 0x40 : 0), data)</span>

<span class="cp">#define READHSCXFIFO(cs, nr, ptr, cnt) readfifo(cs-&gt;hw.elsa.ale,	\</span>
<span class="cp">						cs-&gt;hw.elsa.hscx, (nr ? 0x40 : 0), ptr, cnt)</span>

<span class="cp">#define WRITEHSCXFIFO(cs, nr, ptr, cnt) writefifo(cs-&gt;hw.elsa.ale,	\</span>
<span class="cp">						  cs-&gt;hw.elsa.hscx, (nr ? 0x40 : 0), ptr, cnt)</span>

<span class="cp">#include &quot;hscx_irq.c&quot;</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">elsa_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">intno</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">icnt</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">typ</span> <span class="o">==</span> <span class="n">ISDN_CTYPE_ELSA_PCMCIA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">busy_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* The card tends to generate interrupts while being removed</span>
<span class="cm">		   causing us to just crash the kernel. bad. */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Elsa: card not available!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#if ARCOFI_USE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">MFlag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">serial_inp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_IIR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">UART_IIR_NO_INT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;IIR %02x&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">rs_interrupt_elsa</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readreg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">hscx</span><span class="p">,</span> <span class="n">HSCX_ISTA</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">);</span>
<span class="nl">Start_HSCX:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hscx_int_main</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readreg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">ISAC_ISTA</span><span class="p">);</span>
<span class="nl">Start_ISAC:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isac_interrupt</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readreg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">hscx</span><span class="p">,</span> <span class="n">HSCX_ISTA</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;&amp;</span> <span class="n">icnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;HSCX IntStat after IntRoutine&quot;</span><span class="p">);</span>
		<span class="n">icnt</span><span class="o">--</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">Start_HSCX</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readreg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">ISAC_ISTA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;&amp;</span> <span class="n">icnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;ISAC IntStat after IntRoutine&quot;</span><span class="p">);</span>
		<span class="n">icnt</span><span class="o">--</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">Start_ISAC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">icnt</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;ELSA IRQ LOOP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">hscx</span><span class="p">,</span> <span class="n">HSCX_MASK</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">hscx</span><span class="p">,</span> <span class="n">HSCX_MASK</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">ISAC_MASK</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ELIRQF_TIMER_AKTIV</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TimerRun</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Timer Restart */</span>
			<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">counter</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#if ARCOFI_USE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">MFlag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">serial_inp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">^=</span> <span class="mh">0x8</span><span class="p">;</span>
		<span class="n">serial_outp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">serial_inp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">^=</span> <span class="mh">0x8</span><span class="p">;</span>
		<span class="n">serial_outp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">trig</span><span class="p">)</span>
		<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">trig</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">hscx</span><span class="p">,</span> <span class="n">HSCX_MASK</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">hscx</span><span class="p">,</span> <span class="n">HSCX_MASK</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">ISAC_MASK</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">elsa_interrupt_ipac</span><span class="p">(</span><span class="kt">int</span> <span class="n">intno</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">ista</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">icnt</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS1000PCI</span> <span class="o">||</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS3000PCI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">bytein</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">cfg</span> <span class="o">+</span> <span class="mh">0x4c</span><span class="p">);</span> <span class="cm">/* PCI IRQ */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ELSA_PCI_IRQ_MASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#if ARCOFI_USE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">MFlag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">serial_inp</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">UART_IIR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">UART_IIR_NO_INT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;IIR %02x&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">rs_interrupt_elsa</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">ista</span> <span class="o">=</span> <span class="n">readreg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">IPAC_ISTA</span><span class="p">);</span>
<span class="nl">Start_IPAC:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_IPAC</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;IPAC ISTA %02X&quot;</span><span class="p">,</span> <span class="n">ista</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ista</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readreg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">hscx</span><span class="p">,</span> <span class="n">HSCX_ISTA</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ista</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ista</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ista</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
			<span class="n">hscx_int_main</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ista</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0xfe</span> <span class="o">&amp;</span> <span class="n">readreg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">ISAC_ISTA</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isac_interrupt</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ista</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">isac_interrupt</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ista</span>  <span class="o">=</span> <span class="n">readreg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">IPAC_ISTA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ista</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">icnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">icnt</span><span class="o">--</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">Start_IPAC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">icnt</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ELSA IRQ LOOP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">IPAC_MASK</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">IPAC_MASK</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">release_io_elsa</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bytecnt</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">tl</span><span class="p">);</span>
<span class="cp">#if ARCOFI_USE</span>
	<span class="n">clear_arcofi</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl</span><span class="p">)</span>
		<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* LEDs Out */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS1000PCI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">cfg</span> <span class="o">+</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>  <span class="cm">/* disable IRQ */</span>
		<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">IPAC_ATX</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">bytecnt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">cfg</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS3000PCI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">cfg</span> <span class="o">+</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span> <span class="cm">/* disable ELSA PCI IRQ */</span>
		<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">IPAC_ATX</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">cfg</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_PCMCIA_IPAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">IPAC_ATX</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_PCFPRO</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS3000</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_PCF</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS3000PCI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bytecnt</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
<span class="cp">#if ARCOFI_USE</span>
		<span class="n">release_modem</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">bytecnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">reset_elsa</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">timer</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Wait 1 Timer */</span>
		<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">TimerRun</span><span class="p">(</span><span class="n">cs</span><span class="p">));</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl_reg</span> <span class="o">|=</span> <span class="mh">0x50</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ELSA_ISDN_RESET</span><span class="p">;</span>	<span class="cm">/* Reset On */</span>
		<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl_reg</span><span class="p">);</span>
		<span class="cm">/* Wait 1 Timer */</span>
		<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">TimerRun</span><span class="p">(</span><span class="n">cs</span><span class="p">));</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl_reg</span> <span class="o">|=</span> <span class="n">ELSA_ISDN_RESET</span><span class="p">;</span>	<span class="cm">/* Reset Off */</span>
		<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl_reg</span><span class="p">);</span>
		<span class="cm">/* Wait 1 Timer */</span>
		<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">TimerRun</span><span class="p">(</span><span class="n">cs</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">trig</span><span class="p">)</span>
			<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">trig</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS1000PCI</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS3000PCI</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_PCMCIA_IPAC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">IPAC_POTA2</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">IPAC_POTA2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">IPAC_MASK</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">!=</span> <span class="n">ELSA_PCMCIA_IPAC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">IPAC_ACFG</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
			<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">IPAC_AOE</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">IPAC_PCFG</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
			<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">IPAC_ACFG</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>
			<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">IPAC_AOE</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">IPAC_ATX</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS1000PCI</span><span class="p">)</span>
			<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">cfg</span> <span class="o">+</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span> <span class="cm">/* enable ELSA PCI IRQ */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS3000PCI</span><span class="p">)</span>
			<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">cfg</span> <span class="o">+</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span> <span class="cm">/* enable ELSA PCI IRQ */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#if ARCOFI_USE</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">set_arcofi</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bc</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">arcofi_bc</span> <span class="o">=</span> <span class="n">bc</span><span class="p">;</span>
	<span class="n">arcofi_fsm</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ARCOFI_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ARCOFI_COP_5</span><span class="p">);</span>
	<span class="n">interruptible_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">arcofi_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">check_arcofi</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">arcofi_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">mon_tx</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">mon_tx</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MAX_MON_FRAME</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;ISAC MON TX out of buffers!&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">arcofi_bc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">arcofi_fsm</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ARCOFI_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ARCOFI_VERSION</span><span class="p">);</span>
	<span class="n">interruptible_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">arcofi_wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_ARCOFI_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Arcofi response received %d bytes&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">mon_rxp</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">mon_rx</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s">&quot;Arcofi data&quot;</span><span class="p">);</span>
		<span class="n">QuickHex</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">mon_rxp</span><span class="p">);</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">mon_rxp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">mon_rx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xa0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">mon_rx</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x80</span>:
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Arcofi 2160 detected&quot;</span><span class="p">);</span>
				<span class="n">arcofi_present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x82</span>:
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Arcofi 2165 detected&quot;</span><span class="p">);</span>
				<span class="n">arcofi_present</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x84</span>:
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Arcofi 2163 detected&quot;</span><span class="p">);</span>
				<span class="n">arcofi_present</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;unknown Arcofi response&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;undefined Monitor response&quot;</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">mon_rxp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">mon_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Arcofi not detected&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arcofi_present</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS1000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">=</span> <span class="n">ELSA_QS3000</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			       <span class="s">&quot;Elsa: %s detected modem at 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">Elsa_Types</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span><span class="p">],</span>
			       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;elsa isdn modem&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				       <span class="s">&quot;HiSax: %s config port %lx-%lx already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">Elsa_Types</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span><span class="p">],</span>
				       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span>
				       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_PCC16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">=</span> <span class="n">ELSA_PCF</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			       <span class="s">&quot;Elsa: %s detected modem at 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">Elsa_Types</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span><span class="p">],</span>
			       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;elsa isdn modem&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				       <span class="s">&quot;HiSax: %s config port %lx-%lx already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">Elsa_Types</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span><span class="p">],</span>
				       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span>
				       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			       <span class="s">&quot;Elsa: %s detected modem at 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">Elsa_Types</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span><span class="p">],</span>
			       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">arcofi_fsm</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ARCOFI_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ARCOFI_XOP_0</span><span class="p">);</span>
		<span class="n">interruptible_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">arcofi_wait</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* ARCOFI_USE */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">elsa_led_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">blink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_PCMCIA</span> <span class="o">||</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_PCMCIA_IPAC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">tl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ELSA_ASSIGN</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl_reg</span> <span class="o">|=</span> <span class="n">ELSA_STAT_LED</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ELSA_BAD_PWR</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ELSA_STAT_LED</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl_reg</span> <span class="o">^=</span> <span class="n">ELSA_STAT_LED</span><span class="p">;</span>
		<span class="n">blink</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xf000</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl_reg</span> <span class="o">|=</span> <span class="n">ELSA_LINE_LED</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0f00</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl_reg</span> <span class="o">^=</span> <span class="n">ELSA_LINE_LED</span><span class="p">;</span>
		<span class="n">blink</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ELSA_LINE_LED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS1000PCI</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS3000PCI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u_char</span> <span class="n">led</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl_reg</span> <span class="o">&amp;</span> <span class="n">ELSA_LINE_LED</span><span class="p">)</span>
			<span class="n">led</span> <span class="o">^=</span> <span class="n">ELSA_IPAC_LINE_LED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl_reg</span> <span class="o">&amp;</span> <span class="n">ELSA_STAT_LED</span><span class="p">)</span>
			<span class="n">led</span> <span class="o">^=</span> <span class="n">ELSA_IPAC_STAT_LED</span><span class="p">;</span>
		<span class="n">writereg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">IPAC_ATX</span><span class="p">,</span> <span class="n">led</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blink</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">tl</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">tl</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">((</span><span class="n">blink</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">tl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">Elsa_card_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CARD_RESET</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">reset_elsa</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CARD_RELEASE</span>:
		<span class="n">release_io_elsa</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CARD_INIT</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">|=</span> <span class="n">L1_DEB_IPAC</span><span class="p">;</span>
		<span class="n">reset_elsa</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">inithscxisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS1000</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS3000</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">trig</span><span class="p">)</span>
			<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">trig</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">inithscxisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CARD_TEST</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_PCMCIA</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_PCMCIA_IPAC</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS1000PCI</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS3000PCI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl_reg</span> <span class="o">|=</span> <span class="n">ELSA_ENA_TIMER_INT</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ELIRQF_TIMER_AKTIV</span><span class="p">;</span>
			<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl_reg</span><span class="p">);</span>
			<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">110</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ELSA_ENA_TIMER_INT</span><span class="p">;</span>
			<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl_reg</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ELIRQF_TIMER_AKTIV</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Elsa: %d timer tics in 110 msek</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">counter</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">counter</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Elsa: timer and irq OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				       <span class="s">&quot;Elsa: timer tic problem (%d/12) maybe an IRQ(%d) conflict</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">counter</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#if ARCOFI_USE</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_arcofi</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">init_modem</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">elsa_led_handler</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">MDL_REMOVE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">MDL_ASSIGN</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ELSA_ASSIGN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MDL_INFO_SETUP</span>:
		<span class="k">if</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span> <span class="n">arg</span><span class="p">)</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="mh">0x0200</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="mh">0x0100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MDL_INFO_CONN</span>:
		<span class="k">if</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span> <span class="n">arg</span><span class="p">)</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="mh">0x2000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="mh">0x1000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MDL_INFO_REL</span>:
		<span class="k">if</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x2000</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0200</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1000</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0100</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#if ARCOFI_USE</span>
	<span class="k">case</span> <span class="n">CARD_AUX_IND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">MFlag</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">u_char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
				<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
			<span class="n">msg</span><span class="o">++</span><span class="p">;</span>
			<span class="n">modem_write_cmd</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">typ</span> <span class="o">==</span> <span class="n">ISDN_CTYPE_ELSA</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">pwr</span> <span class="o">=</span> <span class="n">bytein</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pwr</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ELSA_BAD_PWR</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ELSA_BAD_PWR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">elsa_led_handler</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span>
<span class="nf">probe_elsa_adr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">adr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">typ</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">in1</span><span class="p">,</span> <span class="n">in2</span><span class="p">,</span> <span class="n">p16_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p16_2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p8_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p8_2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pc_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">pc_2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pfp_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pfp_2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* In case of the elsa pcmcia card, this region is in use,</span>
<span class="cm">	   reserved for us by the card manager. So we do not check it</span>
<span class="cm">	   here, it would fail. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">typ</span> <span class="o">!=</span> <span class="n">ISDN_CTYPE_ELSA_PCMCIA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_region</span><span class="p">(</span><span class="n">adr</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;elsa card&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">adr</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;Elsa: Probing Port 0x%x: already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adr</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">in1</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">adr</span> <span class="o">+</span> <span class="n">ELSA_CONFIG</span><span class="p">);</span>	<span class="cm">/* &#39;toggelt&#39; bei */</span>
		<span class="n">in2</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">adr</span> <span class="o">+</span> <span class="n">ELSA_CONFIG</span><span class="p">);</span>	<span class="cm">/* jedem Zugriff */</span>
		<span class="n">p16_1</span> <span class="o">+=</span> <span class="mh">0x04</span> <span class="o">&amp;</span> <span class="n">in1</span><span class="p">;</span>
		<span class="n">p16_2</span> <span class="o">+=</span> <span class="mh">0x04</span> <span class="o">&amp;</span> <span class="n">in2</span><span class="p">;</span>
		<span class="n">p8_1</span> <span class="o">+=</span> <span class="mh">0x02</span> <span class="o">&amp;</span> <span class="n">in1</span><span class="p">;</span>
		<span class="n">p8_2</span> <span class="o">+=</span> <span class="mh">0x02</span> <span class="o">&amp;</span> <span class="n">in2</span><span class="p">;</span>
		<span class="n">pc_1</span> <span class="o">+=</span> <span class="mh">0x01</span> <span class="o">&amp;</span> <span class="n">in1</span><span class="p">;</span>
		<span class="n">pc_2</span> <span class="o">+=</span> <span class="mh">0x01</span> <span class="o">&amp;</span> <span class="n">in2</span><span class="p">;</span>
		<span class="n">pfp_1</span> <span class="o">+=</span> <span class="mh">0x40</span> <span class="o">&amp;</span> <span class="n">in1</span><span class="p">;</span>
		<span class="n">pfp_2</span> <span class="o">+=</span> <span class="mh">0x40</span> <span class="o">&amp;</span> <span class="n">in2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Elsa: Probing IO 0x%x&quot;</span><span class="p">,</span> <span class="n">adr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">65</span> <span class="o">==</span> <span class="o">++</span><span class="n">p16_1</span> <span class="o">*</span> <span class="o">++</span><span class="n">p16_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; PCC-16/PCF found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ELSA_PCC16</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">1025</span> <span class="o">==</span> <span class="o">++</span><span class="n">pfp_1</span> <span class="o">*</span> <span class="o">++</span><span class="n">pfp_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; PCF-Pro found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ELSA_PCFPRO</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">33</span> <span class="o">==</span> <span class="o">++</span><span class="n">p8_1</span> <span class="o">*</span> <span class="o">++</span><span class="n">p8_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; PCC8 found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ELSA_PCC8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">17</span> <span class="o">==</span> <span class="o">++</span><span class="n">pc_1</span> <span class="o">*</span> <span class="o">++</span><span class="n">pc_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; PC found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ELSA_PC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">probe_elsa</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">CARD_portlist</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span><span class="mh">0x160</span><span class="p">,</span> <span class="mh">0x170</span><span class="p">,</span> <span class="mh">0x260</span><span class="p">,</span> <span class="mh">0x360</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">CARD_portlist</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">=</span> <span class="n">probe_elsa_adr</span><span class="p">(</span><span class="n">CARD_portlist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">typ</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">CARD_portlist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">setup_elsa_isa</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Elsa: Microlink IO probing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">=</span> <span class="n">probe_elsa_adr</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span><span class="p">,</span>
						  <span class="n">cs</span><span class="o">-&gt;</span><span class="n">typ</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;Elsa: no Elsa Microlink at %#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">probe_elsa</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;No Elsa Microlink found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">ELSA_CONFIG</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">ELSA_CONTROL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">ELSA_ALE</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">ELSA_ISAC</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">itac</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">ELSA_ITAC</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">hscx</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">ELSA_HSCX</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">trig</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">ELSA_TRIG_IRQ</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">ELSA_START_TIMER</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">bytein</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_PC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u_char</span> <span class="n">CARD_IrqTab</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">CARD_IrqTab</span><span class="p">[(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ELSA_IRQ_IDX_PC</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_PCC8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u_char</span> <span class="n">CARD_IrqTab</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">CARD_IrqTab</span><span class="p">[(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ELSA_IRQ_IDX_PCC8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u_char</span> <span class="n">CARD_IrqTab</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">{</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">9</span><span class="p">};</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">CARD_IrqTab</span><span class="p">[(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ELSA_IRQ_IDX</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">bytein</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ELSA_HW_RELEASE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">+=</span> <span class="sc">&#39;A&#39;</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="sc">&#39;B&#39;</span> <span class="o">||</span> <span class="n">val</span> <span class="o">==</span> <span class="sc">&#39;C&#39;</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_PCFPRO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="sc">&#39;G&#39;</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;C&#39;</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;Elsa: %s found at %#lx Rev.:%c IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">Elsa_Types</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span><span class="p">],</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span><span class="p">,</span>
	       <span class="n">val</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">bytein</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ELSA_S0_POWER_BAD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;Elsa: Microlink S0 bus power bad</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">ELSA_BAD_PWR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef __ISAPNP__</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">isapnp_device_id</span> <span class="n">elsa_ids</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;E&#39;</span><span class="p">,</span> <span class="sc">&#39;L&#39;</span><span class="p">,</span> <span class="sc">&#39;S&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x0133</span><span class="p">),</span>
	  <span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;E&#39;</span><span class="p">,</span> <span class="sc">&#39;L&#39;</span><span class="p">,</span> <span class="sc">&#39;S&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x0133</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="s">&quot;Elsa QS1000&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;E&#39;</span><span class="p">,</span> <span class="sc">&#39;L&#39;</span><span class="p">,</span> <span class="sc">&#39;S&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x0134</span><span class="p">),</span>
	  <span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;E&#39;</span><span class="p">,</span> <span class="sc">&#39;L&#39;</span><span class="p">,</span> <span class="sc">&#39;S&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x0134</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="s">&quot;Elsa QS3000&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isapnp_device_id</span> <span class="o">*</span><span class="n">ipid</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">elsa_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_card</span> <span class="o">*</span><span class="n">pnp_c</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif	</span><span class="cm">/* __ISAPNP__ */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">setup_elsa_isapnp</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>

<span class="cp">#ifdef __ISAPNP__</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">isapnp_present</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pnp_d</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">ipid</span><span class="o">-&gt;</span><span class="n">card_vendor</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pnp_c</span> <span class="o">=</span> <span class="n">pnp_find_card</span><span class="p">(</span><span class="n">ipid</span><span class="o">-&gt;</span><span class="n">card_vendor</span><span class="p">,</span>
						   <span class="n">ipid</span><span class="o">-&gt;</span><span class="n">card_device</span><span class="p">,</span> <span class="n">pnp_c</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">pnp_d</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">pnp_d</span> <span class="o">=</span> <span class="n">pnp_find_dev</span><span class="p">(</span><span class="n">pnp_c</span><span class="p">,</span>
							  <span class="n">ipid</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">ipid</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span> <span class="n">pnp_d</span><span class="p">)))</span> <span class="p">{</span>
					<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax: %s detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ipid</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">);</span>
					<span class="n">pnp_disable_dev</span><span class="p">(</span><span class="n">pnp_d</span><span class="p">);</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">pnp_activate_dev</span><span class="p">(</span><span class="n">pnp_d</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: pnp_activate_dev ret(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
						<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">pnp_d</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_irq</span><span class="p">(</span><span class="n">pnp_d</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Elsa PnP:some resources are missing %ld/%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
						<span class="n">pnp_disable_dev</span><span class="p">(</span><span class="n">pnp_d</span><span class="p">);</span>
						<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ipid</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x133</span><span class="p">))</span>
						<span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">=</span> <span class="n">ELSA_QS1000</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">=</span> <span class="n">ELSA_QS3000</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Elsa PnP: PnP error card found, no device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">ipid</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pnp_c</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipid</span><span class="o">-&gt;</span><span class="n">card_vendor</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Elsa PnP: no ISAPnP card found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* __ISAPNP__ */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span><span class="p">)</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">=</span> <span class="n">ELSA_QS1000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Elsa PnP: no parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">ELSA_CONFIG</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">ELSA_ALE</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">ELSA_ISAC</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">hscx</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">ELSA_HSCX</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">trig</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">ELSA_TRIG_IRQ</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">ELSA_START_TIMER</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">ELSA_CONTROL</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;Elsa: %s defined at %#lx IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">Elsa_Types</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span><span class="p">],</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span><span class="p">,</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">setup_elsa_pcmcia</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readreg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">IPAC_ID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* IPAC version 1.1/1.2 */</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">=</span> <span class="n">ELSA_PCMCIA_IPAC</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">hscx</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HW_IPAC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">=</span> <span class="n">ELSA_PCMCIA</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">ELSA_ALE_PCM</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">ELSA_ISAC_PCM</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">hscx</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">ELSA_HSCX</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">trig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq_flags</span> <span class="o">|=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;Elsa: %s defined at %#lx IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">Elsa_Types</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span><span class="p">],</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span><span class="p">,</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span>	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev_qs1000</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span>	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev_qs3000</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">setup_elsa_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_qs1000</span> <span class="o">=</span> <span class="n">hisax_find_pci_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ELSA</span><span class="p">,</span>
						<span class="n">PCI_DEVICE_ID_ELSA_MICROLINK</span><span class="p">,</span> <span class="n">dev_qs1000</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev_qs1000</span><span class="p">))</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">=</span> <span class="n">ELSA_QS1000PCI</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">dev_qs1000</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev_qs1000</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev_qs1000</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_qs3000</span> <span class="o">=</span> <span class="n">hisax_find_pci_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ELSA</span><span class="p">,</span>
						       <span class="n">PCI_DEVICE_ID_ELSA_QS3000</span><span class="p">,</span> <span class="n">dev_qs3000</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev_qs3000</span><span class="p">))</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">=</span> <span class="n">ELSA_QS3000PCI</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">dev_qs3000</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev_qs3000</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev_qs3000</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Elsa: No PCI card found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Elsa: No IRQ for PCI card found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">&amp;&amp;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">cfg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Elsa: No IO-Adr for PCI card found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Elsa: You may have a wrong PCI bios</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Elsa: If your system hangs now, read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Elsa: Documentation/isdn/README.HiSax</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span>  <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">hscx</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HW_IPAC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">trig</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq_flags</span> <span class="o">|=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;Elsa: %s defined at %#lx/0x%x IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">Elsa_Types</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span><span class="p">],</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span><span class="p">,</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">cfg</span><span class="p">,</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">setup_elsa_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">setup_elsa_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytecnt</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ELSA_PC</span>:
	<span class="k">case</span> <span class="n">ELSA_PCC8</span>:
	<span class="k">case</span> <span class="n">ELSA_PCC16</span>:
	<span class="k">case</span> <span class="n">ELSA_QS1000</span>:
	<span class="k">case</span> <span class="n">ELSA_PCMCIA</span>:
	<span class="k">case</span> <span class="n">ELSA_PCMCIA_IPAC</span>:
		<span class="n">bytecnt</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ELSA_PCFPRO</span>:
	<span class="k">case</span> <span class="n">ELSA_PCF</span>:
	<span class="k">case</span> <span class="n">ELSA_QS3000</span>:
	<span class="k">case</span> <span class="n">ELSA_QS3000PCI</span>:
		<span class="n">bytecnt</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ELSA_QS1000PCI</span>:
		<span class="n">bytecnt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;Unknown ELSA subtype %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* In case of the elsa pcmcia card, this region is in use,</span>
<span class="cm">	   reserved for us by the card manager. So we do not check it</span>
<span class="cm">	   here, it would fail. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">typ</span> <span class="o">!=</span> <span class="n">ISDN_CTYPE_ELSA_PCMCIA</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">bytecnt</span><span class="p">,</span> <span class="s">&quot;elsa isdn&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;HiSax: ELSA config port %#lx-%#lx already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span><span class="p">,</span>
		       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">bytecnt</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS1000PCI</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS3000PCI</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">cfg</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="s">&quot;elsa isdn pci&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;HiSax: ELSA pci port %x-%x already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">cfg</span><span class="p">,</span>
			       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">cfg</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">);</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">bytecnt</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#if ARCOFI_USE</span>
	<span class="n">init_arcofi</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">setup_isac</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">tl</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">elsa_led_handler</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">tl</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">cs</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">tl</span><span class="p">);</span>
	<span class="cm">/* Teste Timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">timer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">trig</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TimerRun</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">byteout</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* 2. Versuch */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TimerRun</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				       <span class="s">&quot;Elsa: timer do not start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">release_io_elsa</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
				<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">HZDELAY</span><span class="p">((</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* wait &gt;=10 ms */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">TimerRun</span><span class="p">(</span><span class="n">cs</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Elsa: timer do not run down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">release_io_elsa</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Elsa: timer OK; resetting card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Read_Reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ReadHSCX</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">WriteHSCX</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Send_Data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hscx_fill_fifo</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Elsa_card_msg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS1000PCI</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_QS3000PCI</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_PCMCIA_IPAC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ReadISAC_IPAC</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">WriteISAC_IPAC</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisacfifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ReadISACfifo_IPAC</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisacfifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">WriteISACfifo_IPAC</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">elsa_interrupt_ipac</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readreg</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ale</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">IPAC_ID</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Elsa: IPAC version %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ReadISAC</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">WriteISAC</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisacfifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ReadISACfifo</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisacfifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">WriteISACfifo</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">elsa_interrupt</span><span class="p">;</span>
		<span class="n">ISACVersion</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Elsa:&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HscxVersion</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Elsa:&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;Elsa: wrong HSCX versions check IO address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">release_io_elsa</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">ELSA_PC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readitac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ITAC_SYS</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Elsa: ITAC version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ITACVer</span><span class="p">[</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">]);</span>
		<span class="n">writeitac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ITAC_ISEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">writeitac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ITAC_RFIE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">writeitac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ITAC_XFIE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">writeitac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ITAC_SCIE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">writeitac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ITAC_STIE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">setup_elsa</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">Elsa_revision</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax: Elsa driver Rev. %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HiSax_getrev</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">ctrl_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">MFlag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">typ</span> <span class="o">==</span> <span class="n">ISDN_CTYPE_ELSA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">setup_elsa_isa</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">typ</span> <span class="o">==</span> <span class="n">ISDN_CTYPE_ELSA_PNP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">setup_elsa_isapnp</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">typ</span> <span class="o">==</span> <span class="n">ISDN_CTYPE_ELSA_PCMCIA</span><span class="p">)</span>
		<span class="n">setup_elsa_pcmcia</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">typ</span> <span class="o">==</span> <span class="n">ISDN_CTYPE_ELSA_PCI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">setup_elsa_pci</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">setup_elsa_common</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
