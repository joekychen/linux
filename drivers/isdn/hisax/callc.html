<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hisax › callc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>callc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: callc.c,v 2.59.2.4 2004/02/11 13:21:32 keil Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * Author       Karsten Keil</span>
<span class="cm"> * Copyright    by Karsten Keil      &lt;keil@isdn4linux.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> * For changes and modifications please read</span>
<span class="cm"> * Documentation/isdn/HiSax.cert</span>
<span class="cm"> *</span>
<span class="cm"> * based on the teles driver from Jan den Ouden</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to    Jan den Ouden</span>
<span class="cm"> *              Fritz Elfert</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &quot;hisax.h&quot;</span>
<span class="cp">#include &lt;linux/isdn/capicmd.h&gt;</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">lli_revision</span> <span class="o">=</span> <span class="s">&quot;$Revision: 2.59.2.4 $&quot;</span><span class="p">;</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">IsdnCard</span> <span class="n">cards</span><span class="p">[];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">init_b_st</span><span class="p">(</span><span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">incoming</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">release_b_st</span><span class="p">(</span><span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">Fsm</span> <span class="n">callcfsm</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">chancount</span><span class="p">;</span>

<span class="cm">/* experimental REJECT after ALERTING for CALLBACK to beat the 4s delay */</span>
<span class="cp">#define ALERT_REJECT 0</span>

<span class="cm">/* Value to delay the sending of the first B-channel paket after CONNECT</span>
<span class="cm"> * here is no value given by ITU, but experience shows that 300 ms will</span>
<span class="cm"> * work on many networks, if you or your other side is behind local exchanges</span>
<span class="cm"> * a greater value may be recommented. If the delay is to short the first paket</span>
<span class="cm"> * will be lost and autodetect on many comercial routers goes wrong !</span>
<span class="cm"> * You can adjust this value on runtime with</span>
<span class="cm"> * hisaxctrl &lt;id&gt; 2 &lt;value&gt;</span>
<span class="cm"> * value is in milliseconds</span>
<span class="cm"> */</span>
<span class="cp">#define DEFAULT_B_DELAY	300</span>

<span class="cm">/* Flags for remembering action done in lli */</span>

<span class="cp">#define  FLG_START_B	0</span>

<span class="cm">/*</span>
<span class="cm"> * Find card with given driverId</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span>
<span class="nf">hisax_findcard</span><span class="p">(</span><span class="kt">int</span> <span class="n">driverid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nrcards</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cs</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span> <span class="o">==</span> <span class="n">driverid</span><span class="p">)</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cs</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">__printf</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="kt">void</span>
	<span class="n">link_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s">&quot;Ch%d %s &quot;</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span>
		<span class="n">direction</span> <span class="o">?</span> <span class="s">&quot;LL-&gt;HL&quot;</span> <span class="o">:</span> <span class="s">&quot;HL-&gt;LL&quot;</span><span class="p">);</span>
	<span class="n">VHiSax_putstatus</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">ST_NULL</span><span class="p">,</span>		<span class="cm">/*  0 inactive */</span>
	<span class="n">ST_OUT_DIAL</span><span class="p">,</span>		<span class="cm">/*  1 outgoing, SETUP send; awaiting confirm */</span>
	<span class="n">ST_IN_WAIT_LL</span><span class="p">,</span>		<span class="cm">/*  2 incoming call received; wait for LL confirm */</span>
	<span class="n">ST_IN_ALERT_SENT</span><span class="p">,</span>	<span class="cm">/*  3 incoming call received; ALERT send */</span>
	<span class="n">ST_IN_WAIT_CONN_ACK</span><span class="p">,</span>	<span class="cm">/*  4 incoming CONNECT send; awaiting CONN_ACK */</span>
	<span class="n">ST_WAIT_BCONN</span><span class="p">,</span>		<span class="cm">/*  5 CONNECT/CONN_ACK received, awaiting b-channel prot. estbl. */</span>
	<span class="n">ST_ACTIVE</span><span class="p">,</span>		<span class="cm">/*  6 active, b channel prot. established */</span>
	<span class="n">ST_WAIT_BRELEASE</span><span class="p">,</span>	<span class="cm">/*  7 call clear. (initiator), awaiting b channel prot. rel. */</span>
	<span class="n">ST_WAIT_BREL_DISC</span><span class="p">,</span>	<span class="cm">/*  8 call clear. (receiver), DISCONNECT req. received */</span>
	<span class="n">ST_WAIT_DCOMMAND</span><span class="p">,</span>	<span class="cm">/*  9 call clear. (receiver), awaiting DCHANNEL message */</span>
	<span class="n">ST_WAIT_DRELEASE</span><span class="p">,</span>	<span class="cm">/* 10 DISCONNECT sent, awaiting RELEASE */</span>
	<span class="n">ST_WAIT_D_REL_CNF</span><span class="p">,</span>	<span class="cm">/* 11 RELEASE sent, awaiting RELEASE confirm */</span>
	<span class="n">ST_IN_PROCEED_SEND</span><span class="p">,</span>	<span class="cm">/* 12 incoming call, proceeding send */</span>
<span class="p">};</span>


<span class="cp">#define STATE_COUNT (ST_IN_PROCEED_SEND + 1)</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">strState</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="s">&quot;ST_NULL&quot;</span><span class="p">,</span>
	<span class="s">&quot;ST_OUT_DIAL&quot;</span><span class="p">,</span>
	<span class="s">&quot;ST_IN_WAIT_LL&quot;</span><span class="p">,</span>
	<span class="s">&quot;ST_IN_ALERT_SENT&quot;</span><span class="p">,</span>
	<span class="s">&quot;ST_IN_WAIT_CONN_ACK&quot;</span><span class="p">,</span>
	<span class="s">&quot;ST_WAIT_BCONN&quot;</span><span class="p">,</span>
	<span class="s">&quot;ST_ACTIVE&quot;</span><span class="p">,</span>
	<span class="s">&quot;ST_WAIT_BRELEASE&quot;</span><span class="p">,</span>
	<span class="s">&quot;ST_WAIT_BREL_DISC&quot;</span><span class="p">,</span>
	<span class="s">&quot;ST_WAIT_DCOMMAND&quot;</span><span class="p">,</span>
	<span class="s">&quot;ST_WAIT_DRELEASE&quot;</span><span class="p">,</span>
	<span class="s">&quot;ST_WAIT_D_REL_CNF&quot;</span><span class="p">,</span>
	<span class="s">&quot;ST_IN_PROCEED_SEND&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">EV_DIAL</span><span class="p">,</span>		<span class="cm">/*  0 */</span>
	<span class="n">EV_SETUP_CNF</span><span class="p">,</span>		<span class="cm">/*  1 */</span>
	<span class="n">EV_ACCEPTB</span><span class="p">,</span>		<span class="cm">/*  2 */</span>
	<span class="n">EV_DISCONNECT_IND</span><span class="p">,</span>	<span class="cm">/*  3 */</span>
	<span class="n">EV_RELEASE</span><span class="p">,</span>		<span class="cm">/*  4 */</span>
	<span class="n">EV_LEASED</span><span class="p">,</span>		<span class="cm">/*  5 */</span>
	<span class="n">EV_LEASED_REL</span><span class="p">,</span>		<span class="cm">/*  6 */</span>
	<span class="n">EV_SETUP_IND</span><span class="p">,</span>		<span class="cm">/*  7 */</span>
	<span class="n">EV_ACCEPTD</span><span class="p">,</span>		<span class="cm">/*  8 */</span>
	<span class="n">EV_SETUP_CMPL_IND</span><span class="p">,</span>	<span class="cm">/*  9 */</span>
	<span class="n">EV_BC_EST</span><span class="p">,</span>		<span class="cm">/* 10 */</span>
	<span class="n">EV_WRITEBUF</span><span class="p">,</span>		<span class="cm">/* 11 */</span>
	<span class="n">EV_HANGUP</span><span class="p">,</span>		<span class="cm">/* 12 */</span>
	<span class="n">EV_BC_REL</span><span class="p">,</span>		<span class="cm">/* 13 */</span>
	<span class="n">EV_CINF</span><span class="p">,</span>		<span class="cm">/* 14 */</span>
	<span class="n">EV_SUSPEND</span><span class="p">,</span>		<span class="cm">/* 15 */</span>
	<span class="n">EV_RESUME</span><span class="p">,</span>		<span class="cm">/* 16 */</span>
	<span class="n">EV_NOSETUP_RSP</span><span class="p">,</span>		<span class="cm">/* 17 */</span>
	<span class="n">EV_SETUP_ERR</span><span class="p">,</span>		<span class="cm">/* 18 */</span>
	<span class="n">EV_CONNECT_ERR</span><span class="p">,</span>		<span class="cm">/* 19 */</span>
	<span class="n">EV_PROCEED</span><span class="p">,</span>		<span class="cm">/* 20 */</span>
	<span class="n">EV_ALERT</span><span class="p">,</span>		<span class="cm">/* 21 */</span>
	<span class="n">EV_REDIR</span><span class="p">,</span>		<span class="cm">/* 22 */</span>
<span class="p">};</span>

<span class="cp">#define EVENT_COUNT (EV_REDIR + 1)</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">strEvent</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="s">&quot;EV_DIAL&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_SETUP_CNF&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_ACCEPTB&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_DISCONNECT_IND&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_RELEASE&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_LEASED&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_LEASED_REL&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_SETUP_IND&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_ACCEPTD&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_SETUP_CMPL_IND&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_BC_EST&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_WRITEBUF&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_HANGUP&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_BC_REL&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_CINF&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_SUSPEND&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_RESUME&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_NOSETUP_RSP&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_SETUP_ERR&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_CONNECT_ERR&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_PROCEED&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_ALERT&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_REDIR&quot;</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">HL_LL</span><span class="p">(</span><span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_ctrl</span> <span class="n">ic</span><span class="p">;</span>

	<span class="n">ic</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">lli_deliver_cause</span><span class="p">(</span><span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_ctrl</span> <span class="n">ic</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">==</span> <span class="n">NO_CAUSE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_CAUSE</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_PTYPE_EURO</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="s">&quot;E%02X%02X&quot;</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">loc</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
			<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="s">&quot;%02X%02X&quot;</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">loc</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
			<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">lli_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_NULL</span><span class="p">);</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">MDL_INFO_REL</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_leased_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">ic</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">leased</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">MDL_INFO_SETUP</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_IN_WAIT_LL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;STAT_ICALL_LEASED&quot;</span><span class="p">);</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="p">((</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="n">ISDN_STAT_ICALL</span> <span class="o">:</span> <span class="n">ISDN_STAT_ICALLW</span><span class="p">);</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">plan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">screen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">,</span> <span class="s">&quot;LEASED%d&quot;</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;statcallb ret=%d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">MDL_INFO_REL</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Dial out</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_init_bchan_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_WAIT_BCONN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;STAT_DCONN&quot;</span><span class="p">);</span>
	<span class="n">HL_LL</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="n">ISDN_STAT_DCONN</span><span class="p">);</span>
	<span class="n">init_b_st</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">b_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">b_st</span><span class="p">,</span> <span class="n">DL_ESTABLISH</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_prep_dialout</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="n">FsmDelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">drel_timer</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
	<span class="n">FsmDelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">dial_timer</span><span class="p">,</span> <span class="mi">73</span><span class="p">);</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">l2_active_protocol</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">l2_protocol</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">incoming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">MDL_INFO_SETUP</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">leased</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lli_init_bchan_out</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_OUT_DIAL</span><span class="p">);</span>
		<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span> <span class="n">CC_SETUP</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">chanp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="n">FsmDelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">drel_timer</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
	<span class="n">FsmDelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">dial_timer</span><span class="p">,</span> <span class="mi">73</span><span class="p">);</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">l2_active_protocol</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">l2_protocol</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">incoming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">MDL_INFO_SETUP</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">leased</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lli_init_bchan_out</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_OUT_DIAL</span><span class="p">);</span>
		<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span> <span class="n">CC_RESUME</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">chanp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_go_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">ic</span><span class="p">;</span>


	<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_ACTIVE</span><span class="p">);</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">data_open</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">conmsg</span><span class="p">)</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">conmsg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;STAT_BCONN %s&quot;</span><span class="p">,</span> <span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_BCONN</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">);</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">MDL_INFO_CONN</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * RESUME</span>
<span class="cm"> */</span>

<span class="cm">/* incoming call */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_deliver_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">ic</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">MDL_INFO_SETUP</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Report incoming calls only once to linklevel, use CallFlags</span>
<span class="cm">	 * which is set to 3 with each broadcast message in isdnl1.c</span>
<span class="cm">	 * and resetted if a interface  answered the STAT_ICALL.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* for only one TEI */</span>
		<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_IN_WAIT_LL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;STAT_ICALL&quot;</span> <span class="o">:</span> <span class="s">&quot;STAT_ICALLW&quot;</span><span class="p">);</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="p">((</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="n">ISDN_STAT_ICALL</span> <span class="o">:</span> <span class="n">ISDN_STAT_ICALLW</span><span class="p">);</span>

		<span class="n">ic</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * No need to return &quot;unknown&quot; for calls without OAD,</span>
<span class="cm">		 * cause that&#39;s handled in linklevel now (replaced by &#39;0&#39;)</span>
<span class="cm">		 */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">setup</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">setup_parm</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;statcallb ret=%d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:	<span class="cm">/* OK, someone likes this call */</span>
			<span class="n">FsmDelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">drel_timer</span><span class="p">,</span> <span class="mi">61</span><span class="p">);</span>
			<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_IN_ALERT_SENT</span><span class="p">);</span>
			<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span> <span class="n">CC_ALERTING</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>: <span class="cm">/* direct redirect */</span>
		<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* Proceeding desired */</span>
			<span class="n">FsmDelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">drel_timer</span><span class="p">,</span> <span class="mi">61</span><span class="p">);</span>
			<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_IN_PROCEED_SEND</span><span class="p">);</span>
			<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span> <span class="n">CC_PROCEED_SEND</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">setup_parm</span><span class="p">));</span>
				<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span> <span class="n">CC_REDIR</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:	<span class="cm">/* Rejecting Call */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:	<span class="cm">/* incomplete number */</span>
			<span class="n">FsmDelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">drel_timer</span><span class="p">,</span> <span class="mi">61</span><span class="p">);</span>
			<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span> <span class="n">CC_MORE_INFO</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* OK, nobody likes this call */</span>
		<span class="nl">default:</span>	<span class="cm">/* statcallb problems */</span>
			<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span> <span class="n">CC_IGNORE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
			<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">MDL_INFO_REL</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
			<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_NULL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span> <span class="n">CC_IGNORE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
		<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">MDL_INFO_REL</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_send_dconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_IN_WAIT_CONN_ACK</span><span class="p">);</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span> <span class="n">CC_SETUP</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_send_alert</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_IN_ALERT_SENT</span><span class="p">);</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span> <span class="n">CC_ALERTING</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_send_redir</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span> <span class="n">CC_REDIR</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_init_bchan_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_WAIT_BCONN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;STAT_DCONN&quot;</span><span class="p">);</span>
	<span class="n">HL_LL</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="n">ISDN_STAT_DCONN</span><span class="p">);</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">l2_active_protocol</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">l2_protocol</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">incoming</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">init_b_st</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="o">!</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">b_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">b_st</span><span class="p">,</span> <span class="n">DL_ESTABLISH</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_setup_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">leased</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lli_init_bchan_in</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_IN_WAIT_CONN_ACK</span><span class="p">);</span>
<span class="cp">#ifdef WANT_ALERT</span>
		<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span> <span class="n">CC_ALERTING</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span> <span class="n">CC_SETUP</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Call suspend */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span> <span class="n">CC_SUSPEND</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Call clearing */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_leased_hup</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_ctrl</span> <span class="n">ic</span><span class="p">;</span>

	<span class="n">ic</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_CAUSE</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="s">&quot;L0010&quot;</span><span class="p">);</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;STAT_DHUP&quot;</span><span class="p">);</span>
	<span class="n">HL_LL</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="n">ISDN_STAT_DHUP</span><span class="p">);</span>
	<span class="n">lli_close</span><span class="p">(</span><span class="n">fi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_disconnect_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">leased</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lli_leased_hup</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">chanp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_WAIT_DRELEASE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">)</span>
			<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>	<span class="cm">/* Normal Call Clearing */</span>
		<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span> <span class="n">CC_DISCONNECT</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span>
				      <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_disconnect_reject</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">leased</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lli_leased_hup</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">chanp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_WAIT_DRELEASE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">)</span>
			<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mh">0x15</span><span class="p">;</span>	<span class="cm">/* Call Rejected */</span>
		<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span> <span class="n">CC_DISCONNECT</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span>
				      <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_dhup_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">leased</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lli_leased_hup</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">chanp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;STAT_DHUP&quot;</span><span class="p">);</span>
		<span class="n">lli_deliver_cause</span><span class="p">(</span><span class="n">chanp</span><span class="p">);</span>
		<span class="n">HL_LL</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="n">ISDN_STAT_DHUP</span><span class="p">);</span>
		<span class="n">lli_close</span><span class="p">(</span><span class="n">fi</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_reject_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">leased</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lli_leased_hup</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">chanp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifndef ALERT_REJECT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">)</span>
		<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mh">0x15</span><span class="p">;</span>	<span class="cm">/* Call Rejected */</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span> <span class="n">CC_REJECT</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
	<span class="n">lli_dhup_close</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">FsmRestartTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">drel_timer</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">EV_HANGUP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">63</span><span class="p">);</span>
	<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_IN_ALERT_SENT</span><span class="p">);</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span> <span class="n">CC_ALERTING</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_disconn_bchan</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">data_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_WAIT_BRELEASE</span><span class="p">);</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">b_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">b_st</span><span class="p">,</span> <span class="n">DL_RELEASE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_start_disc</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">leased</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lli_leased_hup</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">chanp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lli_disconnect_req</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_rel_b_disc</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="n">release_b_st</span><span class="p">(</span><span class="n">chanp</span><span class="p">);</span>
	<span class="n">lli_start_disc</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_bhup_disc</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;STAT_BHUP&quot;</span><span class="p">);</span>
	<span class="n">HL_LL</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="n">ISDN_STAT_BHUP</span><span class="p">);</span>
	<span class="n">lli_rel_b_disc</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_bhup_rel_b</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_WAIT_DCOMMAND</span><span class="p">);</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">data_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;STAT_BHUP&quot;</span><span class="p">);</span>
	<span class="n">HL_LL</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="n">ISDN_STAT_BHUP</span><span class="p">);</span>
	<span class="n">release_b_st</span><span class="p">(</span><span class="n">chanp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_release_bchan</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">data_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_WAIT_BREL_DISC</span><span class="p">);</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">b_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">b_st</span><span class="p">,</span> <span class="n">DL_RELEASE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_rel_b_dhup</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="n">release_b_st</span><span class="p">(</span><span class="n">chanp</span><span class="p">);</span>
	<span class="n">lli_dhup_close</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_bhup_dhup</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;STAT_BHUP&quot;</span><span class="p">);</span>
	<span class="n">HL_LL</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="n">ISDN_STAT_BHUP</span><span class="p">);</span>
	<span class="n">lli_rel_b_dhup</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">data_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">b_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">b_st</span><span class="p">,</span> <span class="n">DL_RELEASE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">lli_bhup_dhup</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_release_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">leased</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lli_leased_hup</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">chanp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_WAIT_D_REL_CNF</span><span class="p">);</span>
		<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span> <span class="n">CC_RELEASE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span>
				      <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_rel_b_release_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="n">release_b_st</span><span class="p">(</span><span class="n">chanp</span><span class="p">);</span>
	<span class="n">lli_release_req</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_bhup_release_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;STAT_BHUP&quot;</span><span class="p">);</span>
	<span class="n">HL_LL</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="n">ISDN_STAT_BHUP</span><span class="p">);</span>
	<span class="n">lli_rel_b_release_req</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* processing charge info */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_charge_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">ic</span><span class="p">;</span>

	<span class="n">ic</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_CINF</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">chargeinfo</span><span class="p">);</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* error procedures */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_dchan_not_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;STAT_DHUP&quot;</span><span class="p">);</span>
	<span class="n">HL_LL</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="n">ISDN_STAT_DHUP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_no_setup_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;STAT_DHUP&quot;</span><span class="p">);</span>
	<span class="n">HL_LL</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="n">ISDN_STAT_DHUP</span><span class="p">);</span>
	<span class="n">lli_close</span><span class="p">(</span><span class="n">fi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_WAIT_DRELEASE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_failure_l</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">ic</span><span class="p">;</span>

	<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_NULL</span><span class="p">);</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_CAUSE</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="s">&quot;L%02X%02X&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">);</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">);</span>
	<span class="n">HL_LL</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="n">ISDN_STAT_DHUP</span><span class="p">);</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">MDL_INFO_REL</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_rel_b_fail</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="n">release_b_st</span><span class="p">(</span><span class="n">chanp</span><span class="p">);</span>
	<span class="n">lli_failure_l</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_bhup_fail</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;STAT_BHUP&quot;</span><span class="p">);</span>
	<span class="n">HL_LL</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="n">ISDN_STAT_BHUP</span><span class="p">);</span>
	<span class="n">lli_rel_b_fail</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_failure_a</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">data_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">b_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">b_st</span><span class="p">,</span> <span class="n">DL_RELEASE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">lli_bhup_fail</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* *INDENT-OFF* */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">FsmNode</span> <span class="n">fnlist</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span><span class="n">ST_NULL</span><span class="p">,</span>               <span class="n">EV_DIAL</span><span class="p">,</span>                <span class="n">lli_prep_dialout</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_NULL</span><span class="p">,</span>               <span class="n">EV_RESUME</span><span class="p">,</span>              <span class="n">lli_resume</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_NULL</span><span class="p">,</span>               <span class="n">EV_SETUP_IND</span><span class="p">,</span>           <span class="n">lli_deliver_call</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_NULL</span><span class="p">,</span>               <span class="n">EV_LEASED</span><span class="p">,</span>              <span class="n">lli_leased_in</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_OUT_DIAL</span><span class="p">,</span>           <span class="n">EV_SETUP_CNF</span><span class="p">,</span>           <span class="n">lli_init_bchan_out</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_OUT_DIAL</span><span class="p">,</span>           <span class="n">EV_HANGUP</span><span class="p">,</span>              <span class="n">lli_disconnect_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_OUT_DIAL</span><span class="p">,</span>           <span class="n">EV_DISCONNECT_IND</span><span class="p">,</span>      <span class="n">lli_release_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_OUT_DIAL</span><span class="p">,</span>           <span class="n">EV_RELEASE</span><span class="p">,</span>             <span class="n">lli_dhup_close</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_OUT_DIAL</span><span class="p">,</span>           <span class="n">EV_NOSETUP_RSP</span><span class="p">,</span>         <span class="n">lli_no_setup_rsp</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_OUT_DIAL</span><span class="p">,</span>           <span class="n">EV_SETUP_ERR</span><span class="p">,</span>           <span class="n">lli_error</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_WAIT_LL</span><span class="p">,</span>         <span class="n">EV_LEASED_REL</span><span class="p">,</span>          <span class="n">lli_failure_l</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_WAIT_LL</span><span class="p">,</span>         <span class="n">EV_ACCEPTD</span><span class="p">,</span>             <span class="n">lli_setup_rsp</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_WAIT_LL</span><span class="p">,</span>         <span class="n">EV_HANGUP</span><span class="p">,</span>              <span class="n">lli_reject_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_WAIT_LL</span><span class="p">,</span>         <span class="n">EV_DISCONNECT_IND</span><span class="p">,</span>      <span class="n">lli_release_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_WAIT_LL</span><span class="p">,</span>         <span class="n">EV_RELEASE</span><span class="p">,</span>             <span class="n">lli_dhup_close</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_WAIT_LL</span><span class="p">,</span>         <span class="n">EV_SETUP_IND</span><span class="p">,</span>           <span class="n">lli_deliver_call</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_WAIT_LL</span><span class="p">,</span>         <span class="n">EV_SETUP_ERR</span><span class="p">,</span>           <span class="n">lli_error</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_ALERT_SENT</span><span class="p">,</span>      <span class="n">EV_SETUP_CMPL_IND</span><span class="p">,</span>      <span class="n">lli_init_bchan_in</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_ALERT_SENT</span><span class="p">,</span>      <span class="n">EV_ACCEPTD</span><span class="p">,</span>             <span class="n">lli_send_dconnect</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_ALERT_SENT</span><span class="p">,</span>      <span class="n">EV_HANGUP</span><span class="p">,</span>              <span class="n">lli_disconnect_reject</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_ALERT_SENT</span><span class="p">,</span>      <span class="n">EV_DISCONNECT_IND</span><span class="p">,</span>      <span class="n">lli_release_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_ALERT_SENT</span><span class="p">,</span>      <span class="n">EV_RELEASE</span><span class="p">,</span>             <span class="n">lli_dhup_close</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_ALERT_SENT</span><span class="p">,</span>	<span class="n">EV_REDIR</span><span class="p">,</span>		<span class="n">lli_send_redir</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_PROCEED_SEND</span><span class="p">,</span>	<span class="n">EV_REDIR</span><span class="p">,</span>		<span class="n">lli_send_redir</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_PROCEED_SEND</span><span class="p">,</span>	<span class="n">EV_ALERT</span><span class="p">,</span>		<span class="n">lli_send_alert</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_PROCEED_SEND</span><span class="p">,</span>	<span class="n">EV_ACCEPTD</span><span class="p">,</span>		<span class="n">lli_send_dconnect</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_PROCEED_SEND</span><span class="p">,</span>	<span class="n">EV_HANGUP</span><span class="p">,</span>		<span class="n">lli_disconnect_reject</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_PROCEED_SEND</span><span class="p">,</span>	<span class="n">EV_DISCONNECT_IND</span><span class="p">,</span>	<span class="n">lli_dhup_close</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_ALERT_SENT</span><span class="p">,</span>      <span class="n">EV_RELEASE</span><span class="p">,</span>             <span class="n">lli_dhup_close</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_WAIT_CONN_ACK</span><span class="p">,</span>   <span class="n">EV_SETUP_CMPL_IND</span><span class="p">,</span>      <span class="n">lli_init_bchan_in</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_WAIT_CONN_ACK</span><span class="p">,</span>   <span class="n">EV_HANGUP</span><span class="p">,</span>              <span class="n">lli_disconnect_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_WAIT_CONN_ACK</span><span class="p">,</span>   <span class="n">EV_DISCONNECT_IND</span><span class="p">,</span>      <span class="n">lli_release_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_WAIT_CONN_ACK</span><span class="p">,</span>   <span class="n">EV_RELEASE</span><span class="p">,</span>             <span class="n">lli_dhup_close</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_IN_WAIT_CONN_ACK</span><span class="p">,</span>   <span class="n">EV_CONNECT_ERR</span><span class="p">,</span>         <span class="n">lli_error</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_WAIT_BCONN</span><span class="p">,</span>         <span class="n">EV_BC_EST</span><span class="p">,</span>              <span class="n">lli_go_active</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_WAIT_BCONN</span><span class="p">,</span>         <span class="n">EV_BC_REL</span><span class="p">,</span>              <span class="n">lli_rel_b_disc</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_WAIT_BCONN</span><span class="p">,</span>         <span class="n">EV_HANGUP</span><span class="p">,</span>              <span class="n">lli_rel_b_disc</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_WAIT_BCONN</span><span class="p">,</span>         <span class="n">EV_DISCONNECT_IND</span><span class="p">,</span>      <span class="n">lli_rel_b_release_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_WAIT_BCONN</span><span class="p">,</span>         <span class="n">EV_RELEASE</span><span class="p">,</span>             <span class="n">lli_rel_b_dhup</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_WAIT_BCONN</span><span class="p">,</span>         <span class="n">EV_LEASED_REL</span><span class="p">,</span>          <span class="n">lli_rel_b_fail</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_WAIT_BCONN</span><span class="p">,</span>         <span class="n">EV_CINF</span><span class="p">,</span>                <span class="n">lli_charge_info</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_ACTIVE</span><span class="p">,</span>             <span class="n">EV_CINF</span><span class="p">,</span>                <span class="n">lli_charge_info</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_ACTIVE</span><span class="p">,</span>             <span class="n">EV_BC_REL</span><span class="p">,</span>              <span class="n">lli_bhup_rel_b</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_ACTIVE</span><span class="p">,</span>             <span class="n">EV_SUSPEND</span><span class="p">,</span>             <span class="n">lli_suspend</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_ACTIVE</span><span class="p">,</span>             <span class="n">EV_HANGUP</span><span class="p">,</span>              <span class="n">lli_disconn_bchan</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_ACTIVE</span><span class="p">,</span>             <span class="n">EV_DISCONNECT_IND</span><span class="p">,</span>      <span class="n">lli_release_bchan</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_ACTIVE</span><span class="p">,</span>             <span class="n">EV_RELEASE</span><span class="p">,</span>             <span class="n">lli_abort</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_ACTIVE</span><span class="p">,</span>             <span class="n">EV_LEASED_REL</span><span class="p">,</span>          <span class="n">lli_failure_a</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_WAIT_BRELEASE</span><span class="p">,</span>      <span class="n">EV_BC_REL</span><span class="p">,</span>              <span class="n">lli_bhup_disc</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_WAIT_BRELEASE</span><span class="p">,</span>      <span class="n">EV_DISCONNECT_IND</span><span class="p">,</span>      <span class="n">lli_bhup_release_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_WAIT_BRELEASE</span><span class="p">,</span>      <span class="n">EV_RELEASE</span><span class="p">,</span>             <span class="n">lli_bhup_dhup</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_WAIT_BRELEASE</span><span class="p">,</span>      <span class="n">EV_LEASED_REL</span><span class="p">,</span>          <span class="n">lli_bhup_fail</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_WAIT_BREL_DISC</span><span class="p">,</span>     <span class="n">EV_BC_REL</span><span class="p">,</span>              <span class="n">lli_bhup_release_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_WAIT_BREL_DISC</span><span class="p">,</span>     <span class="n">EV_RELEASE</span><span class="p">,</span>             <span class="n">lli_bhup_dhup</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_WAIT_DCOMMAND</span><span class="p">,</span>      <span class="n">EV_HANGUP</span><span class="p">,</span>              <span class="n">lli_start_disc</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_WAIT_DCOMMAND</span><span class="p">,</span>      <span class="n">EV_DISCONNECT_IND</span><span class="p">,</span>      <span class="n">lli_release_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_WAIT_DCOMMAND</span><span class="p">,</span>      <span class="n">EV_RELEASE</span><span class="p">,</span>             <span class="n">lli_dhup_close</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_WAIT_DCOMMAND</span><span class="p">,</span>      <span class="n">EV_LEASED_REL</span><span class="p">,</span>          <span class="n">lli_failure_l</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_WAIT_DRELEASE</span><span class="p">,</span>      <span class="n">EV_RELEASE</span><span class="p">,</span>             <span class="n">lli_dhup_close</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_WAIT_DRELEASE</span><span class="p">,</span>      <span class="n">EV_DIAL</span><span class="p">,</span>                <span class="n">lli_dchan_not_ready</span><span class="p">},</span>
	<span class="cm">/* ETS 300-104 16.1 */</span>
	<span class="p">{</span><span class="n">ST_WAIT_D_REL_CNF</span><span class="p">,</span>     <span class="n">EV_RELEASE</span><span class="p">,</span>             <span class="n">lli_dhup_close</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_WAIT_D_REL_CNF</span><span class="p">,</span>     <span class="n">EV_DIAL</span><span class="p">,</span>                <span class="n">lli_dchan_not_ready</span><span class="p">},</span>
<span class="p">};</span>
<span class="cm">/* *INDENT-ON* */</span>

<span class="kt">int</span> <span class="n">__init</span>
<span class="nf">CallcNew</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">callcfsm</span><span class="p">.</span><span class="n">state_count</span> <span class="o">=</span> <span class="n">STATE_COUNT</span><span class="p">;</span>
	<span class="n">callcfsm</span><span class="p">.</span><span class="n">event_count</span> <span class="o">=</span> <span class="n">EVENT_COUNT</span><span class="p">;</span>
	<span class="n">callcfsm</span><span class="p">.</span><span class="n">strEvent</span> <span class="o">=</span> <span class="n">strEvent</span><span class="p">;</span>
	<span class="n">callcfsm</span><span class="p">.</span><span class="n">strState</span> <span class="o">=</span> <span class="n">strState</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">FsmNew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">callcfsm</span><span class="p">,</span> <span class="n">fnlist</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fnlist</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">CallcFree</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FsmFree</span><span class="p">(</span><span class="o">&amp;</span><span class="n">callcfsm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">release_b_st</span><span class="p">(</span><span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">b_st</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_START_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">BC_Close</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">l2_active_protocol</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_PROTO_L2_X75I</span><span class="p">)</span>:
			<span class="n">releasestack_isdnl2</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_PROTO_L2_HDLC</span><span class="p">)</span>:
		<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_PROTO_L2_HDLC_56K</span><span class="p">)</span>:
		<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_PROTO_L2_TRANS</span><span class="p">)</span>:
		<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_PROTO_L2_MODEM</span><span class="p">)</span>:
		<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_PROTO_L2_FAX</span><span class="p">)</span>:
			<span class="n">releasestack_transl2</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">Channel</span>
<span class="o">*</span><span class="nf">selectfreechannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">userdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_TWO_DCHAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* virtual channel */</span>
		<span class="n">chanp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">bch</span><span class="p">)</span> <span class="o">?</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">chanlimit</span> <span class="o">:</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">MAX_WAITING_CALLS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">ST_NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">chanp</span><span class="p">);</span>
		<span class="n">chanp</span><span class="o">++</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="p">)</span> <span class="cm">/* number of channels is limited */</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* virtual channel */</span>
		<span class="n">chanp</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">userdata</span><span class="p">;</span>
		<span class="n">chanp</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">MAX_WAITING_CALLS</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">ST_NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">chanp</span><span class="p">);</span>
			<span class="n">chanp</span><span class="o">++</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stat_redir_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>	<span class="n">isdn_ctrl</span> <span class="n">ic</span><span class="p">;</span>

	<span class="n">ic</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_REDIR</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* stat_redir_result */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dchan_l3l4</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l3_process</span> <span class="o">*</span><span class="n">pc</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">==</span> <span class="p">(</span><span class="n">CC_SETUP</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">selectfreechannel</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">bchannel</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>	<span class="cm">/* User busy */</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">pc</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">,</span> <span class="n">CC_REJECT</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">=</span> <span class="n">pc</span><span class="p">;</span>
			<span class="n">pc</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">=</span> <span class="n">chanp</span><span class="p">;</span>
			<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_SETUP_IND</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">CC_MORE_INFO</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_SETUP_IND</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">CC_DISCONNECT</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_DISCONNECT_IND</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">CC_RELEASE</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">)</span>:
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_RELEASE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">CC_SUSPEND</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">)</span>:
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_RELEASE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">CC_RESUME</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">)</span>:
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_SETUP_CNF</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">CC_RESUME_ERR</span><span class="p">)</span>:
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_RELEASE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">CC_RELEASE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_RELEASE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">CC_SETUP_COMPL</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_SETUP_CMPL_IND</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">CC_SETUP</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">)</span>:
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_SETUP_CNF</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">CC_CHARGE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_CINF</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">CC_NOSETUP_RSP</span><span class="p">)</span>:
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_NOSETUP_RSP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">CC_SETUP_ERR</span><span class="p">)</span>:
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_SETUP_ERR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">CC_CONNECT_ERR</span><span class="p">)</span>:
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_CONNECT_ERR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">CC_RELEASE_ERR</span><span class="p">)</span>:
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_RELEASE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">CC_PROCEED_SEND</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">CC_PROCEEDING</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">CC_ALERTING</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">CC_PROGRESS</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">CC_NOTIFY</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">CC_REDIR</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="n">stat_redir_result</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="n">pc</span><span class="o">-&gt;</span><span class="n">redir_result</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x800</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HiSax_putstatus</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Ch&quot;</span><span class="p">,</span>
					<span class="s">&quot;%d L3-&gt;L4 unknown primitiv %#x&quot;</span><span class="p">,</span>
					<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dummy_pstack</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;call to dummy_pstack pr=%04x arg %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">init_PStack</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">**</span><span class="n">stp</span><span class="p">)</span> <span class="p">{</span>
	<span class="o">*</span><span class="n">stp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">stp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">stp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">stp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span> <span class="o">=</span> <span class="n">dummy_pstack</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">stp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1hw</span> <span class="o">=</span> <span class="n">dummy_pstack</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">stp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1tei</span> <span class="o">=</span> <span class="n">dummy_pstack</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">stp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2tei</span> <span class="o">=</span> <span class="n">dummy_pstack</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">stp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2l1</span> <span class="o">=</span> <span class="n">dummy_pstack</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">stp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2l3</span> <span class="o">=</span> <span class="n">dummy_pstack</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">stp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l2</span> <span class="o">=</span> <span class="n">dummy_pstack</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">stp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3ml3</span> <span class="o">=</span> <span class="n">dummy_pstack</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">stp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span> <span class="o">=</span> <span class="n">dummy_pstack</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">stp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span> <span class="o">=</span> <span class="n">dummy_pstack</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">stp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">layer</span> <span class="o">=</span> <span class="n">dummy_pstack</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">init_d_st</span><span class="p">(</span><span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">init_PStack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">st</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">HiSax_addlist</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">st</span><span class="p">);</span>
	<span class="n">setstack_HiSax</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">cs</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">sap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">tei</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_MOD128</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">flag</span><span class="p">);</span>
	<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LAPD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">flag</span><span class="p">);</span>
	<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_ORIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">flag</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">maxlen</span> <span class="o">=</span> <span class="n">MAX_DFRAME_LEN</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">window</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">T200</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>	<span class="cm">/* 1000 milliseconds  */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">N200</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* try 3 times        */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">T203</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>	<span class="cm">/* 10000 milliseconds */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_TWO_DCHAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s">&quot;DCh%d Q.921 &quot;</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s">&quot;DCh Q.921 &quot;</span><span class="p">);</span>
	<span class="n">setstack_isdnl2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">setstack_l3dc</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">chanp</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">userdata</span> <span class="o">=</span> <span class="n">chanp</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l4</span> <span class="o">=</span> <span class="n">dchan_l3l4</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">__printf</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="kt">void</span>
	<span class="n">callc_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s">&quot;Ch%d callc &quot;</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">VHiSax_putstatus</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">init_chan</span><span class="p">(</span><span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">csta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="n">chan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span> <span class="o">=</span> <span class="n">csta</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">+</span> <span class="n">chan</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">incoming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">leased</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">init_PStack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">b_st</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">b_st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">DEFAULT_B_DELAY</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">.</span><span class="n">fsm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">callcfsm</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">ST_NULL</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">.</span><span class="n">userdata</span> <span class="o">=</span> <span class="n">chanp</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">.</span><span class="n">printdebug</span> <span class="o">=</span> <span class="n">callc_debug</span><span class="p">;</span>
	<span class="n">FsmInitTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">dial_timer</span><span class="p">);</span>
	<span class="n">FsmInitTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">drel_timer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span> <span class="o">||</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_TWO_DCHAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">init_d_st</span><span class="p">(</span><span class="n">chanp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span> <span class="o">=</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">data_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">CallcNewChan</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">csta</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">chancount</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">init_chan</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">csta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">init_chan</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">csta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax: 2 channels added</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_WAITING_CALLS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">init_chan</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">csta</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax: MAX_WAITING_CALLS added</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_PTP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;LAYER2 WATCHING ESTABLISH</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span>
					      <span class="n">DL_ESTABLISH</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">release_d_st</span><span class="p">(</span><span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">st</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">releasestack_isdnl2</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="n">releasestack_isdnl3</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="n">HiSax_rmlist</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">,</span> <span class="n">st</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">CallcFreeChan</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">csta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FsmDelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">drel_timer</span><span class="p">,</span> <span class="mi">74</span><span class="p">);</span>
		<span class="n">FsmDelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dial_timer</span><span class="p">,</span> <span class="mi">75</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_TWO_DCHAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
			<span class="n">release_d_st</span><span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">b_st</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">release_b_st</span><span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">b_st</span><span class="p">);</span>
			<span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">b_st</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CallcFreeChan b_st ch%d already freed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_TWO_DCHAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">release_d_st</span><span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_st</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lldata_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="p">)</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">userdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">DL_DATA</span>  <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">data_open</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x800</span><span class="p">)</span>
				<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;lldata: %d&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">rcvcallb_skb</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;lldata: channel not open&quot;</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">DL_ESTABLISH</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">DL_ESTABLISH</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">)</span>:
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_BC_EST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">DL_RELEASE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">DL_RELEASE</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">)</span>:
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_BC_REL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;lldata_handler unknown primitive %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lltrans_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="p">)</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">userdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">data_open</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x800</span><span class="p">)</span>
				<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;lltrans: %d&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">rcvcallb_skb</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;lltrans: channel not open&quot;</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_ACTIVATE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_ACTIVATE</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">)</span>:
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_BC_EST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">)</span>:
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_BC_REL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;lltrans_handler unknown primitive %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">lli_writewakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">userdata</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">ic</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x800</span><span class="p">)</span>
		<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;llwakeup: %d&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_BSENT</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">init_b_st</span><span class="p">(</span><span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">incoming</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">b_st</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span> <span class="o">=</span> <span class="n">cs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">leased</span><span class="p">)</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bc</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bc</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">bchannel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">l2_active_protocol</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_PROTO_L2_X75I</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_PROTO_L2_HDLC</span><span class="p">)</span>:
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">L1_MODE_HDLC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_PROTO_L2_HDLC_56K</span><span class="p">)</span>:
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">L1_MODE_HDLC_56K</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_PROTO_L2_TRANS</span><span class="p">)</span>:
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">L1_MODE_TRANS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_PROTO_L2_MODEM</span><span class="p">)</span>:
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">L1_MODE_V32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_PROTO_L2_FAX</span><span class="p">)</span>:
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">L1_MODE_FAX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">conmsg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">BC_SetStack</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LAPB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">flag</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">maxlen</span> <span class="o">=</span> <span class="n">MAX_DATA_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">incoming</span><span class="p">)</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_ORIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">flag</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">T200</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>	<span class="cm">/* 1000 milliseconds */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">window</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">N200</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* try 4 times       */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">T203</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>	<span class="cm">/* 5000 milliseconds */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">l2_active_protocol</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_PROTO_L2_X75I</span><span class="p">)</span>:
		<span class="n">sprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s">&quot;Ch%d X.75&quot;</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">setstack_isdnl2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">setstack_l3bc</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">chanp</span><span class="p">);</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2l3</span> <span class="o">=</span> <span class="n">lldata_handler</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">userdata</span> <span class="o">=</span> <span class="n">chanp</span><span class="p">;</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LLI_L1WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">flag</span><span class="p">);</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LLI_L2WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">flag</span><span class="p">);</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2m</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_PROTO_L2_HDLC</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_PROTO_L2_HDLC_56K</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_PROTO_L2_TRANS</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_PROTO_L2_MODEM</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_PROTO_L2_FAX</span><span class="p">)</span>:
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span> <span class="o">=</span> <span class="n">lltrans_handler</span><span class="p">;</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">userdata</span> <span class="o">=</span> <span class="n">chanp</span><span class="p">;</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_LLI_L1WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">flag</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_LLI_L2WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">flag</span><span class="p">);</span>
		<span class="n">setstack_transl2</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
		<span class="n">setstack_l3bc</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">chanp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_START_B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">leased_l4l3</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="p">)</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">userdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;leased line d-channel DATA&quot;</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">DL_ESTABLISH</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2l1</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_ACTIVATE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">DL_RELEASE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;transd_l4l3 unknown primitive %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">leased_l1l2</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="p">)</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">userdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">event</span> <span class="o">=</span> <span class="n">EV_LEASED_REL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;leased line d-channel DATA&quot;</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_ACTIVATE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_ACTIVATE</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">)</span>:
		<span class="n">event</span> <span class="o">=</span> <span class="n">EV_LEASED</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_TWO_DCHAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">chanp</span><span class="o">++</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;transd_l1l2 unknown primitive %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">distr_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">csta</span><span class="p">,</span> <span class="kt">int</span> <span class="n">debugflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span> <span class="o">=</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">MAX_WAITING_CALLS</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chanp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debugflags</span><span class="p">;</span>
		<span class="n">chanp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fi</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debugflags</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">chanp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2m</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debugflags</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">chanp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">b_st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2m</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debugflags</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">chanp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debugflags</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">chanp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">b_st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debugflags</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">chanp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3m</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debugflags</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">chanp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">b_st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3m</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debugflags</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">;</span>
		<span class="n">chanp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">b_st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debugflags</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">;</span>
		<span class="n">chanp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">b_st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debugflags</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">;</span>
		<span class="n">chanp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1m</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debugflags</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">;</span>
		<span class="n">chanp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">b_st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1m</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debugflags</span> <span class="o">&amp;</span> <span class="mh">0x2000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugflags</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">csta</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">|=</span> <span class="n">DEB_DLOG_HEX</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">csta</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DEB_DLOG_HEX</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">tmpbuf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">capi_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span><span class="p">,</span> <span class="n">capi_msg</span> <span class="o">*</span><span class="n">cm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">tmpbuf</span><span class="p">;</span>

	<span class="n">t</span> <span class="o">+=</span> <span class="n">QuickHex</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="n">cm</span><span class="p">,</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">Length</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span> <span class="o">?</span> <span class="mi">50</span> <span class="o">:</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">Length</span><span class="p">);</span>
	<span class="n">t</span><span class="o">--</span><span class="p">;</span>
	<span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">HiSax_putstatus</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Ch&quot;</span><span class="p">,</span> <span class="s">&quot;%d CAPIMSG %s&quot;</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="n">tmpbuf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_got_fac_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span><span class="p">,</span> <span class="n">capi_msg</span> <span class="o">*</span><span class="n">cm</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* Suspend */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_SUSPEND</span><span class="p">,</span> <span class="n">cm</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>: <span class="cm">/* Resume */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">ST_NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_RESUME</span><span class="p">,</span> <span class="n">cm</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">FsmDelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">dial_timer</span><span class="p">,</span> <span class="mi">72</span><span class="p">);</span>
			<span class="n">FsmAddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">dial_timer</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="n">EV_RESUME</span><span class="p">,</span> <span class="n">cm</span><span class="p">,</span> <span class="mi">73</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lli_got_manufacturer</span><span class="p">(</span><span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">capi_msg</span> <span class="o">*</span><span class="n">cm</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">typ</span> <span class="o">==</span> <span class="n">ISDN_CTYPE_ELSA</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">typ</span> <span class="o">==</span> <span class="n">ISDN_CTYPE_ELSA_PNP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">typ</span> <span class="o">==</span> <span class="n">ISDN_CTYPE_ELSA_PCI</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">elsa</span><span class="p">.</span><span class="n">MFlag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">CARD_AUX_IND</span><span class="p">,</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/***************************************************************/</span>
<span class="cm">/* Limit the available number of channels for the current card */</span>
<span class="cm">/***************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">set_channel_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chanmax</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_ctrl</span> <span class="n">ic</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ii</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">chanmax</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">chanmax</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">chanlimit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_DISCH</span><span class="p">;</span>
		<span class="n">ic</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">ii</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">&gt;=</span> <span class="n">chanmax</span><span class="p">)</span>
			<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* disabled */</span>
		<span class="k">else</span>
			<span class="n">ic</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* enabled */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ic</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">&lt;</span> <span class="n">chanmax</span><span class="p">)</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">chanlimit</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* set_channel_limit */</span>

<span class="kt">int</span>
<span class="nf">HiSax_command</span><span class="p">(</span><span class="n">isdn_ctrl</span> <span class="o">*</span><span class="n">ic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">csta</span> <span class="o">=</span> <span class="n">hisax_findcard</span><span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">num</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;HiSax: if_command %d called with invalid driverId %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ic</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_CMD_SETEAZ</span><span class="p">)</span>:
		<span class="n">chanp</span> <span class="o">=</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_CMD_SETL2</span><span class="p">)</span>:
		<span class="n">chanp</span> <span class="o">=</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;SETL2 card %d %ld&quot;</span><span class="p">,</span>
				   <span class="n">csta</span><span class="o">-&gt;</span><span class="n">cardnr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">l2_protocol</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_CMD_SETL3</span><span class="p">)</span>:
		<span class="n">chanp</span> <span class="o">=</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;SETL3 card %d %ld&quot;</span><span class="p">,</span>
				   <span class="n">csta</span><span class="o">-&gt;</span><span class="n">cardnr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">l3_protocol</span> <span class="o">=</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_CMD_DIAL</span><span class="p">)</span>:
		<span class="n">chanp</span> <span class="o">=</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;DIAL %s -&gt; %s (%d,%d)&quot;</span><span class="p">,</span>
				   <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">,</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">,</span>
				   <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span><span class="p">,</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">setup_parm</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">))</span>
			<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="cm">/* this solution is dirty and may be change, if</span>
<span class="cm">		 * we make a callreference based callmanager */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">ST_NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_DIAL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">FsmDelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">dial_timer</span><span class="p">,</span> <span class="mi">70</span><span class="p">);</span>
			<span class="n">FsmAddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">dial_timer</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">EV_DIAL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">71</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_CMD_ACCEPTB</span><span class="p">)</span>:
		<span class="n">chanp</span> <span class="o">=</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ACCEPTB&quot;</span><span class="p">);</span>
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_ACCEPTB</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_CMD_ACCEPTD</span><span class="p">)</span>:
		<span class="n">chanp</span> <span class="o">=</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">setup_parm</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ACCEPTD&quot;</span><span class="p">);</span>
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_ACCEPTD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_CMD_HANGUP</span><span class="p">)</span>:
		<span class="n">chanp</span> <span class="o">=</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;HANGUP&quot;</span><span class="p">);</span>
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_HANGUP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">CAPI_PUT_MESSAGE</span><span class="p">)</span>:
		<span class="n">chanp</span> <span class="o">=</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">capi_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">Length</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">Command</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CAPI_FACILITY</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">Subcommand</span> <span class="o">==</span> <span class="n">CAPI_REQ</span><span class="p">)</span>
				<span class="n">lli_got_fac_req</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CAPI_MANUFACTURER</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">Subcommand</span> <span class="o">==</span> <span class="n">CAPI_REQ</span><span class="p">)</span>
				<span class="n">lli_got_manufacturer</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="n">csta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_CMD_IOCTL</span><span class="p">)</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
			<span class="n">num</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">;</span>
			<span class="n">HiSax_reportcard</span><span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">cardnr</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>:
			<span class="n">num</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">;</span>
			<span class="n">distr_debug</span><span class="p">(</span><span class="n">csta</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HiSax: debugging flags card %d set to %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">csta</span><span class="o">-&gt;</span><span class="n">cardnr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
			<span class="n">HiSax_putstatus</span><span class="p">(</span><span class="n">csta</span><span class="p">,</span> <span class="s">&quot;debugging flags &quot;</span><span class="p">,</span>
					<span class="s">&quot;card %d set to %x&quot;</span><span class="p">,</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">cardnr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>:
			<span class="n">num</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">;</span>
			<span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">b_st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
			<span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">b_st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
			<span class="n">HiSax_putstatus</span><span class="p">(</span><span class="n">csta</span><span class="p">,</span> <span class="s">&quot;delay &quot;</span><span class="p">,</span> <span class="s">&quot;card %d set to %d ms&quot;</span><span class="p">,</span>
					<span class="n">csta</span><span class="o">-&gt;</span><span class="n">cardnr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HiSax: delay card %d set to %d ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">csta</span><span class="o">-&gt;</span><span class="n">cardnr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span>:	<span class="cm">/* set card in leased mode */</span>
			<span class="n">num</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">num</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">HiSax_putstatus</span><span class="p">(</span><span class="n">csta</span><span class="p">,</span> <span class="s">&quot;Set LEASED &quot;</span><span class="p">,</span>
						<span class="s">&quot;wrong channel %d&quot;</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HiSax: Set LEASED wrong channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">num</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">num</span><span class="o">--</span><span class="p">;</span>
				<span class="n">chanp</span> <span class="o">=</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="n">num</span><span class="p">;</span>
				<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">leased</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">HiSax_putstatus</span><span class="p">(</span><span class="n">csta</span><span class="p">,</span> <span class="s">&quot;Card&quot;</span><span class="p">,</span>
						<span class="s">&quot;%d channel %d set leased mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">csta</span><span class="o">-&gt;</span><span class="n">cardnr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span> <span class="o">=</span> <span class="n">leased_l1l2</span><span class="p">;</span>
				<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span> <span class="o">=</span> <span class="n">leased_l4l3</span><span class="p">;</span>
				<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span>
						      <span class="n">DL_ESTABLISH</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span>:	<span class="cm">/* set B-channel test loop */</span>
			<span class="n">num</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">stlist</span><span class="p">)</span>
				<span class="n">csta</span><span class="o">-&gt;</span><span class="n">stlist</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2l1</span><span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">stlist</span><span class="p">,</span>
						      <span class="n">PH_TESTLOOP</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">num</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mi">7</span><span class="p">)</span>:	<span class="cm">/* set card in PTP mode */</span>
			<span class="n">num</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_TWO_DCHAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;HiSax PTP mode only with one TEI possible</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_PTP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">flag</span><span class="p">);</span>
				<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_FIXED_TEI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">flag</span><span class="p">);</span>
				<span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">tei</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">HiSax_putstatus</span><span class="p">(</span><span class="n">csta</span><span class="p">,</span> <span class="s">&quot;set card &quot;</span><span class="p">,</span> <span class="s">&quot;in PTP mode&quot;</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HiSax: set card in PTP mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;LAYER2 WATCHING ESTABLISH</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d_st</span><span class="p">,</span>
								<span class="n">DL_ESTABLISH</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_PTP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">flag</span><span class="p">);</span>
				<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_FIXED_TEI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">flag</span><span class="p">);</span>
				<span class="n">HiSax_putstatus</span><span class="p">(</span><span class="n">csta</span><span class="p">,</span> <span class="s">&quot;set card &quot;</span><span class="p">,</span> <span class="s">&quot;in PTMP mode&quot;</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HiSax: set card in PTMP mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mi">8</span><span class="p">)</span>:	<span class="cm">/* set card in FIXED TEI mode */</span>
			<span class="n">num</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">;</span>
			<span class="n">chanp</span> <span class="o">=</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="p">(</span><span class="n">num</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">num</span> <span class="o">=</span> <span class="n">num</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="mi">127</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_FIXED_TEI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">flag</span><span class="p">);</span>
				<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">tei</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">HiSax_putstatus</span><span class="p">(</span><span class="n">csta</span><span class="p">,</span> <span class="s">&quot;set card &quot;</span><span class="p">,</span> <span class="s">&quot;in VAR TEI mode&quot;</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HiSax: set card in VAR TEI mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_FIXED_TEI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">flag</span><span class="p">);</span>
				<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">tei</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
				<span class="n">HiSax_putstatus</span><span class="p">(</span><span class="n">csta</span><span class="p">,</span> <span class="s">&quot;set card &quot;</span><span class="p">,</span> <span class="s">&quot;in FIXED TEI (%d) mode&quot;</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HiSax: set card in FIXED TEI (%d) mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">num</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3</span><span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">d_st</span><span class="p">,</span>
					      <span class="n">DL_ESTABLISH</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mi">11</span><span class="p">)</span>:
			<span class="n">num</span> <span class="o">=</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_HEX</span><span class="p">;</span>
			<span class="n">csta</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">;</span>
			<span class="n">csta</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">|=</span> <span class="n">num</span><span class="p">;</span>
			<span class="n">HiSax_putstatus</span><span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;l1 debugging &quot;</span><span class="p">,</span>
					<span class="s">&quot;flags card %d set to %x&quot;</span><span class="p">,</span>
					<span class="n">csta</span><span class="o">-&gt;</span><span class="n">cardnr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HiSax: l1 debugging flags card %d set to %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">csta</span><span class="o">-&gt;</span><span class="n">cardnr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mi">13</span><span class="p">)</span>:
			<span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">;</span>
			<span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">d_st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">;</span>
			<span class="n">HiSax_putstatus</span><span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;l3 debugging &quot;</span><span class="p">,</span>
					<span class="s">&quot;flags card %d set to %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">cardnr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
					<span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HiSax: l3 debugging flags card %d set to %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">csta</span><span class="o">-&gt;</span><span class="n">cardnr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>:
			<span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">;</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">set_channel_limit</span><span class="p">(</span><span class="n">csta</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">auxcmd</span><span class="p">)</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">auxcmd</span><span class="p">(</span><span class="n">csta</span><span class="p">,</span> <span class="n">ic</span><span class="p">));</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HiSax: invalid ioctl %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_CMD_PROCEED</span><span class="p">)</span>:
		<span class="n">chanp</span> <span class="o">=</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;PROCEED&quot;</span><span class="p">);</span>
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_PROCEED</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_CMD_ALERT</span><span class="p">)</span>:
		<span class="n">chanp</span> <span class="o">=</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ALERT&quot;</span><span class="p">);</span>
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_ALERT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_CMD_REDIR</span><span class="p">)</span>:
		<span class="n">chanp</span> <span class="o">=</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;REDIR&quot;</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">setup_parm</span><span class="p">));</span>
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">fi</span><span class="p">,</span> <span class="n">EV_REDIR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* protocol specific io commands */</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_CMD_PROT_IO</span><span class="p">)</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">st</span> <span class="o">=</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">stlist</span><span class="p">;</span> <span class="n">st</span><span class="p">;</span> <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="p">(</span><span class="n">ic</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">))</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">l4l3_proto</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">ic</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">auxcmd</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">csta</span><span class="o">-&gt;</span><span class="n">auxcmd</span><span class="p">(</span><span class="n">csta</span><span class="p">,</span> <span class="n">ic</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">HiSax_writebuf_skb</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ack</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">csta</span> <span class="o">=</span> <span class="n">hisax_findcard</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">Channel</span> <span class="o">*</span><span class="n">chanp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;HiSax: if_sendbuf called with invalid driverId!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chanp</span> <span class="o">=</span> <span class="n">csta</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="n">chan</span><span class="p">;</span>
	<span class="n">st</span> <span class="o">=</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">b_st</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">data_open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;writebuf: channel not open&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">MAX_DATA_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;writebuf: packet too large (%d bytes)&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HiSax_writebuf: packet too large (%d bytes) !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">+</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_DATA_MEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Must return 0 here, since this is not an error</span>
<span class="cm">			 * but a temporary lack of resources.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x800</span><span class="p">)</span>
				<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;writebuf: no buffers for %d bytes&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x800</span><span class="p">)</span>
			<span class="n">link_debug</span><span class="p">(</span><span class="n">chanp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;writebuf %d/%d/%d&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">chanp</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">,</span> <span class="n">MAX_DATA_MEM</span><span class="p">);</span>
		<span class="n">nskb</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nskb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">=</span> <span class="n">nskb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ack</span><span class="p">)</span>
				<span class="n">nskb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_NOACK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chanp</span><span class="o">-&gt;</span><span class="n">l2_active_protocol</span> <span class="o">==</span> <span class="n">ISDN_PROTO_L2_X75I</span><span class="p">)</span>
				<span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">DL_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">chanp</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
				<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2l1</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
