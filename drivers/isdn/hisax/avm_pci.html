<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hisax › avm_pci.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>avm_pci.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: avm_pci.c,v 1.29.2.4 2004/02/11 13:21:32 keil Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * low level stuff for AVM Fritz!PCI and ISA PnP isdn cards</span>
<span class="cm"> *</span>
<span class="cm"> * Author       Karsten Keil</span>
<span class="cm"> * Copyright    by Karsten Keil      &lt;keil@isdn4linux.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to AVM, Berlin for information</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &quot;hisax.h&quot;</span>
<span class="cp">#include &quot;isac.h&quot;</span>
<span class="cp">#include &quot;isdnl1.h&quot;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/isapnp.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">avm_pci_rev</span> <span class="o">=</span> <span class="s">&quot;$Revision: 1.29.2.4 $&quot;</span><span class="p">;</span>

<span class="cp">#define  AVM_FRITZ_PCI		1</span>
<span class="cp">#define  AVM_FRITZ_PNP		2</span>

<span class="cp">#define  HDLC_FIFO		0x0</span>
<span class="cp">#define  HDLC_STATUS		0x4</span>

<span class="cp">#define	 AVM_HDLC_1		0x00</span>
<span class="cp">#define	 AVM_HDLC_2		0x01</span>
<span class="cp">#define	 AVM_ISAC_FIFO		0x02</span>
<span class="cp">#define	 AVM_ISAC_REG_LOW	0x04</span>
<span class="cp">#define	 AVM_ISAC_REG_HIGH	0x06</span>

<span class="cp">#define  AVM_STATUS0_IRQ_ISAC	0x01</span>
<span class="cp">#define  AVM_STATUS0_IRQ_HDLC	0x02</span>
<span class="cp">#define  AVM_STATUS0_IRQ_TIMER	0x04</span>
<span class="cp">#define  AVM_STATUS0_IRQ_MASK	0x07</span>

<span class="cp">#define  AVM_STATUS0_RESET	0x01</span>
<span class="cp">#define  AVM_STATUS0_DIS_TIMER	0x02</span>
<span class="cp">#define  AVM_STATUS0_RES_TIMER	0x04</span>
<span class="cp">#define  AVM_STATUS0_ENA_IRQ	0x08</span>
<span class="cp">#define  AVM_STATUS0_TESTBIT	0x10</span>

<span class="cp">#define  AVM_STATUS1_INT_SEL	0x0f</span>
<span class="cp">#define  AVM_STATUS1_ENA_IOM	0x80</span>

<span class="cp">#define  HDLC_MODE_ITF_FLG	0x01</span>
<span class="cp">#define  HDLC_MODE_TRANS	0x02</span>
<span class="cp">#define  HDLC_MODE_CCR_7	0x04</span>
<span class="cp">#define  HDLC_MODE_CCR_16	0x08</span>
<span class="cp">#define  HDLC_MODE_TESTLOOP	0x80</span>

<span class="cp">#define  HDLC_INT_XPR		0x80</span>
<span class="cp">#define  HDLC_INT_XDU		0x40</span>
<span class="cp">#define  HDLC_INT_RPR		0x20</span>
<span class="cp">#define  HDLC_INT_MASK		0xE0</span>

<span class="cp">#define  HDLC_STAT_RME		0x01</span>
<span class="cp">#define  HDLC_STAT_RDO		0x10</span>
<span class="cp">#define  HDLC_STAT_CRCVFRRAB	0x0E</span>
<span class="cp">#define  HDLC_STAT_CRCVFR	0x06</span>
<span class="cp">#define  HDLC_STAT_RML_MASK	0x3f00</span>

<span class="cp">#define  HDLC_CMD_XRS		0x80</span>
<span class="cp">#define  HDLC_CMD_XME		0x01</span>
<span class="cp">#define  HDLC_CMD_RRS		0x20</span>
<span class="cp">#define  HDLC_CMD_XML_MASK	0x3f00</span>


<span class="cm">/* Interface functions */</span>

<span class="k">static</span> <span class="n">u_char</span>
<span class="nf">ReadISAC</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="n">u_char</span> <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mh">0x2f</span><span class="p">)</span> <span class="o">?</span> <span class="n">AVM_ISAC_REG_HIGH</span> <span class="o">:</span> <span class="n">AVM_ISAC_REG_LOW</span><span class="p">;</span>
	<span class="k">register</span> <span class="n">u_char</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">isac</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">));</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">WriteISAC</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="n">u_char</span> <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mh">0x2f</span><span class="p">)</span> <span class="o">?</span> <span class="n">AVM_ISAC_REG_HIGH</span> <span class="o">:</span> <span class="n">AVM_ISAC_REG_LOW</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">isac</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ReadISACfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">AVM_ISAC_FIFO</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">insb</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">WriteISACfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">AVM_ISAC_FIFO</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">outsb</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">isac</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u_int</span>
<span class="nf">ReadHDLCPCI</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="n">u_int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">chan</span> <span class="o">?</span> <span class="n">AVM_HDLC_2</span> <span class="o">:</span> <span class="n">AVM_HDLC_1</span><span class="p">;</span>
	<span class="k">register</span> <span class="n">u_int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">outl</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">isac</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">WriteHDLCPCI</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="n">u_int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">chan</span> <span class="o">?</span> <span class="n">AVM_HDLC_2</span> <span class="o">:</span> <span class="n">AVM_HDLC_1</span><span class="p">;</span>

	<span class="n">outl</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">isac</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u_char</span>
<span class="nf">ReadHDLCPnP</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="n">u_char</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">chan</span> <span class="o">?</span> <span class="n">AVM_HDLC_2</span> <span class="o">:</span> <span class="n">AVM_HDLC_1</span><span class="p">;</span>
	<span class="k">register</span> <span class="n">u_char</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">isac</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">WriteHDLCPnP</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="n">u_char</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">chan</span> <span class="o">?</span> <span class="n">AVM_HDLC_2</span> <span class="o">:</span> <span class="n">AVM_HDLC_1</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">isac</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_char</span>
<span class="nf">ReadHDLC_s</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="mh">0xff</span> <span class="o">&amp;</span> <span class="n">ReadHDLCPCI</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">offset</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">WriteHDLC_s</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WriteHDLCPCI</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="nf">Sel_BCS</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mode</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">channel</span> <span class="o">==</span> <span class="n">channel</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">mode</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">channel</span> <span class="o">==</span> <span class="n">channel</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">write_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hdlc %c wr%x ctrl %x&quot;</span><span class="p">,</span>
			<span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">which</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">AVM_FRITZ_PCI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WriteHDLCPCI</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">HDLC_STATUS</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">WriteHDLCPnP</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">HDLC_STATUS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
				     <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">WriteHDLCPnP</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">HDLC_STATUS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				     <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">xml</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">WriteHDLCPnP</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">HDLC_STATUS</span><span class="p">,</span>
				     <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">modehdlc</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdlc</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hdlc %c mode %d --&gt; %d ichan %d --&gt; %d&quot;</span><span class="p">,</span>
			<span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">hdlc</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">hdlc</span><span class="p">,</span> <span class="n">bc</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>: <span class="cm">/* used for init */</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">bc</span><span class="p">;</span>
		<span class="n">bc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">L1_MODE_NULL</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">L1_MODE_NULL</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">cmd</span>  <span class="o">=</span> <span class="n">HDLC_CMD_XRS</span> <span class="o">|</span> <span class="n">HDLC_CMD_RRS</span><span class="p">;</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">HDLC_MODE_TRANS</span><span class="p">;</span>
		<span class="n">write_ctrl</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">L1_MODE_NULL</span><span class="p">;</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">bc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">L1_MODE_TRANS</span><span class="p">)</span>:
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">bc</span><span class="p">;</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">cmd</span>  <span class="o">=</span> <span class="n">HDLC_CMD_XRS</span> <span class="o">|</span> <span class="n">HDLC_CMD_RRS</span><span class="p">;</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">HDLC_MODE_TRANS</span><span class="p">;</span>
		<span class="n">write_ctrl</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">HDLC_CMD_XRS</span><span class="p">;</span>
		<span class="n">write_ctrl</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">schedule_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_XMTBUFREADY</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">L1_MODE_HDLC</span><span class="p">)</span>:
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">bc</span><span class="p">;</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">cmd</span>  <span class="o">=</span> <span class="n">HDLC_CMD_XRS</span> <span class="o">|</span> <span class="n">HDLC_CMD_RRS</span><span class="p">;</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">HDLC_MODE_ITF_FLG</span><span class="p">;</span>
		<span class="n">write_ctrl</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">HDLC_CMD_XRS</span><span class="p">;</span>
		<span class="n">write_ctrl</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">schedule_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_XMTBUFREADY</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">hdlc_empty_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="n">u_int</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">?</span> <span class="n">AVM_HDLC_2</span> <span class="o">:</span> <span class="n">AVM_HDLC_1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX_FIFO</span><span class="p">))</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hdlc_empty_fifo %d&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">rcvidx</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">HSCX_BUFMAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hdlc_empty_fifo: incoming packet too large&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">rcvbuf</span> <span class="o">+</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">rcvidx</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_int</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">rcvidx</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">AVM_FRITZ_PCI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef __powerpc__</span>
			<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">isac</span> <span class="o">+</span> <span class="n">_IO_BASE</span><span class="p">));</span>
<span class="cp">#else</span>
			<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">isac</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* __powerpc__ */</span><span class="cp"></span>
			<span class="n">cnt</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">isac</span><span class="p">);</span>
			<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX_FIFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">blog</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">AVM_FRITZ_PNP</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&quot;hdlc_empty_fifo %c cnt %d&quot;</span><span class="p">,</span>
			     <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">?</span> <span class="sc">&#39;B&#39;</span> <span class="o">:</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">QuickHex</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">blog</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">hdlc_fill_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX_FIFO</span><span class="p">))</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hdlc_fill_fifo&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDLC_CMD_XME</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">fifo_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">fifo_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">L1_MODE_TRANS</span><span class="p">)</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">|=</span> <span class="n">HDLC_CMD_XME</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX_FIFO</span><span class="p">))</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hdlc_fill_fifo %d/%u&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_int</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">count</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">xml</span> <span class="o">=</span> <span class="p">((</span><span class="n">count</span> <span class="o">==</span> <span class="n">fifo_size</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">write_ctrl</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>  <span class="cm">/* sets the correct index too */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">AVM_FRITZ_PCI</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef __powerpc__</span>
			<span class="n">out_be32</span><span class="p">((</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">isac</span> <span class="o">+</span> <span class="n">_IO_BASE</span><span class="p">),</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">);</span>
<span class="cp">#else</span>
			<span class="n">outl</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">isac</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* __powerpc__ */</span><span class="cp"></span>
			<span class="n">cnt</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">isac</span><span class="p">);</span>
			<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX_FIFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">blog</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">AVM_FRITZ_PNP</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&quot;hdlc_fill_fifo %c cnt %d&quot;</span><span class="p">,</span>
			     <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">?</span> <span class="sc">&#39;B&#39;</span> <span class="o">:</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">QuickHex</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">blog</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">HDLC_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">stat</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;ch%d stat %#x&quot;</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">HDLC_INT_RPR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">HDLC_STAT_RDO</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;RDO&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;ch%d stat %#x&quot;</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">xml</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">|=</span> <span class="n">HDLC_CMD_RRS</span><span class="p">;</span>
			<span class="n">write_ctrl</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDLC_CMD_RRS</span><span class="p">;</span>
			<span class="n">write_ctrl</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">rcvidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">HDLC_STAT_RML_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">))</span>
				<span class="n">len</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">hdlc_empty_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">HDLC_STAT_RME</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">L1_MODE_TRANS</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">HDLC_STAT_CRCVFRRAB</span><span class="p">)</span> <span class="o">==</span> <span class="n">HDLC_STAT_CRCVFR</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">L1_MODE_TRANS</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">rcvidx</span><span class="p">)))</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HDLC: receive out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">else</span> <span class="p">{</span>
						<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">rcvidx</span><span class="p">),</span>
						       <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">rcvbuf</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">rcvidx</span><span class="p">);</span>
						<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rqueue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">rcvidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">schedule_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_RCVBUFREADY</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span>
						<span class="n">debugl1</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;invalid frame&quot;</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="n">debugl1</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;ch%d invalid frame %#x&quot;</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
					<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">rcvidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">HDLC_INT_XDU</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Here we lost an TX interrupt, so</span>
<span class="cm">		 * restart transmitting the whole frame.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_push</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">+=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;ch%d XDU&quot;</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;ch%d XDU without skb&quot;</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">xml</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">|=</span> <span class="n">HDLC_CMD_XRS</span><span class="p">;</span>
		<span class="n">write_ctrl</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">sr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDLC_CMD_XRS</span><span class="p">;</span>
		<span class="n">write_ctrl</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">hdlc_fill_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">HDLC_INT_XPR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc_fill_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_LLI_L1WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">flag</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">PACKET_NOACK</span> <span class="o">!=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>
					<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aclock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ackcnt</span> <span class="o">+=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aclock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="n">schedule_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_ACKPENDING</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
				<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
			<span class="n">hdlc_fill_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
			<span class="n">schedule_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_XMTBUFREADY</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">HDLC_irq_main</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">stat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">AVM_FRITZ_PCI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">ReadHDLCPCI</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDLC_STATUS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">ReadHDLCPnP</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDLC_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">HDLC_INT_RPR</span><span class="p">)</span>
			<span class="n">stat</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ReadHDLCPnP</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDLC_STATUS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">HDLC_INT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">Sel_BCS</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hdlc spurious channel 0 IRQ&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">HDLC_irq</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">AVM_FRITZ_PCI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">ReadHDLCPCI</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">HDLC_STATUS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">ReadHDLCPnP</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">HDLC_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">HDLC_INT_RPR</span><span class="p">)</span>
			<span class="n">stat</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ReadHDLCPnP</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">HDLC_STATUS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">HDLC_INT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">Sel_BCS</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;hdlc spurious channel 1 IRQ&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">HDLC_irq</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hdlc_l2l1</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bcs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Send_Data</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;hdlc_l2l1: this shouldn&#39;t happen</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Send_Data</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L1_PULL_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_L1_PULL_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_ACTIVATE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">BC_FLG_ACTIV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="n">modehdlc</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bc</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">l1_msg_b</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">l1_msg_b</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_ACTIV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="n">modehdlc</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bc</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">close_hdlcstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">modehdlc</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">rcvbuf</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">blog</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">blog</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rqueue</span><span class="p">);</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">open_hdlcstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">BC_FLG_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">HSCX_BUFMAX</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;HiSax: No memory for hdlc.rcvbuf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">blog</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MAX_BLOG_SPACE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;HiSax: No memory for bcs-&gt;blog</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">rcvbuf</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rqueue</span><span class="p">);</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hdlc</span><span class="p">.</span><span class="n">rcvidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">setstack_hdlc</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">open_hdlcstate</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">,</span> <span class="n">bcs</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">bcs</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2l1</span> <span class="o">=</span> <span class="n">hdlc_l2l1</span><span class="p">;</span>
	<span class="n">setstack_manager</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="p">;</span>
	<span class="n">setstack_l1_B</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">void __init</span>
<span class="c">clear_pending_hdlc_ints(struct IsdnCardState *cs)</span>
<span class="c">{</span>
<span class="c">	u_int val;</span>

<span class="c">	if (cs-&gt;subtyp == AVM_FRITZ_PCI) {</span>
<span class="c">		val = ReadHDLCPCI(cs, 0, HDLC_STATUS);</span>
<span class="c">		debugl1(cs, &quot;HDLC 1 STA %x&quot;, val);</span>
<span class="c">		val = ReadHDLCPCI(cs, 1, HDLC_STATUS);</span>
<span class="c">		debugl1(cs, &quot;HDLC 2 STA %x&quot;, val);</span>
<span class="c">	} else {</span>
<span class="c">		val = ReadHDLCPnP(cs, 0, HDLC_STATUS);</span>
<span class="c">		debugl1(cs, &quot;HDLC 1 STA %x&quot;, val);</span>
<span class="c">		val = ReadHDLCPnP(cs, 0, HDLC_STATUS + 1);</span>
<span class="c">		debugl1(cs, &quot;HDLC 1 RML %x&quot;, val);</span>
<span class="c">		val = ReadHDLCPnP(cs, 0, HDLC_STATUS + 2);</span>
<span class="c">		debugl1(cs, &quot;HDLC 1 MODE %x&quot;, val);</span>
<span class="c">		val = ReadHDLCPnP(cs, 0, HDLC_STATUS + 3);</span>
<span class="c">		debugl1(cs, &quot;HDLC 1 VIN %x&quot;, val);</span>
<span class="c">		val = ReadHDLCPnP(cs, 1, HDLC_STATUS);</span>
<span class="c">		debugl1(cs, &quot;HDLC 2 STA %x&quot;, val);</span>
<span class="c">		val = ReadHDLCPnP(cs, 1, HDLC_STATUS + 1);</span>
<span class="c">		debugl1(cs, &quot;HDLC 2 RML %x&quot;, val);</span>
<span class="c">		val = ReadHDLCPnP(cs, 1, HDLC_STATUS + 2);</span>
<span class="c">		debugl1(cs, &quot;HDLC 2 MODE %x&quot;, val);</span>
<span class="c">		val = ReadHDLCPnP(cs, 1, HDLC_STATUS + 3);</span>
<span class="c">		debugl1(cs, &quot;HDLC 2 VIN %x&quot;, val);</span>
<span class="c">	}</span>
<span class="c">}</span>
<span class="cp">#endif  /*  0  */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">inithdlc</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">BC_SetStack</span> <span class="o">=</span> <span class="n">setstack_hdlc</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">BC_SetStack</span> <span class="o">=</span> <span class="n">setstack_hdlc</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">BC_Close</span> <span class="o">=</span> <span class="n">close_hdlcstate</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">BC_Close</span> <span class="o">=</span> <span class="n">close_hdlcstate</span><span class="p">;</span>
	<span class="n">modehdlc</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">modehdlc</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">avm_pcipnp_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">intno</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">sval</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sval</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sval</span> <span class="o">&amp;</span> <span class="n">AVM_STATUS0_IRQ_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AVM_STATUS0_IRQ_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* possible a shared  IRQ reqest */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sval</span> <span class="o">&amp;</span> <span class="n">AVM_STATUS0_IRQ_ISAC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">ReadISAC</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ISAC_ISTA</span><span class="p">);</span>
		<span class="n">isac_interrupt</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sval</span> <span class="o">&amp;</span> <span class="n">AVM_STATUS0_IRQ_HDLC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">HDLC_irq_main</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">WriteISAC</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ISAC_MASK</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">WriteISAC</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ISAC_MASK</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">reset_avmpcipnp</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;AVM PCI/PnP: reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">AVM_STATUS0_RESET</span> <span class="o">|</span> <span class="n">AVM_STATUS0_DIS_TIMER</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">AVM_STATUS0_DIS_TIMER</span> <span class="o">|</span> <span class="n">AVM_STATUS0_RES_TIMER</span> <span class="o">|</span> <span class="n">AVM_STATUS0_ENA_IRQ</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">AVM_STATUS1_ENA_IOM</span> <span class="o">|</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;AVM PCI/PnP: S1 %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">+</span> <span class="mi">3</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">AVM_card_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mt</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CARD_RESET</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">reset_avmpcipnp</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CARD_RELEASE</span>:
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CARD_INIT</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">reset_avmpcipnp</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">clear_pending_isac_ints</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">initisac</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">inithdlc</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">AVM_STATUS0_DIS_TIMER</span> <span class="o">|</span> <span class="n">AVM_STATUS0_RES_TIMER</span><span class="p">,</span>
		     <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">WriteISAC</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ISAC_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">AVM_STATUS0_DIS_TIMER</span> <span class="o">|</span> <span class="n">AVM_STATUS0_RES_TIMER</span> <span class="o">|</span>
		     <span class="n">AVM_STATUS0_ENA_IRQ</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="cm">/* RESET Receiver and Transmitter */</span>
		<span class="n">WriteISAC</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ISAC_CMDR</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CARD_TEST</span>:
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">avm_setup_rest</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">val</span><span class="p">,</span> <span class="n">ver</span><span class="p">;</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">isac</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">AVM_FRITZ_PCI</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;avm PCI&quot;</span> <span class="o">:</span> <span class="s">&quot;avm PnP&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;HiSax: Fritz!PCI/PNP config port %x-%x already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span><span class="p">,</span>
		       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">+</span> <span class="mi">31</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AVM_FRITZ_PCI</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;AVM PCI: stat %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;AVM PCI: Class %X Rev %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Read_Reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ReadHDLC_s</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">WriteHDLC_s</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AVM_FRITZ_PNP</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span><span class="p">);</span>
		<span class="n">ver</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;AVM PnP: Class %X Rev %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ver</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Read_Reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ReadHDLCPnP</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">WriteHDLCPnP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;AVM unknown subtype %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax: %s config irq:%d base:0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">AVM_FRITZ_PCI</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;AVM Fritz!PCI&quot;</span> <span class="o">:</span> <span class="s">&quot;AVM Fritz!PnP&quot;</span><span class="p">,</span>
	       <span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span><span class="p">);</span>

	<span class="n">setup_isac</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ReadISAC</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">WriteISAC</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisacfifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ReadISACfifo</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisacfifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">WriteISACfifo</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Send_Data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdlc_fill_fifo</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">AVM_card_msg</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq_func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">avm_pcipnp_interrupt</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ISAC_MASK</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">ISACVersion</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">==</span> <span class="n">AVM_FRITZ_PCI</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;AVM PCI:&quot;</span> <span class="o">:</span> <span class="s">&quot;AVM PnP:&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifndef __ISAPNP__</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">avm_pnp_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* no-op: success */</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_card</span> <span class="o">*</span><span class="n">pnp_avm_c</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">avm_pnp_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pnp_avm_d</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isapnp_present</span><span class="p">())</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* no-op: success */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pnp_avm_c</span> <span class="o">=</span> <span class="n">pnp_find_card</span><span class="p">(</span>
		     <span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;V&#39;</span><span class="p">,</span> <span class="sc">&#39;M&#39;</span><span class="p">),</span>
		     <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x0900</span><span class="p">),</span> <span class="n">pnp_avm_c</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pnp_avm_d</span> <span class="o">=</span> <span class="n">pnp_find_dev</span><span class="p">(</span><span class="n">pnp_avm_c</span><span class="p">,</span>
					      <span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;V&#39;</span><span class="p">,</span> <span class="sc">&#39;M&#39;</span><span class="p">),</span>
					      <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x0900</span><span class="p">),</span> <span class="n">pnp_avm_d</span><span class="p">)))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

			<span class="n">pnp_disable_dev</span><span class="p">(</span><span class="n">pnp_avm_d</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">pnp_activate_dev</span><span class="p">(</span><span class="n">pnp_avm_d</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: pnp_activate_dev ret(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
				<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">=</span>
				<span class="n">pnp_port_start</span><span class="p">(</span><span class="n">pnp_avm_d</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pnp_irq</span><span class="p">(</span><span class="n">pnp_avm_d</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;FritzPnP:No IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;FritzPnP:No IO address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">=</span> <span class="n">AVM_FRITZ_PNP</span><span class="p">;</span>

			<span class="k">return</span> <span class="p">(</span><span class="mi">2</span><span class="p">);</span>	<span class="cm">/* goto &#39;ready&#39; label */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* __ISAPNP__ */</span><span class="cp"></span>

<span class="cp">#ifndef CONFIG_PCI</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">avm_pci_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* no-op: success */</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev_avm</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">avm_pci_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_avm</span> <span class="o">=</span> <span class="n">hisax_find_pci_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_AVM</span><span class="p">,</span>
					     <span class="n">PCI_DEVICE_ID_AVM_A1</span><span class="p">,</span> <span class="n">dev_avm</span><span class="p">)))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev_avm</span><span class="p">))</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">dev_avm</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;FritzPCI: No IRQ for PCI card found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev_avm</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;FritzPCI: No IO-Adr for PCI card found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">=</span> <span class="n">AVM_FRITZ_PCI</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;FritzPCI: No PCI card found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq_flags</span> <span class="o">|=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">setup_avm_pcipnp</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCard</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">avm_pci_rev</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax: AVM PCI driver Rev. %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HiSax_getrev</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">typ</span> <span class="o">!=</span> <span class="n">ISDN_CTYPE_FRITZPCI</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* old manual method */</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">avm</span><span class="p">.</span><span class="n">cfg_reg</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">subtyp</span> <span class="o">=</span> <span class="n">AVM_FRITZ_PNP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ready</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">avm_pnp_setup</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ready</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">avm_pci_setup</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="nl">ready:</span>
	<span class="k">return</span> <span class="n">avm_setup_rest</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
