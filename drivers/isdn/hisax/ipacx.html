<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hisax › ipacx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ipacx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * IPACX specific routines</span>
<span class="cm"> *</span>
<span class="cm"> * Author       Joerg Petersohn</span>
<span class="cm"> * Derived from hisax_isac.c, isac.c, hscx.c and others</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &quot;hisax_if.h&quot;</span>
<span class="cp">#include &quot;hisax.h&quot;</span>
<span class="cp">#include &quot;isdnl1.h&quot;</span>
<span class="cp">#include &quot;ipacx.h&quot;</span>

<span class="cp">#define DBUSY_TIMER_VALUE 80</span>
<span class="cp">#define TIMER3_VALUE      7000</span>
<span class="cp">#define MAX_DFRAME_LEN_L1 300</span>
<span class="cp">#define B_FIFO_SIZE       64</span>
<span class="cp">#define D_FIFO_SIZE       32</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>ipacx interrupt mask values</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define _MASK_IMASK     0x2E  </span><span class="c1">// global mask</span>
<span class="cp">#define _MASKB_IMASK    0x0B</span>
<span class="cp">#define _MASKD_IMASK    0x03  </span><span class="c1">// all on</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><hr />

<h2>local function declarations</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="n">ph_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">command</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">cic_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dch_l2l1</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dbusy_timer_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dch_empty_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dch_fill_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">dch_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dch_setstack</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dch_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bch_l2l1</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bch_empty_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bch_fill_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bch_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">hscx</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bch_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bch_close_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bch_open_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bch_setstack</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bch_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hscx</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">clear_pending_ints</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><hr />

<h2>Issue Layer 1 command to chip</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">ph_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;ph_command (%#x) in (%#x)&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">ph_state</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><h6>#</h6>

<p>printk(KERN<em>INFO "ph</em>command (%#x)\n", command);</p>

<h6>#</h6></td><td class="code"><div class="highlight"><pre>	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CIX0</span><span class="p">,</span> <span class="p">(</span><span class="n">command</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0E</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><hr />

<h2>Transceiver interrupt handler</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">cic_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">event</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CIR0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span> <span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;cic_int(event=%#x)&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><h6>#</h6>

<p>printk(KERN<em>INFO "cic</em>int(%x)\n", event);</p>

<h6>#</h6></td><td class="code"><div class="highlight"><pre>	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">ph_state</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
	<span class="n">schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_L1STATECHANGE</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>==========================================================</p>

<h1>D channel functions</h1></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><hr />

<h2>Command entry point</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">dch_l2l1</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="p">)</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">cda1_cr</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_HEX</span><span class="p">)</span> <span class="n">LogFrame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_VERBOSE</span><span class="p">)</span> <span class="n">dlogframe</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="cp">#ifdef L2FRAME_DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_LAPD</span><span class="p">)</span> <span class="n">Logl2Frame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="s">&quot;PH_DATA Queued&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef L2FRAME_DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_LAPD</span><span class="p">)</span> <span class="n">Logl2Frame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="s">&quot;PH_DATA&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">dch_fill_fifo</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="p">(</span><span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot; l2l1 tx_skb exist this shouldn&#39;t happen&quot;</span><span class="p">);</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_HEX</span><span class="p">)</span>     <span class="n">LogFrame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_VERBOSE</span><span class="p">)</span> <span class="n">dlogframe</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef L2FRAME_DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_LAPD</span><span class="p">)</span> <span class="n">Logl2Frame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="s">&quot;PH_DATA_PULLED&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">dch_fill_fifo</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="p">(</span><span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
<span class="cp">#ifdef L2FRAME_DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_LAPD</span><span class="p">)</span> <span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;-&gt; PH_REQUEST_PULL&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">FLG_L1_PULL_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">FLG_L1_PULL_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="p">(</span><span class="n">HW_RESET</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">HW_ENABLE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">ph_state</span> <span class="o">==</span> <span class="n">IPACX_IND_RES</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">ph_state</span> <span class="o">==</span> <span class="n">IPACX_IND_DR</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">isac</span><span class="p">.</span><span class="n">ph_state</span> <span class="o">==</span> <span class="n">IPACX_IND_DC</span><span class="p">))</span>
			<span class="n">ph_command</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CMD_TIM</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ph_command</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CMD_RES</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="p">(</span><span class="n">HW_INFO3</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">ph_command</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CMD_AR8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="p">(</span><span class="n">HW_TESTLOOP</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CDA_TSDP10</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span> <span class="c1">// Timeslot 0 is B1</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CDA_TSDP11</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">);</span> <span class="c1">// Timeslot 0 is B1</span>
		<span class="n">cda1_cr</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CDA1_CR</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CDA2_CR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// loop B1</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CDA1_CR</span><span class="p">,</span> <span class="n">cda1_cr</span> <span class="o">|</span> <span class="mh">0x0a</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>  <span class="c1">// B1 off</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CDA1_CR</span><span class="p">,</span> <span class="n">cda1_cr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0a</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// loop B2</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CDA1_CR</span><span class="p">,</span> <span class="n">cda1_cr</span> <span class="o">|</span> <span class="mh">0x14</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>  <span class="c1">// B2 off</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CDA1_CR</span><span class="p">,</span> <span class="n">cda1_cr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x14</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="p">(</span><span class="n">HW_DEACTIVATE</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">)</span>:
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">);</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_DBUSY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span> <span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;dch_l2l1 unknown %04x&quot;</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><h2>----------------------------------------------------------</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">dbusy_timer_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">rbchd</span><span class="p">,</span> <span class="n">stard</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_DBUSY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rbchd</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_RBCHD</span><span class="p">);</span>
		<span class="n">stard</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_STARD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;D-Channel Busy RBCHD %02x STARD %02x&quot;</span><span class="p">,</span> <span class="n">rbchd</span><span class="p">,</span> <span class="n">stard</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">stard</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// D-Channel Busy</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">FLG_L1_DBUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">st</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">stlist</span><span class="p">;</span> <span class="n">st</span><span class="p">;</span> <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_PAUSE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> <span class="c1">// flow control on</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>seems we lost an interrupt; reset transceiver */</p></td><td class="code"><div class="highlight"><pre>			<span class="n">clear_bit</span><span class="p">(</span><span class="n">FLG_DBUSY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HiSax: ISAC D-Channel Busy no skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;D-Channel Busy no skb&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CMDRD</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span> <span class="c1">// Tx reset, generates XPR</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><hr />

<h2>Fill buffer from receive FIFO</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">dch_empty_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC_FIFO</span><span class="p">))</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;dch_empty_fifo()&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>message too large, remove</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvidx</span> <span class="o">+</span> <span class="n">count</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MAX_DFRAME_LEN_L1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;dch_empty_fifo() incoming message too large&quot;</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CMDRD</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span> <span class="c1">// RMC</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span> <span class="o">+</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvidx</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvidx</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisacfifo</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CMDRD</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span> <span class="c1">// RMC</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC_FIFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dlog</span><span class="p">;</span>

		<span class="n">t</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&quot;dch_empty_fifo() cnt %d&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">QuickHex</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dlog</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><hr />

<h2>Fill transmit FIFO</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">dch_fill_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC_FIFO</span><span class="p">))</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;dch_fill_fifo()&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">D_FIFO_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">D_FIFO_SIZE</span><span class="p">;</span>
		<span class="n">cmd</span>   <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span> <span class="c1">// XTF</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span>   <span class="o">=</span> <span class="mh">0x0A</span><span class="p">;</span> <span class="c1">// XTF | XME</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisacfifo</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CMDRD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>set timeout for transmission contol</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_DBUSY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;dch_fill_fifo dbusytimer running&quot;</span><span class="p">);</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">((</span><span class="n">DBUSY_TIMER_VALUE</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC_FIFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dlog</span><span class="p">;</span>

		<span class="n">t</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&quot;dch_fill_fifo() cnt %d&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">QuickHex</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dlog</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><hr />

<h2>D channel interrupt handler</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">dch_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">istad</span><span class="p">,</span> <span class="n">rstad</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">istad</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_ISTAD</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><h6>#</h6>

<p>printk(KERN<em>WARNING "dch</em>int(istad=%02x)\n", istad);</p>

<h6>#</h6></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">istad</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// RME</span>
		<span class="n">rstad</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_RSTAD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rstad</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xa0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// !(VFR &amp;&amp; !RDO &amp;&amp; CRC &amp;&amp; !RAB)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rstad</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
					<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;dch_int(): invalid frame&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rstad</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
					<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;dch_int(): RDO&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rstad</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">))</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
					<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;dch_int(): CRC error&quot;</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CMDRD</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>  <span class="c1">// RMC</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  <span class="c1">// received frame ok</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_RBCLD</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="n">count</span><span class="o">--</span><span class="p">;</span> <span class="c1">// RSTAB is last byte</span>
			<span class="n">count</span> <span class="o">&amp;=</span> <span class="n">D_FIFO_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">count</span> <span class="o">=</span> <span class="n">D_FIFO_SIZE</span><span class="p">;</span>
			<span class="n">dch_empty_fifo</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvidx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">count</span><span class="p">)))</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HiSax dch_int(): receive out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">count</span><span class="p">),</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
					<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_RCVBUFREADY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istad</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// RPF</span>
		<span class="n">dch_empty_fifo</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_FIFO_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istad</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// RFO</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span> <span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;dch_int(): RFO&quot;</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CMDRD</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span> <span class="c1">//RRES</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istad</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// XPR</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_DBUSY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L1_DBUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
			<span class="n">schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_CLEARBUSY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dch_fill_fifo</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">afterXPR</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dch_fill_fifo</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_XMTBUFREADY</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">afterXPR:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istad</span> <span class="o">&amp;</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// XDU or XMR</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span> <span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;dch_int(): XDU&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_push</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">);</span> <span class="c1">// retransmit</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dch_fill_fifo</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HiSax: ISAC XDU no skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;ISAC XDU no skb&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><h2>----------------------------------------------------------</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">dch_setstack</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1hw</span> <span class="o">=</span> <span class="n">dch_l2l1</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><h2>----------------------------------------------------------</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">dch_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HiSax: IPACX ISDN driver v0.1.0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">setstack_d</span>      <span class="o">=</span> <span class="n">dch_setstack</span><span class="p">;</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dbusy_timer_handler</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">cs</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">);</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_TR_CONF0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>  <span class="c1">// clear LDD</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_TR_CONF2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>  <span class="c1">// enable transmitter</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_MODED</span><span class="p">,</span>    <span class="mh">0xC9</span><span class="p">);</span>  <span class="c1">// transparent mode 0, RAC, stop/go</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_MON_CR</span><span class="p">,</span>   <span class="mh">0x00</span><span class="p">);</span>  <span class="c1">// disable monitor channel</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>==========================================================</p>

<h1>B channel functions</h1></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><hr />

<h2>Entry point for commands</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">bch_l2l1</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bcs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bch_fill_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HiSax bch_l2l1(): this shouldn&#39;t happen</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bch_fill_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">FLG_L1_PULL_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">FLG_L1_PULL_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_ACTIVATE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">BC_FLG_ACTIV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="n">bch_mode</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bc</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">l1_msg_b</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">l1_msg_b</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">BC_FLG_ACTIV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="n">bch_mode</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bc</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_DEACTIVATE</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><hr />

<h2>Read B channel fifo to receive buffer</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">bch_empty_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">hscx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="n">hscx</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">hscx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX_FIFO</span><span class="p">))</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;bch_empty_fifo()&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>message too large, remove</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvidx</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">HSCX_BUFMAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;bch_empty_fifo() incoming packet too large&quot;</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_CMDRB</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>  <span class="c1">// RMC</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvbuf</span> <span class="o">+</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvidx</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span><span class="o">--</span><span class="p">)</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Read_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_RFIFOB</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_CMDRB</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>  <span class="c1">// RMC</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvbuf</span> <span class="o">+</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvidx</span><span class="p">;</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvidx</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX_FIFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">blog</span><span class="p">;</span>

		<span class="n">t</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&quot;bch_empty_fifo() B-%d cnt %d&quot;</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">QuickHex</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">blog</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><hr />

<h2>Fill buffer to transmit FIFO</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">bch_fill_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">more</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">hscx</span><span class="p">;</span>

	<span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX_FIFO</span><span class="p">))</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;bch_fill_fifo()&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span>           <span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>  <span class="k">return</span><span class="p">;</span>

	<span class="n">hscx</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">hscx</span><span class="p">;</span>
	<span class="n">more</span> <span class="o">=</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">L1_MODE_TRANS</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">B_FIFO_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">more</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">count</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span><span class="o">--</span><span class="p">)</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_XFIFOB</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_CMDRB</span><span class="p">,</span> <span class="p">(</span><span class="n">more</span> <span class="o">?</span> <span class="mh">0x08</span> <span class="o">:</span> <span class="mh">0x0a</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX_FIFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">blog</span><span class="p">;</span>

		<span class="n">t</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&quot;chb_fill_fifo() B-%d cnt %d&quot;</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">QuickHex</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">blog</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><hr />

<h2>B channel interrupt handler</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">bch_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">hscx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">istab</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">rstab</span><span class="p">;</span>

	<span class="n">bcs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">+</span> <span class="n">hscx</span><span class="p">;</span>
	<span class="n">istab</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Read_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_ISTAB</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><h6>#</h6>

<p>printk(KERN<em>WARNING "bch</em>int(istab=%02x)\n", istab);</p>

<h6>#</h6></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BC_FLG_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istab</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// RME</span>
		<span class="n">rstab</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Read_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_RSTAB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rstab</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xa0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// !(VFR &amp;&amp; !RDO &amp;&amp; CRC &amp;&amp; !RAB)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rstab</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
					<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;bch_int() B-%d: invalid frame&quot;</span><span class="p">,</span> <span class="n">hscx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rstab</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">L1_MODE_NULL</span><span class="p">))</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
					<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;bch_int() B-%d: RDO mode=%d&quot;</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rstab</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">))</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
					<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;bch_int() B-%d: CRC error&quot;</span><span class="p">,</span> <span class="n">hscx</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_CMDRB</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>  <span class="c1">// RMC</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>  <span class="c1">// received frame ok</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Read_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_RBCLB</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">B_FIFO_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">count</span> <span class="o">=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>
			<span class="n">bch_empty_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvidx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX_FIFO</span><span class="p">)</span>
					<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;bch_int Frame %d&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">count</span><span class="p">)))</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HiSax bch_int(): receive frame out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">count</span><span class="p">),</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvbuf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
					<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rqueue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">schedule_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_RCVBUFREADY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istab</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// RPF</span>
		<span class="n">bch_empty_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_FIFO_SIZE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">L1_MODE_TRANS</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// queue every chunk</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>receive transparent audio data</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">B_FIFO_SIZE</span><span class="p">)))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HiSax bch_int(): receive transparent out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">B_FIFO_SIZE</span><span class="p">),</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvbuf</span><span class="p">,</span> <span class="n">B_FIFO_SIZE</span><span class="p">);</span>
				<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rqueue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">schedule_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_RCVBUFREADY</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istab</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// RFO</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;bch_int() B-%d: RFO error&quot;</span><span class="p">,</span> <span class="n">hscx</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_CMDRB</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>  <span class="c1">// RRES</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istab</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// XPR</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bch_fill_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">afterXPR</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_LLI_L1WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">lli</span><span class="p">.</span><span class="n">flag</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">PACKET_NOACK</span> <span class="o">!=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">u_long</span>	<span class="n">flags</span><span class="p">;</span>
					<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aclock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ackcnt</span> <span class="o">+=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aclock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="n">schedule_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_ACKPENDING</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
			<span class="n">bch_fill_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
			<span class="n">schedule_event</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">B_XMTBUFREADY</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">afterXPR:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">istab</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// XDU</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">L1_MODE_TRANS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bch_fill_fifo</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// restart transmitting the whole frame</span>
				<span class="n">skb_push</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
				<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">+=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
				<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_CMDRB</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>  <span class="c1">// XRES</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;bch_int() B-%d XDU error&quot;</span><span class="p">,</span> <span class="n">hscx</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><h2>----------------------------------------------------------</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">bch_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hscx</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">hscx</span><span class="p">;</span>

	<span class="n">bc</span> <span class="o">=</span> <span class="n">bc</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// in case bc is greater than 1</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_HSCX</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;mode_bch() switch B-%d mode %d chan %d&quot;</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">bc</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">bc</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>map controller to according timeslot</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hscx</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_BCHA_TSDP_BC1</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="n">bc</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_BCHA_CR</span><span class="p">,</span>       <span class="mh">0x88</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_BCHB_TSDP_BC1</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="n">bc</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_BCHB_CR</span><span class="p">,</span>       <span class="mh">0x88</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">L1_MODE_NULL</span><span class="p">)</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_MODEB</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">);</span>  <span class="c1">// rec off</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_EXMB</span><span class="p">,</span>  <span class="mh">0x30</span><span class="p">);</span>  <span class="c1">// std adj.</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_MASKB</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>  <span class="c1">// ints off</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_CMDRB</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>  <span class="c1">// validate adjustments</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">L1_MODE_TRANS</span><span class="p">)</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_MODEB</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>  <span class="c1">// ext transp mode</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_EXMB</span><span class="p">,</span>  <span class="mh">0x00</span><span class="p">);</span>  <span class="c1">// xxx00000</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_CMDRB</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>  <span class="c1">// validate adjustments</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_MASKB</span><span class="p">,</span> <span class="n">_MASKB_IMASK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">L1_MODE_HDLC</span><span class="p">)</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_MODEB</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">);</span>  <span class="c1">// transp mode 0</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_EXMB</span><span class="p">,</span>  <span class="mh">0x01</span><span class="p">);</span>  <span class="c1">// idle=hdlc flags crc enabled</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_CMDRB</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>  <span class="c1">// validate adjustments</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">hscx</span><span class="p">,</span> <span class="n">IPACX_MASKB</span><span class="p">,</span> <span class="n">_MASKB_IMASK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><h2>----------------------------------------------------------</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">bch_close_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bch_mode</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BC_FLG_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvbuf</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">blog</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">blog</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rqueue</span><span class="p">);</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><h2>----------------------------------------------------------</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span>
<span class="nf">bch_open_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">BC_FLG_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">HSCX_BUFMAX</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;HiSax open_bchstate(): No memory for hscx.rcvbuf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">BC_FLG_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">blog</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MAX_BLOG_SPACE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;HiSax open_bchstate: No memory for bcs-&gt;blog</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">BC_FLG_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvbuf</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rqueue</span><span class="p">);</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">BC_FLG_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">Flag</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">rcvidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><h2>----------------------------------------------------------</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span>
<span class="nf">bch_setstack</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="k">struct</span> <span class="n">BCState</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bch_open_state</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">,</span> <span class="n">bcs</span><span class="p">))</span> <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">bcs</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2l1</span> <span class="o">=</span> <span class="n">bch_l2l1</span><span class="p">;</span>
	<span class="n">setstack_manager</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="p">;</span>
	<span class="n">setstack_l1_B</span><span class="p">(</span><span class="n">st</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><h2>----------------------------------------------------------</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">bch_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hscx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">hscx</span><span class="p">].</span><span class="n">BC_SetStack</span>   <span class="o">=</span> <span class="n">bch_setstack</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">hscx</span><span class="p">].</span><span class="n">BC_Close</span>      <span class="o">=</span> <span class="n">bch_close_state</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">hscx</span><span class="p">].</span><span class="n">hw</span><span class="p">.</span><span class="n">hscx</span><span class="p">.</span><span class="n">hscx</span>  <span class="o">=</span> <span class="n">hscx</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">hscx</span><span class="p">].</span><span class="n">cs</span>            <span class="o">=</span> <span class="n">cs</span><span class="p">;</span>
	<span class="n">bch_mode</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">+</span> <span class="n">hscx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hscx</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>==========================================================</p>

<h1>Shared functions</h1></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><hr />

<h2>Main interrupt handler</h2></td><td class="code"><div class="highlight"><pre><span class="kt">void</span>
<span class="nf">interrupt_ipacx</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">ista</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">ista</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_ISTA</span><span class="p">)))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><h6>#</h6>

<pre><code>printk(KERN_WARNING "interrupt_ipacx(ista=%02x)\n", ista);
</code></pre>

<h6>#</h6></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">ista</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="n">bch_int</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// B channel interrupts</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ista</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="n">bch_int</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ista</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="n">dch_int</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>    <span class="c1">// D channel</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ista</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="n">cic_int</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>    <span class="c1">// Layer 1 state</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><hr />

<h2>Clears chip interrupt status</h2></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">clear_pending_ints</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ista</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>all interrupts off</p></td><td class="code"><div class="highlight"><pre>	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_MASK</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_MASKD</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPACX_MASKB</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPACX_MASKB</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">ista</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_ISTA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ista</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Read_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPACX_ISTAB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ista</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Read_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPACX_ISTAB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ista</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CIR0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ista</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">readisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_ISTAD</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><hr />

<p>Does chip configuration work</p>

<h2>Work to do depends on bit mask in part</h2></td><td class="code"><div class="highlight"><pre><span class="kt">void</span>
<span class="nf">init_ipacx</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">part</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// initialise chip</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><h6>#</h6>

<p>printk(KERN<em>INFO "init</em>ipacx(%x)\n", part);</p>

<h6>#</h6></td><td class="code"><div class="highlight"><pre>		<span class="n">clear_pending_ints</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">bch_init</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bch_init</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dch_init</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">part</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// reenable all interrupts and start chip</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPACX_MASKB</span><span class="p">,</span> <span class="n">_MASKB_IMASK</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPACX_MASKB</span><span class="p">,</span> <span class="n">_MASKB_IMASK</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_MASKD</span><span class="p">,</span> <span class="n">_MASKD_IMASK</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_MASK</span><span class="p">,</span> <span class="n">_MASK_IMASK</span><span class="p">);</span> <span class="c1">// global mask register</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>reset HDLC Transmitters/receivers</p></td><td class="code"><div class="highlight"><pre>		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">writeisac</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CMDRD</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPACX_CMDRB</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">BC_Write_Reg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPACX_CMDRB</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>
		<span class="n">ph_command</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">IPACX_CMD_RES</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>----------------- end of file -----------------------</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
