<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hisax › tei.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tei.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: tei.c,v 2.20.2.3 2004/01/13 14:31:26 keil Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * Author       Karsten Keil</span>
<span class="cm"> *              based on the teles driver from Jan den Ouden</span>
<span class="cm"> * Copyright    by Karsten Keil      &lt;keil@isdn4linux.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> * For changes and modifications please read</span>
<span class="cm"> * Documentation/isdn/HiSax.cert</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to    Jan den Ouden</span>
<span class="cm"> *              Fritz Elfert</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;hisax.h&quot;</span>
<span class="cp">#include &quot;isdnl2.h&quot;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tei_revision</span> <span class="o">=</span> <span class="s">&quot;$Revision: 2.20.2.3 $&quot;</span><span class="p">;</span>

<span class="cp">#define ID_REQUEST	1</span>
<span class="cp">#define ID_ASSIGNED	2</span>
<span class="cp">#define ID_DENIED	3</span>
<span class="cp">#define ID_CHK_REQ	4</span>
<span class="cp">#define ID_CHK_RES	5</span>
<span class="cp">#define ID_REMOVE	6</span>
<span class="cp">#define ID_VERIFY	7</span>

<span class="cp">#define TEI_ENTITY_ID	0xf</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">Fsm</span> <span class="n">teifsm</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">tei_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">pr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">ST_TEI_NOP</span><span class="p">,</span>
	<span class="n">ST_TEI_IDREQ</span><span class="p">,</span>
	<span class="n">ST_TEI_IDVERIFY</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define TEI_STATE_COUNT (ST_TEI_IDVERIFY + 1)</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">strTeiState</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="s">&quot;ST_TEI_NOP&quot;</span><span class="p">,</span>
	<span class="s">&quot;ST_TEI_IDREQ&quot;</span><span class="p">,</span>
	<span class="s">&quot;ST_TEI_IDVERIFY&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">EV_IDREQ</span><span class="p">,</span>
	<span class="n">EV_ASSIGN</span><span class="p">,</span>
	<span class="n">EV_DENIED</span><span class="p">,</span>
	<span class="n">EV_CHKREQ</span><span class="p">,</span>
	<span class="n">EV_REMOVE</span><span class="p">,</span>
	<span class="n">EV_VERIFY</span><span class="p">,</span>
	<span class="n">EV_T202</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define TEI_EVENT_COUNT (EV_T202 + 1)</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">strTeiEvent</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="s">&quot;EV_IDREQ&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_ASSIGN&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_DENIED&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_CHKREQ&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_REMOVE&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_VERIFY&quot;</span><span class="p">,</span>
	<span class="s">&quot;EV_T202&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">random_ri</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span>
<span class="nf">findtei</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tei</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">stlistp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tei</span> <span class="o">==</span> <span class="mi">127</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">tei</span> <span class="o">==</span> <span class="n">tei</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">put_tei_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">m_id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ri</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">tei</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HiSax: No skb for TEI manager</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">TEI_SAPI</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">GROUP_TEI</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">UI</span><span class="p">;</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEI_ENTITY_ID</span><span class="p">;</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ri</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ri</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_id</span><span class="p">;</span>
	<span class="n">bp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tei</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2l1</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tei_id_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">tei</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span>
					<span class="s">&quot;assign request for already assigned tei %d&quot;</span><span class="p">,</span>
					<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">tei</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">ri</span> <span class="o">=</span> <span class="n">random_ri</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span>
					<span class="s">&quot;assign request ri %d&quot;</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">ri</span><span class="p">);</span>
	<span class="n">put_tei_msg</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">ID_REQUEST</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">ri</span><span class="p">,</span> <span class="mi">127</span><span class="p">);</span>
	<span class="n">FsmChangeState</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span> <span class="n">ST_TEI_IDREQ</span><span class="p">);</span>
	<span class="n">FsmAddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">t202</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">T202</span><span class="p">,</span> <span class="n">EV_T202</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">N202</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tei_id_assign</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">ost</span><span class="p">,</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ri</span><span class="p">,</span> <span class="n">tei</span><span class="p">;</span>

	<span class="n">ri</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">tei</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span>
					<span class="s">&quot;identity assign ri %d tei %d&quot;</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">tei</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ost</span> <span class="o">=</span> <span class="n">findtei</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">tei</span><span class="p">)))</span> <span class="p">{</span>	<span class="cm">/* same tei is in use */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ri</span> <span class="o">!=</span> <span class="n">ost</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">ri</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span>
						<span class="s">&quot;possible duplicate assignment tei %d&quot;</span><span class="p">,</span> <span class="n">tei</span><span class="p">);</span>
			<span class="n">ost</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2tei</span><span class="p">(</span><span class="n">ost</span><span class="p">,</span> <span class="n">MDL_ERROR</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ri</span> <span class="o">==</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">ri</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FsmDelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">t202</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">FsmChangeState</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span> <span class="n">ST_TEI_NOP</span><span class="p">);</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">MDL_ASSIGN</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">tei</span><span class="p">);</span>
		<span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="p">)</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MDL_ASSIGN</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tei_id_test_dup</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">ost</span><span class="p">,</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tei</span><span class="p">,</span> <span class="n">ri</span><span class="p">;</span>

	<span class="n">ri</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">tei</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span>
					<span class="s">&quot;foreign identity assign ri %d tei %d&quot;</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">tei</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ost</span> <span class="o">=</span> <span class="n">findtei</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">tei</span><span class="p">)))</span> <span class="p">{</span>	<span class="cm">/* same tei is in use */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ri</span> <span class="o">!=</span> <span class="n">ost</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">ri</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* and it wasn&#39;t our request */</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span>
						<span class="s">&quot;possible duplicate assignment tei %d&quot;</span><span class="p">,</span> <span class="n">tei</span><span class="p">);</span>
			<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ost</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span> <span class="n">EV_VERIFY</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tei_id_denied</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ri</span><span class="p">,</span> <span class="n">tei</span><span class="p">;</span>

	<span class="n">ri</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">tei</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span>
					<span class="s">&quot;identity denied ri %d tei %d&quot;</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">tei</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tei_id_chk_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tei</span><span class="p">;</span>

	<span class="n">tei</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span>
					<span class="s">&quot;identity check req tei %d&quot;</span><span class="p">,</span> <span class="n">tei</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">tei</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">tei</span> <span class="o">==</span> <span class="n">GROUP_TEI</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tei</span> <span class="o">==</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">tei</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">FsmDelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">t202</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">FsmChangeState</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span> <span class="n">ST_TEI_NOP</span><span class="p">);</span>
		<span class="n">put_tei_msg</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">ID_CHK_RES</span><span class="p">,</span> <span class="n">random_ri</span><span class="p">(),</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">tei</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tei_id_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tei</span><span class="p">;</span>

	<span class="n">tei</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span>
					<span class="s">&quot;identity remove tei %d&quot;</span><span class="p">,</span> <span class="n">tei</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">tei</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">tei</span> <span class="o">==</span> <span class="n">GROUP_TEI</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tei</span> <span class="o">==</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">tei</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">FsmDelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">t202</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">FsmChangeState</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span> <span class="n">ST_TEI_NOP</span><span class="p">);</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">MDL_REMOVE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="p">)</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MDL_REMOVE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tei_id_verify</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span>
					<span class="s">&quot;id verify request for tei %d&quot;</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">tei</span><span class="p">);</span>
	<span class="n">put_tei_msg</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">ID_VERIFY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">tei</span><span class="p">);</span>
	<span class="n">FsmChangeState</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span> <span class="n">ST_TEI_IDVERIFY</span><span class="p">);</span>
	<span class="n">FsmAddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">t202</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">T202</span><span class="p">,</span> <span class="n">EV_T202</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">N202</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tei_id_req_tout</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">N202</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">ri</span> <span class="o">=</span> <span class="n">random_ri</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span>
						<span class="s">&quot;assign req(%d) ri %d&quot;</span><span class="p">,</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">N202</span><span class="p">,</span>
						<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">ri</span><span class="p">);</span>
		<span class="n">put_tei_msg</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">ID_REQUEST</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">ri</span><span class="p">,</span> <span class="mi">127</span><span class="p">);</span>
		<span class="n">FsmAddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">t202</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">T202</span><span class="p">,</span> <span class="n">EV_T202</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span> <span class="s">&quot;assign req failed&quot;</span><span class="p">);</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">MDL_ERROR</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="p">)</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MDL_REMOVE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_TEI_NOP</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tei_id_ver_tout</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">N202</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span>
						<span class="s">&quot;id verify req(%d) for tei %d&quot;</span><span class="p">,</span>
						<span class="mi">3</span> <span class="o">-</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">N202</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">tei</span><span class="p">);</span>
		<span class="n">put_tei_msg</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">ID_VERIFY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">tei</span><span class="p">);</span>
		<span class="n">FsmAddTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">t202</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">T202</span><span class="p">,</span> <span class="n">EV_T202</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span>
					<span class="s">&quot;verify req for tei %d failed&quot;</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">tei</span><span class="p">);</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">MDL_REMOVE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="p">)</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MDL_REMOVE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">FsmChangeState</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">ST_TEI_NOP</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tei_l1l2</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_FIXED_TEI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">==</span> <span class="p">(</span><span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span>
						<span class="s">&quot;short mgr frame %ld/3&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="p">((</span><span class="n">TEI_SAPI</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">))</span> <span class="o">||</span>
			   <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="p">((</span><span class="n">GROUP_TEI</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span>
						<span class="s">&quot;wrong mgr sapi/tei %x/%x&quot;</span><span class="p">,</span>
						<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xef</span><span class="p">)</span> <span class="o">!=</span> <span class="n">UI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span>
						<span class="s">&quot;mgr frame is not ui %x&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span>
							<span class="s">&quot;short mgr frame %ld/5&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TEI_ENTITY_ID</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* wrong management entity identifier, ignore */</span>
				<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span>
							<span class="s">&quot;tei handler wrong entity id %x&quot;</span><span class="p">,</span>
							<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">mt</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mt</span> <span class="o">==</span> <span class="n">ID_ASSIGNED</span><span class="p">)</span>
					<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span> <span class="n">EV_ASSIGN</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mt</span> <span class="o">==</span> <span class="n">ID_DENIED</span><span class="p">)</span>
					<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span> <span class="n">EV_DENIED</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mt</span> <span class="o">==</span> <span class="n">ID_CHK_REQ</span><span class="p">)</span>
					<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span> <span class="n">EV_CHKREQ</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mt</span> <span class="o">==</span> <span class="n">ID_REMOVE</span><span class="p">)</span>
					<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span> <span class="n">EV_REMOVE</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span>
								<span class="s">&quot;tei handler wrong mt %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mt</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span>
					<span class="s">&quot;tei handler wrong pr %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tei_l2tei</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_FIXED_TEI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">==</span> <span class="p">(</span><span class="n">MDL_ASSIGN</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">debug</span><span class="p">)</span>
				<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span>
							<span class="s">&quot;fixed assign tei %d&quot;</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">tei</span><span class="p">);</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">l3</span><span class="p">.</span><span class="n">l3l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">MDL_ASSIGN</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">tei</span><span class="p">);</span>
			<span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="p">)</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cardmsg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MDL_ASSIGN</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">MDL_ASSIGN</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span> <span class="n">EV_IDREQ</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">MDL_ERROR</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">FsmEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span> <span class="n">EV_VERIFY</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tei_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">FsmInst</span> <span class="o">*</span><span class="n">fi</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">userdata</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">VHiSax_putstatus</span><span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">,</span> <span class="s">&quot;tei &quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">setstack_tei</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l2</span><span class="p">.</span><span class="n">l2tei</span> <span class="o">=</span> <span class="n">tei_l2tei</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">T202</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">;</span>	<span class="cm">/* T202  2000 milliseconds */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1tei</span> <span class="o">=</span> <span class="n">tei_l1l2</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">fsm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">teifsm</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">ST_TEI_NOP</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">userdata</span> <span class="o">=</span> <span class="n">st</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">userint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">.</span><span class="n">printdebug</span> <span class="o">=</span> <span class="n">tei_debug</span><span class="p">;</span>
	<span class="n">FsmInitTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">tei_m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">t202</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">init_tei</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">release_tei</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">stlist</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FsmDelTimer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">.</span><span class="n">t202</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">FsmNode</span> <span class="n">TeiFnList</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span><span class="n">ST_TEI_NOP</span><span class="p">,</span> <span class="n">EV_IDREQ</span><span class="p">,</span> <span class="n">tei_id_request</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_TEI_NOP</span><span class="p">,</span> <span class="n">EV_ASSIGN</span><span class="p">,</span> <span class="n">tei_id_test_dup</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_TEI_NOP</span><span class="p">,</span> <span class="n">EV_VERIFY</span><span class="p">,</span> <span class="n">tei_id_verify</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_TEI_NOP</span><span class="p">,</span> <span class="n">EV_REMOVE</span><span class="p">,</span> <span class="n">tei_id_remove</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_TEI_NOP</span><span class="p">,</span> <span class="n">EV_CHKREQ</span><span class="p">,</span> <span class="n">tei_id_chk_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_TEI_IDREQ</span><span class="p">,</span> <span class="n">EV_T202</span><span class="p">,</span> <span class="n">tei_id_req_tout</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_TEI_IDREQ</span><span class="p">,</span> <span class="n">EV_ASSIGN</span><span class="p">,</span> <span class="n">tei_id_assign</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_TEI_IDREQ</span><span class="p">,</span> <span class="n">EV_DENIED</span><span class="p">,</span> <span class="n">tei_id_denied</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_TEI_IDVERIFY</span><span class="p">,</span> <span class="n">EV_T202</span><span class="p">,</span> <span class="n">tei_id_ver_tout</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_TEI_IDVERIFY</span><span class="p">,</span> <span class="n">EV_REMOVE</span><span class="p">,</span> <span class="n">tei_id_remove</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ST_TEI_IDVERIFY</span><span class="p">,</span> <span class="n">EV_CHKREQ</span><span class="p">,</span> <span class="n">tei_id_chk_req</span><span class="p">},</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__init</span>
<span class="nf">TeiNew</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">teifsm</span><span class="p">.</span><span class="n">state_count</span> <span class="o">=</span> <span class="n">TEI_STATE_COUNT</span><span class="p">;</span>
	<span class="n">teifsm</span><span class="p">.</span><span class="n">event_count</span> <span class="o">=</span> <span class="n">TEI_EVENT_COUNT</span><span class="p">;</span>
	<span class="n">teifsm</span><span class="p">.</span><span class="n">strEvent</span> <span class="o">=</span> <span class="n">strTeiEvent</span><span class="p">;</span>
	<span class="n">teifsm</span><span class="p">.</span><span class="n">strState</span> <span class="o">=</span> <span class="n">strTeiState</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">FsmNew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">teifsm</span><span class="p">,</span> <span class="n">TeiFnList</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">TeiFnList</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">TeiFree</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FsmFree</span><span class="p">(</span><span class="o">&amp;</span><span class="n">teifsm</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
