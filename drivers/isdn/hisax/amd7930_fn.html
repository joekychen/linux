<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hisax › amd7930_fn.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>amd7930_fn.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* gerdes_amd7930.c,v 0.99 2001/10/02</span>
<span class="cm"> *</span>
<span class="cm"> * gerdes_amd7930.c     Amd 79C30A and 79C32A specific routines</span>
<span class="cm"> *                      (based on HiSax driver by Karsten Keil)</span>
<span class="cm"> *</span>
<span class="cm"> * Author               Christoph Ersfeld &lt;info@formula-n.de&gt;</span>
<span class="cm"> *                      Formula-n Europe AG (www.formula-n.com)</span>
<span class="cm"> *                      previously Gerdes AG</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *                      This file is (c) under GNU PUBLIC LICENSE</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Notes:</span>
<span class="cm"> * Version 0.99 is the first release of this driver and there are</span>
<span class="cm"> * certainly a few bugs.</span>
<span class="cm"> *</span>
<span class="cm"> * Please don&#39;t report any malfunction to me without sending</span>
<span class="cm"> * (compressed) debug-logs.</span>
<span class="cm"> * It would be nearly impossible to retrace it.</span>
<span class="cm"> *</span>
<span class="cm"> * Log D-channel-processing as follows:</span>
<span class="cm"> *</span>
<span class="cm"> * 1. Load hisax with card-specific parameters, this example ist for</span>
<span class="cm"> *    Formula-n enter:now ISDN PCI and compatible</span>
<span class="cm"> *    (f.e. Gerdes Power ISDN PCI)</span>
<span class="cm"> *</span>
<span class="cm"> *    modprobe hisax type=41 protocol=2 id=gerdes</span>
<span class="cm"> *</span>
<span class="cm"> *    if you chose an other value for id, you need to modify the</span>
<span class="cm"> *    code below, too.</span>
<span class="cm"> *</span>
<span class="cm"> * 2. set debug-level</span>
<span class="cm"> *</span>
<span class="cm"> *    hisaxctrl gerdes 1 0x3ff</span>
<span class="cm"> *    hisaxctrl gerdes 11 0x4f</span>
<span class="cm"> *    cat /dev/isdnctrl &gt;&gt; ~/log &amp;</span>
<span class="cm"> *</span>
<span class="cm"> * Please take also a look into /var/log/messages if there is</span>
<span class="cm"> * anything importand concerning HISAX.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Credits:</span>
<span class="cm"> * Programming the driver for Formula-n enter:now ISDN PCI and</span>
<span class="cm"> * necessary this driver for the used Amd 7930 D-channel-controller</span>
<span class="cm"> * was spnsored by Formula-n Europe AG.</span>
<span class="cm"> * Thanks to Karsten Keil and Petr Novak, who gave me support in</span>
<span class="cm"> * Hisax-specific questions.</span>
<span class="cm"> * I want so say special thanks to Carl-Friedrich Braun, who had to</span>
<span class="cm"> * answer a lot of questions about generally ISDN and about handling</span>
<span class="cm"> * of the Amd-Chip.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>


<span class="cp">#include &quot;hisax.h&quot;</span>
<span class="cp">#include &quot;isdnl1.h&quot;</span>
<span class="cp">#include &quot;isac.h&quot;</span>
<span class="cp">#include &quot;amd7930_fn.h&quot;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">Amd7930_new_ph</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">);</span>

<span class="k">static</span> <span class="n">WORD</span> <span class="n">initAMD</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x0100</span><span class="p">,</span>

	<span class="mh">0x00A5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span>				<span class="c1">// LPR, LMR1, LMR2</span>
	<span class="mh">0x0086</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span>					<span class="c1">// DMR1 (D-Buffer TH-Interrupts on)</span>
	<span class="mh">0x0087</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>					<span class="c1">// DMR2</span>
	<span class="mh">0x0092</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span>					<span class="c1">// EFCR (extended mode d-channel-fifo on)</span>
	<span class="mh">0x0090</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span>			<span class="c1">// FRAR4, SRAR4, DMR3, DMR4 (address recognition )</span>
	<span class="mh">0x0084</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>					<span class="c1">// DRLR</span>
	<span class="mh">0x00C0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span>					<span class="c1">// PPCR1</span>
	<span class="mh">0x00C8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>					<span class="c1">// PPCR2</span>

	<span class="mh">0x0102</span><span class="p">,</span>
	<span class="mh">0x0107</span><span class="p">,</span>
	<span class="mh">0x01A1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
	<span class="mh">0x0121</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
	<span class="mh">0x0189</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>

	<span class="mh">0x0045</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>			<span class="c1">// MCR1, MCR2, MCR3, MCR4</span>
	<span class="mh">0x0063</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span>					<span class="c1">// GX</span>
	<span class="mh">0x0064</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span>					<span class="c1">// GR</span>
	<span class="mh">0x0065</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>					<span class="c1">// GER</span>
	<span class="mh">0x0066</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x7C</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span>					<span class="c1">// STG</span>
	<span class="mh">0x0067</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>					<span class="c1">// FTGR1, FTGR2</span>
	<span class="mh">0x0068</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>					<span class="c1">// ATGR1, ATGR2</span>
	<span class="mh">0x0069</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x4F</span><span class="p">,</span>					<span class="c1">// MMR1</span>
	<span class="mh">0x006A</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>					<span class="c1">// MMR2</span>
	<span class="mh">0x006C</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>					<span class="c1">// MMR3</span>
	<span class="mh">0x0021</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>					<span class="c1">// INIT</span>
	<span class="mh">0x00A3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>					<span class="c1">// LMR1</span>

	<span class="mh">0xFFFF</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="cm">/* macro wWordAMD */</span>
<span class="n">WriteWordAmd7930</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">BYTE</span> <span class="n">reg</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">wByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">LOBYTE</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
	<span class="n">wByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">HIBYTE</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">WORD</span> <span class="cm">/* macro rWordAMD */</span>
<span class="n">ReadWordAmd7930</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">BYTE</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WORD</span> <span class="n">res</span><span class="p">;</span>
	<span class="cm">/* direct access register */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">rByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">+=</span> <span class="mi">256</span> <span class="o">*</span> <span class="n">rByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* indirect access register */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">wByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">rByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">+=</span> <span class="mi">256</span> <span class="o">*</span> <span class="n">rByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">res</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="n">Amd7930_ph_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">command</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;AMD7930: %s: ph_command 0x%02X&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">lmr1</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">wByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
<span class="p">}</span>



<span class="k">static</span> <span class="n">BYTE</span> <span class="n">i430States</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>to   reset  F3    F4    F5    F6    F7    F8    AR     from</p></td><td class="code"><div class="highlight"><pre>	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>   <span class="c1">// init</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>   <span class="c1">// reset</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>   <span class="c1">// F3</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>   <span class="c1">// F4</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>   <span class="c1">// F5</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>   <span class="c1">// F6</span>
	<span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>   <span class="c1">// F7</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>   <span class="c1">// F8</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">};</span>  <span class="c1">// AR</span>


<span class="cm">/*                    Row     init    -   reset  F3    F4    F5    F6    F7    F8    AR */</span>
<span class="k">static</span> <span class="n">BYTE</span> <span class="n">stateHelper</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">};</span>




<span class="k">static</span> <span class="kt">void</span>
<span class="nf">Amd7930_get_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">BYTE</span> <span class="n">lsr</span> <span class="o">=</span> <span class="n">rByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">ph_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">Amd7930_new_ph</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">void</span>
<span class="nf">Amd7930_new_ph</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">index</span> <span class="o">=</span> <span class="n">stateHelper</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">old_state</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">stateHelper</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">ph_state</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">message</span> <span class="o">=</span> <span class="n">i430States</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;AMD7930: new_ph %d, old_ph %d, message %d, index %d&quot;</span><span class="p">,</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">ph_state</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">old_state</span><span class="p">,</span> <span class="n">message</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">old_state</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">ph_state</span><span class="p">;</span>

	<span class="cm">/* abort transmit if nessesary */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">message</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">);</span>
		<span class="n">wByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">message</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>:
		<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_RESET</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">Amd7930_get_state</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>: <span class="cm">/* init, Card starts in F3 */</span>
		<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_DEACTIVATE</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>:
		<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_DEACTIVATE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>:
		<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_POWERUP</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">Amd7930_ph_command</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="s">&quot;HW_ENABLE REQUEST&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span>:
		<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_RSYNC</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span>:
		<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_INFO4_P8</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="mi">7</span><span class="p">)</span>: <span class="cm">/* init, Card starts in F7 */</span>
		<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_RSYNC</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_INFO4_P8</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="mi">8</span><span class="p">)</span>:
		<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_POWERUP</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="p">(</span><span class="mi">9</span><span class="p">)</span>:
		<span class="n">Amd7930_ph_command</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="s">&quot;HW_ENABLE REQ cleared if set&quot;</span><span class="p">);</span>
		<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_RSYNC</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_INFO2</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_INFO4_P8</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>:
		<span class="n">Amd7930_ph_command</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="s">&quot;T3 expired, HW_ENABLE REQ cleared&quot;</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">old_state</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="mi">11</span><span class="p">)</span>:
		<span class="n">l1_msg</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">HW_INFO2</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">void</span>
<span class="nf">Amd7930_bh</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">IsdnCardState</span><span class="p">,</span> <span class="n">tqueue</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">stptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">D_CLEARBUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: bh, D-Channel Busy cleared&quot;</span><span class="p">);</span>
		<span class="n">stptr</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">stlist</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">stptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stptr</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">stptr</span><span class="p">,</span> <span class="n">PH_PAUSE</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">stptr</span> <span class="o">=</span> <span class="n">stptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">D_L1STATECHANGE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;AMD7930: bh, D_L1STATECHANGE&quot;</span><span class="p">);</span>
		<span class="n">Amd7930_new_ph</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">D_RCVBUFREADY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;AMD7930: bh, D_RCVBUFREADY&quot;</span><span class="p">);</span>
		<span class="n">DChannel_proc_rcv</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">D_XMTBUFREADY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;AMD7930: bh, D_XMTBUFREADY&quot;</span><span class="p">);</span>
		<span class="n">DChannel_proc_xmt</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">Amd7930_empty_Dfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">BYTE</span> <span class="n">stat</span><span class="p">,</span> <span class="n">der</span><span class="p">;</span>
	<span class="n">BYTE</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC_FIFO</span><span class="p">))</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: empty_Dfifo&quot;</span><span class="p">);</span>


	<span class="n">ptr</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span> <span class="o">+</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvidx</span><span class="p">;</span>

	<span class="cm">/* AMD interrupts off */</span>
	<span class="n">AmdIrqOff</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>

	<span class="cm">/* read D-Channel-Fifo*/</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">rByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span> <span class="c1">// DSR2</span>

	<span class="cm">/* while Data in Fifo ... */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">ptr</span><span class="o">-</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MAX_DFRAME_LEN_L1</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">rByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span> <span class="c1">// DCRB</span>
		<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">rByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span> <span class="c1">// DSR2</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvidx</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">-</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">;</span>

		<span class="cm">/* Paket ready? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">der</span> <span class="o">=</span> <span class="n">rWordAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>

			<span class="cm">/* no errors, packet ok */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">der</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rWordAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">);</span> <span class="c1">// clear DRCR</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvidx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvidx</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HiSax: Amd7930: empty_Dfifo, D receive out of memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">else</span> <span class="p">{</span>
						<span class="cm">/* Debugging */</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC_FIFO</span><span class="p">)</span> <span class="p">{</span>
							<span class="kt">char</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dlog</span><span class="p">;</span>

							<span class="n">t</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&quot;Amd7930: empty_Dfifo cnt: %d |&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvidx</span><span class="p">);</span>
							<span class="n">QuickHex</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvidx</span><span class="p">);</span>
							<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dlog</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="cm">/* moves received data in sk-buffer */</span>
						<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvidx</span><span class="p">),</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvidx</span><span class="p">);</span>
						<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>

			<span class="p">}</span>
			<span class="cm">/* throw damaged packets away, reset receive-buffer, indicate RX */</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_RCVBUFREADY</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Packet to long, overflow */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvidx</span> <span class="o">&gt;=</span> <span class="n">MAX_DFRAME_LEN_L1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;AMD7930: empty_Dfifo L2-Framelength overrun&quot;</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">rcvidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* AMD interrupts on */</span>
	<span class="n">AmdIrqOn</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">Amd7930_fill_Dfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">WORD</span> <span class="n">dtcrr</span><span class="p">,</span> <span class="n">dtcrw</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">BYTE</span> <span class="n">txstat</span><span class="p">,</span> <span class="n">dmr3</span><span class="p">;</span>
	<span class="n">BYTE</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">deb_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC_FIFO</span><span class="p">))</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: fill_Dfifo&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dtcrw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">tx_xmtlen</span><span class="p">)</span>
		<span class="cm">/* new Frame */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">dtcrw</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="cm">/* continue frame */</span>
	<span class="k">else</span> <span class="n">len</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">tx_xmtlen</span><span class="p">;</span>


	<span class="cm">/* AMD interrupts off */</span>
	<span class="n">AmdIrqOff</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>

	<span class="n">deb_ptr</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* while free place in tx-fifo available and data in sk-buffer */</span>
	<span class="n">txstat</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">txstat</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
		<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">txstat</span> <span class="o">=</span> <span class="n">rByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">-</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>


	<span class="n">dtcrr</span> <span class="o">=</span> <span class="n">rWordAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">);</span> <span class="c1">// DTCR</span>
	<span class="n">dmr3</span>  <span class="o">=</span> <span class="n">rByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x8E</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: fill_Dfifo, DMR3: 0x%02X, DTCR read: 0x%04X write: 0x%02X 0x%02X&quot;</span><span class="p">,</span> <span class="n">dmr3</span><span class="p">,</span> <span class="n">dtcrr</span><span class="p">,</span> <span class="n">LOBYTE</span><span class="p">(</span><span class="n">dtcrw</span><span class="p">),</span> <span class="n">HIBYTE</span><span class="p">(</span><span class="n">dtcrw</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* writeing of dtcrw starts transmit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">tx_xmtlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wWordAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="n">dtcrw</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">tx_xmtlen</span> <span class="o">=</span> <span class="n">dtcrw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_DBUSY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: fill_Dfifo dbusytimer running&quot;</span><span class="p">);</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">((</span><span class="n">DBUSY_TIMER_VALUE</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC_FIFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dlog</span><span class="p">;</span>

		<span class="n">t</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&quot;Amd7930: fill_Dfifo cnt: %d |&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">QuickHex</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">deb_ptr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dlog</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* AMD interrupts on */</span>
	<span class="n">AmdIrqOn</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">Amd7930_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">BYTE</span> <span class="n">irflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BYTE</span> <span class="n">dsr1</span><span class="p">,</span> <span class="n">dsr2</span><span class="p">,</span> <span class="n">lsr</span><span class="p">;</span>
	<span class="n">WORD</span> <span class="n">der</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">irflags</span><span class="p">)</span>
	<span class="p">{</span>

		<span class="n">dsr1</span> <span class="o">=</span> <span class="n">rByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">der</span>  <span class="o">=</span> <span class="n">rWordAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="n">dsr2</span> <span class="o">=</span> <span class="n">rByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
		<span class="n">lsr</span>  <span class="o">=</span> <span class="n">rByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: interrupt: flags: 0x%02X, DSR1: 0x%02X, DSR2: 0x%02X, LSR: 0x%02X, DER=0x%04X&quot;</span><span class="p">,</span> <span class="n">irflags</span><span class="p">,</span> <span class="n">dsr1</span><span class="p">,</span> <span class="n">dsr2</span><span class="p">,</span> <span class="n">lsr</span><span class="p">,</span> <span class="n">der</span><span class="p">);</span>

		<span class="cm">/* D error -&gt; read DER and DSR2 bit 2 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">der</span> <span class="o">||</span> <span class="p">(</span><span class="n">dsr2</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: interrupt: D error DER=0x%04X&quot;</span><span class="p">,</span> <span class="n">der</span><span class="p">);</span>

			<span class="cm">/* RX, TX abort if collision detected */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">der</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">wByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">);</span>
				<span class="n">wByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_DBUSY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
					<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L1_DBUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
					<span class="n">schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_CLEARBUSY</span><span class="p">);</span>
				<span class="cm">/* restart frame */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">skb_push</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">);</span>
					<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">tx_xmtlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">Amd7930_fill_Dfifo</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HiSax: Amd7930 D-Collision, no skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: interrupt: D-Collision, no skb&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/* remove damaged data from fifo */</span>
			<span class="n">Amd7930_empty_Dfifo</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_DBUSY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
				<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L1_DBUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
				<span class="n">schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_CLEARBUSY</span><span class="p">);</span>
			<span class="cm">/* restart TX-Frame */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb_push</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">);</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">tx_xmtlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">Amd7930_fill_Dfifo</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* D TX FIFO empty -&gt; fill */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irflags</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: interrupt: clear Timer and fill D-TX-FIFO if data&quot;</span><span class="p">);</span>

			<span class="cm">/* AMD interrupts off */</span>
			<span class="n">AmdIrqOff</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_DBUSY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
				<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L1_DBUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
				<span class="n">schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_CLEARBUSY</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
					<span class="n">Amd7930_fill_Dfifo</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* AMD interrupts on */</span>
			<span class="n">AmdIrqOn</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="p">}</span>


		<span class="cm">/* D RX FIFO full or tiny packet in Fifo -&gt; empty */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">irflags</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">dsr1</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: interrupt: empty D-FIFO&quot;</span><span class="p">);</span>
			<span class="n">Amd7930_empty_Dfifo</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>


		<span class="cm">/* D-Frame transmit complete */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsr1</span> <span class="o">&amp;</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: interrupt: transmit packet ready&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* AMD interrupts off */</span>
			<span class="n">AmdIrqOff</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_DBUSY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
				<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L1_DBUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
				<span class="n">schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_CLEARBUSY</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
					<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: interrupt: TX-Packet ready, freeing skb&quot;</span><span class="p">);</span>
				<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">tx_xmtlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
					<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: interrupt: TX-Packet ready, next packet dequeued&quot;</span><span class="p">);</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">tx_xmtlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">Amd7930_fill_Dfifo</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_XMTBUFREADY</span><span class="p">);</span>
			<span class="cm">/* AMD interrupts on */</span>
			<span class="n">AmdIrqOn</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* LIU status interrupt -&gt; read LSR, check statechanges */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* AMD interrupts off */</span>
			<span class="n">AmdIrqOff</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd: interrupt: LSR=0x%02X, LIU is in state %d&quot;</span><span class="p">,</span> <span class="n">lsr</span><span class="p">,</span> <span class="p">((</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>

			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">ph_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

			<span class="n">schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_L1STATECHANGE</span><span class="p">);</span>
			<span class="cm">/* AMD interrupts on */</span>
			<span class="n">AmdIrqOn</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* reads Interrupt-Register again. If there is a new interrupt-flag: restart handler */</span>
		<span class="n">irflags</span> <span class="o">=</span> <span class="n">rByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">Amd7930_l1hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="p">)</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">hardware</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: l1hw called, pr: 0x%04X&quot;</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DATA</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_HEX</span><span class="p">)</span>
			<span class="n">LogFrame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_VERBOSE</span><span class="p">)</span>
			<span class="n">dlogframe</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="cp">#ifdef L2FRAME_DEBUG		</span><span class="cm">/* psa */</span><span class="cp"></span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_LAPD</span><span class="p">)</span>
				<span class="n">Logl2Frame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="s">&quot;Amd7930: l1hw: PH_DATA Queued&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">tx_xmtlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef L2FRAME_DEBUG		</span><span class="cm">/* psa */</span><span class="cp"></span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_LAPD</span><span class="p">)</span>
				<span class="n">Logl2Frame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="s">&quot;Amd7930: l1hw: PH_DATA&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">Amd7930_fill_Dfifo</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: l1hw: l2l1 tx_skb exist this shouldn&#39;t happen&quot;</span><span class="p">);</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_HEX</span><span class="p">)</span>
			<span class="n">LogFrame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEB_DLOG_VERBOSE</span><span class="p">)</span>
			<span class="n">dlogframe</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">tx_xmtlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef L2FRAME_DEBUG		</span><span class="cm">/* psa */</span><span class="cp"></span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_LAPD</span><span class="p">)</span>
			<span class="n">Logl2Frame</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="s">&quot;Amd7930: l1hw: PH_DATA_PULLED&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">Amd7930_fill_Dfifo</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
<span class="cp">#ifdef L2FRAME_DEBUG		</span><span class="cm">/* psa */</span><span class="cp"></span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_LAPD</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: l1hw: -&gt; PH_REQUEST_PULL, skb: %s&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L1_PULL_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">PH_PULL</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_L1_PULL_REQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">HW_RESET</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">ph_state</span> <span class="o">==</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* b-channels off, PH-AR cleared</span>
<span class="cm">			 * change to F3 */</span>
			<span class="n">Amd7930_ph_command</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="s">&quot;HW_RESET REQEST&quot;</span><span class="p">);</span> <span class="c1">//LMR1 bit 5</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">Amd7930_ph_command</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="s">&quot;HW_RESET REQUEST&quot;</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">ph_state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">Amd7930_new_ph</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">HW_ENABLE</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">ph_state</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">Amd7930_new_ph</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">HW_INFO3</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:</pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>automatic</p></td><td class="code"><div class="highlight"><pre>		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">HW_TESTLOOP</span> <span class="o">|</span> <span class="n">REQUEST</span><span class="p">)</span>:
		<span class="cm">/* not implemented yet */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">HW_DEACTIVATE</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">)</span>:
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">);</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">sq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_DBUSY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L1_DBUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span>
			<span class="n">schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">D_CLEARBUSY</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_WARN</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: l1hw: unknown %04x&quot;</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">setstack_Amd7930</span><span class="p">(</span><span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">st</span><span class="p">,</span> <span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: setstack called&quot;</span><span class="p">);</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1hw</span> <span class="o">=</span> <span class="n">Amd7930_l1hw</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">DC_Close_Amd7930</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: DC_Close called&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dbusy_timer_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">PStack</span> <span class="o">*</span><span class="n">stptr</span><span class="p">;</span>
	<span class="n">WORD</span> <span class="n">dtcr</span><span class="p">,</span> <span class="n">der</span><span class="p">;</span>
	<span class="n">BYTE</span> <span class="n">dsr1</span><span class="p">,</span> <span class="n">dsr2</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: dbusy_timer expired!&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_DBUSY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* D Transmit Byte Count Register:</span>
<span class="cm">		 * Counts down packet&#39;s number of Bytes, 0 if packet ready */</span>
		<span class="n">dtcr</span> <span class="o">=</span> <span class="n">rWordAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">);</span>
		<span class="n">dsr1</span> <span class="o">=</span> <span class="n">rByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">dsr2</span> <span class="o">=</span> <span class="n">rByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
		<span class="n">der</span>  <span class="o">=</span> <span class="n">rWordAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
			<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: dbusy_timer_handler: DSR1=0x%02X, DSR2=0x%02X, DER=0x%04X, cs-&gt;tx_skb-&gt;len=%u, tx_stat=%u, dtcr=%u, cs-&gt;tx_cnt=%u&quot;</span><span class="p">,</span> <span class="n">dsr1</span><span class="p">,</span> <span class="n">dsr2</span><span class="p">,</span> <span class="n">der</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">tx_xmtlen</span><span class="p">,</span> <span class="n">dtcr</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">tx_xmtlen</span> <span class="o">-</span> <span class="n">dtcr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* D-Channel Busy */</span>
			<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_L1_DBUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
			<span class="n">stptr</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">stlist</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">stptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stptr</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">.</span><span class="n">l1l2</span><span class="p">(</span><span class="n">stptr</span><span class="p">,</span> <span class="n">PH_PAUSE</span> <span class="o">|</span> <span class="n">INDICATION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="n">stptr</span> <span class="o">=</span> <span class="n">stptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* discard frame; reset transceiver */</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_DBUSY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">HW_Flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">tx_xmtlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HiSax: Amd7930: D-Channel Busy no skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: D-Channel Busy no skb&quot;</span><span class="p">);</span>

			<span class="p">}</span>
			<span class="cm">/* Transmitter reset, abort transmit */</span>
			<span class="n">wByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">);</span>
			<span class="n">wByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq_func</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">cs</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
				<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: dbusy_timer_handler: Transmitter reset&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="kt">void</span> <span class="nf">Amd7930_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WORD</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">BYTE</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">L1_DEB_ISAC</span><span class="p">)</span>
		<span class="n">debugl1</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="s">&quot;Amd7930: initamd called&quot;</span><span class="p">);</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">tx_xmtlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">old_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">lmr1</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dc</span><span class="p">.</span><span class="n">amd7930</span><span class="p">.</span><span class="n">ph_command</span> <span class="o">=</span> <span class="n">Amd7930_ph_command</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">setstack_d</span> <span class="o">=</span> <span class="n">setstack_Amd7930</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">DC_Close</span> <span class="o">=</span> <span class="n">DC_Close_Amd7930</span><span class="p">;</span>

	<span class="cm">/* AMD Initialisation */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">initAMD</span><span class="p">;</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">!=</span> <span class="mh">0xFFFF</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">LOBYTE</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">);</span>

		<span class="cm">/* read */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="mh">0x100</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
				<span class="cm">/* reset register */</span>
				<span class="n">rByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">wByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span>
					<span class="n">rByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* write */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">wByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">LOBYTE</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">));</span>

		<span class="k">else</span> <span class="p">{</span>
			<span class="n">wByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span>
				<span class="n">wByteAMD</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">LOBYTE</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">setup_Amd7930</span><span class="p">(</span><span class="k">struct</span> <span class="n">IsdnCardState</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tqueue</span><span class="p">,</span> <span class="n">Amd7930_bh</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dbusy_timer_handler</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">cs</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dbusytimer</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
