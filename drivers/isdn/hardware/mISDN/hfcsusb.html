<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hardware › mISDN › hfcsusb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>hfcsusb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* hfcsusb.c</span>
<span class="cm"> * mISDN driver for Colognechip HFC-S USB chip</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2001 by Peter Sprenger (sprenger@moving-bytes.de)</span>
<span class="cm"> * Copyright 2008 by Martin Bachem (info@bachem-it.com)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * module params</span>
<span class="cm"> *   debug=&lt;n&gt;, default=0, with n=0xHHHHGGGG</span>
<span class="cm"> *      H - l1 driver flags described in hfcsusb.h</span>
<span class="cm"> *      G - common mISDN debug flags described at mISDNhw.h</span>
<span class="cm"> *</span>
<span class="cm"> *   poll=&lt;n&gt;, default 128</span>
<span class="cm"> *     n : burst size of PH_DATA_IND at transparent rx data</span>
<span class="cm"> *</span>
<span class="cm"> * Revision: 0.3.3 (socket), 2008-11-05</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/mISDNhw.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;hfcsusb.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">poll</span> <span class="o">=</span> <span class="n">DEFAULT_TRANSP_BURST_SZ</span><span class="p">;</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">HFClist</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">HFClock</span><span class="p">);</span>


<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Martin Bachem&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">poll</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">hfcsusb_cnt</span><span class="p">;</span>

<span class="cm">/* some function prototypes */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hfcsusb_ph_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">command</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">release_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_hfcsusb</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">setPortMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hfcsusb_start_endpoint</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hfcsusb_stop_endpoint</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">hfcsusb_setup_bch</span><span class="p">(</span><span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">deactivate_bchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hfcsusb_ph_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>

<span class="cm">/* start next background transfer for control channel */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ctrl_start_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_CALL_TRACE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_out_pipe</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="o">-&gt;</span><span class="n">setup_packet</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_write</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_write</span><span class="p">.</span><span class="n">wIndex</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_buff</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_out_idx</span><span class="p">].</span><span class="n">hfcs_reg</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_write</span><span class="p">.</span><span class="n">wValue</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_buff</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_out_idx</span><span class="p">].</span><span class="n">reg_val</span><span class="p">);</span>

		<span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * queue a control transfer request to write HFC-S USB</span>
<span class="cm"> * chip register using CTRL resuest queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ctrl_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_CALL_TRACE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s reg(0x%02x) val(0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_cnt</span> <span class="o">&gt;=</span> <span class="n">HFC_CTRL_BUFSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_buff</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_in_idx</span><span class="p">];</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">hfcs_reg</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">reg_val</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_in_idx</span> <span class="o">&gt;=</span> <span class="n">HFC_CTRL_BUFSIZE</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_in_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ctrl_start_transfer</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* control completion routine handling background control cmds */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ctrl_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_CALL_TRACE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_cnt</span><span class="o">--</span><span class="p">;</span>	<span class="cm">/* decrement actual count */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_out_idx</span> <span class="o">&gt;=</span> <span class="n">HFC_CTRL_BUFSIZE</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_out_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* pointer wrap */</span>

		<span class="n">ctrl_start_transfer</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span> <span class="cm">/* start next transfer */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* handle LED bits   */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">set_led_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">signed</span> <span class="kt">short</span> <span class="n">led_bits</span><span class="p">,</span> <span class="kt">int</span> <span class="n">set_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">led_bits</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">led_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">abs</span><span class="p">(</span><span class="n">led_bits</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">led_state</span> <span class="o">|=</span> <span class="n">led_bits</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">led_bits</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">led_state</span> <span class="o">|=</span> <span class="n">abs</span><span class="p">(</span><span class="n">led_bits</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">led_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">led_bits</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* handle LED requests  */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">handle_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfcsusb_vdata</span> <span class="o">*</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb_vdata</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">hfcsusb_idtab</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vend_idx</span><span class="p">].</span><span class="n">driver_info</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">tmpled</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">led_scheme</span> <span class="o">==</span> <span class="n">LED_OFF</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">tmpled</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">led_state</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LED_POWER_ON</span>:
		<span class="n">set_led_bit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">led_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">set_led_bit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">led_bits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">set_led_bit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">led_bits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">set_led_bit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">led_bits</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LED_POWER_OFF</span>:
		<span class="n">set_led_bit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">led_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">set_led_bit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">led_bits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">set_led_bit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">led_bits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">set_led_bit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">led_bits</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LED_S0_ON</span>:
		<span class="n">set_led_bit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">led_bits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LED_S0_OFF</span>:
		<span class="n">set_led_bit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">led_bits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LED_B1_ON</span>:
		<span class="n">set_led_bit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">led_bits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LED_B1_OFF</span>:
		<span class="n">set_led_bit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">led_bits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LED_B2_ON</span>:
		<span class="n">set_led_bit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">led_bits</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LED_B2_OFF</span>:
		<span class="n">set_led_bit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">led_bits</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">led_state</span> <span class="o">!=</span> <span class="n">tmpled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_CALL_TRACE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s reg(0x%02x) val(x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			       <span class="n">HFCUSB_P_DATA</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">led_state</span><span class="p">);</span>

		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_P_DATA</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">led_state</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Layer2 -&gt; Layer 1 Bchannel data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfcusb_l2l1B</span><span class="p">(</span><span class="k">struct</span> <span class="n">mISDNchannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bchannel</span>		<span class="o">*</span><span class="n">bch</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bchannel</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hfcsusb</span>		<span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mISDNhead</span>	<span class="o">*</span><span class="n">hh</span> <span class="o">=</span> <span class="n">mISDN_HEAD_P</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">u_long</span>			<span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_CALL_TRACE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PH_DATA_REQ</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">bchannel_senddata</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_CALL_TRACE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s PH_DATA_REQ ret(%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_ACTIVATE_REQ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hfcsusb_start_endpoint</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">hfcsusb_setup_bch</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">_queue_data</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_ACTIVATE_IND</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span>
				    <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_DEACTIVATE_REQ</span>:
		<span class="n">deactivate_bchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span>
		<span class="n">_queue_data</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_DEACTIVATE_IND</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span>
			    <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * send full D/B channel status information</span>
<span class="cm"> * as MPH_INFORMATION_IND</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcsusb_ph_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ph_info</span> <span class="o">*</span><span class="n">phi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">phi</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ph_info</span><span class="p">)</span> <span class="o">+</span>
		      <span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">nrbchan</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ph_info_ch</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">phi</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">ch</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
	<span class="n">phi</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">ch</span><span class="p">.</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">;</span>
	<span class="n">phi</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">phi</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">num_bch</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">nrbchan</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">nrbchan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phi</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ch</span><span class="p">.</span><span class="n">protocol</span><span class="p">;</span>
		<span class="n">phi</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Flags</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">MPH_INFORMATION_IND</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ph_info_dch</span><span class="p">)</span> <span class="o">+</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">nrbchan</span> <span class="o">*</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ph_info_ch</span><span class="p">),</span> <span class="n">phi</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">phi</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Layer2 -&gt; Layer 1 Dchannel data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfcusb_l2l1D</span><span class="p">(</span><span class="k">struct</span> <span class="n">mISDNchannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mISDNdevice</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mISDNdevice</span><span class="p">,</span> <span class="n">D</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dchannel</span>		<span class="o">*</span><span class="n">dch</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dchannel</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mISDNhead</span>	<span class="o">*</span><span class="n">hh</span> <span class="o">=</span> <span class="n">mISDN_HEAD_P</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hfcsusb</span>		<span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u_long</span>			<span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PH_DATA_REQ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_CALL_TRACE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: PH_DATA_REQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dchannel_senddata</span><span class="p">(</span><span class="n">dch</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">queue_ch_frame</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_DATA_CNF</span><span class="p">,</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PH_ACTIVATE_REQ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_CALL_TRACE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: PH_ACTIVATE_REQ %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_S0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;NT&quot;</span> <span class="o">:</span> <span class="s">&quot;TE&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_S0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span>
					    <span class="n">PH_ACTIVATE_IND</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">hfcsusb_ph_command</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						   <span class="n">HFC_L1_ACTIVATE_NT</span><span class="p">);</span>
				<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_L2_ACTIVATED</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hfcsusb_ph_command</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFC_L1_ACTIVATE_TE</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PH_DEACTIVATE_REQ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_CALL_TRACE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: PH_DEACTIVATE_REQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L2_ACTIVATED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_S0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hfcsusb_ph_command</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFC_L1_DEACTIVATE_NT</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
				<span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
				<span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_TX_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#ifdef FIXME</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L1_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
				<span class="n">dchannel_sched_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">,</span> <span class="n">D_CLEARBUSY</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPH_INFORMATION_REQ</span>:
		<span class="n">hfcsusb_ph_info</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Layer 1 callback function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfc_l1callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_CALL_TRACE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s cmd 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INFO3_P8</span>:
	<span class="k">case</span> <span class="n">INFO3_P10</span>:
	<span class="k">case</span> <span class="n">HW_RESET_REQ</span>:
	<span class="k">case</span> <span class="n">HW_POWERUP_REQ</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HW_DEACT_REQ</span>:
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
			<span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
			<span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_TX_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_ACTIVATE_IND</span>:
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_DEACTIVATE_IND</span>:
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: unknown cmd %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hfcsusb_ph_info</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">open_dchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mISDNchannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">channel_req</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_OPEN</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: dev(%d) open addr(%i) from %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span>
		       <span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
	<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ech</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
	<span class="n">hfcsusb_start_endpoint</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFC_CHAN_D</span><span class="p">);</span>

	<span class="cm">/* E-Channel logging */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">HFCUSB_PCM_RX</span><span class="p">].</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hfcsusb_start_endpoint</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFC_CHAN_E</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ech</span><span class="p">.</span><span class="n">Flags</span><span class="p">);</span>
			<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ech</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">PH_ACTIVATE_IND</span><span class="p">,</span>
				    <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">initdone</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">create_l1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">,</span> <span class="n">hfc_l1callback</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">setPortMode</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">initdone</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_S0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)))</span>
		<span class="n">_queue_data</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_ACTIVATE_IND</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span>
			    <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">ch</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: %s: cannot get module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">open_bchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">channel_req</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bchannel</span>		<span class="o">*</span><span class="n">bch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_CALL_TRACE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s B%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>

	<span class="n">bch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_OPEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span> <span class="cm">/* b-channel can be only open once */</span>
	<span class="n">bch</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: %s:cannot get module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">channel_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mISDN_ctrl_req</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_CALL_TRACE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s op(0x%x) channel(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">),</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_GETOP</span>:
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">MISDN_CTRL_LOOP</span> <span class="o">|</span> <span class="n">MISDN_CTRL_CONNECT</span> <span class="o">|</span>
			<span class="n">MISDN_CTRL_DISCONNECT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: %s: unknown Op %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * device control function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfc_dctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mISDNchannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mISDNdevice</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mISDNdevice</span><span class="p">,</span> <span class="n">D</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dchannel</span>		<span class="o">*</span><span class="n">dch</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dchannel</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hfcsusb</span>		<span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_req</span>	<span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: cmd:%x %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OPEN_CHANNEL</span>:
		<span class="n">rq</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_S0</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">open_dchannel</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">open_bchannel</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">open</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLOSE_CHANNEL</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">open</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_OPEN</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;%s: %s: dev(%d) close from %p (open %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
			       <span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hfcsusb_stop_endpoint</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFC_CHAN_D</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">HFCUSB_PCM_RX</span><span class="p">].</span><span class="n">pipe</span><span class="p">)</span>
				<span class="n">hfcsusb_stop_endpoint</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFC_CHAN_E</span><span class="p">);</span>
			<span class="n">handle_led</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">LED_POWER_ON</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CONTROL_CHANNEL</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">channel_ctrl</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: unknown command %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * S0 TE state change event handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ph_state_te</span><span class="p">(</span><span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;=</span> <span class="n">HFC_MAX_TE_LAYER1_STATE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			       <span class="n">HFC_TE_LAYER1_STATES</span><span class="p">[</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: TE F%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">HW_RESET_IND</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">HW_DEACT_IND</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">ANYSIGNAL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">INFO2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">INFO4_P8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">handle_led</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">LED_S0_ON</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">handle_led</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">LED_S0_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * S0 NT state change event handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ph_state_nt</span><span class="p">(</span><span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;=</span> <span class="n">HFC_MAX_NT_LAYER1_STATE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			       <span class="n">HFC_NT_LAYER1_STATES</span><span class="p">[</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">]);</span>

		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;%s: %s: NT G%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>:
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L2_ACTIVATED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">timers</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NT_ACTIVATION_TIMER</span><span class="p">;</span>
		<span class="n">handle_led</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">LED_S0_OFF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">nt_timer</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">timers</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NT_ACTIVATION_TIMER</span><span class="p">;</span>
			<span class="n">hfcsusb_ph_command</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFC_L1_DEACTIVATE_NT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">timers</span> <span class="o">|=</span> <span class="n">NT_ACTIVATION_TIMER</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="n">NT_T1_COUNT</span><span class="p">;</span>
			<span class="cm">/* allow G2 -&gt; G3 transition */</span>
			<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_STATES</span><span class="p">,</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">HFCUSB_NT_G2_G3</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">timers</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NT_ACTIVATION_TIMER</span><span class="p">;</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">PH_ACTIVATE_IND</span><span class="p">,</span>
			    <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="n">handle_led</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">LED_S0_ON</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">timers</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NT_ACTIVATION_TIMER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hfcsusb_ph_info</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ph_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_S0</span><span class="p">)</span>
		<span class="n">ph_state_nt</span><span class="p">(</span><span class="n">dch</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span>
		<span class="n">ph_state_te</span><span class="p">(</span><span class="n">dch</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * disable/enable BChannel for desired protocoll</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfcsusb_setup_bch</span><span class="p">(</span><span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">conhdlc</span><span class="p">,</span> <span class="n">sctrl</span><span class="p">,</span> <span class="n">sctrl_r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: protocol %x--&gt;%x B%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span>
		       <span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>

	<span class="cm">/* setup val for CON_HDLC */</span>
	<span class="n">conhdlc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">&gt;</span> <span class="n">ISDN_P_NONE</span><span class="p">)</span>
		<span class="n">conhdlc</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* enable FIFO */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>:	<span class="cm">/* used for init */</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_P_NONE</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISDN_P_NONE</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* already in idle state */</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ISDN_P_NONE</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FLG_HDLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FLG_TRANSPARENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_P_B_RAW</span><span class="p">)</span>:
		<span class="n">conhdlc</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FLG_TRANSPARENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_P_B_HDLC</span><span class="p">)</span>:
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FLG_HDLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: prot not known %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">protocol</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">&gt;=</span> <span class="n">ISDN_P_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_FIFO</span><span class="p">,</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_CON_HDLC</span><span class="p">,</span> <span class="n">conhdlc</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_INC_RES_F</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_FIFO</span><span class="p">,</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_CON_HDLC</span><span class="p">,</span> <span class="n">conhdlc</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_INC_RES_F</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">sctrl</span> <span class="o">=</span> <span class="mh">0x40</span> <span class="o">+</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x00</span> <span class="o">:</span> <span class="mh">0x04</span><span class="p">);</span>
		<span class="n">sctrl_r</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sctrl</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sctrl_r</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sctrl</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">sctrl_r</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_SCTRL</span><span class="p">,</span> <span class="n">sctrl</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_SCTRL_R</span><span class="p">,</span> <span class="n">sctrl_r</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">&gt;</span> <span class="n">ISDN_P_NONE</span><span class="p">)</span>
			<span class="n">handle_led</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">LED_B1_ON</span> <span class="o">:</span> <span class="n">LED_B2_ON</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">handle_led</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">LED_B1_OFF</span> <span class="o">:</span>
				   <span class="n">LED_B2_OFF</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hfcsusb_ph_info</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcsusb_ph_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HFC_L1_ACTIVATE_TE</span>:
		<span class="cm">/* force sending sending INFO1 */</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_STATES</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
		<span class="cm">/* start l1 activation */</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_STATES</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HFC_L1_FORCE_DEACTIVATE_TE</span>:
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_STATES</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_STATES</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HFC_L1_ACTIVATE_NT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">PH_ACTIVATE_IND</span><span class="p">,</span>
				    <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_STATES</span><span class="p">,</span> <span class="n">HFCUSB_ACTIVATE</span> <span class="o">|</span>
				  <span class="n">HFCUSB_DO_ACTION</span> <span class="o">|</span> <span class="n">HFCUSB_NT_G2_G3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HFC_L1_DEACTIVATE_NT</span>:
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_STATES</span><span class="p">,</span>
			  <span class="n">HFCUSB_DO_ACTION</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Layer 1 B-channel hardware access</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">channel_bctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mISDN_ctrl_req</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mISDN_ctrl_bchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">cq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* collect data from incoming interrupt or isochron USB data */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcsusb_rx_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">finish</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfcsusb</span>	<span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">maxlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">fifon</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifonum</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">hdlc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_CALL_TRACE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: fifo(%i) len(%i) &quot;</span>
		       <span class="s">&quot;dch(%p) bch(%p) ech(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fifon</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
		       <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ech</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!!</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">dch</span> <span class="o">+</span> <span class="o">!!</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span> <span class="o">+</span> <span class="o">!!</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ech</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: undefined channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_skb</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">;</span>
		<span class="n">maxlen</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">maxlen</span><span class="p">;</span>
		<span class="n">hdlc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_RX_OFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">dropcnt</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">maxlen</span> <span class="o">=</span> <span class="n">bchannel_get_rxbuf</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">rx_skb</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">maxlen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_skb</span><span class="p">)</span>
				<span class="n">skb_trim</span><span class="p">(</span><span class="n">rx_skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s.B%d: No bufferspace for %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">maxlen</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">maxlen</span><span class="p">;</span>
		<span class="n">hdlc</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_HDLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ech</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_skb</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ech</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">;</span>
		<span class="n">maxlen</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ech</span><span class="o">-&gt;</span><span class="n">maxlen</span><span class="p">;</span>
		<span class="n">hdlc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">dch</span> <span class="o">||</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ech</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rx_skb</span> <span class="o">=</span> <span class="n">mI_alloc_skb</span><span class="p">(</span><span class="n">maxlen</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">)</span>
					<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="n">rx_skb</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ech</span><span class="p">)</span>
					<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ech</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="n">rx_skb</span><span class="p">;</span>
				<span class="n">skb_trim</span><span class="p">(</span><span class="n">rx_skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: No mem for rx_skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* D/E-Channel SKB range check */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MAX_DFRAME_LEN_L1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: sbk mem exceeded &quot;</span>
			       <span class="s">&quot;for fifo(%d) HFCUSB_D_RX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fifon</span><span class="p">);</span>
			<span class="n">skb_trim</span><span class="p">(</span><span class="n">rx_skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we have a complete hdlc packet */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">finish</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_FIFO_VERBOSE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: fifon(%i)&quot;</span>
					       <span class="s">&quot; new RX len(%i): &quot;</span><span class="p">,</span>
					       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fifon</span><span class="p">,</span>
					       <span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
					<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
						<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span>
						       <span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]);</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="cm">/* remove CRC &amp; status */</span>
				<span class="n">skb_trim</span><span class="p">(</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">3</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">)</span>
					<span class="n">recv_Dchannel</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">)</span>
					<span class="n">recv_Bchannel</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span>
						      <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ech</span><span class="p">)</span>
					<span class="n">recv_Echannel</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ech</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_FIFO_VERBOSE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s: CRC or minlen ERROR fifon(%i) &quot;</span>
					       <span class="s">&quot;RX len(%i): &quot;</span><span class="p">,</span>
					       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fifon</span><span class="p">,</span> <span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
					<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
						<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span>
						       <span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]);</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">skb_trim</span><span class="p">(</span><span class="n">rx_skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* deliver transparent data to layer2 */</span>
		<span class="n">recv_Bchannel</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fill_isoc_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span>
	      <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_packets</span><span class="p">,</span> <span class="kt">int</span> <span class="n">packet_size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">interval</span><span class="p">,</span>
	      <span class="n">usb_complete_t</span> <span class="n">complete</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>

	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">packet_size</span> <span class="o">*</span> <span class="n">num_packets</span><span class="p">,</span>
			  <span class="n">complete</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>

	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span> <span class="o">=</span> <span class="n">num_packets</span><span class="p">;</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">=</span> <span class="n">URB_ISO_ASAP</span><span class="p">;</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">num_packets</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">packet_size</span> <span class="o">*</span> <span class="n">k</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">packet_size</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* receive completion routine for all ISO tx fifos   */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rx_iso_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iso_urb</span> <span class="o">*</span><span class="n">context_iso_urb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iso_urb</span> <span class="o">*</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_fifo</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="n">context_iso_urb</span><span class="o">-&gt;</span><span class="n">owner_fifo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">errcode</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">num_isoc_packets</span><span class="p">,</span> <span class="n">fifon</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">,</span>
		<span class="n">status</span><span class="p">,</span> <span class="n">iso_status</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">__u8</span> <span class="n">eof</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">__u8</span> <span class="n">s0_state</span><span class="p">;</span>

	<span class="n">fifon</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifonum</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stop_gracefull</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stop_gracefull</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * ISO transfer only partially completed,</span>
<span class="cm">	 * look at individual frame status for details</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EXDEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: with -EXDEV &quot;</span>
			       <span class="s">&quot;urb-&gt;status %d, fifonum %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>  <span class="n">status</span><span class="p">,</span> <span class="n">fifon</span><span class="p">);</span>

		<span class="cm">/* clear status, so go on with ISO transfers */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s0_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num_isoc_packets</span> <span class="o">=</span> <span class="n">iso_packets</span><span class="p">[</span><span class="n">fifon</span><span class="p">];</span>
		<span class="n">maxlen</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">usb_packet_maxlen</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">num_isoc_packets</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">actual_length</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">context_iso_urb</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">iso_status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">status</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">iso_status</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_FIFO_VERBOSE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: &quot;</span>
				       <span class="s">&quot;ISO packet %i, status: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iso_status</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* USB data log for every D ISO in */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">fifon</span> <span class="o">==</span> <span class="n">HFCUSB_D_RX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_USB_VERBOSE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: %s: %d (%d/%d) len(%d) &quot;</span><span class="p">,</span>
				       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">start_frame</span><span class="p">,</span>
				       <span class="n">k</span><span class="p">,</span> <span class="n">num_isoc_packets</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
				       <span class="n">len</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%x &quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iso_status</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">last_urblen</span> <span class="o">!=</span> <span class="n">maxlen</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * save fifo fill-level threshold bits</span>
<span class="cm">					 * to use them later in TX ISO URB</span>
<span class="cm">					 * completions</span>
<span class="cm">					 */</span>
					<span class="n">hw</span><span class="o">-&gt;</span><span class="n">threshold_mask</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">fifon</span> <span class="o">==</span> <span class="n">HFCUSB_D_RX</span><span class="p">)</span>
						<span class="n">s0_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>

					<span class="n">eof</span><span class="p">[</span><span class="n">fifon</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
						<span class="n">hfcsusb_rx_frame</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
								 <span class="n">len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">maxlen</span><span class="p">)</span>
								 <span class="o">?</span> <span class="n">eof</span><span class="p">[</span><span class="n">fifon</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">hfcsusb_rx_frame</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
							 <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">maxlen</span><span class="p">)</span> <span class="o">?</span>
							 <span class="n">eof</span><span class="p">[</span><span class="n">fifon</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">last_urblen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* signal S0 layer1 state change */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">s0_state</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">initdone</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">s0_state</span> <span class="o">!=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">s0_state</span><span class="p">;</span>
			<span class="n">schedule_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">,</span> <span class="n">FLG_PHCHANGE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">fill_isoc_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span>
			      <span class="n">context_iso_urb</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">num_isoc_packets</span><span class="p">,</span>
			      <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">usb_packet_maxlen</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">intervall</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">usb_complete_t</span><span class="p">)</span><span class="n">rx_iso_complete</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
		<span class="n">errcode</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errcode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: error submitting &quot;</span>
				       <span class="s">&quot;ISO URB: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">errcode</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_URB_INFO</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: rx_iso_complete : &quot;</span>
			       <span class="s">&quot;urb-&gt;status %d, fifonum %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">fifon</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* receive completion routine for all interrupt rx fifos */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rx_int_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">,</span> <span class="n">fifon</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_fifo</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_fifo</span> <span class="o">*</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">__u8</span> <span class="n">eof</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stop_gracefull</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stop_gracefull</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">fifon</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifonum</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_URB_ERROR</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;%s: %s: RX-Fifo %i is going down (%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fifon</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* cancel automatic rescheduling */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">maxlen</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">usb_packet_maxlen</span><span class="p">;</span>

	<span class="cm">/* USB data log for every D INT in */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fifon</span> <span class="o">==</span> <span class="n">HFCUSB_D_RX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_USB_VERBOSE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: D RX INT len(%d) &quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">last_urblen</span> <span class="o">!=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">usb_packet_maxlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* the threshold mask is in the 2nd status byte */</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">threshold_mask</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

		<span class="cm">/* signal S0 layer1 state change */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">initdone</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">schedule_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">,</span> <span class="n">FLG_PHCHANGE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">eof</span><span class="p">[</span><span class="n">fifon</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* if we have more than the 2 status bytes -&gt; collect data */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">hfcsusb_rx_frame</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
					 <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">maxlen</span><span class="p">)</span> <span class="o">?</span> <span class="n">eof</span><span class="p">[</span><span class="n">fifon</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hfcsusb_rx_frame</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">maxlen</span><span class="p">)</span> <span class="o">?</span> <span class="n">eof</span><span class="p">[</span><span class="n">fifon</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">last_urblen</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: error resubmitting USB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* transmit completion routine for all ISO tx fifos */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tx_iso_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iso_urb</span> <span class="o">*</span><span class="n">context_iso_urb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iso_urb</span> <span class="o">*</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_fifo</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="n">context_iso_urb</span><span class="o">-&gt;</span><span class="n">owner_fifo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tx_skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">tx_offset</span><span class="p">,</span> <span class="n">num_isoc_packets</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">remain</span><span class="p">,</span> <span class="n">current_len</span><span class="p">,</span>
		<span class="n">errcode</span><span class="p">,</span> <span class="n">hdlc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">tx_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frame_complete</span><span class="p">,</span> <span class="n">fifon</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">fillempty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">threshbit</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stop_gracefull</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stop_gracefull</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_skb</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">;</span>
		<span class="n">tx_idx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_idx</span><span class="p">;</span>
		<span class="n">hdlc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_skb</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">;</span>
		<span class="n">tx_idx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_idx</span><span class="p">;</span>
		<span class="n">hdlc</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_HDLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_skb</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hdlc</span> <span class="o">&amp;&amp;</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_FILLEMPTY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
			<span class="n">fillempty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: neither BCH nor DCH</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fifon</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifonum</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="n">tx_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ISO transfer only partially completed,</span>
<span class="cm">	 * look at individual frame status for details</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EXDEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_URB_ERROR</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: &quot;</span>
			       <span class="s">&quot;-EXDEV (%i) fifon (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">fifon</span><span class="p">);</span>

		<span class="cm">/* clear status, so go on with ISO transfers */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* is FifoFull-threshold set for our channel? */</span>
		<span class="n">threshbit</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">threshold_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">fifon</span><span class="p">));</span>
		<span class="n">num_isoc_packets</span> <span class="o">=</span> <span class="n">iso_packets</span><span class="p">[</span><span class="n">fifon</span><span class="p">];</span>

		<span class="cm">/* predict dataflow to avoid fifo overflow */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fifon</span> <span class="o">&gt;=</span> <span class="n">HFCUSB_D_TX</span><span class="p">)</span>
			<span class="n">sink</span> <span class="o">=</span> <span class="p">(</span><span class="n">threshbit</span><span class="p">)</span> <span class="o">?</span> <span class="n">SINK_DMIN</span> <span class="o">:</span> <span class="n">SINK_DMAX</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sink</span> <span class="o">=</span> <span class="p">(</span><span class="n">threshbit</span><span class="p">)</span> <span class="o">?</span> <span class="n">SINK_MIN</span> <span class="o">:</span> <span class="n">SINK_MAX</span><span class="p">;</span>
		<span class="n">fill_isoc_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span>
			      <span class="n">context_iso_urb</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">num_isoc_packets</span><span class="p">,</span>
			      <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">usb_packet_maxlen</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">intervall</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">usb_complete_t</span><span class="p">)</span><span class="n">tx_iso_complete</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">context_iso_urb</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">context_iso_urb</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">));</span>
		<span class="n">frame_complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">num_isoc_packets</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* analyze tx success of previous ISO packets */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_URB_ERROR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">errcode</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">status</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">errcode</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: &quot;</span>
					       <span class="s">&quot;ISO packet %i, status: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">errcode</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* Generate next ISO Packets */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_skb</span><span class="p">)</span>
				<span class="n">remain</span> <span class="o">=</span> <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="o">*</span><span class="n">tx_idx</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fillempty</span><span class="p">)</span>
				<span class="n">remain</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="cm">/* &gt; not complete */</span>
			<span class="k">else</span>
				<span class="n">remain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">remain</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bit_line</span> <span class="o">-=</span> <span class="n">sink</span><span class="p">;</span>
				<span class="n">current_len</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">-</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bit_line</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">current_len</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span>
					<span class="n">current_len</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">current_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">current_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">remain</span> <span class="o">&lt;</span> <span class="n">current_len</span><span class="p">)</span>
					<span class="n">current_len</span> <span class="o">=</span> <span class="n">remain</span><span class="p">;</span>

				<span class="cm">/* how much bit do we put on the line? */</span>
				<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bit_line</span> <span class="o">+=</span> <span class="n">current_len</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

				<span class="n">context_iso_urb</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">tx_offset</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">current_len</span> <span class="o">==</span> <span class="n">remain</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* signal frame completion */</span>
						<span class="n">context_iso_urb</span><span class="o">-&gt;</span>
							<span class="n">buffer</span><span class="p">[</span><span class="n">tx_offset</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="cm">/* add 2 byte flags and 16bit</span>
<span class="cm">						 * CRC at end of ISDN frame */</span>
						<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bit_line</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">frame_complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* copy tx data to iso-urb buffer */</span>
				<span class="n">p</span> <span class="o">=</span> <span class="n">context_iso_urb</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">tx_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fillempty</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">fill</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					       <span class="n">current_len</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="o">*</span><span class="n">tx_idx</span><span class="p">),</span>
					       <span class="n">current_len</span><span class="p">);</span>
					<span class="o">*</span><span class="n">tx_idx</span> <span class="o">+=</span> <span class="n">current_len</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">tx_offset</span><span class="p">;</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">current_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

				<span class="cm">/* USB data log for every D ISO out */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">fifon</span> <span class="o">==</span> <span class="n">HFCUSB_D_RX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fillempty</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_USB_VERBOSE</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s: %s (%d/%d) offs(%d) len(%d) &quot;</span><span class="p">,</span>
					       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					       <span class="n">k</span><span class="p">,</span> <span class="n">num_isoc_packets</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
					       <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span>
					       <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>

					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
					     <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">offset</span>
						  <span class="o">+</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
					     <span class="n">i</span><span class="o">++</span><span class="p">)</span>
						<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%x &quot;</span><span class="p">,</span>
						       <span class="n">context_iso_urb</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

					<span class="n">printk</span><span class="p">(</span><span class="s">&quot; skb-&gt;len(%i) tx-idx(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="o">*</span><span class="n">tx_idx</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">tx_offset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">current_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">tx_offset</span><span class="o">++</span><span class="p">;</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="cm">/* we lower data margin every msec */</span>
				<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bit_line</span> <span class="o">-=</span> <span class="n">sink</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bit_line</span> <span class="o">&lt;</span> <span class="n">BITLINE_INF</span><span class="p">)</span>
					<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bit_line</span> <span class="o">=</span> <span class="n">BITLINE_INF</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">frame_complete</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">frame_complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_FIFO_VERBOSE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>  <span class="s">&quot;%s: %s: &quot;</span>
					       <span class="s">&quot;fifon(%i) new TX len(%i): &quot;</span><span class="p">,</span>
					       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					       <span class="n">fifon</span><span class="p">,</span> <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
					<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
						<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span>
						       <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]);</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">tx_skb</span><span class="p">);</span>
				<span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">dch</span> <span class="o">&amp;&amp;</span> <span class="n">get_next_dframe</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">))</span>
					<span class="n">tx_skb</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span> <span class="o">&amp;&amp;</span>
					 <span class="n">get_next_bframe</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">))</span>
					<span class="n">tx_skb</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">errcode</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errcode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: %s: error submitting ISO URB: %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">errcode</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * abuse DChannel tx iso completion to trigger NT mode state</span>
<span class="cm">		 * changes tx_iso_complete is assumed to be called every</span>
<span class="cm">		 * fifo-&gt;intervall (ms)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fifon</span> <span class="o">==</span> <span class="n">HFCUSB_D_TX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_S0</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">timers</span> <span class="o">&amp;</span> <span class="n">NT_ACTIVATION_TIMER</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">--</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">nt_timer</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">schedule_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">,</span> <span class="n">FLG_PHCHANGE</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_URB_ERROR</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>  <span class="s">&quot;%s: %s: urb-&gt;status %s (%i)&quot;</span>
			       <span class="s">&quot;fifonum=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			       <span class="n">symbolic</span><span class="p">(</span><span class="n">urb_errlist</span><span class="p">,</span> <span class="n">status</span><span class="p">),</span> <span class="n">status</span><span class="p">,</span> <span class="n">fifon</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * allocs urbs and start isoc transfer with two pending urbs to avoid</span>
<span class="cm"> * gaps in the transfer chain</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">start_isoc_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_packets_per_urb</span><span class="p">,</span>
		 <span class="n">usb_complete_t</span> <span class="n">complete</span><span class="p">,</span> <span class="kt">int</span> <span class="n">packet_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">errcode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: fifo %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifonum</span><span class="p">);</span>

	<span class="cm">/* allocate Memory for Iso out Urbs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">iso</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">iso</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urb</span> <span class="o">=</span>
				<span class="n">usb_alloc_urb</span><span class="p">(</span><span class="n">num_packets_per_urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">iso</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urb</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: %s: alloc urb for fifo %i failed&quot;</span><span class="p">,</span>
				       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifonum</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">iso</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">owner_fifo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_fifo</span> <span class="o">*</span><span class="p">)</span> <span class="n">fifo</span><span class="p">;</span>
			<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">iso</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">indx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

			<span class="cm">/* Init the first iso */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ISO_BUFFER_SIZE</span> <span class="o">&gt;=</span>
			    <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">usb_packet_maxlen</span> <span class="o">*</span>
			     <span class="n">num_packets_per_urb</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">fill_isoc_urb</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">iso</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urb</span><span class="p">,</span>
					      <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span>
					      <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">iso</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span><span class="p">,</span>
					      <span class="n">num_packets_per_urb</span><span class="p">,</span>
					      <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">usb_packet_maxlen</span><span class="p">,</span>
					      <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">intervall</span><span class="p">,</span> <span class="n">complete</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">iso</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">iso</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">iso</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span><span class="p">));</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">num_packets_per_urb</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">iso</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urb</span><span class="o">-&gt;</span>
						<span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span>
						<span class="n">k</span> <span class="o">*</span> <span class="n">packet_size</span><span class="p">;</span>
					<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">iso</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urb</span><span class="o">-&gt;</span>
						<span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span>
						<span class="n">packet_size</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: %s: ISO Buffer size to small!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">bit_line</span> <span class="o">=</span> <span class="n">BITLINE_INF</span><span class="p">;</span>

		<span class="n">errcode</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">iso</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="p">(</span><span class="n">errcode</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stop_gracefull</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errcode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: %s URB nr:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			       <span class="n">symbolic</span><span class="p">(</span><span class="n">urb_errlist</span><span class="p">,</span> <span class="n">errcode</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">stop_iso_gracefull</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s for fifo %i.%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifonum</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stop_gracefull</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stop_gracefull</span> <span class="o">&amp;&amp;</span> <span class="n">timeout</span><span class="o">--</span><span class="p">)</span>
			<span class="n">schedule_timeout_interruptible</span><span class="p">((</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;&amp;</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stop_gracefull</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: ERROR %s for fifo %i.%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifonum</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">stop_int_gracefull</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s for fifo %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifonum</span><span class="p">);</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stop_gracefull</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stop_gracefull</span> <span class="o">&amp;&amp;</span> <span class="n">timeout</span><span class="o">--</span><span class="p">)</span>
		<span class="n">schedule_timeout_interruptible</span><span class="p">((</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;&amp;</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stop_gracefull</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: ERROR %s for fifo %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifonum</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* start the interrupt transfer for the given fifo */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">start_int_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">errcode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: INT IN fifo:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifonum</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span>
			 <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">usb_packet_maxlen</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">usb_complete_t</span><span class="p">)</span><span class="n">rx_int_complete</span><span class="p">,</span> <span class="n">fifo</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">intervall</span><span class="p">);</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stop_gracefull</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">errcode</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errcode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: submit URB: status:%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">errcode</span><span class="p">);</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">setPortMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;TE&quot;</span> <span class="o">:</span> <span class="s">&quot;NT&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_SCTRL</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_SCTRL_E</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_CLKDEL</span><span class="p">,</span> <span class="n">CLKDEL_TE</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_STATES</span><span class="p">,</span> <span class="mi">3</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_STATES</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_SCTRL</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_SCTRL_E</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_CLKDEL</span><span class="p">,</span> <span class="n">CLKDEL_NT</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_STATES</span><span class="p">,</span> <span class="mi">1</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_STATES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">reset_hfcsusb</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* do Chip reset */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_CIRM</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* aux = output, reset off */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_CIRM</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>

	<span class="cm">/* set USB_SIZE to match the wMaxPacketSize for INT or BULK transfers */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_USB_SIZE</span><span class="p">,</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">packet_size</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">packet_size</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>

	<span class="cm">/* set USB_SIZE_I to match the the wMaxPacketSize for ISO transfers */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_USB_SIZE_I</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">iso_packet_size</span><span class="p">);</span>

	<span class="cm">/* enable PCM/GCI master mode */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_MST_MODE1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* set default values */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_MST_MODE0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* enable master mode */</span>

	<span class="cm">/* init the fifos */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_F_THRES</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">HFCUSB_TX_THRESHOLD</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">HFCUSB_RX_THRESHOLD</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>

	<span class="n">fifo</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HFCUSB_NUM_FIFOS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_FIFO</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>	<span class="cm">/* select the desired fifo */</span>
		<span class="n">fifo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_size</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">HFCUSB_B2_RX</span><span class="p">)</span> <span class="o">?</span> <span class="n">MAX_BCH_SIZE</span> <span class="o">:</span> <span class="n">MAX_DFRAME_LEN</span><span class="p">;</span>
		<span class="n">fifo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">last_urblen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* set 2 bit for D- &amp; E-channel */</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_HDLC_PAR</span><span class="p">,</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">HFCUSB_B2_RX</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">2</span><span class="p">));</span>

		<span class="cm">/* enable all fifos */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">HFCUSB_D_TX</span><span class="p">)</span>
			<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_CON_HDLC</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_S0</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x08</span> <span class="o">:</span> <span class="mh">0x09</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_CON_HDLC</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_INC_RES_F</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* reset the fifo */</span>
	<span class="p">}</span>

	<span class="n">write_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_SCTRL_R</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* disable both B receivers */</span>
	<span class="n">handle_led</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">LED_POWER_ON</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* start USB data pipes dependand on device&#39;s endpoint configuration */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcsusb_start_endpoint</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* quick check if endpoint already running */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">channel</span> <span class="o">==</span> <span class="n">HFC_CHAN_D</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">HFCUSB_D_RX</span><span class="p">].</span><span class="n">active</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">channel</span> <span class="o">==</span> <span class="n">HFC_CHAN_B1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">HFCUSB_B1_RX</span><span class="p">].</span><span class="n">active</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">channel</span> <span class="o">==</span> <span class="n">HFC_CHAN_B2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">HFCUSB_B2_RX</span><span class="p">].</span><span class="n">active</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">channel</span> <span class="o">==</span> <span class="n">HFC_CHAN_E</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">HFCUSB_PCM_RX</span><span class="p">].</span><span class="n">active</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* start rx endpoints using USB INT IN method */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cfg_used</span> <span class="o">==</span> <span class="n">CNF_3INT3ISO</span> <span class="o">||</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cfg_used</span> <span class="o">==</span> <span class="n">CNF_4INT3ISO</span><span class="p">)</span>
		<span class="n">start_int_fifo</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span> <span class="o">+</span> <span class="n">channel</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* start rx endpoints using USB ISO IN method */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cfg_used</span> <span class="o">==</span> <span class="n">CNF_3ISO3ISO</span> <span class="o">||</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cfg_used</span> <span class="o">==</span> <span class="n">CNF_4ISO3ISO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HFC_CHAN_D</span>:
			<span class="n">start_isoc_chain</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span> <span class="o">+</span> <span class="n">HFCUSB_D_RX</span><span class="p">,</span>
					 <span class="n">ISOC_PACKETS_D</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">usb_complete_t</span><span class="p">)</span><span class="n">rx_iso_complete</span><span class="p">,</span>
					 <span class="mi">16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HFC_CHAN_E</span>:
			<span class="n">start_isoc_chain</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span> <span class="o">+</span> <span class="n">HFCUSB_PCM_RX</span><span class="p">,</span>
					 <span class="n">ISOC_PACKETS_D</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">usb_complete_t</span><span class="p">)</span><span class="n">rx_iso_complete</span><span class="p">,</span>
					 <span class="mi">16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HFC_CHAN_B1</span>:
			<span class="n">start_isoc_chain</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span> <span class="o">+</span> <span class="n">HFCUSB_B1_RX</span><span class="p">,</span>
					 <span class="n">ISOC_PACKETS_B</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">usb_complete_t</span><span class="p">)</span><span class="n">rx_iso_complete</span><span class="p">,</span>
					 <span class="mi">16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HFC_CHAN_B2</span>:
			<span class="n">start_isoc_chain</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span> <span class="o">+</span> <span class="n">HFCUSB_B2_RX</span><span class="p">,</span>
					 <span class="n">ISOC_PACKETS_B</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">usb_complete_t</span><span class="p">)</span><span class="n">rx_iso_complete</span><span class="p">,</span>
					 <span class="mi">16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* start tx endpoints using USB ISO OUT method */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HFC_CHAN_D</span>:
		<span class="n">start_isoc_chain</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span> <span class="o">+</span> <span class="n">HFCUSB_D_TX</span><span class="p">,</span>
				 <span class="n">ISOC_PACKETS_B</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">usb_complete_t</span><span class="p">)</span><span class="n">tx_iso_complete</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HFC_CHAN_B1</span>:
		<span class="n">start_isoc_chain</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span> <span class="o">+</span> <span class="n">HFCUSB_B1_TX</span><span class="p">,</span>
				 <span class="n">ISOC_PACKETS_D</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">usb_complete_t</span><span class="p">)</span><span class="n">tx_iso_complete</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HFC_CHAN_B2</span>:
		<span class="n">start_isoc_chain</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span> <span class="o">+</span> <span class="n">HFCUSB_B2_TX</span><span class="p">,</span>
				 <span class="n">ISOC_PACKETS_B</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">usb_complete_t</span><span class="p">)</span><span class="n">tx_iso_complete</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* stop USB data pipes dependand on device&#39;s endpoint configuration */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcsusb_stop_endpoint</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* quick check if endpoint currently running */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">channel</span> <span class="o">==</span> <span class="n">HFC_CHAN_D</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">HFCUSB_D_RX</span><span class="p">].</span><span class="n">active</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">channel</span> <span class="o">==</span> <span class="n">HFC_CHAN_B1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">HFCUSB_B1_RX</span><span class="p">].</span><span class="n">active</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">channel</span> <span class="o">==</span> <span class="n">HFC_CHAN_B2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">HFCUSB_B2_RX</span><span class="p">].</span><span class="n">active</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">channel</span> <span class="o">==</span> <span class="n">HFC_CHAN_E</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">HFCUSB_PCM_RX</span><span class="p">].</span><span class="n">active</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* rx endpoints using USB INT IN method */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cfg_used</span> <span class="o">==</span> <span class="n">CNF_3INT3ISO</span> <span class="o">||</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cfg_used</span> <span class="o">==</span> <span class="n">CNF_4INT3ISO</span><span class="p">)</span>
		<span class="n">stop_int_gracefull</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span> <span class="o">+</span> <span class="n">channel</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* rx endpoints using USB ISO IN method */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cfg_used</span> <span class="o">==</span> <span class="n">CNF_3ISO3ISO</span> <span class="o">||</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cfg_used</span> <span class="o">==</span> <span class="n">CNF_4ISO3ISO</span><span class="p">)</span>
		<span class="n">stop_iso_gracefull</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span> <span class="o">+</span> <span class="n">channel</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* tx endpoints using USB ISO OUT method */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">!=</span> <span class="n">HFC_CHAN_E</span><span class="p">)</span>
		<span class="n">stop_iso_gracefull</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span> <span class="o">+</span> <span class="n">channel</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Hardware Initialization */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">setup_hfcsusb</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_CALL_TRACE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* check the chip id */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_reg_atomic</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFCUSB_CHIP_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: cannot read chip id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="n">HFCUSB_CHIPID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: Invalid chip id 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* first set the needed config, interface and alternate */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">if_used</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">alt_used</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">led_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* init the background machinery for control requests */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_read</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_read</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_read</span><span class="p">.</span><span class="n">wLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_write</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_write</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_write</span><span class="p">.</span><span class="n">wLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usb_fill_control_urb</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_out_pipe</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_write</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">usb_complete_t</span><span class="p">)</span><span class="n">ctrl_complete</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>

	<span class="n">reset_hfcsusb</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">release_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_CALL_TRACE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * stop all endpoints gracefully</span>
<span class="cm">	 * TODO: mISDN_core should generate CLOSE_CHANNEL</span>
<span class="cm">	 *       signals after calling mISDN_unregister_device()</span>
<span class="cm">	 */</span>
	<span class="n">hfcsusb_stop_endpoint</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFC_CHAN_D</span><span class="p">);</span>
	<span class="n">hfcsusb_stop_endpoint</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFC_CHAN_B1</span><span class="p">);</span>
	<span class="n">hfcsusb_stop_endpoint</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFC_CHAN_B2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">HFCUSB_PCM_RX</span><span class="p">].</span><span class="n">pipe</span><span class="p">)</span>
		<span class="n">hfcsusb_stop_endpoint</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFC_CHAN_E</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span>
		<span class="n">l1_event</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">l1</span><span class="p">,</span> <span class="n">CLOSE_CHANNEL</span><span class="p">);</span>

	<span class="n">mISDN_unregister_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mISDN_freebchannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">mISDN_freebchannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">mISDN_freedchannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">)</span>
		<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">hw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">deactivate_bchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: bch-&gt;nr(%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mISDN_clear_bchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">hfcsusb_setup_bch</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">ISDN_P_NONE</span><span class="p">);</span>
	<span class="n">hfcsusb_stop_endpoint</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Layer 1 B-channel hardware access</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfc_bctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mISDNchannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bchannel</span>	<span class="o">*</span><span class="n">bch</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bchannel</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: cmd:%x %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HW_TESTRX_RAW</span>:
	<span class="k">case</span> <span class="n">HW_TESTRX_HDLC</span>:
	<span class="k">case</span> <span class="n">HW_TESTRX_OFF</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CLOSE_CHANNEL</span>:
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_OPEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">deactivate_bchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ISDN_P_NONE</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">peer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CONTROL_CHANNEL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">channel_bctrl</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: unknown prim(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">setup_instance</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_HFC_CALL_TRACE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">mISDN_initdchannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">,</span> <span class="n">MAX_DFRAME_LEN_L1</span><span class="p">,</span> <span class="n">ph_state</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">Dprotocols</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ISDN_P_NT_S0</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">send</span> <span class="o">=</span> <span class="n">hfcusb_l2l1D</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">hfc_dctrl</span><span class="p">;</span>

	<span class="cm">/* enable E-Channel logging */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">HFCUSB_PCM_RX</span><span class="p">].</span><span class="n">pipe</span><span class="p">)</span>
		<span class="n">mISDN_initdchannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ech</span><span class="p">,</span> <span class="n">MAX_DFRAME_LEN_L1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">Bprotocols</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ISDN_P_B_RAW</span> <span class="o">&amp;</span> <span class="n">ISDN_P_B_MASK</span><span class="p">))</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ISDN_P_B_HDLC</span> <span class="o">&amp;</span> <span class="n">ISDN_P_B_MASK</span><span class="p">));</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">nrbchan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nr</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">set_channelmap</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">channelmap</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>
		<span class="n">mISDN_initbchannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">MAX_DATA_MEM</span><span class="p">,</span> <span class="n">poll</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ch</span><span class="p">.</span><span class="n">send</span> <span class="o">=</span> <span class="n">hfcusb_l2l1B</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ch</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">hfc_bctrl</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ch</span><span class="p">.</span><span class="n">nr</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ch</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">bchannels</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">HFCUSB_B1_TX</span><span class="p">].</span><span class="n">bch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">HFCUSB_B1_RX</span><span class="p">].</span><span class="n">bch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">HFCUSB_B2_TX</span><span class="p">].</span><span class="n">bch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">HFCUSB_B2_RX</span><span class="p">].</span><span class="n">bch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">HFCUSB_D_TX</span><span class="p">].</span><span class="n">dch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">HFCUSB_D_RX</span><span class="p">].</span><span class="n">dch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">HFCUSB_PCM_RX</span><span class="p">].</span><span class="n">ech</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ech</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">HFCUSB_PCM_TX</span><span class="p">].</span><span class="n">ech</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ech</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">setup_hfcsusb</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">MISDN_MAX_IDLEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s.%d&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
		 <span class="n">hfcsusb_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: registered as &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mISDN_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">hfcsusb_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HFClock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">HFClist</span><span class="p">);</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HFClock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">mISDN_freebchannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">mISDN_freebchannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">mISDN_freedchannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfcsusb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfcsusb</span>			<span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span>		<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span>	<span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span>	<span class="o">*</span><span class="n">iface_used</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_endpoint</span>	<span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hfcsusb_vdata</span>		<span class="o">*</span><span class="n">driver_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ifnum</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">alt_idx</span><span class="p">,</span>
		<span class="n">probe_alt_setting</span><span class="p">,</span> <span class="n">vend_idx</span><span class="p">,</span> <span class="n">cfg_used</span><span class="p">,</span> <span class="o">*</span><span class="n">vcf</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">cfg_found</span><span class="p">,</span>
		<span class="n">ep_addr</span><span class="p">,</span> <span class="n">cmptbl</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">small_match</span><span class="p">,</span> <span class="n">iso_packet_size</span><span class="p">,</span> <span class="n">packet_size</span><span class="p">,</span>
		<span class="n">alt_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vend_idx</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">hfcsusb_idtab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idVendor</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">)</span>
		     <span class="o">==</span> <span class="n">hfcsusb_idtab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idVendor</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">)</span>
		     <span class="o">==</span> <span class="n">hfcsusb_idtab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idProduct</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vend_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	       <span class="s">&quot;%s: interface(%d) actalt(%d) minor(%d) vend_idx(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">__func__</span><span class="p">,</span> <span class="n">ifnum</span><span class="p">,</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bAlternateSetting</span><span class="p">,</span>
	       <span class="n">intf</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">vend_idx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vend_idx</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;%s: no valid vendor found in USB descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* if vendor and product ID is OK, start probing alternate settings */</span>
	<span class="n">alt_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">small_match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* default settings */</span>
	<span class="n">iso_packet_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">packet_size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">alt_idx</span> <span class="o">&lt;</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">num_altsetting</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iface</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">altsetting</span> <span class="o">+</span> <span class="n">alt_idx</span><span class="p">;</span>
		<span class="n">probe_alt_setting</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bAlternateSetting</span><span class="p">;</span>
		<span class="n">cfg_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">validconf</span><span class="p">[</span><span class="n">cfg_used</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">cfg_found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">vcf</span> <span class="o">=</span> <span class="n">validconf</span><span class="p">[</span><span class="n">cfg_used</span><span class="p">];</span>
			<span class="n">ep</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">cmptbl</span><span class="p">,</span> <span class="n">vcf</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>

			<span class="cm">/* check for all endpoints in this alternate setting */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ep_addr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">;</span>

				<span class="cm">/* get endpoint base */</span>
				<span class="n">idx</span> <span class="o">=</span> <span class="p">((</span><span class="n">ep_addr</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ep_addr</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
					<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
				<span class="n">attr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bmAttributes</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">cmptbl</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">!=</span> <span class="n">EP_NOP</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">cmptbl</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">EP_NUL</span><span class="p">)</span>
						<span class="n">cfg_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_INT</span>
					    <span class="o">&amp;&amp;</span> <span class="n">cmptbl</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">EP_INT</span><span class="p">)</span>
						<span class="n">cmptbl</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">EP_NUL</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>
					    <span class="o">&amp;&amp;</span> <span class="n">cmptbl</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">EP_BLK</span><span class="p">)</span>
						<span class="n">cmptbl</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">EP_NUL</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>
					    <span class="o">&amp;&amp;</span> <span class="n">cmptbl</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">EP_ISO</span><span class="p">)</span>
						<span class="n">cmptbl</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">EP_NUL</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_INT</span> <span class="o">&amp;&amp;</span>
					    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterval</span> <span class="o">&lt;</span> <span class="n">vcf</span><span class="p">[</span><span class="mi">17</span><span class="p">])</span> <span class="p">{</span>
						<span class="n">cfg_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">ep</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cmptbl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">EP_NOP</span> <span class="o">&amp;&amp;</span> <span class="n">cmptbl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">EP_NUL</span><span class="p">)</span>
					<span class="n">cfg_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cfg_found</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">small_match</span> <span class="o">&lt;</span> <span class="n">cfg_used</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">small_match</span> <span class="o">=</span> <span class="n">cfg_used</span><span class="p">;</span>
					<span class="n">alt_used</span> <span class="o">=</span> <span class="n">probe_alt_setting</span><span class="p">;</span>
					<span class="n">iface_used</span> <span class="o">=</span> <span class="n">iface</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">cfg_used</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">alt_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>	<span class="cm">/* (alt_idx &lt; intf-&gt;num_altsetting) */</span>

	<span class="cm">/* not found a valid USB Ta Endpoint config */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">small_match</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">iface_used</span><span class="p">;</span>
	<span class="n">hw</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>	<span class="cm">/* got no mem */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">MISDN_MAX_IDLEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="n">vcf</span> <span class="o">=</span> <span class="n">validconf</span><span class="p">[</span><span class="n">small_match</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_fifo</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>

		<span class="n">ep_addr</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">;</span>
		<span class="cm">/* get endpoint base */</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="p">((</span><span class="n">ep_addr</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep_addr</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">f</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">idx</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">];</span>

		<span class="cm">/* init Endpoints */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">EP_NOP</span> <span class="o">||</span> <span class="n">vcf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">EP_NUL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bmAttributes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_INT</span>:
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						 <span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">);</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">usb_transfer_mode</span> <span class="o">=</span> <span class="n">USB_INT</span><span class="p">;</span>
			<span class="n">packet_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ep_addr</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">);</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">usb_transfer_mode</span> <span class="o">=</span> <span class="n">USB_BULK</span><span class="p">;</span>
			<span class="n">packet_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_ISOC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ep_addr</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvisocpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_sndisocpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							  <span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">);</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">usb_transfer_mode</span> <span class="o">=</span> <span class="n">USB_ISOC</span><span class="p">;</span>
			<span class="n">iso_packet_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">fifonum</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">usb_packet_maxlen</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span><span class="p">);</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">intervall</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterval</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ep</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span> <span class="cm">/* save device */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">if_used</span> <span class="o">=</span> <span class="n">ifnum</span><span class="p">;</span> <span class="cm">/* save used interface */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">alt_used</span> <span class="o">=</span> <span class="n">alt_used</span><span class="p">;</span> <span class="cm">/* and alternate config */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_paksize</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">bMaxPacketSize0</span><span class="p">;</span> <span class="cm">/* control size */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cfg_used</span> <span class="o">=</span> <span class="n">vcf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>	<span class="cm">/* store used config */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vend_idx</span> <span class="o">=</span> <span class="n">vend_idx</span><span class="p">;</span> <span class="cm">/* store found vendor */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">packet_size</span> <span class="o">=</span> <span class="n">packet_size</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">iso_packet_size</span> <span class="o">=</span> <span class="n">iso_packet_size</span><span class="p">;</span>

	<span class="cm">/* create the control pipes needed for register access */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_in_pipe</span> <span class="o">=</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_out_pipe</span> <span class="o">=</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">driver_info</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">hfcsusb_vdata</span> <span class="o">*</span><span class="p">)</span><span class="n">hfcsusb_idtab</span><span class="p">[</span><span class="n">vend_idx</span><span class="p">].</span><span class="n">driver_info</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s: detected </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> (%s, if=%d alt=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">vend_name</span><span class="p">,</span>
	       <span class="n">conf_str</span><span class="p">[</span><span class="n">small_match</span><span class="p">],</span> <span class="n">ifnum</span><span class="p">,</span> <span class="n">alt_used</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">setup_instance</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">intf</span> <span class="o">=</span> <span class="n">intf</span><span class="p">;</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* function called when an active device is removed */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcsusb_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hfcsusb</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: device disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">handle_led</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">LED_POWER_OFF</span><span class="p">);</span>
	<span class="n">release_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">HFClist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span><span class="p">)</span>
		<span class="n">hfcsusb_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">hfcsusb_drv</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">hfcsusb_idtab</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">hfcsusb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">hfcsusb_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_hub_initiated_lpm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">hfcsusb_drv</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
