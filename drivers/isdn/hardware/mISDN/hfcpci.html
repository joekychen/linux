<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hardware › mISDN › hfcpci.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>hfcpci.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * hfcpci.c     low level driver for CCD&#39;s hfc-pci based cards</span>
<span class="cm"> *</span>
<span class="cm"> * Author     Werner Cornelius (werner@isdn4linux.de)</span>
<span class="cm"> *            based on existing driver for CCD hfc ISA cards</span>
<span class="cm"> *            type approval valid for HFC-S PCI A based card</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 1999  by Werner Cornelius (werner@isdn-development.de)</span>
<span class="cm"> * Copyright 2008  by Karsten Keil &lt;kkeil@novell.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Module options:</span>
<span class="cm"> *</span>
<span class="cm"> * debug:</span>
<span class="cm"> *	NOTE: only one poll value must be given for all cards</span>
<span class="cm"> *	See hfc_pci.h for debug flags.</span>
<span class="cm"> *</span>
<span class="cm"> * poll:</span>
<span class="cm"> *	NOTE: only one poll value must be given for all cards</span>
<span class="cm"> *	Give the number of samples for each fifo process.</span>
<span class="cm"> *	By default 128 is used. Decrease to reduce delay, increase to</span>
<span class="cm"> *	reduce cpu load. If unsure, don&#39;t mess with it!</span>
<span class="cm"> *	A value of 128 will use controller&#39;s interrupt. Other values will</span>
<span class="cm"> *	use kernel timer, because the controller will not allow lower values</span>
<span class="cm"> *	than 128.</span>
<span class="cm"> *	Also note that the value depends on the kernel timer frequency.</span>
<span class="cm"> *	If kernel uses a frequency of 1000 Hz, steps of 8 samples are possible.</span>
<span class="cm"> *	If the kernel uses 100 Hz, steps of 80 samples are possible.</span>
<span class="cm"> *	If the kernel uses 300 Hz, steps of about 26 samples are possible.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mISDNhw.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;hfc_pci.h&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hfcpci_revision</span> <span class="o">=</span> <span class="s">&quot;2.0&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">HFC_cnt</span><span class="p">;</span>
<span class="k">static</span> <span class="n">uint</span> <span class="n">debug</span><span class="p">;</span>
<span class="k">static</span> <span class="n">uint</span> <span class="n">poll</span><span class="p">,</span> <span class="n">tics</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">hfc_tl</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hfc_jiffies</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Karsten Keil&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">poll</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">HFC_CCD_2BD0</span><span class="p">,</span>
	<span class="n">HFC_CCD_B000</span><span class="p">,</span>
	<span class="n">HFC_CCD_B006</span><span class="p">,</span>
	<span class="n">HFC_CCD_B007</span><span class="p">,</span>
	<span class="n">HFC_CCD_B008</span><span class="p">,</span>
	<span class="n">HFC_CCD_B009</span><span class="p">,</span>
	<span class="n">HFC_CCD_B00A</span><span class="p">,</span>
	<span class="n">HFC_CCD_B00B</span><span class="p">,</span>
	<span class="n">HFC_CCD_B00C</span><span class="p">,</span>
	<span class="n">HFC_CCD_B100</span><span class="p">,</span>
	<span class="n">HFC_CCD_B700</span><span class="p">,</span>
	<span class="n">HFC_CCD_B701</span><span class="p">,</span>
	<span class="n">HFC_ASUS_0675</span><span class="p">,</span>
	<span class="n">HFC_BERKOM_A1T</span><span class="p">,</span>
	<span class="n">HFC_BERKOM_TCONCEPT</span><span class="p">,</span>
	<span class="n">HFC_ANIGMA_MC145575</span><span class="p">,</span>
	<span class="n">HFC_ZOLTRIX_2BD0</span><span class="p">,</span>
	<span class="n">HFC_DIGI_DF_M_IOM2_E</span><span class="p">,</span>
	<span class="n">HFC_DIGI_DF_M_E</span><span class="p">,</span>
	<span class="n">HFC_DIGI_DF_M_IOM2_A</span><span class="p">,</span>
	<span class="n">HFC_DIGI_DF_M_A</span><span class="p">,</span>
	<span class="n">HFC_ABOCOM_2BD1</span><span class="p">,</span>
	<span class="n">HFC_SITECOM_DC105V2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hfcPCI_hw</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">cirm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">ctmt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">clkdel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">states</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">conn</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">mst_m</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">int_m1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">int_m2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">sctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">sctrl_r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">sctrl_e</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">trm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">fifo_en</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">bswapped</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">protocol</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">nt_timer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">pci_io</span><span class="p">;</span> <span class="cm">/* start of PCI IO memory */</span>
	<span class="n">dma_addr_t</span>		<span class="n">dmahandle</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">fifos</span><span class="p">;</span> <span class="cm">/* FIFO memory */</span>
	<span class="kt">int</span>			<span class="n">last_bfifo_cnt</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="cm">/* marker saving last b-fifo frame count */</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">timer</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define	HFC_CFG_MASTER		1</span>
<span class="cp">#define HFC_CFG_SLAVE		2</span>
<span class="cp">#define	HFC_CFG_PCM		3</span>
<span class="cp">#define HFC_CFG_2HFC		4</span>
<span class="cp">#define HFC_CFG_SLAVEHFC	5</span>
<span class="cp">#define HFC_CFG_NEG_F0		6</span>
<span class="cp">#define HFC_CFG_SW_DD_DU	7</span>

<span class="cp">#define FLG_HFC_TIMER_T1	16</span>
<span class="cp">#define FLG_HFC_TIMER_T3	17</span>

<span class="cp">#define NT_T1_COUNT	1120	</span><span class="cm">/* number of 3.125ms interrupts (3.5s) */</span><span class="cp"></span>
<span class="cp">#define NT_T3_COUNT	31	</span><span class="cm">/* number of 3.125ms interrupts (97 ms) */</span><span class="cp"></span>
<span class="cp">#define CLKDEL_TE	0x0e	</span><span class="cm">/* CLKDEL in TE mode */</span><span class="cp"></span>
<span class="cp">#define CLKDEL_NT	0x6c	</span><span class="cm">/* CLKDEL in NT mode */</span><span class="cp"></span>


<span class="k">struct</span> <span class="n">hfc_pci</span> <span class="p">{</span>
	<span class="n">u_char</span>			<span class="n">subtype</span><span class="p">;</span>
	<span class="n">u_char</span>			<span class="n">chanlimit</span><span class="p">;</span>
	<span class="n">u_char</span>			<span class="n">initdone</span><span class="p">;</span>
	<span class="n">u_long</span>			<span class="n">cfg</span><span class="p">;</span>
	<span class="n">u_int</span>			<span class="n">irq</span><span class="p">;</span>
	<span class="n">u_int</span>			<span class="n">irqcnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>		<span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hfcPCI_hw</span>	<span class="n">hw</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>	<span class="cm">/* card lock */</span>
	<span class="k">struct</span> <span class="n">dchannel</span>		<span class="n">dch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bchannel</span>		<span class="n">bch</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* Interface functions */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">enable_hwirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_pci</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m2</span> <span class="o">|=</span> <span class="n">HFCPCI_IRQ_ENABLE</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_INT_M2</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">disable_hwirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_pci</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">u_char</span><span class="p">)</span><span class="n">HFCPCI_IRQ_ENABLE</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_INT_M2</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * free hardware resources used by driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">release_io_hfcpci</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_pci</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* disable memory mapped ports + busmaster */</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifos</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dmahandle</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">pci_io</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set mode (NT or TE)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcpci_setmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_pci</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_S0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">clkdel</span> <span class="o">=</span> <span class="n">CLKDEL_NT</span><span class="p">;</span>	<span class="cm">/* ST-Bit delay for NT-Mode */</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">SCTRL_MODE_NT</span><span class="p">;</span>	<span class="cm">/* NT-MODE */</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">states</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* G1 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">clkdel</span> <span class="o">=</span> <span class="n">CLKDEL_TE</span><span class="p">;</span>	<span class="cm">/* ST-Bit delay for TE-Mode */</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCTRL_MODE_NT</span><span class="p">;</span>	<span class="cm">/* TE-MODE */</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">states</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>		<span class="cm">/* F2 */</span>
	<span class="p">}</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_CLKDEL</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">clkdel</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="n">HFCPCI_LOAD_STATE</span> <span class="o">|</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">states</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">states</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span> <span class="cm">/* Deactivate */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_SCTRL</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * function called to reset the HFC PCI chip. A complete software reset of chip</span>
<span class="cm"> * and fifos is done.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">reset_hfcpci</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_pci</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span>	<span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;reset_hfcpci: entered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_CHIP_ID</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HFC_PCI: resetting HFC ChipId(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="cm">/* enable memory mapped ports, disable busmaster */</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">PCI_ENA_MEMIO</span><span class="p">);</span>
	<span class="n">disable_hwirq</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="cm">/* enable memory ports + busmaster */</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span>
			      <span class="n">PCI_ENA_MEMIO</span> <span class="o">+</span> <span class="n">PCI_ENA_MASTER</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_STATUS</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HFC-PCI status(%x) before reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cirm</span> <span class="o">=</span> <span class="n">HFCPCI_RESET</span><span class="p">;</span>	<span class="cm">/* Reset On */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_CIRM</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cirm</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>			<span class="cm">/* Timeout 10ms */</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cirm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Reset Off */</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_CIRM</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cirm</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_STATUS</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HFC-PCI status(%x) after reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">50000</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* max 50000 us */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">cnt</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HFC-PCI status(%x) after %dus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>

	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>	<span class="cm">/* only D fifos enabled */</span>

	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no exchange */</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">=</span> <span class="n">HFCPCI_TIM3_125</span> <span class="o">|</span> <span class="n">HFCPCI_AUTO_TIMER</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">trm</span> <span class="o">=</span> <span class="n">HFCPCI_BTRANS_THRESMASK</span><span class="p">;</span> <span class="cm">/* no echo connect , threshold */</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>	<span class="cm">/* set tx_lo mode, error in datasheet ! */</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl_e</span> <span class="o">=</span> <span class="n">HFCPCI_AUTO_AWAKE</span><span class="p">;</span>	<span class="cm">/* S/T Auto awake */</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mst_m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">))</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mst_m</span> <span class="o">|=</span> <span class="n">HFCPCI_MASTER</span><span class="p">;</span>	<span class="cm">/* HFC Master Mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_NEG_F0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">))</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mst_m</span> <span class="o">|=</span> <span class="n">HFCPCI_F0_NEGATIV</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_FIFO_EN</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_TRM</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">trm</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_SCTRL_E</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl_e</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_CTMT</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ctmt</span><span class="p">);</span>

	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">=</span> <span class="n">HFCPCI_INTS_DTRANS</span> <span class="o">|</span> <span class="n">HFCPCI_INTS_DREC</span> <span class="o">|</span>
		<span class="n">HFCPCI_INTS_L1STATE</span> <span class="o">|</span> <span class="n">HFCPCI_INTS_TIMER</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_INT_M1</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>

	<span class="cm">/* Clear already pending ints */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_INT_S1</span><span class="p">);</span>

	<span class="cm">/* set NT/TE mode */</span>
	<span class="n">hfcpci_setmode</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>

	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_MST_MODE</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mst_m</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_SCTRL_R</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl_r</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Init GCI/IOM2 in master mode</span>
<span class="cm">	 * Slots 0 and 1 are set for B-chan 1 and 2</span>
<span class="cm">	 * D- and monitor/CI channel are not enabled</span>
<span class="cm">	 * STIO1 is used as output for data, B1+B2 from ST-&gt;IOM+HFC</span>
<span class="cm">	 * STIO2 is used as data input, B1+B2 from IOM-&gt;ST</span>
<span class="cm">	 * ST B-channel send disabled -&gt; continuous 1s</span>
<span class="cm">	 * The IOM slots are always enabled</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_PCM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* set data flow directions: connect B1,B2: HFC to/from PCM */</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="mh">0x36</span><span class="p">;</span>	<span class="cm">/* set data flow directions */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_SW_DD_DU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_B1_SSL</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">);</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_B2_SSL</span><span class="p">,</span> <span class="mh">0xC1</span><span class="p">);</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_B1_RSL</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">);</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_B2_RSL</span><span class="p">,</span> <span class="mh">0xC1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_B1_SSL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_B2_SSL</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">);</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_B1_RSL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_B2_RSL</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_CONNECT</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_INT_S2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Timer function called when kernel timer expires</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcpci_Timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_pci</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">75</span><span class="p">;</span>
	<span class="cm">/* WD RESET */</span>
<span class="cm">/*</span>
<span class="cm"> *	WriteReg(hc, HFCD_DATA, HFCD_CTMT, hc-&gt;hw.ctmt | 0x80);</span>
<span class="cm"> *	add_timer(&amp;hc-&gt;hw.timer);</span>
<span class="cm"> */</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * select a b-channel entry matching and active</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span>
<span class="nf">Sel_BCS</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_pci</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">nr</span> <span class="o">&amp;</span> <span class="n">channel</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">Flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">nr</span> <span class="o">&amp;</span> <span class="n">channel</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * clear the desired B-channel rx fifo</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcpci_clear_fifo_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_pci</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span>		<span class="n">fifo_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bzfifo</span>	<span class="o">*</span><span class="n">bzr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bzr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">union</span> <span class="n">fifo_area</span> <span class="o">*</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">rxbz_b2</span><span class="p">;</span>
		<span class="n">fifo_state</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">&amp;</span> <span class="n">HFCPCI_FIFOEN_B2RX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bzr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">union</span> <span class="n">fifo_area</span> <span class="o">*</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">rxbz_b1</span><span class="p">;</span>
		<span class="n">fifo_state</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">&amp;</span> <span class="n">HFCPCI_FIFOEN_B1RX</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo_state</span><span class="p">)</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">^=</span> <span class="n">fifo_state</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_FIFO_EN</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">last_bfifo_cnt</span><span class="p">[</span><span class="n">fifo</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bzr</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">=</span> <span class="n">MAX_B_FRAMES</span><span class="p">;</span>
	<span class="n">bzr</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">=</span> <span class="n">bzr</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">;</span>	<span class="cm">/* init F pointers to remain constant */</span>
	<span class="n">bzr</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">MAX_B_FRAMES</span><span class="p">].</span><span class="n">z1</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bzr</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">MAX_B_FRAMES</span><span class="p">].</span><span class="n">z2</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bzr</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">MAX_B_FRAMES</span><span class="p">].</span><span class="n">z1</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo_state</span><span class="p">)</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">|=</span> <span class="n">fifo_state</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_FIFO_EN</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * clear the desired B-channel tx fifo</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hfcpci_clear_fifo_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_pci</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span>		<span class="n">fifo_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bzfifo</span>	<span class="o">*</span><span class="n">bzt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bzt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">union</span> <span class="n">fifo_area</span> <span class="o">*</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">txbz_b2</span><span class="p">;</span>
		<span class="n">fifo_state</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">&amp;</span> <span class="n">HFCPCI_FIFOEN_B2TX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bzt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">union</span> <span class="n">fifo_area</span> <span class="o">*</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">txbz_b1</span><span class="p">;</span>
		<span class="n">fifo_state</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">&amp;</span> <span class="n">HFCPCI_FIFOEN_B1TX</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo_state</span><span class="p">)</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">^=</span> <span class="n">fifo_state</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_FIFO_EN</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">fifo</span><span class="p">].</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_BCHANNEL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;hfcpci_clear_fifo_tx%d f1(%x) f2(%x) &quot;</span>
		       <span class="s">&quot;z1(%x) z2(%x) state(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fifo</span><span class="p">,</span> <span class="n">bzt</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">,</span> <span class="n">bzt</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">,</span>
		       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bzt</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">MAX_B_FRAMES</span><span class="p">].</span><span class="n">z1</span><span class="p">),</span>
		       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bzt</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">MAX_B_FRAMES</span><span class="p">].</span><span class="n">z2</span><span class="p">),</span>
		       <span class="n">fifo_state</span><span class="p">);</span>
	<span class="n">bzt</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">=</span> <span class="n">MAX_B_FRAMES</span><span class="p">;</span>
	<span class="n">bzt</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">=</span> <span class="n">bzt</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">;</span>	<span class="cm">/* init F pointers to remain constant */</span>
	<span class="n">bzt</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">MAX_B_FRAMES</span><span class="p">].</span><span class="n">z1</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bzt</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">MAX_B_FRAMES</span><span class="p">].</span><span class="n">z2</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifo_state</span><span class="p">)</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">|=</span> <span class="n">fifo_state</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_FIFO_EN</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">fifo</span><span class="p">].</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_BCHANNEL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;hfcpci_clear_fifo_tx%d f1(%x) f2(%x) z1(%x) z2(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fifo</span><span class="p">,</span> <span class="n">bzt</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">,</span> <span class="n">bzt</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">,</span>
		       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bzt</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">MAX_B_FRAMES</span><span class="p">].</span><span class="n">z1</span><span class="p">),</span>
		       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bzt</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">MAX_B_FRAMES</span><span class="p">].</span><span class="n">z2</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * read a complete B-frame out of the buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcpci_empty_bfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bzfifo</span> <span class="o">*</span><span class="n">bz</span><span class="p">,</span>
		   <span class="n">u_char</span> <span class="o">*</span><span class="n">bdata</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span>		<span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr1</span><span class="p">,</span> <span class="n">new_f2</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">maxlen</span><span class="p">,</span> <span class="n">new_z2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zt</span>	<span class="o">*</span><span class="n">zp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_BCHANNEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_BFIFO</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;hfcpci_empty_fifo</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">zp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">];</span>	<span class="cm">/* point to Z-Regs */</span>
	<span class="n">new_z2</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">)</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>	<span class="cm">/* new position in fifo */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_z2</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span><span class="p">))</span>
		<span class="n">new_z2</span> <span class="o">-=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>	<span class="cm">/* buffer wrap */</span>
	<span class="n">new_f2</span> <span class="o">=</span> <span class="p">(</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX_B_FRAMES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">MAX_DATA_SIZE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">bdata</span> <span class="o">+</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z1</span><span class="p">)</span> <span class="o">-</span> <span class="n">B_SUB_VAL</span><span class="p">))))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;hfcpci_empty_fifo: incoming packet &quot;</span>
			       <span class="s">&quot;invalid length %d or crc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="cp">#ifdef ERROR_STATISTIC</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">err_inv</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">new_f2</span><span class="p">].</span><span class="n">z2</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">new_z2</span><span class="p">);</span>
		<span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">=</span> <span class="n">new_f2</span><span class="p">;</span>	<span class="cm">/* next buffer */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="n">mI_alloc_skb</span><span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFCPCI: receive out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">)</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span><span class="p">)</span>
			<span class="n">maxlen</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>		<span class="cm">/* complete transfer */</span>
		<span class="k">else</span>
			<span class="n">maxlen</span> <span class="o">=</span> <span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span> <span class="o">-</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">);</span>	<span class="cm">/* maximum */</span>

		<span class="n">ptr1</span> <span class="o">=</span> <span class="n">bdata</span> <span class="o">+</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">)</span> <span class="o">-</span> <span class="n">B_SUB_VAL</span><span class="p">);</span>
		<span class="cm">/* start of data */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ptr1</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">);</span>	<span class="cm">/* copy data */</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">maxlen</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* rest remaining */</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="n">maxlen</span><span class="p">;</span>
			<span class="n">ptr1</span> <span class="o">=</span> <span class="n">bdata</span><span class="p">;</span>	<span class="cm">/* start of buffer */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ptr1</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>	<span class="cm">/* rest */</span>
		<span class="p">}</span>
		<span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">new_f2</span><span class="p">].</span><span class="n">z2</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">new_z2</span><span class="p">);</span>
		<span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">=</span> <span class="n">new_f2</span><span class="p">;</span>	<span class="cm">/* next buffer */</span>
		<span class="n">recv_Bchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * D-channel receive procedure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">receive_dmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_pci</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dchannel</span>	<span class="o">*</span><span class="n">dch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">maxlen</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">rcnt</span><span class="p">,</span> <span class="n">total</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">count</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">u_char</span>		<span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dfifo</span>	<span class="o">*</span><span class="n">df</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zt</span>	<span class="o">*</span><span class="n">zp</span><span class="p">;</span>

	<span class="n">df</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">union</span> <span class="n">fifo_area</span> <span class="o">*</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">d_chan</span><span class="p">.</span><span class="n">d_rx</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">];</span>
		<span class="n">rcnt</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z1</span><span class="p">)</span> <span class="o">-</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rcnt</span> <span class="o">+=</span> <span class="n">D_FIFO_SIZE</span><span class="p">;</span>
		<span class="n">rcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_DCHANNEL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;hfcpci recd f1(%d) f2(%d) z1(%x) z2(%x) cnt(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">,</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">,</span>
			       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z1</span><span class="p">),</span>
			       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">),</span>
			       <span class="n">rcnt</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rcnt</span> <span class="o">&gt;</span> <span class="n">MAX_DFRAME_LEN</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rcnt</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z1</span><span class="p">)]))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;empty_fifo hfcpci paket inv. len &quot;</span>
				       <span class="s">&quot;%d or crc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">rcnt</span><span class="p">,</span>
				       <span class="n">df</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z1</span><span class="p">)]);</span>
<span class="cp">#ifdef ERROR_STATISTIC</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">err_rx</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX_D_FRAMES</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">MAX_D_FRAMES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* next buffer */</span>
			<span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">].</span><span class="n">z2</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">)</span> <span class="o">+</span> <span class="n">rcnt</span><span class="p">)</span> <span class="o">&amp;</span>
					    <span class="p">(</span><span class="n">D_FIFO_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="n">mI_alloc_skb</span><span class="p">(</span><span class="n">rcnt</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				       <span class="s">&quot;HFC-PCI: D receive out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">total</span> <span class="o">=</span> <span class="n">rcnt</span><span class="p">;</span>
			<span class="n">rcnt</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">rcnt</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">)</span> <span class="o">+</span> <span class="n">rcnt</span> <span class="o">&lt;=</span> <span class="n">D_FIFO_SIZE</span><span class="p">)</span>
				<span class="n">maxlen</span> <span class="o">=</span> <span class="n">rcnt</span><span class="p">;</span>	<span class="cm">/* complete transfer */</span>
			<span class="k">else</span>
				<span class="n">maxlen</span> <span class="o">=</span> <span class="n">D_FIFO_SIZE</span> <span class="o">-</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">);</span>
			<span class="cm">/* maximum */</span>

			<span class="n">ptr1</span> <span class="o">=</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">);</span>
			<span class="cm">/* start of data */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ptr1</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">);</span>	<span class="cm">/* copy data */</span>
			<span class="n">rcnt</span> <span class="o">-=</span> <span class="n">maxlen</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rcnt</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* rest remaining */</span>
				<span class="n">ptr</span> <span class="o">+=</span> <span class="n">maxlen</span><span class="p">;</span>
				<span class="n">ptr1</span> <span class="o">=</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>	<span class="cm">/* start of buffer */</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ptr1</span><span class="p">,</span> <span class="n">rcnt</span><span class="p">);</span>	<span class="cm">/* rest */</span>
			<span class="p">}</span>
			<span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX_D_FRAMES</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">MAX_D_FRAMES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* next buffer */</span>
			<span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">].</span><span class="n">z2</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span>
									      <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">)</span> <span class="o">+</span> <span class="n">total</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">D_FIFO_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">recv_Dchannel</span><span class="p">(</span><span class="n">dch</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * check for transparent receive data and read max one &#39;poll&#39; size if avail</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcpci_empty_fifo_trans</span><span class="p">(</span><span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bzfifo</span> <span class="o">*</span><span class="n">rxbz</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">bzfifo</span> <span class="o">*</span><span class="n">txbz</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">bdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le16</span>	<span class="o">*</span><span class="n">z1r</span><span class="p">,</span> <span class="o">*</span><span class="n">z2r</span><span class="p">,</span> <span class="o">*</span><span class="n">z1t</span><span class="p">,</span> <span class="o">*</span><span class="n">z2t</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">new_z2</span><span class="p">,</span> <span class="n">fcnt_rx</span><span class="p">,</span> <span class="n">fcnt_tx</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">;</span>
	<span class="n">u_char</span>	<span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr1</span><span class="p">;</span>

	<span class="n">z1r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxbz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">MAX_B_FRAMES</span><span class="p">].</span><span class="n">z1</span><span class="p">;</span>	<span class="cm">/* pointer to z reg */</span>
	<span class="n">z2r</span> <span class="o">=</span> <span class="n">z1r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">z1t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txbz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">MAX_B_FRAMES</span><span class="p">].</span><span class="n">z1</span><span class="p">;</span>
	<span class="n">z2t</span> <span class="o">=</span> <span class="n">z1t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">fcnt_rx</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">z1r</span><span class="p">)</span> <span class="o">-</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">z2r</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcnt_rx</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>	<span class="cm">/* no data avail */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fcnt_rx</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fcnt_rx</span> <span class="o">+=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>	<span class="cm">/* bytes actually buffered */</span>
	<span class="n">new_z2</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">z2r</span><span class="p">)</span> <span class="o">+</span> <span class="n">fcnt_rx</span><span class="p">;</span>	<span class="cm">/* new position in fifo */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_z2</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span><span class="p">))</span>
		<span class="n">new_z2</span> <span class="o">-=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>	<span class="cm">/* buffer wrap */</span>

	<span class="n">fcnt_tx</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">z2t</span><span class="p">)</span> <span class="o">-</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">z1t</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcnt_tx</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fcnt_tx</span> <span class="o">+=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>
	<span class="cm">/* fcnt_tx contains available bytes in tx-fifo */</span>
	<span class="n">fcnt_tx</span> <span class="o">=</span> <span class="n">B_FIFO_SIZE</span> <span class="o">-</span> <span class="n">fcnt_tx</span><span class="p">;</span>
	<span class="cm">/* remaining bytes to send (bytes in tx-fifo) */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_RX_OFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">dropcnt</span> <span class="o">+=</span> <span class="n">fcnt_rx</span><span class="p">;</span>
		<span class="o">*</span><span class="n">z2r</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">new_z2</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">maxlen</span> <span class="o">=</span> <span class="n">bchannel_get_rxbuf</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">fcnt_rx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxlen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;B%d: No bufferspace for %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">fcnt_rx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">fcnt_rx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">z2r</span><span class="p">)</span> <span class="o">+</span> <span class="n">fcnt_rx</span> <span class="o">&lt;=</span> <span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span><span class="p">)</span>
			<span class="n">maxlen</span> <span class="o">=</span> <span class="n">fcnt_rx</span><span class="p">;</span>	<span class="cm">/* complete transfer */</span>
		<span class="k">else</span>
			<span class="n">maxlen</span> <span class="o">=</span> <span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span> <span class="o">-</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">z2r</span><span class="p">);</span>
		<span class="cm">/* maximum */</span>

		<span class="n">ptr1</span> <span class="o">=</span> <span class="n">bdata</span> <span class="o">+</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">z2r</span><span class="p">)</span> <span class="o">-</span> <span class="n">B_SUB_VAL</span><span class="p">);</span>
		<span class="cm">/* start of data */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ptr1</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">);</span>	<span class="cm">/* copy data */</span>
		<span class="n">fcnt_rx</span> <span class="o">-=</span> <span class="n">maxlen</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fcnt_rx</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* rest remaining */</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="n">maxlen</span><span class="p">;</span>
			<span class="n">ptr1</span> <span class="o">=</span> <span class="n">bdata</span><span class="p">;</span>	<span class="cm">/* start of buffer */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ptr1</span><span class="p">,</span> <span class="n">fcnt_rx</span><span class="p">);</span>	<span class="cm">/* rest */</span>
		<span class="p">}</span>
		<span class="n">recv_Bchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">fcnt_tx</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="cm">/* bch, id, !force */</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">z2r</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">new_z2</span><span class="p">);</span>		<span class="cm">/* new position */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * B-channel main receive routine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">main_rec_hfcpci</span><span class="p">(</span><span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfc_pci</span>	<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">rcnt</span><span class="p">,</span> <span class="n">real_fifo</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">receive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bzfifo</span>	<span class="o">*</span><span class="n">txbz</span><span class="p">,</span> <span class="o">*</span><span class="n">rxbz</span><span class="p">;</span>
	<span class="n">u_char</span>		<span class="o">*</span><span class="n">bdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zt</span>	<span class="o">*</span><span class="n">zp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bswapped</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rxbz</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">union</span> <span class="n">fifo_area</span> <span class="o">*</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">rxbz_b2</span><span class="p">;</span>
		<span class="n">txbz</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">union</span> <span class="n">fifo_area</span> <span class="o">*</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">txbz_b2</span><span class="p">;</span>
		<span class="n">bdata</span> <span class="o">=</span> <span class="p">((</span><span class="k">union</span> <span class="n">fifo_area</span> <span class="o">*</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">rxdat_b2</span><span class="p">;</span>
		<span class="n">real_fifo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rxbz</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">union</span> <span class="n">fifo_area</span> <span class="o">*</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">rxbz_b1</span><span class="p">;</span>
		<span class="n">txbz</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">union</span> <span class="n">fifo_area</span> <span class="o">*</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">txbz_b1</span><span class="p">;</span>
		<span class="n">bdata</span> <span class="o">=</span> <span class="p">((</span><span class="k">union</span> <span class="n">fifo_area</span> <span class="o">*</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">rxdat_b1</span><span class="p">;</span>
		<span class="n">real_fifo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">Begin:</span>
	<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxbz</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">!=</span> <span class="n">rxbz</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_BCHANNEL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;hfcpci rec ch(%x) f1(%d) f2(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">rxbz</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">,</span> <span class="n">rxbz</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">);</span>
		<span class="n">zp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxbz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">rxbz</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">];</span>

		<span class="n">rcnt</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z1</span><span class="p">)</span> <span class="o">-</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rcnt</span> <span class="o">+=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>
		<span class="n">rcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_BCHANNEL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;hfcpci rec ch(%x) z1(%x) z2(%x) cnt(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z1</span><span class="p">),</span>
			       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">z2</span><span class="p">),</span> <span class="n">rcnt</span><span class="p">);</span>
		<span class="n">hfcpci_empty_bfifo</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">rxbz</span><span class="p">,</span> <span class="n">bdata</span><span class="p">,</span> <span class="n">rcnt</span><span class="p">);</span>
		<span class="n">rcnt</span> <span class="o">=</span> <span class="n">rxbz</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">-</span> <span class="n">rxbz</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rcnt</span> <span class="o">+=</span> <span class="n">MAX_B_FRAMES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">last_bfifo_cnt</span><span class="p">[</span><span class="n">real_fifo</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rcnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hfcpci_clear_fifo_rx</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">real_fifo</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">last_bfifo_cnt</span><span class="p">[</span><span class="n">real_fifo</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">receive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">receive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_TRANSPARENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hfcpci_empty_fifo_trans</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">rxbz</span><span class="p">,</span> <span class="n">txbz</span><span class="p">,</span> <span class="n">bdata</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">receive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="n">receive</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">Begin</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * D-channel send routine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcpci_fill_dfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_pci</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dchannel</span>	<span class="o">*</span><span class="n">dch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">fcnt</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">count</span><span class="p">,</span> <span class="n">new_z1</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dfifo</span>	<span class="o">*</span><span class="n">df</span><span class="p">;</span>
	<span class="n">u_char</span>		<span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">new_f1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_DCHANNEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_DFIFO</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_idx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">df</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">union</span> <span class="n">fifo_area</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">d_chan</span><span class="p">.</span><span class="n">d_tx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_DFIFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s:f1(%d) f2(%d) z1(f1)(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">,</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">,</span>
		       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">].</span><span class="n">z1</span><span class="p">));</span>
	<span class="n">fcnt</span> <span class="o">=</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">-</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">;</span>	<span class="cm">/* frame count actually buffered */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fcnt</span> <span class="o">+=</span> <span class="p">(</span><span class="n">MAX_D_FRAMES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* if wrap around */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcnt</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">MAX_D_FRAMES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_DCHANNEL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;hfcpci_fill_Dfifo more as 14 frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifdef ERROR_STATISTIC</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">err_tx</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* now determine free bytes in FIFO buffer */</span>
	<span class="n">maxlen</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">].</span><span class="n">z2</span><span class="p">)</span> <span class="o">-</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">].</span><span class="n">z1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxlen</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">maxlen</span> <span class="o">+=</span> <span class="n">D_FIFO_SIZE</span><span class="p">;</span>	<span class="cm">/* count now contains available bytes */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_DCHANNEL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;hfcpci_fill_Dfifo count(%d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">count</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">maxlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_DCHANNEL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;hfcpci_fill_Dfifo no fifo mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">new_z1</span> <span class="o">=</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">].</span><span class="n">z1</span><span class="p">)</span> <span class="o">+</span> <span class="n">count</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">D_FIFO_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">new_f1</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">D_FREG_MASK</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">src</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_idx</span><span class="p">;</span>	<span class="cm">/* source pointer */</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">].</span><span class="n">z1</span><span class="p">);</span>
	<span class="n">maxlen</span> <span class="o">=</span> <span class="n">D_FIFO_SIZE</span> <span class="o">-</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">].</span><span class="n">z1</span><span class="p">);</span>
	<span class="cm">/* end fifo */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxlen</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
		<span class="n">maxlen</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>	<span class="cm">/* limit size */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">);</span>	<span class="cm">/* first copy */</span>

	<span class="n">count</span> <span class="o">-=</span> <span class="n">maxlen</span><span class="p">;</span>	<span class="cm">/* remaining bytes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>	<span class="cm">/* start of buffer */</span>
		<span class="n">src</span> <span class="o">+=</span> <span class="n">maxlen</span><span class="p">;</span>	<span class="cm">/* new position */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">new_f1</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">].</span><span class="n">z1</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">new_z1</span><span class="p">);</span>
	<span class="cm">/* for next buffer */</span>
	<span class="n">df</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">&amp;</span> <span class="n">D_FREG_MASK</span><span class="p">].</span><span class="n">z1</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">new_z1</span><span class="p">);</span>
	<span class="cm">/* new pos actual buffer */</span>
	<span class="n">df</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">=</span> <span class="n">new_f1</span><span class="p">;</span>	<span class="cm">/* next frame */</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_idx</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * B-channel send routine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcpci_fill_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfc_pci</span>	<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">maxlen</span><span class="p">,</span> <span class="n">fcnt</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">count</span><span class="p">,</span> <span class="n">new_z1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bzfifo</span>	<span class="o">*</span><span class="n">bz</span><span class="p">;</span>
	<span class="n">u_char</span>		<span class="o">*</span><span class="n">bdata</span><span class="p">;</span>
	<span class="n">u_char</span>		<span class="n">new_f1</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">z1t</span><span class="p">,</span> <span class="o">*</span><span class="n">z2t</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_BCHANNEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_BFIFO</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="o">||</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_FILLEMPTY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_TRANSPARENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">HFCPCI_FILLEMPTY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_idx</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bswapped</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bz</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">union</span> <span class="n">fifo_area</span> <span class="o">*</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">txbz_b2</span><span class="p">;</span>
		<span class="n">bdata</span> <span class="o">=</span> <span class="p">((</span><span class="k">union</span> <span class="n">fifo_area</span> <span class="o">*</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">txdat_b2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bz</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">union</span> <span class="n">fifo_area</span> <span class="o">*</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">txbz_b1</span><span class="p">;</span>
		<span class="n">bdata</span> <span class="o">=</span> <span class="p">((</span><span class="k">union</span> <span class="n">fifo_area</span> <span class="o">*</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifos</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">b_chans</span><span class="p">.</span><span class="n">txdat_b1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_TRANSPARENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">z1t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">MAX_B_FRAMES</span><span class="p">].</span><span class="n">z1</span><span class="p">;</span>
		<span class="n">z2t</span> <span class="o">=</span> <span class="n">z1t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_BCHANNEL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;hfcpci_fill_fifo_trans ch(%x) &quot;</span>
			       <span class="s">&quot;cnt(%d) z1(%x) z2(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
			       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">z1t</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">z2t</span><span class="p">));</span>
		<span class="n">fcnt</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">z2t</span><span class="p">)</span> <span class="o">-</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">z1t</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcnt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fcnt</span> <span class="o">+=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_FILLEMPTY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* fcnt contains available bytes in fifo */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">fcnt</span><span class="p">)</span>
				<span class="n">count</span> <span class="o">=</span> <span class="n">fcnt</span><span class="p">;</span>
			<span class="n">new_z1</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">z1t</span><span class="p">)</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
			<span class="cm">/* new buffer Position */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_z1</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span><span class="p">))</span>
				<span class="n">new_z1</span> <span class="o">-=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>	<span class="cm">/* buffer wrap */</span>
			<span class="n">dst</span> <span class="o">=</span> <span class="n">bdata</span> <span class="o">+</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">z1t</span><span class="p">)</span> <span class="o">-</span> <span class="n">B_SUB_VAL</span><span class="p">);</span>
			<span class="n">maxlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span><span class="p">)</span> <span class="o">-</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">z1t</span><span class="p">);</span>
			<span class="cm">/* end of fifo */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_BFIFO</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;hfcpci_FFt fillempty &quot;</span>
				       <span class="s">&quot;fcnt(%d) maxl(%d) nz1(%x) dst(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">fcnt</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">,</span> <span class="n">new_z1</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">maxlen</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
				<span class="n">maxlen</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>		<span class="cm">/* limit size */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">fill</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">maxlen</span><span class="p">);</span> <span class="cm">/* first copy */</span>
			<span class="n">count</span> <span class="o">-=</span> <span class="n">maxlen</span><span class="p">;</span>		<span class="cm">/* remaining bytes */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dst</span> <span class="o">=</span> <span class="n">bdata</span><span class="p">;</span>		<span class="cm">/* start of buffer */</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">fill</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">count</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">z1t</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">new_z1</span><span class="p">);</span>	<span class="cm">/* now send data */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* fcnt contains available bytes in fifo */</span>
		<span class="n">fcnt</span> <span class="o">=</span> <span class="n">B_FIFO_SIZE</span> <span class="o">-</span> <span class="n">fcnt</span><span class="p">;</span>
		<span class="cm">/* remaining bytes to send (bytes in fifo) */</span>

	<span class="nl">next_t_frame:</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_idx</span><span class="p">;</span>
		<span class="cm">/* maximum fill shall be poll*2 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">poll</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">fcnt</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">poll</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">fcnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="cm">/* data is suitable for fifo */</span>
		<span class="n">new_z1</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">z1t</span><span class="p">)</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
		<span class="cm">/* new buffer Position */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_z1</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span><span class="p">))</span>
			<span class="n">new_z1</span> <span class="o">-=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>	<span class="cm">/* buffer wrap */</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_idx</span><span class="p">;</span>
		<span class="cm">/* source pointer */</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">bdata</span> <span class="o">+</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">z1t</span><span class="p">)</span> <span class="o">-</span> <span class="n">B_SUB_VAL</span><span class="p">);</span>
		<span class="n">maxlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span><span class="p">)</span> <span class="o">-</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">z1t</span><span class="p">);</span>
		<span class="cm">/* end of fifo */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_BFIFO</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;hfcpci_FFt fcnt(%d) &quot;</span>
			       <span class="s">&quot;maxl(%d) nz1(%x) dst(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">fcnt</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">,</span> <span class="n">new_z1</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
		<span class="n">fcnt</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_idx</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">maxlen</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
			<span class="n">maxlen</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>		<span class="cm">/* limit size */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">);</span>	<span class="cm">/* first copy */</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">maxlen</span><span class="p">;</span>	<span class="cm">/* remaining bytes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dst</span> <span class="o">=</span> <span class="n">bdata</span><span class="p">;</span>	<span class="cm">/* start of buffer */</span>
			<span class="n">src</span> <span class="o">+=</span> <span class="n">maxlen</span><span class="p">;</span>	<span class="cm">/* new position */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">z1t</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">new_z1</span><span class="p">);</span>	<span class="cm">/* now send data */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_idx</span> <span class="o">&lt;</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_next_bframe</span><span class="p">(</span><span class="n">bch</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">next_t_frame</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_BCHANNEL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;%s: ch(%x) f1(%d) f2(%d) z1(f1)(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">,</span> <span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">,</span>
		       <span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">].</span><span class="n">z1</span><span class="p">);</span>
	<span class="n">fcnt</span> <span class="o">=</span> <span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">-</span> <span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">;</span>	<span class="cm">/* frame count actually buffered */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fcnt</span> <span class="o">+=</span> <span class="p">(</span><span class="n">MAX_B_FRAMES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* if wrap around */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcnt</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">MAX_B_FRAMES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_BCHANNEL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;hfcpci_fill_Bfifo more as 14 frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* now determine free bytes in FIFO buffer */</span>
	<span class="n">maxlen</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f2</span><span class="p">].</span><span class="n">z2</span><span class="p">)</span> <span class="o">-</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">].</span><span class="n">z1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxlen</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">maxlen</span> <span class="o">+=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>	<span class="cm">/* count now contains available bytes */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_BCHANNEL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;hfcpci_fill_fifo ch(%x) count(%d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">maxlen</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_BCHANNEL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;hfcpci_fill_fifo no fifo mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">new_z1</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">].</span><span class="n">z1</span><span class="p">)</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>
	<span class="cm">/* new buffer Position */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_z1</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span><span class="p">))</span>
		<span class="n">new_z1</span> <span class="o">-=</span> <span class="n">B_FIFO_SIZE</span><span class="p">;</span>	<span class="cm">/* buffer wrap */</span>

	<span class="n">new_f1</span> <span class="o">=</span> <span class="p">((</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX_B_FRAMES</span><span class="p">);</span>
	<span class="n">src</span> <span class="o">=</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_idx</span><span class="p">;</span>	<span class="cm">/* source pointer */</span>
	<span class="n">dst</span> <span class="o">=</span> <span class="n">bdata</span> <span class="o">+</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">].</span><span class="n">z1</span><span class="p">)</span> <span class="o">-</span> <span class="n">B_SUB_VAL</span><span class="p">);</span>
	<span class="n">maxlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">B_FIFO_SIZE</span> <span class="o">+</span> <span class="n">B_SUB_VAL</span><span class="p">)</span> <span class="o">-</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span><span class="p">].</span><span class="n">z1</span><span class="p">);</span>
	<span class="cm">/* end fifo */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maxlen</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
		<span class="n">maxlen</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>	<span class="cm">/* limit size */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">);</span>	<span class="cm">/* first copy */</span>

	<span class="n">count</span> <span class="o">-=</span> <span class="n">maxlen</span><span class="p">;</span>	<span class="cm">/* remaining bytes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">bdata</span><span class="p">;</span>	<span class="cm">/* start of buffer */</span>
		<span class="n">src</span> <span class="o">+=</span> <span class="n">maxlen</span><span class="p">;</span>	<span class="cm">/* new position */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bz</span><span class="o">-&gt;</span><span class="n">za</span><span class="p">[</span><span class="n">new_f1</span><span class="p">].</span><span class="n">z1</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">new_z1</span><span class="p">);</span>	<span class="cm">/* for next buffer */</span>
	<span class="n">bz</span><span class="o">-&gt;</span><span class="n">f1</span> <span class="o">=</span> <span class="n">new_f1</span><span class="p">;</span>	<span class="cm">/* next frame */</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
	<span class="n">get_next_bframe</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * handle L1 state changes TE</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ph_state_te</span><span class="p">(</span><span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: TE newstate %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">HW_RESET_IND</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">HW_DEACT_IND</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">ANYSIGNAL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">INFO2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">INFO4_P8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * handle L1 state changes NT</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">handle_nt_timer3</span><span class="p">(</span><span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfc_pci</span>	<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_HFC_TIMER_T3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_INTS_TIMER</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_INT_M1</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">))</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mst_m</span> <span class="o">|=</span> <span class="n">HFCPCI_MASTER</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_MST_MODE</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mst_m</span><span class="p">);</span>
	<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">PH_ACTIVATE_IND</span><span class="p">,</span>
		    <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ph_state_nt</span><span class="p">(</span><span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfc_pci</span>	<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: NT newstate %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">nt_timer</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_HFC_TIMER_T3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_HFC_TIMER_T1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_INTS_TIMER</span><span class="p">;</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_INT_M1</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
			<span class="cm">/* Clear already pending ints */</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_INT_S1</span><span class="p">);</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">HFCPCI_LOAD_STATE</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">nt_timer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="n">HFCPCI_INTS_TIMER</span><span class="p">;</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_INT_M1</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="n">NT_T1_COUNT</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_AUTO_TIMER</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">|=</span> <span class="n">HFCPCI_TIM3_125</span><span class="p">;</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_CTMT</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">|</span>
				  <span class="n">HFCPCI_CLTIMER</span><span class="p">);</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_HFC_TIMER_T3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
			<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_HFC_TIMER_T1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
			<span class="cm">/* allow G2 -&gt; G3 transition */</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">HFCPCI_NT_G2_G3</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">HFCPCI_NT_G2_G3</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_HFC_TIMER_T3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_HFC_TIMER_T1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_INTS_TIMER</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_INT_M1</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mst_m</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_MASTER</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_MST_MODE</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mst_m</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L2_ACTIVATED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">PH_DEACTIVATE_IND</span><span class="p">,</span>
			    <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_HFC_TIMER_T3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_HFC_TIMER_T1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_INTS_TIMER</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_INT_M1</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_HFC_TIMER_T3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L2_ACTIVATED</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">handle_nt_timer3</span><span class="p">(</span><span class="n">dch</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_HFC_TIMER_T1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="n">HFCPCI_INTS_TIMER</span><span class="p">;</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_INT_M1</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="n">NT_T3_COUNT</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_AUTO_TIMER</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">|=</span> <span class="n">HFCPCI_TIM3_125</span><span class="p">;</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_CTMT</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">|</span>
				  <span class="n">HFCPCI_CLTIMER</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ph_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfc_pci</span>	<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_S0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_HFC_TIMER_T3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">nt_timer</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">handle_nt_timer3</span><span class="p">(</span><span class="n">dch</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ph_state_nt</span><span class="p">(</span><span class="n">dch</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ph_state_te</span><span class="p">(</span><span class="n">dch</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Layer 1 callback function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfc_l1callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfc_pci</span>		<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INFO3_P8</span>:
	<span class="k">case</span> <span class="n">INFO3_P10</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">))</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mst_m</span> <span class="o">|=</span> <span class="n">HFCPCI_MASTER</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_MST_MODE</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mst_m</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_RESET_REQ</span>:
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="n">HFCPCI_LOAD_STATE</span> <span class="o">|</span> <span class="mi">3</span><span class="p">);</span>
		<span class="cm">/* HFC ST 3 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>	<span class="cm">/* HFC ST 2 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">))</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mst_m</span> <span class="o">|=</span> <span class="n">HFCPCI_MASTER</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_MST_MODE</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mst_m</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="n">HFCPCI_ACTIVATE</span> <span class="o">|</span>
			  <span class="n">HFCPCI_DO_ACTION</span><span class="p">);</span>
		<span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">HW_POWERUP_IND</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_DEACT_REQ</span>:
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mst_m</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_MASTER</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_MST_MODE</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mst_m</span><span class="p">);</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
			<span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
			<span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_TX_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_BUSY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_POWERUP_REQ</span>:
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="n">HFCPCI_DO_ACTION</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_ACTIVATE_IND</span>:
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_DEACTIVATE_IND</span>:
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: unknown command %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Interrupt handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">tx_birq</span><span class="p">(</span><span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">&amp;&amp;</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_idx</span> <span class="o">&lt;</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="n">hfcpci_fill_fifo</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_next_bframe</span><span class="p">(</span><span class="n">bch</span><span class="p">))</span>
			<span class="n">hfcpci_fill_fifo</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">tx_dirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">&amp;&amp;</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_idx</span> <span class="o">&lt;</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="n">hfcpci_fill_dfifo</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_next_dframe</span><span class="p">(</span><span class="n">dch</span><span class="p">))</span>
			<span class="n">hfcpci_fill_dfifo</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">hfcpci_int</span><span class="p">(</span><span class="kt">int</span> <span class="n">intno</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfc_pci</span>	<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u_char</span>		<span class="n">exval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bchannel</span>	<span class="o">*</span><span class="n">bch</span><span class="p">;</span>
	<span class="n">u_char</span>		<span class="n">val</span><span class="p">,</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m2</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span> <span class="cm">/* not initialised */</span>
	<span class="p">}</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HFCPCI_ANYINT</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_INT_S1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_DCHANNEL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;HFC-PCI: stat(%02x) s1(%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* shared */</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">irqcnt</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_DCHANNEL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HFC-PCI irq %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* state machine irq */</span>
		<span class="n">exval</span> <span class="o">=</span> <span class="n">Read_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_DCHANNEL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ph_state chg %d-&gt;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">exval</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">exval</span><span class="p">;</span>
		<span class="n">schedule_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">,</span> <span class="n">FLG_PHCHANGE</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* timer irq */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_S0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">--</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">nt_timer</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">schedule_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">,</span> <span class="n">FLG_PHCHANGE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_CTMT</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">|</span> <span class="n">HFCPCI_CLTIMER</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* B1 rx */</span>
		<span class="n">bch</span> <span class="o">=</span> <span class="n">Sel_BCS</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="p">)</span>
			<span class="n">main_rec_hfcpci</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;hfcpci spurious 0x08 IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* B2 rx */</span>
		<span class="n">bch</span> <span class="o">=</span> <span class="n">Sel_BCS</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="p">)</span>
			<span class="n">main_rec_hfcpci</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;hfcpci spurious 0x10 IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* B1 tx */</span>
		<span class="n">bch</span> <span class="o">=</span> <span class="n">Sel_BCS</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="p">)</span>
			<span class="n">tx_birq</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;hfcpci spurious 0x01 IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* B2 tx */</span>
		<span class="n">bch</span> <span class="o">=</span> <span class="n">Sel_BCS</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="p">)</span>
			<span class="n">tx_birq</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;hfcpci spurious 0x02 IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>		<span class="cm">/* D rx */</span>
		<span class="n">receive_dmsg</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* D tx */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_BUSY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">Flags</span><span class="p">))</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">tx_dirq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * timer callback for D-chan busy resolution. Currently no function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcpci_dbusy_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_pci</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * activate/deactivate hardware for selected channels and mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mode_hfcpci</span><span class="p">(</span><span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfc_pci</span>	<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">fifo2</span><span class="p">;</span>
	<span class="n">u_char</span>		<span class="n">rx_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tx_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pcm_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_BCHANNEL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;HFCPCI bchannel protocol %x--&gt;%x ch %x--&gt;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">bc</span><span class="p">);</span>

	<span class="n">fifo2</span> <span class="o">=</span> <span class="n">bc</span><span class="p">;</span>
	<span class="n">pcm_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">bc</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcm_mode</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* PCM SLOT USE */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_PCM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;%s: pcm channel id without HFC_CFG_PCM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rx_slot</span> <span class="o">=</span> <span class="p">(</span><span class="n">bc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">tx_slot</span> <span class="o">=</span> <span class="p">(</span><span class="n">bc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">bc</span> <span class="o">=</span> <span class="n">bc</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_PCM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">&gt;</span> <span class="n">ISDN_P_NONE</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: no pcm channel id but HFC_CFG_PCM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chanlimit</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* B1 and B2 normal mode */</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl_e</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">ISDN_P_NONE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* B1 and B2 exchanged */</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl_e</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* B1 and B2 normal mode */</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl_e</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">fifo2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* B1 and B2 normal mode */</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl_e</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>: <span class="cm">/* used for init */</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="n">bc</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_P_NONE</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISDN_P_NONE</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fifo2</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_FIFOEN_B2</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HFCPCI_INTS_B2TRANS</span> <span class="o">+</span>
					   <span class="n">HFCPCI_INTS_B2REC</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_FIFOEN_B1</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HFCPCI_INTS_B1TRANS</span> <span class="o">+</span>
					   <span class="n">HFCPCI_INTS_B1REC</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#ifdef REVERSE_BITORDER</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cirm</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cirm</span> <span class="o">&amp;=</span> <span class="mh">0xbf</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ISDN_P_NONE</span><span class="p">;</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="n">bc</span><span class="p">;</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_HDLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_TRANSPARENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_P_B_RAW</span><span class="p">)</span>:
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">;</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="n">bc</span><span class="p">;</span>
		<span class="n">hfcpci_clear_fifo_rx</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="p">(</span><span class="n">fifo2</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hfcpci_clear_fifo_tx</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="p">(</span><span class="n">fifo2</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">|=</span> <span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
<span class="cp">#ifdef REVERSE_BITORDER</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cirm</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">|=</span> <span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
<span class="cp">#ifdef REVERSE_BITORDER</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cirm</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fifo2</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">|=</span> <span class="n">HFCPCI_FIFOEN_B2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tics</span><span class="p">)</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HFCPCI_INTS_B2TRANS</span> <span class="o">+</span>
						  <span class="n">HFCPCI_INTS_B2REC</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x18</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">|=</span> <span class="n">HFCPCI_FIFOEN_B1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tics</span><span class="p">)</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HFCPCI_INTS_B1TRANS</span> <span class="o">+</span>
						  <span class="n">HFCPCI_INTS_B1REC</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_TRANSPARENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_P_B_HDLC</span><span class="p">)</span>:
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">;</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="n">bc</span><span class="p">;</span>
		<span class="n">hfcpci_clear_fifo_rx</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="p">(</span><span class="n">fifo2</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hfcpci_clear_fifo_tx</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="p">(</span><span class="n">fifo2</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">|=</span> <span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl</span> <span class="o">|=</span> <span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">|=</span> <span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fifo2</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">last_bfifo_cnt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">|=</span> <span class="n">HFCPCI_FIFOEN_B2</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HFCPCI_INTS_B2TRANS</span> <span class="o">+</span>
					  <span class="n">HFCPCI_INTS_B2REC</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">2</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x18</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">last_bfifo_cnt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">|=</span> <span class="n">HFCPCI_FIFOEN_B1</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HFCPCI_INTS_B1TRANS</span> <span class="o">+</span>
					  <span class="n">HFCPCI_INTS_B1REC</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_HDLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;prot not known %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">protocol</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_PCM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NONE</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">protocol</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* init case */</span>
			<span class="n">rx_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tx_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_SW_DD_DU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rx_slot</span> <span class="o">|=</span> <span class="mh">0xC0</span><span class="p">;</span>
				<span class="n">tx_slot</span> <span class="o">|=</span> <span class="mh">0xC0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rx_slot</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="n">tx_slot</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;=</span> <span class="mh">0xc7</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Write_hfc: B2_SSL 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">tx_slot</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Write_hfc: B2_RSL 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">rx_slot</span><span class="p">);</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_B2_SSL</span><span class="p">,</span> <span class="n">tx_slot</span><span class="p">);</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_B2_RSL</span><span class="p">,</span> <span class="n">rx_slot</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;=</span> <span class="mh">0xf8</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Write_hfc: B1_SSL 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">tx_slot</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Write_hfc: B1_RSL 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">rx_slot</span><span class="p">);</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_B1_SSL</span><span class="p">,</span> <span class="n">tx_slot</span><span class="p">);</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_B1_RSL</span><span class="p">,</span> <span class="n">rx_slot</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_SCTRL_E</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl_e</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_INT_M1</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_FIFO_EN</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_SCTRL</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_SCTRL_R</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl_r</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_CTMT</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ctmt</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_CONNECT</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span><span class="p">);</span>
<span class="cp">#ifdef REVERSE_BITORDER</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_CIRM</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cirm</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">set_hfcpci_rxtest</span><span class="p">(</span><span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfc_pci</span>	<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_BCHANNEL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;HFCPCI bchannel test rx protocol %x--&gt;%x ch %x--&gt;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">!=</span> <span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;HFCPCI rxtest wrong channel parameter %x/%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_P_B_RAW</span><span class="p">)</span>:
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">;</span>
		<span class="n">hfcpci_clear_fifo_rx</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">|=</span> <span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">|=</span> <span class="n">HFCPCI_FIFOEN_B2RX</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tics</span><span class="p">)</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="n">HFCPCI_INTS_B2REC</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x18</span><span class="p">;</span>
<span class="cp">#ifdef REVERSE_BITORDER</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cirm</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">|=</span> <span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">|=</span> <span class="n">HFCPCI_FIFOEN_B1RX</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tics</span><span class="p">)</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="n">HFCPCI_INTS_B1REC</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>
<span class="cp">#ifdef REVERSE_BITORDER</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cirm</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_P_B_HDLC</span><span class="p">)</span>:
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">;</span>
		<span class="n">hfcpci_clear_fifo_rx</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">|=</span> <span class="n">SCTRL_B2_ENA</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">last_bfifo_cnt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">|=</span> <span class="n">HFCPCI_FIFOEN_B2RX</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="n">HFCPCI_INTS_B2REC</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">2</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x18</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl_r</span> <span class="o">|=</span> <span class="n">SCTRL_B1_ENA</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">last_bfifo_cnt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span> <span class="o">|=</span> <span class="n">HFCPCI_FIFOEN_B1RX</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">|=</span> <span class="n">HFCPCI_INTS_B1REC</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ctmt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;prot not known %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">protocol</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_INT_M1</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_FIFO_EN</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifo_en</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_SCTRL_R</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">sctrl_r</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_CTMT</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ctmt</span><span class="p">);</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_CONNECT</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span><span class="p">);</span>
<span class="cp">#ifdef REVERSE_BITORDER</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_CIRM</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cirm</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">deactivate_bchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfc_pci</span>	<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u_long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mISDN_clear_bchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span>
	<span class="n">mode_hfcpci</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">ISDN_P_NONE</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Layer 1 B-channel hardware access</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">channel_bctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mISDN_ctrl_req</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mISDN_ctrl_bchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">cq</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfc_bctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mISDNchannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bchannel</span>	<span class="o">*</span><span class="n">bch</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bchannel</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hfc_pci</span>	<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u_long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: cmd:%x %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HW_TESTRX_RAW</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_hfcpci_rxtest</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">ISDN_P_B_RAW</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_TESTRX_HDLC</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_hfcpci_rxtest</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">ISDN_P_B_HDLC</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_TESTRX_OFF</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">mode_hfcpci</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">ISDN_P_NONE</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLOSE_CHANNEL</span>:
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_OPEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">deactivate_bchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ISDN_P_NONE</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">peer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CONTROL_CHANNEL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">channel_bctrl</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: unknown prim(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Layer2 -&gt; Layer 1 Dchannel data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfcpci_l2l1D</span><span class="p">(</span><span class="k">struct</span> <span class="n">mISDNchannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mISDNdevice</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mISDNdevice</span><span class="p">,</span> <span class="n">D</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dchannel</span>		<span class="o">*</span><span class="n">dch</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dchannel</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hfc_pci</span>		<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mISDNhead</span>	<span class="o">*</span><span class="n">hh</span> <span class="o">=</span> <span class="n">mISDN_HEAD_P</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">id</span><span class="p">;</span>
	<span class="n">u_long</span>			<span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PH_DATA_REQ</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dchannel_senddata</span><span class="p">(</span><span class="n">dch</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* direct TX */</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span> <span class="cm">/* skb can be freed */</span>
			<span class="n">hfcpci_fill_dfifo</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">queue_ch_frame</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_DATA_CNF</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_ACTIVATE_REQ</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_S0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">))</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mst_m</span> <span class="o">|=</span> <span class="n">HFCPCI_MASTER</span><span class="p">;</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_MST_MODE</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mst_m</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">PH_ACTIVATE_IND</span><span class="p">,</span>
					    <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_L2_ACTIVATED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="n">HFCPCI_ACTIVATE</span> <span class="o">|</span>
				  <span class="n">HFCPCI_DO_ACTION</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_DEACTIVATE_REQ</span>:
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L2_ACTIVATED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_S0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* prepare deactivation */</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_STATES</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
			<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
				<span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
				<span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_TX_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_BUSY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
				<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="cp">#ifdef FIXME</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L1_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
				<span class="n">dchannel_sched_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">,</span> <span class="n">D_CLEARBUSY</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mst_m</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_MASTER</span><span class="p">;</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_MST_MODE</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mst_m</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Layer2 -&gt; Layer 1 Bchannel data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfcpci_l2l1B</span><span class="p">(</span><span class="k">struct</span> <span class="n">mISDNchannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bchannel</span>		<span class="o">*</span><span class="n">bch</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bchannel</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hfc_pci</span>		<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mISDNhead</span>	<span class="o">*</span><span class="n">hh</span> <span class="o">=</span> <span class="n">mISDN_HEAD_P</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PH_DATA_REQ</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">bchannel_senddata</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* direct TX */</span>
			<span class="n">hfcpci_fill_fifo</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_ACTIVATE_REQ</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mode_hfcpci</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">_queue_data</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_ACTIVATE_IND</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_DEACTIVATE_REQ</span>:
		<span class="n">deactivate_bchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span>
		<span class="n">_queue_data</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_DEACTIVATE_IND</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called for card init message</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">inithfcpci</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_pci</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;inithfcpci: entered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hfcpci_dbusy_timer</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chanlimit</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">mode_hfcpci</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">mode_hfcpci</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">init_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_pci</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">cnt</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">u_long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;init_card: entered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">disable_hwirq</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hfcpci_int</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;HFC PCI&quot;</span><span class="p">,</span> <span class="n">hc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;mISDN: couldn&#39;t get interrupt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">reset_hfcpci</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inithfcpci</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Finally enable IRQ output</span>
<span class="cm">		 * this is only allowed, if an IRQ routine is already</span>
<span class="cm">		 * established for this HFC, so don&#39;t do that earlier</span>
<span class="cm">		 */</span>
		<span class="n">enable_hwirq</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* Timeout 80ms */</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">;</span>
		<span class="n">schedule_timeout</span><span class="p">((</span><span class="mi">80</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HFC PCI: IRQ %d count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">irqcnt</span><span class="p">);</span>
		<span class="cm">/* now switch timer interrupt off */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFCPCI_INTS_TIMER</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_INT_M1</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
		<span class="cm">/* reinit mode reg */</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_MST_MODE</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mst_m</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">irqcnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;HFC PCI: IRQ(%d) getting no interrupts &quot;</span>
			       <span class="s">&quot;during init %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">cnt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">reset_hfcpci</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
				<span class="n">cnt</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">initdone</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">disable_hwirq</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hc</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">channel_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_pci</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mISDN_ctrl_req</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_char</span>	<span class="n">slot</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_GETOP</span>:
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">MISDN_CTRL_LOOP</span> <span class="o">|</span> <span class="n">MISDN_CTRL_CONNECT</span> <span class="o">|</span>
			 <span class="n">MISDN_CTRL_DISCONNECT</span> <span class="o">|</span> <span class="n">MISDN_CTRL_L1_TIMER3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_LOOP</span>:
		<span class="cm">/* channel 0 disabled loop */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_SW_DD_DU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">))</span>
				<span class="n">slot</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">slot</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Write_hfc: B1_SSL/RSL 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_B1_SSL</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_B1_RSL</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_CONNECT</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_SW_DD_DU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">))</span>
				<span class="n">slot</span> <span class="o">=</span> <span class="mh">0xC1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">slot</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Write_hfc: B2_SSL/RSL 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_B2_SSL</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_B2_RSL</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x38</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x30</span><span class="p">;</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_CONNECT</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">trm</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>	<span class="cm">/* enable IOM-loop */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x09</span><span class="p">;</span>
			<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_CONNECT</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">trm</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>	<span class="cm">/* disable IOM-loop */</span>
		<span class="p">}</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_TRM</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">trm</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_CONNECT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">||</span>
		    <span class="n">cq</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_SW_DD_DU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">))</span>
			<span class="n">slot</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">slot</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Write_hfc: B1_SSL/RSL 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_B1_SSL</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_B2_RSL</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_SW_DD_DU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">))</span>
			<span class="n">slot</span> <span class="o">=</span> <span class="mh">0xC1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">slot</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Write_hfc: B2_SSL/RSL 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_B2_SSL</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_B1_RSL</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x36</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_CONNECT</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">trm</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_TRM</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">trm</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_DISCONNECT</span>:
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">=</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x09</span><span class="p">;</span>
		<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_CONNECT</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">conn</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">trm</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>	<span class="cm">/* disable IOM-loop */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_L1_TIMER3</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">l1_event</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">l1</span><span class="p">,</span> <span class="n">HW_TIMER3_VALUE</span> <span class="o">|</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: unknown Op %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">open_dchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_pci</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mISDNchannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">channel_req</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_OPEN</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: dev(%d) open from %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TODO: E-Channel */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">initdone</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">create_l1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">,</span> <span class="n">hfc_l1callback</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">init_card</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span>
				<span class="n">l1_event</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">l1</span><span class="p">,</span> <span class="n">CLOSE_CHANNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">create_l1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">,</span> <span class="n">hfc_l1callback</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
			<span class="n">hfcpci_setmode</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_S0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">_queue_data</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_ACTIVATE_IND</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span>
			    <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">ch</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:cannot get module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">open_bchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_pci</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">channel_req</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bchannel</span>		<span class="o">*</span><span class="n">bch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">bch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_OPEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span> <span class="cm">/* b-channel can be only open once */</span>
	<span class="n">bch</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">;</span> <span class="cm">/* TODO: E-channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:cannot get module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * device control function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfc_dctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mISDNchannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mISDNdevice</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mISDNdevice</span><span class="p">,</span> <span class="n">D</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dchannel</span>		<span class="o">*</span><span class="n">dch</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dchannel</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hfc_pci</span>		<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_req</span>	<span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: cmd:%x %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OPEN_CHANNEL</span>:
		<span class="n">rq</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_S0</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">open_dchannel</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">open_bchannel</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLOSE_CHANNEL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_OPEN</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: dev(%d) close from %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
			       <span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CONTROL_CHANNEL</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">channel_ctrl</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: unknown command %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">setup_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_pci</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span>	<span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mISDN: HFC-PCI driver %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hfcpci_revision</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cirm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFC-PCI: No IRQ for PCI card found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">pci_io</span> <span class="o">=</span>
		<span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">pci_io</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFC-PCI: No IO-Mem for PCI card found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Allocate memory for FIFOS */</span>
	<span class="cm">/* the memory needs to be on a 32k boundary within the first 4G */</span>
	<span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0xFFFF8000</span><span class="p">);</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dmahandle</span><span class="p">);</span>
	<span class="cm">/* We silently assume the address is okay if nonzero */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;HFC-PCI: Error allocating memory for FIFO!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifos</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dmahandle</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">pci_io</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">((</span><span class="n">ulong</span><span class="p">)</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">pci_io</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;HFC-PCI: defined at mem %#lx fifo %#lx(%#lx) IRQ %d HZ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">pci_io</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fifos</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dmahandle</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="cm">/* enable memory mapped ports, disable busmaster */</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">PCI_ENA_MEMIO</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">disable_hwirq</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">Write_hfc</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">HFCPCI_INT_M1</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m1</span><span class="p">);</span>
	<span class="cm">/* At this point the needed PCI config is done */</span>
	<span class="cm">/* fifos are still not enabled */</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hfcpci_Timer</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">hc</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="cm">/* default PCM master */</span>
	<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CFG_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">release_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_pci</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">u_long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* interrupt output off ! */</span>
	<span class="n">disable_hwirq</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="n">mode_hfcpci</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ISDN_P_NONE</span><span class="p">);</span>
	<span class="n">mode_hfcpci</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ISDN_P_NONE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span>
		<span class="n">l1_event</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">l1</span><span class="p">,</span> <span class="n">CLOSE_CHANNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">initdone</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hc</span><span class="p">);</span>
	<span class="n">release_io_hfcpci</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span> <span class="cm">/* must release after free_irq! */</span>
	<span class="n">mISDN_unregister_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mISDN_freebchannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">mISDN_freebchannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">mISDN_freedchannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">setup_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_pci</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u_int</span>		<span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="n">name</span><span class="p">[</span><span class="n">MISDN_MAX_IDLEN</span><span class="p">];</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mISDN_initdchannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">,</span> <span class="n">MAX_DFRAME_LEN_L1</span><span class="p">,</span> <span class="n">ph_state</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">hw</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">Dprotocols</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ISDN_P_NT_S0</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">Bprotocols</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ISDN_P_B_RAW</span> <span class="o">&amp;</span> <span class="n">ISDN_P_B_MASK</span><span class="p">))</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ISDN_P_B_HDLC</span> <span class="o">&amp;</span> <span class="n">ISDN_P_B_MASK</span><span class="p">));</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">send</span> <span class="o">=</span> <span class="n">hfcpci_l2l1D</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">hfc_dctrl</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">nrbchan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nr</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">set_channelmap</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">channelmap</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>
		<span class="n">mISDN_initbchannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">MAX_DATA_MEM</span><span class="p">,</span> <span class="n">poll</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ch</span><span class="p">.</span><span class="n">send</span> <span class="o">=</span> <span class="n">hfcpci_l2l1B</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ch</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">hfc_bctrl</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ch</span><span class="p">.</span><span class="n">nr</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ch</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">bchannels</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">setup_hw</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">MISDN_MAX_IDLEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;hfc-pci.%d&quot;</span><span class="p">,</span> <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mISDN_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">HFC_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HFC %d cards installed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HFC_cnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">mISDN_freebchannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">mISDN_freebchannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">mISDN_freedchannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* private data in the PCI devices list */</span>
<span class="k">struct</span> <span class="n">_hfc_map</span> <span class="p">{</span>
	<span class="n">u_int</span>	<span class="n">subtype</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">flag</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">_hfc_map</span> <span class="n">hfc_map</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span><span class="n">HFC_CCD_2BD0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;CCD/Billion/Asuscom 2BD0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_CCD_B000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Billion B000&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_CCD_B006</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Billion B006&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_CCD_B007</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Billion B007&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_CCD_B008</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Billion B008&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_CCD_B009</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Billion B009&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_CCD_B00A</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Billion B00A&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_CCD_B00B</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Billion B00B&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_CCD_B00C</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Billion B00C&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_CCD_B100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Seyeon B100&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_CCD_B700</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Primux II S0 B700&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_CCD_B701</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Primux II S0 NT B701&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_ABOCOM_2BD1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Abocom/Magitek 2BD1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_ASUS_0675</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Asuscom/Askey 675&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_BERKOM_TCONCEPT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;German telekom T-Concept&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_BERKOM_A1T</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;German telekom A1T&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_ANIGMA_MC145575</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Motorola MC145575&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_ZOLTRIX_2BD0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Zoltrix 2BD0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_DIGI_DF_M_IOM2_E</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="s">&quot;Digi International DataFire Micro V IOM2 (Europe)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_DIGI_DF_M_E</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="s">&quot;Digi International DataFire Micro V (Europe)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_DIGI_DF_M_IOM2_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="s">&quot;Digi International DataFire Micro V IOM2 (North America)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_DIGI_DF_M_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="s">&quot;Digi International DataFire Micro V (North America)&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HFC_SITECOM_DC105V2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Sitecom Connectivity DC-105 ISDN TA&quot;</span><span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">hfc_ids</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_2BD0</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B000</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B006</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B007</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B008</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B009</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B00A</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B00B</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B00C</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B100</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B700</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_B701</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ABOCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ABOCOM_2BD1</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ASUSTEK</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ASUSTEK_0675</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BERKOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_BERKOM_T_CONCEPT</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BERKOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_BERKOM_A1T</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ANIGMA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ANIGMA_MC145575</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ZOLTRIX</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ZOLTRIX_2BD0</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">DIGI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_DIGI_DF_M_IOM2_E</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">DIGI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_DIGI_DF_M_E</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">DIGI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_DIGI_DF_M_IOM2_A</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">DIGI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_DIGI_DF_M_A</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">SITECOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_SITECOM_DC105V2</span><span class="p">),</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hfc_map</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">hfc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hfc_pci</span>	<span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_hfc_map</span>	<span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_hfc_map</span> <span class="o">*</span><span class="p">)</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_pci</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;No kmem for HFC card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">subtype</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mISDN_hfcpci: found adapter %s at %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">m</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">setup_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="nf">hfc_remove_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfc_pci</span>	<span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="p">)</span>
		<span class="n">release_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: drvdata already removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">hfc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hfcpci&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">hfc_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">hfc_remove_pci</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">hfc_ids</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">_hfcpci_softirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfc_pci</span>  <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">int_m2</span> <span class="o">&amp;</span> <span class="n">HFCPCI_IRQ_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">bch</span> <span class="o">=</span> <span class="n">Sel_BCS</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bch</span> <span class="o">&amp;&amp;</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISDN_P_B_RAW</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* B1 rx&amp;tx */</span>
			<span class="n">main_rec_hfcpci</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span>
			<span class="n">tx_birq</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bch</span> <span class="o">=</span> <span class="n">Sel_BCS</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bswapped</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bch</span> <span class="o">&amp;&amp;</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISDN_P_B_RAW</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* B2 rx&amp;tx */</span>
			<span class="n">main_rec_hfcpci</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span>
			<span class="n">tx_birq</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcpci_softirq</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">driver_for_each_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hfc_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span>
				      <span class="n">_hfcpci_softirq</span><span class="p">);</span>

	<span class="cm">/* if next event would be in the past ... */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">s32</span><span class="p">)(</span><span class="n">hfc_jiffies</span> <span class="o">+</span> <span class="n">tics</span> <span class="o">-</span> <span class="n">jiffies</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hfc_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hfc_jiffies</span> <span class="o">+=</span> <span class="n">tics</span><span class="p">;</span>
	<span class="n">hfc_tl</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">hfc_jiffies</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hfc_tl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">HFC_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">poll</span><span class="p">)</span>
		<span class="n">poll</span> <span class="o">=</span> <span class="n">HFCPCI_BTRANS_THRESHOLD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">poll</span> <span class="o">!=</span> <span class="n">HFCPCI_BTRANS_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tics</span> <span class="o">=</span> <span class="p">(</span><span class="n">poll</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tics</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">tics</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">poll</span> <span class="o">=</span> <span class="p">(</span><span class="n">tics</span> <span class="o">*</span> <span class="mi">8000</span><span class="p">)</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">poll</span> <span class="o">&gt;</span> <span class="mi">256</span> <span class="o">||</span> <span class="n">poll</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Wrong poll value %d not in range &quot;</span>
			       <span class="s">&quot;of 8..256.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">poll</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">poll</span> <span class="o">!=</span> <span class="n">HFCPCI_BTRANS_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Using alternative poll value of %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">poll</span><span class="p">);</span>
		<span class="n">hfc_tl</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">hfcpci_softirq</span><span class="p">;</span>
		<span class="n">hfc_tl</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hfc_tl</span><span class="p">);</span>
		<span class="n">hfc_tl</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">tics</span><span class="p">;</span>
		<span class="n">hfc_jiffies</span> <span class="o">=</span> <span class="n">hfc_tl</span><span class="p">.</span><span class="n">expires</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hfc_tl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tics</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* indicate the use of controller&#39;s timer */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hfc_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hfc_tl</span><span class="p">))</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hfc_tl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">HFC_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hfc_tl</span><span class="p">))</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hfc_tl</span><span class="p">);</span>

	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hfc_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">HFC_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">HFC_cleanup</span><span class="p">);</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">hfc_ids</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
