<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hardware › mISDN › hfcmulti.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>hfcmulti.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * hfcmulti.c  low level driver for hfc-4s/hfc-8s/hfc-e1 based cards</span>
<span class="cm"> *</span>
<span class="cm"> * Author	Andreas Eversberg (jolly@eversberg.eu)</span>
<span class="cm"> * ported to mqueue mechanism:</span>
<span class="cm"> *		Peter Sprenger (sprengermoving-bytes.de)</span>
<span class="cm"> *</span>
<span class="cm"> * inspired by existing hfc-pci driver:</span>
<span class="cm"> * Copyright 1999  by Werner Cornelius (werner@isdn-development.de)</span>
<span class="cm"> * Copyright 2008  by Karsten Keil (kkeil@suse.de)</span>
<span class="cm"> * Copyright 2008  by Andreas Eversberg (jolly@eversberg.eu)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to Cologne Chip AG for this great controller!</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * module parameters:</span>
<span class="cm"> * type:</span>
<span class="cm"> *	By default (0), the card is automatically detected.</span>
<span class="cm"> *	Or use the following combinations:</span>
<span class="cm"> *	Bit 0-7   = 0x00001 = HFC-E1 (1 port)</span>
<span class="cm"> * or	Bit 0-7   = 0x00004 = HFC-4S (4 ports)</span>
<span class="cm"> * or	Bit 0-7   = 0x00008 = HFC-8S (8 ports)</span>
<span class="cm"> *	Bit 8     = 0x00100 = uLaw (instead of aLaw)</span>
<span class="cm"> *	Bit 9     = 0x00200 = Disable DTMF detect on all B-channels via hardware</span>
<span class="cm"> *	Bit 10    = spare</span>
<span class="cm"> *	Bit 11    = 0x00800 = Force PCM bus into slave mode. (otherwhise auto)</span>
<span class="cm"> * or   Bit 12    = 0x01000 = Force PCM bus into master mode. (otherwhise auto)</span>
<span class="cm"> *	Bit 13	  = spare</span>
<span class="cm"> *	Bit 14    = 0x04000 = Use external ram (128K)</span>
<span class="cm"> *	Bit 15    = 0x08000 = Use external ram (512K)</span>
<span class="cm"> *	Bit 16    = 0x10000 = Use 64 timeslots instead of 32</span>
<span class="cm"> * or	Bit 17    = 0x20000 = Use 128 timeslots instead of anything else</span>
<span class="cm"> *	Bit 18    = spare</span>
<span class="cm"> *	Bit 19    = 0x80000 = Send the Watchdog a Signal (Dual E1 with Watchdog)</span>
<span class="cm"> * (all other bits are reserved and shall be 0)</span>
<span class="cm"> *	example: 0x20204 one HFC-4S with dtmf detection and 128 timeslots on PCM</span>
<span class="cm"> *		 bus (PCM master)</span>
<span class="cm"> *</span>
<span class="cm"> * port: (optional or required for all ports on all installed cards)</span>
<span class="cm"> *	HFC-4S/HFC-8S only bits:</span>
<span class="cm"> *	Bit 0	  = 0x001 = Use master clock for this S/T interface</span>
<span class="cm"> *			    (ony once per chip).</span>
<span class="cm"> *	Bit 1     = 0x002 = transmitter line setup (non capacitive mode)</span>
<span class="cm"> *			    Don&#39;t use this unless you know what you are doing!</span>
<span class="cm"> *	Bit 2     = 0x004 = Disable E-channel. (No E-channel processing)</span>
<span class="cm"> *	example: 0x0001,0x0000,0x0000,0x0000 one HFC-4S with master clock</span>
<span class="cm"> *		 received from port 1</span>
<span class="cm"> *</span>
<span class="cm"> *	HFC-E1 only bits:</span>
<span class="cm"> *	Bit 0     = 0x0001 = interface: 0=copper, 1=optical</span>
<span class="cm"> *	Bit 1     = 0x0002 = reserved (later for 32 B-channels transparent mode)</span>
<span class="cm"> *	Bit 2     = 0x0004 = Report LOS</span>
<span class="cm"> *	Bit 3     = 0x0008 = Report AIS</span>
<span class="cm"> *	Bit 4     = 0x0010 = Report SLIP</span>
<span class="cm"> *	Bit 5     = 0x0020 = Report RDI</span>
<span class="cm"> *	Bit 8     = 0x0100 = Turn off CRC-4 Multiframe Mode, use double frame</span>
<span class="cm"> *			     mode instead.</span>
<span class="cm"> *	Bit 9	  = 0x0200 = Force get clock from interface, even in NT mode.</span>
<span class="cm"> * or	Bit 10	  = 0x0400 = Force put clock to interface, even in TE mode.</span>
<span class="cm"> *	Bit 11    = 0x0800 = Use direct RX clock for PCM sync rather than PLL.</span>
<span class="cm"> *			     (E1 only)</span>
<span class="cm"> *	Bit 12-13 = 0xX000 = elastic jitter buffer (1-3), Set both bits to 0</span>
<span class="cm"> *			     for default.</span>
<span class="cm"> * (all other bits are reserved and shall be 0)</span>
<span class="cm"> *</span>
<span class="cm"> * debug:</span>
<span class="cm"> *	NOTE: only one debug value must be given for all cards</span>
<span class="cm"> *	enable debugging (see hfc_multi.h for debug options)</span>
<span class="cm"> *</span>
<span class="cm"> * poll:</span>
<span class="cm"> *	NOTE: only one poll value must be given for all cards</span>
<span class="cm"> *	Give the number of samples for each fifo process.</span>
<span class="cm"> *	By default 128 is used. Decrease to reduce delay, increase to</span>
<span class="cm"> *	reduce cpu load. If unsure, don&#39;t mess with it!</span>
<span class="cm"> *	Valid is 8, 16, 32, 64, 128, 256.</span>
<span class="cm"> *</span>
<span class="cm"> * pcm:</span>
<span class="cm"> *	NOTE: only one pcm value must be given for every card.</span>
<span class="cm"> *	The PCM bus id tells the mISDNdsp module about the connected PCM bus.</span>
<span class="cm"> *	By default (0), the PCM bus id is 100 for the card that is PCM master.</span>
<span class="cm"> *	If multiple cards are PCM master (because they are not interconnected),</span>
<span class="cm"> *	each card with PCM master will have increasing PCM id.</span>
<span class="cm"> *	All PCM busses with the same ID are expected to be connected and have</span>
<span class="cm"> *	common time slots slots.</span>
<span class="cm"> *	Only one chip of the PCM bus must be master, the others slave.</span>
<span class="cm"> *	-1 means no support of PCM bus not even.</span>
<span class="cm"> *	Omit this value, if all cards are interconnected or none is connected.</span>
<span class="cm"> *	If unsure, don&#39;t give this parameter.</span>
<span class="cm"> *</span>
<span class="cm"> * dmask and bmask:</span>
<span class="cm"> *	NOTE: One dmask value must be given for every HFC-E1 card.</span>
<span class="cm"> *	If omitted, the E1 card has D-channel on time slot 16, which is default.</span>
<span class="cm"> *	dmask is a 32 bit mask. The bit must be set for an alternate time slot.</span>
<span class="cm"> *	If multiple bits are set, multiple virtual card fragments are created.</span>
<span class="cm"> *	For each bit set, a bmask value must be given. Each bit on the bmask</span>
<span class="cm"> *	value stands for a B-channel. The bmask may not overlap with dmask or</span>
<span class="cm"> *	with other bmask values for that card.</span>
<span class="cm"> *	Example: dmask=0x00020002 bmask=0x0000fffc,0xfffc0000</span>
<span class="cm"> *		This will create one fragment with D-channel on slot 1 with</span>
<span class="cm"> *		B-channels on slots 2..15, and a second fragment with D-channel</span>
<span class="cm"> *		on slot 17 with B-channels on slot 18..31. Slot 16 is unused.</span>
<span class="cm"> *	If bit 0 is set (dmask=0x00000001) the D-channel is on slot 0 and will</span>
<span class="cm"> *	not function.</span>
<span class="cm"> *	Example: dmask=0x00000001 bmask=0xfffffffe</span>
<span class="cm"> *		This will create a port with all 31 usable timeslots as</span>
<span class="cm"> *		B-channels.</span>
<span class="cm"> *	If no bits are set on bmask, no B-channel is created for that fragment.</span>
<span class="cm"> *	Example: dmask=0xfffffffe bmask=0,0,0,0.... (31 0-values for bmask)</span>
<span class="cm"> *		This will create 31 ports with one D-channel only.</span>
<span class="cm"> *	If you don&#39;t know how to use it, you don&#39;t need it!</span>
<span class="cm"> *</span>
<span class="cm"> * iomode:</span>
<span class="cm"> *	NOTE: only one mode value must be given for every card.</span>
<span class="cm"> *	-&gt; See hfc_multi.h for HFC_IO_MODE_* values</span>
<span class="cm"> *	By default, the IO mode is pci memory IO (MEMIO).</span>
<span class="cm"> *	Some cards require specific IO mode, so it cannot be changed.</span>
<span class="cm"> *	It may be useful to set IO mode to register io (REGIO) to solve</span>
<span class="cm"> *	PCI bridge problems.</span>
<span class="cm"> *	If unsure, don&#39;t give this parameter.</span>
<span class="cm"> *</span>
<span class="cm"> * clockdelay_nt:</span>
<span class="cm"> *	NOTE: only one clockdelay_nt value must be given once for all cards.</span>
<span class="cm"> *	Give the value of the clock control register (A_ST_CLK_DLY)</span>
<span class="cm"> *	of the S/T interfaces in NT mode.</span>
<span class="cm"> *	This register is needed for the TBR3 certification, so don&#39;t change it.</span>
<span class="cm"> *</span>
<span class="cm"> * clockdelay_te:</span>
<span class="cm"> *	NOTE: only one clockdelay_te value must be given once</span>
<span class="cm"> *	Give the value of the clock control register (A_ST_CLK_DLY)</span>
<span class="cm"> *	of the S/T interfaces in TE mode.</span>
<span class="cm"> *	This register is needed for the TBR3 certification, so don&#39;t change it.</span>
<span class="cm"> *</span>
<span class="cm"> * clock:</span>
<span class="cm"> *	NOTE: only one clock value must be given once</span>
<span class="cm"> *	Selects interface with clock source for mISDN and applications.</span>
<span class="cm"> *	Set to card number starting with 1. Set to -1 to disable.</span>
<span class="cm"> *	By default, the first card is used as clock source.</span>
<span class="cm"> *</span>
<span class="cm"> * hwid:</span>
<span class="cm"> *	NOTE: only one hwid value must be given once</span>
<span class="cm"> *	Enable special embedded devices with XHFC controllers.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * debug register access (never use this, it will flood your system log)</span>
<span class="cm"> * #define HFC_REGISTER_DEBUG</span>
<span class="cm"> */</span>

<span class="cp">#define HFC_MULTI_VERSION	&quot;2.03&quot;</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mISDNhw.h&gt;</span>
<span class="cp">#include &lt;linux/mISDNdsp.h&gt;</span>

<span class="cm">/*</span>
<span class="cm">  #define IRQCOUNT_DEBUG</span>
<span class="cm">  #define IRQ_DEBUG</span>
<span class="cm">*/</span>

<span class="cp">#include &quot;hfc_multi.h&quot;</span>
<span class="cp">#ifdef ECHOPREP</span>
<span class="cp">#include &quot;gaintab.h&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#define	MAX_CARDS	8</span>
<span class="cp">#define	MAX_PORTS	(8 * MAX_CARDS)</span>
<span class="cp">#define	MAX_FRAGS	(32 * MAX_CARDS)</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">HFClist</span><span class="p">);</span>
<span class="k">static</span> <span class="n">spinlock_t</span> <span class="n">HFClock</span><span class="p">;</span> <span class="cm">/* global hfc list lock */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ph_state_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">syncmaster</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">plxsd_master</span><span class="p">;</span> <span class="cm">/* if we have a master card (yet) */</span>
<span class="k">static</span> <span class="n">spinlock_t</span> <span class="n">plx_lock</span><span class="p">;</span> <span class="cm">/* may not acquire other lock inside */</span>

<span class="cp">#define	TYP_E1		1</span>
<span class="cp">#define	TYP_4S		4</span>
<span class="cp">#define TYP_8S		8</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">poll_timer</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>	<span class="cm">/* default = 128 samples = 16ms */</span>
<span class="cm">/* number of POLL_TIMER interrupts for G2 timeout (ca 1s) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nt_t1_count</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3840</span><span class="p">,</span> <span class="mi">1920</span><span class="p">,</span> <span class="mi">960</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">30</span>  <span class="p">};</span>
<span class="cp">#define	CLKDEL_TE	0x0f	</span><span class="cm">/* CLKDEL in TE mode */</span><span class="cp"></span>
<span class="cp">#define	CLKDEL_NT	0x6c	</span><span class="cm">/* CLKDEL in NT mode</span>
<span class="cm">				   (0x60 MUST be included!) */</span><span class="cp"></span>

<span class="cp">#define	DIP_4S	0x1		</span><span class="cm">/* DIP Switches for Beronet 1S/2S/4S cards */</span><span class="cp"></span>
<span class="cp">#define	DIP_8S	0x2		</span><span class="cm">/* DIP Switches for Beronet 8S+ cards */</span><span class="cp"></span>
<span class="cp">#define	DIP_E1	0x3		</span><span class="cm">/* DIP Switches for Beronet E1 cards */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * module stuff</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">uint</span>	<span class="n">type</span><span class="p">[</span><span class="n">MAX_CARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">pcm</span><span class="p">[</span><span class="n">MAX_CARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="n">uint</span>	<span class="n">dmask</span><span class="p">[</span><span class="n">MAX_CARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="n">uint</span>	<span class="n">bmask</span><span class="p">[</span><span class="n">MAX_FRAGS</span><span class="p">];</span>
<span class="k">static</span> <span class="n">uint</span>	<span class="n">iomode</span><span class="p">[</span><span class="n">MAX_CARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="n">uint</span>	<span class="n">port</span><span class="p">[</span><span class="n">MAX_PORTS</span><span class="p">];</span>
<span class="k">static</span> <span class="n">uint</span>	<span class="n">debug</span><span class="p">;</span>
<span class="k">static</span> <span class="n">uint</span>	<span class="n">poll</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">clock</span><span class="p">;</span>
<span class="k">static</span> <span class="n">uint</span>	<span class="n">timer</span><span class="p">;</span>
<span class="k">static</span> <span class="n">uint</span>	<span class="n">clockdelay_te</span> <span class="o">=</span> <span class="n">CLKDEL_TE</span><span class="p">;</span>
<span class="k">static</span> <span class="n">uint</span>	<span class="n">clockdelay_nt</span> <span class="o">=</span> <span class="n">CLKDEL_NT</span><span class="p">;</span>
<span class="cp">#define HWID_NONE	0</span>
<span class="cp">#define HWID_MINIP4	1</span>
<span class="cp">#define HWID_MINIP8	2</span>
<span class="cp">#define HWID_MINIP16	3</span>
<span class="k">static</span> <span class="n">uint</span>	<span class="n">hwid</span> <span class="o">=</span> <span class="n">HWID_NONE</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>	<span class="n">HFC_cnt</span><span class="p">,</span> <span class="n">E1_cnt</span><span class="p">,</span> <span class="n">bmask_cnt</span><span class="p">,</span> <span class="n">Port_cnt</span><span class="p">,</span> <span class="n">PCM_cnt</span> <span class="o">=</span> <span class="mi">99</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Andreas Eversberg&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">HFC_MULTI_VERSION</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">poll</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">clockdelay_te</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">clockdelay_nt</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">dmask</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">bmask</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">iomode</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">hwid</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span> <span class="cm">/* The hardware ID */</span>

<span class="cp">#ifdef HFC_REGISTER_DEBUG</span>
<span class="cp">#define HFC_outb(hc, reg, val)					\</span>
<span class="cp">	(hc-&gt;HFC_outb(hc, reg, val, __func__, __LINE__))</span>
<span class="cp">#define HFC_outb_nodebug(hc, reg, val)					\</span>
<span class="cp">	(hc-&gt;HFC_outb_nodebug(hc, reg, val, __func__, __LINE__))</span>
<span class="cp">#define HFC_inb(hc, reg)				\</span>
<span class="cp">	(hc-&gt;HFC_inb(hc, reg, __func__, __LINE__))</span>
<span class="cp">#define HFC_inb_nodebug(hc, reg)				\</span>
<span class="cp">	(hc-&gt;HFC_inb_nodebug(hc, reg, __func__, __LINE__))</span>
<span class="cp">#define HFC_inw(hc, reg)				\</span>
<span class="cp">	(hc-&gt;HFC_inw(hc, reg, __func__, __LINE__))</span>
<span class="cp">#define HFC_inw_nodebug(hc, reg)				\</span>
<span class="cp">	(hc-&gt;HFC_inw_nodebug(hc, reg, __func__, __LINE__))</span>
<span class="cp">#define HFC_wait(hc)				\</span>
<span class="cp">	(hc-&gt;HFC_wait(hc, __func__, __LINE__))</span>
<span class="cp">#define HFC_wait_nodebug(hc)				\</span>
<span class="cp">	(hc-&gt;HFC_wait_nodebug(hc, __func__, __LINE__))</span>
<span class="cp">#else</span>
<span class="cp">#define HFC_outb(hc, reg, val)		(hc-&gt;HFC_outb(hc, reg, val))</span>
<span class="cp">#define HFC_outb_nodebug(hc, reg, val)	(hc-&gt;HFC_outb_nodebug(hc, reg, val))</span>
<span class="cp">#define HFC_inb(hc, reg)		(hc-&gt;HFC_inb(hc, reg))</span>
<span class="cp">#define HFC_inb_nodebug(hc, reg)	(hc-&gt;HFC_inb_nodebug(hc, reg))</span>
<span class="cp">#define HFC_inw(hc, reg)		(hc-&gt;HFC_inw(hc, reg))</span>
<span class="cp">#define HFC_inw_nodebug(hc, reg)	(hc-&gt;HFC_inw_nodebug(hc, reg))</span>
<span class="cp">#define HFC_wait(hc)			(hc-&gt;HFC_wait(hc))</span>
<span class="cp">#define HFC_wait_nodebug(hc)		(hc-&gt;HFC_wait_nodebug(hc))</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_MISDN_HFCMULTI_8xx</span>
<span class="cp">#include &quot;hfc_multi_8xx.h&quot;</span>
<span class="cp">#endif</span>

<span class="cm">/* HFC_IO_MODE_PCIMEM */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="cp">#ifdef HFC_REGISTER_DEBUG</span>
<span class="n">HFC_outb_pcimem</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">val</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="cp">#else</span>
	<span class="n">HFC_outb_pcimem</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">val</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="p">{</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_membase</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">u_char</span>
<span class="cp">#ifdef HFC_REGISTER_DEBUG</span>
<span class="n">HFC_inb_pcimem</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">reg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="cp">#else</span>
	<span class="n">HFC_inb_pcimem</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">reg</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_membase</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">u_short</span>
<span class="cp">#ifdef HFC_REGISTER_DEBUG</span>
<span class="n">HFC_inw_pcimem</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">reg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="cp">#else</span>
	<span class="n">HFC_inw_pcimem</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">reg</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readw</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_membase</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="cp">#ifdef HFC_REGISTER_DEBUG</span>
<span class="n">HFC_wait_pcimem</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="cp">#else</span>
	<span class="n">HFC_wait_pcimem</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_membase</span> <span class="o">+</span> <span class="n">R_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">V_BUSY</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* HFC_IO_MODE_REGIO */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="cp">#ifdef HFC_REGISTER_DEBUG</span>
<span class="n">HFC_outb_regio</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">val</span><span class="p">,</span>
	       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="cp">#else</span>
	<span class="n">HFC_outb_regio</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">val</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">u_char</span>
<span class="cp">#ifdef HFC_REGISTER_DEBUG</span>
<span class="n">HFC_inb_regio</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">reg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="cp">#else</span>
	<span class="n">HFC_inb_regio</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">reg</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">u_short</span>
<span class="cp">#ifdef HFC_REGISTER_DEBUG</span>
<span class="n">HFC_inw_regio</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">reg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="cp">#else</span>
	<span class="n">HFC_inw_regio</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">reg</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">inw</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="cp">#ifdef HFC_REGISTER_DEBUG</span>
<span class="n">HFC_wait_regio</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="cp">#else</span>
	<span class="n">HFC_wait_regio</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">R_STATUS</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">V_BUSY</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#ifdef HFC_REGISTER_DEBUG</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">HFC_outb_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">val</span><span class="p">,</span>
	       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">regname</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;xxxxxxxx&quot;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">hfc_register_names</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hfc_register_names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span> <span class="o">==</span> <span class="n">reg</span><span class="p">)</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">regname</span><span class="p">,</span> <span class="n">hfc_register_names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">regname</span><span class="p">,</span> <span class="s">&quot;register&quot;</span><span class="p">);</span>

	<span class="n">bits</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">bits</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">bits</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">bits</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">bits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">bits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">32</span><span class="p">));</span>
	<span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">64</span><span class="p">));</span>
	<span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">128</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	       <span class="s">&quot;HFC_outb(chip %d, %02x=%s, 0x%02x=%s); in %s() line %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">regname</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">u_char</span>
<span class="n">HFC_inb_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">reg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">regname</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;xxxxxxxx&quot;</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">val</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">hfc_register_names</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">name</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">hfc_register_names</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hfc_register_names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span> <span class="o">==</span> <span class="n">reg</span><span class="p">)</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">regname</span><span class="p">,</span> <span class="n">hfc_register_names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">regname</span><span class="p">,</span> <span class="s">&quot;register&quot;</span><span class="p">);</span>

	<span class="n">bits</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">bits</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">bits</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">bits</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">bits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">bits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">32</span><span class="p">));</span>
	<span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">64</span><span class="p">));</span>
	<span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">128</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	       <span class="s">&quot;HFC_inb(chip %d, %02x=%s) = 0x%02x=%s; in %s() line %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">regname</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">u_short</span>
<span class="n">HFC_inw_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">reg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">regname</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">val</span> <span class="o">=</span> <span class="n">HFC_inw_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">hfc_register_names</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">name</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">hfc_register_names</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hfc_register_names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span> <span class="o">==</span> <span class="n">reg</span><span class="p">)</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">regname</span><span class="p">,</span> <span class="n">hfc_register_names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">regname</span><span class="p">,</span> <span class="s">&quot;register&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	       <span class="s">&quot;HFC_inw(chip %d, %02x=%s) = 0x%04x; in %s() line %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">regname</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">HFC_wait_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HFC_wait(chip %d); in %s() line %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="n">HFC_wait_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* write fifo data (REGIO) */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">write_fifo_regio</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">A_FIFO_DATA0</span><span class="p">,</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">),</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">),</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">);</span>
		<span class="n">data</span><span class="o">++</span><span class="p">;</span>
		<span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/* write fifo data (PCIMEM) */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">write_fifo_pcimem</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">),</span>
		       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_membase</span> <span class="o">+</span> <span class="n">A_FIFO_DATA0</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">),</span>
		       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_membase</span> <span class="o">+</span> <span class="n">A_FIFO_DATA0</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeb</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_membase</span> <span class="o">+</span> <span class="n">A_FIFO_DATA0</span><span class="p">);</span>
		<span class="n">data</span><span class="o">++</span><span class="p">;</span>
		<span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* read fifo data (REGIO) */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">read_fifo_regio</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">A_FIFO_DATA0</span><span class="p">,</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">));</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">));</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">);</span>
		<span class="n">data</span><span class="o">++</span><span class="p">;</span>
		<span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* read fifo data (PCIMEM) */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">read_fifo_pcimem</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_membase</span> <span class="o">+</span> <span class="n">A_FIFO_DATA0</span><span class="p">));</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_membase</span> <span class="o">+</span> <span class="n">A_FIFO_DATA0</span><span class="p">));</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_membase</span> <span class="o">+</span> <span class="n">A_FIFO_DATA0</span><span class="p">);</span>
		<span class="n">data</span><span class="o">++</span><span class="p">;</span>
		<span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">enable_hwirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_irq_ctrl</span> <span class="o">|=</span> <span class="n">V_GLOB_IRQ_EN</span><span class="p">;</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_IRQ_CTRL</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_irq_ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">disable_hwirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_irq_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">u_char</span><span class="p">)</span><span class="n">V_GLOB_IRQ_EN</span><span class="p">);</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_IRQ_CTRL</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_irq_ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define	NUM_EC 2</span>
<span class="cp">#define	MAX_TDM_CHAN 32</span>


<span class="kr">inline</span> <span class="kt">void</span>
<span class="n">enablepcibridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">R_BRG_PCM_CFG</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x0</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">);</span> <span class="cm">/* was _io before */</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span>
<span class="n">disablepcibridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">R_BRG_PCM_CFG</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x0</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">);</span> <span class="cm">/* was _io before */</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span>
<span class="n">readpcibridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cipv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* slow down a PCI read access by 1 PCI clock cycle */</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_CTRL</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span> <span class="cm">/*was _io before*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cipv</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cipv</span> <span class="o">=</span> <span class="mh">0x5800</span><span class="p">;</span>

	<span class="cm">/* select local bridge port address by writing to CIP port */</span>
	<span class="cm">/* data = HFC_inb(c, cipv); * was _io before */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">cipv</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">);</span>

	<span class="cm">/* restore R_CTRL for normal PCI read cycle speed */</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_CTRL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span> <span class="cm">/* was _io before */</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span>
<span class="n">writepcibridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">address</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cipv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">datav</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cipv</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cipv</span> <span class="o">=</span> <span class="mh">0x5800</span><span class="p">;</span>

	<span class="cm">/* select local bridge port address by writing to CIP port */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">cipv</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="cm">/* define a 32 bit dword with 4 identical bytes for write sequence */</span>
	<span class="n">datav</span> <span class="o">=</span> <span class="n">data</span> <span class="o">|</span> <span class="p">((</span><span class="n">__u32</span><span class="p">)</span> <span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">__u32</span><span class="p">)</span> <span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">__u32</span><span class="p">)</span> <span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * write this 32 bit dword to the bridge data port</span>
<span class="cm">	 * this will initiate a write sequence of up to 4 writes to the same</span>
<span class="cm">	 * address on the local bus interface the number of write accesses</span>
<span class="cm">	 * is undefined but &gt;=1 and depends on the next PCI transaction</span>
<span class="cm">	 * during write sequence on the local bus</span>
<span class="cm">	 */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">datav</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span>
<span class="n">cpld_set_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Do data pin read low byte */</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_OUT1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span>
<span class="n">cpld_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpld_set_reg</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">enablepcibridge</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="n">writepcibridge</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">disablepcibridge</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span>
<span class="n">cpld_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bytein</span><span class="p">;</span>

	<span class="n">cpld_set_reg</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Do data pin read low byte */</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_OUT1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">enablepcibridge</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="n">bytein</span> <span class="o">=</span> <span class="n">readpcibridge</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">disablepcibridge</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bytein</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span>
<span class="n">vpm_write_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpld_write_reg</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">cpld_write_reg</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x01</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">short</span>
<span class="n">vpm_read_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">highbit</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">cpld_read_reg</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">highbit</span> <span class="o">=</span> <span class="n">cpld_read_reg</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">|</span> <span class="p">(</span><span class="n">highbit</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span>
<span class="n">vpm_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">vpm_write_address</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">which</span><span class="p">)</span>
		<span class="n">cpld_set_reg</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cpld_set_reg</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">enablepcibridge</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">readpcibridge</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">disablepcibridge</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="n">cpld_set_reg</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span>
<span class="n">vpm_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vpm_write_address</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="n">enablepcibridge</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">which</span><span class="p">)</span>
		<span class="n">cpld_set_reg</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cpld_set_reg</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">writepcibridge</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">cpld_set_reg</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">disablepcibridge</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">regin</span><span class="p">;</span>
		<span class="n">regin</span> <span class="o">=</span> <span class="n">vpm_in</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">which</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regin</span> <span class="o">!=</span> <span class="n">data</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Wrote 0x%x to register 0x%x but got back &quot;</span>
			       <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">regin</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="n">vpm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">wc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ver</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">NUM_EC</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Setup GPIO&#39;s */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ver</span> <span class="o">=</span> <span class="n">vpm_in</span><span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mh">0x1a0</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VPM: Chip %d: ver %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ver</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vpm_out</span><span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mh">0x1a8</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="cm">/* GPIO out */</span>
			<span class="n">vpm_out</span><span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mh">0x1ac</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="cm">/* GPIO dir */</span>
			<span class="n">vpm_out</span><span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mh">0x1b0</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="cm">/* GPIO sel */</span>
		<span class="p">}</span>

		<span class="cm">/* Setup TDM path - sets fsync and tdm_clk as inputs */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">vpm_in</span><span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mh">0x1a3</span><span class="p">);</span> <span class="cm">/* misc_con */</span>
		<span class="n">vpm_out</span><span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mh">0x1a3</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">2</span><span class="p">);</span>

		<span class="cm">/* Setup Echo length (256 taps) */</span>
		<span class="n">vpm_out</span><span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mh">0x022</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">vpm_out</span><span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mh">0x023</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

		<span class="cm">/* Setup timeslots */</span>
		<span class="n">vpm_out</span><span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mh">0x02f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x02020202</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

		<span class="cm">/* Setup the tdm channel masks for all chips */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">vpm_out</span><span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mh">0x33</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

		<span class="cm">/* Setup convergence rate */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VPM: A-law mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x00</span> <span class="o">|</span> <span class="mh">0x10</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">vpm_out</span><span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VPM reg 0x20 is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="cm">/*vpm_out(wc, x, 0x20, (0x00 | 0x08 | 0x20 | 0x10)); */</span>

		<span class="n">vpm_out</span><span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">vpm_in</span><span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;NLP Thresh is set to %d (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="cm">/* Initialize echo cans */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_TDM_CHAN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x00000001</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
				<span class="n">vpm_out</span><span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * ARM arch at least disallows a udelay of</span>
<span class="cm">		 * more than 2ms... it gives a fake &quot;__bad_udelay&quot;</span>
<span class="cm">		 * reference at link-time.</span>
<span class="cm">		 * long delays in kernel code are pretty sucky anyway</span>
<span class="cm">		 * for now work around it using 5 x 2ms instead of 1 x 10ms</span>
<span class="cm">		 */</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>

		<span class="cm">/* Put in bypass mode */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_TDM_CHAN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x00000001</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
				<span class="n">vpm_out</span><span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Enable bypass */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_TDM_CHAN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x00000001</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
				<span class="n">vpm_out</span><span class="p">(</span><span class="n">wc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mh">0x78</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef UNUSED</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">vpm_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hctmp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">gpi2</span><span class="p">;</span>

	<span class="n">gpi2</span> <span class="o">=</span> <span class="n">HFC_inb</span><span class="p">(</span><span class="n">hctmp</span><span class="p">,</span> <span class="n">R_GPI_IN2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">gpi2</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x3</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Got interrupt 0x%x from VPM!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gpi2</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* UNUSED */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm"> * Interface to enable/disable the HW Echocan</span>
<span class="cm"> *</span>
<span class="cm"> * these functions are called within a spin_lock_irqsave on</span>
<span class="cm"> * the channel instance lock, so we are not disturbed by irqs</span>
<span class="cm"> *</span>
<span class="cm"> * we can later easily change the interface to make  other</span>
<span class="cm"> * things configurable, for now we configure the taps</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">vpm_echocan_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">taps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeslot</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">unit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span><span class="p">;</span>
<span class="cp">#ifdef TXADJ</span>
	<span class="kt">int</span> <span class="n">txadj</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">ISDN_P_B_RAW</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bch</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifdef TXADJ</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">_alloc_mISDN_skb</span><span class="p">(</span><span class="n">PH_CONTROL_IND</span><span class="p">,</span> <span class="n">HFC_VOL_CHANGE_TX</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">txadj</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">recv_Bchannel_skb</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">timeslot</span> <span class="o">=</span> <span class="p">((</span><span class="n">ch</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">ch</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">unit</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;vpm_echocan_on called taps [%d] on timeslot %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">taps</span><span class="p">,</span> <span class="n">timeslot</span><span class="p">);</span>

	<span class="n">vpm_out</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">timeslot</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">vpm_echocan_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeslot</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">unit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span><span class="p">;</span>
<span class="cp">#ifdef TXADJ</span>
	<span class="kt">int</span> <span class="n">txadj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">ISDN_P_B_RAW</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bch</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifdef TXADJ</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">_alloc_mISDN_skb</span><span class="p">(</span><span class="n">PH_CONTROL_IND</span><span class="p">,</span> <span class="n">HFC_VOL_CHANGE_TX</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">txadj</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">recv_Bchannel_skb</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">timeslot</span> <span class="o">=</span> <span class="p">((</span><span class="n">ch</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">ch</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">unit</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;vpm_echocan_off called on timeslot %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">timeslot</span><span class="p">);</span>
	<span class="cm">/* FILLME */</span>
	<span class="n">vpm_out</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">timeslot</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Speech Design resync feature</span>
<span class="cm"> * NOTE: This is called sometimes outside interrupt handler.</span>
<span class="cm"> * We must lock irqsave, so no other interrupt (other card) will occur!</span>
<span class="cm"> * Also multiple interrupts may nest, so must lock each access (lists, card)!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="n">hfcmulti_resync</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">locked</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">newmaster</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span> <span class="o">*</span><span class="n">pcmmaster</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">plx_acc_32</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">pv</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HFClock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_lock</span><span class="p">);</span> <span class="cm">/* must be locked inside other locks */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_PLXSD</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: RESYNC(syncmaster=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">syncmaster</span><span class="p">);</span>

	<span class="cm">/* select new master */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newmaster</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_PLXSD</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;using provided controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">HFClist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">syncronized</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">newmaster</span> <span class="o">=</span> <span class="n">hc</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Disable sync of all cards */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">HFClist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">plx_acc_32</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_membase</span> <span class="o">+</span> <span class="n">PLX_GPIOC</span><span class="p">;</span>
			<span class="n">pv</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">plx_acc_32</span><span class="p">);</span>
			<span class="n">pv</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PLX_SYNC_O_EN</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">plx_acc_32</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PCM_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pcmmaster</span> <span class="o">=</span> <span class="n">hc</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_PLXSD</span><span class="p">)</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
						       <span class="s">&quot;Schedule SYNC_I</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">hc</span><span class="o">-&gt;</span><span class="n">e1_resync</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* get SYNC_I */</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">newmaster</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hc</span> <span class="o">=</span> <span class="n">newmaster</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_PLXSD</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;id=%d (0x%p) = syncronized with &quot;</span>
			       <span class="s">&quot;interface.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">hc</span><span class="p">);</span>
		<span class="cm">/* Enable new sync master */</span>
		<span class="n">plx_acc_32</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_membase</span> <span class="o">+</span> <span class="n">PLX_GPIOC</span><span class="p">;</span>
		<span class="n">pv</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">plx_acc_32</span><span class="p">);</span>
		<span class="n">pv</span> <span class="o">|=</span> <span class="n">PLX_SYNC_O_EN</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">plx_acc_32</span><span class="p">);</span>
		<span class="cm">/* switch to jatt PLL, if not disabled by RX_SYNC */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_RX_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_PLXSD</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Schedule jatt PLL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">e1_resync</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* switch to jatt */</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcmmaster</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hc</span> <span class="o">=</span> <span class="n">pcmmaster</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_PLXSD</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;id=%d (0x%p) = PCM master syncronized &quot;</span>
				       <span class="s">&quot;with QUARTZ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">hc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Use the crystal clock for the PCM</span>
<span class="cm">				   master card */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_PLXSD</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;Schedule QUARTZ for HFC-E1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">e1_resync</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* switch quartz */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_PLXSD</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;QUARTZ is automatically &quot;</span>
					       <span class="s">&quot;enabled by HFC-%dS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">plx_acc_32</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_membase</span> <span class="o">+</span> <span class="n">PLX_GPIOC</span><span class="p">;</span>
			<span class="n">pv</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">plx_acc_32</span><span class="p">);</span>
			<span class="n">pv</span> <span class="o">|=</span> <span class="n">PLX_SYNC_O_EN</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">plx_acc_32</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rm</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s no pcm master, this MUST &quot;</span>
				       <span class="s">&quot;not happen!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">syncmaster</span> <span class="o">=</span> <span class="n">newmaster</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_lock</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HFClock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This must be called AND hc must be locked irqsave!!! */</span>
<span class="kr">inline</span> <span class="kt">void</span>
<span class="n">plxsd_checksync</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">syncronized</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">syncmaster</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_PLXSD</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: GOT sync on card %d&quot;</span>
				       <span class="s">&quot; (id=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">hfcmulti_resync</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">hc</span><span class="p">,</span> <span class="n">rm</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">syncmaster</span> <span class="o">==</span> <span class="n">hc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_PLXSD</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: LOST sync on card %d&quot;</span>
				       <span class="s">&quot; (id=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">hfcmulti_resync</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">rm</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * free hardware resources used by driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">release_io_hfcmulti</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">plx_acc_32</span><span class="p">;</span>
	<span class="n">u_int</span>	<span class="n">pv</span><span class="p">;</span>
	<span class="n">u_long</span>	<span class="n">plx_flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: entered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* soft reset also masks all interrupts */</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_cirm</span> <span class="o">|=</span> <span class="n">V_SRES</span><span class="p">;</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_CIRM</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_cirm</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_cirm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V_SRES</span><span class="p">;</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_CIRM</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_cirm</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span> <span class="cm">/* instead of &#39;wait&#39; that may cause locking */</span>

	<span class="cm">/* release Speech Design card, if PLX was initialized */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_membase</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_PLXSD</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: release PLXSD card %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_lock</span><span class="p">,</span> <span class="n">plx_flags</span><span class="p">);</span>
		<span class="n">plx_acc_32</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_membase</span> <span class="o">+</span> <span class="n">PLX_GPIOC</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">PLX_GPIOC_INIT</span><span class="p">,</span> <span class="n">plx_acc_32</span><span class="p">);</span>
		<span class="n">pv</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">plx_acc_32</span><span class="p">);</span>
		<span class="cm">/* Termination off */</span>
		<span class="n">pv</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PLX_TERM_ON</span><span class="p">;</span>
		<span class="cm">/* Disconnect the PCM */</span>
		<span class="n">pv</span> <span class="o">|=</span> <span class="n">PLX_SLAVE_EN_N</span><span class="p">;</span>
		<span class="n">pv</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PLX_MASTER_EN</span><span class="p">;</span>
		<span class="n">pv</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PLX_SYNC_O_EN</span><span class="p">;</span>
		<span class="cm">/* Put the DSP in Reset */</span>
		<span class="n">pv</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PLX_DSP_RES_N</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">plx_acc_32</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: PCM off: PLX_GPIO=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">pv</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_lock</span><span class="p">,</span> <span class="n">plx_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* disable memory mapped ports / io ports */</span>
	<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span> <span class="cm">/* prevent resync */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">)</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_membase</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_membase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_membase</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_membase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">xhfc_membase</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">xhfc_membase</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * function called to reset the HFC chip. A complete software reset of chip</span>
<span class="cm"> * and fifos is done. All configuration of the chip is done.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="n">init_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span>			<span class="n">flags</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rev</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_char</span>			<span class="n">r_conf_en</span><span class="p">,</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">plx_acc_32</span><span class="p">;</span>
	<span class="n">u_int</span>			<span class="n">pv</span><span class="p">;</span>
	<span class="n">u_long</span>			<span class="n">plx_flags</span><span class="p">,</span> <span class="n">hfc_flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">plx_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hfc_multi</span>	<span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span> <span class="o">*</span><span class="n">plx_last_hc</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* reset all registers */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfcm_hw</span><span class="p">));</span>

	<span class="cm">/* revision check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: entered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">HFC_inb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_CHIP_ID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x8</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xe</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x31</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HFC_multi: unknown CHIP_ID:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rev</span> <span class="o">=</span> <span class="n">HFC_inb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_CHIP_RV</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;HFC_multi: detected HFC with chip ID=0x%lx revision=%ld%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">val</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">!=</span> <span class="n">HFC_TYPE_XHFC</span><span class="p">))</span> <span class="o">?</span>
	       <span class="s">&quot; (old FIFO handling)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">!=</span> <span class="n">HFC_TYPE_XHFC</span> <span class="o">&amp;&amp;</span> <span class="n">rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CHIP_REVISION0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;HFC_multi: NOTE: Your chip is revision 0, &quot;</span>
		       <span class="s">&quot;ask Cologne Chip for update. Newer chips &quot;</span>
		       <span class="s">&quot;have a better FIFO handling. Old chips &quot;</span>
		       <span class="s">&quot;still work but may have slightly lower &quot;</span>
		       <span class="s">&quot;HDLC transmit performance.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFC_multi: WARNING: This driver doesn&#39;t &quot;</span>
		       <span class="s">&quot;consider chip revision = %ld. The chip / &quot;</span>
		       <span class="s">&quot;bridge may not work.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set s-ram size */</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">Flen</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">Zmin</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">Zlen</span> <span class="o">=</span> <span class="mi">384</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">DTMFbase</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_EXRAM_128</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: changing to 128K external RAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_ctrl</span> <span class="o">|=</span> <span class="n">V_EXT_RAM</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_ram_sz</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">Flen</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">Zmin</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">Zlen</span> <span class="o">=</span> <span class="mi">1856</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">DTMFbase</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_EXRAM_512</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: changing to 512K external RAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_ctrl</span> <span class="o">|=</span> <span class="n">V_EXT_RAM</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_ram_sz</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">Flen</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">Zmin</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">Zlen</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">DTMFbase</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_XHFC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">Flen</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">Zmin</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">Zlen</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">DTMFbase</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">max_trans</span> <span class="o">=</span> <span class="n">poll</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">max_trans</span> <span class="o">&gt;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">Zlen</span><span class="p">)</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">max_trans</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">Zlen</span><span class="p">;</span>

	<span class="cm">/* Speech Design PLX bridge */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_PLXSD</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: initializing PLXSD card %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_lock</span><span class="p">,</span> <span class="n">plx_flags</span><span class="p">);</span>
		<span class="n">plx_acc_32</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_membase</span> <span class="o">+</span> <span class="n">PLX_GPIOC</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">PLX_GPIOC_INIT</span><span class="p">,</span> <span class="n">plx_acc_32</span><span class="p">);</span>
		<span class="n">pv</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">plx_acc_32</span><span class="p">);</span>
		<span class="cm">/* The first and the last cards are terminating the PCM bus */</span>
		<span class="n">pv</span> <span class="o">|=</span> <span class="n">PLX_TERM_ON</span><span class="p">;</span> <span class="cm">/* hc is currently the last */</span>
		<span class="cm">/* Disconnect the PCM */</span>
		<span class="n">pv</span> <span class="o">|=</span> <span class="n">PLX_SLAVE_EN_N</span><span class="p">;</span>
		<span class="n">pv</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PLX_MASTER_EN</span><span class="p">;</span>
		<span class="n">pv</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PLX_SYNC_O_EN</span><span class="p">;</span>
		<span class="cm">/* Put the DSP in Reset */</span>
		<span class="n">pv</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PLX_DSP_RES_N</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">plx_acc_32</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_lock</span><span class="p">,</span> <span class="n">plx_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: slave/term: PLX_GPIO=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">pv</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we are the 3rd PLXSD card or higher, we must turn</span>
<span class="cm">		 * termination of last PLXSD card off.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HFClock</span><span class="p">,</span> <span class="n">hfc_flags</span><span class="p">);</span>
		<span class="n">plx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">plx_last_hc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">HFClist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">plx_count</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">!=</span> <span class="n">hc</span><span class="p">)</span>
					<span class="n">plx_last_hc</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plx_count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_PLXSD</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: card %d is between, so &quot;</span>
				       <span class="s">&quot;we disable termination</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">plx_last_hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_lock</span><span class="p">,</span> <span class="n">plx_flags</span><span class="p">);</span>
			<span class="n">plx_acc_32</span> <span class="o">=</span> <span class="n">plx_last_hc</span><span class="o">-&gt;</span><span class="n">plx_membase</span> <span class="o">+</span> <span class="n">PLX_GPIOC</span><span class="p">;</span>
			<span class="n">pv</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">plx_acc_32</span><span class="p">);</span>
			<span class="n">pv</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PLX_TERM_ON</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">plx_acc_32</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_lock</span><span class="p">,</span> <span class="n">plx_flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: term off: PLX_GPIO=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">pv</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HFClock</span><span class="p">,</span> <span class="n">hfc_flags</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_pcm_md0</span> <span class="o">=</span> <span class="n">V_F0_LEN</span><span class="p">;</span> <span class="cm">/* shift clock for DSP */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_EMBSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_pcm_md0</span> <span class="o">=</span> <span class="n">V_F0_LEN</span><span class="p">;</span> <span class="cm">/* shift clock for DSP */</span>

	<span class="cm">/* we only want the real Z2 read-pointer for revision &gt; 0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_REVISION0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_ram_sz</span> <span class="o">|=</span> <span class="n">V_FZ_MD</span><span class="p">;</span>

	<span class="cm">/* select pcm mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PCM_SLAVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: setting PCM into slave mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PCM_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">plxsd_master</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: setting PCM into master mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_pcm_md0</span> <span class="o">|=</span> <span class="n">V_PCM_MD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: performing PCM auto detect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="cm">/* soft reset */</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_CTRL</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_XHFC</span><span class="p">)</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="mh">0x0C</span> <span class="cm">/* R_FIFO_THRES */</span><span class="p">,</span>
			 <span class="mh">0x11</span> <span class="cm">/* 16 Bytes TX/RX */</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RAM_SZ</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_ram_sz</span><span class="p">);</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO_MD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_XHFC</span><span class="p">)</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_cirm</span> <span class="o">=</span> <span class="n">V_SRES</span> <span class="o">|</span> <span class="n">V_HFCRES</span> <span class="o">|</span> <span class="n">V_PCMRES</span> <span class="o">|</span> <span class="n">V_STRES</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_cirm</span> <span class="o">=</span> <span class="n">V_SRES</span> <span class="o">|</span> <span class="n">V_HFCRES</span> <span class="o">|</span> <span class="n">V_PCMRES</span> <span class="o">|</span> <span class="n">V_STRES</span>
			<span class="o">|</span> <span class="n">V_RLD_EPR</span><span class="p">;</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_CIRM</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_cirm</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_cirm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_CIRM</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_cirm</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">!=</span> <span class="n">HFC_TYPE_XHFC</span><span class="p">)</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RAM_SZ</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_ram_sz</span><span class="p">);</span>

	<span class="cm">/* Speech Design PLX bridge pcm and sync mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_lock</span><span class="p">,</span> <span class="n">plx_flags</span><span class="p">);</span>
		<span class="n">plx_acc_32</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_membase</span> <span class="o">+</span> <span class="n">PLX_GPIOC</span><span class="p">;</span>
		<span class="n">pv</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">plx_acc_32</span><span class="p">);</span>
		<span class="cm">/* Connect PCM */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_pcm_md0</span> <span class="o">&amp;</span> <span class="n">V_PCM_MD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pv</span> <span class="o">|=</span> <span class="n">PLX_MASTER_EN</span> <span class="o">|</span> <span class="n">PLX_SLAVE_EN_N</span><span class="p">;</span>
			<span class="n">pv</span> <span class="o">|=</span> <span class="n">PLX_SYNC_O_EN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: master: PLX_GPIO=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">pv</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pv</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PLX_MASTER_EN</span> <span class="o">|</span> <span class="n">PLX_SLAVE_EN_N</span><span class="p">);</span>
			<span class="n">pv</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PLX_SYNC_O_EN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: slave: PLX_GPIO=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">pv</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">plx_acc_32</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_lock</span><span class="p">,</span> <span class="n">plx_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* PCM setup */</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_PCM_MD0</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_pcm_md0</span> <span class="o">|</span> <span class="mh">0x90</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">slots</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_PCM_MD1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">slots</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_PCM_MD1</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">slots</span> <span class="o">==</span> <span class="mi">128</span><span class="p">)</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_PCM_MD1</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_PCM_MD0</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_pcm_md0</span> <span class="o">|</span> <span class="mh">0xa0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_PCM_MD2</span><span class="p">,</span> <span class="n">V_SYNC_SRC</span><span class="p">);</span> <span class="cm">/* sync via SYNC_I / O */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_EMBSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_PCM_MD2</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span> <span class="cm">/* V_C2O_EN */</span>
	<span class="k">else</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_PCM_MD2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="cm">/* sync from interface */</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_PCM_MD0</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_pcm_md0</span> <span class="o">|</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SLOT</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_SL_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">!=</span> <span class="n">HFC_TYPE_XHFC</span><span class="p">)</span>
			<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CONF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">slot_owner</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set clock speed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_CLOCK2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;%s: setting double clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_BRG_PCM_CFG</span><span class="p">,</span> <span class="n">V_PCM_CLK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_EMBSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="mh">0x02</span> <span class="cm">/* R_CLK_CFG */</span><span class="p">,</span> <span class="mh">0x40</span> <span class="cm">/* V_CLKO_OFF */</span><span class="p">);</span>

	<span class="cm">/* B410P GPIO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_B410P</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Setting GPIOs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_SEL</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_EN1</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;calling vpm_init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vpm_init</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* check if R_F0_CNT counts (8 kHz frame count) */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">HFC_inb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_F0_CNTL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">+=</span> <span class="n">HFC_inb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_F0_CNTH</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;HFC_multi F0_CNT %ld after reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
	<span class="n">schedule_timeout</span><span class="p">((</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">?</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* Timeout minimum 10ms */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">val2</span> <span class="o">=</span> <span class="n">HFC_inb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_F0_CNTL</span><span class="p">);</span>
	<span class="n">val2</span> <span class="o">+=</span> <span class="n">HFC_inb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_F0_CNTH</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;HFC_multi F0_CNT %ld after 10 ms (1st try)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">val2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val2</span> <span class="o">&gt;=</span> <span class="n">val</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 1 ms */</span>
		<span class="cm">/* it counts, so we keep the pcm mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PCM_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;controller is PCM bus MASTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PCM_SLAVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;controller is PCM bus SLAVE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PCM_SLAVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;controller is PCM bus SLAVE &quot;</span>
				       <span class="s">&quot;(auto detected)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* does not count */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PCM_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="nl">controller_fail:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;HFC_multi ERROR, getting no 125us &quot;</span>
			       <span class="s">&quot;pulse. Seems that controller fails.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PCM_SLAVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;controller is PCM bus SLAVE &quot;</span>
			       <span class="s">&quot;(ignoring missing PCM clock)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* only one pcm master */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="n">plxsd_master</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;HFC_multi ERROR, no clock &quot;</span>
				       <span class="s">&quot;on another Speech Design card found. &quot;</span>
				       <span class="s">&quot;Please be sure to connect PCM cable.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* retry with master clock */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_lock</span><span class="p">,</span> <span class="n">plx_flags</span><span class="p">);</span>
				<span class="n">plx_acc_32</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_membase</span> <span class="o">+</span> <span class="n">PLX_GPIOC</span><span class="p">;</span>
				<span class="n">pv</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">plx_acc_32</span><span class="p">);</span>
				<span class="n">pv</span> <span class="o">|=</span> <span class="n">PLX_MASTER_EN</span> <span class="o">|</span> <span class="n">PLX_SLAVE_EN_N</span><span class="p">;</span>
				<span class="n">pv</span> <span class="o">|=</span> <span class="n">PLX_SYNC_O_EN</span><span class="p">;</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">plx_acc_32</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_lock</span><span class="p">,</span> <span class="n">plx_flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: master: &quot;</span>
					       <span class="s">&quot;PLX_GPIO=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">pv</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_pcm_md0</span> <span class="o">|=</span> <span class="n">V_PCM_MD</span><span class="p">;</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_PCM_MD0</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_pcm_md0</span> <span class="o">|</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
			<span class="n">schedule_timeout</span><span class="p">((</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">?:</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* Timeout min. 10ms */</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">val2</span> <span class="o">=</span> <span class="n">HFC_inb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_F0_CNTL</span><span class="p">);</span>
			<span class="n">val2</span> <span class="o">+=</span> <span class="n">HFC_inb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_F0_CNTH</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HFC_multi F0_CNT %ld after &quot;</span>
				       <span class="s">&quot;10 ms (2nd try)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val2</span> <span class="o">&gt;=</span> <span class="n">val</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 1 ms */</span>
				<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PCM_MASTER</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;controller is PCM bus MASTER &quot;</span>
				       <span class="s">&quot;(auto detected)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">goto</span> <span class="n">controller_fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Release the DSP Reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PCM_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
			<span class="n">plxsd_master</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_lock</span><span class="p">,</span> <span class="n">plx_flags</span><span class="p">);</span>
		<span class="n">plx_acc_32</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_membase</span> <span class="o">+</span> <span class="n">PLX_GPIOC</span><span class="p">;</span>
		<span class="n">pv</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">plx_acc_32</span><span class="p">);</span>
		<span class="n">pv</span> <span class="o">|=</span>  <span class="n">PLX_DSP_RES_N</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">plx_acc_32</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_lock</span><span class="p">,</span> <span class="n">plx_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: reset off: PLX_GPIO=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">pv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* pcm id */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;controller has given PCM BUS ID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PCM_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span>
		    <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">PCM_cnt</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* SD has proprietary bridging */</span>
		<span class="p">}</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">PCM_cnt</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;controller has PCM BUS ID %d &quot;</span>
		       <span class="s">&quot;(auto selected)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set up timer */</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_TI_WD</span><span class="p">,</span> <span class="n">poll_timer</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_irqmsk_misc</span> <span class="o">|=</span> <span class="n">V_TI_IRQMSK</span><span class="p">;</span>

	<span class="cm">/* set E1 state machine IRQ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_irqmsk_misc</span> <span class="o">|=</span> <span class="n">V_STA_IRQMSK</span><span class="p">;</span>

	<span class="cm">/* set DTMF detection */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_DTMF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: enabling DTMF detection &quot;</span>
			       <span class="s">&quot;for all B-channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_dtmf</span> <span class="o">=</span> <span class="n">V_DTMF_EN</span> <span class="o">|</span> <span class="n">V_DTMF_STOP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_ULAW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_dtmf</span> <span class="o">|=</span> <span class="n">V_ULAW_SEL</span><span class="p">;</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_DTMF_N</span><span class="p">,</span> <span class="mi">102</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_irqmsk_misc</span> <span class="o">|=</span> <span class="n">V_DTMF_IRQMSK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* conference engine */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_ULAW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
		<span class="n">r_conf_en</span> <span class="o">=</span> <span class="n">V_CONF_EN</span> <span class="o">|</span> <span class="n">V_ULAW</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">r_conf_en</span> <span class="o">=</span> <span class="n">V_CONF_EN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">!=</span> <span class="n">HFC_TYPE_XHFC</span><span class="p">)</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_CONF_EN</span><span class="p">,</span> <span class="n">r_conf_en</span><span class="p">);</span>

	<span class="cm">/* setting leds */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* HFC-E1 OEM */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_WATCHDOG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_SEL</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_SEL</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>

		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_EN1</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_OUT1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_EN0</span><span class="p">,</span> <span class="n">V_GPIO_EN2</span> <span class="o">|</span> <span class="n">V_GPIO_EN3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* HFC-4S OEM */</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_SEL</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_EN1</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_OUT1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_EMBSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_st_sync</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="cm">/* V_AUTO_SYNCI */</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_ST_SYNC</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_st_sync</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set master clock */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">masterclk</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: setting ST master clock &quot;</span>
			       <span class="s">&quot;to port %d (0..%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">masterclk</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_st_sync</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">masterclk</span> <span class="o">|</span> <span class="n">V_AUTO_SYNC</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_ST_SYNC</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_st_sync</span><span class="p">);</span>
	<span class="p">}</span>



	<span class="cm">/* setting misc irq */</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_IRQMSK_MISC</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_irqmsk_misc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;r_irqmsk_misc.2: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_irqmsk_misc</span><span class="p">);</span>

	<span class="cm">/* RAM access test */</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RAM_ADDR0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RAM_ADDR1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RAM_ADDR2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RAM_ADDR0</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RAM_DATA</span><span class="p">,</span> <span class="p">((</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RAM_ADDR0</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RAM_DATA</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_INT_DATA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="p">((</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;addr:%x val:%x should:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">err</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;aborting - %d RAM access errors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * control the watchdog</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">hfcmulti_watchdog</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">wdcount</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">wdcount</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">wdcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">wdbyte</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">wdbyte</span> <span class="o">==</span> <span class="n">V_GPIO_OUT2</span> <span class="o">?</span>
			<span class="n">V_GPIO_OUT3</span> <span class="o">:</span> <span class="n">V_GPIO_OUT2</span><span class="p">;</span>

		<span class="cm">/* printk(&quot;Sending Watchdog Kill %x\n&quot;,hc-&gt;wdbyte); */</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_EN0</span><span class="p">,</span> <span class="n">V_GPIO_EN2</span> <span class="o">|</span> <span class="n">V_GPIO_EN3</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_OUT0</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">wdbyte</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * output leds</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">hfcmulti_leds</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lled</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">leddw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">leds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">led</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* HFC-E1 OEM */</span>
		<span class="cm">/* 2 red steady:       LOS</span>
<span class="cm">		 * 1 red steady:       L1 not active</span>
<span class="cm">		 * 2 green steady:     L1 active</span>
<span class="cm">		 * 1st green flashing: activity on TX</span>
<span class="cm">		 * 2nd green flashing: activity on RX</span>
<span class="cm">		 */</span>
		<span class="n">led</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">led</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">led</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">led</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">dch</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">los</span><span class="p">)</span>
				<span class="n">led</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">e1_state</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">led</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">led</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">led</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">activity_tx</span><span class="p">)</span>
					<span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">poll</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">activity_rx</span><span class="p">)</span>
					<span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">poll</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span>
					<span class="n">led</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span>
					<span class="n">led</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2048</span><span class="p">)</span>
					<span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2048</span><span class="p">)</span>
					<span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
					<span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">poll</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
					<span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">poll</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">leds</span> <span class="o">=</span> <span class="p">(</span><span class="n">led</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">led</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">led</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">led</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">))</span><span class="o">^</span><span class="mh">0xF</span><span class="p">;</span>
		<span class="cm">/* leds are inverted */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">leds</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ledstate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_OUT1</span><span class="p">,</span> <span class="n">leds</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">ledstate</span> <span class="o">=</span> <span class="n">leds</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* HFC-4S OEM */</span>
		<span class="cm">/* red steady:     PH_DEACTIVATE</span>
<span class="cm">		 * green steady:   PH_ACTIVATE</span>
<span class="cm">		 * green flashing: activity on TX</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">active</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">dch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">].</span><span class="n">dch</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">state</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_S0</span><span class="p">)</span>
					<span class="n">active</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">active</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">active</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* led green */</span>
					<span class="n">hc</span><span class="o">-&gt;</span><span class="n">activity_tx</span> <span class="o">|=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">activity_rx</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
						<span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">activity_tx</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
							<span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">poll</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span>
						<span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* led off */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2048</span><span class="p">)</span>
						<span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
						<span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">poll</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* led red */</span>
					<span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* led off */</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_B410P</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">leds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*green*/</span>
					<span class="n">leds</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*red*/</span>
					<span class="n">leds</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">leds</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ledstate</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vpm_out</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1a8</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">leds</span><span class="p">);</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">ledstate</span> <span class="o">=</span> <span class="n">leds</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">leds</span> <span class="o">=</span> <span class="p">((</span><span class="n">led</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">led</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">led</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">led</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">led</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">led</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">led</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">led</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">leds</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ledstate</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_EN1</span><span class="p">,</span> <span class="n">leds</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>
				<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_OUT1</span><span class="p">,</span> <span class="n">leds</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">ledstate</span> <span class="o">=</span> <span class="n">leds</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* HFC 1S/2S Beronet */</span>
		<span class="cm">/* red steady:     PH_DEACTIVATE</span>
<span class="cm">		 * green steady:   PH_ACTIVATE</span>
<span class="cm">		 * green flashing: activity on TX</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">active</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">dch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">].</span><span class="n">dch</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">state</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_S0</span><span class="p">)</span>
					<span class="n">active</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">active</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">active</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* led green */</span>
					<span class="n">hc</span><span class="o">-&gt;</span><span class="n">activity_tx</span> <span class="o">|=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">activity_rx</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
						<span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">activity_tx</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
							<span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">poll</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span>
						<span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* led off */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2048</span><span class="p">)</span>
						<span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
						<span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">poll</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* led red */</span>
					<span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* led off */</span>
		<span class="p">}</span>
		<span class="n">leds</span> <span class="o">=</span> <span class="p">(</span><span class="n">led</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">led</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">led</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">((</span><span class="n">led</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">leds</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ledstate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_EN1</span><span class="p">,</span>
					 <span class="p">((</span><span class="n">led</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">led</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
			<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_OUT1</span><span class="p">,</span>
					 <span class="p">((</span><span class="n">led</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">led</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">ledstate</span> <span class="o">=</span> <span class="n">leds</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>: <span class="cm">/* HFC 8S+ Beronet */</span>
		<span class="cm">/* off:      PH_DEACTIVATE</span>
<span class="cm">		 * steady:   PH_ACTIVATE</span>
<span class="cm">		 * flashing: activity on TX</span>
<span class="cm">		 */</span>
		<span class="n">lled</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* leds off */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">active</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">dch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">].</span><span class="n">dch</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">state</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_S0</span><span class="p">)</span>
					<span class="n">active</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">active</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">active</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">lled</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span> <span class="cm">/* led on */</span>
					<span class="n">hc</span><span class="o">-&gt;</span><span class="n">activity_tx</span> <span class="o">|=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">activity_rx</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
						<span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">activity_tx</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
							<span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">poll</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span>
						<span class="n">lled</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="cm">/* led off */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2048</span><span class="p">)</span>
						<span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
						<span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">poll</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">hc</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">leddw</span> <span class="o">=</span> <span class="n">lled</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span> <span class="n">lled</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">lled</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">lled</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">leddw</span> <span class="o">!=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">ledstate</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* HFC_outb(hc, R_BRG_PCM_CFG, 1);</span>
<span class="cm">			   HFC_outb(c, R_BRG_PCM_CFG, (0x0 &lt;&lt; 6) | 0x3); */</span>
			<span class="cm">/* was _io before */</span>
			<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_BRG_PCM_CFG</span><span class="p">,</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">V_PCM_CLK</span><span class="p">);</span>
			<span class="n">outw</span><span class="p">(</span><span class="mh">0x4000</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">outl</span><span class="p">(</span><span class="n">leddw</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">);</span>
			<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_BRG_PCM_CFG</span><span class="p">,</span> <span class="n">V_PCM_CLK</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">ledstate</span> <span class="o">=</span> <span class="n">leddw</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">activity_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">activity_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * read dtmf coefficients</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">hfcmulti_dtmf</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span>		<span class="o">*</span><span class="n">coeff</span><span class="p">;</span>
	<span class="n">u_int</span>		<span class="n">mantissa</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">co</span><span class="p">,</span> <span class="n">ch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bchannel</span>	<span class="o">*</span><span class="n">bch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">exponent</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">dtmf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">addr</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">w_float</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mISDNhead</span> <span class="o">*</span><span class="n">hh</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_DTMF</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: dtmf detection irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* only process enabled B-channels */</span>
		<span class="n">bch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bch</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">port</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_TRANSPARENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_DTMF</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: dtmf channel %d:&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="n">coeff</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">coeff</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">coeff_count</span> <span class="o">*</span> <span class="mi">16</span><span class="p">]);</span>
		<span class="n">dtmf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">co</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">co</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">co</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* read W(n-1) coefficient */</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">DTMFbase</span> <span class="o">+</span> <span class="p">((</span><span class="n">co</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
			<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RAM_ADDR0</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RAM_ADDR1</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RAM_ADDR2</span><span class="p">,</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span>
					 <span class="o">|</span> <span class="n">V_ADDR_INC</span><span class="p">);</span>
			<span class="n">w_float</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RAM_DATA</span><span class="p">);</span>
			<span class="n">w_float</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RAM_DATA</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_DTMF</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %04x&quot;</span><span class="p">,</span> <span class="n">w_float</span><span class="p">);</span>

			<span class="cm">/* decode float (see chip doc) */</span>
			<span class="n">mantissa</span> <span class="o">=</span> <span class="n">w_float</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">w_float</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span>
				<span class="n">mantissa</span> <span class="o">|=</span> <span class="mh">0xfffff000</span><span class="p">;</span>
			<span class="n">exponent</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_float</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exponent</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mantissa</span> <span class="o">^=</span> <span class="mh">0x1000</span><span class="p">;</span>
				<span class="n">mantissa</span> <span class="o">&lt;&lt;=</span> <span class="p">(</span><span class="n">exponent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* store coefficient */</span>
			<span class="n">coeff</span><span class="p">[</span><span class="n">co</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mantissa</span><span class="p">;</span>

			<span class="cm">/* read W(n) coefficient */</span>
			<span class="n">w_float</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RAM_DATA</span><span class="p">);</span>
			<span class="n">w_float</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RAM_DATA</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_DTMF</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %04x&quot;</span><span class="p">,</span> <span class="n">w_float</span><span class="p">);</span>

			<span class="cm">/* decode float (see chip doc) */</span>
			<span class="n">mantissa</span> <span class="o">=</span> <span class="n">w_float</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">w_float</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span>
				<span class="n">mantissa</span> <span class="o">|=</span> <span class="mh">0xfffff000</span><span class="p">;</span>
			<span class="n">exponent</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_float</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exponent</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mantissa</span> <span class="o">^=</span> <span class="mh">0x1000</span><span class="p">;</span>
				<span class="n">mantissa</span> <span class="o">&lt;&lt;=</span> <span class="p">(</span><span class="n">exponent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* store coefficient */</span>
			<span class="n">coeff</span><span class="p">[(</span><span class="n">co</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mantissa</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_DTMF</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; DTMF ready %08x %08x %08x %08x &quot;</span>
			       <span class="s">&quot;%08x %08x %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			       <span class="n">coeff</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">coeff_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">coeff_count</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">coeff_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">mI_alloc_skb</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: No memory for skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">hh</span> <span class="o">=</span> <span class="n">mISDN_HEAD_P</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span> <span class="o">=</span> <span class="n">PH_CONTROL_IND</span><span class="p">;</span>
			<span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">DTMF_HFC_COEF</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">coeff</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
			<span class="n">recv_Bchannel_skb</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* restart DTMF processing */</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">dtmf</span> <span class="o">=</span> <span class="n">dtmf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dtmf</span><span class="p">)</span>
		<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_DTMF</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_dtmf</span> <span class="o">|</span> <span class="n">V_RST_DTMF</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * fill fifo as much as possible</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">hfcmulti_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">Zspace</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">;</span> <span class="cm">/* must be int for calculation */</span>
	<span class="kt">int</span> <span class="n">Fspace</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">txpending</span><span class="p">,</span> <span class="n">slot_tx</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span><span class="p">;</span>
	<span class="k">struct</span>  <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">;</span>
	<span class="k">struct</span>  <span class="n">sk_buff</span> <span class="o">**</span><span class="n">sp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">idxp</span><span class="p">;</span>

	<span class="n">bch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span><span class="p">;</span>
	<span class="n">dch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">dch</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">bch</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">txpending</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">txpending</span><span class="p">;</span>
	<span class="n">slot_tx</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">slot_tx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">;</span>
		<span class="n">idxp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_idx</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">;</span>
		<span class="n">idxp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">tx_idx</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">len</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">txpending</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* no data */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_B410P</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_B_RAW</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">slot_rx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">slot_tx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="mh">0x20</span> <span class="o">|</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">HFC_wait_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">txpending</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* reset fifo */</span>
		<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_INC_RES_FIFO</span><span class="p">,</span> <span class="n">V_RES_F</span><span class="p">);</span>
		<span class="n">HFC_wait_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_SUBCH_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="o">*</span><span class="n">txpending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">next_frame:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_HDLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">f1</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_F1</span><span class="p">);</span>
		<span class="n">f2</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_F2</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">f2</span> <span class="o">!=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_F2</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_FIFO</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s(card %d): reread f2 because %d!=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">f2</span><span class="p">);</span>
			<span class="n">f2</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span> <span class="cm">/* repeat until F2 is equal */</span>
		<span class="p">}</span>
		<span class="n">Fspace</span> <span class="o">=</span> <span class="n">f2</span> <span class="o">-</span> <span class="n">f1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Fspace</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">Fspace</span> <span class="o">+=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">Flen</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Old FIFO handling doesn&#39;t give us the current Z2 read</span>
<span class="cm">		 * pointer, so we cannot send the next frame before the fifo</span>
<span class="cm">		 * is empty. It makes no difference except for a slightly</span>
<span class="cm">		 * lower performance.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_REVISION0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f1</span> <span class="o">!=</span> <span class="n">f2</span><span class="p">)</span>
				<span class="n">Fspace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">Fspace</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* one frame only for ST D-channels, to allow resending */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">!=</span> <span class="n">HFC_TYPE_E1</span> <span class="o">&amp;&amp;</span> <span class="n">dch</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f1</span> <span class="o">!=</span> <span class="n">f2</span><span class="p">)</span>
				<span class="n">Fspace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* F-counter full condition */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Fspace</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">z1</span> <span class="o">=</span> <span class="n">HFC_inw_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_Z1</span><span class="p">)</span> <span class="o">-</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">Zmin</span><span class="p">;</span>
	<span class="n">z2</span> <span class="o">=</span> <span class="n">HFC_inw_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_Z2</span><span class="p">)</span> <span class="o">-</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">Zmin</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">z2</span> <span class="o">!=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">HFC_inw_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_Z2</span><span class="p">)</span> <span class="o">-</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">Zmin</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_FIFO</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s(card %d): reread z2 because &quot;</span>
			       <span class="s">&quot;%d!=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">z2</span><span class="p">);</span>
		<span class="n">z2</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span> <span class="cm">/* repeat unti Z2 is equal */</span>
	<span class="p">}</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">Zfill</span> <span class="o">=</span> <span class="n">z1</span> <span class="o">-</span> <span class="n">z2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">Zfill</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">Zfill</span> <span class="o">+=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">Zlen</span><span class="p">;</span>
	<span class="n">Zspace</span> <span class="o">=</span> <span class="n">z2</span> <span class="o">-</span> <span class="n">z1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Zspace</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">Zspace</span> <span class="o">+=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">Zlen</span><span class="p">;</span>
	<span class="n">Zspace</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* keep not too full, so pointers will not overrun */</span>
	<span class="cm">/* fill transparent data only to maxinum transparent load (minus 4) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bch</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_TRANSPARENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
		<span class="n">Zspace</span> <span class="o">=</span> <span class="n">Zspace</span> <span class="o">-</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">Zlen</span> <span class="o">+</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">max_trans</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Zspace</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* no space of 4 bytes */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* if no data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">z1</span> <span class="o">==</span> <span class="n">z2</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* empty */</span>
			<span class="cm">/* if done with FIFO audio data during PCM connection */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bch</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_HDLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="o">*</span><span class="n">txpending</span> <span class="o">&amp;&amp;</span> <span class="n">slot_tx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MODE</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s: reconnecting PCM due to no &quot;</span>
					       <span class="s">&quot;more FIFO data: channel %d &quot;</span>
					       <span class="s">&quot;slot_tx %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">__func__</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">slot_tx</span><span class="p">);</span>
				<span class="cm">/* connect slot */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_XHFC</span><span class="p">)</span>
					<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CON_HDLC</span><span class="p">,</span> <span class="mh">0xc0</span>
						 <span class="o">|</span> <span class="mh">0x07</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">V_HDLC_TRP</span> <span class="o">|</span> <span class="n">V_IFF</span><span class="p">);</span>
				<span class="cm">/* Enable FIFO, no interrupt */</span>
				<span class="k">else</span>
					<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CON_HDLC</span><span class="p">,</span> <span class="mh">0xc0</span> <span class="o">|</span> <span class="mh">0x00</span> <span class="o">|</span>
						 <span class="n">V_HDLC_TRP</span> <span class="o">|</span> <span class="n">V_IFF</span><span class="p">);</span>
				<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">HFC_wait_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_XHFC</span><span class="p">)</span>
					<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CON_HDLC</span><span class="p">,</span> <span class="mh">0xc0</span>
						 <span class="o">|</span> <span class="mh">0x07</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">V_HDLC_TRP</span> <span class="o">|</span> <span class="n">V_IFF</span><span class="p">);</span>
				<span class="cm">/* Enable FIFO, no interrupt */</span>
				<span class="k">else</span>
					<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CON_HDLC</span><span class="p">,</span> <span class="mh">0xc0</span> <span class="o">|</span> <span class="mh">0x00</span> <span class="o">|</span>
						 <span class="n">V_HDLC_TRP</span> <span class="o">|</span> <span class="n">V_IFF</span><span class="p">);</span>
				<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">HFC_wait_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">txpending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* no data */</span>
	<span class="p">}</span>

	<span class="cm">/* &quot;fill fifo if empty&quot; feature */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bch</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_FILLEMPTY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_HDLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">z2</span> <span class="o">==</span> <span class="n">z1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_FILL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: buffer empty, so we have &quot;</span>
			       <span class="s">&quot;underrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="cm">/* fill buffer, to prevent future underrun */</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">silence_data</span><span class="p">,</span> <span class="n">poll</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">Zspace</span> <span class="o">-=</span> <span class="p">(</span><span class="n">poll</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* if audio data and connected slot */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bch</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_HDLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!*</span><span class="n">txpending</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="n">slot_tx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MODE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: disconnecting PCM due to &quot;</span>
			       <span class="s">&quot;FIFO data: channel %d slot_tx %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">slot_tx</span><span class="p">);</span>
		<span class="cm">/* disconnect slot */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_XHFC</span><span class="p">)</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CON_HDLC</span><span class="p">,</span> <span class="mh">0x80</span>
				 <span class="o">|</span> <span class="mh">0x07</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">V_HDLC_TRP</span> <span class="o">|</span> <span class="n">V_IFF</span><span class="p">);</span>
		<span class="cm">/* Enable FIFO, no interrupt */</span>
		<span class="k">else</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CON_HDLC</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="mh">0x00</span> <span class="o">|</span>
				 <span class="n">V_HDLC_TRP</span> <span class="o">|</span> <span class="n">V_IFF</span><span class="p">);</span>
		<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">HFC_wait_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_XHFC</span><span class="p">)</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CON_HDLC</span><span class="p">,</span> <span class="mh">0x80</span>
				 <span class="o">|</span> <span class="mh">0x07</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">V_HDLC_TRP</span> <span class="o">|</span> <span class="n">V_IFF</span><span class="p">);</span>
		<span class="cm">/* Enable FIFO, no interrupt */</span>
		<span class="k">else</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CON_HDLC</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="mh">0x00</span> <span class="o">|</span>
				 <span class="n">V_HDLC_TRP</span> <span class="o">|</span> <span class="n">V_IFF</span><span class="p">);</span>
		<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">HFC_wait_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">txpending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* show activity */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="p">)</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">activity_tx</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">port</span><span class="p">;</span>

	<span class="cm">/* fill fifo to what we have left */</span>
	<span class="n">ii</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_HDLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="n">idxp</span><span class="p">;</span>
	<span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">-</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">Zspace</span><span class="p">)</span>
		<span class="n">ii</span> <span class="o">=</span> <span class="n">Zspace</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_FIFO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s(card %d): fifo(%d) has %d bytes space &quot;</span>
		       <span class="s">&quot;left (z1=%04x, z2=%04x) sending %d of %d bytes %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">Zspace</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">,</span> <span class="n">ii</span><span class="o">-</span><span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="o">-</span><span class="n">i</span><span class="p">,</span>
		       <span class="n">temp</span> <span class="o">?</span> <span class="s">&quot;HDLC&quot;</span> <span class="o">:</span> <span class="s">&quot;TRANS&quot;</span><span class="p">);</span>

	<span class="cm">/* Have to prep the audio data */</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">write_fifo</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">ii</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">Zfill</span> <span class="o">+=</span> <span class="n">ii</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
	<span class="o">*</span><span class="n">idxp</span> <span class="o">=</span> <span class="n">ii</span><span class="p">;</span>

	<span class="cm">/* if not all data has been written */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* NOTE: fifo is started by the calling function */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if all data has been written, terminate frame */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_HDLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* increment f-counter */</span>
		<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_INC_RES_FIFO</span><span class="p">,</span> <span class="n">V_INC_F</span><span class="p">);</span>
		<span class="n">HFC_wait_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">);</span>
	<span class="cm">/* check for next frame */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bch</span> <span class="o">&amp;&amp;</span> <span class="n">get_next_bframe</span><span class="p">(</span><span class="n">bch</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">next_frame</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span> <span class="o">&amp;&amp;</span> <span class="n">get_next_dframe</span><span class="p">(</span><span class="n">dch</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">next_frame</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * now we have no more data, so in case of transparent,</span>
<span class="cm">	 * we set the last byte in fifo to &#39;silence&#39; in case we will get</span>
<span class="cm">	 * no more data at all. this prevents sending an undefined value.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bch</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_TRANSPARENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
		<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_FIFO_DATA0_NOINC</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">silence</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* NOTE: only called if E1 card is in active state */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">hfcmulti_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">Zsize</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* = 0, to make GCC happy */</span>
	<span class="kt">int</span> <span class="n">f1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">f2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* = 0, to make GCC happy */</span>
	<span class="kt">int</span> <span class="n">again</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span><span class="p">;</span>
	<span class="k">struct</span>  <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">**</span><span class="n">sp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">maxlen</span><span class="p">;</span>

	<span class="n">bch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dch</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">next_frame:</span>
	<span class="cm">/* on first AND before getting next valid frame, R_FIFO must be written</span>
<span class="cm">	   to. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_B410P</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_B_RAW</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">slot_rx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">slot_tx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="mh">0x20</span> <span class="o">|</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">HFC_wait_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>

	<span class="cm">/* ignore if rx is off BUT change fifo (above) to start pending TX */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">rx_off</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="p">)</span>
			<span class="n">bch</span><span class="o">-&gt;</span><span class="n">dropcnt</span> <span class="o">+=</span> <span class="n">poll</span><span class="p">;</span> <span class="cm">/* not exact but fair enough */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_HDLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">f1</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_F1</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">f1</span> <span class="o">!=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_F1</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_FIFO</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s(card %d): reread f1 because %d!=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">f1</span><span class="p">);</span>
			<span class="n">f1</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span> <span class="cm">/* repeat until F1 is equal */</span>
		<span class="p">}</span>
		<span class="n">f2</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_F2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">z1</span> <span class="o">=</span> <span class="n">HFC_inw_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_Z1</span><span class="p">)</span> <span class="o">-</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">Zmin</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">z1</span> <span class="o">!=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">HFC_inw_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_Z1</span><span class="p">)</span> <span class="o">-</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">Zmin</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_FIFO</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s(card %d): reread z2 because &quot;</span>
			       <span class="s">&quot;%d!=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">z2</span><span class="p">);</span>
		<span class="n">z1</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span> <span class="cm">/* repeat until Z1 is equal */</span>
	<span class="p">}</span>
	<span class="n">z2</span> <span class="o">=</span> <span class="n">HFC_inw_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_Z2</span><span class="p">)</span> <span class="o">-</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">Zmin</span><span class="p">;</span>
	<span class="n">Zsize</span> <span class="o">=</span> <span class="n">z1</span> <span class="o">-</span> <span class="n">z2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dch</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_HDLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">f1</span> <span class="o">!=</span> <span class="n">f2</span><span class="p">)</span>
		<span class="cm">/* complete hdlc frame */</span>
		<span class="n">Zsize</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Zsize</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">Zsize</span> <span class="o">+=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">Zlen</span><span class="p">;</span>
	<span class="cm">/* if buffer is empty */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Zsize</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">maxlen</span> <span class="o">=</span> <span class="n">bchannel_get_rxbuf</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">Zsize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">maxlen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;card%d.B%d: No bufferspace for %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">Zsize</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">;</span>
		<span class="n">maxlen</span> <span class="o">=</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">maxlen</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Dchannel */</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">;</span>
		<span class="n">maxlen</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">maxlen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">mI_alloc_skb</span><span class="p">(</span><span class="n">maxlen</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;card%d: No mem for dch rx_skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* show activity */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="p">)</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">activity_rx</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">port</span><span class="p">;</span>

	<span class="cm">/* empty fifo with what we have */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_HDLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_FIFO</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s(card %d): fifo(%d) reading %d &quot;</span>
			       <span class="s">&quot;bytes (z1=%04x, z2=%04x) HDLC %s (f1=%d, f2=%d) &quot;</span>
			       <span class="s">&quot;got=%d (again %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span>
			       <span class="n">Zsize</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">,</span> <span class="p">(</span><span class="n">f1</span> <span class="o">==</span> <span class="n">f2</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;fragment&quot;</span> <span class="o">:</span> <span class="s">&quot;COMPLETE&quot;</span><span class="p">,</span>
			       <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">Zsize</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">again</span><span class="p">);</span>
		<span class="cm">/* HDLC */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">Zsize</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_FIFO</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s(card %d): hdlc-frame too large.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">skb_trim</span><span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_INC_RES_FIFO</span><span class="p">,</span> <span class="n">V_RES_F</span><span class="p">);</span>
			<span class="n">HFC_wait_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">read_fifo</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="n">Zsize</span><span class="p">),</span> <span class="n">Zsize</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">f1</span> <span class="o">!=</span> <span class="n">f2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* increment Z2,F2-counter */</span>
			<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_INC_RES_FIFO</span><span class="p">,</span> <span class="n">V_INC_F</span><span class="p">);</span>
			<span class="n">HFC_wait_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
			<span class="cm">/* check size */</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_FIFO</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s(card %d): Frame below minimum &quot;</span>
					       <span class="s">&quot;size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">skb_trim</span><span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">next_frame</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* there is at least one complete frame, check crc */</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_CRC</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s: CRC-error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">skb_trim</span><span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">next_frame</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">skb_trim</span><span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">3</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">MISDN_COPY_SIZE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
				<span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">mI_alloc_skb</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span>
					       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
					<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: No mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">__func__</span><span class="p">);</span>
					<span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
					<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_FIFO</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s(card %d):&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">temp</span><span class="o">++</span><span class="p">]);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="p">)</span>
				<span class="n">recv_Dchannel</span><span class="p">(</span><span class="n">dch</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">recv_Bchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">again</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">next_frame</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* there is an incomplete frame */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* transparent */</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">read_fifo</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="n">Zsize</span><span class="p">),</span> <span class="n">Zsize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_FIFO</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;%s(card %d): fifo(%d) reading %d bytes &quot;</span>
			       <span class="s">&quot;(z1=%04x, z2=%04x) TRANS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">Zsize</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">);</span>
		<span class="cm">/* only bch is transparent */</span>
		<span class="n">recv_Bchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">Zfill</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Interrupt handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">signal_state_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">info</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">id</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_STATE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">TEI_SAPI</span> <span class="o">|</span> <span class="p">(</span><span class="n">GROUP_TEI</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span> <span class="cm">/* manager address */</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">_alloc_mISDN_skb</span><span class="p">(</span><span class="n">MPH_INFORMATION_IND</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span>
			       <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">recv_Dchannel_skb</span><span class="p">(</span><span class="n">dch</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="n">handle_timer_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">ch</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dchannel</span>	<span class="o">*</span><span class="n">dch</span><span class="p">;</span>
	<span class="n">u_long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* process queued resync jobs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">e1_resync</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* lock, so e1_resync gets not changed */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HFClock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">e1_resync</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_PLXSD</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Enable SYNC_I</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SYNC_CTRL</span><span class="p">,</span> <span class="n">V_EXT_CLK_SYNC</span><span class="p">);</span>
			<span class="cm">/* disable JATT, if RX_SYNC is set */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_RX_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SYNC_OUT</span><span class="p">,</span> <span class="n">V_SYNC_E1_RX</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">e1_resync</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_PLXSD</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Enable jatt PLL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SYNC_CTRL</span><span class="p">,</span> <span class="n">V_SYNC_OFFS</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">e1_resync</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_PLXSD</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;Enable QUARTZ for HFC-E1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* set jatt to quartz */</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SYNC_CTRL</span><span class="p">,</span> <span class="n">V_EXT_CLK_SYNC</span>
				 <span class="o">|</span> <span class="n">V_JATT_OFF</span><span class="p">);</span>
			<span class="cm">/* switch to JATT, in case it is not already */</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SYNC_OUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">e1_resync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HFClock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">!=</span> <span class="n">HFC_TYPE_E1</span> <span class="o">||</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">e1_state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">port</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">hfcmulti_tx</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
				<span class="cm">/* fifo is started when switching to rx-fifo */</span>
				<span class="n">hfcmulti_rx</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dch</span> <span class="o">&amp;&amp;</span>
				    <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">nt_timer</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dch</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">--</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">nt_timer</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">schedule_event</span><span class="p">(</span><span class="n">dch</span><span class="p">,</span>
							       <span class="n">FLG_PHCHANGE</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span>
						    <span class="n">DEBUG_HFCMULTI_STATE</span><span class="p">)</span>
							<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
							       <span class="s">&quot;%s: nt_timer at &quot;</span>
							       <span class="s">&quot;state %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							       <span class="n">__func__</span><span class="p">,</span>
							       <span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span> <span class="o">&amp;&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">dch</span><span class="p">;</span>
		<span class="cm">/* LOS */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SYNC_STA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">V_SIG_LOS</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">los</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_REPORT_LOS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">cfg</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">temp</span> <span class="o">&amp;&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">los</span><span class="p">)</span>
				<span class="n">signal_state_up</span><span class="p">(</span><span class="n">dch</span><span class="p">,</span> <span class="n">L1_SIGNAL_LOS_ON</span><span class="p">,</span>
						<span class="s">&quot;LOS detected&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">los</span><span class="p">)</span>
				<span class="n">signal_state_up</span><span class="p">(</span><span class="n">dch</span><span class="p">,</span> <span class="n">L1_SIGNAL_LOS_OFF</span><span class="p">,</span>
						<span class="s">&quot;LOS gone&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_REPORT_AIS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">cfg</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* AIS */</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SYNC_STA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">V_AIS</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">temp</span> <span class="o">&amp;&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">ais</span><span class="p">)</span>
				<span class="n">signal_state_up</span><span class="p">(</span><span class="n">dch</span><span class="p">,</span> <span class="n">L1_SIGNAL_AIS_ON</span><span class="p">,</span>
						<span class="s">&quot;AIS detected&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">ais</span><span class="p">)</span>
				<span class="n">signal_state_up</span><span class="p">(</span><span class="n">dch</span><span class="p">,</span> <span class="n">L1_SIGNAL_AIS_OFF</span><span class="p">,</span>
						<span class="s">&quot;AIS gone&quot;</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">ais</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_REPORT_SLIP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">cfg</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* SLIP */</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SLIP</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">V_FOSLIP_RX</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">temp</span> <span class="o">&amp;&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">slip_rx</span><span class="p">)</span>
				<span class="n">signal_state_up</span><span class="p">(</span><span class="n">dch</span><span class="p">,</span> <span class="n">L1_SIGNAL_SLIP_RX</span><span class="p">,</span>
						<span class="s">&quot; bit SLIP detected RX&quot;</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">slip_rx</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SLIP</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">V_FOSLIP_TX</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">temp</span> <span class="o">&amp;&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">slip_tx</span><span class="p">)</span>
				<span class="n">signal_state_up</span><span class="p">(</span><span class="n">dch</span><span class="p">,</span> <span class="n">L1_SIGNAL_SLIP_TX</span><span class="p">,</span>
						<span class="s">&quot; bit SLIP detected TX&quot;</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">slip_tx</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_REPORT_RDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">cfg</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* RDI */</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RX_SL0_0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">V_A</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">temp</span> <span class="o">&amp;&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">rdi</span><span class="p">)</span>
				<span class="n">signal_state_up</span><span class="p">(</span><span class="n">dch</span><span class="p">,</span> <span class="n">L1_SIGNAL_RDI_ON</span><span class="p">,</span>
						<span class="s">&quot;RDI detected&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">rdi</span><span class="p">)</span>
				<span class="n">signal_state_up</span><span class="p">(</span><span class="n">dch</span><span class="p">,</span> <span class="n">L1_SIGNAL_RDI_OFF</span><span class="p">,</span>
						<span class="s">&quot;RDI gone&quot;</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">rdi</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_JATT_DIR</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">sync</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x60</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_SYNC</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s: (id=%d) E1 now &quot;</span>
					       <span class="s">&quot;in clock sync</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RX_OFF</span><span class="p">,</span>
				    <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">jitter</span> <span class="o">|</span> <span class="n">V_RX_INIT</span><span class="p">);</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_TX_OFF</span><span class="p">,</span>
				    <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">jitter</span> <span class="o">|</span> <span class="n">V_RX_INIT</span><span class="p">);</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">check_framesync</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x60</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_SYNC</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s: (id=%d) E1 &quot;</span>
					       <span class="s">&quot;lost clock sync</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="nl">check_framesync:</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SYNC_STA</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="mh">0x27</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_SYNC</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s: (id=%d) E1 &quot;</span>
					       <span class="s">&quot;now in frame sync</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x60</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_SYNC</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s: (id=%d) E1 lost &quot;</span>
					       <span class="s">&quot;clock &amp; frame sync</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SYNC_STA</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">!=</span> <span class="mh">0x27</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_SYNC</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s: (id=%d) E1 &quot;</span>
					       <span class="s">&quot;lost frame sync</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_WATCHDOG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
		<span class="n">hfcmulti_watchdog</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">)</span>
		<span class="n">hfcmulti_leds</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">ph_state_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">r_irq_statech</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dchannel</span>	<span class="o">*</span><span class="n">dch</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">active</span><span class="p">;</span>
	<span class="n">u_char</span>		<span class="n">st_status</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* state machine */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dch</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dch</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r_irq_statech</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_ST_SEL</span><span class="p">,</span>
						 <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
				<span class="cm">/* undocumented: delay after R_ST_SEL */</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="cm">/* undocumented: status changes during read */</span>
				<span class="n">st_status</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_RD_STATE</span><span class="p">);</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">st_status</span> <span class="o">!=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">=</span>
						     <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_RD_STATE</span><span class="p">)))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_STATE</span><span class="p">)</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: reread &quot;</span>
						       <span class="s">&quot;STATE because %d!=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">__func__</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span>
						       <span class="n">st_status</span><span class="p">);</span>
					<span class="n">st_status</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span> <span class="cm">/* repeat */</span>
				<span class="p">}</span>

				<span class="cm">/* Speech Design TE-sync indication */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">st_status</span> <span class="o">&amp;</span> <span class="n">V_FR_SYNC_ST</span><span class="p">)</span>
						<span class="n">hc</span><span class="o">-&gt;</span><span class="n">syncronized</span> <span class="o">|=</span>
							<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="n">hc</span><span class="o">-&gt;</span><span class="n">syncronized</span> <span class="o">&amp;=</span>
							<span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">st_status</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_S0</span><span class="p">)</span>
					<span class="n">active</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">active</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">active</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span>
							 <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
					<span class="n">HFC_wait_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
					<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span>
							 <span class="n">R_INC_RES_FIFO</span><span class="p">,</span> <span class="n">V_RES_F</span><span class="p">);</span>
					<span class="n">HFC_wait_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
					<span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">schedule_event</span><span class="p">(</span><span class="n">dch</span><span class="p">,</span> <span class="n">FLG_PHCHANGE</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_STATE</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s: S/T newstate %x port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">__func__</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span>
					       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">r_irq_statech</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
		<span class="n">plxsd_checksync</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">fifo_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">block</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">ch</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dchannel</span>	<span class="o">*</span><span class="n">dch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bchannel</span>	<span class="o">*</span><span class="n">bch</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">r_irq_fifo_bl</span><span class="p">;</span>

	<span class="n">r_irq_fifo_bl</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_IRQ_FIFO_BL0</span> <span class="o">+</span> <span class="n">block</span><span class="p">);</span>
	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dch</span><span class="p">;</span>
		<span class="n">bch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="o">!</span><span class="n">dch</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">bch</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">port</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">j</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">r_irq_fifo_bl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hfcmulti_tx</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
			<span class="cm">/* start fifo */</span>
			<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">HFC_wait_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bch</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">r_irq_fifo_bl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hfcmulti_tx</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
			<span class="cm">/* start fifo */</span>
			<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">HFC_wait_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">r_irq_fifo_bl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hfcmulti_rx</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bch</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">r_irq_fifo_bl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hfcmulti_rx</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef IRQ_DEBUG</span>
<span class="kt">int</span> <span class="n">irqsem</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">hfcmulti_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">intno</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef IRQCOUNT_DEBUG</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">iq1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iq2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iq3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iq4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">iq5</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iq6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iqcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">hfc_multi</span>	<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dchannel</span>		<span class="o">*</span><span class="n">dch</span><span class="p">;</span>
	<span class="n">u_char</span>			<span class="n">r_irq_statech</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">r_irq_misc</span><span class="p">,</span> <span class="n">r_irq_oview</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">plx_acc</span><span class="p">;</span>
	<span class="n">u_short</span>			<span class="n">wval</span><span class="p">;</span>
	<span class="n">u_char</span>			<span class="n">e1_syncsta</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">temp2</span><span class="p">;</span>
	<span class="n">u_long</span>			<span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;HFC-multi: Spurious interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

<span class="cp">#ifdef IRQ_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqsem</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;irq for card %d during irq from &quot;</span>
		       <span class="s">&quot;card %d, this is no bug.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">irqsem</span><span class="p">);</span>
	<span class="n">irqsem</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_MISDN_HFCMULTI_8xx</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">immap</span><span class="o">-&gt;</span><span class="n">im_cpm</span><span class="p">.</span><span class="n">cp_pbdat</span> <span class="o">&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pb_irqmsk</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">irq_notforus</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">plx_acc</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_membase</span> <span class="o">+</span> <span class="n">PLX_INTCSR</span><span class="p">;</span>
		<span class="n">wval</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">plx_acc</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wval</span> <span class="o">&amp;</span> <span class="n">PLX_INTCSR_LINTI1_STATUS</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">irq_notforus</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_STATUS</span><span class="p">);</span>
	<span class="n">r_irq_statech</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_IRQ_STATECH</span><span class="p">);</span>
<span class="cp">#ifdef IRQCOUNT_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r_irq_statech</span><span class="p">)</span>
		<span class="n">iq1</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">V_DTMF_STA</span><span class="p">)</span>
		<span class="n">iq2</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">V_LOST_STA</span><span class="p">)</span>
		<span class="n">iq3</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">V_EXT_IRQSTA</span><span class="p">)</span>
		<span class="n">iq4</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">V_MISC_IRQSTA</span><span class="p">)</span>
		<span class="n">iq5</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">V_FR_IRQSTA</span><span class="p">)</span>
		<span class="n">iq6</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iqcnt</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;iq1:%x iq2:%x iq3:%x iq4:%x iq5:%x iq6:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">iq1</span><span class="p">,</span> <span class="n">iq2</span><span class="p">,</span> <span class="n">iq3</span><span class="p">,</span> <span class="n">iq4</span><span class="p">,</span> <span class="n">iq5</span><span class="p">,</span> <span class="n">iq6</span><span class="p">);</span>
		<span class="n">iqcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r_irq_statech</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V_DTMF_STA</span> <span class="o">|</span> <span class="n">V_LOST_STA</span> <span class="o">|</span> <span class="n">V_EXT_IRQSTA</span> <span class="o">|</span>
			<span class="n">V_MISC_IRQSTA</span> <span class="o">|</span> <span class="n">V_FR_IRQSTA</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* irq is not for us */</span>
		<span class="k">goto</span> <span class="n">irq_notforus</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">irqcnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r_irq_statech</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">!=</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span>
			<span class="n">ph_state_irq</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">r_irq_statech</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">V_EXT_IRQSTA</span><span class="p">)</span>
		<span class="p">;</span> <span class="cm">/* external IRQ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">V_LOST_STA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* LOST IRQ */</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_INC_RES_FIFO</span><span class="p">,</span> <span class="n">V_RES_LOST</span><span class="p">);</span> <span class="cm">/* clear irq! */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">V_MISC_IRQSTA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* misc IRQ */</span>
		<span class="n">r_irq_misc</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_IRQ_MISC</span><span class="p">);</span>
		<span class="n">r_irq_misc</span> <span class="o">&amp;=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_irqmsk_misc</span><span class="p">;</span> <span class="cm">/* ignore disabled irqs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r_irq_misc</span> <span class="o">&amp;</span> <span class="n">V_STA_IRQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* state machine */</span>
				<span class="n">dch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">dch</span><span class="p">;</span>
				<span class="n">e1_syncsta</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SYNC_STA</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span>
				    <span class="o">&amp;&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">e1_getclock</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">e1_syncsta</span> <span class="o">&amp;</span> <span class="n">V_FR_SYNC_E1</span><span class="p">)</span>
						<span class="n">hc</span><span class="o">-&gt;</span><span class="n">syncronized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">hc</span><span class="o">-&gt;</span><span class="n">syncronized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* undocumented: status changes during read */</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_E1_RD_STA</span><span class="p">);</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">temp</span> <span class="o">!=</span> <span class="p">(</span><span class="n">temp2</span> <span class="o">=</span>
						      <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_E1_RD_STA</span><span class="p">)))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_STATE</span><span class="p">)</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: reread &quot;</span>
						       <span class="s">&quot;STATE because %d!=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						    <span class="n">__func__</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">temp2</span><span class="p">);</span>
					<span class="n">temp</span> <span class="o">=</span> <span class="n">temp2</span><span class="p">;</span> <span class="cm">/* repeat */</span>
				<span class="p">}</span>
				<span class="cm">/* broadcast state change to all fragments */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_STATE</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s: E1 (id=%d) newstate %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">dch</span><span class="p">;</span>
					<span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
					<span class="n">schedule_event</span><span class="p">(</span><span class="n">dch</span><span class="p">,</span> <span class="n">FLG_PHCHANGE</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
					<span class="n">plxsd_checksync</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r_irq_misc</span> <span class="o">&amp;</span> <span class="n">V_TI_IRQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">iclock_on</span><span class="p">)</span>
				<span class="n">mISDN_clock_update</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">iclock</span><span class="p">,</span> <span class="n">poll</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">handle_timer_irq</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r_irq_misc</span> <span class="o">&amp;</span> <span class="n">V_DTMF_IRQ</span><span class="p">)</span>
			<span class="n">hfcmulti_dtmf</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r_irq_misc</span> <span class="o">&amp;</span> <span class="n">V_IRQ_PROC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">static</span> <span class="kt">int</span> <span class="n">irq_proc_cnt</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_proc_cnt</span><span class="o">++</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: got V_IRQ_PROC -&quot;</span>
				       <span class="s">&quot; this should not happen</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">V_FR_IRQSTA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIFO IRQ */</span>
		<span class="n">r_irq_oview</span> <span class="o">=</span> <span class="n">HFC_inb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_IRQ_OVIEW</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r_irq_oview</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
				<span class="n">fifo_irq</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef IRQ_DEBUG</span>
	<span class="n">irqsem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

<span class="nl">irq_notforus:</span>
<span class="cp">#ifdef IRQ_DEBUG</span>
	<span class="n">irqsem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * timer callback for D-chan busy resolution. Currently no function</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcmulti_dbusy_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * activate/deactivate hardware for selected channels and mode</span>
<span class="cm"> *</span>
<span class="cm"> * configure B-channel with the given protocol</span>
<span class="cm"> * ch eqals to the HFC-channel (0-31)</span>
<span class="cm"> * ch is the number of channel (0-4,4-7,8-11,12-15,16-19,20-23,24-27,28-31</span>
<span class="cm"> * for S/T, 1-31 for E1)</span>
<span class="cm"> * the hdlc interrupts will be set/unset</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mode_hfcmulti</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot_tx</span><span class="p">,</span>
	      <span class="kt">int</span> <span class="n">bank_tx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot_rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bank_rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flow_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">flow_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">routing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oslot_tx</span><span class="p">,</span> <span class="n">oslot_rx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">conf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">oslot_tx</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">slot_tx</span><span class="p">;</span>
	<span class="n">oslot_rx</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">slot_rx</span><span class="p">;</span>
	<span class="n">conf</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">conf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MODE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;%s: card %d channel %d protocol %x slot old=%d new=%d &quot;</span>
		       <span class="s">&quot;bank new=%d (TX) slot old=%d new=%d bank new=%d (RX)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">oslot_tx</span><span class="p">,</span> <span class="n">slot_tx</span><span class="p">,</span>
		       <span class="n">bank_tx</span><span class="p">,</span> <span class="n">oslot_rx</span><span class="p">,</span> <span class="n">slot_rx</span><span class="p">,</span> <span class="n">bank_rx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oslot_tx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">slot_tx</span> <span class="o">!=</span> <span class="n">oslot_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* remove from slot */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MODE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: remove from slot %d (TX)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">oslot_tx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">slot_owner</span><span class="p">[</span><span class="n">oslot_tx</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SLOT</span><span class="p">,</span> <span class="n">oslot_tx</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_SL_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">!=</span> <span class="n">HFC_TYPE_XHFC</span><span class="p">)</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CONF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">slot_owner</span><span class="p">[</span><span class="n">oslot_tx</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MODE</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: we are not owner of this tx slot &quot;</span>
				       <span class="s">&quot;anymore, channel %d is.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">slot_owner</span><span class="p">[</span><span class="n">oslot_tx</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oslot_rx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">slot_rx</span> <span class="o">!=</span> <span class="n">oslot_rx</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* remove from slot */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MODE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;%s: remove from slot %d (RX)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">oslot_rx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">slot_owner</span><span class="p">[(</span><span class="n">oslot_rx</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SLOT</span><span class="p">,</span> <span class="p">(</span><span class="n">oslot_rx</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_SL_DIR</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_SL_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">slot_owner</span><span class="p">[(</span><span class="n">oslot_rx</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MODE</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: we are not owner of this rx slot &quot;</span>
				       <span class="s">&quot;anymore, channel %d is.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span>
				       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">slot_owner</span><span class="p">[(</span><span class="n">oslot_rx</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot_tx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flow_tx</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* FIFO-&gt;ST */</span>
		<span class="cm">/* disable pcm slot */</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">slot_tx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bank_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* set pcm slot */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">txpending</span><span class="p">)</span>
			<span class="n">flow_tx</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* FIFO-&gt;ST */</span>
		<span class="k">else</span>
			<span class="n">flow_tx</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span> <span class="cm">/* PCM-&gt;ST */</span>
		<span class="cm">/* put on slot */</span>
		<span class="n">routing</span> <span class="o">=</span> <span class="n">bank_tx</span> <span class="o">?</span> <span class="mh">0xc0</span> <span class="o">:</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">bank_tx</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">routing</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span> <span class="cm">/* loop */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MODE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: put channel %d to slot %d bank&quot;</span>
			       <span class="s">&quot; %d flow %02x routing %02x conf %d (TX)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">slot_tx</span><span class="p">,</span> <span class="n">bank_tx</span><span class="p">,</span>
			       <span class="n">flow_tx</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span> <span class="n">conf</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SLOT</span><span class="p">,</span> <span class="n">slot_tx</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_SL_CFG</span><span class="p">,</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">routing</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">!=</span> <span class="n">HFC_TYPE_XHFC</span><span class="p">)</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CONF</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">conf</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">conf</span> <span class="o">|</span> <span class="n">V_CONF_SL</span><span class="p">));</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">slot_owner</span><span class="p">[</span><span class="n">slot_tx</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">slot_tx</span> <span class="o">=</span> <span class="n">slot_tx</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bank_tx</span> <span class="o">=</span> <span class="n">bank_tx</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot_rx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable pcm slot */</span>
		<span class="n">flow_rx</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* ST-&gt;FIFO */</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">slot_rx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bank_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* set pcm slot */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">txpending</span><span class="p">)</span>
			<span class="n">flow_rx</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* ST-&gt;FIFO */</span>
		<span class="k">else</span>
			<span class="n">flow_rx</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span> <span class="cm">/* ST-&gt;(FIFO,PCM) */</span>
		<span class="cm">/* put on slot */</span>
		<span class="n">routing</span> <span class="o">=</span> <span class="n">bank_rx</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mh">0xc0</span><span class="p">;</span> <span class="cm">/* reversed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">bank_rx</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">routing</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span> <span class="cm">/* loop */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MODE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: put channel %d to slot %d bank&quot;</span>
			       <span class="s">&quot; %d flow %02x routing %02x conf %d (RX)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">slot_rx</span><span class="p">,</span> <span class="n">bank_rx</span><span class="p">,</span>
			       <span class="n">flow_rx</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span> <span class="n">conf</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SLOT</span><span class="p">,</span> <span class="p">(</span><span class="n">slot_rx</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_SL_DIR</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_SL_CFG</span><span class="p">,</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">V_CH_DIR</span> <span class="o">|</span> <span class="n">routing</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">slot_owner</span><span class="p">[(</span><span class="n">slot_rx</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">slot_rx</span> <span class="o">=</span> <span class="n">slot_rx</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bank_rx</span> <span class="o">=</span> <span class="n">bank_rx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_P_NONE</span><span class="p">)</span>:
		<span class="cm">/* disable TX fifo */</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">HFC_wait</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CON_HDLC</span><span class="p">,</span> <span class="n">flow_tx</span> <span class="o">|</span> <span class="mh">0x00</span> <span class="o">|</span> <span class="n">V_IFF</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_SUBCH_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_IRQ_MSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_INC_RES_FIFO</span><span class="p">,</span> <span class="n">V_RES_F</span><span class="p">);</span>
		<span class="n">HFC_wait</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="cm">/* disable RX fifo */</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">HFC_wait</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CON_HDLC</span><span class="p">,</span> <span class="n">flow_rx</span> <span class="o">|</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_SUBCH_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_IRQ_MSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_INC_RES_FIFO</span><span class="p">,</span> <span class="n">V_RES_F</span><span class="p">);</span>
		<span class="n">HFC_wait</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span> <span class="o">&amp;&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">!=</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">a_st_ctrl0</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">port</span><span class="p">]</span> <span class="o">&amp;=</span>
				<span class="p">((</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="o">~</span><span class="n">V_B1_EN</span> <span class="o">:</span> <span class="o">~</span><span class="n">V_B2_EN</span><span class="p">;</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_ST_SEL</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
			<span class="cm">/* undocumented: delay after R_ST_SEL */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_CTRL0</span><span class="p">,</span>
				 <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">a_st_ctrl0</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">port</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_HDLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_TRANSPARENT</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_P_B_RAW</span><span class="p">)</span>: <span class="cm">/* B-channel */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_B410P</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">slot_rx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">slot_tx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;Setting B-channel %d to echo cancelable &quot;</span>
			       <span class="s">&quot;state on PCM slot %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span>
			       <span class="p">((</span><span class="n">ch</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">ch</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;Enabling pass through for channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">vpm_out</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="p">((</span><span class="n">ch</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
				<span class="p">((</span><span class="n">ch</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
			<span class="cm">/* rx path */</span>
			<span class="cm">/* S/T -&gt; PCM */</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">HFC_wait</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CON_HDLC</span><span class="p">,</span> <span class="mh">0xc0</span> <span class="o">|</span> <span class="n">V_HDLC_TRP</span> <span class="o">|</span> <span class="n">V_IFF</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SLOT</span><span class="p">,</span> <span class="p">(((</span><span class="n">ch</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
					      <span class="p">((</span><span class="n">ch</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_SL_CFG</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>

			<span class="cm">/* PCM -&gt; FIFO */</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="mh">0x20</span> <span class="o">|</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">HFC_wait</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CON_HDLC</span><span class="p">,</span> <span class="mh">0x20</span> <span class="o">|</span> <span class="n">V_HDLC_TRP</span> <span class="o">|</span> <span class="n">V_IFF</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_SUBCH_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_IRQ_MSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_INC_RES_FIFO</span><span class="p">,</span> <span class="n">V_RES_F</span><span class="p">);</span>
				<span class="n">HFC_wait</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SLOT</span><span class="p">,</span> <span class="p">((((</span><span class="n">ch</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
					       <span class="p">((</span><span class="n">ch</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_SL_CFG</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="mh">0x20</span> <span class="o">|</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>

			<span class="cm">/* tx path */</span>
			<span class="cm">/* PCM -&gt; S/T */</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">HFC_wait</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CON_HDLC</span><span class="p">,</span> <span class="mh">0xc0</span> <span class="o">|</span> <span class="n">V_HDLC_TRP</span> <span class="o">|</span> <span class="n">V_IFF</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SLOT</span><span class="p">,</span> <span class="p">((((</span><span class="n">ch</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
					       <span class="p">((</span><span class="n">ch</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_SL_CFG</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>

			<span class="cm">/* FIFO -&gt; PCM */</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="mh">0x20</span> <span class="o">|</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">HFC_wait</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CON_HDLC</span><span class="p">,</span> <span class="mh">0x20</span> <span class="o">|</span> <span class="n">V_HDLC_TRP</span> <span class="o">|</span> <span class="n">V_IFF</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_SUBCH_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_IRQ_MSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_INC_RES_FIFO</span><span class="p">,</span> <span class="n">V_RES_F</span><span class="p">);</span>
				<span class="n">HFC_wait</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* tx silence */</span>
			<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_FIFO_DATA0_NOINC</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">silence</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SLOT</span><span class="p">,</span> <span class="p">(((</span><span class="n">ch</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
					      <span class="p">((</span><span class="n">ch</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_SL_CFG</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="mh">0x20</span> <span class="o">|</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* enable TX fifo */</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">HFC_wait</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_XHFC</span><span class="p">)</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CON_HDLC</span><span class="p">,</span> <span class="n">flow_tx</span> <span class="o">|</span> <span class="mh">0x07</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">|</span>
					 <span class="n">V_HDLC_TRP</span> <span class="o">|</span> <span class="n">V_IFF</span><span class="p">);</span>
			<span class="cm">/* Enable FIFO, no interrupt */</span>
			<span class="k">else</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CON_HDLC</span><span class="p">,</span> <span class="n">flow_tx</span> <span class="o">|</span> <span class="mh">0x00</span> <span class="o">|</span>
					 <span class="n">V_HDLC_TRP</span> <span class="o">|</span> <span class="n">V_IFF</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_SUBCH_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_IRQ_MSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_INC_RES_FIFO</span><span class="p">,</span> <span class="n">V_RES_F</span><span class="p">);</span>
				<span class="n">HFC_wait</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* tx silence */</span>
			<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_FIFO_DATA0_NOINC</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">silence</span><span class="p">);</span>
			<span class="cm">/* enable RX fifo */</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">HFC_wait</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_XHFC</span><span class="p">)</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CON_HDLC</span><span class="p">,</span> <span class="n">flow_rx</span> <span class="o">|</span> <span class="mh">0x07</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">|</span>
					 <span class="n">V_HDLC_TRP</span><span class="p">);</span>
			<span class="cm">/* Enable FIFO, no interrupt*/</span>
			<span class="k">else</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CON_HDLC</span><span class="p">,</span> <span class="n">flow_rx</span> <span class="o">|</span> <span class="mh">0x00</span> <span class="o">|</span>
					 <span class="n">V_HDLC_TRP</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_SUBCH_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_IRQ_MSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_INC_RES_FIFO</span><span class="p">,</span> <span class="n">V_RES_F</span><span class="p">);</span>
				<span class="n">HFC_wait</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">!=</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">a_st_ctrl0</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">port</span><span class="p">]</span> <span class="o">|=</span>
				<span class="p">((</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">V_B1_EN</span> <span class="o">:</span> <span class="n">V_B2_EN</span><span class="p">;</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_ST_SEL</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
			<span class="cm">/* undocumented: delay after R_ST_SEL */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_CTRL0</span><span class="p">,</span>
				 <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">a_st_ctrl0</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">port</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span><span class="p">)</span>
			<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_TRANSPARENT</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_P_B_HDLC</span><span class="p">)</span>: <span class="cm">/* B-channel */</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_P_TE_S0</span><span class="p">)</span>: <span class="cm">/* D-channel */</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_P_NT_S0</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_P_TE_E1</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">ISDN_P_NT_E1</span><span class="p">)</span>:
		<span class="cm">/* enable TX fifo */</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">HFC_wait</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span> <span class="o">||</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* E1 or B-channel */</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CON_HDLC</span><span class="p">,</span> <span class="n">flow_tx</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_SUBCH_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* D-Channel without HDLC fill flags */</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CON_HDLC</span><span class="p">,</span> <span class="n">flow_tx</span> <span class="o">|</span> <span class="mh">0x04</span> <span class="o">|</span> <span class="n">V_IFF</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_SUBCH_CFG</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_IRQ_MSK</span><span class="p">,</span> <span class="n">V_IRQ</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_INC_RES_FIFO</span><span class="p">,</span> <span class="n">V_RES_F</span><span class="p">);</span>
		<span class="n">HFC_wait</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="cm">/* enable RX fifo */</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">HFC_wait</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_CON_HDLC</span><span class="p">,</span> <span class="n">flow_rx</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span> <span class="o">||</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span><span class="p">)</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_SUBCH_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* full 8 bits */</span>
		<span class="k">else</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_SUBCH_CFG</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* 2 bits dchannel */</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_IRQ_MSK</span><span class="p">,</span> <span class="n">V_IRQ</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_INC_RES_FIFO</span><span class="p">,</span> <span class="n">V_RES_F</span><span class="p">);</span>
		<span class="n">HFC_wait</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_HDLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">!=</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">a_st_ctrl0</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">port</span><span class="p">]</span> <span class="o">|=</span>
					<span class="p">((</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">V_B1_EN</span> <span class="o">:</span> <span class="n">V_B2_EN</span><span class="p">;</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_ST_SEL</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
				<span class="cm">/* undocumented: delay after R_ST_SEL */</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_CTRL0</span><span class="p">,</span>
					 <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">a_st_ctrl0</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">port</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: protocol not known %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">protocol</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ISDN_P_NONE</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * connect/disconnect PCM</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcmulti_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot_tx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bank_tx</span><span class="p">,</span>
	     <span class="kt">int</span> <span class="n">slot_rx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bank_rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot_tx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">slot_rx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">bank_tx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">bank_rx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable PCM */</span>
		<span class="n">mode_hfcmulti</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">protocol</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* enable pcm */</span>
	<span class="n">mode_hfcmulti</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">protocol</span><span class="p">,</span> <span class="n">slot_tx</span><span class="p">,</span> <span class="n">bank_tx</span><span class="p">,</span>
		      <span class="n">slot_rx</span><span class="p">,</span> <span class="n">bank_rx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set/disable conference</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcmulti_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">conf</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">conf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">mode_hfcmulti</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">protocol</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">slot_tx</span><span class="p">,</span>
		      <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bank_tx</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">slot_rx</span><span class="p">,</span>
		      <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bank_rx</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * set/disable sample loop</span>
<span class="cm"> */</span>

<span class="cm">/* NOTE: this function is experimental and therefore disabled */</span>

<span class="cm">/*</span>
<span class="cm"> * Layer 1 callback function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfcm_l1callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfc_multi</span>	<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u_long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INFO3_P8</span>:
	<span class="k">case</span> <span class="n">INFO3_P10</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_RESET_REQ</span>:
		<span class="cm">/* start activation */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MSG</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: HW_RESET_REQ no BRI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_ST_SEL</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
			<span class="cm">/* undocumented: delay after R_ST_SEL */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_WR_STATE</span><span class="p">,</span> <span class="n">V_ST_LD_STA</span> <span class="o">|</span> <span class="mi">3</span><span class="p">);</span> <span class="cm">/* F3 */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span> <span class="cm">/* wait at least 5,21us */</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_WR_STATE</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_WR_STATE</span><span class="p">,</span> <span class="mi">3</span> <span class="o">|</span> <span class="p">(</span><span class="n">V_ST_ACT</span> <span class="o">*</span> <span class="mi">3</span><span class="p">));</span>
			<span class="cm">/* activate */</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">HW_POWERUP_IND</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_DEACT_REQ</span>:
		<span class="cm">/* start deactivation */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MSG</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: HW_DEACT_REQ no BRI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_ST_SEL</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
			<span class="cm">/* undocumented: delay after R_ST_SEL */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_WR_STATE</span><span class="p">,</span> <span class="n">V_ST_ACT</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
			<span class="cm">/* deactivate */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">syncronized</span> <span class="o">&amp;=</span>
					<span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
				<span class="n">plxsd_checksync</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
			<span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
			<span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_TX_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_BUSY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HW_POWERUP_REQ</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MSG</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: HW_POWERUP_REQ no BRI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_ST_SEL</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
			<span class="cm">/* undocumented: delay after R_ST_SEL */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_WR_STATE</span><span class="p">,</span> <span class="mi">3</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">);</span> <span class="cm">/* activate */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span> <span class="cm">/* wait at least 5,21us */</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_WR_STATE</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="cm">/* activate */</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_ACTIVATE_IND</span>:
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_DEACTIVATE_IND</span>:
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: unknown command %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Layer2 -&gt; Layer 1 Transfer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">handle_dmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">mISDNchannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mISDNdevice</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mISDNdevice</span><span class="p">,</span> <span class="n">D</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dchannel</span>		<span class="o">*</span><span class="n">dch</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dchannel</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hfc_multi</span>	<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mISDNhead</span>	<span class="o">*</span><span class="n">hh</span> <span class="o">=</span> <span class="n">mISDN_HEAD_P</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">id</span><span class="p">;</span>
	<span class="n">u_long</span>			<span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PH_DATA_REQ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dchannel_senddata</span><span class="p">(</span><span class="n">dch</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* direct TX */</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span> <span class="cm">/* skb can be freed */</span>
			<span class="n">hfcmulti_tx</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* start fifo */</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">HFC_wait</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">queue_ch_frame</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_DATA_CNF</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_ACTIVATE_REQ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MSG</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: PH_ACTIVATE port %d (0..%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">port</span><span class="p">,</span>
				       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="cm">/* start activation */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ph_state_change</span><span class="p">(</span><span class="n">dch</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_STATE</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s: E1 report state %x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">__func__</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_ST_SEL</span><span class="p">,</span>
					 <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
				<span class="cm">/* undocumented: delay after R_ST_SEL */</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_WR_STATE</span><span class="p">,</span> <span class="n">V_ST_LD_STA</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
				<span class="cm">/* G1 */</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span> <span class="cm">/* wait at least 5,21us */</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_WR_STATE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_WR_STATE</span><span class="p">,</span> <span class="mi">1</span> <span class="o">|</span>
					 <span class="p">(</span><span class="n">V_ST_ACT</span> <span class="o">*</span> <span class="mi">3</span><span class="p">));</span> <span class="cm">/* activate */</span>
				<span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_DEACTIVATE_REQ</span>:
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L2_ACTIVATED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MSG</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: PH_DEACTIVATE port %d (0..%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">port</span><span class="p">,</span>
				       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="cm">/* start deactivation */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MSG</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s: PH_DEACTIVATE no BRI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">__func__</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_ST_SEL</span><span class="p">,</span>
					 <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
				<span class="cm">/* undocumented: delay after R_ST_SEL */</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_WR_STATE</span><span class="p">,</span> <span class="n">V_ST_ACT</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
				<span class="cm">/* deactivate */</span>
				<span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
				<span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dch</span><span class="o">-&gt;</span><span class="n">tx_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
				<span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_TX_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_BUSY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
				<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="cp">#ifdef FIXME</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_L1_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
				<span class="n">dchannel_sched_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dch</span><span class="p">,</span> <span class="n">D_CLEARBUSY</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">deactivate_bchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfc_multi</span>	<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u_long</span>			<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mISDN_clear_bchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">coeff_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">rx_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">conf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">mode_hfcmulti</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span> <span class="n">ISDN_P_NONE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">handle_bmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">mISDNchannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bchannel</span>		<span class="o">*</span><span class="n">bch</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bchannel</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hfc_multi</span>	<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mISDNhead</span>	<span class="o">*</span><span class="n">hh</span> <span class="o">=</span> <span class="n">mISDN_HEAD_P</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PH_DATA_REQ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">bchannel_senddata</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* direct TX */</span>
			<span class="n">hfcmulti_tx</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* start fifo */</span>
			<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">HFC_wait_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_ACTIVATE_REQ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MSG</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: PH_ACTIVATE ch %d (0..32)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* activate B-channel if not already activated */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">txpending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mode_hfcmulti</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span>
					    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">,</span>
					    <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_tx</span><span class="p">,</span>
					    <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">bank_tx</span><span class="p">,</span>
					    <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">slot_rx</span><span class="p">,</span>
					    <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">bank_rx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_B_RAW</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dtmf</span>
				    <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_DTMF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* start decoder */</span>
					<span class="n">hc</span><span class="o">-&gt;</span><span class="n">dtmf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_DTMF</span><span class="p">)</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
						       <span class="s">&quot;%s: start dtmf decoder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">__func__</span><span class="p">);</span>
					<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_DTMF</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_dtmf</span> <span class="o">|</span>
						 <span class="n">V_RST_DTMF</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">_queue_data</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_ACTIVATE_IND</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				    <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_CONTROL_REQ</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HFC_SPL_LOOP_ON</span>: <span class="cm">/* set sample loop */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MSG</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: HFC_SPL_LOOP_ON (len = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HFC_SPL_LOOP_OFF</span>: <span class="cm">/* set silence */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MSG</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: HFC_SPL_LOOP_OFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;%s: unknown PH_CONTROL_REQ info %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_DEACTIVATE_REQ</span>:
		<span class="n">deactivate_bchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span> <span class="cm">/* locked there */</span>
		<span class="n">_queue_data</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_DEACTIVATE_IND</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * bchannel control function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">channel_bctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mISDN_ctrl_req</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_features</span>	<span class="o">*</span><span class="n">features</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">dsp_features</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">((</span><span class="n">u_long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">hfc_multi</span>	<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">slot_tx</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">bank_tx</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">slot_rx</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">bank_rx</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">num</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_GETOP</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mISDN_ctrl_bchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">cq</span><span class="p">);</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">|=</span> <span class="n">MISDN_CTRL_HFC_OP</span> <span class="o">|</span> <span class="n">MISDN_CTRL_HW_FEATURES_OP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_RX_OFF</span>: <span class="cm">/* turn off / on rx stream */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mISDN_ctrl_bchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">cq</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">rx_off</span> <span class="o">=</span> <span class="o">!!</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">rx_off</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* reset fifo on rx on */</span>
			<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">HFC_wait_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
			<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_INC_RES_FIFO</span><span class="p">,</span> <span class="n">V_RES_F</span><span class="p">);</span>
			<span class="n">HFC_wait_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MSG</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: RX_OFF request (nr=%d off=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">rx_off</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_FILL_EMPTY</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mISDN_ctrl_bchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">cq</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">silence</span> <span class="o">=</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">fill</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">silence_data</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">silence</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">silence_data</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_HW_FEATURES</span>: <span class="cm">/* fill features structure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MSG</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: HW_FEATURE request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
		<span class="cm">/* create confirm */</span>
		<span class="n">features</span><span class="o">-&gt;</span><span class="n">hfc_id</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_DTMF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
			<span class="n">features</span><span class="o">-&gt;</span><span class="n">hfc_dtmf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_CONF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
			<span class="n">features</span><span class="o">-&gt;</span><span class="n">hfc_conf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">features</span><span class="o">-&gt;</span><span class="n">hfc_loops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_B410P</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">features</span><span class="o">-&gt;</span><span class="n">hfc_echocanhw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">features</span><span class="o">-&gt;</span><span class="n">pcm_id</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">;</span>
			<span class="n">features</span><span class="o">-&gt;</span><span class="n">pcm_slots</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">;</span>
			<span class="n">features</span><span class="o">-&gt;</span><span class="n">pcm_banks</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_HFC_PCM_CONN</span>: <span class="cm">/* connect to pcm timeslot (0..N) */</span>
		<span class="n">slot_tx</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">bank_tx</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">slot_rx</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">p2</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">bank_rx</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">p2</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MSG</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;%s: HFC_PCM_CONN slot %d bank %d (TX) &quot;</span>
			       <span class="s">&quot;slot %d bank %d (RX)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">slot_tx</span><span class="p">,</span> <span class="n">bank_tx</span><span class="p">,</span>
			       <span class="n">slot_rx</span><span class="p">,</span> <span class="n">bank_rx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot_tx</span> <span class="o">&lt;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">slots</span> <span class="o">&amp;&amp;</span> <span class="n">bank_tx</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span>
		    <span class="n">slot_rx</span> <span class="o">&lt;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">slots</span> <span class="o">&amp;&amp;</span> <span class="n">bank_rx</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">hfcmulti_pcm</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span>
				     <span class="n">slot_tx</span><span class="p">,</span> <span class="n">bank_tx</span><span class="p">,</span> <span class="n">slot_rx</span><span class="p">,</span> <span class="n">bank_rx</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;%s: HFC_PCM_CONN slot %d bank %d (TX) &quot;</span>
			       <span class="s">&quot;slot %d bank %d (RX) out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">slot_tx</span><span class="p">,</span> <span class="n">bank_tx</span><span class="p">,</span>
			       <span class="n">slot_rx</span><span class="p">,</span> <span class="n">bank_rx</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_HFC_PCM_DISC</span>: <span class="cm">/* release interface from pcm timeslot */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MSG</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: HFC_PCM_DISC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
		<span class="n">hfcmulti_pcm</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_HFC_CONF_JOIN</span>: <span class="cm">/* join conference (0..7) */</span>
		<span class="n">num</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MSG</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: HFC_CONF_JOIN conf %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">hfcmulti_conf</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;%s: HW_CONF_JOIN conf %d out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_HFC_CONF_SPLIT</span>: <span class="cm">/* split conference */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MSG</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: HFC_CONF_SPLIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">hfcmulti_conf</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_HFC_ECHOCAN_ON</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MSG</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: HFC_ECHOCAN_ON</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_B410P</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
			<span class="n">vpm_echocan_on</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MISDN_CTRL_HFC_ECHOCAN_OFF</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MSG</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: HFC_ECHOCAN_OFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_B410P</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
			<span class="n">vpm_echocan_off</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mISDN_ctrl_bchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">cq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfcm_bctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mISDNchannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bchannel</span>		<span class="o">*</span><span class="n">bch</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bchannel</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hfc_multi</span>	<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u_long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: cmd:%x %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CLOSE_CHANNEL</span>:
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_OPEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">deactivate_bchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span> <span class="cm">/* locked there */</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ISDN_P_NONE</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">peer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CONTROL_CHANNEL</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">channel_bctrl</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: unknown prim(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * handle D-channel events</span>
<span class="cm"> *</span>
<span class="cm"> * handle state change event</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ph_state_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: ERROR given dch is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hc</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_TE_E1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_STATE</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: E1 TE (id=%d) newstate %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_STATE</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: E1 NT (id=%d) newstate %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">e1_state</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* reset fifos on e1 activation */</span>
					<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_FIFO</span><span class="p">,</span>
							 <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
					<span class="n">HFC_wait_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
					<span class="n">HFC_outb_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_INC_RES_FIFO</span><span class="p">,</span>
							 <span class="n">V_RES_F</span><span class="p">);</span>
					<span class="n">HFC_wait_nodebug</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
			<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">PH_ACTIVATE_IND</span><span class="p">,</span>
				    <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">e1_state</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
			<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">PH_DEACTIVATE_IND</span><span class="p">,</span>
				    <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">e1_state</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_STATE</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: S/T TE newstate %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
				<span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">HW_RESET_IND</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>:
				<span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">HW_DEACT_IND</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span>:
			<span class="k">case</span> <span class="p">(</span><span class="mi">8</span><span class="p">)</span>:
				<span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">ANYSIGNAL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span>:
				<span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">INFO2</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">7</span><span class="p">)</span>:
				<span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">INFO4_P8</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_STATE</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: S/T NT newstate %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">nt_timer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
					<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_ST_SEL</span><span class="p">,</span>
						 <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
					<span class="cm">/* undocumented: delay after R_ST_SEL */</span>
					<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
					<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_WR_STATE</span><span class="p">,</span> <span class="mi">4</span> <span class="o">|</span>
						 <span class="n">V_ST_LD_STA</span><span class="p">);</span> <span class="cm">/* G4 */</span>
					<span class="n">udelay</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span> <span class="cm">/* wait at least 5,21us */</span>
					<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_WR_STATE</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
					<span class="n">dch</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* one extra count for the next event */</span>
					<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">nt_timer</span> <span class="o">=</span>
						<span class="n">nt_t1_count</span><span class="p">[</span><span class="n">poll_timer</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_ST_SEL</span><span class="p">,</span>
						 <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
					<span class="cm">/* undocumented: delay after R_ST_SEL */</span>
					<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
					<span class="cm">/* allow G2 -&gt; G3 transition */</span>
					<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_WR_STATE</span><span class="p">,</span> <span class="mi">2</span> <span class="o">|</span>
						 <span class="n">V_SET_G2_G3</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>:
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
				<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">PH_DEACTIVATE_IND</span><span class="p">,</span>
					    <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>:
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>:
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
				<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">PH_ACTIVATE_IND</span><span class="p">,</span>
					    <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called for card mode init message</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">hfcmulti_initmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u_char</span>		<span class="n">a_st_wr_state</span><span class="p">,</span> <span class="n">r_e1_wr_sta</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">,</span> <span class="n">pt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: entered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">;</span>
	<span class="n">pt</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* E1 */</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="n">pt</span><span class="p">]].</span><span class="n">slot_tx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="n">pt</span><span class="p">]].</span><span class="n">slot_rx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="n">pt</span><span class="p">]].</span><span class="n">conf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="n">pt</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">mode_hfcmulti</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span>
				      <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">dch</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hfcmulti_dbusy_timer</span><span class="p">;</span>
			<span class="n">dch</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">dch</span><span class="p">;</span>
			<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">bmask</span><span class="p">[</span><span class="n">pt</span><span class="p">]))</span> <span class="cm">/* skip unused chan */</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">slot_tx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">slot_rx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">conf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">mode_hfcmulti</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ISDN_P_NONE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span> <span class="o">&amp;&amp;</span> <span class="n">pt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* E1, port 0 */</span>
		<span class="n">dch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">dch</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_REPORT_LOS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">cfg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_LOS0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span> <span class="cm">/* 2 ms */</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_LOS1</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span> <span class="cm">/* 512 ms */</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_OPTICAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">cfg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RX0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_tx0</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">|</span> <span class="n">V_OUT_EN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RX0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_tx0</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">V_OUT_EN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_tx1</span> <span class="o">=</span> <span class="n">V_ATX</span> <span class="o">|</span> <span class="n">V_NTRI</span><span class="p">;</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_TX0</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_tx0</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_TX1</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_tx1</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_TX_FR0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_TX_FR1</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_CRC4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">cfg</span><span class="p">))</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_TX_FR2</span><span class="p">,</span> <span class="n">V_TX_MF</span> <span class="o">|</span> <span class="n">V_TX_E</span> <span class="o">|</span> <span class="n">V_NEG_E</span><span class="p">);</span>

		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RX_FR0</span><span class="p">,</span> <span class="n">V_AUTO_RESYNC</span> <span class="o">|</span> <span class="n">V_AUTO_RECO</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_CRC4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">cfg</span><span class="p">))</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_RX_FR1</span><span class="p">,</span> <span class="n">V_RX_MF</span> <span class="o">|</span> <span class="n">V_RX_MF_SYNC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_E1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: E1 port is NT-mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">);</span>
			<span class="n">r_e1_wr_sta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* G0 */</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">e1_getclock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: E1 port is TE-mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">);</span>
			<span class="n">r_e1_wr_sta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* F0 */</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">e1_getclock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_RX_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SYNC_OUT</span><span class="p">,</span> <span class="n">V_SYNC_E1_RX</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SYNC_OUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_E1CLOCK_GET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">e1_getclock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_E1CLOCK_PUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">e1_getclock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PCM_SLAVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* SLAVE (clock master) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: E1 port is clock master &quot;</span>
				       <span class="s">&quot;(clock from PCM)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SYNC_CTRL</span><span class="p">,</span> <span class="n">V_EXT_CLK_SYNC</span> <span class="o">|</span> <span class="n">V_PCM_SYNC</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">e1_getclock</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* MASTER (clock slave) */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s: E1 port is clock slave &quot;</span>
					       <span class="s">&quot;(clock to PCM)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SYNC_CTRL</span><span class="p">,</span> <span class="n">V_SYNC_OFFS</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* MASTER (clock master) */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: E1 port is &quot;</span>
					       <span class="s">&quot;clock master &quot;</span>
					       <span class="s">&quot;(clock from QUARTZ)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">__func__</span><span class="p">);</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SYNC_CTRL</span><span class="p">,</span> <span class="n">V_EXT_CLK_SYNC</span> <span class="o">|</span>
					 <span class="n">V_PCM_SYNC</span> <span class="o">|</span> <span class="n">V_JATT_OFF</span><span class="p">);</span>
				<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SYNC_OUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_JATT_ATT</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">);</span> <span class="cm">/* undoc register */</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_PWM_MD</span><span class="p">,</span> <span class="n">V_PWM0_MD</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_PWM0</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_PWM1</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="cm">/* state machine setup */</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_E1_WR_STA</span><span class="p">,</span> <span class="n">r_e1_wr_sta</span> <span class="o">|</span> <span class="n">V_E1_LD_STA</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span> <span class="cm">/* wait at least 5,21us */</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_E1_WR_STA</span><span class="p">,</span> <span class="n">r_e1_wr_sta</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">syncronized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">plxsd_checksync</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">!=</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ST */</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">slot_tx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">slot_rx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">conf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">mode_hfcmulti</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dch</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hfcmulti_dbusy_timer</span><span class="p">;</span>
		<span class="n">dch</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">dch</span><span class="p">;</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">].</span><span class="n">slot_tx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">].</span><span class="n">slot_rx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">].</span><span class="n">conf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">mode_hfcmulti</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ISDN_P_NONE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">slot_tx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">slot_rx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">conf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">mode_hfcmulti</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ISDN_P_NONE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* select interface */</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_ST_SEL</span><span class="p">,</span> <span class="n">pt</span><span class="p">);</span>
		<span class="cm">/* undocumented: delay after R_ST_SEL */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_S0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: ST port %d is NT-mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">pt</span><span class="p">);</span>
			<span class="cm">/* clock delay */</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_CLK_DLY</span><span class="p">,</span> <span class="n">clockdelay_nt</span><span class="p">);</span>
			<span class="n">a_st_wr_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* G1 */</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">a_st_ctrl0</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="n">V_ST_MD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: ST port %d is TE-mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">pt</span><span class="p">);</span>
			<span class="cm">/* clock delay */</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_CLK_DLY</span><span class="p">,</span> <span class="n">clockdelay_te</span><span class="p">);</span>
			<span class="n">a_st_wr_state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* F2 */</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">a_st_ctrl0</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_NONCAP_TX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cfg</span><span class="p">))</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">a_st_ctrl0</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">|=</span> <span class="n">V_TX_LI</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_XHFC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">a_st_ctrl0</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span> <span class="cm">/* V_ST_PU_CTRL */</span><span class="p">;</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="mh">0x35</span> <span class="cm">/* A_ST_CTRL3 */</span><span class="p">,</span>
				 <span class="mh">0x7c</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="cm">/* V_ST_PULSE */</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* line setup */</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_CTRL0</span><span class="p">,</span>  <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">a_st_ctrl0</span><span class="p">[</span><span class="n">pt</span><span class="p">]);</span>
		<span class="cm">/* disable E-channel */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NT_S0</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CFG_DIS_ECHANNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cfg</span><span class="p">))</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_CTRL1</span><span class="p">,</span> <span class="n">V_E_IGNO</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_CTRL1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* enable B-channel receive */</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_CTRL2</span><span class="p">,</span>  <span class="n">V_B1_RX_EN</span> <span class="o">|</span> <span class="n">V_B2_RX_EN</span><span class="p">);</span>
		<span class="cm">/* state machine setup */</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_WR_STATE</span><span class="p">,</span> <span class="n">a_st_wr_state</span> <span class="o">|</span> <span class="n">V_ST_LD_STA</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span> <span class="cm">/* wait at least 5,21us */</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">A_ST_WR_STATE</span><span class="p">,</span> <span class="n">a_st_wr_state</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_sci_msk</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pt</span><span class="p">;</span>
		<span class="cm">/* state machine interrupts */</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_SCI_MSK</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_sci_msk</span><span class="p">);</span>
		<span class="cm">/* unset sync on port */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">syncronized</span> <span class="o">&amp;=</span>
				<span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
			<span class="n">plxsd_checksync</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">open_dchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">channel_req</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_OPEN</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: dev(%d) open from %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">ISDN_P_NONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MODE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: change protocol %x to %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">ISDN_P_TE_S0</span><span class="p">))</span>
		<span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">CLOSE_CHANNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">create_l1</span><span class="p">(</span><span class="n">dch</span><span class="p">,</span> <span class="n">hfcm_l1callback</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">hfcmulti_initmode</span><span class="p">(</span><span class="n">dch</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
		<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">PH_ACTIVATE_IND</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span>
			    <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:cannot get module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">open_bchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">channel_req</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bchannel</span>	<span class="o">*</span><span class="n">bch</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_channelmap</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">channelmap</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">bch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:internal error ch %d has no bch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_OPEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span> <span class="cm">/* b-channel can be only open once */</span>
	<span class="n">bch</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">rx_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:cannot get module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * device control function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">channel_dctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mISDN_ctrl_req</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfc_multi</span>	<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">wd_mode</span><span class="p">,</span> <span class="n">wd_cnt</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_GETOP</span>:
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">MISDN_CTRL_HFC_OP</span> <span class="o">|</span> <span class="n">MISDN_CTRL_L1_TIMER3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_HFC_WD_INIT</span>: <span class="cm">/* init the watchdog */</span>
		<span class="n">wd_cnt</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">wd_mode</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MSG</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: MISDN_CTRL_HFC_WD_INIT mode %s&quot;</span>
			       <span class="s">&quot;, counter 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			       <span class="n">wd_mode</span> <span class="o">?</span> <span class="s">&quot;AUTO&quot;</span> <span class="o">:</span> <span class="s">&quot;MANUAL&quot;</span><span class="p">,</span> <span class="n">wd_cnt</span><span class="p">);</span>
		<span class="cm">/* set the watchdog timer */</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_TI_WD</span><span class="p">,</span> <span class="n">poll_timer</span> <span class="o">|</span> <span class="p">(</span><span class="n">wd_cnt</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_bert_wd_md</span> <span class="o">=</span> <span class="p">(</span><span class="n">wd_mode</span> <span class="o">?</span> <span class="n">V_AUTO_WD_RES</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_XHFC</span><span class="p">)</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_bert_wd_md</span> <span class="o">|=</span> <span class="mh">0x40</span> <span class="cm">/* V_WD_EN */</span><span class="p">;</span>
		<span class="cm">/* init the watchdog register and reset the counter */</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_BERT_WD_MD</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_bert_wd_md</span> <span class="o">|</span> <span class="n">V_WD_RES</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* enable the watchdog output for Speech-Design */</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_SEL</span><span class="p">,</span>  <span class="n">V_GPIO_SEL7</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_EN1</span><span class="p">,</span>  <span class="n">V_GPIO_EN15</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_OUT1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_OUT1</span><span class="p">,</span> <span class="n">V_GPIO_OUT15</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_HFC_WD_RESET</span>: <span class="cm">/* reset the watchdog counter */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_MSG</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: MISDN_CTRL_HFC_WD_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_BERT_WD_MD</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_bert_wd_md</span> <span class="o">|</span> <span class="n">V_WD_RES</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_L1_TIMER3</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">HW_TIMER3_VALUE</span> <span class="o">|</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: unknown Op %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfcm_dctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mISDNchannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mISDNdevice</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mISDNdevice</span><span class="p">,</span> <span class="n">D</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dchannel</span>		<span class="o">*</span><span class="n">dch</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dchannel</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hfc_multi</span>	<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_req</span>	<span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_long</span>			<span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: cmd:%x %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OPEN_CHANNEL</span>:
		<span class="n">rq</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISDN_P_TE_S0</span>:
		<span class="k">case</span> <span class="n">ISDN_P_NT_S0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">open_dchannel</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">dch</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span> <span class="cm">/* locked there */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_P_TE_E1</span>:
		<span class="k">case</span> <span class="n">ISDN_P_NT_E1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">!=</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">open_dchannel</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">dch</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span> <span class="cm">/* locked there */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">open_bchannel</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">dch</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLOSE_CHANNEL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_OPEN</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: dev(%d) close from %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
			       <span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CONTROL_CHANNEL</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">channel_dctrl</span><span class="p">(</span><span class="n">dch</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: unknown command %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">clockctl</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">iclock_on</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * initialize the card</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * start timer irq, wait some time and check if we have interrupts.</span>
<span class="cm"> * if not, reset chip and try again.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">init_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">u_long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span>	<span class="n">__iomem</span> <span class="o">*</span><span class="n">plx_acc</span><span class="p">;</span>
	<span class="n">u_long</span>	<span class="n">plx_flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: entered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* set interrupts but leave global interrupt disabled */</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">r_irq_ctrl</span> <span class="o">=</span> <span class="n">V_FIFO_IRQ</span><span class="p">;</span>
	<span class="n">disable_hwirq</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hfcmulti_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="s">&quot;HFC-multi&quot;</span><span class="p">,</span> <span class="n">hc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;mISDN: Could not get interrupt %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_lock</span><span class="p">,</span> <span class="n">plx_flags</span><span class="p">);</span>
		<span class="n">plx_acc</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_membase</span> <span class="o">+</span> <span class="n">PLX_INTCSR</span><span class="p">;</span>
		<span class="n">writew</span><span class="p">((</span><span class="n">PLX_INTCSR_PCIINT_ENABLE</span> <span class="o">|</span> <span class="n">PLX_INTCSR_LINTI1_ENABLE</span><span class="p">),</span>
		       <span class="n">plx_acc</span><span class="p">);</span> <span class="cm">/* enable PCI &amp; LINT1 irq */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_lock</span><span class="p">,</span> <span class="n">plx_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: IRQ %d count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">irqcnt</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">init_chip</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Finally enable IRQ output</span>
<span class="cm">	 * this is only allowed, if an IRQ routine is already</span>
<span class="cm">	 * established for this HFC, so don&#39;t do that earlier</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">enable_hwirq</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* printk(KERN_DEBUG &quot;no master irq set!!!\n&quot;); */</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
	<span class="n">schedule_timeout</span><span class="p">((</span><span class="mi">100</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span> <span class="cm">/* Timeout 100ms */</span>
	<span class="cm">/* turn IRQ off until chip is completely initialized */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">disable_hwirq</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: IRQ %d count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">irqcnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">irqcnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PCM_SLAVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ignoring missing interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;HFC PCI: IRQ(%d) getting no interrupts during init.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_lock</span><span class="p">,</span> <span class="n">plx_flags</span><span class="p">);</span>
		<span class="n">plx_acc</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_membase</span> <span class="o">+</span> <span class="n">PLX_INTCSR</span><span class="p">;</span>
		<span class="n">writew</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">plx_acc</span><span class="p">);</span> <span class="cm">/*disable IRQs*/</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_lock</span><span class="p">,</span> <span class="n">plx_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: free irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hc</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: done (err=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * find pci device and set it up</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">setup_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
	  <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hm_map</span>	<span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hm_map</span> <span class="o">*</span><span class="p">)</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;HFC-multi: card manufacturer: &#39;%s&#39; card name: &#39;%s&#39; clock: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">m</span><span class="o">-&gt;</span><span class="n">vendor_name</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">clock2</span> <span class="o">?</span> <span class="s">&quot;double&quot;</span> <span class="o">:</span> <span class="s">&quot;normal&quot;</span><span class="p">);</span>

	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">clock2</span><span class="p">)</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CHIP_CLOCK2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0xB410</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CHIP_B410P</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PCM_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PCM_SLAVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">slots</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFC-multi: No IRQ for PCI card found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFC-multi: Error enabling PCI card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">leds</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">ledstate</span> <span class="o">=</span> <span class="mh">0xAFFEAFFE</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">opticalsupport</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">opticalsupport</span><span class="p">;</span>

	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_membase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_membase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* set memory access methods */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">io_mode</span><span class="p">)</span> <span class="cm">/* use mode from card config */</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">io_mode</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">io_mode</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">io_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HFC_IO_MODE_PLXSD</span>:
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">slots</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span> <span class="cm">/* required */</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_outb</span> <span class="o">=</span> <span class="n">HFC_outb_pcimem</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_inb</span> <span class="o">=</span> <span class="n">HFC_inb_pcimem</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_inw</span> <span class="o">=</span> <span class="n">HFC_inw_pcimem</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_wait</span> <span class="o">=</span> <span class="n">HFC_wait_pcimem</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">read_fifo</span> <span class="o">=</span> <span class="n">read_fifo_pcimem</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">write_fifo</span> <span class="o">=</span> <span class="n">write_fifo_pcimem</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_origmembase</span> <span class="o">=</span>  <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
		<span class="cm">/* MEMBASE 1 is PLX PCI Bridge */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_origmembase</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;HFC-multi: No IO-Memory for PCI PLX bridge found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_membase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_origmembase</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_membase</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;HFC-multi: failed to remap plx address space. &quot;</span>
			       <span class="s">&quot;(internal error)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;HFC-multi: plx_membase:%#lx plx_origmembase:%#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_membase</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">plx_origmembase</span><span class="p">);</span>

		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_origmembase</span> <span class="o">=</span>  <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
		<span class="cm">/* MEMBASE 1 is PLX PCI Bridge */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_origmembase</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;HFC-multi: No IO-Memory for PCI card found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_membase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_origmembase</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_membase</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFC-multi: failed to remap io &quot;</span>
			       <span class="s">&quot;address space. (internal error)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;card %d: defined at MEMBASE %#lx (%#lx) IRQ %d HZ %d &quot;</span>
		       <span class="s">&quot;leds-type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_membase</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_origmembase</span><span class="p">,</span>
		       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">HZ</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">);</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">PCI_ENA_MEMIO</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HFC_IO_MODE_PCIMEM</span>:
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_outb</span> <span class="o">=</span> <span class="n">HFC_outb_pcimem</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_inb</span> <span class="o">=</span> <span class="n">HFC_inb_pcimem</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_inw</span> <span class="o">=</span> <span class="n">HFC_inw_pcimem</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_wait</span> <span class="o">=</span> <span class="n">HFC_wait_pcimem</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">read_fifo</span> <span class="o">=</span> <span class="n">read_fifo_pcimem</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">write_fifo</span> <span class="o">=</span> <span class="n">write_fifo_pcimem</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_origmembase</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_origmembase</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;HFC-multi: No IO-Memory for PCI card found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_membase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_origmembase</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_membase</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;HFC-multi: failed to remap io address space. &quot;</span>
			       <span class="s">&quot;(internal error)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;card %d: defined at MEMBASE %#lx (%#lx) IRQ &quot;</span>
		       <span class="s">&quot;%d HZ %d leds-type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_membase</span><span class="p">,</span>
		       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_origmembase</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">HZ</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">);</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">PCI_ENA_MEMIO</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HFC_IO_MODE_REGIO</span>:
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_outb</span> <span class="o">=</span> <span class="n">HFC_outb_regio</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_inb</span> <span class="o">=</span> <span class="n">HFC_inb_regio</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_inw</span> <span class="o">=</span> <span class="n">HFC_inw_regio</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_wait</span> <span class="o">=</span> <span class="n">HFC_wait_regio</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">read_fifo</span> <span class="o">=</span> <span class="n">read_fifo_regio</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">write_fifo</span> <span class="o">=</span> <span class="n">write_fifo_regio</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;HFC-multi: No IO for PCI card found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;hfcmulti&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFC-multi: failed to request &quot;</span>
			       <span class="s">&quot;address space at 0x%08lx (internal error)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">);</span>
			<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;%s %s: defined at IOBASE %#x IRQ %d HZ %d leds-type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">m</span><span class="o">-&gt;</span><span class="n">vendor_name</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">,</span>
		       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">HZ</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">);</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">PCI_ENA_REGIO</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFC-multi: Invalid IO mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">hc</span><span class="p">);</span>

	<span class="cm">/* At this point the needed PCI config is done */</span>
	<span class="cm">/* fifos are still not enabled */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * remove port</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">release_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">pt</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">pb</span><span class="p">;</span>

	<span class="n">ci</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">;</span>
	<span class="n">pt</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ci</span><span class="p">].</span><span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: entered for port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">pt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pt</span> <span class="o">&gt;=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: ERROR port out of range (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">pt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: releasing port=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">pt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span>
		<span class="n">l1_event</span><span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">l1</span><span class="p">,</span> <span class="n">CLOSE_CHANNEL</span><span class="p">);</span>

	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ci</span><span class="p">].</span><span class="n">dch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">[</span><span class="n">pt</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mISDN_unregister_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">dch</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* E1 */</span>
		<span class="cm">/* remove sync */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">syncronized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">plxsd_checksync</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* free channels */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">bmask</span><span class="p">[</span><span class="n">pt</span><span class="p">]))</span> <span class="cm">/* skip unused chan */</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bch</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s: free port %d channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">pb</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bch</span><span class="p">;</span>
				<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">mISDN_freebchannel</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coeff</span><span class="p">);</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* remove sync */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PLXSD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">syncronized</span> <span class="o">&amp;=</span>
				<span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ci</span><span class="p">].</span><span class="n">port</span><span class="p">);</span>
			<span class="n">plxsd_checksync</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* free channels */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ci</span> <span class="o">-</span> <span class="mi">2</span><span class="p">].</span><span class="n">bch</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: free port %d channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ci</span> <span class="o">-</span> <span class="mi">2</span><span class="p">].</span><span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				       <span class="n">ci</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">pb</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ci</span> <span class="o">-</span> <span class="mi">2</span><span class="p">].</span><span class="n">bch</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ci</span> <span class="o">-</span> <span class="mi">2</span><span class="p">].</span><span class="n">bch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">mISDN_freebchannel</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ci</span> <span class="o">-</span> <span class="mi">2</span><span class="p">].</span><span class="n">coeff</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ci</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">bch</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: free port %d channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ci</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				       <span class="n">ci</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">pb</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ci</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">bch</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ci</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">bch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">mISDN_freebchannel</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ci</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">coeff</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: free port %d channel D(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">pt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ci</span><span class="p">);</span>
	<span class="n">mISDN_freedchannel</span><span class="p">(</span><span class="n">dch</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: done!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">release_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: release card (%d) entered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="cm">/* unregister clock source */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">iclock</span><span class="p">)</span>
		<span class="n">mISDN_unregister_clock</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">iclock</span><span class="p">);</span>

	<span class="cm">/* disable and free irq */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">disable_hwirq</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: free irq %d (hc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hc</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hc</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="cm">/* disable D-channels &amp; B-channels */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: disable all channels (d and b)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dch</span><span class="p">)</span>
			<span class="n">release_port</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dch</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* dimm leds */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">leds</span><span class="p">)</span>
		<span class="n">hfcmulti_leds</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>

	<span class="cm">/* release hardware */</span>
	<span class="n">release_io_hfcmulti</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: remove instance from list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: delete instance</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span> <span class="o">==</span> <span class="n">syncmaster</span><span class="p">)</span>
		<span class="n">syncmaster</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: card successfully removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">init_e1_port_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hm_map</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* set optical line type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">Port_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x001</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">opticalsupport</span><span class="p">)</span>  <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			       <span class="s">&quot;This board has no optical &quot;</span>
			       <span class="s">&quot;support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s: PORT set optical &quot;</span>
				       <span class="s">&quot;interfacs: card(%d) &quot;</span>
				       <span class="s">&quot;port(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span>
				       <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CFG_OPTICAL</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">cfg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* set LOS report */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">Port_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x004</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: PORT set &quot;</span>
			       <span class="s">&quot;LOS report: card(%d) port(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CFG_REPORT_LOS</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">cfg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* set AIS report */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">Port_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x008</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: PORT set &quot;</span>
			       <span class="s">&quot;AIS report: card(%d) port(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CFG_REPORT_AIS</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">cfg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* set SLIP report */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">Port_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x010</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;%s: PORT set SLIP report: &quot;</span>
			       <span class="s">&quot;card(%d) port(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CFG_REPORT_SLIP</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">cfg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* set RDI report */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">Port_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x020</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;%s: PORT set RDI report: &quot;</span>
			       <span class="s">&quot;card(%d) port(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CFG_REPORT_RDI</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">cfg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* set CRC-4 Mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">Port_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: PORT turn on CRC4 report:&quot;</span>
			       <span class="s">&quot; card(%d) port(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CFG_CRC4</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">cfg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: PORT turn off CRC4&quot;</span>
			       <span class="s">&quot; report: card(%d) port(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* set forced clock */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">Port_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0200</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: PORT force getting clock from &quot;</span>
			       <span class="s">&quot;E1: card(%d) port(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CHIP_E1CLOCK_GET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">Port_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0400</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: PORT force putting clock to &quot;</span>
				       <span class="s">&quot;E1: card(%d) port(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CHIP_E1CLOCK_PUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="cm">/* set JATT PLL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">Port_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0800</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: PORT disable JATT PLL on &quot;</span>
			       <span class="s">&quot;E1: card(%d) port(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CHIP_RX_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* set elastic jitter buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">Port_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">jitter</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">Port_cnt</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;%s: PORT set elastic &quot;</span>
			       <span class="s">&quot;buffer to %d: card(%d) port(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">jitter</span><span class="p">,</span>
			       <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]].</span><span class="n">jitter</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* default */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">init_e1_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hm_map</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dchannel</span>	<span class="o">*</span><span class="n">dch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bchannel</span>	<span class="o">*</span><span class="n">bch</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">ch</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="n">name</span><span class="p">[</span><span class="n">MISDN_MAX_IDLEN</span><span class="p">];</span>
	<span class="kt">int</span>		<span class="n">bcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dch</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dchannel</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dch</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>
	<span class="n">mISDN_initdchannel</span><span class="p">(</span><span class="n">dch</span><span class="p">,</span> <span class="n">MAX_DFRAME_LEN_L1</span><span class="p">,</span> <span class="n">ph_state_change</span><span class="p">);</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hc</span><span class="p">;</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">Dprotocols</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ISDN_P_TE_E1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ISDN_P_NT_E1</span><span class="p">);</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">Bprotocols</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ISDN_P_B_RAW</span> <span class="o">&amp;</span> <span class="n">ISDN_P_B_MASK</span><span class="p">))</span> <span class="o">|</span>
	    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ISDN_P_B_HDLC</span> <span class="o">&amp;</span> <span class="n">ISDN_P_B_MASK</span><span class="p">));</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">send</span> <span class="o">=</span> <span class="n">handle_dmsg</span><span class="p">;</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">hfcm_dctrl</span><span class="p">;</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="n">pt</span><span class="p">];</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="n">pt</span><span class="p">]].</span><span class="n">dch</span> <span class="o">=</span> <span class="n">dch</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="n">pt</span><span class="p">]].</span><span class="n">port</span> <span class="o">=</span> <span class="n">pt</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="n">pt</span><span class="p">]].</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ch</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">bmask</span><span class="p">[</span><span class="n">pt</span><span class="p">]))</span> <span class="cm">/* skip unused channel */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">bch</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bchannel</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bch</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: no memory for bchannel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_chan</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">coeff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: no memory for coeffs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">free_chan</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>
		<span class="n">mISDN_initbchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">MAX_DATA_MEM</span><span class="p">,</span> <span class="n">poll</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hc</span><span class="p">;</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">send</span> <span class="o">=</span> <span class="n">handle_bmsg</span><span class="p">;</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">hfcm_bctrl</span><span class="p">;</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">nr</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bchannels</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span> <span class="o">=</span> <span class="n">bch</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">port</span> <span class="o">=</span> <span class="n">pt</span><span class="p">;</span>
		<span class="n">set_channelmap</span><span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">channelmap</span><span class="p">);</span>
		<span class="n">bcount</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">nrbchan</span> <span class="o">=</span> <span class="n">bcount</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">init_e1_port_hw</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">MISDN_MAX_IDLEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;hfc-e1.%d-%d&quot;</span><span class="p">,</span>
				<span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pt</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">MISDN_MAX_IDLEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;hfc-e1.%d&quot;</span><span class="p">,</span> <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mISDN_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_chan</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="nl">free_chan:</span>
	<span class="n">release_port</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">dch</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">init_multi_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dchannel</span>	<span class="o">*</span><span class="n">dch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bchannel</span>	<span class="o">*</span><span class="n">bch</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">ch</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="n">name</span><span class="p">[</span><span class="n">MISDN_MAX_IDLEN</span><span class="p">];</span>

	<span class="n">dch</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dchannel</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dch</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>
	<span class="n">mISDN_initdchannel</span><span class="p">(</span><span class="n">dch</span><span class="p">,</span> <span class="n">MAX_DFRAME_LEN_L1</span><span class="p">,</span> <span class="n">ph_state_change</span><span class="p">);</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hc</span><span class="p">;</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">Dprotocols</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ISDN_P_NT_S0</span><span class="p">);</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">Bprotocols</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ISDN_P_B_RAW</span> <span class="o">&amp;</span> <span class="n">ISDN_P_B_MASK</span><span class="p">))</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ISDN_P_B_HDLC</span> <span class="o">&amp;</span> <span class="n">ISDN_P_B_MASK</span><span class="p">));</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">send</span> <span class="o">=</span> <span class="n">handle_dmsg</span><span class="p">;</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">hfcm_dctrl</span><span class="p">;</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">nrbchan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">pt</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">].</span><span class="n">dch</span> <span class="o">=</span> <span class="n">dch</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">].</span><span class="n">port</span> <span class="o">=</span> <span class="n">pt</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">].</span><span class="n">nt_timer</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">nrbchan</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bch</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bchannel</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bch</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: no memory for bchannel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_chan</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">ch</span><span class="p">].</span><span class="n">coeff</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">ch</span><span class="p">].</span><span class="n">coeff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: no memory for coeffs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">bch</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">free_chan</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>
		<span class="n">mISDN_initbchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">MAX_DATA_MEM</span><span class="p">,</span> <span class="n">poll</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hc</span><span class="p">;</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">send</span> <span class="o">=</span> <span class="n">handle_bmsg</span><span class="p">;</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">hfcm_bctrl</span><span class="p">;</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">nr</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bchannels</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">ch</span><span class="p">].</span><span class="n">bch</span> <span class="o">=</span> <span class="n">bch</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">ch</span><span class="p">].</span><span class="n">port</span> <span class="o">=</span> <span class="n">pt</span><span class="p">;</span>
		<span class="n">set_channelmap</span><span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">channelmap</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* set master clock */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">Port_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x001</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;%s: PROTOCOL set master clock: &quot;</span>
			       <span class="s">&quot;card(%d) port(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error: Master clock &quot;</span>
			       <span class="s">&quot;for port(%d) of card(%d) is only&quot;</span>
			       <span class="s">&quot; possible with TE-mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_chan</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">masterclk</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error: Master clock &quot;</span>
			       <span class="s">&quot;for port(%d) of card(%d) already &quot;</span>
			       <span class="s">&quot;defined for port(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">masterclk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_chan</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">masterclk</span> <span class="o">=</span> <span class="n">pt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* set transmitter line to non capacitive */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">Port_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x002</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;%s: PROTOCOL set non capacitive &quot;</span>
			       <span class="s">&quot;transmitter: card(%d) port(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CFG_NONCAP_TX</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">].</span><span class="n">cfg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* disable E-channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">Port_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x004</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;%s: PROTOCOL disable E-channel: &quot;</span>
			       <span class="s">&quot;card(%d) port(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CFG_DIS_ECHANNEL</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">].</span><span class="n">cfg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_XHFC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">MISDN_MAX_IDLEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;xhfc.%d-%d&quot;</span><span class="p">,</span>
			 <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mISDN_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">MISDN_MAX_IDLEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;hfc-%ds.%d-%d&quot;</span><span class="p">,</span>
			 <span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span><span class="p">,</span> <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mISDN_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_chan</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">created</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="nl">free_chan:</span>
	<span class="n">release_port</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">dch</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfcmulti_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hm_map</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
	      <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">ret_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">pt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hfc_multi</span>	<span class="o">*</span><span class="n">hc</span><span class="p">;</span>
	<span class="n">u_long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="n">u_char</span>		<span class="n">dips</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pmj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* dip settings, port mode Jumpers */</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">,</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">u_int</span>		<span class="n">maskcheck</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HFC_cnt</span> <span class="o">&gt;=</span> <span class="n">MAX_CARDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;too many cards (max=%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">MAX_CARDS</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">type</span><span class="p">[</span><span class="n">HFC_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="n">HFC_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">!=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFC-MULTI: Card &#39;%s:%s&#39; type %d found but &quot;</span>
		       <span class="s">&quot;type[%d] %d was supplied as module parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">m</span><span class="o">-&gt;</span><span class="n">vendor_name</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">HFC_cnt</span><span class="p">,</span>
		       <span class="n">type</span><span class="p">[</span><span class="n">HFC_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HFC-MULTI: Load module without parameters &quot;</span>
		       <span class="s">&quot;first, to see cards and their types.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Registering %s:%s chip type %d (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">vendor_name</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
		       <span class="n">type</span><span class="p">[</span><span class="n">HFC_cnt</span><span class="p">]);</span>

	<span class="cm">/* allocate card+fifo structure */</span>
	<span class="n">hc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hfc_multi</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;No kmem for HFC-Multi card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">mtyp</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">=</span>  <span class="n">m</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">HFC_cnt</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">[</span><span class="n">HFC_cnt</span><span class="p">];</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">io_mode</span> <span class="o">=</span> <span class="n">iomode</span><span class="p">[</span><span class="n">HFC_cnt</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span> <span class="o">&amp;&amp;</span> <span class="n">dmask</span><span class="p">[</span><span class="n">E1_cnt</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* fragment card */</span>
		<span class="n">pt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">maskcheck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ch</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">dmask</span><span class="p">[</span><span class="n">E1_cnt</span><span class="p">]))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">bmask</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmask</span><span class="p">[</span><span class="n">bmask_cnt</span><span class="o">++</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">maskcheck</span> <span class="o">&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">bmask</span><span class="p">[</span><span class="n">pt</span><span class="p">])</span>
			 <span class="o">||</span> <span class="p">(</span><span class="n">dmask</span><span class="p">[</span><span class="n">E1_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">bmask</span><span class="p">[</span><span class="n">pt</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				       <span class="s">&quot;HFC-E1 #%d has overlapping B-channels on fragment #%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">E1_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pt</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">maskcheck</span> <span class="o">|=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">bmask</span><span class="p">[</span><span class="n">pt</span><span class="p">];</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			       <span class="s">&quot;HFC-E1 #%d uses D-channel on slot %d and a B-channel map of 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">E1_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">bmask</span><span class="p">[</span><span class="n">pt</span><span class="p">]);</span>
			<span class="n">pt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">=</span> <span class="n">pt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dmask</span><span class="p">[</span><span class="n">E1_cnt</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* default card layout */</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">bmask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfffefffe</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set chip specific features */</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">masterclk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="n">HFC_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CHIP_ULAW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">silence</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* ulaw silence */</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">silence</span> <span class="o">=</span> <span class="mh">0x2a</span><span class="p">;</span> <span class="cm">/* alaw silence */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">poll</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">silence_data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;HFCMULTI error: silence_data too small, &quot;</span>
		       <span class="s">&quot;please fix</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">poll</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">silence_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">silence</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">!=</span> <span class="n">HFC_TYPE_XHFC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="n">HFC_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">))</span>
			<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CHIP_DTMF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CHIP_CONF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="n">HFC_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x800</span><span class="p">)</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PCM_SLAVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="n">HFC_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PCM_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HFC_CHIP_PCM_SLAVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="n">HFC_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CHIP_EXRAM_128</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="n">HFC_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CHIP_EXRAM_512</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">slots</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="n">HFC_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10000</span><span class="p">)</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">slots</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="n">HFC_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20000</span><span class="p">)</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">slots</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="n">HFC_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HFC_CHIP_WATCHDOG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">wdcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">wdbyte</span> <span class="o">=</span> <span class="n">V_GPIO_OUT2</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Watchdog enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span> <span class="o">&amp;&amp;</span> <span class="n">ent</span><span class="p">)</span>
		<span class="cm">/* setup pci, hc-&gt;slots may change due to PLXSD */</span>
		<span class="n">ret_err</span> <span class="o">=</span> <span class="n">setup_pci</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#ifdef CONFIG_MISDN_HFCMULTI_8xx</span>
		<span class="n">ret_err</span> <span class="o">=</span> <span class="n">setup_embedded</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Embedded IO Mode not selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret_err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span> <span class="o">==</span> <span class="n">syncmaster</span><span class="p">)</span>
			<span class="n">syncmaster</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_outb_nodebug</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_outb</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_inb_nodebug</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_inb</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_inw_nodebug</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_inw</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_wait_nodebug</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_wait</span><span class="p">;</span>
<span class="cp">#ifdef HFC_REGISTER_DEBUG</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_outb</span> <span class="o">=</span> <span class="n">HFC_outb_debug</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_inb</span> <span class="o">=</span> <span class="n">HFC_inb_debug</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_inw</span> <span class="o">=</span> <span class="n">HFC_inw_debug</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">HFC_wait</span> <span class="o">=</span> <span class="n">HFC_wait_debug</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* create channels */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pt</span> <span class="o">&lt;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span> <span class="n">pt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Port_cnt</span> <span class="o">&gt;=</span> <span class="n">MAX_PORTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;too many ports (max=%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">MAX_PORTS</span><span class="p">);</span>
			<span class="n">ret_err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_card</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span>
			<span class="n">ret_err</span> <span class="o">=</span> <span class="n">init_e1_port</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">pt</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret_err</span> <span class="o">=</span> <span class="n">init_multi_port</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">pt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			    <span class="s">&quot;%s: Registering D-channel, card(%d) port(%d) &quot;</span>
			       <span class="s">&quot;result %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span> <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ret_err</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret_err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">pt</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* release already registered ports */</span>
				<span class="n">pt</span><span class="o">--</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span>
					<span class="n">release_port</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span>
						<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">dnum</span><span class="p">[</span><span class="n">pt</span><span class="p">]].</span><span class="n">dch</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">release_port</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span>
						<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[(</span><span class="n">pt</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">].</span><span class="n">dch</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">free_card</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">!=</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span>
			<span class="n">Port_cnt</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* for each S0 port */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ctype</span> <span class="o">==</span> <span class="n">HFC_TYPE_E1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Port_cnt</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* for each E1 port */</span>
		<span class="n">E1_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* disp switches */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">dip_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DIP_4S</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Get DIP setting for beroNet 1S/2S/4S cards</span>
<span class="cm">		 * DIP Setting: (collect GPIO 13/14/15 (R_GPIO_IN1) +</span>
<span class="cm">		 * GPI 19/23 (R_GPI_IN2))</span>
<span class="cm">		 */</span>
		<span class="n">dips</span> <span class="o">=</span> <span class="p">((</span><span class="o">~</span><span class="n">HFC_inb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPIO_IN1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xE0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="o">~</span><span class="n">HFC_inb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPI_IN2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="o">~</span><span class="n">HFC_inb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPI_IN2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">);</span>

		<span class="cm">/* Port mode (TE/NT) jumpers */</span>
		<span class="n">pmj</span> <span class="o">=</span> <span class="p">((</span><span class="n">HFC_inb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPI_IN3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HFC_CHIP_B410P</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span>
			<span class="n">pmj</span> <span class="o">=</span> <span class="o">~</span><span class="n">pmj</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s DIPs(0x%x) jumpers(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">m</span><span class="o">-&gt;</span><span class="n">vendor_name</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span> <span class="n">dips</span><span class="p">,</span> <span class="n">pmj</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DIP_8S</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Get DIP Setting for beroNet 8S0+ cards</span>
<span class="cm">		 * Enable PCI auxbridge function</span>
<span class="cm">		 */</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_BRG_PCM_CFG</span><span class="p">,</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">V_PCM_CLK</span><span class="p">);</span>
		<span class="cm">/* prepare access to auxport */</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x4000</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * some dummy reads are required to</span>
<span class="cm">		 * read valid DIP switch data</span>
<span class="cm">		 */</span>
		<span class="n">dips</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">);</span>
		<span class="n">dips</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">);</span>
		<span class="n">dips</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">);</span>
		<span class="n">dips</span> <span class="o">=</span> <span class="o">~</span><span class="n">inb</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_iobase</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="cm">/* disable PCI auxbridge function */</span>
		<span class="n">HFC_outb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_BRG_PCM_CFG</span><span class="p">,</span> <span class="n">V_PCM_CLK</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s DIPs(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">m</span><span class="o">-&gt;</span><span class="n">vendor_name</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span> <span class="n">dips</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DIP_E1</span>:
		<span class="cm">/*</span>
<span class="cm">		 * get DIP Setting for beroNet E1 cards</span>
<span class="cm">		 * DIP Setting: collect GPI 4/5/6/7 (R_GPI_IN0)</span>
<span class="cm">		 */</span>
		<span class="n">dips</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">HFC_inb</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">R_GPI_IN0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s DIPs(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">m</span><span class="o">-&gt;</span><span class="n">vendor_name</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span> <span class="n">dips</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* add to list */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HFClock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">HFClist</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HFClock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* use as clock source */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">HFC_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">iclock</span> <span class="o">=</span> <span class="n">mISDN_register_clock</span><span class="p">(</span><span class="s">&quot;HFCMulti&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">clockctl</span><span class="p">,</span> <span class="n">hc</span><span class="p">);</span>

	<span class="cm">/* initialize hardware */</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="o">?</span> <span class="o">:</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">ret_err</span> <span class="o">=</span> <span class="n">init_card</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;init card returns %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret_err</span><span class="p">);</span>
		<span class="n">release_card</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* start IRQ and return */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">enable_hwirq</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_card:</span>
	<span class="n">release_io_hfcmulti</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span> <span class="o">==</span> <span class="n">syncmaster</span><span class="p">)</span>
		<span class="n">syncmaster</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">hfc_remove_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfc_multi</span>	<span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">u_long</span>			<span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;removing hfc_multi card vendor:%x &quot;</span>
		       <span class="s">&quot;device:%x subvendor:%x subdevice:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
		       <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HFClock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">release_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HFClock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>  <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: drvdata already removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define	VENDOR_CCD	&quot;Cologne Chip AG&quot;</span>
<span class="cp">#define	VENDOR_BN	&quot;beroNet GmbH&quot;</span>
<span class="cp">#define	VENDOR_DIG	&quot;Digium Inc.&quot;</span>
<span class="cp">#define VENDOR_JH	&quot;Junghanns.NET GmbH&quot;</span>
<span class="cp">#define VENDOR_PRIM	&quot;PrimuX&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hm_map</span> <span class="n">hfcm_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*0*/</span>	<span class="p">{</span><span class="n">VENDOR_BN</span><span class="p">,</span> <span class="s">&quot;HFC-1S Card (mini PCI)&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DIP_4S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*1*/</span>	<span class="p">{</span><span class="n">VENDOR_BN</span><span class="p">,</span> <span class="s">&quot;HFC-2S Card&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DIP_4S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*2*/</span>	<span class="p">{</span><span class="n">VENDOR_BN</span><span class="p">,</span> <span class="s">&quot;HFC-2S Card (mini PCI)&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DIP_4S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*3*/</span>	<span class="p">{</span><span class="n">VENDOR_BN</span><span class="p">,</span> <span class="s">&quot;HFC-4S Card&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DIP_4S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*4*/</span>	<span class="p">{</span><span class="n">VENDOR_BN</span><span class="p">,</span> <span class="s">&quot;HFC-4S Card (mini PCI)&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*5*/</span>	<span class="p">{</span><span class="n">VENDOR_CCD</span><span class="p">,</span> <span class="s">&quot;HFC-4S Eval (old)&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*6*/</span>	<span class="p">{</span><span class="n">VENDOR_CCD</span><span class="p">,</span> <span class="s">&quot;HFC-4S IOB4ST&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DIP_4S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*7*/</span>	<span class="p">{</span><span class="n">VENDOR_CCD</span><span class="p">,</span> <span class="s">&quot;HFC-4S&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*8*/</span>	<span class="p">{</span><span class="n">VENDOR_DIG</span><span class="p">,</span> <span class="s">&quot;HFC-4S Card&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HFC_IO_MODE_REGIO</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*9*/</span>	<span class="p">{</span><span class="n">VENDOR_CCD</span><span class="p">,</span> <span class="s">&quot;HFC-4S Swyx 4xS0 SX2 QuadBri&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*10*/</span>	<span class="p">{</span><span class="n">VENDOR_JH</span><span class="p">,</span> <span class="s">&quot;HFC-4S (junghanns 2.0)&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*11*/</span>	<span class="p">{</span><span class="n">VENDOR_PRIM</span><span class="p">,</span> <span class="s">&quot;HFC-2S Primux Card&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>

	<span class="cm">/*12*/</span>	<span class="p">{</span><span class="n">VENDOR_BN</span><span class="p">,</span> <span class="s">&quot;HFC-8S Card&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*13*/</span>	<span class="p">{</span><span class="n">VENDOR_BN</span><span class="p">,</span> <span class="s">&quot;HFC-8S Card (+)&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DIP_8S</span><span class="p">,</span>
		 <span class="n">HFC_IO_MODE_REGIO</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*14*/</span>	<span class="p">{</span><span class="n">VENDOR_CCD</span><span class="p">,</span> <span class="s">&quot;HFC-8S Eval (old)&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*15*/</span>	<span class="p">{</span><span class="n">VENDOR_CCD</span><span class="p">,</span> <span class="s">&quot;HFC-8S IOB4ST Recording&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>

	<span class="cm">/*16*/</span>	<span class="p">{</span><span class="n">VENDOR_CCD</span><span class="p">,</span> <span class="s">&quot;HFC-8S IOB8ST&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*17*/</span>	<span class="p">{</span><span class="n">VENDOR_CCD</span><span class="p">,</span> <span class="s">&quot;HFC-8S&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*18*/</span>	<span class="p">{</span><span class="n">VENDOR_CCD</span><span class="p">,</span> <span class="s">&quot;HFC-8S&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>

	<span class="cm">/*19*/</span>	<span class="p">{</span><span class="n">VENDOR_BN</span><span class="p">,</span> <span class="s">&quot;HFC-E1 Card&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DIP_E1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*20*/</span>	<span class="p">{</span><span class="n">VENDOR_BN</span><span class="p">,</span> <span class="s">&quot;HFC-E1 Card (mini PCI)&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*21*/</span>	<span class="p">{</span><span class="n">VENDOR_BN</span><span class="p">,</span> <span class="s">&quot;HFC-E1+ Card (Dual)&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DIP_E1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*22*/</span>	<span class="p">{</span><span class="n">VENDOR_BN</span><span class="p">,</span> <span class="s">&quot;HFC-E1 Card (Dual)&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DIP_E1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>

	<span class="cm">/*23*/</span>	<span class="p">{</span><span class="n">VENDOR_CCD</span><span class="p">,</span> <span class="s">&quot;HFC-E1 Eval (old)&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*24*/</span>	<span class="p">{</span><span class="n">VENDOR_CCD</span><span class="p">,</span> <span class="s">&quot;HFC-E1 IOB1E1&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*25*/</span>	<span class="p">{</span><span class="n">VENDOR_CCD</span><span class="p">,</span> <span class="s">&quot;HFC-E1&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>

	<span class="cm">/*26*/</span>	<span class="p">{</span><span class="n">VENDOR_CCD</span><span class="p">,</span> <span class="s">&quot;HFC-4S Speech Design&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		 <span class="n">HFC_IO_MODE_PLXSD</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*27*/</span>	<span class="p">{</span><span class="n">VENDOR_CCD</span><span class="p">,</span> <span class="s">&quot;HFC-E1 Speech Design&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		 <span class="n">HFC_IO_MODE_PLXSD</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*28*/</span>	<span class="p">{</span><span class="n">VENDOR_CCD</span><span class="p">,</span> <span class="s">&quot;HFC-4S OpenVox&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*29*/</span>	<span class="p">{</span><span class="n">VENDOR_CCD</span><span class="p">,</span> <span class="s">&quot;HFC-2S OpenVox&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*30*/</span>	<span class="p">{</span><span class="n">VENDOR_CCD</span><span class="p">,</span> <span class="s">&quot;HFC-8S OpenVox&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*31*/</span>	<span class="p">{</span><span class="n">VENDOR_CCD</span><span class="p">,</span> <span class="s">&quot;XHFC-4S Speech Design&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		 <span class="n">HFC_IO_MODE_EMBSD</span><span class="p">,</span> <span class="n">XHFC_IRQ</span><span class="p">},</span>
	<span class="cm">/*32*/</span>	<span class="p">{</span><span class="n">VENDOR_JH</span><span class="p">,</span> <span class="s">&quot;HFC-8S (junghanns)&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*33*/</span>	<span class="p">{</span><span class="n">VENDOR_BN</span><span class="p">,</span> <span class="s">&quot;HFC-2S Beronet Card PCIe&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DIP_4S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*34*/</span>	<span class="p">{</span><span class="n">VENDOR_BN</span><span class="p">,</span> <span class="s">&quot;HFC-4S Beronet Card PCIe&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DIP_4S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>

<span class="cp">#undef H</span>
<span class="cp">#define H(x)	((unsigned long)&amp;hfcm_map[x])</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">hfmultipci_ids</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>

	<span class="cm">/* Cards with HFC-4S Chip */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC4S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_BN1SM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">0</span><span class="p">)},</span> <span class="cm">/* BN1S mini PCI */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC4S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_BN2S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">1</span><span class="p">)},</span> <span class="cm">/* BN2S */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC4S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_BN2SM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">2</span><span class="p">)},</span> <span class="cm">/* BN2S mini PCI */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC4S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_BN4S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">3</span><span class="p">)},</span> <span class="cm">/* BN4S */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC4S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_BN4SM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">4</span><span class="p">)},</span> <span class="cm">/* BN4S mini PCI */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC4S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_DEVICE_ID_CCD_HFC4S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">5</span><span class="p">)},</span> <span class="cm">/* Old Eval */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC4S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_IOB4ST</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">6</span><span class="p">)},</span> <span class="cm">/* IOB4ST */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC4S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_HFC4S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">7</span><span class="p">)},</span> <span class="cm">/* 4S */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_DIGIUM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_DIGIUM_HFC4S</span><span class="p">,</span>
	  <span class="n">PCI_VENDOR_ID_DIGIUM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_DIGIUM_HFC4S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">8</span><span class="p">)},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC4S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_SWYX4S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">9</span><span class="p">)},</span> <span class="cm">/* 4S Swyx */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC4S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_JH4S20</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">10</span><span class="p">)},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC4S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_PMX2S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">11</span><span class="p">)},</span> <span class="cm">/* Primux */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC4S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_OV4S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">28</span><span class="p">)},</span> <span class="cm">/* OpenVox 4 */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC4S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_OV2S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">29</span><span class="p">)},</span> <span class="cm">/* OpenVox 2 */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC4S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="mh">0xb761</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">33</span><span class="p">)},</span> <span class="cm">/* BN2S PCIe */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC4S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="mh">0xb762</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">34</span><span class="p">)},</span> <span class="cm">/* BN4S PCIe */</span>

	<span class="cm">/* Cards with HFC-8S Chip */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC8S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_BN8S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">12</span><span class="p">)},</span> <span class="cm">/* BN8S */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC8S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_BN8SP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">13</span><span class="p">)},</span> <span class="cm">/* BN8S+ */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC8S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_DEVICE_ID_CCD_HFC8S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">14</span><span class="p">)},</span> <span class="cm">/* old Eval */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC8S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_IOB8STR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">15</span><span class="p">)},</span> <span class="cm">/* IOB8ST Recording */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC8S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_IOB8ST</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">16</span><span class="p">)},</span> <span class="cm">/* IOB8ST  */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC8S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_IOB8ST_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">17</span><span class="p">)},</span> <span class="cm">/* IOB8ST  */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC8S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_HFC8S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">18</span><span class="p">)},</span> <span class="cm">/* 8S */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC8S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_OV8S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">30</span><span class="p">)},</span> <span class="cm">/* OpenVox 8 */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC8S</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_JH8S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">32</span><span class="p">)},</span> <span class="cm">/* Junganns 8S  */</span>


	<span class="cm">/* Cards with HFC-E1 Chip */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFCE1</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_BNE1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">19</span><span class="p">)},</span> <span class="cm">/* BNE1 */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFCE1</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_BNE1M</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">20</span><span class="p">)},</span> <span class="cm">/* BNE1 mini PCI */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFCE1</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_BNE1DP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">21</span><span class="p">)},</span> <span class="cm">/* BNE1 + (Dual) */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFCE1</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_BNE1D</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">22</span><span class="p">)},</span> <span class="cm">/* BNE1 (Dual) */</span>

	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFCE1</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_DEVICE_ID_CCD_HFCE1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">23</span><span class="p">)},</span> <span class="cm">/* Old Eval */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFCE1</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_IOB1E1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">24</span><span class="p">)},</span> <span class="cm">/* IOB1E1 */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFCE1</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_HFCE1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">25</span><span class="p">)},</span> <span class="cm">/* E1 */</span>

	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_PLX</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_PLX_9030</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_SPD4S</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">26</span><span class="p">)},</span> <span class="cm">/* PLX PCI Bridge */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_PLX</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_PLX_9030</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_SPDE1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">27</span><span class="p">)},</span> <span class="cm">/* PLX PCI Bridge */</span>

	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFCE1</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_CCD</span><span class="p">,</span>
	  <span class="n">PCI_SUBDEVICE_ID_CCD_JHSE1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">(</span><span class="mi">25</span><span class="p">)},</span> <span class="cm">/* Junghanns E1 */</span>

	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC4S</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFC8S</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">CCD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CCD_HFCE1</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>
<span class="cp">#undef H</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">hfmultipci_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hfcmulti_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hm_map</span>	<span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hm_map</span> <span class="o">*</span><span class="p">)</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_CCD</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
		    <span class="n">ent</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_CCD_HFC4S</span> <span class="o">||</span>
		    <span class="n">ent</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_CCD_HFC8S</span> <span class="o">||</span>
		    <span class="n">ent</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_CCD_HFCE1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;Unknown HFC multiport controller (vendor:%04x device:%04x &quot;</span>
		       <span class="s">&quot;subvendor:%04x subdevice:%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span>
		       <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span>
		       <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;Please contact the driver maintainer for support.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">hfcmulti_init</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="n">ent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">HFC_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%d devices registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HFC_cnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">hfcmultipci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;hfc_multi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">hfcmulti_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">hfc_remove_pci</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">hfmultipci_ids</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">HFCmulti_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfc_multi</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="cm">/* get rid of all devices of this driver */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">HFClist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">release_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hfcmultipci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">HFCmulti_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">xhfc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hm_map</span> <span class="n">m</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mISDN: HFC-multi driver %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HFC_MULTI_VERSION</span><span class="p">);</span>

<span class="cp">#ifdef IRQ_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: IRQ_DEBUG IS ENABLED!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HFClock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plx_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HFCMULTI_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: init entered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">poll</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">poll_timer</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">poll</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">poll_timer</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">poll_timer</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">poll_timer</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">64</span>:
		<span class="n">poll_timer</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">128</span>:
		<span class="n">poll_timer</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">256</span>:
		<span class="n">poll_timer</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;%s: Wrong poll value (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">poll</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clock</span><span class="p">)</span>
		<span class="n">clock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Register the embedded devices.</span>
<span class="cm">	 * This should be done before the PCI cards registration */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hwid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HWID_MINIP4</span>:
		<span class="n">xhfc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">hfcm_map</span><span class="p">[</span><span class="mi">31</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HWID_MINIP8</span>:
		<span class="n">xhfc</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">hfcm_map</span><span class="p">[</span><span class="mi">31</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HWID_MINIP16</span>:
		<span class="n">xhfc</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">hfcm_map</span><span class="p">[</span><span class="mi">31</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">xhfc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">xhfc</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hfcmulti_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error registering embedded driver: &quot;</span>
			       <span class="s">&quot;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">HFC_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%d devices registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HFC_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Register the PCI cards */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hfcmultipci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error registering pci driver: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">module_init</span><span class="p">(</span><span class="n">HFCmulti_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">HFCmulti_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
