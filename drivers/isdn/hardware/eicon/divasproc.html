<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hardware › eicon › divasproc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>divasproc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: divasproc.c,v 1.19.4.3 2005/01/31 12:22:20 armin Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * Low level driver for Eicon DIVA Server ISDN cards.</span>
<span class="cm"> * /proc functions</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2000-2003 by Armin Schindler (mac@melware.de)</span>
<span class="cm"> * Copyright 2000-2003 Cytronics &amp; Melware (info@melware.de)</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;platform.h&quot;</span>
<span class="cp">#include &quot;debuglib.h&quot;</span>
<span class="cp">#undef ID_MASK</span>
<span class="cp">#undef N_DATA</span>
<span class="cp">#include &quot;pc.h&quot;</span>
<span class="cp">#include &quot;di_defs.h&quot;</span>
<span class="cp">#include &quot;divasync.h&quot;</span>
<span class="cp">#include &quot;di.h&quot;</span>
<span class="cp">#include &quot;io.h&quot;</span>
<span class="cp">#include &quot;xdi_msg.h&quot;</span>
<span class="cp">#include &quot;xdi_adapter.h&quot;</span>
<span class="cp">#include &quot;diva.h&quot;</span>
<span class="cp">#include &quot;diva_pci.h&quot;</span>


<span class="k">extern</span> <span class="n">PISDN_ADAPTER</span> <span class="n">IoAdapters</span><span class="p">[</span><span class="n">MAX_ADAPTER</span><span class="p">];</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">divas_get_version</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">diva_get_vserial_number</span><span class="p">(</span><span class="n">PISDN_ADAPTER</span> <span class="n">IoAdapter</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>

<span class="cm">/*********************************************************</span>
<span class="cm"> ** Functions for /proc interface / File operations</span>
<span class="cm"> *********************************************************/</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">divas_proc_name</span> <span class="o">=</span> <span class="s">&quot;divas&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">adapter_dir_name</span> <span class="o">=</span> <span class="s">&quot;adapter&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">info_proc_name</span> <span class="o">=</span> <span class="s">&quot;info&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">grp_opt_proc_name</span> <span class="o">=</span> <span class="s">&quot;group_optimization&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">d_l1_down_proc_name</span> <span class="o">=</span> <span class="s">&quot;dynamic_l1_down&quot;</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** &quot;divas&quot; entry</span>
<span class="cm">*/</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">proc_net_eicon</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">divas_proc_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">divas_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cadapter</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmpbuf</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">tmpser</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">divas_get_version</span><span class="p">(</span><span class="n">tmpbuf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmpbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">tmpbuf</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">tmpbuf</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cadapter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cadapter</span> <span class="o">&lt;</span> <span class="n">MAX_ADAPTER</span><span class="p">;</span> <span class="n">cadapter</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IoAdapters</span><span class="p">[</span><span class="n">cadapter</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">diva_get_vserial_number</span><span class="p">(</span><span class="n">IoAdapters</span><span class="p">[</span><span class="n">cadapter</span><span class="p">],</span>
						<span class="n">tmpser</span><span class="p">);</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">tmpbuf</span><span class="p">,</span>
				<span class="s">&quot;%2d: %-30s Serial:%-10s IRQ:%2d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cadapter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">IoAdapters</span><span class="p">[</span><span class="n">cadapter</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Properties</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
				<span class="n">tmpser</span><span class="p">,</span>
				<span class="n">IoAdapters</span><span class="p">[</span><span class="n">cadapter</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">irq_nr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">tmpbuf</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span>
			    <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmpbuf</span><span class="p">,</span>
			     <span class="n">strlen</span><span class="p">(</span><span class="n">tmpbuf</span><span class="p">)))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">tmpbuf</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">off</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">divas_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">divas_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">POLLERR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">divas_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">divas_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">divas_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>   <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>  <span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>    <span class="o">=</span> <span class="n">divas_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>   <span class="o">=</span> <span class="n">divas_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>    <span class="o">=</span> <span class="n">divas_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">divas_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">divas_close</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">create_divas_proc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">divas_proc_entry</span> <span class="o">=</span> <span class="n">proc_create</span><span class="p">(</span><span class="n">divas_proc_name</span><span class="p">,</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				       <span class="n">proc_net_eicon</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">divas_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">divas_proc_entry</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">remove_divas_proc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">divas_proc_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">divas_proc_name</span><span class="p">,</span> <span class="n">proc_net_eicon</span><span class="p">);</span>
		<span class="n">divas_proc_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">grp_opt_proc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
				  <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">diva_os_xdi_adapter_t</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">PISDN_ADAPTER</span> <span class="n">IoAdapter</span> <span class="o">=</span> <span class="n">IoAdapters</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">controller</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buffer</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;0&#39;</span>:
			<span class="n">IoAdapter</span><span class="o">-&gt;</span><span class="n">capi_cfg</span><span class="p">.</span><span class="n">cfg_1</span> <span class="o">&amp;=</span>
				<span class="o">~</span><span class="n">DIVA_XDI_CAPI_CFG_1_GROUP_POPTIMIZATION_ON</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;1&#39;</span>:
			<span class="n">IoAdapter</span><span class="o">-&gt;</span><span class="n">capi_cfg</span><span class="p">.</span><span class="n">cfg_1</span> <span class="o">|=</span>
				<span class="n">DIVA_XDI_CAPI_CFG_1_GROUP_POPTIMIZATION_ON</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">d_l1_down_proc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
				    <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">diva_os_xdi_adapter_t</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">PISDN_ADAPTER</span> <span class="n">IoAdapter</span> <span class="o">=</span> <span class="n">IoAdapters</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">controller</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buffer</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;0&#39;</span>:
			<span class="n">IoAdapter</span><span class="o">-&gt;</span><span class="n">capi_cfg</span><span class="p">.</span><span class="n">cfg_1</span> <span class="o">&amp;=</span>
				<span class="o">~</span><span class="n">DIVA_XDI_CAPI_CFG_1_DYNAMIC_L1_ON</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;1&#39;</span>:
			<span class="n">IoAdapter</span><span class="o">-&gt;</span><span class="n">capi_cfg</span><span class="p">.</span><span class="n">cfg_1</span> <span class="o">|=</span>
				<span class="n">DIVA_XDI_CAPI_CFG_1_DYNAMIC_L1_ON</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">d_l1_down_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">diva_os_xdi_adapter_t</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">PISDN_ADAPTER</span> <span class="n">IoAdapter</span> <span class="o">=</span> <span class="n">IoAdapters</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">controller</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">IoAdapter</span><span class="o">-&gt;</span><span class="n">capi_cfg</span><span class="p">.</span>
		    <span class="n">cfg_1</span> <span class="o">&amp;</span> <span class="n">DIVA_XDI_CAPI_CFG_1_DYNAMIC_L1_ON</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;1&quot;</span> <span class="o">:</span>
		   <span class="s">&quot;0&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">d_l1_down_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">d_l1_down_proc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">d_l1_down_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">d_l1_down_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">d_l1_down_proc_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">grp_opt_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">diva_os_xdi_adapter_t</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">PISDN_ADAPTER</span> <span class="n">IoAdapter</span> <span class="o">=</span> <span class="n">IoAdapters</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">controller</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">IoAdapter</span><span class="o">-&gt;</span><span class="n">capi_cfg</span><span class="p">.</span>
		    <span class="n">cfg_1</span> <span class="o">&amp;</span> <span class="n">DIVA_XDI_CAPI_CFG_1_GROUP_POPTIMIZATION_ON</span><span class="p">)</span>
		   <span class="o">?</span> <span class="s">&quot;1&quot;</span> <span class="o">:</span> <span class="s">&quot;0&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">grp_opt_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">grp_opt_proc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">grp_opt_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">grp_opt_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">grp_opt_proc_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">info_proc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			       <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">diva_os_xdi_adapter_t</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">PISDN_ADAPTER</span> <span class="n">IoAdapter</span> <span class="o">=</span> <span class="n">IoAdapters</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">controller</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* this is for test purposes only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&quot;trap&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">IoAdapter</span><span class="o">-&gt;</span><span class="n">os_trap_nfy_Fnc</span><span class="p">))</span> <span class="p">(</span><span class="n">IoAdapter</span><span class="p">,</span> <span class="n">IoAdapter</span><span class="o">-&gt;</span><span class="n">ANum</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">info_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmpser</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">diva_os_xdi_adapter_t</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">PISDN_ADAPTER</span> <span class="n">IoAdapter</span> <span class="o">=</span> <span class="n">IoAdapters</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">controller</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Name        : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">IoAdapter</span><span class="o">-&gt;</span><span class="n">Properties</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DSP state   : %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">dsp_mask</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Channels    : %02d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">IoAdapter</span><span class="o">-&gt;</span><span class="n">Properties</span><span class="p">.</span><span class="n">Channels</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;E. max/used : %03d/%03d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">IoAdapter</span><span class="o">-&gt;</span><span class="n">e_max</span><span class="p">,</span> <span class="n">IoAdapter</span><span class="o">-&gt;</span><span class="n">e_count</span><span class="p">);</span>
	<span class="n">diva_get_vserial_number</span><span class="p">(</span><span class="n">IoAdapter</span><span class="p">,</span> <span class="n">tmpser</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Serial      : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmpser</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;IRQ         : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">IoAdapter</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">irq_nr</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;CardIndex   : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">CardIndex</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;CardOrdinal : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">CardOrdinal</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Controller  : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Bus-Type    : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">==</span>
		    <span class="n">DIVAS_XDI_ADAPTER_BUS_ISA</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ISA&quot;</span> <span class="o">:</span> <span class="s">&quot;PCI&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Port-Name   : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">port_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">==</span> <span class="n">DIVAS_XDI_ADAPTER_BUS_PCI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;PCI-bus     : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">bus</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;PCI-func    : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">func</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">bar</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
					   <span class="s">&quot;Mem / I/O %d : 0x%x / mapped : 0x%lx&quot;</span><span class="p">,</span>
					   <span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">bar</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">.</span>
					   <span class="n">pci</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span><span class="n">length</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
						   <span class="s">&quot; / length : %d&quot;</span><span class="p">,</span>
						   <span class="n">a</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">.</span><span class="n">pci</span><span class="p">.</span>
						   <span class="n">length</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="p">}</span>
				<span class="n">seq_putc</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">xdi_adapter</span><span class="p">.</span><span class="n">port</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">xdi_adapter</span><span class="p">.</span><span class="n">ram</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">xdi_adapter</span><span class="p">.</span><span class="n">reset</span><span class="p">)</span>
	     <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">xdi_adapter</span><span class="p">.</span><span class="n">cfg</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IoAdapter</span><span class="o">-&gt;</span><span class="n">irq_info</span><span class="p">.</span><span class="n">irq_nr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">=</span> <span class="s">&quot;slave&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">=</span> <span class="s">&quot;out of service&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">xdi_adapter</span><span class="p">.</span><span class="n">trapped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="s">&quot;trapped&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">xdi_adapter</span><span class="p">.</span><span class="n">Initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="s">&quot;active&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="s">&quot;ready&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;State       : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">info_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">info_proc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">info_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">info_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">info_proc_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">** adapter proc init/de-init</span>
<span class="cm">*/</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">   Create adapter directory and files in proc file system</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>
<span class="kt">int</span> <span class="nf">create_adapter_proc</span><span class="p">(</span><span class="n">diva_os_xdi_adapter_t</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">de</span><span class="p">,</span> <span class="o">*</span><span class="n">pe</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s">&quot;%s%d&quot;</span><span class="p">,</span> <span class="n">adapter_dir_name</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">de</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">proc_net_eicon</span><span class="p">)))</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">proc_adapter_dir</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">de</span><span class="p">;</span>

	<span class="n">pe</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="n">info_proc_name</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">info_proc_fops</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pe</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">proc_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pe</span><span class="p">;</span>

	<span class="n">pe</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="n">grp_opt_proc_name</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">grp_opt_proc_fops</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pe</span><span class="p">)</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">proc_grp_opt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pe</span><span class="p">;</span>
	<span class="n">pe</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="n">d_l1_down_proc_name</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">d_l1_down_proc_fops</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pe</span><span class="p">)</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">proc_d_l1_down</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pe</span><span class="p">;</span>

	<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;proc entry %s created&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">));</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">   Remove adapter directory and files in proc file system</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>
<span class="kt">void</span> <span class="nf">remove_adapter_proc</span><span class="p">(</span><span class="n">diva_os_xdi_adapter_t</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">proc_adapter_dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">proc_d_l1_down</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">d_l1_down_proc_name</span><span class="p">,</span>
					  <span class="p">(</span><span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">proc_adapter_dir</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">proc_grp_opt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">grp_opt_proc_name</span><span class="p">,</span>
					  <span class="p">(</span><span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">proc_adapter_dir</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">proc_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">info_proc_name</span><span class="p">,</span>
					  <span class="p">(</span><span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">proc_adapter_dir</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s">&quot;%s%d&quot;</span><span class="p">,</span> <span class="n">adapter_dir_name</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">);</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">proc_net_eicon</span><span class="p">);</span>
		<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;proc entry %s%d removed&quot;</span><span class="p">,</span> <span class="n">adapter_dir_name</span><span class="p">,</span>
			 <span class="n">a</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
