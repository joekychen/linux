<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hardware › eicon › um_idi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>um_idi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: um_idi.c,v 1.14 2004/03/21 17:54:37 armin Exp $ */</span>

<span class="cp">#include &quot;platform.h&quot;</span>
<span class="cp">#include &quot;di_defs.h&quot;</span>
<span class="cp">#include &quot;pc.h&quot;</span>
<span class="cp">#include &quot;dqueue.h&quot;</span>
<span class="cp">#include &quot;adapter.h&quot;</span>
<span class="cp">#include &quot;entity.h&quot;</span>
<span class="cp">#include &quot;um_xdi.h&quot;</span>
<span class="cp">#include &quot;um_idi.h&quot;</span>
<span class="cp">#include &quot;debuglib.h&quot;</span>
<span class="cp">#include &quot;divasync.h&quot;</span>

<span class="cp">#define DIVAS_MAX_XDI_ADAPTERS	64</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">   IMPORTS</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">diva_os_wakeup_read</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">os_context</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">diva_os_wakeup_close</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">os_context</span><span class="p">);</span>
<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">   LOCALS</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">adapter_q</span><span class="p">);</span>
<span class="k">static</span> <span class="n">diva_os_spin_lock_t</span> <span class="n">adapter_lock</span><span class="p">;</span>

<span class="k">static</span> <span class="n">diva_um_idi_adapter_t</span> <span class="o">*</span><span class="n">diva_um_idi_find_adapter</span><span class="p">(</span><span class="n">dword</span> <span class="n">nr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cleanup_adapter</span><span class="p">(</span><span class="n">diva_um_idi_adapter_t</span> <span class="o">*</span><span class="n">a</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cleanup_entity</span><span class="p">(</span><span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="n">e</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">diva_user_mode_idi_adapter_features</span><span class="p">(</span><span class="n">diva_um_idi_adapter_t</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
					       <span class="n">diva_um_idi_adapter_features_t</span>
					       <span class="o">*</span><span class="n">features</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">process_idi_request</span><span class="p">(</span><span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span>
			       <span class="k">const</span> <span class="n">diva_um_idi_req_hdr_t</span> <span class="o">*</span><span class="n">req</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">process_idi_rc</span><span class="p">(</span><span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="n">byte</span> <span class="n">rc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">process_idi_ind</span><span class="p">(</span><span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="n">byte</span> <span class="n">ind</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">write_return_code</span><span class="p">(</span><span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="n">byte</span> <span class="n">rc</span><span class="p">);</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">   MAIN</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>
<span class="kt">int</span> <span class="nf">diva_user_mode_idi_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">diva_os_initialize_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="s">&quot;adapter&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">   Copy adapter features to user supplied buffer</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">diva_user_mode_idi_adapter_features</span><span class="p">(</span><span class="n">diva_um_idi_adapter_t</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
				    <span class="n">diva_um_idi_adapter_features_t</span> <span class="o">*</span>
				    <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IDI_SYNC_REQ</span> <span class="n">sync_req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">request</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">features</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
		<span class="n">features</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">features</span><span class="p">;</span>
		<span class="n">features</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">channels</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">features</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">features</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

		<span class="n">sync_req</span><span class="p">.</span><span class="n">GetName</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sync_req</span><span class="p">.</span><span class="n">GetName</span><span class="p">.</span><span class="n">Rc</span> <span class="o">=</span> <span class="n">IDI_SYNC_REQ_GET_NAME</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">request</span><span class="p">))</span> <span class="p">((</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sync_req</span><span class="p">);</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">features</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sync_req</span><span class="p">.</span><span class="n">GetName</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">features</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

		<span class="n">sync_req</span><span class="p">.</span><span class="n">GetSerial</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sync_req</span><span class="p">.</span><span class="n">GetSerial</span><span class="p">.</span><span class="n">Rc</span> <span class="o">=</span> <span class="n">IDI_SYNC_REQ_GET_SERIAL</span><span class="p">;</span>
		<span class="n">sync_req</span><span class="p">.</span><span class="n">GetSerial</span><span class="p">.</span><span class="n">serial</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">request</span><span class="p">))((</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sync_req</span><span class="p">);</span>
		<span class="n">features</span><span class="o">-&gt;</span><span class="n">serial_number</span> <span class="o">=</span> <span class="n">sync_req</span><span class="p">.</span><span class="n">GetSerial</span><span class="p">.</span><span class="n">serial</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">a</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">   REMOVE ADAPTER</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>
<span class="kt">void</span> <span class="nf">diva_user_mode_idi_remove_adapter</span><span class="p">(</span><span class="kt">int</span> <span class="n">adapter_nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">diva_um_idi_adapter_t</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">diva_um_idi_adapter_t</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_nr</span> <span class="o">==</span> <span class="n">adapter_nr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
			<span class="n">cleanup_adapter</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
			<span class="n">DBG_LOG</span><span class="p">((</span><span class="s">&quot;DIDD: del adapter(%d)&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">));</span>
			<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">   CALLED ON DRIVER EXIT (UNLOAD)</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>
<span class="kt">void</span> <span class="nf">diva_user_mode_idi_finit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">safe</span><span class="p">;</span>
	<span class="n">diva_um_idi_adapter_t</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">safe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">diva_um_idi_adapter_t</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">cleanup_adapter</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
		<span class="n">DBG_LOG</span><span class="p">((</span><span class="s">&quot;DIDD: del adapter(%d)&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">));</span>
		<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">diva_os_destroy_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="s">&quot;adapter&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -------------------------------------------------------------------------</span>
<span class="cm">   CREATE AND INIT IDI ADAPTER</span>
<span class="cm">   ------------------------------------------------------------------------- */</span>
<span class="kt">int</span> <span class="nf">diva_user_mode_idi_create_adapter</span><span class="p">(</span><span class="k">const</span> <span class="n">DESCRIPTOR</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adapter_nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>
	<span class="n">diva_um_idi_adapter_t</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">diva_um_idi_adapter_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">diva_os_malloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
							 <span class="k">sizeof</span>
							 <span class="p">(</span><span class="n">diva_um_idi_adapter_t</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">));</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">entity_q</span><span class="p">);</span>

	<span class="n">a</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">=</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_nr</span> <span class="o">=</span> <span class="n">adapter_nr</span><span class="p">;</span>

	<span class="n">DBG_LOG</span><span class="p">((</span><span class="s">&quot;DIDD_ADD A(%d), type:%02x, features:%04x, channels:%d&quot;</span><span class="p">,</span>
		 <span class="n">adapter_nr</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">features</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">channels</span><span class="p">));</span>

	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;create_adapter&quot;</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter_q</span><span class="p">);</span>
	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;create_adapter&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm">   Find adapter by Adapter number</span>
<span class="cm">   ------------------------------------------------------------------------ */</span>
<span class="k">static</span> <span class="n">diva_um_idi_adapter_t</span> <span class="o">*</span><span class="nf">diva_um_idi_find_adapter</span><span class="p">(</span><span class="n">dword</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">diva_um_idi_adapter_t</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">diva_um_idi_adapter_t</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>
		<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;find_adapter: (%d)-(%d)&quot;</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_nr</span> <span class="o">==</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">nr</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">a</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm">   Cleanup this adapter and cleanup/delete all entities assigned</span>
<span class="cm">   to this adapter</span>
<span class="cm">   ------------------------------------------------------------------------ */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cleanup_adapter</span><span class="p">(</span><span class="n">diva_um_idi_adapter_t</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">safe</span><span class="p">;</span>
	<span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">safe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">entity_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">divas_um_idi_entity_t</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">cleanup_entity</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">os_context</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_os_wakeup_read</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">os_context</span><span class="p">);</span>
			<span class="n">diva_os_wakeup_close</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">os_context</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DESCRIPTOR</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm">   Cleanup, but NOT delete this entity</span>
<span class="cm">   ------------------------------------------------------------------------ */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cleanup_entity</span><span class="p">(</span><span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">os_ref</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">rc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">DIVA_UM_IDI_REMOVED</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">DIVA_UM_IDI_REMOVE_PENDING</span><span class="p">;</span>

	<span class="n">diva_data_q_finit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">diva_data_q_finit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm">   Create ENTITY, link it to the adapter and remove pointer to entity</span>
<span class="cm">   ------------------------------------------------------------------------ */</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">divas_um_idi_create_entity</span><span class="p">(</span><span class="n">dword</span> <span class="n">adapter_nr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="n">diva_um_idi_adapter_t</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">diva_os_malloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span>
		    <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">os_context</span> <span class="o">=</span>
		     <span class="n">diva_os_malloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">diva_os_get_context_size</span><span class="p">())))</span> <span class="p">{</span>
			<span class="n">DBG_LOG</span><span class="p">((</span><span class="s">&quot;E(%08x) no memory for os context&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">));</span>
			<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">os_context</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">diva_os_get_context_size</span><span class="p">());</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">diva_data_q_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">2048</span> <span class="o">+</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">16</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">os_context</span><span class="p">);</span>
			<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">diva_data_q_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">diva_um_idi_ind_hdr_t</span><span class="p">),</span> <span class="mi">2</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">diva_data_q_finit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">os_context</span><span class="p">);</span>
			<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;create_entity&quot;</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		  Look for Adapter requested</span>
<span class="cm">		*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">diva_um_idi_find_adapter</span><span class="p">(</span><span class="n">adapter_nr</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			  No adapter was found, or this adapter was removed</span>
<span class="cm">			*/</span>
			<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;create_entity&quot;</span><span class="p">);</span>

			<span class="n">DBG_LOG</span><span class="p">((</span><span class="s">&quot;A: no adapter(%ld)&quot;</span><span class="p">,</span> <span class="n">adapter_nr</span><span class="p">));</span>

			<span class="n">cleanup_entity</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
			<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">os_context</span><span class="p">);</span>
			<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>

			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">e</span><span class="o">-&gt;</span><span class="n">os_ref</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>	<span class="cm">/* link to os handle */</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>	<span class="cm">/* link to adapter   */</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">entity_q</span><span class="p">);</span>	<span class="cm">/* link from adapter */</span>

		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;create_entity&quot;</span><span class="p">);</span>

		<span class="n">DBG_LOG</span><span class="p">((</span><span class="s">&quot;A(%ld), create E(%08x)&quot;</span><span class="p">,</span> <span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm">   Unlink entity and free memory</span>
<span class="cm">   ------------------------------------------------------------------------ */</span>
<span class="kt">int</span> <span class="nf">divas_um_idi_delete_entity</span><span class="p">(</span><span class="kt">int</span> <span class="n">adapter_nr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">entity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="n">diva_um_idi_adapter_t</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">entity</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;delete_entity&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">a</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;delete_entity&quot;</span><span class="p">);</span>

	<span class="n">diva_um_idi_stop_wdog</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
	<span class="n">cleanup_entity</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
	<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">os_context</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">));</span>
	<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>

	<span class="n">DBG_LOG</span><span class="p">((</span><span class="s">&quot;A(%d) remove E:%08x&quot;</span><span class="p">,</span> <span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">));</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">   Called by application to read data from IDI</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>
<span class="kt">int</span> <span class="nf">diva_um_idi_read</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">entity</span><span class="p">,</span>
		     <span class="kt">void</span> <span class="o">*</span><span class="n">os_handle</span><span class="p">,</span>
		     <span class="kt">void</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">divas_um_idi_copy_to_user_fn_t</span> <span class="n">cp_fn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="n">diva_um_idi_adapter_t</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">diva_um_idi_data_queue_t</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>

	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;read&quot;</span><span class="p">);</span>

	<span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">entity</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_REMOVE_PENDING</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_REMOVED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_ADAPTER_REMOVED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;read&quot;</span><span class="p">);</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;E(%08x) read failed - adapter removed&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;A(%d) E(%08x) read(%d)&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">max_length</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	  Try to read return code first</span>
<span class="cm">	*/</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">diva_data_q_get_segment4read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">);</span>
	<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	  No return codes available, read indications now</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_RC_PENDING</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;A(%d) E(%08x) read data&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">));</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">diva_data_q_get_segment4read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DIVA_UM_IDI_RC_PENDING</span><span class="p">;</span>
		<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;A(%d) E(%08x) read rc&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">length</span> <span class="o">=</span> <span class="n">diva_data_q_get_segment_length</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="o">&gt;</span>
		    <span class="n">max_length</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			  Not enough space to read message</span>
<span class="cm">			*/</span>
			<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;A: A(%d) E(%08x) read small buffer&quot;</span><span class="p">,</span>
				 <span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>
			<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span>
						<span class="s">&quot;read&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		  Copy it to user, this function does access ONLY locked an verified</span>
<span class="cm">		  memory, also we can access it witch spin lock held</span>
<span class="cm">		*/</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">cp_fn</span><span class="p">)</span> <span class="p">(</span><span class="n">os_handle</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			  Acknowledge only if read was successful</span>
<span class="cm">			*/</span>
			<span class="n">diva_data_q_ack_segment4read</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;A(%d) E(%08x) read=%d&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>

	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;read&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">diva_um_idi_write</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">entity</span><span class="p">,</span>
		      <span class="kt">void</span> <span class="o">*</span><span class="n">os_handle</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">divas_um_idi_copy_from_user_fn_t</span> <span class="n">cp_fn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="n">diva_um_idi_adapter_t</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">diva_um_idi_req_hdr_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>

	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;write&quot;</span><span class="p">);</span>

	<span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">entity</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_REMOVE_PENDING</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_REMOVED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_ADAPTER_REMOVED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;write&quot;</span><span class="p">);</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;E(%08x) write failed - adapter removed&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;A(%d) E(%08x) write(%d)&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">length</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">length</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;write&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_RC_PENDING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;A: A(%d) E(%08x) rc pending&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">));</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;write&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* should wait for RC code first */</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	  Copy function does access only locked verified memory,</span>
<span class="cm">	  also it can be called with spin lock held</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">cp_fn</span><span class="p">)</span> <span class="p">(</span><span class="n">os_handle</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;A: A(%d) E(%08x) write error=%d&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span>
			 <span class="n">e</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;write&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_um_idi_req_hdr_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DIVA_UM_IDI_GET_FEATURES</span>:<span class="p">{</span>
		<span class="n">DBG_LOG</span><span class="p">((</span><span class="s">&quot;A(%d) get_features&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span>
		      <span class="n">diva_data_q_get_segment4write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;A(%d) get_features, no free buffer&quot;</span><span class="p">,</span>
				 <span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">));</span>
			<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span>
						<span class="s">&quot;write&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">diva_user_mode_idi_adapter_features</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(((</span><span class="n">diva_um_idi_ind_hdr_t</span>
							   <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">features</span><span class="p">));</span>
		<span class="p">((</span><span class="n">diva_um_idi_ind_hdr_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span>
			<span class="n">DIVA_UM_IDI_IND_FEATURES</span><span class="p">;</span>
		<span class="p">((</span><span class="n">diva_um_idi_ind_hdr_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">diva_data_q_ack_segment4write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					      <span class="k">sizeof</span><span class="p">(</span><span class="n">diva_um_idi_ind_hdr_t</span><span class="p">));</span>

		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;write&quot;</span><span class="p">);</span>

		<span class="n">diva_os_wakeup_read</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">os_context</span><span class="p">);</span>
	<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIVA_UM_IDI_REQ</span>:
	<span class="k">case</span> <span class="n">DIVA_UM_IDI_REQ_MAN</span>:
	<span class="k">case</span> <span class="n">DIVA_UM_IDI_REQ_SIG</span>:
	<span class="k">case</span> <span class="n">DIVA_UM_IDI_REQ_NET</span>:
		<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;A(%d) REQ(%02d)-(%02d)-(%08x)&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span>
			 <span class="n">req</span><span class="o">-&gt;</span><span class="n">Req</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ReqCh</span><span class="p">,</span>
			 <span class="n">req</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_REQ_TYPE_MASK</span><span class="p">));</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">process_idi_request</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
			<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;write&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">case</span> <span class="o">-</span><span class="mi">2</span>:
			<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;write&quot;</span><span class="p">);</span>
			<span class="n">diva_os_wakeup_read</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">os_context</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;write&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;write&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;A(%d) E(%08x) write=%d&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">   CALLBACK FROM XDI</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">diva_um_idi_xdi_callback</span><span class="p">(</span><span class="n">ENTITY</span> <span class="o">*</span><span class="n">entity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">DIVAS_CONTAINING_RECORD</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span>
							   <span class="n">divas_um_idi_entity_t</span><span class="p">,</span>
							   <span class="n">e</span><span class="p">);</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">call_wakeup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;xdi_callback&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">complete</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_REMOVE_PENDING</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">diva_um_idi_stop_wdog</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">call_wakeup</span> <span class="o">=</span> <span class="n">process_idi_rc</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Rc</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">rc_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">e</span><span class="o">-&gt;</span><span class="n">rc_count</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;xdi_callback&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">call_wakeup</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_os_wakeup_read</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">os_context</span><span class="p">);</span>
			<span class="n">diva_os_wakeup_close</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">os_context</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_REMOVE_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">RNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">RNR</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">call_wakeup</span> <span class="o">=</span> <span class="n">process_idi_ind</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Ind</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;xdi_callback&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call_wakeup</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_os_wakeup_read</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">os_context</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_idi_request</span><span class="p">(</span><span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span>
			       <span class="k">const</span> <span class="n">diva_um_idi_req_hdr_t</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">assign</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">Req</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">Req</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">type</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_REQ_TYPE_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Id</span> <span class="o">||</span> <span class="o">!</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">callback</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* not assigned */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Req</span> <span class="o">!=</span> <span class="n">ASSIGN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;A: A(%d) E(%08x) not assigned&quot;</span><span class="p">,</span>
				 <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">));</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* NOT ASSIGNED */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">DIVA_UM_IDI_REQ_TYPE_MAN</span>:
				<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Id</span> <span class="o">=</span> <span class="n">MAN_ID</span><span class="p">;</span>
				<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;A(%d) E(%08x) assign MAN&quot;</span><span class="p">,</span>
					 <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">DIVA_UM_IDI_REQ_TYPE_SIG</span>:
				<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Id</span> <span class="o">=</span> <span class="n">DSIG_ID</span><span class="p">;</span>
				<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;A(%d) E(%08x) assign SIG&quot;</span><span class="p">,</span>
					 <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">DIVA_UM_IDI_REQ_TYPE_NET</span>:
				<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Id</span> <span class="o">=</span> <span class="n">NL_ID</span><span class="p">;</span>
				<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;A(%d) E(%08x) assign NET&quot;</span><span class="p">,</span>
					 <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;A: A(%d) E(%08x) unknown type=%08x&quot;</span><span class="p">,</span>
					 <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span>
					 <span class="n">type</span><span class="p">));</span>
				<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">XNum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">RNum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">diva_um_idi_xdi_callback</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">XData</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">R</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">;</span>
		<span class="n">assign</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">DIVA_UM_IDI_RC_PENDING</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="n">Req</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">ReqCh</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ReqCh</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">X</span><span class="o">-&gt;</span><span class="n">PLength</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">X</span><span class="o">-&gt;</span><span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>	<span class="cm">/* Our buffer is safe */</span>

	<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;A(%d) E(%08x) request(%02x-%02x-%02x (%d))&quot;</span><span class="p">,</span>
		 <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Req</span><span class="p">,</span>
		 <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">ReqCh</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">X</span><span class="o">-&gt;</span><span class="n">PLength</span><span class="p">));</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">rc_count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diva_um_idi_start_wdog</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">request</span><span class="p">))</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">assign</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Rc</span> <span class="o">==</span> <span class="n">OUT_OF_RESOURCES</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			  XDI has no entities more, call was not forwarded to the card,</span>
<span class="cm">			  no callback will be scheduled</span>
<span class="cm">			*/</span>
			<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;A: A(%d) E(%08x) XDI out of entities&quot;</span><span class="p">,</span>
				 <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">));</span>

			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">ReqCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">RcCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">IndCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">XNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">RNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">R</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">write_return_code</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ASSIGN_RC</span> <span class="o">|</span> <span class="n">OUT_OF_RESOURCES</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">DIVA_UM_IDI_ASSIGN_PENDING</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_idi_rc</span><span class="p">(</span><span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="n">byte</span> <span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;A(%d) E(%08x) rc(%02x-%02x-%02x)&quot;</span><span class="p">,</span>
		 <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">RcCh</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_ASSIGN_PENDING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DIVA_UM_IDI_ASSIGN_PENDING</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ASSIGN_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;A: A(%d) E(%08x) ASSIGN failed&quot;</span><span class="p">,</span>
				 <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">));</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">ReqCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">RcCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">IndCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">R</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">XNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">RNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Req</span> <span class="o">==</span> <span class="n">REMOVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Id</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;A: A(%d) E(%08x)  discard OK in REMOVE&quot;</span><span class="p">,</span>
			 <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>	<span class="cm">/* let us do it in the driver */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Req</span> <span class="o">==</span> <span class="n">REMOVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Id</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* REMOVE COMPLETE */</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">ReqCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">RcCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">IndCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">R</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">XNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">RNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">rc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Req</span> <span class="o">==</span> <span class="n">REMOVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* REMOVE FAILED */</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;A: A(%d) E(%08x)  REMOVE FAILED&quot;</span><span class="p">,</span>
			 <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">write_return_code</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_idi_ind</span><span class="p">(</span><span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="n">byte</span> <span class="n">ind</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">do_wakeup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">complete</span> <span class="o">!=</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diva_um_idi_ind_hdr_t</span> <span class="o">*</span><span class="n">pind</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">diva_um_idi_ind_hdr_t</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">diva_data_q_get_segment4write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pind</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">RNum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">R</span><span class="o">-&gt;</span><span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pind</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">R</span><span class="o">-&gt;</span><span class="n">PLength</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="p">(</span><span class="n">diva_data_q_get_max_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pind</span><span class="p">));</span>
			<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;A(%d) E(%08x) ind_1(%02x-%02x-%02x)-[%d-%d]&quot;</span><span class="p">,</span>
				 <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span>
				 <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">IndCh</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">RLength</span><span class="p">,</span>
				 <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">R</span><span class="o">-&gt;</span><span class="n">PLength</span><span class="p">));</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;A(%d) E(%08x) ind(%02x-%02x-%02x)-RNR&quot;</span><span class="p">,</span>
				 <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span>
				 <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">IndCh</span><span class="p">));</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">RNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">RNR</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">do_wakeup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">diva_um_idi_ind_hdr_t</span> <span class="o">*</span><span class="n">pind</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">diva_um_idi_ind_hdr_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">R</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">);</span>

		<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;A(%d) E(%08x) ind(%02x-%02x-%02x)-[%d]&quot;</span><span class="p">,</span>
			 <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span>
			 <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">IndCh</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">R</span><span class="o">-&gt;</span><span class="n">PLength</span><span class="p">));</span>

		<span class="n">pind</span><span class="o">--</span><span class="p">;</span>
		<span class="n">pind</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">DIVA_UM_IDI_IND</span><span class="p">;</span>
		<span class="n">pind</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ind</span><span class="p">.</span><span class="n">Ind</span> <span class="o">=</span> <span class="n">ind</span><span class="p">;</span>
		<span class="n">pind</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ind</span><span class="p">.</span><span class="n">IndCh</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">IndCh</span><span class="p">;</span>
		<span class="n">pind</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">R</span><span class="o">-&gt;</span><span class="n">PLength</span><span class="p">;</span>
		<span class="n">diva_data_q_ack_segment4write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					      <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pind</span><span class="p">)</span> <span class="o">+</span>
						     <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">R</span><span class="o">-&gt;</span><span class="n">PLength</span><span class="p">));</span>
		<span class="n">do_wakeup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_RC_PENDING</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_wakeup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">do_wakeup</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">   Write return code to the return code queue of entity</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_return_code</span><span class="p">(</span><span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="n">byte</span> <span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">diva_um_idi_ind_hdr_t</span> <span class="o">*</span><span class="n">prc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">prc</span> <span class="o">=</span>
	      <span class="p">(</span><span class="n">diva_um_idi_ind_hdr_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">diva_data_q_get_segment4write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;A: A(%d) E(%08x) rc(%02x) lost&quot;</span><span class="p">,</span>
			 <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">rc</span><span class="p">));</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DIVA_UM_IDI_RC_PENDING</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">prc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">DIVA_UM_IDI_IND_RC</span><span class="p">;</span>
	<span class="n">prc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">Rc</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">prc</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">rc</span><span class="p">.</span><span class="n">RcCh</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">RcCh</span><span class="p">;</span>
	<span class="n">prc</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">diva_data_q_ack_segment4write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">prc</span><span class="p">));</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">   Return amount of entries that can be bead from this entity or</span>
<span class="cm">   -1 if adapter was removed</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>
<span class="kt">int</span> <span class="nf">diva_user_mode_idi_ind_ready</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">entity</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">os_handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="n">diva_um_idi_adapter_t</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entity</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;ind_ready&quot;</span><span class="p">);</span>
	<span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">entity</span><span class="p">;</span>
	<span class="n">a</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">a</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_ADAPTER_REMOVED</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		  Adapter was unloaded</span>
<span class="cm">		*/</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;ind_ready&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* adapter was removed */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_REMOVED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		  entity was removed as result of adapter removal</span>
<span class="cm">		  user should assign this entity again</span>
<span class="cm">		*/</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;ind_ready&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">.</span><span class="n">count</span> <span class="o">+</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_RC_PENDING</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">rc</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;ind_ready&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">diva_um_id_get_os_context</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">entity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(((</span><span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">entity</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">os_context</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">divas_um_idi_entity_assigned</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">entity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="n">diva_um_idi_adapter_t</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>

	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;assigned?&quot;</span><span class="p">);</span>


	<span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">entity</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_REMOVED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_ADAPTER_REMOVED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;assigned?&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">DIVA_UM_IDI_REMOVE_PENDING</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Id</span> <span class="o">||</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">rc_count</span>
	       <span class="o">||</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_ASSIGN_PENDING</span><span class="p">));</span>

	<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;Id:%02x, rc_count:%d, status:%08x&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">rc_count</span><span class="p">,</span>
		 <span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>

		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;assigned?&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">divas_um_idi_entity_start_remove</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">entity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="n">diva_um_idi_adapter_t</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>

	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;start_remove&quot;</span><span class="p">);</span>

	<span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">divas_um_idi_entity_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">entity</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_REMOVED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DIVA_UM_IDI_ADAPTER_REMOVED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;start_remove&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">rc_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		  Entity BUSY</span>
<span class="cm">		*/</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;start_remove&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		  Remove request was already pending, and arrived now</span>
<span class="cm">		*/</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;start_remove&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>	<span class="cm">/* REMOVE was pending */</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	  Now send remove request</span>
<span class="cm">	*/</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="n">REMOVE</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">ReqCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">rc_count</span><span class="o">++</span><span class="p">;</span>

	<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;A(%d) E(%08x) request(%02x-%02x-%02x (%d))&quot;</span><span class="p">,</span>
		 <span class="n">e</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_nr</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">Req</span><span class="p">,</span>
		 <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">ReqCh</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">X</span><span class="o">-&gt;</span><span class="n">PLength</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">request</span><span class="p">)</span>
		<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">request</span><span class="p">))</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">);</span>

	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;start_remove&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
