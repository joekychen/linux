<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hardware › eicon › message.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>message.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> Copyright (c) Eicon Networks, 2002.</span>
<span class="cm"> *</span>
<span class="cm"> This source file is supplied for the use with</span>
<span class="cm"> Eicon Networks range of DIVA Server Adapters.</span>
<span class="cm"> *</span>
<span class="cm"> Eicon File Revision :    2.1</span>
<span class="cm"> *</span>
<span class="cm"> This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> it under the terms of the GNU General Public License as published by</span>
<span class="cm"> the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> any later version.</span>
<span class="cm"> *</span>
<span class="cm"> This program is distributed in the hope that it will be useful,</span>
<span class="cm"> but WITHOUT ANY WARRANTY OF ANY KIND WHATSOEVER INCLUDING ANY</span>
<span class="cm"> implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="cm"> See the GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> You should have received a copy of the GNU General Public License</span>
<span class="cm"> along with this program; if not, write to the Free Software</span>
<span class="cm"> Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>





<span class="cp">#include &quot;platform.h&quot;</span>
<span class="cp">#include &quot;di_defs.h&quot;</span>
<span class="cp">#include &quot;pc.h&quot;</span>
<span class="cp">#include &quot;capi20.h&quot;</span>
<span class="cp">#include &quot;divacapi.h&quot;</span>
<span class="cp">#include &quot;mdm_msg.h&quot;</span>
<span class="cp">#include &quot;divasync.h&quot;</span>



<span class="cp">#define FILE_ &quot;MESSAGE.C&quot;</span>
<span class="cp">#define dprintf</span>









<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* This is options supported for all adapters that are server by    */</span>
<span class="cm">/* XDI driver. Allo it is not necessary to ask it from every adapter*/</span>
<span class="cm">/* and it is not necessary to save it separate for every adapter    */</span>
<span class="cm">/* Macrose defined here have only local meaning                     */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="n">dword</span> <span class="n">diva_xdi_extended_features</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#define DIVA_CAPI_USE_CMA                 0x00000001</span>
<span class="cp">#define DIVA_CAPI_XDI_PROVIDES_SDRAM_BAR  0x00000002</span>
<span class="cp">#define DIVA_CAPI_XDI_PROVIDES_NO_CANCEL  0x00000004</span>
<span class="cp">#define DIVA_CAPI_XDI_PROVIDES_RX_DMA     0x00000008</span>

<span class="cm">/*</span>
<span class="cm">  CAPI can request to process all return codes self only if:</span>
<span class="cm">  protocol code supports this &amp;&amp; xdi supports this</span>
<span class="cm">*/</span>
<span class="cp">#define DIVA_CAPI_SUPPORTS_NO_CANCEL(__a__)   (((__a__)-&gt;manufacturer_features &amp; MANUFACTURER_FEATURE_XONOFF_FLOW_CONTROL) &amp;&amp; ((__a__)-&gt;manufacturer_features &amp; MANUFACTURER_FEATURE_OK_FC_LABEL) &amp;&amp; (diva_xdi_extended_features &amp; DIVA_CAPI_XDI_PROVIDES_NO_CANCEL))</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* local function prototypes                                        */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">group_optimization</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_group_ind_mask</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">clear_group_ind_mask_bit</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">word</span> <span class="n">b</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">test_group_ind_mask_bit</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">word</span> <span class="n">b</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">AutomaticLaw</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">);</span>
<span class="n">word</span> <span class="n">CapiRelease</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>
<span class="n">word</span> <span class="n">CapiRegister</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>
<span class="n">word</span> <span class="n">api_put</span><span class="p">(</span><span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">word</span> <span class="n">api_parse</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">api_save_msg</span><span class="p">(</span><span class="n">API_PARSE</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="n">API_SAVE</span> <span class="o">*</span><span class="n">out</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">api_load_msg</span><span class="p">(</span><span class="n">API_SAVE</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">out</span><span class="p">);</span>

<span class="n">word</span> <span class="n">api_remove_start</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">api_remove_complete</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">plci_remove</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">diva_get_extended_adapter_features</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">diva_ask_for_xdi_sdram_bar</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">IDI_SYNC_REQ</span> <span class="o">*</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">callback</span><span class="p">(</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">control_rc</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">data_rc</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">data_ack</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sig_ind</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">SendInfo</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">dword</span><span class="p">,</span> <span class="n">byte</span> <span class="o">**</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">SendSetupInfo</span><span class="p">(</span><span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">dword</span><span class="p">,</span> <span class="n">byte</span> <span class="o">**</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">SendSSExtInd</span><span class="p">(</span><span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">byte</span> <span class="o">**</span><span class="n">parms</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">VSwitchReqInd</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">byte</span> <span class="o">**</span><span class="n">parms</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">nl_ind</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="n">byte</span> <span class="n">connect_req</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">connect_res</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">connect_a_res</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">disconnect_req</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">disconnect_res</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">listen_req</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">info_req</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">info_res</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">alert_req</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">facility_req</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">facility_res</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">connect_b3_req</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">connect_b3_res</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">connect_b3_a_res</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">disconnect_b3_req</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">disconnect_b3_res</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">data_b3_req</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">data_b3_res</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">reset_b3_req</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">reset_b3_res</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">connect_b3_t90_a_res</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">select_b_req</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">manufacturer_req</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">manufacturer_res</span><span class="p">(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="n">word</span> <span class="n">get_plci</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">add_p</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">add_s</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">code</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">add_ss</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">code</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">add_ie</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">code</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">word</span> <span class="n">p_length</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">add_d</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">add_ai</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">word</span> <span class="n">add_b1</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
<span class="k">static</span> <span class="n">word</span> <span class="n">add_b23</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">word</span> <span class="n">add_modem_b23</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">bp_parms</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sig_req</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">send_req</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">send_data</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">word</span> <span class="n">plci_remove_check</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">listen_check</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">AddInfo</span><span class="p">(</span><span class="n">byte</span> <span class="o">**</span><span class="p">,</span> <span class="n">byte</span> <span class="o">**</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">getChannel</span><span class="p">(</span><span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">IndParse</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">word</span> <span class="o">*</span><span class="p">,</span> <span class="n">byte</span> <span class="o">**</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">ie_compare</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">word</span> <span class="n">find_cip</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">word</span> <span class="n">CPN_filter_ok</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">cpn</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">  XON protocol helpers</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">channel_flow_control_remove</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">channel_x_off</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">ch</span><span class="p">,</span> <span class="n">byte</span> <span class="n">flag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">channel_x_on</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">ch</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">channel_request_xon</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">ch</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">channel_xmit_xon</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">channel_can_xon</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">ch</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">channel_xmit_extended_xon</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">);</span>

<span class="k">static</span> <span class="n">byte</span> <span class="n">SendMultiIE</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">byte</span> <span class="o">**</span><span class="n">parms</span><span class="p">,</span> <span class="n">byte</span> <span class="n">ie_type</span><span class="p">,</span> <span class="n">dword</span> <span class="n">info_mask</span><span class="p">,</span> <span class="n">byte</span> <span class="n">setupParse</span><span class="p">);</span>
<span class="k">static</span> <span class="n">word</span> <span class="n">AdvCodecSupport</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">CodecIdCheck</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">SetVoiceChannel</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">VoiceChannelOff</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">adv_voice_write_coefs</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">word</span> <span class="n">write_command</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">adv_voice_clear_config</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">);</span>

<span class="k">static</span> <span class="n">word</span> <span class="n">get_b1_facilities</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">b1_resource</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">add_b1_facilities</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">b1_resource</span><span class="p">,</span> <span class="n">word</span> <span class="n">b1_facilities</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">adjust_b1_facilities</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">new_b1_resource</span><span class="p">,</span> <span class="n">word</span> <span class="n">new_b1_facilities</span><span class="p">);</span>
<span class="k">static</span> <span class="n">word</span> <span class="n">adjust_b_process</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">adjust_b1_resource</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">API_SAVE</span> <span class="o">*</span><span class="n">bp_msg</span><span class="p">,</span> <span class="n">word</span> <span class="n">b1_facilities</span><span class="p">,</span> <span class="n">word</span> <span class="n">internal_command</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">adjust_b_restore</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_b3_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">select_b_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fax_connect_ack_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fax_edata_ack_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fax_connect_info_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fax_adjust_b23_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fax_disconnect_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hold_save_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">retrieve_restore_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">init_b1_config</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">clear_b1_config</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">dtmf_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">dtmf_request</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">msg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dtmf_confirmation</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dtmf_indication</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">word</span> <span class="n">length</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dtmf_parameter_write</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">mixer_set_bchannel_id_esc</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">bchannel_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mixer_set_bchannel_id</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">chi</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mixer_clear_config</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mixer_notify_update</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">others</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mixer_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">mixer_request</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">msg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mixer_indication_coefs_set</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mixer_indication_xconnect_from</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">word</span> <span class="n">length</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mixer_indication_xconnect_to</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">word</span> <span class="n">length</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mixer_remove</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">ec_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">);</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">ec_request</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">msg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ec_indication</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">word</span> <span class="n">length</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">rtp_connect_b3_req_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rtp_connect_b3_res_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">diva_get_dma_descriptor</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">dword</span> <span class="o">*</span><span class="n">dma_magic</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">diva_free_dma_descriptor</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">);</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* external function prototypes                                     */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">extern</span> <span class="n">byte</span> <span class="n">MapController</span><span class="p">(</span><span class="n">byte</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">byte</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">byte</span><span class="p">);</span>
<span class="cp">#define MapId(Id)(((Id) &amp; 0xffffff00L) | MapController((byte)(Id)))</span>
<span class="cp">#define UnMapId(Id)(((Id) &amp; 0xffffff00L) | UnMapController((byte)(Id)))</span>

<span class="kt">void</span> <span class="n">sendf</span><span class="p">(</span><span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="p">,</span> <span class="p">...);</span>
<span class="kt">void</span> <span class="o">*</span><span class="n">TransmitBufferSet</span><span class="p">(</span><span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">dword</span> <span class="n">ref</span><span class="p">);</span>
<span class="kt">void</span> <span class="o">*</span><span class="n">TransmitBufferGet</span><span class="p">(</span><span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">TransmitBufferFree</span><span class="p">(</span><span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="kt">void</span> <span class="o">*</span><span class="n">ReceiveBufferGet</span><span class="p">(</span><span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">Num</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">fax_head_line_time</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>


<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* Global data definitions                                          */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="k">extern</span> <span class="n">byte</span> <span class="n">max_adapter</span><span class="p">;</span>
<span class="k">extern</span> <span class="n">byte</span> <span class="n">max_appl</span><span class="p">;</span>
<span class="k">extern</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
<span class="k">extern</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">application</span><span class="p">;</span>







<span class="k">static</span> <span class="n">byte</span> <span class="n">remove_started</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="k">static</span> <span class="n">PLCI</span> <span class="n">dummy_plci</span><span class="p">;</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">_ftable</span> <span class="p">{</span>
	<span class="n">word</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
	<span class="n">byte</span> <span class="p">(</span><span class="o">*</span><span class="n">function</span><span class="p">)(</span><span class="n">dword</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="p">);</span>
<span class="p">}</span> <span class="n">ftable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">_DATA_B3_R</span><span class="p">,</span>                          <span class="s">&quot;dwww&quot;</span><span class="p">,</span>         <span class="n">data_b3_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_DATA_B3_I</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">,</span>               <span class="s">&quot;w&quot;</span><span class="p">,</span>            <span class="n">data_b3_res</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_INFO_R</span><span class="p">,</span>                             <span class="s">&quot;ss&quot;</span><span class="p">,</span>           <span class="n">info_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_INFO_I</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">,</span>                  <span class="s">&quot;&quot;</span><span class="p">,</span>             <span class="n">info_res</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_CONNECT_R</span><span class="p">,</span>                          <span class="s">&quot;wsssssssss&quot;</span><span class="p">,</span>   <span class="n">connect_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_CONNECT_I</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">,</span>               <span class="s">&quot;wsssss&quot;</span><span class="p">,</span>       <span class="n">connect_res</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_CONNECT_ACTIVE_I</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">,</span>        <span class="s">&quot;&quot;</span><span class="p">,</span>             <span class="n">connect_a_res</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_DISCONNECT_R</span><span class="p">,</span>                       <span class="s">&quot;s&quot;</span><span class="p">,</span>            <span class="n">disconnect_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_DISCONNECT_I</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">,</span>            <span class="s">&quot;&quot;</span><span class="p">,</span>             <span class="n">disconnect_res</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_LISTEN_R</span><span class="p">,</span>                           <span class="s">&quot;dddss&quot;</span><span class="p">,</span>        <span class="n">listen_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_ALERT_R</span><span class="p">,</span>                            <span class="s">&quot;s&quot;</span><span class="p">,</span>            <span class="n">alert_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_FACILITY_R</span><span class="p">,</span>                         <span class="s">&quot;ws&quot;</span><span class="p">,</span>           <span class="n">facility_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_FACILITY_I</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">,</span>              <span class="s">&quot;ws&quot;</span><span class="p">,</span>           <span class="n">facility_res</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_CONNECT_B3_R</span><span class="p">,</span>                       <span class="s">&quot;s&quot;</span><span class="p">,</span>            <span class="n">connect_b3_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_CONNECT_B3_I</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">,</span>            <span class="s">&quot;ws&quot;</span><span class="p">,</span>           <span class="n">connect_b3_res</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_CONNECT_B3_ACTIVE_I</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">,</span>     <span class="s">&quot;&quot;</span><span class="p">,</span>             <span class="n">connect_b3_a_res</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_DISCONNECT_B3_R</span><span class="p">,</span>                    <span class="s">&quot;s&quot;</span><span class="p">,</span>            <span class="n">disconnect_b3_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_DISCONNECT_B3_I</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">,</span>         <span class="s">&quot;&quot;</span><span class="p">,</span>             <span class="n">disconnect_b3_res</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_RESET_B3_R</span><span class="p">,</span>                         <span class="s">&quot;s&quot;</span><span class="p">,</span>            <span class="n">reset_b3_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_RESET_B3_I</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">,</span>              <span class="s">&quot;&quot;</span><span class="p">,</span>             <span class="n">reset_b3_res</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_CONNECT_B3_T90_ACTIVE_I</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span>           <span class="n">connect_b3_t90_a_res</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_CONNECT_B3_T90_ACTIVE_I</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span>             <span class="n">connect_b3_t90_a_res</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_SELECT_B_REQ</span><span class="p">,</span>                       <span class="s">&quot;s&quot;</span><span class="p">,</span>            <span class="n">select_b_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_MANUFACTURER_R</span><span class="p">,</span>                     <span class="s">&quot;dws&quot;</span><span class="p">,</span>          <span class="n">manufacturer_req</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_MANUFACTURER_I</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">,</span>          <span class="s">&quot;dws&quot;</span><span class="p">,</span>          <span class="n">manufacturer_res</span><span class="p">},</span>
	<span class="p">{</span><span class="n">_MANUFACTURER_I</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">,</span>          <span class="s">&quot;&quot;</span><span class="p">,</span>             <span class="n">manufacturer_res</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">byte</span> <span class="o">*</span><span class="n">cip_bc</span><span class="p">[</span><span class="mi">29</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span>                     <span class="s">&quot;&quot;</span>                     <span class="p">},</span> <span class="cm">/* 0 */</span>
	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x03\x80\x90\xa3</span><span class="s">&quot;</span><span class="p">,</span>     <span class="s">&quot;</span><span class="se">\x03\x80\x90\xa2</span><span class="s">&quot;</span>     <span class="p">},</span> <span class="cm">/* 1 */</span>
	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x02\x88\x90</span><span class="s">&quot;</span><span class="p">,</span>         <span class="s">&quot;</span><span class="se">\x02\x88\x90</span><span class="s">&quot;</span>         <span class="p">},</span> <span class="cm">/* 2 */</span>
	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x02\x89\x90</span><span class="s">&quot;</span><span class="p">,</span>         <span class="s">&quot;</span><span class="se">\x02\x89\x90</span><span class="s">&quot;</span>         <span class="p">},</span> <span class="cm">/* 3 */</span>
	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x03\x90\x90\xa3</span><span class="s">&quot;</span><span class="p">,</span>     <span class="s">&quot;</span><span class="se">\x03\x90\x90\xa2</span><span class="s">&quot;</span>     <span class="p">},</span> <span class="cm">/* 4 */</span>
	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x03\x91\x90\xa5</span><span class="s">&quot;</span><span class="p">,</span>     <span class="s">&quot;</span><span class="se">\x03\x91\x90\xa5</span><span class="s">&quot;</span>     <span class="p">},</span> <span class="cm">/* 5 */</span>
	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x02\x98\x90</span><span class="s">&quot;</span><span class="p">,</span>         <span class="s">&quot;</span><span class="se">\x02\x98\x90</span><span class="s">&quot;</span>         <span class="p">},</span> <span class="cm">/* 6 */</span>
	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x04\x88\xc0\xc6\xe6</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x04\x88\xc0\xc6\xe6</span><span class="s">&quot;</span> <span class="p">},</span> <span class="cm">/* 7 */</span>
	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x04\x88\x90\x21\x8f</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x04\x88\x90\x21\x8f</span><span class="s">&quot;</span> <span class="p">},</span> <span class="cm">/* 8 */</span>
	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x03\x91\x90\xa5</span><span class="s">&quot;</span><span class="p">,</span>     <span class="s">&quot;</span><span class="se">\x03\x91\x90\xa5</span><span class="s">&quot;</span>     <span class="p">},</span> <span class="cm">/* 9 */</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span>                     <span class="s">&quot;&quot;</span>                     <span class="p">},</span> <span class="cm">/* 10 */</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span>                     <span class="s">&quot;&quot;</span>                     <span class="p">},</span> <span class="cm">/* 11 */</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span>                     <span class="s">&quot;&quot;</span>                     <span class="p">},</span> <span class="cm">/* 12 */</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span>                     <span class="s">&quot;&quot;</span>                     <span class="p">},</span> <span class="cm">/* 13 */</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span>                     <span class="s">&quot;&quot;</span>                     <span class="p">},</span> <span class="cm">/* 14 */</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span>                     <span class="s">&quot;&quot;</span>                     <span class="p">},</span> <span class="cm">/* 15 */</span>

	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x03\x80\x90\xa3</span><span class="s">&quot;</span><span class="p">,</span>     <span class="s">&quot;</span><span class="se">\x03\x80\x90\xa2</span><span class="s">&quot;</span>     <span class="p">},</span> <span class="cm">/* 16 */</span>
	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x03\x90\x90\xa3</span><span class="s">&quot;</span><span class="p">,</span>     <span class="s">&quot;</span><span class="se">\x03\x90\x90\xa2</span><span class="s">&quot;</span>     <span class="p">},</span> <span class="cm">/* 17 */</span>
	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x02\x88\x90</span><span class="s">&quot;</span><span class="p">,</span>         <span class="s">&quot;</span><span class="se">\x02\x88\x90</span><span class="s">&quot;</span>         <span class="p">},</span> <span class="cm">/* 18 */</span>
	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x02\x88\x90</span><span class="s">&quot;</span><span class="p">,</span>         <span class="s">&quot;</span><span class="se">\x02\x88\x90</span><span class="s">&quot;</span>         <span class="p">},</span> <span class="cm">/* 19 */</span>
	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x02\x88\x90</span><span class="s">&quot;</span><span class="p">,</span>         <span class="s">&quot;</span><span class="se">\x02\x88\x90</span><span class="s">&quot;</span>         <span class="p">},</span> <span class="cm">/* 20 */</span>
	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x02\x88\x90</span><span class="s">&quot;</span><span class="p">,</span>         <span class="s">&quot;</span><span class="se">\x02\x88\x90</span><span class="s">&quot;</span>         <span class="p">},</span> <span class="cm">/* 21 */</span>
	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x02\x88\x90</span><span class="s">&quot;</span><span class="p">,</span>         <span class="s">&quot;</span><span class="se">\x02\x88\x90</span><span class="s">&quot;</span>         <span class="p">},</span> <span class="cm">/* 22 */</span>
	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x02\x88\x90</span><span class="s">&quot;</span><span class="p">,</span>         <span class="s">&quot;</span><span class="se">\x02\x88\x90</span><span class="s">&quot;</span>         <span class="p">},</span> <span class="cm">/* 23 */</span>
	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x02\x88\x90</span><span class="s">&quot;</span><span class="p">,</span>         <span class="s">&quot;</span><span class="se">\x02\x88\x90</span><span class="s">&quot;</span>         <span class="p">},</span> <span class="cm">/* 24 */</span>
	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x02\x88\x90</span><span class="s">&quot;</span><span class="p">,</span>         <span class="s">&quot;</span><span class="se">\x02\x88\x90</span><span class="s">&quot;</span>         <span class="p">},</span> <span class="cm">/* 25 */</span>
	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x03\x91\x90\xa5</span><span class="s">&quot;</span><span class="p">,</span>     <span class="s">&quot;</span><span class="se">\x03\x91\x90\xa5</span><span class="s">&quot;</span>     <span class="p">},</span> <span class="cm">/* 26 */</span>
	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x03\x91\x90\xa5</span><span class="s">&quot;</span><span class="p">,</span>     <span class="s">&quot;</span><span class="se">\x03\x91\x90\xa5</span><span class="s">&quot;</span>     <span class="p">},</span> <span class="cm">/* 27 */</span>
	<span class="p">{</span> <span class="s">&quot;</span><span class="se">\x02\x88\x90</span><span class="s">&quot;</span><span class="p">,</span>         <span class="s">&quot;</span><span class="se">\x02\x88\x90</span><span class="s">&quot;</span>         <span class="p">}</span>  <span class="cm">/* 28 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">byte</span> <span class="o">*</span><span class="n">cip_hlc</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span>                           <span class="cm">/* 0 */</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span>                           <span class="cm">/* 1 */</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span>                           <span class="cm">/* 2 */</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span>                           <span class="cm">/* 3 */</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span>                           <span class="cm">/* 4 */</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span>                           <span class="cm">/* 5 */</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span>                           <span class="cm">/* 6 */</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span>                           <span class="cm">/* 7 */</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span>                           <span class="cm">/* 8 */</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span>                           <span class="cm">/* 9 */</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span>                           <span class="cm">/* 10 */</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span>                           <span class="cm">/* 11 */</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span>                           <span class="cm">/* 12 */</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span>                           <span class="cm">/* 13 */</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span>                           <span class="cm">/* 14 */</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span>                           <span class="cm">/* 15 */</span>

	<span class="s">&quot;</span><span class="se">\x02\x91\x81</span><span class="s">&quot;</span><span class="p">,</span>               <span class="cm">/* 16 */</span>
	<span class="s">&quot;</span><span class="se">\x02\x91\x84</span><span class="s">&quot;</span><span class="p">,</span>               <span class="cm">/* 17 */</span>
	<span class="s">&quot;</span><span class="se">\x02\x91\xa1</span><span class="s">&quot;</span><span class="p">,</span>               <span class="cm">/* 18 */</span>
	<span class="s">&quot;</span><span class="se">\x02\x91\xa4</span><span class="s">&quot;</span><span class="p">,</span>               <span class="cm">/* 19 */</span>
	<span class="s">&quot;</span><span class="se">\x02\x91\xa8</span><span class="s">&quot;</span><span class="p">,</span>               <span class="cm">/* 20 */</span>
	<span class="s">&quot;</span><span class="se">\x02\x91\xb1</span><span class="s">&quot;</span><span class="p">,</span>               <span class="cm">/* 21 */</span>
	<span class="s">&quot;</span><span class="se">\x02\x91\xb2</span><span class="s">&quot;</span><span class="p">,</span>               <span class="cm">/* 22 */</span>
	<span class="s">&quot;</span><span class="se">\x02\x91\xb5</span><span class="s">&quot;</span><span class="p">,</span>               <span class="cm">/* 23 */</span>
	<span class="s">&quot;</span><span class="se">\x02\x91\xb8</span><span class="s">&quot;</span><span class="p">,</span>               <span class="cm">/* 24 */</span>
	<span class="s">&quot;</span><span class="se">\x02\x91\xc1</span><span class="s">&quot;</span><span class="p">,</span>               <span class="cm">/* 25 */</span>
	<span class="s">&quot;</span><span class="se">\x02\x91\x81</span><span class="s">&quot;</span><span class="p">,</span>               <span class="cm">/* 26 */</span>
	<span class="s">&quot;</span><span class="se">\x03\x91\xe0\x01</span><span class="s">&quot;</span><span class="p">,</span>           <span class="cm">/* 27 */</span>
	<span class="s">&quot;</span><span class="se">\x03\x91\xe0\x02</span><span class="s">&quot;</span>            <span class="cm">/* 28 */</span>
<span class="p">};</span>

<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="cp">#define V120_HEADER_LENGTH 1</span>
<span class="cp">#define V120_HEADER_EXTEND_BIT  0x80</span>
<span class="cp">#define V120_HEADER_BREAK_BIT   0x40</span>
<span class="cp">#define V120_HEADER_C1_BIT      0x04</span>
<span class="cp">#define V120_HEADER_C2_BIT      0x08</span>
<span class="cp">#define V120_HEADER_FLUSH_COND  (V120_HEADER_BREAK_BIT | V120_HEADER_C1_BIT | V120_HEADER_C2_BIT)</span>

<span class="k">static</span> <span class="n">byte</span> <span class="n">v120_default_header</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>

	<span class="mh">0x83</span>                          <span class="cm">/*  Ext, BR , res, res, C2 , C1 , B  , F   */</span>

<span class="p">};</span>

<span class="k">static</span> <span class="n">byte</span> <span class="n">v120_break_header</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>

	<span class="mh">0xc3</span> <span class="o">|</span> <span class="n">V120_HEADER_BREAK_BIT</span>  <span class="cm">/*  Ext, BR , res, res, C2 , C1 , B  , F   */</span>

<span class="p">};</span>


<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* API_PUT function                                                 */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="n">word</span> <span class="nf">api_put</span><span class="p">(</span><span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">CAPI_MSG</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">controller</span><span class="p">;</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">;</span>
	<span class="n">NCCI</span> <span class="o">*</span><span class="n">ncci_ptr</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">ncci</span><span class="p">;</span>
	<span class="n">CAPI_MSG</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="n">msg_parms</span><span class="p">[</span><span class="n">MAX_MSG_PARMS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">MAX_MSG_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;bad len&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">_BAD_MSG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">controller</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)((</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">controller</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* controller starts with 0 up to (max_adapter - 1) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">controller</span> <span class="o">&gt;=</span> <span class="n">max_adapter</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;invalid ctrl&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">_BAD_MSG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="p">[</span><span class="n">controller</span><span class="p">];</span>
	<span class="n">plci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">plci</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">plci</span> <span class="o">&lt;=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">max_plci</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_disabled</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;plci=%x&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">plci</span><span class="p">));</span>
		<span class="n">plci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">plci</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">ncci</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">ncci</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_CON_PENDING</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_CON_ALERT</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="p">(</span><span class="n">_DISCONNECT_I</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">)))</span>
		    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">ncci</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="p">(</span><span class="n">_DISCONNECT_B3_I</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">))</span>
			<span class="o">||</span> <span class="p">((</span><span class="n">ncci</span> <span class="o">&lt;</span> <span class="n">MAX_NCCI</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_plci</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">))))</span>
		<span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_read_pos</span><span class="p">;</span>
			<span class="n">j</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_write_pos</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">i</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="n">MSG_IN_OVERHEAD</span> <span class="o">&lt;=</span> <span class="n">MSG_IN_QUEUE_SIZE</span><span class="p">)</span>
					<span class="n">i</span> <span class="o">+=</span> <span class="n">MSG_IN_QUEUE_SIZE</span> <span class="o">-</span> <span class="n">j</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>

				<span class="n">n</span> <span class="o">=</span> <span class="p">(((</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="n">MSG_IN_OVERHEAD</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">MSG_IN_QUEUE_SIZE</span> <span class="o">-</span> <span class="n">n</span><span class="p">)</span>
					<span class="n">i</span> <span class="o">=</span> <span class="n">MSG_IN_QUEUE_SIZE</span> <span class="o">-</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">i</span> <span class="o">-=</span> <span class="n">j</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="p">((</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="n">MSG_IN_OVERHEAD</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">))</span>

			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Q-FULL1(msg) - len=%d write=%d read=%d wrap=%d free=%d&quot;</span><span class="p">,</span>
						<span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_write_pos</span><span class="p">,</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_read_pos</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_wrap_pos</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>

				<span class="k">return</span> <span class="n">_QUEUE_FULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">c</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">)))</span>
			    <span class="o">||</span> <span class="p">(((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">))</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">)))</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_write_pos</span> <span class="o">!=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_read_pos</span><span class="p">)</span>
					<span class="n">c</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">_DATA_B3_R</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;DATA_B3 REQ wrong length %d&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span><span class="p">));</span>
					<span class="k">return</span> <span class="n">_BAD_MSG</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">ncci_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci</span><span class="p">[</span><span class="n">ncci</span><span class="p">]);</span>
				<span class="n">n</span> <span class="o">=</span> <span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_pending</span><span class="p">;</span>
				<span class="n">l</span> <span class="o">=</span> <span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_ack_pending</span><span class="p">;</span>
				<span class="n">k</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_read_pos</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">k</span> <span class="o">!=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_write_pos</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_wrap_pos</span><span class="p">)</span>
						<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((((</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">))[</span><span class="n">k</span><span class="p">]))</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">_DATA_B3_R</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">))[</span><span class="n">k</span><span class="p">]))</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">ncci</span> <span class="o">==</span> <span class="n">ncci</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">n</span><span class="o">++</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(((</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">))[</span><span class="n">k</span><span class="p">]))</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">data_b3_req</span><span class="p">.</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="mh">0x0004</span><span class="p">)</span>
							<span class="n">l</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">k</span> <span class="o">+=</span> <span class="p">(((</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">))[</span><span class="n">k</span><span class="p">]))</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span>
					      <span class="n">MSG_IN_OVERHEAD</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">;</span>

				<span class="p">}</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">MAX_DATA_B3</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;=</span> <span class="n">MAX_DATA_ACK</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Q-FULL2(data) - pending=%d/%d ack_pending=%d/%d&quot;</span><span class="p">,</span>
							<span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_pending</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_ack_pending</span><span class="p">,</span> <span class="n">l</span><span class="p">));</span>

					<span class="k">return</span> <span class="n">_QUEUE_FULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">((((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">)))</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">))</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">)))</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Q-FULL3(requeue)&quot;</span><span class="p">));</span>

						<span class="k">return</span> <span class="n">_QUEUE_FULL</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">c</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
					<span class="n">c</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">command</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">number</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;enqueue msg(0x%04x,0x%x,0x%x) - len=%d write=%d read=%d wrap=%d free=%d&quot;</span><span class="p">,</span>
						<span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">,</span>
						<span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_write_pos</span><span class="p">,</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_read_pos</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_wrap_pos</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_wrap_pos</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_write_pos</span><span class="p">;</span>
				<span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">))[</span><span class="n">j</span><span class="p">]);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">))[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">_DATA_B3_R</span><span class="p">)</span>
				<span class="p">{</span>

					<span class="n">m</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">data_b3_req</span><span class="p">.</span><span class="n">Data</span> <span class="o">=</span> <span class="p">(</span><span class="n">dword</span><span class="p">)(</span><span class="kt">long</span><span class="p">)(</span><span class="n">TransmitBufferSet</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">data_b3_req</span><span class="p">.</span><span class="n">Data</span><span class="p">));</span>

				<span class="p">}</span>

				<span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">;</span>

				<span class="o">*</span><span class="p">((</span><span class="n">APPL</span> <span class="o">**</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">))[</span><span class="n">j</span><span class="p">]))</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_write_pos</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="n">MSG_IN_OVERHEAD</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">plci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;com=%x&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">command</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_MSG_PARMS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="n">msg_parms</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">_BAD_MSG</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ftable</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ftable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">command</span> <span class="o">==</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* break loop if the message is correct, otherwise continue scan  */</span>
			<span class="cm">/* (for example: CONNECT_B3_T90_ACT_RES has two specifications)   */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">api_parse</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="mi">12</span><span class="p">),</span> <span class="n">ftable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">format</span><span class="p">,</span> <span class="n">msg_parms</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_MSG_PARMS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="n">msg_parms</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;BAD_MSG&quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="p">)</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">c</span> <span class="o">=</span> <span class="n">ftable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">function</span><span class="p">(</span><span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">controller</span><span class="p">),</span>
			       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">number</span><span class="p">,</span>
			       <span class="n">a</span><span class="p">,</span>
			       <span class="n">plci</span><span class="p">,</span>
			       <span class="n">appl</span><span class="p">,</span>
			       <span class="n">msg_parms</span><span class="p">);</span>

	<span class="n">channel_xmit_extended_xon</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="p">)</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in_start</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="p">)</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* api_parse function, check the format of api messages             */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">word</span> <span class="nf">api_parse</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">word</span> <span class="n">length</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">parms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">format</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parms</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="n">p</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">format</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;b&#39;</span>:
			<span class="n">p</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;w&#39;</span>:
			<span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
			<span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
				<span class="n">p</span> <span class="o">+=</span> <span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">p</span><span class="p">];</span>
				<span class="n">p</span> <span class="o">+=</span> <span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parms</span><span class="p">)</span> <span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">api_save_msg</span><span class="p">(</span><span class="n">API_PARSE</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="n">API_SAVE</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">out</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">format</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">format</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;b&#39;</span>:
			<span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;w&#39;</span>:
			<span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
			<span class="n">n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
			<span class="n">n</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">api_load_msg</span><span class="p">(</span><span class="n">API_SAVE</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span>
	<span class="p">{</span>
		<span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="p">;</span>
		<span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* CAPI remove function                                             */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="n">word</span> <span class="nf">api_remove_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">remove_started</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">remove_started</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_adapter</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_plci</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">plci</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span> <span class="n">plci_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">plci</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_adapter</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_plci</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">plci</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">api_remove_complete</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* internal command queue                                           */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_internal_command_queue</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;%s,%d: init_internal_command_queue&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_INTERNAL_COMMAND_LEVELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_internal_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">t_std_internal_command</span> <span class="n">command_function</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: start_internal_command&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">command_function</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">command_function</span><span class="p">)(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">OK</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">command_function</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">next_internal_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: next_internal_command&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command_queue</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_INTERNAL_COMMAND_LEVELS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command_queue</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command_queue</span><span class="p">[</span><span class="n">MAX_INTERNAL_COMMAND_LEVELS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]))(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">OK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* NCCI allocate/remove function                                    */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">dword</span> <span class="n">ncci_mapping_bug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="n">word</span> <span class="nf">get_ncci</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">ch</span><span class="p">,</span> <span class="n">word</span> <span class="n">force_ncci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">ncci</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch</span> <span class="o">||</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_ncci</span><span class="p">[</span><span class="n">ch</span><span class="p">])</span>
	<span class="p">{</span>
		<span class="n">ncci_mapping_bug</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;NCCI mapping exists %ld %02x %02x %02x-%02x&quot;</span><span class="p">,</span>
				<span class="n">ncci_mapping_bug</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">force_ncci</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_ncci</span><span class="p">[</span><span class="n">ch</span><span class="p">]],</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_ncci</span><span class="p">[</span><span class="n">ch</span><span class="p">]));</span>
		<span class="n">ncci</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">force_ncci</span><span class="p">)</span>
			<span class="n">ncci</span> <span class="o">=</span> <span class="n">force_ncci</span><span class="p">;</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ch</span> <span class="o">&lt;</span> <span class="n">MAX_NCCI</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">ch</span><span class="p">])</span>
				<span class="n">ncci</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">ncci</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">((</span><span class="n">ncci</span> <span class="o">&lt;</span> <span class="n">MAX_NCCI</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">ncci</span><span class="p">])</span>
					<span class="n">ncci</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ncci</span> <span class="o">==</span> <span class="n">MAX_NCCI</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">ncci_mapping_bug</span><span class="o">++</span><span class="p">;</span>
					<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">do</span>
					<span class="p">{</span>
						<span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="k">while</span> <span class="p">((</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_NCCI</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="n">i</span><span class="p">))</span>
							<span class="n">j</span><span class="o">++</span><span class="p">;</span>
						<span class="n">k</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_NCCI</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="k">do</span>
							<span class="p">{</span>
								<span class="n">j</span><span class="o">++</span><span class="p">;</span>
							<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_NCCI</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="n">i</span><span class="p">));</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NL_CHANNEL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_NCCI</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NL_CHANNEL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;NCCI mapping overflow %ld %02x %02x %02x-%02x-%02x&quot;</span><span class="p">,</span>
								<span class="n">ncci_mapping_bug</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">force_ncci</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;NCCI mapping overflow %ld %02x %02x&quot;</span><span class="p">,</span>
								<span class="n">ncci_mapping_bug</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">force_ncci</span><span class="p">));</span>
					<span class="p">}</span>
					<span class="n">ncci</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_plci</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncci_ring_list</span><span class="p">)</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncci_ring_list</span> <span class="o">=</span> <span class="n">ncci</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_next</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_next</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncci_ring_list</span><span class="p">];</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_next</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncci_ring_list</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">ncci</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_ncci</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">ncci</span><span class="p">;</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;NCCI mapping established %ld %02x %02x %02x-%02x&quot;</span><span class="p">,</span>
				<span class="n">ncci_mapping_bug</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">force_ncci</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ncci</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ncci</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ncci_free_receive_buffers</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">word</span> <span class="n">ncci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">ncci_code</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">Id</span><span class="p">;</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">Id</span> <span class="o">=</span> <span class="p">(((</span><span class="n">dword</span><span class="p">)</span> <span class="n">ncci</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">word</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ncci</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_plci</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">ncci_mapping_bug</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;NCCI mapping appl expected %ld %08lx&quot;</span><span class="p">,</span>
						<span class="n">ncci_mapping_bug</span><span class="p">,</span> <span class="n">Id</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">appl</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">;</span>
				<span class="n">ncci_code</span> <span class="o">=</span> <span class="n">ncci</span> <span class="o">|</span> <span class="p">(((</span><span class="n">word</span><span class="p">)</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">appl</span><span class="o">-&gt;</span><span class="n">MaxBuffer</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">DataNCCI</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">ncci_code</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">byte</span><span class="p">)(</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">DataFlags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">appl</span><span class="o">-&gt;</span><span class="n">DataNCCI</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ncci</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ncci</span> <span class="o">&lt;</span> <span class="n">MAX_NCCI</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ncci</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_plci</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">ncci_mapping_bug</span><span class="o">++</span><span class="p">;</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;NCCI mapping no appl %ld %08lx&quot;</span><span class="p">,</span>
							<span class="n">ncci_mapping_bug</span><span class="p">,</span> <span class="n">Id</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">appl</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">;</span>
					<span class="n">ncci_code</span> <span class="o">=</span> <span class="n">ncci</span> <span class="o">|</span> <span class="p">(((</span><span class="n">word</span><span class="p">)</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">appl</span><span class="o">-&gt;</span><span class="n">MaxBuffer</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">DataNCCI</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">ncci_code</span><span class="p">)</span>
						    <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">byte</span><span class="p">)(</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">DataFlags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">))</span>
						<span class="p">{</span>
							<span class="n">appl</span><span class="o">-&gt;</span><span class="n">DataNCCI</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">cleanup_ncci_data</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">word</span> <span class="n">ncci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NCCI</span> <span class="o">*</span><span class="n">ncci_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ncci</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ncci_plci</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">ncci_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ncci</span><span class="p">[</span><span class="n">ncci</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_pending</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">data_sent</span> <span class="o">||</span> <span class="p">(</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">DBuffer</span><span class="p">[</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_out</span><span class="p">].</span><span class="n">P</span> <span class="o">!=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">data_sent_ptr</span><span class="p">))</span>
					<span class="n">TransmitBufferFree</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">DBuffer</span><span class="p">[</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_out</span><span class="p">].</span><span class="n">P</span><span class="p">);</span>
				<span class="p">(</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_out</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_out</span> <span class="o">==</span> <span class="n">MAX_DATA_B3</span><span class="p">)</span>
					<span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">(</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_pending</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_ack_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_ack_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ncci_remove</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">word</span> <span class="n">ncci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">preserve_ncci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">Id</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">Id</span> <span class="o">=</span> <span class="p">(((</span><span class="n">dword</span><span class="p">)</span> <span class="n">ncci</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">word</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">preserve_ncci</span><span class="p">)</span>
		<span class="n">ncci_free_receive_buffers</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ncci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ncci</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_plci</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">!=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ncci_mapping_bug</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;NCCI mapping doesn&#39;t exist %ld %08lx %02x&quot;</span><span class="p">,</span>
					<span class="n">ncci_mapping_bug</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">preserve_ncci</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">cleanup_ncci_data</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ncci</span><span class="p">);</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;NCCI mapping released %ld %08lx %02x %02x-%02x&quot;</span><span class="p">,</span>
					<span class="n">ncci_mapping_bug</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">preserve_ncci</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">ncci</span><span class="p">],</span> <span class="n">ncci</span><span class="p">));</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_ncci</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">ncci</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">preserve_ncci</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_plci</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncci_ring_list</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_next</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncci_ring_list</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_next</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ncci</span><span class="p">))</span>
					<span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_next</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_next</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">ncci</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ncci</span><span class="p">)</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncci_ring_list</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncci_ring_list</span> <span class="o">==</span> <span class="n">ncci</span><span class="p">)</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncci_ring_list</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_next</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_next</span><span class="p">[</span><span class="n">ncci</span><span class="p">];</span>
				<span class="p">}</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_next</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ncci</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ncci</span> <span class="o">&lt;</span> <span class="n">MAX_NCCI</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ncci</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_plci</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">cleanup_ncci_data</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ncci</span><span class="p">);</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;NCCI mapping released %ld %08lx %02x %02x-%02x&quot;</span><span class="p">,</span>
						<span class="n">ncci_mapping_bug</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">preserve_ncci</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">ncci</span><span class="p">],</span> <span class="n">ncci</span><span class="p">));</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_ncci</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">ncci</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">preserve_ncci</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_plci</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_next</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">preserve_ncci</span><span class="p">)</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncci_ring_list</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* PLCI remove function                                             */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">plci_free_msg_in_queue</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_read_pos</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_write_pos</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_wrap_pos</span><span class="p">)</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">))[</span><span class="n">i</span><span class="p">]))</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">_DATA_B3_R</span><span class="p">)</span>
			<span class="p">{</span>

				<span class="n">TransmitBufferFree</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span>
						   <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)(((</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">))[</span><span class="n">i</span><span class="p">]))</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">data_b3_req</span><span class="p">.</span><span class="n">Data</span><span class="p">));</span>

			<span class="p">}</span>

			<span class="n">i</span> <span class="o">+=</span> <span class="p">(((</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">))[</span><span class="n">i</span><span class="p">]))</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span>
			      <span class="n">MSG_IN_OVERHEAD</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_write_pos</span> <span class="o">=</span> <span class="n">MSG_IN_QUEUE_SIZE</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_read_pos</span> <span class="o">=</span> <span class="n">MSG_IN_QUEUE_SIZE</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_wrap_pos</span> <span class="o">=</span> <span class="n">MSG_IN_QUEUE_SIZE</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">plci_remove</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;plci_remove(no plci)&quot;</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">init_internal_command_queue</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;plci_remove(%x,tel=%x)&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci_remove_check</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;D-channel X.25 plci-&gt;NL.Id:%0x&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">REMOVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_remove_id</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span> <span class="o">!=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_req</span><span class="p">)))</span>
		<span class="p">{</span>
			<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">HANGUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ncci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">plci_free_msg_in_queue</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_CON_PENDING</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_CON_ALERT</span><span class="p">))</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">OUTG_DIS_PENDING</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* Application Group function helpers                               */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_group_ind_mask</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">C_IND_MASK_DWORDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">group_optimization_mask_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffffL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_group_ind_mask_bit</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">word</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">group_optimization_mask_table</span><span class="p">[</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">test_group_ind_mask_bit</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">word</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">group_optimization_mask_table</span><span class="p">[</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* c_ind_mask operations for arbitrary MAX_APPL                     */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_c_ind_mask</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">C_IND_MASK_DWORDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">c_ind_mask_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">c_ind_mask_empty</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">C_IND_MASK_DWORDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">c_ind_mask_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">C_IND_MASK_DWORDS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_c_ind_mask_bit</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">word</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">c_ind_mask_table</span><span class="p">[</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_c_ind_mask_bit</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">word</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">c_ind_mask_table</span><span class="p">[</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">test_c_ind_mask_bit</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">word</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">c_ind_mask_table</span><span class="p">[</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_c_ind_mask</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">hex_digit_table</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">{</span><span class="sc">&#39;0&#39;</span><span class="p">,</span> <span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="sc">&#39;4&#39;</span><span class="p">,</span> <span class="sc">&#39;5&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;8&#39;</span><span class="p">,</span> <span class="sc">&#39;9&#39;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">,</span> <span class="sc">&#39;b&#39;</span><span class="p">,</span> <span class="sc">&#39;c&#39;</span><span class="p">,</span> <span class="sc">&#39;d&#39;</span><span class="p">,</span> <span class="sc">&#39;e&#39;</span><span class="p">,</span> <span class="sc">&#39;f&#39;</span><span class="p">};</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">d</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">C_IND_MASK_DWORDS</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">36</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">C_IND_MASK_DWORDS</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">d</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">c_ind_mask_table</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="o">*</span><span class="p">(</span><span class="o">--</span><span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="n">hex_digit_table</span><span class="p">[</span><span class="n">d</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>
					<span class="n">d</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
					<span class="o">*</span><span class="p">(</span><span class="o">--</span><span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="p">(</span><span class="o">--</span><span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;c_ind_mask =%s&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>





<span class="cp">#define dump_plcis(a)</span>



<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* translation function for each message                            */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">connect_req</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			<span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">parms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">LinkLayer</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="o">*</span><span class="n">ai</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="n">ai_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">word</span> <span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">ch_mask</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">m</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">byte</span> <span class="n">esc_chi</span><span class="p">[</span><span class="mi">35</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">};</span>
	<span class="k">static</span> <span class="n">byte</span> <span class="n">lli</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
	<span class="n">byte</span> <span class="n">noCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">p_chi</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">ai_parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;connect_req(%d)&quot;</span><span class="p">,</span> <span class="n">parms</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>
	<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_disabled</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;adapter disabled&quot;</span><span class="p">));</span>
			<span class="n">Id</span> <span class="o">=</span> <span class="p">((</span><span class="n">word</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_DISCONNECT_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">_L1_ERROR</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">Info</span> <span class="o">=</span> <span class="n">_OUT_OF_PLCI</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">get_plci</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
		<span class="p">{</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">plci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">=</span> <span class="n">CALL_DIR_OUT</span> <span class="o">|</span> <span class="n">CALL_DIR_ORIGINATE</span><span class="p">;</span>
			<span class="cm">/* check &#39;external controller&#39; bit for codec support */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Id</span> <span class="o">&amp;</span> <span class="n">EXT_CONTROLLER</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">AdvCodecSupport</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">appl</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">ai</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
			<span class="n">bp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span><span class="n">LinkLayer</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="k">else</span> <span class="n">LinkLayer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">ch</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;ssss&quot;</span><span class="p">,</span> <span class="n">ai_parms</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ai_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">ch</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">ai_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* safety -&gt; ignore ChannelID */</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="cm">/* explizit CHI in message */</span>
						<span class="p">{</span>
							<span class="cm">/* check length of B-CH struct */</span>
							<span class="k">if</span> <span class="p">((</span><span class="n">ai_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
							<span class="p">{</span>
								<span class="k">if</span> <span class="p">((</span><span class="n">ai_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">CHI</span><span class="p">)</span>
								<span class="p">{</span>
									<span class="n">p_chi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">ai_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)[</span><span class="mi">5</span><span class="p">]);</span>
								<span class="p">}</span>
								<span class="k">else</span>
								<span class="p">{</span>
									<span class="n">p_chi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">ai_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)[</span><span class="mi">3</span><span class="p">]);</span>
								<span class="p">}</span>
								<span class="k">if</span> <span class="p">(</span><span class="n">p_chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">35</span><span class="p">)</span> <span class="cm">/* check length of channel ID */</span>
								<span class="p">{</span>
									<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
								<span class="p">}</span>
							<span class="p">}</span>
							<span class="k">else</span> <span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
						<span class="p">}</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">ai_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="n">ai_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">36</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="n">dir</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">ai_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
							<span class="n">ch_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="n">m</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
							<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">&lt;=</span> <span class="n">ai_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
							<span class="p">{</span>
								<span class="k">if</span> <span class="p">(</span><span class="n">ai_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
								<span class="p">{</span>
									<span class="k">if</span> <span class="p">((</span><span class="n">ai_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">|</span> <span class="n">m</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
										<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
									<span class="k">else</span>
									<span class="p">{</span>
										<span class="k">if</span> <span class="p">(</span><span class="n">ch_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
											<span class="n">channel</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
										<span class="n">ch_mask</span> <span class="o">|=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
									<span class="p">}</span>
								<span class="p">}</span>
								<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">ch_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
								<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Info</span><span class="p">)</span>
							<span class="p">{</span>
								<span class="k">if</span> <span class="p">((</span><span class="n">ai_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">==</span> <span class="mi">36</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ch_mask</span> <span class="o">!=</span> <span class="p">((</span><span class="n">dword</span><span class="p">)(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="p">))))</span>
								<span class="p">{</span>
									<span class="n">esc_chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">ai_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
									<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">&lt;=</span> <span class="n">ai_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
										<span class="n">esc_chi</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ai_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">];</span>
								<span class="p">}</span>
								<span class="k">else</span>
									<span class="n">esc_chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
								<span class="n">esc_chi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">channel</span><span class="p">;</span>
								<span class="n">plci</span><span class="o">-&gt;</span><span class="n">b_channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">channel</span><span class="p">;</span> <span class="cm">/* not correct for ETSI ch 17..31 */</span>
								<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LLI</span><span class="p">,</span> <span class="n">lli</span><span class="p">);</span>
								<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ESC</span><span class="p">,</span> <span class="n">esc_chi</span><span class="p">);</span>
								<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">LOCAL_CONNECT</span><span class="p">;</span>
								<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span><span class="p">)</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">|=</span> <span class="n">CALL_DIR_FORCE_OUTG_NL</span><span class="p">;</span>     <span class="cm">/* dir 0=DTE, 1=DCE */</span>
							<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">else</span>  <span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;ch=%x,dir=%x,p_ch=%d&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">channel</span><span class="p">));</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">_CONNECT_R</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">Number</span><span class="p">;</span>
			<span class="cm">/* x.31 or D-ch free SAPI in LinkLayer? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">LinkLayer</span> <span class="o">!=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">LinkLayer</span> <span class="o">!=</span> <span class="mi">12</span><span class="p">)</span> <span class="n">noCh</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ch</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">noCh</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Info</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="cm">/* B-channel used for B3 connections (ch==0), or no B channel    */</span>
				<span class="cm">/* is used (ch==2) or perm. connection (3) is used  do a CALL    */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">noCh</span><span class="p">)</span> <span class="n">Info</span> <span class="o">=</span> <span class="n">add_b1</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>    <span class="cm">/* no resource    */</span>
				<span class="k">else</span>     <span class="n">Info</span> <span class="o">=</span> <span class="n">add_b1</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">add_s</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">OAD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
				<span class="n">add_s</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">OSA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
				<span class="n">add_s</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
				<span class="n">add_s</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
				<span class="n">add_s</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">HLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Info_Mask</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="cm">/* early B3 connect (CIP mask bit 9) no release after a disc */</span>
					<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LLI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x01</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">29</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="n">cip_bc</span><span class="p">[</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)][</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">u_law</span><span class="p">]);</span>
					<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">HLC</span><span class="p">,</span> <span class="n">cip_hlc</span><span class="p">[</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)]);</span>
				<span class="p">}</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">UID</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x06\x43\x61\x70\x69\x32\x30</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="n">DSIG_ID</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/* D-Channel used for B3 connections */</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Info</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">noCh</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">add_b23</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Info</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adv_nl</span><span class="p">))</span><span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Info</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">noCh</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">spoofed_msg</span> <span class="o">==</span> <span class="n">SPOOFING_REQUIRED</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">api_save_msg</span><span class="p">(</span><span class="n">parms</span><span class="p">,</span> <span class="s">&quot;wsssssssss&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">saved_msg</span><span class="p">);</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">spoofed_msg</span> <span class="o">=</span> <span class="n">CALL_REQ</span><span class="p">;</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">BLOCK_PLCI</span><span class="p">;</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Spoof&quot;</span><span class="p">));</span>
						<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
						<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span><span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CHI</span><span class="p">,</span> <span class="n">p_chi</span><span class="p">);</span>
					<span class="n">add_s</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CPN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
					<span class="n">add_s</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">DSA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">noCh</span><span class="p">)</span> <span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ESC</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x02\x18\xfd</span><span class="s">&quot;</span><span class="p">);</span>  <span class="cm">/* D-channel, no B-L3 */</span>
					<span class="n">add_ai</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span><span class="p">)</span><span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CALL_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">PERM_LIST_REQ</span><span class="p">;</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
						<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LISTEN_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
						<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
						<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span>
	      <span class="n">_CONNECT_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span>
	      <span class="n">Id</span><span class="p">,</span>
	      <span class="n">Number</span><span class="p">,</span>
	      <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">connect_res</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			<span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">parms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">Info</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">Reject</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">byte</span> <span class="n">cau_t</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">};</span>
	<span class="k">static</span> <span class="n">byte</span> <span class="n">esc_t</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
	<span class="n">API_PARSE</span> <span class="o">*</span><span class="n">ai</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="n">ai_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">word</span> <span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;connect_res(no plci)&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* no plci, no send */</span>
	<span class="p">}</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;connect_res(State=0x%x)&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">ai_parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ai</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;ai-&gt;length=%d&quot;</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;ssss&quot;</span><span class="p">,</span> <span class="n">ai_parms</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;ai_parms[0].length=%d/0x%x&quot;</span><span class="p">,</span> <span class="n">ai_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">ai_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)));</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ai_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">ch</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">ai_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;BCH-I=0x%x&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_CON_CONNECTED_ALERT</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Connected Alert Call_Res&quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Info_Mask</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="cm">/* early B3 connect (CIP mask bit 9) no release after a disc */</span>
			<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LLI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x01</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">add_s</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CONN_NR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">add_s</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">add_ai</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">INC_CON_ACCEPT</span><span class="p">;</span>
		<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CALL_RES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_CON_PENDING</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_CON_ALERT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_c_ind_mask_bit</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">dump_c_ind_mask</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
		<span class="n">Reject</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Reject=0x%x&quot;</span><span class="p">,</span> <span class="n">Reject</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Reject</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c_ind_mask_empty</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">Reject</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x3400</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">esc_t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="n">Reject</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
					<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ESC</span><span class="p">,</span> <span class="n">esc_t</span><span class="p">);</span>
					<span class="n">add_ai</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
					<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">REJECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Reject</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">Reject</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">add_ai</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
					<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">HANGUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">esc_t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cau_t</span><span class="p">[(</span><span class="n">Reject</span><span class="o">&amp;</span><span class="mh">0x000f</span><span class="p">)];</span>
					<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ESC</span><span class="p">,</span> <span class="n">esc_t</span><span class="p">);</span>
					<span class="n">add_ai</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
					<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">REJECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_DISCONNECT_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">_OTHER_APPL_CONNECTED</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Id</span> <span class="o">&amp;</span> <span class="n">EXT_CONTROLLER</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">AdvCodecSupport</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">appl</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;connect_res(error from AdvCodecSupport)&quot;</span><span class="p">));</span>
					<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">HANGUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">ADV_VOICE</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvCodecPLCI</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">add_b23</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">Info</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;connect_res(error from add_b23)&quot;</span><span class="p">));</span>
						<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">HANGUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
						<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adv_nl</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">add_b23</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">Info</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;connect_res(error from add_b23 2)&quot;</span><span class="p">));</span>
						<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">HANGUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
						<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">spoofed_msg</span> <span class="o">==</span> <span class="n">SPOOFING_REQUIRED</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">api_save_msg</span><span class="p">(</span><span class="n">parms</span><span class="p">,</span> <span class="s">&quot;wsssss&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">saved_msg</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">spoofed_msg</span> <span class="o">=</span> <span class="n">CALL_RES</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">BLOCK_PLCI</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Spoof&quot;</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">add_b1</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ch</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Info_Mask</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="cm">/* early B3 connect (CIP mask bit 9) no release after a disc */</span>
					<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LLI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x01</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">add_s</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CONN_NR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
				<span class="n">add_s</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
				<span class="n">add_ai</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">INC_CON_ACCEPT</span><span class="p">;</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CALL_RES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_appl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_c_ind_mask_bit</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">sendf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_DISCONNECT_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">_OTHER_APPL_CONNECTED</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">connect_a_res</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			  <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;connect_a_res&quot;</span><span class="p">));</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">disconnect_req</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			   <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;disconnect_req&quot;</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_CON_PENDING</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_CON_ALERT</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">clear_c_ind_mask_bit</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_appl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_c_ind_mask_bit</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
					<span class="n">sendf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_DISCONNECT_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">OUTG_DIS_PENDING</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">!=</span> <span class="n">INC_DIS_PENDING</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">add_ai</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
					<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">HANGUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">OUTG_DIS_PENDING</span><span class="p">;</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">mixer_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
					<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">REMOVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_DISCONNECT_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_DISCONNECT_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">INC_DIS_PENDING</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">appl</span><span class="p">)</span>  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_DISCONNECT_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">disconnect_res</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			   <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;disconnect_res&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/* clear ind mask bit, just in case of collsion of          */</span>
		<span class="cm">/* DISCONNECT_IND and CONNECT_RES                           */</span>
		<span class="n">clear_c_ind_mask_bit</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">ncci_free_receive_buffers</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci_remove_check</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_DIS_PENDING</span>
		    <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">SUSPENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c_ind_mask_empty</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">!=</span> <span class="n">SUSPENDING</span><span class="p">)</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;chs=%d&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">listen_req</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
		       <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">parms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;listen_req(Appl=0x%x)&quot;</span><span class="p">,</span> <span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">Info_Mask</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">CIP_Mask</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;CIP_MASK=0x%lx&quot;</span><span class="p">,</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Info_Mask</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* early B3 connect provides */</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">Info_Mask</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">|=</span>  <span class="mh">0x10</span><span class="p">;</span>   <span class="cm">/* call progression infos    */</span>
		<span class="p">}</span>

		<span class="cm">/* check if external controller listen and switch listen on or off*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Id</span><span class="o">&amp;</span><span class="n">EXT_CONTROLLER</span> <span class="o">&amp;&amp;</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span> <span class="o">&amp;</span> <span class="n">ON_BOARD_CODEC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dummy_plci</span><span class="p">.</span><span class="n">State</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">codec_listen</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dummy_plci</span><span class="p">;</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">TelOAD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">22</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">TelOAD</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="p">}</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">TelOAD</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">TelOSA</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">22</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">TelOSA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="p">}</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">TelOSA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="n">Info</span> <span class="o">=</span> <span class="mh">0x2002</span><span class="p">;</span> <span class="cm">/* wrong controller, codec not supported */</span>
		<span class="p">}</span>
		<span class="k">else</span><span class="p">{</span>               <span class="cm">/* clear listen */</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">codec_listen</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span>
	      <span class="n">_LISTEN_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span>
	      <span class="n">Id</span><span class="p">,</span>
	      <span class="n">Number</span><span class="p">,</span>
	      <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="n">listen_check</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">info_req</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
		     <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="o">*</span><span class="n">ai</span><span class="p">;</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">rc_plci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="n">ai_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">word</span> <span class="n">Info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;info_req&quot;</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">ai_parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ai</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;ssss&quot;</span><span class="p">,</span> <span class="n">ai_parms</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;AddInfo wrong&quot;</span><span class="p">));</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="p">)</span> <span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Info</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="p">)</span>
	<span class="p">{</span>                <span class="cm">/* no fac, with CPN, or KEY */</span>
		<span class="n">rc_plci</span> <span class="o">=</span> <span class="n">plci</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ai_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">||</span> <span class="n">ai_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="cm">/* overlap sending option */</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;OvlSnd&quot;</span><span class="p">));</span>
			<span class="n">add_s</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CPN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">add_s</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">INFO_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">&amp;&amp;</span> <span class="n">ai_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">length</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="cm">/* User_Info option */</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;UUI&quot;</span><span class="p">));</span>
			<span class="n">add_s</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">UUI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">USER_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">&amp;&amp;</span> <span class="n">ai_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">length</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="cm">/* Facility option */</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;FAC&quot;</span><span class="p">));</span>
			<span class="n">add_s</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CPN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">add_ai</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">FACILITY_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ai_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span> <span class="o">||</span> <span class="n">ai_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">length</span> <span class="o">||</span> <span class="n">ai_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">length</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Info</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/* NCR_Facility option -&gt; send UUI and Keypad too */</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;NCR_FAC&quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">get_plci</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
		<span class="p">{</span>
			<span class="n">rc_plci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
			<span class="n">appl</span><span class="o">-&gt;</span><span class="n">NullCREnable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">rc_plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">C_NCR_FAC_REQ</span><span class="p">;</span>
			<span class="n">rc_plci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
			<span class="n">add_p</span><span class="p">(</span><span class="n">rc_plci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x80</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">add_p</span><span class="p">(</span><span class="n">rc_plci</span><span class="p">,</span> <span class="n">UID</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x06\x43\x61\x70\x69\x32\x30</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sig_req</span><span class="p">(</span><span class="n">rc_plci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="n">DSIG_ID</span><span class="p">);</span>
			<span class="n">send_req</span><span class="p">(</span><span class="n">rc_plci</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="n">_OUT_OF_PLCI</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Info</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">add_s</span><span class="p">(</span><span class="n">rc_plci</span><span class="p">,</span> <span class="n">CPN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">add_ai</span><span class="p">(</span><span class="n">rc_plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">sig_req</span><span class="p">(</span><span class="n">rc_plci</span><span class="p">,</span> <span class="n">NCR_FACILITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">send_req</span><span class="p">(</span><span class="n">rc_plci</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="cm">/* for application controlled supplementary services    */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc_plci</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Info</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">send_req</span><span class="p">(</span><span class="n">rc_plci</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>  <span class="cm">/* appl is not assigned to a PLCI or error condition */</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;localInfoCon&quot;</span><span class="p">));</span>
		<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span>
		      <span class="n">_INFO_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span>
		      <span class="n">Id</span><span class="p">,</span>
		      <span class="n">Number</span><span class="p">,</span>
		      <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">info_res</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
		     <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;info_res&quot;</span><span class="p">));</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">alert_req</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
		      <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;alert_req&quot;</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Info</span> <span class="o">=</span> <span class="n">_ALERT_IGNORED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">!=</span> <span class="n">INC_CON_ALERT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_CON_PENDING</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">INC_CON_ALERT</span><span class="p">;</span>
				<span class="n">add_ai</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CALL_ALERT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span>
	      <span class="n">_ALERT_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span>
	      <span class="n">Id</span><span class="p">,</span>
	      <span class="n">Number</span><span class="p">,</span>
	      <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">facility_req</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			 <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">Info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">word</span> <span class="n">selector</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">SSreq</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">relatedPLCIvalue</span><span class="p">;</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">relatedadapter</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">SSparms</span>  <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">RCparms</span><span class="p">[]</span>  <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x05\x00\x00\x02\x00\x00</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">SSstruct</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x09\x00\x00\x06\x00\x00\x00\x00\x00\x00</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="o">*</span><span class="n">parms</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="n">ss_parms</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">rplci</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">cai</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
	<span class="n">dword</span> <span class="n">d</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="n">dummy</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;facility_req&quot;</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">ss_parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">parms</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;wrong Ctrl&quot;</span><span class="p">));</span>
		<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">selector</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Info</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">selector</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">SELECTOR_HANDSET</span>:
			<span class="n">Info</span> <span class="o">=</span> <span class="n">AdvCodecSupport</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">appl</span><span class="p">,</span> <span class="n">HOOK_SUPPORT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SELECTOR_SU_SERV</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">SSreq</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
			<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RCparms</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">SSreq</span><span class="p">);</span>
			<span class="n">SSparms</span> <span class="o">=</span> <span class="n">RCparms</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">SSreq</span><span class="p">)</span>
			<span class="p">{</span>
			<span class="k">case</span> <span class="n">S_GET_SUPPORTED_SERVICES</span>:
				<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">get_plci</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
				<span class="p">{</span>
					<span class="n">rplci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
					<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
					<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x80</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">UID</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x06\x43\x61\x70\x69\x32\x30</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">sig_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="n">DSIG_ID</span><span class="p">);</span>
					<span class="n">send_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SSstruct</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">MASK_TERMINAL_PORTABILITY</span><span class="p">);</span>
					<span class="n">SSparms</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">SSstruct</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">GETSERV_REQ_PEND</span><span class="p">;</span>
				<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">Number</span><span class="p">;</span>
				<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">S_SUPPORTED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">S_LISTEN</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wbd&quot;</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;format wrong&quot;</span><span class="p">));</span>
						<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">Notification_Mask</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Notification_Mask</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SMASK_MWI</span><span class="p">)</span> <span class="cm">/* MWI active? */</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">get_plci</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
					<span class="p">{</span>
						<span class="n">rplci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
						<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x80</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">UID</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x06\x43\x61\x70\x69\x32\x30</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">sig_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="n">DSIG_ID</span><span class="p">);</span>
						<span class="n">send_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">GET_MWI_STATE</span><span class="p">;</span>
					<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">Number</span><span class="p">;</span>
					<span class="n">sig_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">MWI_POLL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">send_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">S_HOLD</span>:
				<span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">==</span> <span class="n">IDLE</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">=</span> <span class="n">HOLD_REQUEST</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">C_HOLD_REQ</span><span class="p">;</span>
					<span class="n">add_s</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
					<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CALL_HOLD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
					<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="n">Info</span> <span class="o">=</span> <span class="mh">0x3010</span><span class="p">;</span>                    <span class="cm">/* wrong state           */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">S_RETRIEVE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">==</span> <span class="n">CALL_HELD</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">Id</span> <span class="o">&amp;</span> <span class="n">EXT_CONTROLLER</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">AdvCodecSupport</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">appl</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
						<span class="p">{</span>
							<span class="n">Info</span> <span class="o">=</span> <span class="mh">0x3010</span><span class="p">;</span>                    <span class="cm">/* wrong state           */</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="k">else</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">=</span> <span class="n">RETRIEVE_REQUEST</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">C_RETRIEVE_REQ</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">spoofed_msg</span> <span class="o">==</span> <span class="n">SPOOFING_REQUIRED</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">spoofed_msg</span> <span class="o">=</span> <span class="n">CALL_RETRIEVE</span><span class="p">;</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">BLOCK_PLCI</span><span class="p">;</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Spoof&quot;</span><span class="p">));</span>
						<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CALL_RETRIEVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
						<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
						<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="n">Info</span> <span class="o">=</span> <span class="mh">0x3010</span><span class="p">;</span>                    <span class="cm">/* wrong state           */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">S_SUSPEND</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wbs&quot;</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;format wrong&quot;</span><span class="p">));</span>
						<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">add_s</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">SUSPEND_REQ</span><span class="p">;</span>
					<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">SUSPEND</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">SUSPENDING</span><span class="p">;</span>
					<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="n">Info</span> <span class="o">=</span> <span class="mh">0x3010</span><span class="p">;</span>                    <span class="cm">/* wrong state           */</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">S_RESUME</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">get_plci</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
				<span class="p">{</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_OUT_OF_PLCI</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">rplci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
				<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
				<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">Number</span><span class="p">;</span>
				<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">=</span> <span class="n">CALL_DIR_OUT</span> <span class="o">|</span> <span class="n">CALL_DIR_ORIGINATE</span><span class="p">;</span>
				<span class="cm">/* check &#39;external controller&#39; bit for codec support */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Id</span> <span class="o">&amp;</span> <span class="n">EXT_CONTROLLER</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">AdvCodecSupport</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">rplci</span><span class="p">,</span> <span class="n">appl</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">Info</span> <span class="o">=</span> <span class="mh">0x300A</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wbs&quot;</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;format wrong&quot;</span><span class="p">));</span>
						<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">dummy</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">dummy</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x00</span><span class="s">&quot;</span><span class="p">;</span>
				<span class="n">add_b1</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Info_Mask</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="cm">/* early B3 connect (CIP mask bit 9) no release after a disc */</span>
					<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">LLI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x01</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">UID</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x06\x43\x61\x70\x69\x32\x30</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="n">DSIG_ID</span><span class="p">);</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">);</span>
				<span class="n">add_s</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
				<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">RESUME_REQ</span><span class="p">;</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">RESUME</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">RESUMING</span><span class="p">;</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">S_CONF_BEGIN</span>: <span class="cm">/* Request */</span>
			<span class="k">case</span> <span class="n">S_CONF_DROP</span>:
			<span class="k">case</span> <span class="n">S_CONF_ISOLATE</span>:
			<span class="k">case</span> <span class="n">S_CONF_REATTACH</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wbd&quot;</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;format wrong&quot;</span><span class="p">));</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">==</span> <span class="n">IDLE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">==</span> <span class="n">CALL_HELD</span><span class="p">)))</span>
				<span class="p">{</span>
					<span class="n">d</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&gt;=</span> <span class="mh">0x80</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;format wrong&quot;</span><span class="p">));</span>
						<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">SSreq</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">SSreq</span><span class="p">)</span>
					<span class="p">{</span>
					<span class="k">case</span> <span class="n">S_CONF_BEGIN</span>:
						<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CONF_BEGIN</span><span class="p">;</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">CONF_BEGIN_REQ_PEND</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">S_CONF_DROP</span>:
						<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CONF_DROP</span><span class="p">;</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">CONF_DROP_REQ_PEND</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">S_CONF_ISOLATE</span>:
						<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CONF_ISOLATE</span><span class="p">;</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">CONF_ISOLATE_REQ_PEND</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">S_CONF_REATTACH</span>:
						<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CONF_REATTACH</span><span class="p">;</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">CONF_REATTACH_REQ_PEND</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">d</span><span class="p">;</span> <span class="cm">/* Conference Size resp. PartyId */</span>
					<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="n">cai</span><span class="p">);</span>
					<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">S_SERVICE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
					<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="n">Info</span> <span class="o">=</span> <span class="mh">0x3010</span><span class="p">;</span>                    <span class="cm">/* wrong state           */</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">S_ECT</span>:
			<span class="k">case</span> <span class="n">S_3PTY_BEGIN</span>:
			<span class="k">case</span> <span class="n">S_3PTY_END</span>:
			<span class="k">case</span> <span class="n">S_CONF_ADD</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wbd&quot;</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;format wrong&quot;</span><span class="p">));</span>
						<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="cm">/* workaround for the T-View-S */</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wbdb&quot;</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;format wrong&quot;</span><span class="p">));</span>
						<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">relatedPLCIvalue</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
				<span class="n">relatedPLCIvalue</span> <span class="o">&amp;=</span> <span class="mh">0x0000FFFF</span><span class="p">;</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;PTY/ECT/addCONF,relPLCI=%lx&quot;</span><span class="p">,</span> <span class="n">relatedPLCIvalue</span><span class="p">));</span>
				<span class="cm">/* controller starts with 0 up to (max_adapter - 1) */</span>
				<span class="k">if</span> <span class="p">(((</span><span class="n">relatedPLCIvalue</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				    <span class="o">||</span> <span class="p">(</span><span class="n">MapController</span><span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="n">relatedPLCIvalue</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				    <span class="o">||</span> <span class="p">(</span><span class="n">MapController</span><span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="n">relatedPLCIvalue</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">max_adapter</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">SSreq</span> <span class="o">==</span> <span class="n">S_3PTY_END</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;wrong Controller use 2nd PLCI=PLCI&quot;</span><span class="p">));</span>
						<span class="n">rplci</span> <span class="o">=</span> <span class="n">plci</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">Info</span> <span class="o">=</span> <span class="mh">0x3010</span><span class="p">;</span>                    <span class="cm">/* wrong state           */</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">relatedadapter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="p">[</span><span class="n">MapController</span><span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="n">relatedPLCIvalue</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
					<span class="n">relatedPLCIvalue</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
					<span class="cm">/* find PLCI PTR*/</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rplci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">relatedadapter</span><span class="o">-&gt;</span><span class="n">max_plci</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">relatedadapter</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Id</span> <span class="o">==</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">relatedPLCIvalue</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="n">rplci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">relatedadapter</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rplci</span> <span class="o">||</span> <span class="o">!</span><span class="n">relatedPLCIvalue</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">SSreq</span> <span class="o">==</span> <span class="n">S_3PTY_END</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;use 2nd PLCI=PLCI&quot;</span><span class="p">));</span>
							<span class="n">rplci</span> <span class="o">=</span> <span class="n">plci</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">else</span>
						<span class="p">{</span>
							<span class="n">Info</span> <span class="o">=</span> <span class="mh">0x3010</span><span class="p">;</span>                    <span class="cm">/* wrong state           */</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">  dbug(1, dprintf(&quot;rplci:%x&quot;, rplci));</span>
<span class="cm">  dbug(1, dprintf(&quot;plci:%x&quot;, plci));</span>
<span class="cm">  dbug(1, dprintf(&quot;rplci-&gt;ptyState:%x&quot;, rplci-&gt;ptyState));</span>
<span class="cm">  dbug(1, dprintf(&quot;plci-&gt;ptyState:%x&quot;, plci-&gt;ptyState));</span>
<span class="cm">  dbug(1, dprintf(&quot;SSreq:%x&quot;, SSreq));</span>
<span class="cm">  dbug(1, dprintf(&quot;rplci-&gt;internal_command:%x&quot;, rplci-&gt;internal_command));</span>
<span class="cm">  dbug(1, dprintf(&quot;rplci-&gt;appl:%x&quot;, rplci-&gt;appl));</span>
<span class="cm">  dbug(1, dprintf(&quot;rplci-&gt;Id:%x&quot;, rplci-&gt;Id));</span>
<span class="cm">*/</span>
				<span class="cm">/* send PTY/ECT req, cannot check all states because of US stuff */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rplci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">&amp;&amp;</span> <span class="n">rplci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span> <span class="o">=</span> <span class="n">plci</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span> <span class="o">=</span> <span class="n">rplci</span><span class="p">;</span>
					<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">SSreq</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">SSreq</span> <span class="o">==</span> <span class="n">S_ECT</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">ECT_REQ_PEND</span><span class="p">;</span>
						<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ECT_EXECUTE</span><span class="p">;</span>

						<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">vswitchstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">vsprot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">vsprotdialect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">vswitchstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">vsprot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">vsprotdialect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

					<span class="p">}</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SSreq</span> <span class="o">==</span> <span class="n">S_CONF_ADD</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">CONF_ADD_REQ_PEND</span><span class="p">;</span>
						<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CONF_ADD</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">PTY_REQ_PEND</span><span class="p">;</span>
						<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">SSreq</span> <span class="o">-</span> <span class="mi">3</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">Number</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">!=</span> <span class="n">rplci</span><span class="p">)</span> <span class="cm">/* explicit invocation */</span>
					<span class="p">{</span>
						<span class="n">cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
						<span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span><span class="p">;</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;explicit invocation&quot;</span><span class="p">));</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;implicit invocation&quot;</span><span class="p">));</span>
						<span class="n">cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="n">cai</span><span class="p">);</span>
					<span class="n">sig_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">S_SERVICE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">send_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">);</span>
					<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Wrong line&quot;</span><span class="p">));</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="mh">0x3010</span><span class="p">;</span>                    <span class="cm">/* wrong state           */</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">S_CALL_DEFLECTION</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wbwss&quot;</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;format wrong&quot;</span><span class="p">));</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* reuse unused screening indicator */</span>
				<span class="n">ss_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">CD_REQ_PEND</span><span class="p">;</span>
				<span class="n">appl</span><span class="o">-&gt;</span><span class="n">CDEnable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CALL_DEFLECTION</span><span class="p">;</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="n">cai</span><span class="p">);</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CPN</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">S_SERVICE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">S_CALL_FORWARDING_START</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wbdwwsss&quot;</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;format wrong&quot;</span><span class="p">));</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">get_plci</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
				<span class="p">{</span>
					<span class="n">rplci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
					<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
					<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x80</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">UID</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x06\x43\x61\x70\x69\x32\x30</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">sig_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="n">DSIG_ID</span><span class="p">);</span>
					<span class="n">send_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_OUT_OF_PLCI</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* reuse unused screening indicator */</span>
				<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">CF_START_PEND</span><span class="p">;</span>
				<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
				<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">Number</span><span class="p">;</span>
				<span class="n">appl</span><span class="o">-&gt;</span><span class="n">S_Handle</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
				<span class="n">cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span> <span class="o">|</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span> <span class="cm">/* Function */</span>
				<span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span> <span class="cm">/* Basic Service */</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="n">cai</span><span class="p">);</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">OAD</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">CPN</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">S_SERVICE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">S_INTERROGATE_DIVERSION</span>:
			<span class="k">case</span> <span class="n">S_INTERROGATE_NUMBERS</span>:
			<span class="k">case</span> <span class="n">S_CALL_FORWARDING_STOP</span>:
			<span class="k">case</span> <span class="n">S_CCBS_REQUEST</span>:
			<span class="k">case</span> <span class="n">S_CCBS_DEACTIVATE</span>:
			<span class="k">case</span> <span class="n">S_CCBS_INTERROGATE</span>:
				<span class="k">switch</span> <span class="p">(</span><span class="n">SSreq</span><span class="p">)</span>
				<span class="p">{</span>
				<span class="k">case</span> <span class="n">S_INTERROGATE_NUMBERS</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wbd&quot;</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;format wrong&quot;</span><span class="p">));</span>
						<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">S_CCBS_REQUEST</span>:
				<span class="k">case</span> <span class="n">S_CCBS_DEACTIVATE</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wbdw&quot;</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;format wrong&quot;</span><span class="p">));</span>
						<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">S_CCBS_INTERROGATE</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wbdws&quot;</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;format wrong&quot;</span><span class="p">));</span>
						<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wbdwws&quot;</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;format wrong&quot;</span><span class="p">));</span>
						<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">Info</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">get_plci</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
				<span class="p">{</span>
					<span class="n">rplci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">SSreq</span><span class="p">)</span>
					<span class="p">{</span>
					<span class="k">case</span> <span class="n">S_INTERROGATE_DIVERSION</span>: <span class="cm">/* use cai with S_SERVICE below */</span>
						<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x60</span> <span class="o">|</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span> <span class="cm">/* Function */</span>
						<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">INTERR_DIVERSION_REQ_PEND</span><span class="p">;</span> <span class="cm">/* move to rplci if assigned */</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">S_INTERROGATE_NUMBERS</span>: <span class="cm">/* use cai with S_SERVICE below */</span>
						<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">DIVERSION_INTERROGATE_NUM</span><span class="p">;</span> <span class="cm">/* Function */</span>
						<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">INTERR_NUMBERS_REQ_PEND</span><span class="p">;</span> <span class="cm">/* move to rplci if assigned */</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">S_CALL_FORWARDING_STOP</span>:
						<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">CF_STOP_PEND</span><span class="p">;</span>
						<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span> <span class="cm">/* Function */</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">S_CCBS_REQUEST</span>:
						<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CCBS_REQUEST</span><span class="p">;</span>
						<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">CCBS_REQUEST_REQ_PEND</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">S_CCBS_DEACTIVATE</span>:
						<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CCBS_DEACTIVATE</span><span class="p">;</span>
						<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">CCBS_DEACTIVATE_REQ_PEND</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">S_CCBS_INTERROGATE</span>:
						<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CCBS_INTERROGATE</span><span class="p">;</span>
						<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">CCBS_INTERROGATE_REQ_PEND</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="nl">default:</span>
						<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
					<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">Number</span><span class="p">;</span>
					<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x80</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">UID</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x06\x43\x61\x70\x69\x32\x30</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">sig_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="n">DSIG_ID</span><span class="p">);</span>
					<span class="n">send_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_OUT_OF_PLCI</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">appl</span><span class="o">-&gt;</span><span class="n">S_Handle</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">SSreq</span><span class="p">)</span>
				<span class="p">{</span>
				<span class="k">case</span> <span class="n">S_INTERROGATE_NUMBERS</span>:
					<span class="n">cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="n">cai</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">S_CCBS_REQUEST</span>:
				<span class="k">case</span> <span class="n">S_CCBS_DEACTIVATE</span>:
					<span class="n">cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
					<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">])));</span>
					<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="n">cai</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">S_CCBS_INTERROGATE</span>:
					<span class="n">cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
					<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">])));</span>
					<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="n">cai</span><span class="p">);</span>
					<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">OAD</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span> <span class="cm">/* Basic Service */</span>
					<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="n">cai</span><span class="p">);</span>
					<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">OAD</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">sig_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">S_SERVICE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">S_MWI_ACTIVATE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wbwdwwwssss&quot;</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;format wrong&quot;</span><span class="p">));</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">get_plci</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
					<span class="p">{</span>
						<span class="n">rplci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
						<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
						<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">cr_enquiry</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x80</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">UID</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x06\x43\x61\x70\x69\x32\x30</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">sig_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="n">DSIG_ID</span><span class="p">);</span>
						<span class="n">send_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">Info</span> <span class="o">=</span> <span class="n">_OUT_OF_PLCI</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">rplci</span> <span class="o">=</span> <span class="n">plci</span><span class="p">;</span>
					<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">cr_enquiry</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">MWI_ACTIVATE_REQ_PEND</span><span class="p">;</span>
				<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
				<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">Number</span><span class="p">;</span>

				<span class="n">cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
				<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ACTIVATION_MWI</span><span class="p">;</span> <span class="cm">/* Function */</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">])));</span> <span class="cm">/* Basic Service */</span>
				<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cai</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">])));</span> <span class="cm">/* Number of Messages */</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cai</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">])));</span> <span class="cm">/* Message Status */</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cai</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">])));</span> <span class="cm">/* Message Reference */</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cai</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">])));</span> <span class="cm">/* Invocation Mode */</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="n">cai</span><span class="p">);</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">CPN</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">info</span><span class="p">);</span> <span class="cm">/* Receiving User Number */</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">OAD</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">info</span><span class="p">);</span> <span class="cm">/* Controlling User Number */</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">OSA</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">info</span><span class="p">);</span> <span class="cm">/* Controlling User Provided Number */</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">UID</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">info</span><span class="p">);</span> <span class="cm">/* Time */</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">S_SERVICE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">S_MWI_DEACTIVATE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wbwwss&quot;</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;format wrong&quot;</span><span class="p">));</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">get_plci</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
					<span class="p">{</span>
						<span class="n">rplci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
						<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
						<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">cr_enquiry</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x80</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">UID</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x06\x43\x61\x70\x69\x32\x30</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">sig_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="n">DSIG_ID</span><span class="p">);</span>
						<span class="n">send_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">Info</span> <span class="o">=</span> <span class="n">_OUT_OF_PLCI</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">rplci</span> <span class="o">=</span> <span class="n">plci</span><span class="p">;</span>
					<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">cr_enquiry</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">MWI_DEACTIVATE_REQ_PEND</span><span class="p">;</span>
				<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
				<span class="n">rplci</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">Number</span><span class="p">;</span>

				<span class="n">cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEACTIVATION_MWI</span><span class="p">;</span> <span class="cm">/* Function */</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">])));</span> <span class="cm">/* Basic Service */</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cai</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ss_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">])));</span> <span class="cm">/* Invocation Mode */</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="n">cai</span><span class="p">);</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">CPN</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">);</span> <span class="cm">/* Receiving User Number */</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">OAD</span><span class="p">,</span> <span class="n">ss_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">info</span><span class="p">);</span> <span class="cm">/* Controlling User Number */</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">,</span> <span class="n">S_SERVICE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">rplci</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="mh">0x300E</span><span class="p">;</span>  <span class="cm">/* not supported */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* case SELECTOR_SU_SERV: end */</span>


		<span class="k">case</span> <span class="n">SELECTOR_DTMF</span>:
			<span class="k">return</span> <span class="p">(</span><span class="n">dtmf_request</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">appl</span><span class="p">,</span> <span class="n">msg</span><span class="p">));</span>



		<span class="k">case</span> <span class="n">SELECTOR_LINE_INTERCONNECT</span>:
			<span class="k">return</span> <span class="p">(</span><span class="n">mixer_request</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">appl</span><span class="p">,</span> <span class="n">msg</span><span class="p">));</span>



		<span class="k">case</span> <span class="n">PRIV_SELECTOR_ECHO_CANCELLER</span>:
			<span class="n">appl</span><span class="o">-&gt;</span><span class="n">appl_flags</span> <span class="o">|=</span> <span class="n">APPL_FLAG_PRIV_EC_SPEC</span><span class="p">;</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">ec_request</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">appl</span><span class="p">,</span> <span class="n">msg</span><span class="p">));</span>

		<span class="k">case</span> <span class="n">SELECTOR_ECHO_CANCELLER</span>:
			<span class="n">appl</span><span class="o">-&gt;</span><span class="n">appl_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">APPL_FLAG_PRIV_EC_SPEC</span><span class="p">;</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">ec_request</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">appl</span><span class="p">,</span> <span class="n">msg</span><span class="p">));</span>


		<span class="k">case</span> <span class="n">SELECTOR_V42BIS</span>:
		<span class="nl">default:</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="n">_FACILITY_NOT_SUPPORTED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="cm">/* end of switch (selector) */</span>
	<span class="p">}</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;SendFacRc&quot;</span><span class="p">));</span>
	<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span>
	      <span class="n">_FACILITY_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span>
	      <span class="n">Id</span><span class="p">,</span>
	      <span class="n">Number</span><span class="p">,</span>
	      <span class="s">&quot;wws&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">SSparms</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">facility_res</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			 <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;facility_res&quot;</span><span class="p">));</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">connect_b3_req</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			   <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">parms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">Info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">fax_control_bits</span><span class="p">,</span> <span class="n">fax_feature_bits</span><span class="p">,</span> <span class="n">fax_info_change</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="o">*</span><span class="n">ncpi</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">pvc</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">API_PARSE</span> <span class="n">fax_parms</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>


	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;connect_b3_req&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">IDLE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">OUTG_DIS_PENDING</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_DIS_PENDING</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">!=</span> <span class="n">IDLE</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="cm">/* local reply if assign unsuccessful</span>
<span class="cm">			   or B3 protocol allows only one layer 3 connection</span>
<span class="cm">			   and already connected</span>
<span class="cm">			   or B2 protocol not any LAPD</span>
<span class="cm">			   and connect_b3_req contradicts originate/answer direction */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span>
			    <span class="o">||</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">!=</span> <span class="n">B3_T90NL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">!=</span> <span class="n">B3_ISO8208</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">!=</span> <span class="n">B3_X25_DCE</span><span class="p">))</span>
				<span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				    <span class="o">||</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">!=</span> <span class="n">B2_SDLC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">!=</span> <span class="n">B2_LAPD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">!=</span> <span class="n">B2_LAPD_FREE_SAPI_SEL</span><span class="p">))</span>
					<span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">&amp;</span> <span class="n">CALL_DIR_ANSWER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">&amp;</span> <span class="n">CALL_DIR_FORCE_OUTG_NL</span><span class="p">))))))</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;B3 already connected=%d or no NL.Id=0x%x, dir=%d sstate=0x%x&quot;</span><span class="p">,</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span><span class="p">));</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span>
				      <span class="n">_CONNECT_B3_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span>
				      <span class="n">Id</span><span class="p">,</span>
				      <span class="n">Number</span><span class="p">,</span>
				      <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options_conn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">req</span> <span class="o">=</span> <span class="n">N_CONNECT</span><span class="p">;</span>
			<span class="n">ncpi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="cm">/* check for PVC */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
					<span class="p">{</span>
						<span class="n">pvc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
						<span class="n">pvc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
						<span class="n">add_d</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pvc</span><span class="p">);</span>
						<span class="n">req</span> <span class="o">=</span> <span class="n">N_RESET</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">req</span> <span class="o">=</span> <span class="n">N_CONNECT</span> <span class="o">|</span> <span class="n">N_D_BIT</span><span class="p">;</span>
						<span class="n">add_d</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">3</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">fax_control_bits</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control_bits_low</span><span class="p">);</span>
					<span class="n">fax_feature_bits</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">feature_bits_low</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fax_control_bits</span> <span class="o">&amp;</span> <span class="n">T30_CONTROL_BIT_MORE_DOCUMENTS</span><span class="p">)</span>
					    <span class="o">||</span> <span class="p">(</span><span class="n">fax_feature_bits</span> <span class="o">&amp;</span> <span class="n">T30_FEATURE_BIT_MORE_DOCUMENTS</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">len</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">T30_INFO</span><span class="p">,</span> <span class="n">universal_6</span><span class="p">);</span>
						<span class="n">fax_info_change</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="n">w</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
							<span class="k">if</span> <span class="p">((</span><span class="n">w</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="o">!=</span> <span class="p">((</span><span class="n">word</span><span class="p">)(((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">resolution</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)))</span>
							<span class="p">{</span>
								<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">resolution</span> <span class="o">=</span>
									<span class="p">(</span><span class="n">byte</span><span class="p">)((((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">resolution</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">T30_RESOLUTION_R8_0770_OR_200</span><span class="p">)</span> <span class="o">|</span>
									       <span class="p">((</span><span class="n">w</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="o">?</span> <span class="n">T30_RESOLUTION_R8_0770_OR_200</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
								<span class="n">fax_info_change</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="n">fax_control_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">T30_CONTROL_BIT_REQUEST_POLLING</span> <span class="o">|</span> <span class="n">T30_CONTROL_BIT_MORE_DOCUMENTS</span><span class="p">);</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">&amp;</span> <span class="mh">0x0002</span><span class="p">)</span>  <span class="cm">/* Fax-polling request */</span>
								<span class="n">fax_control_bits</span> <span class="o">|=</span> <span class="n">T30_CONTROL_BIT_REQUEST_POLLING</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">((</span><span class="n">w</span> <span class="o">&amp;</span> <span class="mh">0x0004</span><span class="p">)</span> <span class="cm">/* Request to send / poll another document */</span>
							    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_FAX_MORE_DOCUMENTS</span><span class="p">))</span>
							<span class="p">{</span>
								<span class="n">fax_control_bits</span> <span class="o">|=</span> <span class="n">T30_CONTROL_BIT_MORE_DOCUMENTS</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span>
							<span class="p">{</span>
								<span class="n">w</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
								<span class="k">if</span> <span class="p">(((</span><span class="n">byte</span><span class="p">)</span> <span class="n">w</span><span class="p">)</span> <span class="o">!=</span> <span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">data_format</span><span class="p">)</span>
								<span class="p">{</span>
									<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">data_format</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">w</span><span class="p">;</span>
									<span class="n">fax_info_change</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
								<span class="p">}</span>

								<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_SUB_SEP_PWD</span><span class="p">))</span>
								    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">))</span> <span class="cm">/* Private SEP/SUB/PWD enable */</span>
								<span class="p">{</span>
									<span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options_conn</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_SUB_SEP_PWD</span><span class="p">);</span>
								<span class="p">}</span>
								<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_NONSTANDARD</span><span class="p">))</span>
								    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">))</span> <span class="cm">/* Private non-standard facilities enable */</span>
								<span class="p">{</span>
									<span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options_conn</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_NONSTANDARD</span><span class="p">);</span>
								<span class="p">}</span>
								<span class="n">fax_control_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">T30_CONTROL_BIT_ACCEPT_SUBADDRESS</span> <span class="o">|</span> <span class="n">T30_CONTROL_BIT_ACCEPT_SEL_POLLING</span> <span class="o">|</span>
										      <span class="n">T30_CONTROL_BIT_ACCEPT_PASSWORD</span><span class="p">);</span>
								<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options_conn</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options</span> <span class="o">|</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">requested_options_table</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
								    <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_SUB_SEP_PWD</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_NONSTANDARD</span><span class="p">)))</span>
								<span class="p">{</span>
									<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wwwwsss&quot;</span><span class="p">,</span> <span class="n">fax_parms</span><span class="p">))</span>
										<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
									<span class="k">else</span>
									<span class="p">{</span>
										<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options_conn</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options</span> <span class="o">|</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">requested_options_table</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
										    <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_SUB_SEP_PWD</span><span class="p">))</span>
										<span class="p">{</span>
											<span class="n">fax_control_bits</span> <span class="o">|=</span> <span class="n">T30_CONTROL_BIT_ACCEPT_SUBADDRESS</span> <span class="o">|</span> <span class="n">T30_CONTROL_BIT_ACCEPT_PASSWORD</span><span class="p">;</span>
											<span class="k">if</span> <span class="p">(</span><span class="n">fax_control_bits</span> <span class="o">&amp;</span> <span class="n">T30_CONTROL_BIT_ACCEPT_POLLING</span><span class="p">)</span>
												<span class="n">fax_control_bits</span> <span class="o">|=</span> <span class="n">T30_CONTROL_BIT_ACCEPT_SEL_POLLING</span><span class="p">;</span>
										<span class="p">}</span>
										<span class="n">w</span> <span class="o">=</span> <span class="n">fax_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
										<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span>
											<span class="n">w</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
										<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">station_id_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">w</span><span class="p">;</span>
										<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
											<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">station_id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fax_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
										<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">head_line_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
										<span class="n">len</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">T30_INFO</span><span class="p">,</span> <span class="n">station_id</span><span class="p">)</span> <span class="o">+</span> <span class="n">T30_MAX_STATION_ID_LENGTH</span><span class="p">;</span>
										<span class="n">w</span> <span class="o">=</span> <span class="n">fax_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
										<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span>
											<span class="n">w</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
										<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">w</span><span class="p">;</span>
										<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
											<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">fax_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
										<span class="n">w</span> <span class="o">=</span> <span class="n">fax_parms</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
										<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span>
											<span class="n">w</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
										<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">w</span><span class="p">;</span>
										<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
											<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">fax_parms</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
										<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options_conn</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options</span> <span class="o">|</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">requested_options_table</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
										    <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_NONSTANDARD</span><span class="p">))</span>
										<span class="p">{</span>
											<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wwwwssss&quot;</span><span class="p">,</span> <span class="n">fax_parms</span><span class="p">))</span>
											<span class="p">{</span>
												<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;non-standard facilities info missing or wrong format&quot;</span><span class="p">));</span>
												<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
											<span class="p">}</span>
											<span class="k">else</span>
											<span class="p">{</span>
												<span class="k">if</span> <span class="p">((</span><span class="n">fax_parms</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fax_parms</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">))</span>
													<span class="n">plci</span><span class="o">-&gt;</span><span class="n">nsf_control_bits</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fax_parms</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
												<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">fax_parms</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
												<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fax_parms</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
													<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">fax_parms</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
											<span class="p">}</span>
										<span class="p">}</span>
									<span class="p">}</span>
								<span class="p">}</span>
								<span class="k">else</span>
								<span class="p">{</span>
									<span class="n">len</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">T30_INFO</span><span class="p">,</span> <span class="n">universal_6</span><span class="p">);</span>
								<span class="p">}</span>
								<span class="n">fax_info_change</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

							<span class="p">}</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">fax_control_bits</span> <span class="o">!=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control_bits_low</span><span class="p">))</span>
							<span class="p">{</span>
								<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control_bits_low</span><span class="p">,</span> <span class="n">fax_control_bits</span><span class="p">);</span>
								<span class="n">fax_info_change</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">Info</span> <span class="o">==</span> <span class="n">GOOD</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">fax_info_change</span><span class="p">)</span>
							<span class="p">{</span>
								<span class="k">if</span> <span class="p">(</span><span class="n">fax_feature_bits</span> <span class="o">&amp;</span> <span class="n">T30_FEATURE_BIT_MORE_DOCUMENTS</span><span class="p">)</span>
								<span class="p">{</span>
									<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">fax_connect_info_command</span><span class="p">);</span>
									<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
								<span class="p">}</span>
								<span class="k">else</span>
								<span class="p">{</span>
									<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">fax_adjust_b23_command</span><span class="p">);</span>
									<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
								<span class="p">}</span>
							<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="k">else</span>  <span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span>  <span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="n">B3_RTP</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">UDATA_REQUEST_RTP_RECONFIGURE</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span> <span class="n">w</span><span class="o">++</span><span class="p">)</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">];</span>
				<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">rtp_connect_b3_req_command</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Info</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">;</span>

	<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span>
	      <span class="n">_CONNECT_B3_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span>
	      <span class="n">Id</span><span class="p">,</span>
	      <span class="n">Number</span><span class="p">,</span>
	      <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">connect_b3_res</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			   <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">parms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">ncci</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="o">*</span><span class="n">ncpi</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">req</span><span class="p">;</span>

	<span class="n">word</span> <span class="n">w</span><span class="p">;</span>


	<span class="n">API_PARSE</span> <span class="n">fax_parms</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">len</span><span class="p">;</span>


	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;connect_b3_res&quot;</span><span class="p">));</span>

	<span class="n">ncci</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">Id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">&amp;&amp;</span> <span class="n">ncci</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">INC_CON_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">OUTG_REJ_PENDING</span><span class="p">;</span>
				<span class="n">channel_request_xon</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">ncci</span><span class="p">]);</span>
				<span class="n">channel_xmit_xon</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="n">cleanup_ncci_data</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ncci</span><span class="p">);</span>
				<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">N_DISC</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">ncci</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">INC_ACT_PENDING</span><span class="p">;</span>

			<span class="n">req</span> <span class="o">=</span> <span class="n">N_CONNECT_ACK</span><span class="p">;</span>
			<span class="n">ncpi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">7</span><span class="p">))</span>
			<span class="p">{</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options_conn</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options</span> <span class="o">|</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">requested_options_table</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
				    <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_NONSTANDARD</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">5</span><span class="p">))</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nsf_control_bits</span> <span class="o">&amp;</span> <span class="n">T30_NSF_CONTROL_BIT_ENABLE_NSF</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nsf_control_bits</span> <span class="o">&amp;</span> <span class="n">T30_NSF_CONTROL_BIT_NEGOTIATE_RESP</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">len</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">T30_INFO</span><span class="p">,</span> <span class="n">station_id</span><span class="p">)</span> <span class="o">+</span> <span class="n">T30_MAX_STATION_ID_LENGTH</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_length</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">station_id_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">head_line_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wwwwssss&quot;</span><span class="p">,</span> <span class="n">fax_parms</span><span class="p">))</span>
						<span class="p">{</span>
							<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;non-standard facilities info missing or wrong format&quot;</span><span class="p">));</span>
						<span class="p">}</span>
						<span class="k">else</span>
						<span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_length</span> <span class="o">&lt;=</span> <span class="n">len</span><span class="p">)</span>
								<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="n">len</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">len</span><span class="p">];</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_length</span> <span class="o">&lt;=</span> <span class="n">len</span><span class="p">)</span>
								<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="n">len</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">len</span><span class="p">];</span>
							<span class="k">if</span> <span class="p">((</span><span class="n">fax_parms</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fax_parms</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">))</span>
								<span class="n">plci</span><span class="o">-&gt;</span><span class="n">nsf_control_bits</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fax_parms</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">fax_parms</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
							<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fax_parms</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
								<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">fax_parms</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
						<span class="p">}</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
						<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">fax_connect_ack_command</span><span class="p">);</span>
						<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">ncci</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">&amp;</span> <span class="n">NCPI_VALID_CONNECT_B3_ACT</span><span class="p">)</span>
				    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">&amp;</span> <span class="n">NCPI_CONNECT_B3_ACT_SENT</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
						<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_ACTIVE_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_ACTIVE_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;S&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">);</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">|=</span> <span class="n">NCPI_CONNECT_B3_ACT_SENT</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="n">B3_RTP</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">UDATA_REQUEST_RTP_RECONFIGURE</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span> <span class="n">w</span><span class="o">++</span><span class="p">)</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">w</span><span class="p">];</span>
				<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">rtp_connect_b3_res_command</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">else</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">req</span> <span class="o">=</span> <span class="n">N_CONNECT_ACK</span> <span class="o">|</span> <span class="n">N_D_BIT</span><span class="p">;</span>
					<span class="n">add_d</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">3</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
				<span class="p">}</span>
				<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">ncci</span><span class="p">);</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_ACTIVE_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_restore</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_restore</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">adjust_b_restore</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">connect_b3_a_res</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			     <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">parms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">ncci</span><span class="p">;</span>

	<span class="n">ncci</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">Id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;connect_b3_a_res(ncci=0x%x)&quot;</span><span class="p">,</span> <span class="n">ncci</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">&amp;&amp;</span> <span class="n">ncci</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">!=</span> <span class="n">IDLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">!=</span> <span class="n">INC_DIS_PENDING</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">!=</span> <span class="n">OUTG_DIS_PENDING</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">INC_ACT_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">CONNECTED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">!=</span> <span class="n">INC_CON_CONNECTED_ALERT</span><span class="p">)</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">CONNECTED</span><span class="p">;</span>
			<span class="n">channel_request_xon</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">ncci</span><span class="p">]);</span>
			<span class="n">channel_xmit_xon</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">disconnect_b3_req</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			      <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">parms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">ncci</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="o">*</span><span class="n">ncpi</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;disconnect_b3_req&quot;</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">;</span>
	<span class="n">ncci</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">Id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">&amp;&amp;</span> <span class="n">ncci</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">CONNECTED</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">OUTG_CON_PENDING</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">INC_CON_PENDING</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">INC_ACT_PENDING</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">OUTG_DIS_PENDING</span><span class="p">;</span>
			<span class="n">channel_request_xon</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">ncci</span><span class="p">]);</span>
			<span class="n">channel_xmit_xon</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci</span><span class="p">[</span><span class="n">ncci</span><span class="p">].</span><span class="n">data_pending</span>
			    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="n">B3_TRANSPARENT</span><span class="p">)</span>
				<span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="n">B3_T30</span><span class="p">)</span>
				<span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="n">B3_T30_WITH_EXTENSIONS</span><span class="p">)))</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">send_disc</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">ncci</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">cleanup_ncci_data</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ncci</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">ncpi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">add_d</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">N_DISC</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">ncci</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span>
	      <span class="n">_DISCONNECT_B3_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span>
	      <span class="n">Id</span><span class="p">,</span>
	      <span class="n">Number</span><span class="p">,</span>
	      <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">disconnect_b3_res</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			      <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">parms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">ncci</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ncci</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">Id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;disconnect_b3_res(ncci=0x%x&quot;</span><span class="p">,</span> <span class="n">ncci</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">&amp;&amp;</span> <span class="n">ncci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options_conn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">!=</span> <span class="n">B3_T90NL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">!=</span> <span class="n">B3_ISO8208</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">!=</span> <span class="n">B3_X25_DCE</span><span class="p">))</span>
		    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">!=</span> <span class="n">B2_LAPD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">!=</span> <span class="n">B2_LAPD_FREE_SAPI_SEL</span><span class="p">)))</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">|=</span> <span class="n">CALL_DIR_FORCE_OUTG_NL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CHANNELS_PER_PLCI</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">inc_dis_ncci_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">ncci</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CHANNELS_PER_PLCI</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="o">--</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CHANNELS_PER_PLCI</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">inc_dis_ncci_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">inc_dis_ncci_table</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">inc_dis_ncci_table</span><span class="p">[</span><span class="n">MAX_CHANNELS_PER_PLCI</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">ncci_free_receive_buffers</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ncci</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">IDLE</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">SUSPENDING</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">SUSPENDING</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span>
					      <span class="n">_FACILITY_I</span><span class="p">,</span>
					      <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffffL</span><span class="p">,</span>
					      <span class="mi">0</span><span class="p">,</span>
					      <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x03\x04\x00\x00</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_DISCONNECT_I</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffffL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_FAX_PAPER_FORMATS</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">5</span><span class="p">))</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">INC_DIS_PENDING</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">ncci_free_receive_buffers</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ncci</span><span class="p">);</span>

				<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">N_EDATA</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">ncci</span><span class="p">);</span>

				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
				<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">fax_disconnect_command</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">data_b3_req</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			<span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">parms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NCCI</span> <span class="o">*</span><span class="n">ncci_ptr</span><span class="p">;</span>
	<span class="n">DATA_B3_DESC</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">ncci</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;data_b3_req&quot;</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">;</span>
	<span class="n">ncci</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">Id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;ncci=0x%x, plci=0x%x&quot;</span><span class="p">,</span> <span class="n">ncci</span><span class="p">,</span> <span class="n">plci</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">&amp;&amp;</span> <span class="n">ncci</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">CONNECTED</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">INC_ACT_PENDING</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="cm">/* queue data */</span>
			<span class="n">ncci_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci</span><span class="p">[</span><span class="n">ncci</span><span class="p">]);</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_out</span> <span class="o">+</span> <span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_pending</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MAX_DATA_B3</span><span class="p">)</span>
				<span class="n">i</span> <span class="o">-=</span> <span class="n">MAX_DATA_B3</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">DBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">Number</span> <span class="o">=</span> <span class="n">Number</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">)))</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">))</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">))</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">)))</span>
			<span class="p">{</span>

				<span class="n">data</span><span class="o">-&gt;</span><span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)(</span><span class="o">*</span><span class="p">((</span><span class="n">dword</span> <span class="o">*</span><span class="p">)(</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)));</span>

			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">P</span> <span class="o">=</span> <span class="n">TransmitBufferSet</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">dword</span> <span class="o">*</span><span class="p">)</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">Length</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">Handle</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
			<span class="p">(</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_pending</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* check for delivery confirmation */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="mh">0x0004</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_ack_out</span> <span class="o">+</span> <span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_ack_pending</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MAX_DATA_ACK</span><span class="p">)</span>
					<span class="n">i</span> <span class="o">-=</span> <span class="n">MAX_DATA_ACK</span><span class="p">;</span>
				<span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">DataAck</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Number</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">Number</span><span class="p">;</span>
				<span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">DataAck</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Handle</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">Handle</span><span class="p">;</span>
				<span class="p">(</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_ack_pending</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">send_data</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">appl</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">((((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">)))</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">))</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">))</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">)))</span>
			<span class="p">{</span>

				<span class="n">TransmitBufferFree</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)(</span><span class="o">*</span><span class="p">((</span><span class="n">dword</span> <span class="o">*</span><span class="p">)(</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">))));</span>

			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span>
		      <span class="n">_DATA_B3_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span>
		      <span class="n">Id</span><span class="p">,</span>
		      <span class="n">Number</span><span class="p">,</span>
		      <span class="s">&quot;ww&quot;</span><span class="p">,</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">),</span> <span class="n">Info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">data_b3_res</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			<span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">parms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">ncci</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">NCCIcode</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;data_b3_res&quot;</span><span class="p">));</span>

	<span class="n">ncci</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">Id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">&amp;&amp;</span> <span class="n">ncci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;free(%d)&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">));</span>
		<span class="n">NCCIcode</span> <span class="o">=</span> <span class="n">ncci</span> <span class="o">|</span> <span class="p">(((</span><span class="n">word</span><span class="p">)</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">appl</span><span class="o">-&gt;</span><span class="n">MaxBuffer</span> <span class="o">&amp;&amp;</span>
		    <span class="n">appl</span><span class="o">-&gt;</span><span class="n">DataNCCI</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="n">NCCIcode</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">DataFlags</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;found&quot;</span><span class="p">));</span>
			<span class="n">appl</span><span class="o">-&gt;</span><span class="n">DataNCCI</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">channel_can_xon</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">ncci</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">channel_request_xon</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">ncci</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="n">channel_xmit_xon</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">DataFlags</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">N_DATA_ACK</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">ncci</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">reset_b3_req</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			 <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">parms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">ncci</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;reset_b3_req&quot;</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">;</span>
	<span class="n">ncci</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">Id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">&amp;&amp;</span> <span class="n">ncci</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">B3_ISO8208</span>:
		<span class="k">case</span> <span class="n">B3_X25_DCE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">CONNECTED</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">N_RESET</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">ncci</span><span class="p">);</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">GOOD</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">B3_TRANSPARENT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">CONNECTED</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">reset_b3_command</span><span class="p">);</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">GOOD</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* reset_b3 must result in a reset_b3_con &amp; reset_b3_Ind */</span>
	<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span>
	      <span class="n">_RESET_B3_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span>
	      <span class="n">Id</span><span class="p">,</span>
	      <span class="n">Number</span><span class="p">,</span>
	      <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">reset_b3_res</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			 <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">parms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">ncci</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;reset_b3_res&quot;</span><span class="p">));</span>

	<span class="n">ncci</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">Id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">&amp;&amp;</span> <span class="n">ncci</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">B3_ISO8208</span>:
		<span class="k">case</span> <span class="n">B3_X25_DCE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">INC_RES_PENDING</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">CONNECTED</span><span class="p">;</span>
				<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">N_RESET_ACK</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">ncci</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">connect_b3_t90_a_res</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
				 <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">parms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">ncci</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="o">*</span><span class="n">ncpi</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">req</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;connect_b3_t90_a_res&quot;</span><span class="p">));</span>

	<span class="n">ncci</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">Id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">&amp;&amp;</span> <span class="n">ncci</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">INC_ACT_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">CONNECTED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">INC_CON_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">CONNECTED</span><span class="p">;</span>

			<span class="n">req</span> <span class="o">=</span> <span class="n">N_CONNECT_ACK</span><span class="p">;</span>

			<span class="cm">/* parms[0]==0 for CAPI original message definition! */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ncpi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">req</span> <span class="o">=</span> <span class="n">N_CONNECT_ACK</span> <span class="o">|</span> <span class="n">N_D_BIT</span><span class="p">;</span>
					<span class="n">add_d</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">3</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">ncci</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">byte</span> <span class="nf">select_b_req</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			 <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">Info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">tel</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="n">bp_parms</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span> <span class="o">||</span> <span class="o">!</span><span class="n">msg</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;select_b_req[%d],PLCI=0x%x,Tel=0x%x,NL=0x%x,appl=0x%x,sstate=0x%x&quot;</span><span class="p">,</span>
				<span class="n">msg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span><span class="p">));</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;PlciState=0x%x&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">bp_parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* check if no channel is open, no B3 connected only */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">IDLE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">OUTG_DIS_PENDING</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_DIS_PENDING</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">!=</span> <span class="n">IDLE</span><span class="p">)</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* check message format and fill bp_parms pointer */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wwwsss&quot;</span><span class="p">,</span> <span class="n">bp_parms</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_CON_PENDING</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_CON_ALERT</span><span class="p">))</span> <span class="cm">/* send alert tone inband to the network, */</span>
			<span class="p">{</span>                                                                  <span class="cm">/* e.g. Qsig or RBS or Cornet-N or xess PRI */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Id</span> <span class="o">&amp;</span> <span class="n">EXT_CONTROLLER</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_SELECT_B_REQ</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="mh">0x2002</span><span class="p">);</span> <span class="cm">/* wrong controller */</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">INC_CON_CONNECTED_ALERT</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
				<span class="n">clear_c_ind_mask_bit</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
				<span class="n">dump_c_ind_mask</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_appl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="cm">/* disconnect the other appls */</span>
				<span class="p">{</span>                         <span class="cm">/* its quasi a connect        */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">test_c_ind_mask_bit</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
						<span class="n">sendf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_DISCONNECT_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">_OTHER_APPL_CONNECTED</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">api_save_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">saved_msg</span><span class="p">);</span>
			<span class="n">tel</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Id</span> <span class="o">&amp;</span> <span class="n">EXT_CONTROLLER</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tel</span><span class="p">)</span> <span class="cm">/* external controller in use by this PLCI */</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalAppl</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalAppl</span> <span class="o">!=</span> <span class="n">appl</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Ext_Ctrl in use 1&quot;</span><span class="p">));</span>
						<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">else</span>  <span class="cm">/* external controller NOT in use by this PLCI ? */</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Ext_Ctrl in use 2&quot;</span><span class="p">));</span>
						<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span> <span class="cm">/* activate the codec */</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Ext_Ctrl start&quot;</span><span class="p">));</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">AdvCodecSupport</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">appl</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
						<span class="p">{</span>
							<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Error in codec procedures&quot;</span><span class="p">));</span>
							<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">spoofed_msg</span> <span class="o">==</span> <span class="n">SPOOFING_REQUIRED</span><span class="p">)</span> <span class="cm">/* wait until codec is active */</span>
						<span class="p">{</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">spoofed_msg</span> <span class="o">=</span> <span class="n">AWAITING_SELECT_B</span><span class="p">;</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">BLOCK_PLCI</span><span class="p">;</span> <span class="cm">/* lock other commands */</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;continue if codec loaded&quot;</span><span class="p">));</span>
							<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="cm">/* external controller bit is OFF */</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tel</span><span class="p">)</span> <span class="cm">/* external controller in use, need to switch off */</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalAppl</span> <span class="o">==</span> <span class="n">appl</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">CodecIdCheck</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adv_nl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Ext_Ctrl disable&quot;</span><span class="p">));</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Ext_Ctrl not requested&quot;</span><span class="p">));</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Info</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">&amp;</span> <span class="n">CALL_DIR_OUT</span><span class="p">)</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">=</span> <span class="n">CALL_DIR_OUT</span> <span class="o">|</span> <span class="n">CALL_DIR_ORIGINATE</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">&amp;</span> <span class="n">CALL_DIR_IN</span><span class="p">)</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">=</span> <span class="n">CALL_DIR_IN</span> <span class="o">|</span> <span class="n">CALL_DIR_ANSWER</span><span class="p">;</span>
				<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">select_b_command</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_SELECT_B_REQ</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">manufacturer_req</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			     <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">parms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">ncci</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="n">m_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">word</span> <span class="n">codec</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">dir</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">byte</span> <span class="n">chi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
	<span class="k">static</span> <span class="n">byte</span> <span class="n">lli</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
	<span class="k">static</span> <span class="n">byte</span> <span class="n">codec_cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">};</span>
	<span class="k">static</span> <span class="n">byte</span> <span class="n">null_msg</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">static</span> <span class="n">API_PARSE</span> <span class="n">null_parms</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">null_msg</span> <span class="p">};</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">v_plci</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">Info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;manufacturer_req&quot;</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">m_parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_DWORD</span><span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="n">_DI_MANU_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">command</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
	<span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Info</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">_DI_ASSIGN_PLCI</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wbbs&quot;</span><span class="p">,</span> <span class="n">m_parms</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">codec</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">m_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="n">m_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">dir</span> <span class="o">=</span> <span class="n">m_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">get_plci</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">plci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">_MANUFACTURER_R</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">m_command</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">Number</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">LOCAL_CONNECT</span><span class="p">;</span>
				<span class="n">Id</span> <span class="o">=</span> <span class="p">(((</span><span class="n">word</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;ManCMD,plci=0x%x&quot;</span><span class="p">,</span> <span class="n">Id</span><span class="p">));</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">ch</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dir</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">chi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="mh">0x80</span> <span class="o">|</span> <span class="n">ch</span><span class="p">);</span>
					<span class="n">lli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">=</span> <span class="n">CALL_DIR_OUT</span> <span class="o">|</span> <span class="n">CALL_DIR_ORIGINATE</span><span class="p">;</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">codec</span><span class="p">)</span>
					<span class="p">{</span>
					<span class="k">case</span> <span class="mi">0</span>:
						<span class="n">Info</span> <span class="o">=</span> <span class="n">add_b1</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="mi">1</span>:
						<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="n">codec_cai</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
						<span class="cm">/* manual &#39;swich on&#39; to the codec support without signalling */</span>
						<span class="cm">/* first &#39;assign plci&#39; with this function, then use */</span>
					<span class="k">case</span> <span class="mi">2</span>:
						<span class="k">if</span> <span class="p">(</span><span class="n">AdvCodecSupport</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">appl</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
							<span class="n">Info</span> <span class="o">=</span> <span class="n">_RESOURCE_ERROR</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">else</span> <span class="p">{</span>
							<span class="n">Info</span> <span class="o">=</span> <span class="n">add_b1</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">null_parms</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">B1_FACILITY_LOCAL</span><span class="p">);</span>
							<span class="n">lli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="cm">/* local call codec stream */</span>
						<span class="p">}</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">LOCAL_CONNECT</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">manufacturer</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">_MANUFACTURER_R</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">m_command</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">Number</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Info</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LLI</span><span class="p">,</span> <span class="n">lli</span><span class="p">);</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CHI</span><span class="p">,</span> <span class="n">chi</span><span class="p">);</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">UID</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x06\x43\x61\x70\x69\x32\x30</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="n">DSIG_ID</span><span class="p">);</span>

						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">codec</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="n">Info</span> <span class="o">=</span> <span class="n">add_b23</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
							<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Info</span><span class="p">)</span>
							<span class="p">{</span>
								<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
								<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
							<span class="p">}</span>
						<span class="p">}</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Info</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;dir=0x%x,spoof=0x%x&quot;</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">spoofed_msg</span><span class="p">));</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">spoofed_msg</span> <span class="o">==</span> <span class="n">SPOOFING_REQUIRED</span><span class="p">)</span>
							<span class="p">{</span>
								<span class="n">api_save_msg</span><span class="p">(</span><span class="n">m_parms</span><span class="p">,</span> <span class="s">&quot;wbbs&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">saved_msg</span><span class="p">);</span>
								<span class="n">plci</span><span class="o">-&gt;</span><span class="n">spoofed_msg</span> <span class="o">=</span> <span class="n">AWAITING_MANUF_CON</span><span class="p">;</span>
								<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">BLOCK_PLCI</span><span class="p">;</span> <span class="cm">/* reject other req meanwhile */</span>
								<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
								<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
								<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CALL_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
							<span class="p">}</span>
							<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LISTEN_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
							<span class="p">}</span>
							<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="k">else</span>
						<span class="p">{</span>
							<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span>
							      <span class="n">_MANUFACTURER_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span>
							      <span class="n">Id</span><span class="p">,</span>
							      <span class="n">Number</span><span class="p">,</span>
							      <span class="s">&quot;dww&quot;</span><span class="p">,</span> <span class="n">_DI_MANU_ID</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">Info</span><span class="p">);</span>
							<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span>  <span class="n">Info</span> <span class="o">=</span> <span class="n">_OUT_OF_PLCI</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">_DI_IDI_CTRL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;bs&quot;</span><span class="p">,</span> <span class="n">m_parms</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">m_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">_MANUFACTURER_R</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">m_command</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">Number</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="n">CALL_REQ</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">b_channel</span> <span class="o">=</span> <span class="n">getChannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="n">mixer_set_bchannel_id_esc</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">b_channel</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">spoofed_msg</span> <span class="o">==</span> <span class="n">SPOOFING_REQUIRED</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">spoofed_msg</span> <span class="o">=</span> <span class="n">CALL_REQ</span> <span class="o">|</span> <span class="n">AWAITING_MANUF_CON</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">BLOCK_PLCI</span><span class="p">;</span> <span class="cm">/* reject other req meanwhile */</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="n">LAW_REQ</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">cr_enquiry</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">add_ss</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">FTY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="n">HANGUP</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">for</span> <span class="p">(</span><span class="n">ncci</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ncci</span> <span class="o">&lt;</span> <span class="n">MAX_NCCI</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ncci</span><span class="o">++</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_plci</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">CONNECTED</span><span class="p">))</span>
							<span class="p">{</span>
								<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">OUTG_DIS_PENDING</span><span class="p">;</span>
								<span class="n">cleanup_ncci_data</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ncci</span><span class="p">);</span>
								<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">N_DISC</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">ncci</span><span class="p">);</span>
							<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="n">mixer_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
					<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">REMOVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">_DI_SIG_CTRL</span>:
			<span class="cm">/* signalling control for loop activation B-channel */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">_MANUFACTURER_R</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">Number</span><span class="p">;</span>
				<span class="n">add_ss</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">FTY</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">SIG_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">_DI_RXT_CTRL</span>:
			<span class="cm">/* activation control for receiver/transmitter B-channel */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">_MANUFACTURER_R</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">Number</span><span class="p">;</span>
				<span class="n">add_ss</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">FTY</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">DSP_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">_DI_ADV_CODEC</span>:
		<span class="k">case</span> <span class="n">_DI_DSP_CTRL</span>:
			<span class="cm">/* TEL_CTRL commands to support non standard adjustments: */</span>
			<span class="cm">/* Ring on/off, Handset micro volume, external micro vol. */</span>
			<span class="cm">/* handset+external speaker volume, receiver+transm. gain,*/</span>
			<span class="cm">/* handsfree on (hookinfo off), set mixer command         */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">_DI_ADV_CODEC</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvCodecPLCI</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">v_plci</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvCodecPLCI</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span>
				    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
				    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x1c</span><span class="p">)</span>
				    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">DSP_CTRL_OLD_SET_MIXER_COEFFICIENTS</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">!=</span> <span class="n">ADV_VOICE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">plci</span> <span class="o">!=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">))</span>
						<span class="p">{</span>
							<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_length</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_length</span> <span class="o">&gt;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
							<span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">3</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_length</span> <span class="o">&gt;</span> <span class="n">ADV_VOICE_COEF_BUFFER_SIZE</span><span class="p">)</span>
							<span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_length</span> <span class="o">=</span> <span class="n">ADV_VOICE_COEF_BUFFER_SIZE</span><span class="p">;</span>
						<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
							<span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_VOICE</span><span class="p">)</span>
							<span class="n">adv_voice_write_coefs</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ADV_VOICE_WRITE_UPDATE</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">DSP_CTRL_SET_DTMF_PARAMETERS</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_DTMF_PARAMETERS</span><span class="p">))</span>
						<span class="p">{</span>
							<span class="n">Info</span> <span class="o">=</span> <span class="n">_FACILITY_NOT_SUPPORTED</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>

						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_parameter_length</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_parameter_length</span> <span class="o">&gt;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_parameter_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">3</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_parameter_length</span> <span class="o">&gt;</span> <span class="n">DTMF_PARAMETER_BUFFER_SIZE</span><span class="p">)</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_parameter_length</span> <span class="o">=</span> <span class="n">DTMF_PARAMETER_BUFFER_SIZE</span><span class="p">;</span>
						<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_parameter_length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_parameter_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_DTMFR</span><span class="p">)</span>
							<span class="n">dtmf_parameter_write</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>

					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">v_plci</span> <span class="o">=</span> <span class="n">plci</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v_plci</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">add_ss</span><span class="p">(</span><span class="n">v_plci</span><span class="p">,</span> <span class="n">FTY</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">v_plci</span><span class="p">,</span> <span class="n">TEL_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">v_plci</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">_DI_OPTIONS_REQUEST</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="n">m_parms</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">GET_DWORD</span><span class="p">(</span><span class="n">m_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_FACILITY_NOT_SUPPORTED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">requested_options_table</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="n">m_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>



		<span class="nl">default:</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span>
	      <span class="n">_MANUFACTURER_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span>
	      <span class="n">Id</span><span class="p">,</span>
	      <span class="n">Number</span><span class="p">,</span>
	      <span class="s">&quot;dww&quot;</span><span class="p">,</span> <span class="n">_DI_MANU_ID</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">Info</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">byte</span> <span class="nf">manufacturer_res</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			     <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">indication</span><span class="p">;</span>

	<span class="n">API_PARSE</span> <span class="n">m_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">API_PARSE</span> <span class="o">*</span><span class="n">ncpi</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="n">fax_parms</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">len</span><span class="p">;</span>


	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;manufacturer_res&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">GET_DWORD</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="n">_DI_MANU_ID</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">indication</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">indication</span><span class="p">)</span>
	<span class="p">{</span>

	<span class="k">case</span> <span class="n">_DI_NEGOTIATE_B3</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">))</span>
		    <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">&amp;</span> <span class="n">NCPI_NEGOTIATE_B3_SENT</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;wrong state for NEGOTIATE_B3 parameters&quot;</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="n">m_parms</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;wrong format in NEGOTIATE_B3 parameters&quot;</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ncpi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">T30_INFO</span><span class="p">,</span> <span class="n">station_id</span><span class="p">)</span> <span class="o">+</span> <span class="n">T30_MAX_STATION_ID_LENGTH</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_length</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">station_id_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">head_line_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wwwwssss&quot;</span><span class="p">,</span> <span class="n">fax_parms</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;non-standard facilities info missing or wrong format&quot;</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_length</span> <span class="o">&lt;=</span> <span class="n">len</span><span class="p">)</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">len</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_length</span> <span class="o">&lt;=</span> <span class="n">len</span><span class="p">)</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">len</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">fax_parms</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fax_parms</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">))</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">nsf_control_bits</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fax_parms</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">fax_parms</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fax_parms</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">fax_parms</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_edata_ack_length</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_length</span><span class="p">;</span>
		<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">fax_edata_ack_command</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* IDI callback function                                            */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="kt">void</span> <span class="nf">callback</span><span class="p">(</span><span class="n">ENTITY</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">;</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">;</span>
	<span class="n">CAPI_MSG</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">global_req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">no_cancel_rc</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;%x:CB(%x:Req=%x,Rc=%x,Ind=%x)&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Req</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Rc</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Ind</span><span class="p">));</span>

	<span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">adapter</span><span class="p">[(</span><span class="n">byte</span><span class="p">)</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]]);</span>
	<span class="n">plci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="mi">1</span><span class="p">]]);</span>
	<span class="n">no_cancel_rc</span> <span class="o">=</span> <span class="n">DIVA_CAPI_SUPPORTS_NO_CANCEL</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	  If new protocol code and new XDI is used then CAPI should work</span>
<span class="cm">	  fully in accordance with IDI cpec an look on callback field instead</span>
<span class="cm">	  of Rc field for return codes.</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">no_cancel_rc</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">Rc</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">no_cancel_rc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Rc</span><span class="p">;</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">RcCh</span><span class="p">;</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Req</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">Rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			  If REMOVE request was sent then we have to wait until</span>
<span class="cm">			  return code with Id set to zero arrives.</span>
<span class="cm">			  All other return codes should be ignored.</span>
<span class="cm">			*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="n">REMOVE</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;cancel RC in REMOVE state&quot;</span><span class="p">));</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">channel_flow_control_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">FlowControlIdTable</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span><span class="p">)</span>
						<span class="n">a</span><span class="o">-&gt;</span><span class="n">FlowControlIdTable</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_descriptor</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">diva_free_dma_descriptor</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_descriptor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_descriptor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">OK_FC</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">FlowControlIdTable</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">FlowControlSkipTable</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">|=</span> <span class="n">N_OK_FC_PENDING</span><span class="p">;</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_plci</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				  Cancel return codes self, if feature was requested</span>
<span class="cm">				*/</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">no_cancel_rc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">FlowControlIdTable</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">==</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">FlowControlIdTable</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">==</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">FlowControlSkipTable</span><span class="p">[</span><span class="n">ch</span><span class="p">])</span> <span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;XDI CAPI: RC cancelled Id:0x02, Ch:%02x&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="n">ch</span><span class="p">));</span>
						<span class="k">return</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">N_OK_FC_PENDING</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">N_OK_FC_PENDING</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ReqCh</span><span class="p">)</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span><span class="p">)</span>
				<span class="n">control_rc</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="n">N_XON</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">channel_x_on</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
						<span class="n">control_rc</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_global_req</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">global_req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_global_req</span><span class="p">;</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_global_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ASSIGN_OK</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">e</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_descriptor</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">diva_free_dma_descriptor</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_descriptor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
								<span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_descriptor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>
						<span class="n">channel_xmit_xon</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
						<span class="n">control_rc</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">global_req</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">data_sent</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">channel_xmit_xon</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">data_sent</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">XNum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="n">data_rc</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
							<span class="n">control_rc</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">channel_xmit_xon</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
						<span class="n">control_rc</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			  If REMOVE request was sent then we have to wait until</span>
<span class="cm">			  return code with Id set to zero arrives.</span>
<span class="cm">			  All other return codes should be ignored.</span>
<span class="cm">			*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="n">REMOVE</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;cancel RC in REMOVE state&quot;</span><span class="p">));</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_remove_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_global_req</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">global_req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_global_req</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_global_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ASSIGN_OK</span><span class="p">)</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">channel_xmit_xon</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="n">control_rc</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">global_req</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">channel_xmit_xon</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="n">control_rc</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		  Again: in accordance with IDI spec Rc and Ind can&#39;t be delivered in the</span>
<span class="cm">		  same callback. Also if new XDI and protocol code used then jump</span>
<span class="cm">		  direct to finish.</span>
<span class="cm">		*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">no_cancel_rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">channel_xmit_xon</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">capi_callback_suffix</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">channel_xmit_xon</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">Ind</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">byte</span> <span class="n">Ind</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
			<span class="n">byte</span> <span class="n">Ch</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">IndCh</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">Ind</span> <span class="o">==</span> <span class="n">N_DISC</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">Ind</span> <span class="o">==</span> <span class="n">N_DISC_ACK</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_plci</span><span class="p">[</span><span class="n">Ch</span><span class="p">]</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">Ch</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">N_RX_FLOW_CONTROL_MASK</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;XDI CAPI: I: pending N-XON Ch:%02x&quot;</span><span class="p">,</span> <span class="n">Ch</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">Ch</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">N_RX_FLOW_CONTROL_MASK</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">nl_ind</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">RNR</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_plci</span><span class="p">[</span><span class="n">Ch</span><span class="p">]</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">Ch</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">N_RX_FLOW_CONTROL_MASK</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">Ch</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">N_RX_FLOW_CONTROL_MASK</span><span class="p">;</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;XDI CAPI: I: remove faked N-XON Ch:%02x&quot;</span><span class="p">,</span> <span class="n">Ch</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sig_ind</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">Ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">capi_callback_suffix:</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span>
	       <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span>
	       <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_write_pos</span> <span class="o">!=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_read_pos</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_read_pos</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_wrap_pos</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_read_pos</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">=</span> <span class="p">(((</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">))[</span><span class="n">j</span><span class="p">]))</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">;</span>

		<span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">))[</span><span class="n">j</span><span class="p">]);</span>
		<span class="n">appl</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">APPL</span> <span class="o">**</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_queue</span><span class="p">))[</span><span class="n">j</span> <span class="o">+</span> <span class="n">i</span><span class="p">]));</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;dequeue msg(0x%04x) - write=%d read=%d wrap=%d&quot;</span><span class="p">,</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_write_pos</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_read_pos</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_wrap_pos</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_read_pos</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_wrap_pos</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_wrap_pos</span> <span class="o">=</span> <span class="n">MSG_IN_QUEUE_SIZE</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_read_pos</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">MSG_IN_OVERHEAD</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_read_pos</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="n">MSG_IN_OVERHEAD</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_read_pos</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_write_pos</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_write_pos</span> <span class="o">=</span> <span class="n">MSG_IN_QUEUE_SIZE</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_read_pos</span> <span class="o">=</span> <span class="n">MSG_IN_QUEUE_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_read_pos</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_wrap_pos</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_read_pos</span> <span class="o">=</span> <span class="n">MSG_IN_QUEUE_SIZE</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_wrap_pos</span> <span class="o">=</span> <span class="n">MSG_IN_QUEUE_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">api_put</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">_DATA_B3_R</span><span class="p">)</span>

				<span class="n">TransmitBufferFree</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">data_b3_req</span><span class="p">.</span><span class="n">Data</span><span class="p">));</span>

			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Error 0x%04x from msg(0x%04x)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">command</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_notify_update</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_notify_update</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">mixer_notify_update</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="n">send_data</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
	<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">control_rc</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">req</span><span class="p">,</span> <span class="n">byte</span> <span class="n">rc</span><span class="p">,</span> <span class="n">byte</span> <span class="n">ch</span><span class="p">,</span> <span class="n">byte</span> <span class="n">global_req</span><span class="p">,</span>
		       <span class="n">byte</span> <span class="n">nl_rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dword</span> <span class="n">Id</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">rId</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">Number</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">Info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">ncci</span><span class="p">;</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">;</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">rplci</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">SSparms</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x05\x00\x00\x02\x00\x00</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">SSstruct</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x09\x00\x00\x06\x00\x00\x00\x00\x00\x00</span><span class="s">&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;A: control_rc, no plci %02x:%02x:%02x:%02x:%02x&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">global_req</span><span class="p">,</span> <span class="n">nl_rc</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;req0_in/out=%d/%d&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span> <span class="o">!=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nl_rc</span> <span class="o">||</span> <span class="p">(</span><span class="n">global_req</span> <span class="o">!=</span> <span class="n">ASSIGN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">ASSIGN_OK</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;req_1return&quot;</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* cancel outstanding request on the PLCI after SIG ASSIGN failure */</span>
	<span class="p">}</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in_start</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;control_rc&quot;</span><span class="p">));</span>

	<span class="n">appl</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">;</span>
	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">ncci</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_ncci</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">appl</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">Id</span> <span class="o">=</span> <span class="p">(((</span><span class="n">dword</span><span class="p">)(</span><span class="n">ncci</span> <span class="o">?</span> <span class="n">ncci</span> <span class="o">:</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">word</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">!=</span> <span class="n">CALL_HELD</span><span class="p">)</span> <span class="n">Id</span> <span class="o">|=</span> <span class="n">EXT_CONTROLLER</span><span class="p">;</span>
		<span class="n">Number</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Contr_RC-Id=%08lx,plci=%x,tel=%x, entity=0x%x, command=0x%x, int_command=0x%x&quot;</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">));</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;channels=0x%x&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci_remove_check</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="n">REMOVE</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">==</span> <span class="n">ASSIGN_OK</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">HANGUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">REMOVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span>
			<span class="p">{</span>
			<span class="k">case</span> <span class="n">C_HOLD_REQ</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;HoldRC=0x%x&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">));</span>
				<span class="n">SSparms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">S_HOLD</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="mh">0x2001</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;wws&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SSparms</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">C_RETRIEVE_REQ</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;RetrieveRC=0x%x&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">));</span>
				<span class="n">SSparms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">S_RETRIEVE</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">=</span> <span class="n">CALL_HELD</span><span class="p">;</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="mh">0x2001</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;wws&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SSparms</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">_INFO_R</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;InfoRC=0x%x&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_INFO_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">_CONNECT_R</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Connect_R=0x%x/0x%x/0x%x/0x%x&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">global_req</span><span class="p">,</span> <span class="n">nl_rc</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_DIS_PENDING</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(((</span><span class="n">global_req</span> <span class="o">==</span> <span class="n">ASSIGN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ASSIGN_OK</span><span class="p">))</span>
					    <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">nl_rc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="n">CALL_REQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)))</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;No more IDs/Call_Req failed&quot;</span><span class="p">));</span>
						<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffL</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">_OUT_OF_PLCI</span><span class="p">);</span>
						<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">!=</span> <span class="n">LOCAL_CONNECT</span><span class="p">)</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">OUTG_CON_PENDING</span><span class="p">;</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="cm">/* D-ch activation */</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ASSIGN_OK</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;No more IDs/X.25 Call_Req failed&quot;</span><span class="p">));</span>
						<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffL</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">_OUT_OF_PLCI</span><span class="p">);</span>
						<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_ACTIVE_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;sss&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">INC_ACT_PENDING</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">_CONNECT_I</span> <span class="o">|</span> <span class="n">RESPONSE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">!=</span> <span class="n">INC_DIS_PENDING</span><span class="p">)</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">INC_CON_ACCEPT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">_DISCONNECT_R</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_DIS_PENDING</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">OUTG_DIS_PENDING</span><span class="p">;</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_DISCONNECT_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">SUSPEND_REQ</span>:
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">RESUME_REQ</span>:
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">_CONNECT_B3_R</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">ncci</span> <span class="o">=</span> <span class="n">get_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">Id</span> <span class="o">=</span> <span class="p">(</span><span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">dword</span><span class="p">)</span> <span class="n">ncci</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="n">N_RESET</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">INC_ACT_PENDING</span><span class="p">;</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_ACTIVE_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">OUTG_CON_PENDING</span><span class="p">;</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">_CONNECT_B3_I</span> <span class="o">|</span> <span class="n">RESPONSE</span>:
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">_RESET_B3_R</span>:
<span class="cm">/*        sendf(appl, _RESET_B3_R | CONFIRM, Id, Number, &quot;w&quot;, 0);*/</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">_DISCONNECT_B3_R</span>:
				<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_DISCONNECT_B3_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">_MANUFACTURER_R</span>:
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">PERM_LIST_REQ</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">;</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">);</span>
					<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
			<span class="p">{</span>
			<span class="k">case</span> <span class="n">BLOCK_PLCI</span>:
				<span class="k">return</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">GET_MWI_STATE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">OK</span><span class="p">)</span> <span class="cm">/* command supported, wait for indication */</span>
				<span class="p">{</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

				<span class="cm">/* Get Supported Services */</span>
			<span class="k">case</span> <span class="n">GETSERV_REQ_PEND</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">OK</span><span class="p">)</span> <span class="cm">/* command supported, wait for indication */</span>
				<span class="p">{</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SSstruct</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">MASK_TERMINAL_PORTABILITY</span><span class="p">);</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;wws&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SSstruct</span><span class="p">);</span>
				<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">INTERR_DIVERSION_REQ_PEND</span>:      <span class="cm">/* Interrogate Parameters        */</span>
			<span class="k">case</span> <span class="n">INTERR_NUMBERS_REQ_PEND</span>:
			<span class="k">case</span> <span class="n">CF_START_PEND</span>:                  <span class="cm">/* Call Forwarding Start pending */</span>
			<span class="k">case</span> <span class="n">CF_STOP_PEND</span>:                   <span class="cm">/* Call Forwarding Stop pending  */</span>
			<span class="k">case</span> <span class="n">CCBS_REQUEST_REQ_PEND</span>:
			<span class="k">case</span> <span class="n">CCBS_DEACTIVATE_REQ_PEND</span>:
			<span class="k">case</span> <span class="n">CCBS_INTERROGATE_REQ_PEND</span>:
				<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
				<span class="p">{</span>
				<span class="k">case</span> <span class="n">INTERR_DIVERSION_REQ_PEND</span>:
					<span class="n">SSparms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_INTERROGATE_DIVERSION</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">INTERR_NUMBERS_REQ_PEND</span>:
					<span class="n">SSparms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_INTERROGATE_NUMBERS</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">CF_START_PEND</span>:
					<span class="n">SSparms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_CALL_FORWARDING_START</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">CF_STOP_PEND</span>:
					<span class="n">SSparms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_CALL_FORWARDING_STOP</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">CCBS_REQUEST_REQ_PEND</span>:
					<span class="n">SSparms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_CCBS_REQUEST</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">CCBS_DEACTIVATE_REQ_PEND</span>:
					<span class="n">SSparms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_CCBS_DEACTIVATE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">CCBS_INTERROGATE_REQ_PEND</span>:
					<span class="n">SSparms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_CCBS_INTERROGATE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">global_req</span> <span class="o">==</span> <span class="n">ASSIGN</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;AssignDiversion_RC=0x%x/0x%x&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rc</span><span class="p">));</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">ISDN_GUARD_REJ</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_CAPI_GUARD_ERROR</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_SUPPLEMENTARY_SERVICE_NOT_SUPPORTED</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">,</span>
				      <span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="s">&quot;wws&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="mi">3</span><span class="p">,</span> <span class="n">SSparms</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Info</span><span class="p">)</span> <span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

				<span class="cm">/* 3pty conference pending */</span>
			<span class="k">case</span> <span class="n">PTY_REQ_PEND</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
				<span class="n">rplci</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">;</span>
				<span class="n">SSparms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ptyState</span><span class="p">;</span>
				<span class="n">rId</span> <span class="o">=</span> <span class="p">((</span><span class="n">word</span><span class="p">)</span><span class="n">rplci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">rplci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rplci</span><span class="o">-&gt;</span><span class="n">tel</span><span class="p">)</span> <span class="n">rId</span> <span class="o">|=</span> <span class="n">EXT_CONTROLLER</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="mh">0x300E</span><span class="p">;</span> <span class="cm">/* not supported */</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">rplci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span>
				      <span class="n">_FACILITY_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span>
				      <span class="n">rId</span><span class="p">,</span>
				      <span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
				      <span class="s">&quot;wws&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="mi">3</span><span class="p">,</span> <span class="n">SSparms</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

				<span class="cm">/* Explicit Call Transfer pending */</span>
			<span class="k">case</span> <span class="n">ECT_REQ_PEND</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;ECT_RC=0x%x/0x%x&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rc</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
				<span class="n">rplci</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">;</span>
				<span class="n">SSparms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_ECT</span><span class="p">;</span>
				<span class="n">rId</span> <span class="o">=</span> <span class="p">((</span><span class="n">word</span><span class="p">)</span><span class="n">rplci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">rplci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rplci</span><span class="o">-&gt;</span><span class="n">tel</span><span class="p">)</span> <span class="n">rId</span> <span class="o">|=</span> <span class="n">EXT_CONTROLLER</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="mh">0x300E</span><span class="p">;</span> <span class="cm">/* not supported */</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">rplci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span>
				      <span class="n">_FACILITY_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span>
				      <span class="n">rId</span><span class="p">,</span>
				      <span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
				      <span class="s">&quot;wws&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="mi">3</span><span class="p">,</span> <span class="n">SSparms</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">_MANUFACTURER_R</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;_Manufacturer_R=0x%x/0x%x&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rc</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">global_req</span> <span class="o">==</span> <span class="n">ASSIGN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ASSIGN_OK</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;No more IDs&quot;</span><span class="p">));</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_MANUFACTURER_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;dww&quot;</span><span class="p">,</span> <span class="n">_DI_MANU_ID</span><span class="p">,</span> <span class="n">_MANUFACTURER_R</span><span class="p">,</span> <span class="n">_OUT_OF_PLCI</span><span class="p">);</span>
					<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>  <span class="cm">/* after codec init, internal codec commands pending */</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">_CONNECT_R</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;_Connect_R=0x%x/0x%x&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rc</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">global_req</span> <span class="o">==</span> <span class="n">ASSIGN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ASSIGN_OK</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;No more IDs&quot;</span><span class="p">));</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffL</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">_OUT_OF_PLCI</span><span class="p">);</span>
					<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>  <span class="cm">/* after codec init, internal codec commands pending */</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">PERM_COD_HOOK</span>:                     <span class="cm">/* finished with Hook_Ind */</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">PERM_COD_CALL</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;***Codec Connect_Pending A, Rc = 0x%x&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">));</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">PERM_COD_CONN_PEND</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">PERM_COD_ASSIGN</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;***Codec Assign A, Rc = 0x%x&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ASSIGN_OK</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CALL_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">PERM_COD_CALL</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>

				<span class="cm">/* Null Call Reference Request pending */</span>
			<span class="k">case</span> <span class="n">C_NCR_FAC_REQ</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;NCR_FAC=0x%x/0x%x&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rc</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">global_req</span> <span class="o">==</span> <span class="n">ASSIGN</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">ASSIGN_OK</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">return</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_INFO_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">_WRONG_STATE</span><span class="p">);</span>
						<span class="n">appl</span><span class="o">-&gt;</span><span class="n">NullCREnable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
						<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="n">NCR_FACILITY</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">OK</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_INFO_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_INFO_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">_WRONG_STATE</span><span class="p">);</span>
						<span class="n">appl</span><span class="o">-&gt;</span><span class="n">NullCREnable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">HOOK_ON_REQ</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">CONNECTED</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">OUTG_DIS_PENDING</span><span class="p">;</span>
						<span class="n">cleanup_ncci_data</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ncci</span><span class="p">);</span>
						<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">N_DISC</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">ncci</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">HOOK_OFF_REQ</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_DIS_PENDING</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CALL_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">OUTG_CON_PENDING</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>


			<span class="k">case</span> <span class="n">MWI_ACTIVATE_REQ_PEND</span>:
			<span class="k">case</span> <span class="n">MWI_DEACTIVATE_REQ_PEND</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">global_req</span> <span class="o">==</span> <span class="n">ASSIGN</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">==</span> <span class="n">ASSIGN_OK</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MWI_REQ assigned&quot;</span><span class="p">));</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">WRONG_IE</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">Info</span> <span class="o">=</span> <span class="mh">0x2007</span><span class="p">;</span> <span class="cm">/* Illegal message parameter coding */</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MWI_REQ invalid parameter&quot;</span><span class="p">));</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">Info</span> <span class="o">=</span> <span class="mh">0x300B</span><span class="p">;</span> <span class="cm">/* not supported */</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MWI_REQ not supported&quot;</span><span class="p">));</span>
					<span class="p">}</span>
					<span class="cm">/* 0x3010: Request not allowed in this state */</span>
					<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SSparms</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mh">0x300E</span><span class="p">);</span> <span class="cm">/* SS not supported */</span>

				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">==</span> <span class="n">MWI_ACTIVATE_REQ_PEND</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SSparms</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_MWI_ACTIVATE</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SSparms</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_MWI_DEACTIVATE</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">cr_enquiry</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span>
					      <span class="n">_FACILITY_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span>
					      <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span>
					      <span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
					      <span class="s">&quot;wws&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="mi">3</span><span class="p">,</span> <span class="n">SSparms</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span>
					      <span class="n">_FACILITY_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span>
					      <span class="n">Id</span><span class="p">,</span>
					      <span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
					      <span class="s">&quot;wws&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="mi">3</span><span class="p">,</span> <span class="n">SSparms</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">CONF_BEGIN_REQ_PEND</span>:
			<span class="k">case</span> <span class="n">CONF_ADD_REQ_PEND</span>:
			<span class="k">case</span> <span class="n">CONF_SPLIT_REQ_PEND</span>:
			<span class="k">case</span> <span class="n">CONF_DROP_REQ_PEND</span>:
			<span class="k">case</span> <span class="n">CONF_ISOLATE_REQ_PEND</span>:
			<span class="k">case</span> <span class="n">CONF_REATTACH_REQ_PEND</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;CONF_RC=0x%x/0x%x&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rc</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">==</span> <span class="n">CONF_ADD_REQ_PEND</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
				<span class="n">rplci</span> <span class="o">=</span> <span class="n">plci</span><span class="p">;</span>
				<span class="n">rId</span> <span class="o">=</span> <span class="n">Id</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
				<span class="p">{</span>
				<span class="k">case</span> <span class="n">CONF_BEGIN_REQ_PEND</span>:
					<span class="n">SSparms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_CONF_BEGIN</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">CONF_ADD_REQ_PEND</span>:
					<span class="n">SSparms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_CONF_ADD</span><span class="p">;</span>
					<span class="n">rplci</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">;</span>
					<span class="n">rId</span> <span class="o">=</span> <span class="p">((</span><span class="n">word</span><span class="p">)</span><span class="n">rplci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">rplci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">CONF_SPLIT_REQ_PEND</span>:
					<span class="n">SSparms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_CONF_SPLIT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">CONF_DROP_REQ_PEND</span>:
					<span class="n">SSparms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_CONF_DROP</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">CONF_ISOLATE_REQ_PEND</span>:
					<span class="n">SSparms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_CONF_ISOLATE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">CONF_REATTACH_REQ_PEND</span>:
					<span class="n">SSparms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_CONF_REATTACH</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="mh">0x300E</span><span class="p">;</span> <span class="cm">/* not supported */</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">rplci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span>
				      <span class="n">_FACILITY_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span>
				      <span class="n">rId</span><span class="p">,</span>
				      <span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
				      <span class="s">&quot;wws&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="mi">3</span><span class="p">,</span> <span class="n">SSparms</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">VSWITCH_REQ_PEND</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="o">-&gt;</span><span class="n">vswitchstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="o">-&gt;</span><span class="n">vsprot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="o">-&gt;</span><span class="n">vsprotdialect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">vswitchstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">vsprot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">vsprotdialect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span> <span class="o">&amp;&amp;</span>
					    <span class="n">plci</span><span class="o">-&gt;</span><span class="n">vswitchstate</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
					    <span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="o">-&gt;</span><span class="n">vswitchstate</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="cm">/* join complete */</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">vswitchstate</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

				<span class="cm">/* Call Deflection Request pending (SSCT) */</span>
			<span class="k">case</span> <span class="n">CD_REQ_PEND</span>:
				<span class="n">SSparms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_CALL_DEFLECTION</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="mh">0x300E</span><span class="p">;</span> <span class="cm">/* not supported */</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">CDEnable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span>
				      <span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="s">&quot;wws&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="mi">3</span><span class="p">,</span> <span class="n">SSparms</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">RTP_CONNECT_B3_REQ_COMMAND_2</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">OK</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">ncci</span> <span class="o">=</span> <span class="n">get_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">Id</span> <span class="o">=</span> <span class="p">(</span><span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">dword</span><span class="p">)</span> <span class="n">ncci</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="o">++</span><span class="p">;</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">OUTG_CON_PENDING</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="nl">default:</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="p">{</span>
					<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]))(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
						<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">next_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="cm">/* appl==0 */</span>
	<span class="p">{</span>
		<span class="n">Id</span> <span class="o">=</span> <span class="p">((</span><span class="n">word</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span><span class="p">)</span> <span class="n">Id</span> <span class="o">|=</span> <span class="n">EXT_CONTROLLER</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">BLOCK_PLCI</span>:
			<span class="k">return</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">START_L1_SIG_ASSIGN_PEND</span>:
		<span class="k">case</span> <span class="n">REM_L1_SIG_ASSIGN_PEND</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">global_req</span> <span class="o">==</span> <span class="n">ASSIGN</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;***L1 Req rem PLCI&quot;</span><span class="p">));</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">REMOVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* Call Deflection Request pending, just no appl ptr assigned */</span>
		<span class="k">case</span> <span class="n">CD_REQ_PEND</span>:
			<span class="n">SSparms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_CALL_DEFLECTION</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="mh">0x300E</span><span class="p">;</span> <span class="cm">/* not supported */</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_appl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">CDEnable</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Id</span><span class="p">)</span> <span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">CDEnable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">sendf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_FACILITY_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span>
						      <span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="s">&quot;wws&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="mi">3</span><span class="p">,</span> <span class="n">SSparms</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">Info</span><span class="p">)</span> <span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">CDEnable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PERM_COD_HOOK</span>:                   <span class="cm">/* finished with Hook_Ind */</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PERM_COD_CALL</span>:
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">PERM_COD_CONN_PEND</span><span class="p">;</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;***Codec Connect_Pending, Rc = 0x%x&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PERM_COD_ASSIGN</span>:
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;***Codec Assign, Rc = 0x%x&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">));</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">ASSIGN_OK</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">PERM_COD_CALL</span><span class="p">;</span>
			<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CALL_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">LISTEN_SIG_ASSIGN_PEND</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">ASSIGN_OK</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;ListenCheck, new SIG_ID = 0x%x&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span><span class="p">));</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ESC</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x02\x18\x00</span><span class="s">&quot;</span><span class="p">);</span>             <span class="cm">/* support call waiting */</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">INDICATE_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;ListenCheck failed (assignRc=0x%x)&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">));</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">listen_active</span><span class="o">--</span><span class="p">;</span>
				<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">USELAW_REQ</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">global_req</span> <span class="o">==</span> <span class="n">ASSIGN</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">ASSIGN_OK</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LAW_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Auto-Law assigned&quot;</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Auto-Law assign failed&quot;</span><span class="p">));</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">automatic_law</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">automatic_lawPLCI</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="n">LAW_REQ</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">==</span> <span class="n">OK</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Auto-Law initiated&quot;</span><span class="p">));</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">automatic_law</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Auto-Law not supported&quot;</span><span class="p">));</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">automatic_law</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">REMOVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">automatic_lawPLCI</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plci_remove_check</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">data_rc</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dword</span> <span class="n">Id</span><span class="p">;</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">NCCI</span> <span class="o">*</span><span class="n">ncci_ptr</span><span class="p">;</span>
	<span class="n">DATA_B3_DESC</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">ncci</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">TransmitBufferFree</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">data_sent_ptr</span><span class="p">);</span>
		<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
		<span class="n">ncci</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_ncci</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ncci</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_plci</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">ncci_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci</span><span class="p">[</span><span class="n">ncci</span><span class="p">]);</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;data_out=%d, data_pending=%d&quot;</span><span class="p">,</span> <span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_out</span><span class="p">,</span> <span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_pending</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_pending</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">DBuffer</span><span class="p">[</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_out</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">])</span>
				<span class="p">{</span>
					<span class="n">Id</span> <span class="o">=</span> <span class="p">(((</span><span class="n">dword</span><span class="p">)</span><span class="n">ncci</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">word</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span><span class="p">)</span> <span class="n">Id</span> <span class="o">|=</span> <span class="n">EXT_CONTROLLER</span><span class="p">;</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_DATA_B3_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">Number</span><span class="p">,</span>
					      <span class="s">&quot;ww&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">Handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="p">(</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_out</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_out</span> <span class="o">==</span> <span class="n">MAX_DATA_B3</span><span class="p">)</span>
					<span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">(</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_pending</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">data_ack</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dword</span> <span class="n">Id</span><span class="p">;</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">NCCI</span> <span class="o">*</span><span class="n">ncci_ptr</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">ncci</span><span class="p">;</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">ncci</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_ncci</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">ncci_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci</span><span class="p">[</span><span class="n">ncci</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_ack_pending</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_plci</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">Id</span> <span class="o">=</span> <span class="p">(((</span><span class="n">dword</span><span class="p">)</span><span class="n">ncci</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">word</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span><span class="p">)</span> <span class="n">Id</span> <span class="o">|=</span> <span class="n">EXT_CONTROLLER</span><span class="p">;</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_DATA_B3_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">DataAck</span><span class="p">[</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_ack_out</span><span class="p">].</span><span class="n">Number</span><span class="p">,</span>
			      <span class="s">&quot;ww&quot;</span><span class="p">,</span> <span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">DataAck</span><span class="p">[</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_ack_out</span><span class="p">].</span><span class="n">Handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="p">(</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_ack_out</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_ack_out</span> <span class="o">==</span> <span class="n">MAX_DATA_ACK</span><span class="p">)</span>
			<span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_ack_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">(</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_ack_pending</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sig_ind</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dword</span> <span class="n">x_Id</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">Id</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">rId</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">cip</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">cip_mask</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">ie</span><span class="p">;</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="n">saved_parms</span><span class="p">[</span><span class="n">MAX_MSG_PARMS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="cp">#define MAXPARMSIDS 31</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">parms</span><span class="p">[</span><span class="n">MAXPARMSIDS</span><span class="p">];</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">add_i</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">multi_fac_parms</span><span class="p">[</span><span class="n">MAX_MULTI_IE</span><span class="p">];</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">multi_pi_parms</span><span class="p">[</span><span class="n">MAX_MULTI_IE</span><span class="p">];</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">multi_ssext_parms</span><span class="p">[</span><span class="n">MAX_MULTI_IE</span><span class="p">];</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">multi_CiPN_parms</span><span class="p">[</span><span class="n">MAX_MULTI_IE</span><span class="p">];</span>

	<span class="n">byte</span> <span class="o">*</span><span class="n">multi_vswitch_parms</span><span class="p">[</span><span class="n">MAX_MULTI_IE</span><span class="p">];</span>

	<span class="n">byte</span> <span class="n">ai_len</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">esc_chi</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">esc_law</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">pty_cai</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">esc_cr</span>  <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">esc_profile</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

	<span class="n">byte</span> <span class="n">facility</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">tplci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">chi</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x02\x18\x01</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">voice_cai</span><span class="p">[]</span>  <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x06\x14\x00\x00\x00\x00\x08</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">resume_cau</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x05\x05\x00\x02\x00\x00</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="cm">/* ESC_MSGTYPE must be the last but one message, a new IE has to be */</span>
	<span class="cm">/* included before the ESC_MSGTYPE and MAXPARMSIDS has to be incremented */</span>
	<span class="cm">/* SMSG is situated at the end because its 0 (for compatibility reasons */</span>
	<span class="cm">/* (see Info_Mask Bit 4, first IE. then the message type)           */</span>
	<span class="n">word</span> <span class="n">parms_id</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span><span class="n">MAXPARMSIDS</span><span class="p">,</span> <span class="n">CPN</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">DSA</span><span class="p">,</span> <span class="n">OSA</span><span class="p">,</span> <span class="n">BC</span><span class="p">,</span> <span class="n">LLC</span><span class="p">,</span> <span class="n">HLC</span><span class="p">,</span> <span class="n">ESC_CAUSE</span><span class="p">,</span> <span class="n">DSP</span><span class="p">,</span> <span class="n">DT</span><span class="p">,</span> <span class="n">CHA</span><span class="p">,</span>
		 <span class="n">UUI</span><span class="p">,</span> <span class="n">CONG_RR</span><span class="p">,</span> <span class="n">CONG_RNR</span><span class="p">,</span> <span class="n">ESC_CHI</span><span class="p">,</span> <span class="n">KEY</span><span class="p">,</span> <span class="n">CHI</span><span class="p">,</span> <span class="n">CAU</span><span class="p">,</span> <span class="n">ESC_LAW</span><span class="p">,</span>
		 <span class="n">RDN</span><span class="p">,</span> <span class="n">RDX</span><span class="p">,</span> <span class="n">CONN_NR</span><span class="p">,</span> <span class="n">RIN</span><span class="p">,</span> <span class="n">NI</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="n">ESC_CR</span><span class="p">,</span>
		 <span class="n">CST</span><span class="p">,</span> <span class="n">ESC_PROFILE</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ESC_MSGTYPE</span><span class="p">,</span> <span class="n">SMSG</span><span class="p">};</span>
	<span class="cm">/* 14 FTY repl by ESC_CHI */</span>
	<span class="cm">/* 18 PI  repl by ESC_LAW */</span>
	<span class="cm">/* removed OAD changed to 0xff for future use, OAD is multiIE now */</span>
	<span class="n">word</span> <span class="n">multi_fac_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="n">FTY</span><span class="p">};</span>
	<span class="n">word</span> <span class="n">multi_pi_id</span><span class="p">[]</span>  <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="n">PI</span><span class="p">};</span>
	<span class="n">word</span> <span class="n">multi_CiPN_id</span><span class="p">[]</span>  <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="n">OAD</span><span class="p">};</span>
	<span class="n">word</span> <span class="n">multi_ssext_id</span><span class="p">[]</span>  <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="n">ESC_SSEXT</span><span class="p">};</span>

	<span class="n">word</span> <span class="n">multi_vswitch_id</span><span class="p">[]</span>  <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="n">ESC_VSWITCH</span><span class="p">};</span>

	<span class="n">byte</span> <span class="o">*</span><span class="n">cau</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">ncci</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">SS_Ind</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x05\x02\x00\x02\x00\x00</span><span class="s">&quot;</span><span class="p">;</span> <span class="cm">/* Hold_Ind struct*/</span>
	<span class="n">byte</span> <span class="n">CF_Ind</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x09\x02\x00\x06\x00\x00\x00\x00\x00\x00</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">Interr_Err_Ind</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x0a\x02\x00\x07\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">CONF_Ind</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x09\x16\x00\x06\x00\x00\0</span><span class="s">x00</span><span class="se">\0</span><span class="s">x00</span><span class="se">\0</span><span class="s">x00</span><span class="se">\0</span><span class="s">x00&quot;</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">force_mt_info</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">dir</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">d</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">w</span><span class="p">;</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">Id</span> <span class="o">=</span> <span class="p">((</span><span class="n">word</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
	<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_remove_id</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">RNR</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* discard */</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;SIG discard while remove pending&quot;</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">!=</span> <span class="n">CALL_HELD</span><span class="p">)</span> <span class="n">Id</span> <span class="o">|=</span> <span class="n">EXT_CONTROLLER</span><span class="p">;</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;SigInd-Id=%08lx,plci=%x,tel=%x,state=0x%x,channels=%d,Discflowcl=%d&quot;</span><span class="p">,</span>
			<span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">hangup_flow_ctrl_timer</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Ind</span> <span class="o">==</span> <span class="n">CALL_HOLD_ACK</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">RNR</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Ind</span> <span class="o">==</span> <span class="n">HANGUP</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">RNR</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">hangup_flow_ctrl_timer</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* recover the network layer after timeout */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">hangup_flow_ctrl_timer</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Exceptional disc&quot;</span><span class="p">));</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">RNR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">hangup_flow_ctrl_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">ncci</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ncci</span> <span class="o">&lt;</span> <span class="n">MAX_NCCI</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ncci</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_plci</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">cleanup_ncci_data</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ncci</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="o">--</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">)</span>
						<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_DISCONNECT_B3_I</span><span class="p">,</span> <span class="p">(((</span><span class="n">dword</span><span class="p">)</span> <span class="n">ncci</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">)</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_DISCONNECT_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* do first parse the info with no OAD in, because OAD will be converted */</span>
	<span class="cm">/* first the multiple facility IE, then mult. progress ind.              */</span>
	<span class="cm">/* then the parameters for the info_ind + conn_ind                       */</span>
	<span class="n">IndParse</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">multi_fac_id</span><span class="p">,</span> <span class="n">multi_fac_parms</span><span class="p">,</span> <span class="n">MAX_MULTI_IE</span><span class="p">);</span>
	<span class="n">IndParse</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">multi_pi_id</span><span class="p">,</span> <span class="n">multi_pi_parms</span><span class="p">,</span> <span class="n">MAX_MULTI_IE</span><span class="p">);</span>
	<span class="n">IndParse</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">multi_ssext_id</span><span class="p">,</span> <span class="n">multi_ssext_parms</span><span class="p">,</span> <span class="n">MAX_MULTI_IE</span><span class="p">);</span>

	<span class="n">IndParse</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">multi_vswitch_id</span><span class="p">,</span> <span class="n">multi_vswitch_parms</span><span class="p">,</span> <span class="n">MAX_MULTI_IE</span><span class="p">);</span>

	<span class="n">IndParse</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">parms_id</span><span class="p">,</span> <span class="n">parms</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">IndParse</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">multi_CiPN_id</span><span class="p">,</span> <span class="n">multi_CiPN_parms</span><span class="p">,</span> <span class="n">MAX_MULTI_IE</span><span class="p">);</span>
	<span class="n">esc_chi</span>  <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
	<span class="n">esc_law</span>  <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>
	<span class="n">pty_cai</span>  <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span>
	<span class="n">esc_cr</span>   <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">25</span><span class="p">];</span>
	<span class="n">esc_profile</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">27</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esc_cr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">cr_enquiry</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">cr_enquiry</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="cm">/* d = MANU_ID            */</span>
			<span class="cm">/* w = m_command          */</span>
			<span class="cm">/* b = total length       */</span>
			<span class="cm">/* b = indication type    */</span>
			<span class="cm">/* b = length of all IEs  */</span>
			<span class="cm">/* b = IE1                */</span>
			<span class="cm">/* S = IE1 length + cont. */</span>
			<span class="cm">/* b = IE2                */</span>
			<span class="cm">/* S = IE2 length + cont. */</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span>
			      <span class="n">_MANUFACTURER_I</span><span class="p">,</span>
			      <span class="n">Id</span><span class="p">,</span>
			      <span class="mi">0</span><span class="p">,</span>
			      <span class="s">&quot;dwbbbbSbS&quot;</span><span class="p">,</span> <span class="n">_DI_MANU_ID</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">m_command</span><span class="p">,</span>
			      <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">esc_cr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">esc_law</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Ind</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">esc_cr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">esc_law</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ESC</span><span class="p">,</span> <span class="n">esc_cr</span><span class="p">,</span> <span class="n">ESC</span><span class="p">,</span> <span class="n">esc_law</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* create the additional info structure                                  */</span>
	<span class="n">add_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span> <span class="cm">/* KEY of additional info */</span>
	<span class="n">add_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span> <span class="cm">/* UUI of additional info */</span>
	<span class="n">ai_len</span> <span class="o">=</span> <span class="n">AddInfo</span><span class="p">(</span><span class="n">add_i</span><span class="p">,</span> <span class="n">multi_fac_parms</span><span class="p">,</span> <span class="n">esc_chi</span><span class="p">,</span> <span class="n">facility</span><span class="p">);</span>

	<span class="cm">/* the ESC_LAW indicates if u-Law or a-Law is actually used by the card  */</span>
	<span class="cm">/* indication returns by the card if requested by the function           */</span>
	<span class="cm">/* AutomaticLaw() after driver init                                      */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">automatic_law</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esc_law</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">esc_law</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;u-Law selected&quot;</span><span class="p">));</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">u_law</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;a-Law selected&quot;</span><span class="p">));</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">u_law</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">automatic_law</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">==</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">automatic_lawPLCI</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">REMOVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">automatic_lawPLCI</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esc_profile</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06x] CardProfile: %lx %lx %lx %lx %lx&quot;</span><span class="p">,</span>
					<span class="n">UnMapController</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">),</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esc_profile</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span>
					<span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esc_profile</span><span class="p">[</span><span class="mi">10</span><span class="p">]),</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esc_profile</span><span class="p">[</span><span class="mi">14</span><span class="p">]),</span>
					<span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esc_profile</span><span class="p">[</span><span class="mi">18</span><span class="p">]),</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esc_profile</span><span class="p">[</span><span class="mi">46</span><span class="p">])));</span>

			<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span> <span class="o">&amp;=</span> <span class="mh">0x000000ffL</span><span class="p">;</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B1_Protocols</span> <span class="o">&amp;=</span> <span class="mh">0x000003ffL</span><span class="p">;</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B2_Protocols</span> <span class="o">&amp;=</span> <span class="mh">0x00001fdfL</span><span class="p">;</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B3_Protocols</span> <span class="o">&amp;=</span> <span class="mh">0x000000b7L</span><span class="p">;</span>

			<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span> <span class="o">&amp;=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esc_profile</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">|</span>
				<span class="n">GL_BCHANNEL_OPERATION_SUPPORTED</span><span class="p">;</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B1_Protocols</span> <span class="o">&amp;=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esc_profile</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B2_Protocols</span> <span class="o">&amp;=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esc_profile</span><span class="p">[</span><span class="mi">14</span><span class="p">]);</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B3_Protocols</span> <span class="o">&amp;=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esc_profile</span><span class="p">[</span><span class="mi">18</span><span class="p">]);</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esc_profile</span><span class="p">[</span><span class="mi">46</span><span class="p">]);</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_ECHO_CANCELLER</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span> <span class="o">|=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_ECHO_CANCELLER</span><span class="p">;</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span> <span class="o">|=</span> <span class="n">GL_ECHO_CANCELLER_SUPPORTED</span><span class="p">;</span>
			<span class="p">}</span>


			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_RTP</span><span class="p">)</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span> <span class="o">|=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_RTP</span><span class="p">;</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">rtp_primary_payloads</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esc_profile</span><span class="p">[</span><span class="mi">50</span><span class="p">]);</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">rtp_additional_payloads</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esc_profile</span><span class="p">[</span><span class="mi">54</span><span class="p">]);</span>


			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_T38</span><span class="p">)</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span> <span class="o">|=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_T38</span><span class="p">;</span>


			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_FAX_SUB_SEP_PWD</span><span class="p">)</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span> <span class="o">|=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_SUB_SEP_PWD</span><span class="p">;</span>


			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_V18</span><span class="p">)</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span> <span class="o">|=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_V18</span><span class="p">;</span>


			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_DTMF_TONE</span><span class="p">)</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span> <span class="o">|=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_DTMF_TONE</span><span class="p">;</span>


			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_PIAFS</span><span class="p">)</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span> <span class="o">|=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_PIAFS</span><span class="p">;</span>


			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_FAX_PAPER_FORMATS</span><span class="p">)</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span> <span class="o">|=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_PAPER_FORMATS</span><span class="p">;</span>


			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_VOWN</span><span class="p">)</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span> <span class="o">|=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_VOWN</span><span class="p">;</span>


			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_FAX_NONSTANDARD</span><span class="p">)</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span> <span class="o">|=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_NONSTANDARD</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span> <span class="o">&amp;=</span> <span class="mh">0x0000007fL</span><span class="p">;</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B1_Protocols</span> <span class="o">&amp;=</span> <span class="mh">0x000003dfL</span><span class="p">;</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B2_Protocols</span> <span class="o">&amp;=</span> <span class="mh">0x00001adfL</span><span class="p">;</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B3_Protocols</span> <span class="o">&amp;=</span> <span class="mh">0x000000b7L</span><span class="p">;</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;=</span> <span class="n">MANUFACTURER_FEATURE_HARDDTMF</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MANUFACTURER_FEATURE_HARDDTMF</span> <span class="o">|</span>
						<span class="n">MANUFACTURER_FEATURE_SOFTDTMF_SEND</span> <span class="o">|</span> <span class="n">MANUFACTURER_FEATURE_SOFTDTMF_RECEIVE</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span> <span class="o">|=</span> <span class="n">GL_DTMF_SUPPORTED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MANUFACTURER_FEATURE_OOB_CHANNEL</span><span class="p">;</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06x] Profile: %lx %lx %lx %lx %lx&quot;</span><span class="p">,</span>
				<span class="n">UnMapController</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">),</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span><span class="p">,</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B1_Protocols</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B2_Protocols</span><span class="p">,</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B3_Protocols</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/* codec plci for the handset/hook state support is just an internal id  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">!=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvCodecPLCI</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">force_mt_info</span> <span class="o">=</span> <span class="n">SendMultiIE</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">multi_fac_parms</span><span class="p">,</span> <span class="n">FTY</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">force_mt_info</span> <span class="o">|=</span> <span class="n">SendMultiIE</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">multi_pi_parms</span><span class="p">,</span> <span class="n">PI</span><span class="p">,</span> <span class="mh">0x210</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">SendSSExtInd</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">multi_ssext_parms</span><span class="p">);</span>
		<span class="n">SendInfo</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">parms</span><span class="p">,</span> <span class="n">force_mt_info</span><span class="p">);</span>

		<span class="n">VSwitchReqInd</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">multi_vswitch_parms</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="cm">/* switch the codec to the b-channel                                     */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esc_chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">b_channel</span> <span class="o">=</span> <span class="n">esc_chi</span><span class="p">[</span><span class="n">esc_chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">mixer_set_bchannel_id_esc</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">b_channel</span><span class="p">);</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;storeChannel=0x%x&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">b_channel</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">ADV_VOICE</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SetVoiceChannel</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvCodecPLCI</span><span class="p">,</span> <span class="n">esc_chi</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">)</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Number</span><span class="o">++</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Ind</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Response to Get_Supported_Services request */</span>
	<span class="k">case</span> <span class="n">S_SUPPORTED</span>:
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;S_Supported&quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CF_Ind</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CF_Ind</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">MASK_TERMINAL_PORTABILITY</span> <span class="o">|</span> <span class="n">MASK_HOLD_RETRIEVE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CF_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CF_Ind</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="s">&quot;wws&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">CF_Ind</span><span class="p">);</span>
		<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Supplementary Service rejected */</span>
	<span class="k">case</span> <span class="n">S_SERVICE_REJ</span>:
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;S_Reject=0x%x&quot;</span><span class="p">,</span> <span class="n">pty_cai</span><span class="p">[</span><span class="mi">5</span><span class="p">]));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">ECT_EXECUTE</span>:
		<span class="k">case</span> <span class="n">THREE_PTY_END</span>:
		<span class="k">case</span> <span class="n">THREE_PTY_BEGIN</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
			<span class="n">tplci</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">;</span>
			<span class="n">rId</span> <span class="o">=</span> <span class="p">((</span><span class="n">word</span><span class="p">)</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tplci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">tel</span><span class="p">)</span> <span class="n">rId</span> <span class="o">|=</span> <span class="n">EXT_CONTROLLER</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="n">ECT_EXECUTE</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_ECT</span><span class="p">);</span>

				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">vswitchstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="o">-&gt;</span><span class="n">vswitchstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pty_cai</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mh">0x3600</span> <span class="o">|</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mh">0x300E</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">rId</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SS_Ind</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CALL_DEFLECTION</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mh">0x3600</span> <span class="o">|</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mh">0x300E</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pty_cai</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_appl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">CDEnable</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Id</span><span class="p">)</span> <span class="n">sendf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SS_Ind</span><span class="p">);</span>
					<span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">CDEnable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DEACTIVATION_DIVERSION</span>:
		<span class="k">case</span> <span class="n">ACTIVATION_DIVERSION</span>:
		<span class="k">case</span> <span class="n">DIVERSION_INTERROGATE_CFU</span>:
		<span class="k">case</span> <span class="n">DIVERSION_INTERROGATE_CFB</span>:
		<span class="k">case</span> <span class="n">DIVERSION_INTERROGATE_CFNR</span>:
		<span class="k">case</span> <span class="n">DIVERSION_INTERROGATE_NUM</span>:
		<span class="k">case</span> <span class="n">CCBS_REQUEST</span>:
		<span class="k">case</span> <span class="n">CCBS_DEACTIVATE</span>:
		<span class="k">case</span> <span class="n">CCBS_INTERROGATE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mh">0x3600</span> <span class="o">|</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mh">0x300E</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
			<span class="p">{</span>
			<span class="k">case</span> <span class="n">DEACTIVATION_DIVERSION</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Deact_Div&quot;</span><span class="p">));</span>
				<span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x9</span><span class="p">;</span>
				<span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">;</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CALL_FORWARDING_STOP</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ACTIVATION_DIVERSION</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Act_Div&quot;</span><span class="p">));</span>
				<span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x9</span><span class="p">;</span>
				<span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">;</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CALL_FORWARDING_START</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DIVERSION_INTERROGATE_CFU</span>:
			<span class="k">case</span> <span class="n">DIVERSION_INTERROGATE_CFB</span>:
			<span class="k">case</span> <span class="n">DIVERSION_INTERROGATE_CFNR</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Interr_Div&quot;</span><span class="p">));</span>
				<span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">;</span>
				<span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">;</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_INTERROGATE_DIVERSION</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DIVERSION_INTERROGATE_NUM</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Interr_Num&quot;</span><span class="p">));</span>
				<span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">;</span>
				<span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">;</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_INTERROGATE_NUMBERS</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CCBS_REQUEST</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;CCBS Request&quot;</span><span class="p">));</span>
				<span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xd</span><span class="p">;</span>
				<span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">;</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CCBS_REQUEST</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CCBS_DEACTIVATE</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;CCBS Deactivate&quot;</span><span class="p">));</span>
				<span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x9</span><span class="p">;</span>
				<span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">;</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CCBS_DEACTIVATE</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CCBS_INTERROGATE</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;CCBS Interrogate&quot;</span><span class="p">));</span>
				<span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xb</span><span class="p">;</span>
				<span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CCBS_INTERROGATE</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Interr_Err_Ind</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">S_Handle</span><span class="p">);</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">Interr_Err_Ind</span><span class="p">);</span>
			<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ACTIVATION_MWI</span>:
		<span class="k">case</span> <span class="n">DEACTIVATION_MWI</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="n">ACTIVATION_MWI</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_MWI_ACTIVATE</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_MWI_DEACTIVATE</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mh">0x3600</span> <span class="o">|</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mh">0x300E</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">cr_enquiry</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SS_Ind</span><span class="p">);</span>
				<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SS_Ind</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CONF_ADD</span>: <span class="cm">/* ERROR */</span>
		<span class="k">case</span> <span class="n">CONF_BEGIN</span>:
		<span class="k">case</span> <span class="n">CONF_DROP</span>:
		<span class="k">case</span> <span class="n">CONF_ISOLATE</span>:
		<span class="k">case</span> <span class="n">CONF_REATTACH</span>:
			<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
			<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
			<span class="p">{</span>
			<span class="k">case</span> <span class="n">CONF_BEGIN</span>:
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CONF_BEGIN</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CONF_DROP</span>:
				<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CONF_DROP</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">=</span> <span class="n">CONNECTED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CONF_ISOLATE</span>:
				<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CONF_ISOLATE</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">=</span> <span class="n">CONNECTED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CONF_REATTACH</span>:
				<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CONF_REATTACH</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">=</span> <span class="n">CONNECTED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CONF_ADD</span>:
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CONF_ADD</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">tplci</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tplci</span><span class="p">)</span> <span class="n">tplci</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">=</span> <span class="n">CONNECTED</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">=</span> <span class="n">CONNECTED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mh">0x3600</span> <span class="o">|</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mh">0x3303</span><span class="p">);</span> <span class="cm">/* Time-out: network did not respond</span>
<span class="cm">								  within the required time */</span>
			<span class="p">}</span>

			<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="mh">0x0</span><span class="p">);</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">CONF_Ind</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Supplementary Service indicates success */</span>
	<span class="k">case</span> <span class="n">S_SERVICE</span>:
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Service_Ind&quot;</span><span class="p">));</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CF_Ind</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">THREE_PTY_END</span>:
		<span class="k">case</span> <span class="n">THREE_PTY_BEGIN</span>:
		<span class="k">case</span> <span class="n">ECT_EXECUTE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
			<span class="n">tplci</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">;</span>
			<span class="n">rId</span> <span class="o">=</span> <span class="p">((</span><span class="n">word</span><span class="p">)</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tplci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">tel</span><span class="p">)</span> <span class="n">rId</span> <span class="o">|=</span> <span class="n">EXT_CONTROLLER</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="n">ECT_EXECUTE</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_ECT</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">vswitchstate</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
				<span class="p">{</span>

					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="p">}</span>

				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;ECT OK&quot;</span><span class="p">));</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">rId</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SS_Ind</span><span class="p">);</span>



			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ptyState</span><span class="p">)</span>
				<span class="p">{</span>
				<span class="k">case</span> <span class="n">S_3PTY_BEGIN</span>:
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">=</span> <span class="n">CONNECTED</span><span class="p">;</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;3PTY ON&quot;</span><span class="p">));</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">S_3PTY_END</span>:
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;3PTY OFF&quot;</span><span class="p">));</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pty_cai</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">rId</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SS_Ind</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CALL_DEFLECTION</span>:
			<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pty_cai</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_appl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">CDEnable</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Id</span><span class="p">)</span> <span class="n">sendf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SS_Ind</span><span class="p">);</span>
					<span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">CDEnable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DEACTIVATION_DIVERSION</span>:
		<span class="k">case</span> <span class="n">ACTIVATION_DIVERSION</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
			<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CF_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pty_cai</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CF_Ind</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">S_Handle</span><span class="p">);</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">CF_Ind</span><span class="p">);</span>
			<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DIVERSION_INTERROGATE_CFU</span>:
		<span class="k">case</span> <span class="n">DIVERSION_INTERROGATE_CFB</span>:
		<span class="k">case</span> <span class="n">DIVERSION_INTERROGATE_CFNR</span>:
		<span class="k">case</span> <span class="n">DIVERSION_INTERROGATE_NUM</span>:
		<span class="k">case</span> <span class="n">CCBS_REQUEST</span>:
		<span class="k">case</span> <span class="n">CCBS_DEACTIVATE</span>:
		<span class="k">case</span> <span class="n">CCBS_INTERROGATE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
			<span class="p">{</span>
			<span class="k">case</span> <span class="n">DIVERSION_INTERROGATE_CFU</span>:
			<span class="k">case</span> <span class="n">DIVERSION_INTERROGATE_CFB</span>:
			<span class="k">case</span> <span class="n">DIVERSION_INTERROGATE_CFNR</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Interr_Div&quot;</span><span class="p">));</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_INTERROGATE_DIVERSION</span><span class="p">);</span>
				<span class="n">pty_cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pty_cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* Supplementary Service-specific parameter len */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DIVERSION_INTERROGATE_NUM</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Interr_Num&quot;</span><span class="p">));</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_INTERROGATE_NUMBERS</span><span class="p">);</span>
				<span class="n">pty_cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pty_cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* Supplementary Service-specific parameter len */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CCBS_REQUEST</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;CCBS Request&quot;</span><span class="p">));</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CCBS_REQUEST</span><span class="p">);</span>
				<span class="n">pty_cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pty_cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* Supplementary Service-specific parameter len */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CCBS_DEACTIVATE</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;CCBS Deactivate&quot;</span><span class="p">));</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CCBS_DEACTIVATE</span><span class="p">);</span>
				<span class="n">pty_cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pty_cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* Supplementary Service-specific parameter len */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CCBS_INTERROGATE</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;CCBS Interrogate&quot;</span><span class="p">));</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CCBS_INTERROGATE</span><span class="p">);</span>
				<span class="n">pty_cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pty_cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* Supplementary Service-specific parameter len */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Supplementary Service Reason */</span>
			<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">S_Handle</span><span class="p">);</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wS&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">pty_cai</span><span class="p">);</span>
			<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ACTIVATION_MWI</span>:
		<span class="k">case</span> <span class="n">DEACTIVATION_MWI</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="n">ACTIVATION_MWI</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_MWI_ACTIVATE</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_MWI_DEACTIVATE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">cr_enquiry</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SS_Ind</span><span class="p">);</span>
				<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SS_Ind</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MWI_INDICATION</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x12</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">S_MWI_INDICATE</span><span class="p">);</span>
				<span class="n">pty_cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pty_cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* len Parameter */</span>
				<span class="n">pty_cai</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">pty_cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* Supplementary Service-specific parameter len */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Notification_Mask</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SMASK_MWI</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">==</span> <span class="n">GET_MWI_STATE</span><span class="p">)</span> <span class="cm">/* result on Message Waiting Listen */</span>
					<span class="p">{</span>
						<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wS&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
						<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
						<span class="k">return</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span> <span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wS&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
					<span class="n">pty_cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_appl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Notification_Mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&amp;</span><span class="n">SMASK_MWI</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="n">sendf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wS&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
							<span class="n">pty_cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="p">{</span> <span class="cm">/* acknowledge */</span>
					<span class="n">facility</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* returncode */</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="n">facility</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="cm">/* reject */</span>
				<span class="n">facility</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* returncode */</span>
			<span class="p">}</span>
			<span class="n">facility</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">facility</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MWI_RESPONSE</span><span class="p">;</span> <span class="cm">/* Function */</span>
			<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="n">facility</span><span class="p">);</span>
			<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ESC</span><span class="p">,</span> <span class="n">multi_ssext_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="cm">/* remembered parameter -&gt; only one possible */</span>
			<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">S_SERVICE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">next_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CONF_ADD</span>: <span class="cm">/* OK */</span>
		<span class="k">case</span> <span class="n">CONF_BEGIN</span>:
		<span class="k">case</span> <span class="n">CONF_DROP</span>:
		<span class="k">case</span> <span class="n">CONF_ISOLATE</span>:
		<span class="k">case</span> <span class="n">CONF_REATTACH</span>:
		<span class="k">case</span> <span class="n">CONF_PARTYDISC</span>:
			<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
			<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
			<span class="p">{</span>
			<span class="k">case</span> <span class="n">CONF_BEGIN</span>:
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CONF_BEGIN</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">d</span> <span class="o">=</span> <span class="n">pty_cai</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
					<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">d</span><span class="p">);</span> <span class="cm">/* PartyID */</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="mh">0x0</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CONF_ISOLATE</span>:
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CONF_ISOLATE</span><span class="p">);</span>
				<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CONF_REATTACH</span>:
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CONF_REATTACH</span><span class="p">);</span>
				<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CONF_DROP</span>:
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CONF_DROP</span><span class="p">);</span>
				<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CONF_ADD</span>:
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CONF_ADD</span><span class="p">);</span>
				<span class="n">d</span> <span class="o">=</span> <span class="n">pty_cai</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
				<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">d</span><span class="p">);</span> <span class="cm">/* PartyID */</span>
				<span class="n">tplci</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tplci</span><span class="p">)</span> <span class="n">tplci</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">=</span> <span class="n">CONNECTED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CONF_PARTYDISC</span>:
				<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
				<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CONF_PARTYDISC</span><span class="p">);</span>
				<span class="n">d</span> <span class="o">=</span> <span class="n">pty_cai</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
				<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">d</span><span class="p">);</span> <span class="cm">/* PartyID */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">=</span> <span class="n">CONNECTED</span><span class="p">;</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">CONF_Ind</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CCBS_INFO_RETAIN</span>:
		<span class="k">case</span> <span class="n">CCBS_ERASECALLLINKAGEID</span>:
		<span class="k">case</span> <span class="n">CCBS_STOP_ALERTING</span>:
			<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">pty_cai</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
			<span class="p">{</span>
			<span class="k">case</span> <span class="n">CCBS_INFO_RETAIN</span>:
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CCBS_INFO_RETAIN</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CCBS_STOP_ALERTING</span>:
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CCBS_STOP_ALERTING</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">CCBS_ERASECALLLINKAGEID</span>:
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_CCBS_ERASECALLLINKAGEID</span><span class="p">);</span>
				<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
				<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">w</span> <span class="o">=</span> <span class="n">pty_cai</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
			<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONF_Ind</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">w</span><span class="p">);</span> <span class="cm">/* PartyID */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Notification_Mask</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SMASK_CCBS</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">CONF_Ind</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_appl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Notification_Mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SMASK_CCBS</span><span class="p">)</span>
						<span class="n">sendf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">CONF_Ind</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CALL_HOLD_REJ</span>:
		<span class="n">cau</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cau</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">_L3_CAUSE</span> <span class="o">|</span> <span class="n">cau</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cau</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x3603</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mh">0x3603</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_HOLD</span><span class="p">);</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">==</span> <span class="n">HOLD_REQUEST</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SS_Ind</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CALL_HOLD_ACK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">==</span> <span class="n">HOLD_REQUEST</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">=</span> <span class="n">CALL_HELD</span><span class="p">;</span>
			<span class="n">CodecIdCheck</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
			<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">hold_save_command</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CALL_RETRIEVE_REJ</span>:
		<span class="n">cau</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cau</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">_L3_CAUSE</span> <span class="o">|</span> <span class="n">cau</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cau</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x3603</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mh">0x3603</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_RETRIEVE</span><span class="p">);</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">==</span> <span class="n">RETRIEVE_REQUEST</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">=</span> <span class="n">CALL_HELD</span><span class="p">;</span>
			<span class="n">CodecIdCheck</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SS_Ind</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CALL_RETRIEVE_ACK</span>:
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SS_Ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">S_RETRIEVE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">==</span> <span class="n">RETRIEVE_REQUEST</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">|=</span> <span class="n">CALL_DIR_FORCE_OUTG_NL</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">b_channel</span> <span class="o">=</span> <span class="n">esc_chi</span><span class="p">[</span><span class="n">esc_chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">mixer_set_bchannel_id_esc</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">b_channel</span><span class="p">);</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;RetrChannel=0x%x&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">b_channel</span><span class="p">));</span>
				<span class="n">SetVoiceChannel</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvCodecPLCI</span><span class="p">,</span> <span class="n">esc_chi</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">==</span> <span class="n">B2_TRANSPARENT</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="n">B3_TRANSPARENT</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Get B-ch&quot;</span><span class="p">));</span>
					<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">retrieve_restore_command</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SS_Ind</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">retrieve_restore_command</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">INDICATE_IND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">!=</span> <span class="n">LISTENING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">HANGUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cip</span> <span class="o">=</span> <span class="n">find_cip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">parms</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">parms</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
		<span class="n">cip_mask</span> <span class="o">=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">cip</span><span class="p">;</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;cip=%d,cip_mask=%lx&quot;</span><span class="p">,</span> <span class="n">cip</span><span class="p">,</span> <span class="n">cip_mask</span><span class="p">));</span>
		<span class="n">clear_c_ind_mask</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">remove_started</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_disabled</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">set_c_ind_mask_bit</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">MAX_APPL</span><span class="p">);</span>
			<span class="n">group_optimization</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_appl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Id</span>
				    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">CIP_Mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">CIP_Mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">cip_mask</span><span class="p">)</span>
				    <span class="o">&amp;&amp;</span> <span class="n">CPN_filter_ok</span><span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
				    <span class="o">&amp;&amp;</span> <span class="n">test_group_ind_mask_bit</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;storedcip_mask[%d]=0x%lx&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">CIP_Mask</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
					<span class="n">set_c_ind_mask_bit</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="n">dump_c_ind_mask</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">INC_CON_PENDING</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">CALL_DIR_OUT</span> <span class="o">|</span> <span class="n">CALL_DIR_ORIGINATE</span><span class="p">))</span> <span class="o">|</span>
						<span class="n">CALL_DIR_IN</span> <span class="o">|</span> <span class="n">CALL_DIR_ANSWER</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">esc_chi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">b_channel</span> <span class="o">=</span> <span class="n">esc_chi</span><span class="p">[</span><span class="n">esc_chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
						<span class="n">mixer_set_bchannel_id_esc</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">b_channel</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="cm">/* if a listen on the ext controller is done, check if hook states */</span>
					<span class="cm">/* are supported or if just a on board codec must be activated     */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">codec_listen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span> <span class="o">&amp;</span> <span class="n">HANDSET</span><span class="p">)</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">=</span> <span class="n">ADV_VOICE</span><span class="p">;</span>
						<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span> <span class="o">&amp;</span> <span class="n">ON_BOARD_CODEC</span><span class="p">)</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">=</span> <span class="n">CODEC</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span><span class="p">)</span> <span class="n">Id</span> <span class="o">|=</span> <span class="n">EXT_CONTROLLER</span><span class="p">;</span>
						<span class="n">a</span><span class="o">-&gt;</span><span class="n">codec_listen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">sendf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_CONNECT_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					      <span class="s">&quot;wSSSSSSSbSSSSS&quot;</span><span class="p">,</span> <span class="n">cip</span><span class="p">,</span>    <span class="cm">/* CIP                 */</span>
					      <span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>    <span class="cm">/* CalledPartyNumber   */</span>
					      <span class="n">multi_CiPN_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>    <span class="cm">/* CallingPartyNumber  */</span>
					      <span class="n">parms</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>    <span class="cm">/* CalledPartySubad    */</span>
					      <span class="n">parms</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>    <span class="cm">/* CallingPartySubad   */</span>
					      <span class="n">parms</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>    <span class="cm">/* BearerCapability    */</span>
					      <span class="n">parms</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>    <span class="cm">/* LowLC               */</span>
					      <span class="n">parms</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>    <span class="cm">/* HighLC              */</span>
					      <span class="n">ai_len</span><span class="p">,</span>      <span class="cm">/* nested struct add_i */</span>
					      <span class="n">add_i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>    <span class="cm">/* B channel info    */</span>
					      <span class="n">add_i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>    <span class="cm">/* keypad facility   */</span>
					      <span class="n">add_i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>    <span class="cm">/* user user data    */</span>
					      <span class="n">add_i</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>    <span class="cm">/* nested facility   */</span>
					      <span class="n">multi_CiPN_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>    <span class="cm">/* second CiPN(SCR)   */</span>
						<span class="p">);</span>
					<span class="n">SendSSExtInd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						     <span class="n">plci</span><span class="p">,</span>
						     <span class="n">Id</span><span class="p">,</span>
						     <span class="n">multi_ssext_parms</span><span class="p">);</span>
					<span class="n">SendSetupInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						      <span class="n">plci</span><span class="p">,</span>
						      <span class="n">Id</span><span class="p">,</span>
						      <span class="n">parms</span><span class="p">,</span>
						      <span class="n">SendMultiIE</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">multi_pi_parms</span><span class="p">,</span> <span class="n">PI</span><span class="p">,</span> <span class="mh">0x210</span><span class="p">,</span> <span class="nb">true</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">clear_c_ind_mask_bit</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">MAX_APPL</span><span class="p">);</span>
			<span class="n">dump_c_ind_mask</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c_ind_mask_empty</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">HANGUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">notifiedcall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">listen_active</span><span class="o">--</span><span class="p">;</span>
		<span class="n">listen_check</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CALL_PEND_NOTIFY</span>:
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">notifiedcall</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">listen_check</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CALL_IND</span>:
	<span class="k">case</span> <span class="n">CALL_CON</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">ADVANCED_VOICE_SIG</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">ADVANCED_VOICE_NOSIG</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">==</span> <span class="n">PERM_COD_CONN_PEND</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">ADVANCED_VOICE_NOSIG</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;***Codec OK&quot;</span><span class="p">));</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">tplci</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">spoofed_msg</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;***Spoofed Msg(0x%x)&quot;</span><span class="p">,</span> <span class="n">tplci</span><span class="o">-&gt;</span><span class="n">spoofed_msg</span><span class="p">));</span>
							<span class="n">tplci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="n">tplci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="n">x_Id</span> <span class="o">=</span> <span class="p">((</span><span class="n">word</span><span class="p">)</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tplci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
							<span class="k">switch</span> <span class="p">(</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">spoofed_msg</span><span class="p">)</span>
							<span class="p">{</span>
							<span class="k">case</span> <span class="n">CALL_RES</span>:
								<span class="n">tplci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">_CONNECT_I</span> <span class="o">|</span> <span class="n">RESPONSE</span><span class="p">;</span>
								<span class="n">api_load_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">saved_msg</span><span class="p">,</span> <span class="n">saved_parms</span><span class="p">);</span>
								<span class="n">add_b1</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saved_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tplci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span><span class="p">);</span>
								<span class="k">if</span> <span class="p">(</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Info_Mask</span><span class="p">[</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span>
								<span class="p">{</span>
									<span class="cm">/* early B3 connect (CIP mask bit 9) no release after a disc */</span>
									<span class="n">add_p</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="n">LLI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x01</span><span class="s">&quot;</span><span class="p">);</span>
								<span class="p">}</span>
								<span class="n">add_s</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="n">CONN_NR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saved_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
								<span class="n">add_s</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="n">LLC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saved_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
								<span class="n">add_ai</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saved_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
								<span class="n">tplci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">INC_CON_ACCEPT</span><span class="p">;</span>
								<span class="n">sig_req</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="n">CALL_RES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
								<span class="n">send_req</span><span class="p">(</span><span class="n">tplci</span><span class="p">);</span>
								<span class="k">break</span><span class="p">;</span>

							<span class="k">case</span> <span class="n">AWAITING_SELECT_B</span>:
								<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Select_B continue&quot;</span><span class="p">));</span>
								<span class="n">start_internal_command</span><span class="p">(</span><span class="n">x_Id</span><span class="p">,</span> <span class="n">tplci</span><span class="p">,</span> <span class="n">select_b_command</span><span class="p">);</span>
								<span class="k">break</span><span class="p">;</span>

							<span class="k">case</span> <span class="n">AWAITING_MANUF_CON</span>: <span class="cm">/* Get_Plci per Manufacturer_Req to ext controller */</span>
								<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span>
								<span class="p">{</span>
									<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;No SigID!&quot;</span><span class="p">));</span>
									<span class="n">sendf</span><span class="p">(</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_MANUFACTURER_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">x_Id</span><span class="p">,</span> <span class="n">tplci</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="s">&quot;dww&quot;</span><span class="p">,</span> <span class="n">_DI_MANU_ID</span><span class="p">,</span> <span class="n">_MANUFACTURER_R</span><span class="p">,</span> <span class="n">_OUT_OF_PLCI</span><span class="p">);</span>
									<span class="n">plci_remove</span><span class="p">(</span><span class="n">tplci</span><span class="p">);</span>
									<span class="k">break</span><span class="p">;</span>
								<span class="p">}</span>
								<span class="n">tplci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">_MANUFACTURER_R</span><span class="p">;</span>
								<span class="n">api_load_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">saved_msg</span><span class="p">,</span> <span class="n">saved_parms</span><span class="p">);</span>
								<span class="n">dir</span> <span class="o">=</span> <span class="n">saved_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
								<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
									<span class="n">sig_req</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="n">CALL_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
								<span class="p">}</span>
								<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
									<span class="n">sig_req</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="n">LISTEN_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
								<span class="p">}</span>
								<span class="n">send_req</span><span class="p">(</span><span class="n">tplci</span><span class="p">);</span>
								<span class="n">sendf</span><span class="p">(</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_MANUFACTURER_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">x_Id</span><span class="p">,</span> <span class="n">tplci</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="s">&quot;dww&quot;</span><span class="p">,</span> <span class="n">_DI_MANU_ID</span><span class="p">,</span> <span class="n">_MANUFACTURER_R</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
								<span class="k">break</span><span class="p">;</span>

							<span class="k">case</span> <span class="p">(</span><span class="n">CALL_REQ</span> <span class="o">|</span> <span class="n">AWAITING_MANUF_CON</span><span class="p">)</span>:
								<span class="n">sig_req</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="n">CALL_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
								<span class="n">send_req</span><span class="p">(</span><span class="n">tplci</span><span class="p">);</span>
								<span class="k">break</span><span class="p">;</span>

							<span class="k">case</span> <span class="n">CALL_REQ</span>:
								<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span>
								<span class="p">{</span>
									<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;No SigID!&quot;</span><span class="p">));</span>
									<span class="n">sendf</span><span class="p">(</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">tplci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">_OUT_OF_PLCI</span><span class="p">);</span>
									<span class="n">plci_remove</span><span class="p">(</span><span class="n">tplci</span><span class="p">);</span>
									<span class="k">break</span><span class="p">;</span>
								<span class="p">}</span>
								<span class="n">tplci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">_CONNECT_R</span><span class="p">;</span>
								<span class="n">api_load_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">saved_msg</span><span class="p">,</span> <span class="n">saved_parms</span><span class="p">);</span>
								<span class="n">add_s</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="n">CPN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saved_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
								<span class="n">add_s</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="n">DSA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saved_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
								<span class="n">add_ai</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saved_parms</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
								<span class="n">sig_req</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="n">CALL_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
								<span class="n">send_req</span><span class="p">(</span><span class="n">tplci</span><span class="p">);</span>
								<span class="k">break</span><span class="p">;</span>

							<span class="k">case</span> <span class="n">CALL_RETRIEVE</span>:
								<span class="n">tplci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">C_RETRIEVE_REQ</span><span class="p">;</span>
								<span class="n">sig_req</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="n">CALL_RETRIEVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
								<span class="n">send_req</span><span class="p">(</span><span class="n">tplci</span><span class="p">);</span>
								<span class="k">break</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="n">tplci</span><span class="o">-&gt;</span><span class="n">spoofed_msg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
								<span class="n">next_internal_command</span><span class="p">(</span><span class="n">x_Id</span><span class="p">,</span> <span class="n">tplci</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="n">next_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;***Codec Hook Init Req&quot;</span><span class="p">));</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">PERM_COD_HOOK</span><span class="p">;</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">FTY</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x09</span><span class="s">&quot;</span><span class="p">);</span>             <span class="cm">/* Get Hook State*/</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">TEL_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">!=</span> <span class="n">_MANUFACTURER_R</span>  <span class="cm">/* old style permanent connect */</span>
			 <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">!=</span> <span class="n">INC_ACT_PENDING</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">mixer_set_bchannel_id_esc</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">b_channel</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">ADV_VOICE</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">==</span> <span class="n">IDLE</span><span class="p">)</span> <span class="cm">/* with permanent codec switch on immediately */</span>
			<span class="p">{</span>
				<span class="n">chi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">b_channel</span><span class="p">;</span>
				<span class="n">SetVoiceChannel</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvCodecPLCI</span><span class="p">,</span> <span class="n">chi</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_ACTIVE_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Sss&quot;</span><span class="p">,</span> <span class="n">parms</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">INC_ACT_PENDING</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TEL_CTRL</span>:
		<span class="n">ie</span> <span class="o">=</span> <span class="n">multi_fac_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cm">/* inspect the facility hook indications */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">ADVANCED_VOICE_SIG</span> <span class="o">&amp;&amp;</span> <span class="n">ie</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x91</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x80</span>:   <span class="cm">/* hook off */</span>
			<span class="k">case</span> <span class="mh">0x81</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">==</span> <span class="n">PERM_COD_HOOK</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;init:hook_off&quot;</span><span class="p">));</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">hook_state</span> <span class="o">=</span> <span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
					<span class="n">next_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="cm">/* ignore doubled hook indications */</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">hook_state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;ignore hook&quot;</span><span class="p">));</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">hook_state</span> <span class="o">=</span> <span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x91</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* check for incoming call pending */</span>
				<span class="cm">/* and signal &#39;+&#39;.Appl must decide */</span>
				<span class="cm">/* with connect_res if call must   */</span>
				<span class="cm">/* accepted or not                 */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tplci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_appl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">codec_listen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">codec_listen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_CON_PENDING</span>
						<span class="o">||</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">codec_listen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_CON_ALERT</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">tplci</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">codec_listen</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
						<span class="n">tplci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="cm">/* no incoming call, do outgoing call */</span>
				<span class="cm">/* and signal &#39;+&#39; if outg. setup   */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tplci</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">get_plci</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span> <span class="p">{</span>
						<span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
						<span class="n">tplci</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">;</span>
						<span class="n">tplci</span><span class="o">-&gt;</span><span class="n">tel</span>  <span class="o">=</span> <span class="n">ADV_VOICE</span><span class="p">;</span>
						<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">voice_cai</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalAppl</span><span class="o">-&gt;</span><span class="n">MaxDataLength</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Info_Mask</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalAppl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="p">{</span>
							<span class="cm">/* early B3 connect (CIP mask bit 9) no release after a disc */</span>
							<span class="n">add_p</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="n">LLI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x01</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="n">voice_cai</span><span class="p">);</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="n">OAD</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">TelOAD</span><span class="p">);</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="n">OSA</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">TelOSA</span><span class="p">);</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="n">SHIFT</span> <span class="o">|</span> <span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="n">SIN</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x02\x01\x00</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="n">UID</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x06\x43\x61\x70\x69\x32\x30</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">sig_req</span><span class="p">(</span><span class="n">tplci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="n">DSIG_ID</span><span class="p">);</span>
						<span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">HOOK_OFF_REQ</span><span class="p">;</span>
						<span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">tplci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalAppl</span><span class="p">;</span>
						<span class="n">tplci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">=</span> <span class="n">CALL_DIR_OUT</span> <span class="o">|</span> <span class="n">CALL_DIR_ORIGINATE</span><span class="p">;</span>
						<span class="n">send_req</span><span class="p">(</span><span class="n">tplci</span><span class="p">);</span>
					<span class="p">}</span>

				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tplci</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
				<span class="n">Id</span> <span class="o">=</span> <span class="p">((</span><span class="n">word</span><span class="p">)</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
				<span class="n">Id</span> <span class="o">|=</span> <span class="n">EXT_CONTROLLER</span><span class="p">;</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">tplci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span>
				      <span class="n">_FACILITY_I</span><span class="p">,</span>
				      <span class="n">Id</span><span class="p">,</span>
				      <span class="mi">0</span><span class="p">,</span>
				      <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01</span><span class="s">+&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="mh">0x90</span>:   <span class="cm">/* hook on  */</span>
			<span class="k">case</span> <span class="mh">0x91</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">==</span> <span class="n">PERM_COD_HOOK</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;init:hook_on&quot;</span><span class="p">));</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">hook_state</span> <span class="o">=</span> <span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x91</span><span class="p">;</span>
					<span class="n">next_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="cm">/* ignore doubled hook indications */</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">hook_state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x90</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">hook_state</span> <span class="o">=</span> <span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x91</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* hangup the adv. voice call and signal &#39;-&#39; to the appl */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">Id</span> <span class="o">=</span> <span class="p">((</span><span class="n">word</span><span class="p">)</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span><span class="p">)</span> <span class="n">Id</span> <span class="o">|=</span> <span class="n">EXT_CONTROLLER</span><span class="p">;</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalAppl</span><span class="p">,</span>
					      <span class="n">_FACILITY_I</span><span class="p">,</span>
					      <span class="n">Id</span><span class="p">,</span>
					      <span class="mi">0</span><span class="p">,</span>
					      <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01</span><span class="s">-&quot;</span><span class="p">);</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">HOOK_ON_REQ</span><span class="p">;</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">sig_req</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">,</span> <span class="n">HANGUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">send_req</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RESUME</span>:
		<span class="n">clear_c_ind_mask_bit</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resume_cau</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">GOOD</span><span class="p">);</span>
		<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="mi">3</span><span class="p">,</span> <span class="n">resume_cau</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SUSPEND</span>:
		<span class="n">clear_c_ind_mask</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mixer_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">REMOVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_remove_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">REMOVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x05\x04\x00\x02\x00\x00</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_DISCONNECT_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SUSPEND_REJ</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HANGUP</span>:
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">hangup_flow_ctrl_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">manufacturer</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">LOCAL_CONNECT</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="n">cau</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cau</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">_L3_CAUSE</span> <span class="o">|</span> <span class="n">cau</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cau</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cau</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="n">i</span> <span class="o">=</span> <span class="n">_L1_ERROR</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cau</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">9</span> <span class="o">||</span> <span class="n">cau</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="n">i</span> <span class="o">=</span> <span class="n">_L2_ERROR</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cau</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="n">i</span> <span class="o">=</span> <span class="n">_CAPI_GUARD_ERROR</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">_L3_ERROR</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_CON_PENDING</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_CON_ALERT</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_appl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_c_ind_mask_bit</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
					<span class="n">sendf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_DISCONNECT_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">clear_c_ind_mask</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">LISTENING</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">notifiedcall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">listen_active</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">INC_DIS_PENDING</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c_ind_mask_empty</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">mixer_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
					<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">REMOVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_remove_id</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">REMOVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="cm">/* collision of DISCONNECT or CONNECT_RES with HANGUP can   */</span>
			<span class="cm">/* result in a second HANGUP! Don&#39;t generate another        */</span>
			<span class="cm">/* DISCONNECT                                               */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">!=</span> <span class="n">IDLE</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">!=</span> <span class="n">INC_DIS_PENDING</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">RESUMING</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resume_cau</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">i</span><span class="p">);</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="mi">3</span><span class="p">,</span> <span class="n">resume_cau</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">INC_DIS_PENDING</span><span class="p">;</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_DISCONNECT_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SSEXT_IND</span>:
		<span class="n">SendSSExtInd</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">multi_ssext_parms</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VSWITCH_REQ</span>:
		<span class="n">VSwitchReqInd</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">multi_vswitch_parms</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VSWITCH_IND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span> <span class="o">&amp;&amp;</span>
		    <span class="n">plci</span><span class="o">-&gt;</span><span class="n">vswitchstate</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
		    <span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="o">-&gt;</span><span class="n">vswitchstate</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
		    <span class="n">parms</span><span class="p">[</span><span class="n">MAXPARMSIDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
		<span class="p">{</span>
			<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">,</span> <span class="n">SMSG</span><span class="p">,</span> <span class="n">parms</span><span class="p">[</span><span class="n">MAXPARMSIDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
			<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">,</span> <span class="n">VSWITCH_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="n">VSwitchReqInd</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">multi_vswitch_parms</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">SendSetupInfo</span><span class="p">(</span><span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">byte</span> <span class="o">**</span><span class="n">parms</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Info_Sent_Flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">ie</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">Info_Number</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">Info_Element</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">Info_Mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;SetupInfo&quot;</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXPARMSIDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ie</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">Info_Number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">Info_Element</span> <span class="o">=</span> <span class="n">ie</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ie</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;CPN &quot;</span><span class="p">));</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="mh">0x0070</span><span class="p">;</span>
				<span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="n">Info_Sent_Flag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">8</span>:  <span class="cm">/* display      */</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;display(%d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="mh">0x0028</span><span class="p">;</span>
				<span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
				<span class="n">Info_Sent_Flag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">16</span>: <span class="cm">/* Channel Id */</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;CHI&quot;</span><span class="p">));</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="mh">0x0018</span><span class="p">;</span>
				<span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
				<span class="n">Info_Sent_Flag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">mixer_set_bchannel_id</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">Info_Element</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">19</span>: <span class="cm">/* Redirected Number */</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;RDN&quot;</span><span class="p">));</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="mh">0x0074</span><span class="p">;</span>
				<span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">;</span>
				<span class="n">Info_Sent_Flag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">20</span>: <span class="cm">/* Redirected Number extended */</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;RDX&quot;</span><span class="p">));</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="mh">0x0073</span><span class="p">;</span>
				<span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">;</span>
				<span class="n">Info_Sent_Flag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">22</span>: <span class="cm">/* Redirecing Number  */</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;RIN&quot;</span><span class="p">));</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="mh">0x0076</span><span class="p">;</span>
				<span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">;</span>
				<span class="n">Info_Sent_Flag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MAXPARMSIDS</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* to indicate the message type &quot;Setup&quot; */</span>
			<span class="n">Info_Number</span> <span class="o">=</span> <span class="mh">0x8000</span> <span class="o">|</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="n">Info_Element</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Info_Sent_Flag</span> <span class="o">&amp;&amp;</span> <span class="n">Info_Number</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Info_Mask</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">Info_Mask</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_INFO_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wS&quot;</span><span class="p">,</span> <span class="n">Info_Number</span><span class="p">,</span> <span class="n">Info_Element</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">SendInfo</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">byte</span> <span class="o">**</span><span class="n">parms</span><span class="p">,</span> <span class="n">byte</span> <span class="n">iesent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">k</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">ie</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">Info_Number</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">Info_Element</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">Info_Mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">byte</span> <span class="n">charges</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="k">static</span> <span class="n">byte</span> <span class="n">cause</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
	<span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;InfoParse &quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span>
		<span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span>
		<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span>
		<span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Ind</span> <span class="o">!=</span> <span class="n">NCR_FACILITY</span>
		<span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;NoParse &quot;</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cause</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXPARMSIDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ie</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">Info_Number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">Info_Element</span> <span class="o">=</span> <span class="n">ie</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ie</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;CPN &quot;</span><span class="p">));</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="mh">0x0070</span><span class="p">;</span>
				<span class="n">Info_Mask</span>   <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">7</span>: <span class="cm">/* ESC_CAU */</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;cau(0x%x)&quot;</span><span class="p">,</span> <span class="n">ie</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="mh">0x0008</span><span class="p">;</span>
				<span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="n">cause</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ie</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
				<span class="n">Info_Element</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">8</span>:  <span class="cm">/* display      */</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;display(%d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="mh">0x0028</span><span class="p">;</span>
				<span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">9</span>:  <span class="cm">/* Date display */</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;date(%d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="mh">0x0029</span><span class="p">;</span>
				<span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">10</span>: <span class="cm">/* charges */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="n">charges</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ie</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ie</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ie</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="n">charges</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ie</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>
				<span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
				<span class="n">Info_Element</span> <span class="o">=</span> <span class="n">charges</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">11</span>: <span class="cm">/* user user info */</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;uui&quot;</span><span class="p">));</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="mh">0x007E</span><span class="p">;</span>
				<span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">12</span>: <span class="cm">/* congestion receiver ready */</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;clRDY&quot;</span><span class="p">));</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="mh">0x00B0</span><span class="p">;</span>
				<span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
				<span class="n">Info_Element</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">13</span>: <span class="cm">/* congestion receiver not ready */</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;clNRDY&quot;</span><span class="p">));</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="mh">0x00BF</span><span class="p">;</span>
				<span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
				<span class="n">Info_Element</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">15</span>: <span class="cm">/* Keypad Facility */</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;KEY&quot;</span><span class="p">));</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="mh">0x002C</span><span class="p">;</span>
				<span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">16</span>: <span class="cm">/* Channel Id */</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;CHI&quot;</span><span class="p">));</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="mh">0x0018</span><span class="p">;</span>
				<span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
				<span class="n">mixer_set_bchannel_id</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">Info_Element</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">17</span>: <span class="cm">/* if no 1tr6 cause, send full cause, else esc_cause */</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;q9cau(0x%x)&quot;</span><span class="p">,</span> <span class="n">ie</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cause</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="n">cause</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* eg. layer 1 error */</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="mh">0x0008</span><span class="p">;</span>
				<span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cause</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ie</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="n">Info_Element</span> <span class="o">=</span> <span class="n">cause</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">19</span>: <span class="cm">/* Redirected Number */</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;RDN&quot;</span><span class="p">));</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="mh">0x0074</span><span class="p">;</span>
				<span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">22</span>: <span class="cm">/* Redirecing Number  */</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;RIN&quot;</span><span class="p">));</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="mh">0x0076</span><span class="p">;</span>
				<span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">23</span>: <span class="cm">/* Notification Indicator  */</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;NI&quot;</span><span class="p">));</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">NI</span><span class="p">;</span>
				<span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x210</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">26</span>: <span class="cm">/* Call State  */</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;CST&quot;</span><span class="p">));</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">CST</span><span class="p">;</span>
				<span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* do with cause i.e. for now */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MAXPARMSIDS</span> <span class="o">-</span> <span class="mi">2</span>:  <span class="cm">/* Escape Message Type, must be the last indication */</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;ESC/MT[0x%x]&quot;</span><span class="p">,</span> <span class="n">ie</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>
				<span class="n">Info_Number</span> <span class="o">=</span> <span class="mh">0x8000</span> <span class="o">|</span> <span class="n">ie</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">iesent</span><span class="p">)</span> <span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
				<span class="k">else</span>  <span class="n">Info_Mask</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
				<span class="n">Info_Element</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">Info_Number</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">Info_Mask</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">Info_Element</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Ind</span> <span class="o">==</span> <span class="n">NCR_FACILITY</span><span class="p">)</span>           <span class="cm">/* check controller broadcast */</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">max_appl</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">appl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Info_Number</span>
				    <span class="o">&amp;&amp;</span> <span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span>
				    <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Info_Mask</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">Info_Mask</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;NCR_Ind&quot;</span><span class="p">));</span>
					<span class="n">iesent</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">sendf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">_INFO_I</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wS&quot;</span><span class="p">,</span> <span class="n">Info_Number</span><span class="p">,</span> <span class="n">Info_Element</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">)</span>
		<span class="p">{</span> <span class="cm">/* overlap receiving broadcast */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Info_Number</span> <span class="o">==</span> <span class="n">CPN</span>
			    <span class="o">||</span> <span class="n">Info_Number</span> <span class="o">==</span> <span class="n">KEY</span>
			    <span class="o">||</span> <span class="n">Info_Number</span> <span class="o">==</span> <span class="n">NI</span>
			    <span class="o">||</span> <span class="n">Info_Number</span> <span class="o">==</span> <span class="n">DSP</span>
			    <span class="o">||</span> <span class="n">Info_Number</span> <span class="o">==</span> <span class="n">UUI</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">max_appl</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">test_c_ind_mask_bit</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Ovl_Ind&quot;</span><span class="p">));</span>
						<span class="n">iesent</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
						<span class="n">sendf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">_INFO_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wS&quot;</span><span class="p">,</span> <span class="n">Info_Number</span><span class="p">,</span> <span class="n">Info_Element</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>               <span class="cm">/* all other signalling states */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Info_Number</span>
			 <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Info_Mask</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">Info_Mask</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Std_Ind&quot;</span><span class="p">));</span>
			<span class="n">iesent</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_INFO_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wS&quot;</span><span class="p">,</span> <span class="n">Info_Number</span><span class="p">,</span> <span class="n">Info_Element</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">byte</span> <span class="nf">SendMultiIE</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">byte</span> <span class="o">**</span><span class="n">parms</span><span class="p">,</span> <span class="n">byte</span> <span class="n">ie_type</span><span class="p">,</span>
			<span class="n">dword</span> <span class="n">info_mask</span><span class="p">,</span> <span class="n">byte</span> <span class="n">setupParse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">ie</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">Info_Number</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">Info_Element</span><span class="p">;</span>
	<span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">Info_Mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">iesent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span>
		<span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span>
		<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span>
		<span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Ind</span> <span class="o">!=</span> <span class="n">NCR_FACILITY</span>
		<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">setupParse</span>
		<span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;NoM-IEParse &quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;M-IEParse &quot;</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_MULTI_IE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">ie</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">Info_Number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">Info_Element</span> <span class="o">=</span> <span class="n">ie</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ie</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[Ind0x%x]:IE=0x%x&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Ind</span><span class="p">,</span> <span class="n">ie_type</span><span class="p">));</span>
			<span class="n">Info_Number</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">ie_type</span><span class="p">;</span>
			<span class="n">Info_Mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">info_mask</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Ind</span> <span class="o">==</span> <span class="n">NCR_FACILITY</span><span class="p">)</span>           <span class="cm">/* check controller broadcast */</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">max_appl</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">appl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Info_Number</span>
				    <span class="o">&amp;&amp;</span> <span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span>
				    <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Info_Mask</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">Info_Mask</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">iesent</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Mlt_NCR_Ind&quot;</span><span class="p">));</span>
					<span class="n">sendf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">_INFO_I</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wS&quot;</span><span class="p">,</span> <span class="n">Info_Number</span><span class="p">,</span> <span class="n">Info_Element</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">&amp;&amp;</span> <span class="n">Info_Number</span><span class="p">)</span>
		<span class="p">{</span>                                        <span class="cm">/* overlap receiving broadcast */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">max_appl</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_c_ind_mask_bit</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">iesent</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Mlt_Ovl_Ind&quot;</span><span class="p">));</span>
					<span class="n">sendf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">,</span> <span class="n">_INFO_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wS&quot;</span><span class="p">,</span> <span class="n">Info_Number</span><span class="p">,</span> <span class="n">Info_Element</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>                                        <span class="cm">/* all other signalling states */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Info_Number</span>
			 <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Info_Mask</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">Info_Mask</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">iesent</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Mlt_Std_Ind&quot;</span><span class="p">));</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_INFO_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wS&quot;</span><span class="p">,</span> <span class="n">Info_Number</span><span class="p">,</span> <span class="n">Info_Element</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">iesent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">SendSSExtInd</span><span class="p">(</span><span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">byte</span> <span class="o">**</span><span class="n">parms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="cm">/* Format of multi_ssext_parms[i][]:</span>
<span class="cm">	   0 byte length</span>
<span class="cm">	   1 byte SSEXTIE</span>
<span class="cm">	   2 byte SSEXT_REQ/SSEXT_IND</span>
<span class="cm">	   3 byte length</span>
<span class="cm">	   4 word SSExtCommand</span>
<span class="cm">	   6... Params</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span>
		<span class="n">plci</span>
		<span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span>
		<span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Ind</span> <span class="o">!=</span> <span class="n">NCR_FACILITY</span>
		<span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_MULTI_IE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">SSEXT_REQ</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">appl</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* kill it */</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_MANUFACTURER_I</span><span class="p">,</span>
				      <span class="n">Id</span><span class="p">,</span>
				      <span class="mi">0</span><span class="p">,</span>
				      <span class="s">&quot;dwS&quot;</span><span class="p">,</span>
				      <span class="n">_DI_MANU_ID</span><span class="p">,</span>
				      <span class="n">_DI_SSEXT_CTRL</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* kill it */</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_MANUFACTURER_I</span><span class="p">,</span>
				      <span class="n">Id</span><span class="p">,</span>
				      <span class="mi">0</span><span class="p">,</span>
				      <span class="s">&quot;dwS&quot;</span><span class="p">,</span>
				      <span class="n">_DI_MANU_ID</span><span class="p">,</span>
				      <span class="n">_DI_SSEXT_CTRL</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nl_ind</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">byte</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">ncci</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">Id</span><span class="p">;</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">NCCIcode</span><span class="p">;</span>
	<span class="n">APPL</span> <span class="o">*</span><span class="n">APPLptr</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">Num</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">ncpi_state</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">len</span><span class="p">,</span> <span class="n">ncci_state</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">msg</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">fax_feature_bits</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">fax_send_edata_ack</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">byte</span> <span class="n">v120_header_buffer</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>
	<span class="k">static</span> <span class="n">word</span> <span class="n">fax_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">0</span><span class="p">,</span>                     <span class="cm">/* T30_SUCCESS                        */</span>
		<span class="n">_FAX_NO_CONNECTION</span><span class="p">,</span>    <span class="cm">/* T30_ERR_NO_DIS_RECEIVED            */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_TIMEOUT_NO_RESPONSE        */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_RETRY_NO_RESPONSE          */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_TOO_MANY_REPEATS           */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_UNEXPECTED_MESSAGE         */</span>
		<span class="n">_FAX_REMOTE_ABORT</span><span class="p">,</span>     <span class="cm">/* T30_ERR_UNEXPECTED_DCN             */</span>
		<span class="n">_FAX_LOCAL_ABORT</span><span class="p">,</span>      <span class="cm">/* T30_ERR_DTC_UNSUPPORTED            */</span>
		<span class="n">_FAX_TRAINING_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_ALL_RATES_FAILED           */</span>
		<span class="n">_FAX_TRAINING_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_TOO_MANY_TRAINS            */</span>
		<span class="n">_FAX_PARAMETER_ERROR</span><span class="p">,</span>  <span class="cm">/* T30_ERR_RECEIVE_CORRUPTED          */</span>
		<span class="n">_FAX_REMOTE_ABORT</span><span class="p">,</span>     <span class="cm">/* T30_ERR_UNEXPECTED_DISC            */</span>
		<span class="n">_FAX_LOCAL_ABORT</span><span class="p">,</span>      <span class="cm">/* T30_ERR_APPLICATION_DISC           */</span>
		<span class="n">_FAX_REMOTE_REJECT</span><span class="p">,</span>    <span class="cm">/* T30_ERR_INCOMPATIBLE_DIS           */</span>
		<span class="n">_FAX_LOCAL_ABORT</span><span class="p">,</span>      <span class="cm">/* T30_ERR_INCOMPATIBLE_DCS           */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_TIMEOUT_NO_COMMAND         */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_RETRY_NO_COMMAND           */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_TIMEOUT_COMMAND_TOO_LONG   */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_TIMEOUT_RESPONSE_TOO_LONG  */</span>
		<span class="n">_FAX_NO_CONNECTION</span><span class="p">,</span>    <span class="cm">/* T30_ERR_NOT_IDENTIFIED             */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_SUPERVISORY_TIMEOUT        */</span>
		<span class="n">_FAX_PARAMETER_ERROR</span><span class="p">,</span>  <span class="cm">/* T30_ERR_TOO_LONG_SCAN_LINE         */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_RETRY_NO_PAGE_AFTER_MPS    */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_RETRY_NO_PAGE_AFTER_CFR    */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_RETRY_NO_DCS_AFTER_FTT     */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_RETRY_NO_DCS_AFTER_EOM     */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_RETRY_NO_DCS_AFTER_MPS     */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_RETRY_NO_DCN_AFTER_MCF     */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_RETRY_NO_DCN_AFTER_RTN     */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_RETRY_NO_CFR               */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_RETRY_NO_MCF_AFTER_EOP     */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_RETRY_NO_MCF_AFTER_EOM     */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_RETRY_NO_MCF_AFTER_MPS     */</span>
		<span class="mh">0x331d</span><span class="p">,</span>                <span class="cm">/* T30_ERR_SUB_SEP_UNSUPPORTED        */</span>
		<span class="mh">0x331e</span><span class="p">,</span>                <span class="cm">/* T30_ERR_PWD_UNSUPPORTED            */</span>
		<span class="mh">0x331f</span><span class="p">,</span>                <span class="cm">/* T30_ERR_SUB_SEP_PWD_UNSUPPORTED    */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_INVALID_COMMAND_FRAME      */</span>
		<span class="n">_FAX_PARAMETER_ERROR</span><span class="p">,</span>  <span class="cm">/* T30_ERR_UNSUPPORTED_PAGE_CODING    */</span>
		<span class="n">_FAX_PARAMETER_ERROR</span><span class="p">,</span>  <span class="cm">/* T30_ERR_INVALID_PAGE_CODING        */</span>
		<span class="n">_FAX_REMOTE_REJECT</span><span class="p">,</span>    <span class="cm">/* T30_ERR_INCOMPATIBLE_PAGE_CONFIG   */</span>
		<span class="n">_FAX_LOCAL_ABORT</span><span class="p">,</span>      <span class="cm">/* T30_ERR_TIMEOUT_FROM_APPLICATION   */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_V34FAX_NO_REACTION_ON_MARK */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_V34FAX_TRAINING_TIMEOUT    */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_V34FAX_UNEXPECTED_V21      */</span>
		<span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">,</span>   <span class="cm">/* T30_ERR_V34FAX_PRIMARY_CTS_ON      */</span>
		<span class="n">_FAX_LOCAL_ABORT</span><span class="p">,</span>      <span class="cm">/* T30_ERR_V34FAX_TURNAROUND_POLLING  */</span>
		<span class="n">_FAX_LOCAL_ABORT</span>       <span class="cm">/* T30_ERR_V34FAX_V8_INCOMPATIBILITY  */</span>
	<span class="p">};</span>

	<span class="n">byte</span> <span class="n">dtmf_code_buffer</span><span class="p">[</span><span class="n">CAPIDTMF_RECV_DIGIT_BUFFER_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>


	<span class="k">static</span> <span class="n">word</span> <span class="n">rtp_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">GOOD</span><span class="p">,</span>                  <span class="cm">/* RTP_SUCCESS                       */</span>
		<span class="mh">0x3600</span>                 <span class="cm">/* RTP_ERR_SSRC_OR_PAYLOAD_CHANGE    */</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="n">dword</span> <span class="n">udata_forwarding_table</span><span class="p">[</span><span class="mh">0x100</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dword</span><span class="p">)]</span> <span class="o">=</span>
		<span class="p">{</span>
			<span class="mh">0x0020301e</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00000000</span>
		<span class="p">};</span>

	<span class="n">ch</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">IndCh</span><span class="p">;</span>
	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">ncci</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_ncci</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="n">Id</span> <span class="o">=</span> <span class="p">(((</span><span class="n">dword</span><span class="p">)(</span><span class="n">ncci</span> <span class="o">?</span> <span class="n">ncci</span> <span class="o">:</span> <span class="n">ch</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">word</span><span class="p">)</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span><span class="p">)</span> <span class="n">Id</span> <span class="o">|=</span> <span class="n">EXT_CONTROLLER</span><span class="p">;</span>
	<span class="n">APPLptr</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">;</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;NL_IND-Id(NL:0x%x)=0x%08lx,plci=%x,tel=%x,state=0x%x,ch=0x%x,chs=%d,Ind=%x&quot;</span><span class="p">,</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">));</span>

	<span class="cm">/* in the case if no connect_active_Ind was sent to the appl we wait for */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RNR</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* discard */</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;NL discard while remove pending&quot;</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_CONNECT</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_DIS_PENDING</span>
		    <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">OUTG_DIS_PENDING</span>
		    <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">IDLE</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RNR</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* discard */</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;discard n_connect&quot;</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">&lt;</span> <span class="n">INC_ACT_PENDING</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RNR</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* flow control */</span>
			<span class="n">channel_x_off</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">N_XON_CONNECT_IND</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">APPLptr</span><span class="p">)</span>                         <span class="cm">/* no application or invalid data */</span>
	<span class="p">{</span>                                    <span class="cm">/* while reloading the DSP        */</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;discard1&quot;</span><span class="p">));</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RNR</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_UDATA</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">!=</span> <span class="n">B2_SDLC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span> <span class="o">==</span> <span class="mi">17</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span> <span class="o">==</span> <span class="mi">18</span><span class="p">)))</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ncpi_state</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">complete</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">byte</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="o">*</span><span class="n">data</span> <span class="o">==</span> <span class="n">DSP_UDATA_INDICATION_DCD_ON</span><span class="p">)</span>
				<span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span> <span class="o">==</span> <span class="n">DSP_UDATA_INDICATION_CTS_ON</span><span class="p">)))</span>
			<span class="p">{</span>
				<span class="n">word</span> <span class="n">conn_opt</span><span class="p">,</span> <span class="n">ncpi_opt</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="cm">/*      HexDump (&quot;MDM N_UDATA:&quot;, plci-&gt;NL.RBuffer-&gt;length, data); */</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span> <span class="o">==</span> <span class="n">DSP_UDATA_INDICATION_DCD_ON</span><span class="p">)</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">|=</span> <span class="n">NCPI_MDM_DCD_ON_RECEIVED</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span> <span class="o">==</span> <span class="n">DSP_UDATA_INDICATION_CTS_ON</span><span class="p">)</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">|=</span> <span class="n">NCPI_MDM_CTS_ON_RECEIVED</span><span class="p">;</span>

				<span class="n">data</span><span class="o">++</span><span class="p">;</span>    <span class="cm">/* indication code */</span>
				<span class="n">data</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* timestamp */</span>
				<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">data</span> <span class="o">==</span> <span class="n">DSP_CONNECTED_NORM_V18</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span> <span class="o">==</span> <span class="n">DSP_CONNECTED_NORM_VOWN</span><span class="p">))</span>
					<span class="n">ncpi_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NCPI_MDM_DCD_ON_RECEIVED</span> <span class="o">|</span> <span class="n">NCPI_MDM_CTS_ON_RECEIVED</span><span class="p">);</span>
				<span class="n">data</span><span class="o">++</span><span class="p">;</span>    <span class="cm">/* connected norm */</span>
				<span class="n">conn_opt</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
				<span class="n">data</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* connected options */</span>

				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">GET_DWORD</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">));</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">conn_opt</span> <span class="o">&amp;</span> <span class="n">DSP_CONNECTED_OPTION_MASK_V42</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">ncpi_opt</span> <span class="o">|=</span> <span class="n">MDM_NCPI_ECM_V42</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">conn_opt</span> <span class="o">&amp;</span> <span class="n">DSP_CONNECTED_OPTION_MASK_MNP</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">ncpi_opt</span> <span class="o">|=</span> <span class="n">MDM_NCPI_ECM_MNP</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">ncpi_opt</span> <span class="o">|=</span> <span class="n">MDM_NCPI_TRANSPARENT</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">conn_opt</span> <span class="o">&amp;</span> <span class="n">DSP_CONNECTED_OPTION_MASK_COMPRESSION</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">ncpi_opt</span> <span class="o">|=</span> <span class="n">MDM_NCPI_COMPRESSED</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">ncpi_opt</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">|=</span> <span class="n">NCPI_VALID_CONNECT_B3_IND</span> <span class="o">|</span> <span class="n">NCPI_VALID_CONNECT_B3_ACT</span> <span class="o">|</span> <span class="n">NCPI_VALID_DISC_B3_IND</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">INC_ACT_PENDING</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">OUTG_CON_PENDING</span><span class="p">))</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">&amp;</span> <span class="n">NCPI_VALID_CONNECT_B3_ACT</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">&amp;</span> <span class="n">NCPI_CONNECT_B3_ACT_SENT</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">INC_ACT_PENDING</span><span class="p">;</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_ACTIVE_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;S&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">|=</span> <span class="n">NCPI_CONNECT_B3_ACT_SENT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options_conn</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">requested_options_table</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
		      <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_V18</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_VOWN</span><span class="p">)))</span>
		    <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">ncpi_state</span> <span class="o">&amp;</span> <span class="n">NCPI_MDM_DCD_ON_RECEIVED</span><span class="p">)</span>
		    <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">ncpi_state</span> <span class="o">&amp;</span> <span class="n">NCPI_MDM_CTS_ON_RECEIVED</span><span class="p">))</span>

		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RNR</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">complete</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_UDATA</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">udata_forwarding_table</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">))))</span>
		<span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="p">{</span>

			<span class="k">case</span> <span class="n">DTMF_UDATA_INDICATION_FAX_CALLING_TONE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_rec_active</span> <span class="o">&amp;</span> <span class="n">DTMF_LISTEN_ACTIVE_FLAG</span><span class="p">)</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffffL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="n">SELECTOR_DTMF</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01</span><span class="s">X&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DTMF_UDATA_INDICATION_ANSWER_TONE</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_rec_active</span> <span class="o">&amp;</span> <span class="n">DTMF_LISTEN_ACTIVE_FLAG</span><span class="p">)</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffffL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="n">SELECTOR_DTMF</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01</span><span class="s">Y&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DTMF_UDATA_INDICATION_DIGITS_RECEIVED</span>:
				<span class="n">dtmf_indication</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DTMF_UDATA_INDICATION_DIGITS_SENT</span>:
				<span class="n">dtmf_confirmation</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>


			<span class="k">case</span> <span class="n">UDATA_INDICATION_MIXER_TAP_DATA</span>:
				<span class="n">capidtmf_recv_process_block</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">capidtmf_state</span><span class="p">),</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">capidtmf_indication</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">capidtmf_state</span><span class="p">),</span> <span class="n">dtmf_code_buffer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dtmf_code_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">DTMF_UDATA_INDICATION_DIGITS_RECEIVED</span><span class="p">;</span>
					<span class="n">dtmf_indication</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">dtmf_code_buffer</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>


			<span class="k">case</span> <span class="n">UDATA_INDICATION_MIXER_COEFS_SET</span>:
				<span class="n">mixer_indication_coefs_set</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">UDATA_INDICATION_XCONNECT_FROM</span>:
				<span class="n">mixer_indication_xconnect_from</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">UDATA_INDICATION_XCONNECT_TO</span>:
				<span class="n">mixer_indication_xconnect_to</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>


			<span class="k">case</span> <span class="n">LEC_UDATA_INDICATION_DISABLE_DETECT</span>:
				<span class="n">ec_indication</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>



			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">==</span> <span class="n">B2_V120_ASYNC</span><span class="p">)</span>
				<span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">==</span> <span class="n">B2_V120_ASYNC_V42BIS</span><span class="p">)</span>
				<span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">==</span> <span class="n">B2_V120_BIT_TRANSPARENT</span><span class="p">)))</span>
			<span class="p">{</span>

				<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_DATA_B3_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="s">&quot;dwww&quot;</span><span class="p">,</span>
				      <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">P</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RNum</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">PLength</span><span class="p">,</span>
				      <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RNum</span><span class="p">,</span>
				      <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RFlags</span><span class="p">);</span>

			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>

				<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_DATA_B3_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="s">&quot;dwww&quot;</span><span class="p">,</span>
				      <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span><span class="p">,</span>
				      <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span><span class="p">,</span>
				      <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RNum</span><span class="p">,</span>
				      <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RFlags</span><span class="p">);</span>

			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fax_feature_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_CONNECT</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_CONNECT_ACK</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_DISC</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_EDATA</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_DISC_ACK</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span>  <span class="mi">0</span>: <span class="cm">/*XPARENT*/</span>
		<span class="k">case</span>  <span class="mi">1</span>: <span class="cm">/*T.90 NL*/</span>
			<span class="k">break</span><span class="p">;</span>    <span class="cm">/* no network control protocol info - jfr */</span>
		<span class="k">case</span>  <span class="mi">2</span>: <span class="cm">/*ISO8202*/</span>
		<span class="k">case</span>  <span class="mi">3</span>: <span class="cm">/*X25 DCE*/</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RLength</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="n">N_D_BIT</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span>  <span class="mi">4</span>: <span class="cm">/*T.30 - FAX*/</span>
		<span class="k">case</span>  <span class="mi">5</span>: <span class="cm">/*T.30 - FAX*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RLength</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T30_INFO</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;FaxStatus %04x&quot;</span><span class="p">,</span> <span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">));</span>
				<span class="n">len</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rate_div_2400</span> <span class="o">*</span> <span class="mi">2400</span><span class="p">);</span>
				<span class="n">fax_feature_bits</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">feature_bits_low</span><span class="p">);</span>
				<span class="n">i</span> <span class="o">=</span> <span class="p">(((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">resolution</span> <span class="o">&amp;</span> <span class="n">T30_RESOLUTION_R8_0770_OR_200</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x0001</span> <span class="o">:</span> <span class="mh">0x0000</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fax_feature_bits</span> <span class="o">&amp;</span> <span class="n">T30_FEATURE_BIT_ECM</span><span class="p">))</span>
						<span class="n">i</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span> <span class="cm">/* This is not an ECM connection */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">fax_feature_bits</span> <span class="o">&amp;</span> <span class="n">T30_FEATURE_BIT_T6_CODING</span><span class="p">)</span>
						<span class="n">i</span> <span class="o">|=</span> <span class="mh">0x4000</span><span class="p">;</span> <span class="cm">/* This is a connection with MMR compression */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">fax_feature_bits</span> <span class="o">&amp;</span> <span class="n">T30_FEATURE_BIT_2D_CODING</span><span class="p">)</span>
						<span class="n">i</span> <span class="o">|=</span> <span class="mh">0x2000</span><span class="p">;</span> <span class="cm">/* This is a connection with MR compression */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">fax_feature_bits</span> <span class="o">&amp;</span> <span class="n">T30_FEATURE_BIT_MORE_DOCUMENTS</span><span class="p">)</span>
						<span class="n">i</span> <span class="o">|=</span> <span class="mh">0x0004</span><span class="p">;</span> <span class="cm">/* More documents */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">fax_feature_bits</span> <span class="o">&amp;</span> <span class="n">T30_FEATURE_BIT_POLLING</span><span class="p">)</span>
						<span class="n">i</span> <span class="o">|=</span> <span class="mh">0x0002</span><span class="p">;</span> <span class="cm">/* Fax-polling indication */</span>
				<span class="p">}</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;FAX Options %04x %04x&quot;</span><span class="p">,</span> <span class="n">fax_feature_bits</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data_format</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pages_low</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pages_high</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">station_id_len</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">T30_MAX_STATION_ID_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="o">++</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">station_id</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_DISC</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_DISC_ACK</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fax_info</span><span class="p">))</span>
						<span class="n">info</span> <span class="o">=</span> <span class="n">fax_info</span><span class="p">[((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">];</span>
					<span class="k">else</span>
						<span class="n">info</span> <span class="o">=</span> <span class="n">_FAX_PROTOCOL_ERROR</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options_conn</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options</span> <span class="o">|</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">requested_options_table</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
				    <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_SUB_SEP_PWD</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_NONSTANDARD</span><span class="p">)))</span>
				<span class="p">{</span>
					<span class="n">i</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">T30_INFO</span><span class="p">,</span> <span class="n">station_id</span><span class="p">)</span> <span class="o">+</span> <span class="n">T30_MAX_STATION_ID_LENGTH</span> <span class="o">+</span> <span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">head_line_len</span><span class="p">;</span>
					<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="o">++</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
				<span class="p">}</span>

				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
				<span class="n">fax_feature_bits</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">feature_bits_low</span><span class="p">);</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">feature_bits_low</span><span class="p">,</span> <span class="n">fax_feature_bits</span><span class="p">);</span>

				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">|=</span> <span class="n">NCPI_VALID_CONNECT_B3_IND</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_CONNECT_ACK</span><span class="p">)</span>
				    <span class="o">||</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_CONNECT</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fax_feature_bits</span> <span class="o">&amp;</span> <span class="n">T30_FEATURE_BIT_POLLING</span><span class="p">))</span>
				    <span class="o">||</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_EDATA</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="p">((((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">EDATA_T30_TRAIN_OK</span><span class="p">)</span>
					    <span class="o">||</span> <span class="p">(((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">EDATA_T30_DIS</span><span class="p">)</span>
					    <span class="o">||</span> <span class="p">(((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">EDATA_T30_DTC</span><span class="p">))))</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">|=</span> <span class="n">NCPI_VALID_CONNECT_B3_ACT</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_DISC</span><span class="p">)</span>
				    <span class="o">||</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_DISC_ACK</span><span class="p">)</span>
				    <span class="o">||</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_EDATA</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">EDATA_T30_EOP_CAPI</span><span class="p">)))</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">|=</span> <span class="n">NCPI_VALID_CONNECT_B3_ACT</span> <span class="o">|</span> <span class="n">NCPI_VALID_DISC_B3_IND</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">B3_RTP</span>:
			<span class="k">if</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_DISC</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_DISC_ACK</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RLength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">info</span> <span class="o">=</span> <span class="n">rtp_info</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RLength</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RLength</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RNR</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">N_EDATA</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">5</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;EDATA ncci=0x%x state=%d code=%02x&quot;</span><span class="p">,</span> <span class="n">ncci</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">],</span>
					<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">));</span>
			<span class="n">fax_send_edata_ack</span> <span class="o">=</span> <span class="p">(((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">==</span> <span class="n">T30_OPERATING_MODE_CAPI_NEG</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nsf_control_bits</span> <span class="o">&amp;</span> <span class="n">T30_NSF_CONTROL_BIT_ENABLE_NSF</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nsf_control_bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">T30_NSF_CONTROL_BIT_NEGOTIATE_IND</span> <span class="o">|</span> <span class="n">T30_NSF_CONTROL_BIT_NEGOTIATE_RESP</span><span class="p">))</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">EDATA_T30_DIS</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">OUTG_CON_PENDING</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">&amp;</span> <span class="n">NCPI_VALID_CONNECT_B3_ACT</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">&amp;</span> <span class="n">NCPI_NEGOTIATE_B3_SENT</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_MANUFACTURER_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dwbS&quot;</span><span class="p">,</span> <span class="n">_DI_MANU_ID</span><span class="p">,</span> <span class="n">_DI_NEGOTIATE_B3</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">|=</span> <span class="n">NCPI_NEGOTIATE_B3_SENT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nsf_control_bits</span> <span class="o">&amp;</span> <span class="n">T30_NSF_CONTROL_BIT_NEGOTIATE_RESP</span><span class="p">)</span>
					<span class="n">fax_send_edata_ack</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_FAX_PAPER_FORMATS</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">switch</span> <span class="p">(((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span>
				<span class="p">{</span>
				<span class="k">case</span> <span class="n">EDATA_T30_DIS</span>:
					<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">OUTG_CON_PENDING</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control_bits_low</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">T30_CONTROL_BIT_REQUEST_POLLING</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">&amp;</span> <span class="n">NCPI_VALID_CONNECT_B3_ACT</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">&amp;</span> <span class="n">NCPI_CONNECT_B3_ACT_SENT</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">INC_ACT_PENDING</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
							<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_ACTIVE_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
						<span class="k">else</span>
							<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_ACTIVE_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;S&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">);</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">|=</span> <span class="n">NCPI_CONNECT_B3_ACT_SENT</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">EDATA_T30_TRAIN_OK</span>:
					<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">INC_ACT_PENDING</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">&amp;</span> <span class="n">NCPI_VALID_CONNECT_B3_ACT</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">&amp;</span> <span class="n">NCPI_CONNECT_B3_ACT_SENT</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
							<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_ACTIVE_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
						<span class="k">else</span>
							<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_ACTIVE_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;S&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">);</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">|=</span> <span class="n">NCPI_CONNECT_B3_ACT_SENT</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">EDATA_T30_EOP_CAPI</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">CONNECTED</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_DISCONNECT_B3_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wS&quot;</span><span class="p">,</span> <span class="n">GOOD</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">);</span>
						<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">INC_DIS_PENDING</span><span class="p">;</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">fax_send_edata_ack</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="k">switch</span> <span class="p">(((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span>
				<span class="p">{</span>
				<span class="k">case</span> <span class="n">EDATA_T30_TRAIN_OK</span>:
					<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">INC_ACT_PENDING</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">&amp;</span> <span class="n">NCPI_VALID_CONNECT_B3_ACT</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">&amp;</span> <span class="n">NCPI_CONNECT_B3_ACT_SENT</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
							<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_ACTIVE_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
						<span class="k">else</span>
							<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_ACTIVE_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;S&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">);</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">|=</span> <span class="n">NCPI_CONNECT_B3_ACT_SENT</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fax_send_edata_ack</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_edata_ack_length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">fax_edata_ack_command</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;EDATA ncci=0x%x state=%d&quot;</span><span class="p">,</span> <span class="n">ncci</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]));</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">N_CONNECT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_ncci</span><span class="p">[</span><span class="n">ch</span><span class="p">])</span>
		<span class="p">{</span>
			<span class="n">ncci</span> <span class="o">=</span> <span class="n">get_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">Id</span> <span class="o">=</span> <span class="p">(</span><span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">dword</span><span class="p">)</span> <span class="n">ncci</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;N_CONNECT: ch=%d state=%d plci=%lx plci_Id=%lx plci_State=%d&quot;</span><span class="p">,</span>
				<span class="n">ch</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">],</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_plci</span><span class="p">[</span><span class="n">ncci</span><span class="p">],</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span><span class="p">));</span>

		<span class="n">msg</span> <span class="o">=</span> <span class="n">_CONNECT_B3_I</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">IDLE</span><span class="p">)</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="n">_CONNECT_B3_T90_ACTIVE_I</span><span class="p">;</span>

		<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">INC_CON_PENDING</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;S&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">N_CONNECT_ACK</span>:
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;N_connect_Ack&quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">==</span> <span class="n">ADJUST_B_CONNECT_2</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">==</span> <span class="n">ADJUST_B_CONNECT_3</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">==</span> <span class="n">ADJUST_B_CONNECT_4</span><span class="p">)))</span>
		<span class="p">{</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]))(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
				<span class="n">next_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">_CONNECT_B3_ACTIVE_I</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">!=</span> <span class="n">OUTG_CON_PENDING</span><span class="p">)</span>
				<span class="n">msg</span> <span class="o">=</span> <span class="n">_CONNECT_B3_T90_ACTIVE_I</span><span class="p">;</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">INC_ACT_PENDING</span><span class="p">;</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;S&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">7</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">OUTG_CON_PENDING</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">&amp;</span> <span class="n">NCPI_VALID_CONNECT_B3_ACT</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">&amp;</span> <span class="n">NCPI_CONNECT_B3_ACT_SENT</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">INC_ACT_PENDING</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;S&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">|=</span> <span class="n">NCPI_CONNECT_B3_ACT_SENT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">INC_ACT_PENDING</span><span class="p">;</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;S&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_restore</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_restore</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">adjust_b_restore</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">N_DISC</span>:
	<span class="k">case</span> <span class="n">N_DISC_ACK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">==</span> <span class="n">FAX_DISCONNECT_COMMAND_1</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">==</span> <span class="n">FAX_DISCONNECT_COMMAND_2</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">==</span> <span class="n">FAX_DISCONNECT_COMMAND_3</span><span class="p">)))</span>
		<span class="p">{</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]))(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
				<span class="n">next_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ncci_state</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">];</span>
		<span class="n">ncci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ncci</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="cm">/* with N_DISC or N_DISC_ACK the IDI frees the respective   */</span>
		<span class="cm">/* channel, so we cannot store the state in ncci_state! The */</span>
		<span class="cm">/* information which channel we received a N_DISC is thus   */</span>
		<span class="cm">/* stored in the inc_dis_ncci_table buffer.                 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">inc_dis_ncci_table</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">inc_dis_ncci_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">ncci</span><span class="p">;</span>

		<span class="cm">/* need a connect_b3_ind before a disconnect_b3_ind with FAX */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">&lt;=</span> <span class="n">CONNECTED</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">=</span> <span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rate_div_2400</span> <span class="o">*</span> <span class="mi">2400</span><span class="p">;</span>
			<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">=</span> <span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data_format</span><span class="p">;</span>
			<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
			<span class="k">else</span>
			<span class="p">{</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options_conn</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options</span> <span class="o">|</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">requested_options_table</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
				    <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_SUB_SEP_PWD</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_NONSTANDARD</span><span class="p">)))</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="o">++</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="o">++</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="o">++</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;S&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_DISCONNECT_B3_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wS&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">HANGUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">OUTG_DIS_PENDING</span><span class="p">;</span>
			<span class="cm">/* disc here */</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_FAX_PAPER_FORMATS</span><span class="p">)</span>
			 <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">5</span><span class="p">))</span>
			 <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">ncci_state</span> <span class="o">==</span> <span class="n">INC_DIS_PENDING</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ncci_state</span> <span class="o">==</span> <span class="n">IDLE</span><span class="p">)))</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ncci_state</span> <span class="o">==</span> <span class="n">IDLE</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="o">--</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">IDLE</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">SUSPENDING</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">SUSPENDING</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span>
						      <span class="n">_FACILITY_I</span><span class="p">,</span>
						      <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffffL</span><span class="p">,</span>
						      <span class="mi">0</span><span class="p">,</span>
						      <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x03\x04\x00\x00</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_DISCONNECT_I</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffffL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_DISCONNECT_B3_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wS&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ncci_state</span> <span class="o">==</span> <span class="n">OUTG_REJ_PENDING</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">!=</span> <span class="n">B3_T90NL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">!=</span> <span class="n">B3_ISO8208</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">!=</span> <span class="n">B3_X25_DCE</span><span class="p">)))</span>
			<span class="p">{</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">HANGUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">OUTG_DIS_PENDING</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">N_RESET</span>:
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">INC_RES_PENDING</span><span class="p">;</span>
		<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_RESET_B3_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;S&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">N_RESET_ACK</span>:
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">=</span> <span class="n">CONNECTED</span><span class="p">;</span>
		<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_RESET_B3_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;S&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">N_UDATA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">udata_forwarding_table</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">))))</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_ind_buffer</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="kt">long</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_ind_buffer</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">=</span> <span class="n">INTERNAL_IND_BUFFER_SIZE</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RNum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">N_BDATA</span>:
	<span class="k">case</span> <span class="n">N_DATA</span>:
		<span class="k">if</span> <span class="p">(((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">!=</span> <span class="n">CONNECTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="cm">/* transparent */</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">IDLE</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">INC_DIS_PENDING</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RNR</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">!=</span> <span class="n">CONNECTED</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">!=</span> <span class="n">OUTG_DIS_PENDING</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">!=</span> <span class="n">OUTG_REJ_PENDING</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;flow control&quot;</span><span class="p">));</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RNR</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* flow control  */</span>
			<span class="n">channel_x_off</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">NCCIcode</span> <span class="o">=</span> <span class="n">ncci</span> <span class="o">|</span> <span class="p">(((</span><span class="n">word</span><span class="p">)</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

		<span class="cm">/* count all buffers within the Application pool    */</span>
		<span class="cm">/* belonging to the same NCCI. If this is below the */</span>
		<span class="cm">/* number of buffers available per NCCI we accept   */</span>
		<span class="cm">/* this packet, otherwise we reject it              */</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">Num</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">APPLptr</span><span class="o">-&gt;</span><span class="n">MaxBuffer</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">NCCIcode</span> <span class="o">==</span> <span class="n">APPLptr</span><span class="o">-&gt;</span><span class="n">DataNCCI</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">APPLptr</span><span class="o">-&gt;</span><span class="n">DataNCCI</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">Num</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="n">Num</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">APPLptr</span><span class="o">-&gt;</span><span class="n">MaxNCCIData</span> <span class="o">||</span> <span class="n">Num</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Flow-Control&quot;</span><span class="p">));</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RNR</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="p">(</span><span class="n">APPLptr</span><span class="o">-&gt;</span><span class="n">NCCIDataFlowCtrlTimer</span><span class="p">)</span> <span class="o">&gt;=</span>
			    <span class="p">(</span><span class="n">word</span><span class="p">)((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_OOB_CHANNEL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">40</span> <span class="o">:</span> <span class="mi">2000</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RNR</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;DiscardData&quot;</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">channel_x_off</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">APPLptr</span><span class="o">-&gt;</span><span class="n">NCCIDataFlowCtrlTimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">ReceiveBufferGet</span><span class="p">(</span><span class="n">APPLptr</span><span class="p">,</span> <span class="n">Num</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RNR</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">channel_x_off</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">APPLptr</span><span class="o">-&gt;</span><span class="n">DataNCCI</span><span class="p">[</span><span class="n">Num</span><span class="p">]</span> <span class="o">=</span> <span class="n">NCCIcode</span><span class="p">;</span>
		<span class="n">APPLptr</span><span class="o">-&gt;</span><span class="n">DataFlags</span><span class="p">[</span><span class="n">Num</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Buffer(%d), Max = %d&quot;</span><span class="p">,</span> <span class="n">Num</span><span class="p">,</span> <span class="n">APPLptr</span><span class="o">-&gt;</span><span class="n">MaxBuffer</span><span class="p">));</span>

		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RNum</span> <span class="o">=</span> <span class="n">Num</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RFlags</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">=</span> <span class="n">APPLptr</span><span class="o">-&gt;</span><span class="n">MaxDataLength</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RLength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">==</span> <span class="n">B2_V120_ASYNC</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">==</span> <span class="n">B2_V120_ASYNC_V42BIS</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">==</span> <span class="n">B2_V120_BIT_TRANSPARENT</span><span class="p">)))</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">PLength</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">v120_header_buffer</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">v120_header_buffer</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">V120_HEADER_EXTEND_BIT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RLength</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">V120_HEADER_BREAK_BIT</span><span class="p">)</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RFlags</span> <span class="o">|=</span> <span class="mh">0x0010</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V120_HEADER_C1_BIT</span> <span class="o">|</span> <span class="n">V120_HEADER_C2_BIT</span><span class="p">))</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RFlags</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RNum</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_UDATA</span><span class="p">)</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RFlags</span> <span class="o">|=</span> <span class="mh">0x0010</span><span class="p">;</span>

			<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="n">B3_RTP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Ind</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_BDATA</span><span class="p">))</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RFlags</span> <span class="o">|=</span> <span class="mh">0x0001</span><span class="p">;</span>

			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RNum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">N_DATA_ACK</span>:
		<span class="n">data_ack</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">RNR</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* find a free PLCI */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">word</span> <span class="nf">get_plci</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">;</span>

	<span class="n">dump_plcis</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">max_plci</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Id</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">max_plci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;get_plci: out of PLCIs&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">plci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">SuppState</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">m_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_internal_command_queue</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_write_pos</span> <span class="o">=</span> <span class="n">MSG_IN_QUEUE_SIZE</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_read_pos</span> <span class="o">=</span> <span class="n">MSG_IN_QUEUE_SIZE</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">msg_in_wrap_pos</span> <span class="o">=</span> <span class="n">MSG_IN_QUEUE_SIZE</span><span class="p">;</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">data_sent</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">send_disc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_global_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_remove_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_global_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adv_nl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">manufacturer</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">=</span> <span class="n">CALL_DIR_OUT</span> <span class="o">|</span> <span class="n">CALL_DIR_ORIGINATE</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">spoofed_msg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">cr_enquiry</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">hangup_flow_ctrl_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncci_ring_list</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_CHANNELS_PER_PLCI</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">inc_dis_ncci_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clear_c_ind_mask</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
	<span class="n">set_group_ind_mask</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">nsf_control_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options_conn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">notifiedcall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">vswitchstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">vsprot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">vsprotdialect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_b1_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;get_plci(%x)&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* put a parameter in the parameter buffer                          */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_p</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">code</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">p_length</span><span class="p">;</span>

	<span class="n">p_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="n">p_length</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">add_ie</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">p_length</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* put a structure in the parameter buffer                          */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_s</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">code</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="n">add_ie</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* put multiple structures in the parameter buffer                  */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_ss</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">code</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">byte</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;add_ss(%x,len=%d)&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;add_ss_ie(%x,len=%d)&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
			<span class="n">add_ie</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* return the channel number sent by the application in a esc_chi   */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="n">byte</span> <span class="nf">getChannel</span><span class="p">(</span><span class="n">API_PARSE</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">byte</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ESC</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">CHI</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* put an information element in the parameter buffer               */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_ie</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">code</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">word</span> <span class="n">p_length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">p_length</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">p_length</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p_length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* put a unstructured data into the buffer                          */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_d</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">word</span> <span class="n">length</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* put parameters from the Additional Info parameter in the         */</span>
<span class="cm">/* parameter buffer                                                 */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_ai</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="n">ai_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">ai_parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;ssss&quot;</span><span class="p">,</span> <span class="n">ai_parms</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">add_s</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">add_s</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">UUI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">add_ss</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">FTY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* put parameter for b1 protocol in the parameter buffer            */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">word</span> <span class="nf">add_b1</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">word</span> <span class="n">b_channel_info</span><span class="p">,</span>
		   <span class="n">word</span> <span class="n">b1_facilities</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">API_PARSE</span> <span class="n">bp_parms</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">API_PARSE</span> <span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="n">API_PARSE</span> <span class="n">global_config</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">byte</span> <span class="n">cai</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="n">byte</span> <span class="n">resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">};</span>
	<span class="n">byte</span> <span class="n">voice_cai</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x06\x14\x00\x00\x00\x00\x08</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">API_PARSE</span> <span class="n">mdm_cfg_v18</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">word</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">d</span><span class="p">;</span>


	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">bp_parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">global_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;add_b1&quot;</span><span class="p">));</span>
	<span class="n">api_save_msg</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B_protocol</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b_channel_info</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">adjust_b1_facilities</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">,</span> <span class="n">b1_facilities</span><span class="p">);</span>
		<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x00</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Cai=1,0 (no resource)&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">CODEC_PERMANENT</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">CODEC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">adjust_b1_facilities</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">,</span> <span class="n">b1_facilities</span><span class="p">);</span>
		<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x01</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Cai=1,1 (Codec)&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">ADV_VOICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span> <span class="o">=</span> <span class="n">add_b1_facilities</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">b1_facilities</span> <span class="o">|</span> <span class="n">B1_FACILITY_VOICE</span><span class="p">));</span>
		<span class="n">adjust_b1_facilities</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">b1_facilities</span> <span class="o">|</span> <span class="n">B1_FACILITY_VOICE</span><span class="p">));</span>
		<span class="n">voice_cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">;</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">voice_cai</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">MaxDataLength</span><span class="p">);</span>
		<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="n">voice_cai</span><span class="p">);</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Cai=1,0x%x (AdvVoice)&quot;</span><span class="p">,</span> <span class="n">voice_cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CALL_DIR_ORIGINATE</span> <span class="o">|</span> <span class="n">CALL_DIR_ANSWER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">&amp;</span> <span class="n">CALL_DIR_OUT</span><span class="p">)</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">|=</span> <span class="n">CALL_DIR_ORIGINATE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">&amp;</span> <span class="n">CALL_DIR_IN</span><span class="p">)</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">|=</span> <span class="n">CALL_DIR_ANSWER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">;</span>
		<span class="n">adjust_b1_facilities</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">,</span> <span class="n">b1_facilities</span><span class="p">);</span>
		<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x05</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;b_prot_len=%d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span> <span class="k">return</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wwwsssb&quot;</span><span class="p">,</span> <span class="n">bp_parms</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">bp_parms</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wwwsss&quot;</span><span class="p">,</span> <span class="n">bp_parms</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;b-form.!&quot;</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wwwssss&quot;</span><span class="p">,</span> <span class="n">bp_parms</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;b-form.!&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">length</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">global_config</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">return</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">global_config</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">))</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CALL_DIR_ANSWER</span><span class="p">)</span> <span class="o">|</span> <span class="n">CALL_DIR_ORIGINATE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CALL_DIR_ORIGINATE</span><span class="p">)</span> <span class="o">|</span> <span class="n">CALL_DIR_ANSWER</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;call_dir=%04x&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span><span class="p">));</span>


	<span class="k">if</span> <span class="p">((</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="n">B1_RTP</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_RTP</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span> <span class="o">=</span> <span class="n">add_b1_facilities</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B1_FACILITY_VOICE</span><span class="p">));</span>
		<span class="n">adjust_b1_facilities</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B1_FACILITY_VOICE</span><span class="p">));</span>
		<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">;</span>
		<span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cai</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cai</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">MaxDataLength</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bp_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">cai</span><span class="p">[</span><span class="mi">7</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bp_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
		<span class="n">cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">bp_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
		<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="n">cai</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">((</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="n">B1_PIAFS</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_PIAFS</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span> <span class="o">=</span> <span class="n">add_b1_facilities</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="mi">35</span><span class="cm">/* PIAFS HARDWARE FACILITY */</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B1_FACILITY_VOICE</span><span class="p">));</span>
		<span class="n">adjust_b1_facilities</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B1_FACILITY_VOICE</span><span class="p">));</span>
		<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">;</span>
		<span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cai</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cai</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">MaxDataLength</span><span class="p">);</span>
		<span class="n">cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="n">cai</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">((</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B1_Protocols</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
		    <span class="o">||</span> <span class="o">!</span><span class="p">((</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">B1_HDLC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B1_Protocols</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">((</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">56000</span><span class="p">)))))</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="n">_B1_NOT_SUPPORTED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span> <span class="o">=</span> <span class="n">add_b1_facilities</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">resource</span><span class="p">[</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)],</span>
					      <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B1_FACILITY_VOICE</span><span class="p">));</span>
	<span class="n">adjust_b1_facilities</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B1_FACILITY_VOICE</span><span class="p">));</span>
	<span class="n">cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cai</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">cai</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="n">B1_MODEM_ALL_NEGOTIATE</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="n">B1_MODEM_ASYNC</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="n">B1_MODEM_SYNC_HDLC</span><span class="p">))</span>
	<span class="p">{</span> <span class="cm">/* B1 - modem */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">mdm_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">length</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wwwwww&quot;</span><span class="p">,</span> <span class="n">mdm_cfg</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Bit rate for adaptation */</span>

			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MDM Max Bit Rate:&lt;%d&gt;&quot;</span><span class="p">,</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)));</span>

			<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cai</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>                          <span class="cm">/* Min Tx speed */</span>
			<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cai</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">));</span> <span class="cm">/* Max Tx speed */</span>
			<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cai</span><span class="p">[</span><span class="mi">17</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>                          <span class="cm">/* Min Rx speed */</span>
			<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cai</span><span class="p">[</span><span class="mi">19</span><span class="p">],</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">));</span> <span class="cm">/* Max Rx speed */</span>

			<span class="n">cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Async framing parameters */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">))</span>
			<span class="p">{</span>       <span class="cm">/* Parity     */</span>
			<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* odd parity */</span>
				<span class="n">cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DSP_CAI_ASYNC_PARITY_ENABLE</span> <span class="o">|</span> <span class="n">DSP_CAI_ASYNC_PARITY_ODD</span><span class="p">);</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MDM: odd parity&quot;</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* even parity */</span>
				<span class="n">cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DSP_CAI_ASYNC_PARITY_ENABLE</span> <span class="o">|</span> <span class="n">DSP_CAI_ASYNC_PARITY_EVEN</span><span class="p">);</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MDM: even parity&quot;</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MDM: no parity&quot;</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">))</span>
			<span class="p">{</span>       <span class="cm">/* stop bits   */</span>
			<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* 2 stop bits */</span>
				<span class="n">cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DSP_CAI_ASYNC_TWO_STOP_BITS</span><span class="p">;</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MDM: 2 stop bits&quot;</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MDM: 1 stop bit&quot;</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">))</span>
			<span class="p">{</span>     <span class="cm">/* char length */</span>
			<span class="k">case</span> <span class="mi">5</span>:
				<span class="n">cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DSP_CAI_ASYNC_CHAR_LENGTH_5</span><span class="p">;</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MDM: 5 bits&quot;</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="mi">6</span>:
				<span class="n">cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DSP_CAI_ASYNC_CHAR_LENGTH_6</span><span class="p">;</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MDM: 6 bits&quot;</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="mi">7</span>:
				<span class="n">cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DSP_CAI_ASYNC_CHAR_LENGTH_7</span><span class="p">;</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MDM: 7 bits&quot;</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MDM: 8 bits&quot;</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">cai</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Line taking options */</span>
			<span class="n">cai</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Modulation negotiation options */</span>
			<span class="n">cai</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Modulation options */</span>

			<span class="k">if</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">&amp;</span> <span class="n">CALL_DIR_ORIGINATE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">&amp;</span> <span class="n">CALL_DIR_OUT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">cai</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DSP_CAI_MODEM_REVERSE_DIRECTION</span><span class="p">;</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MDM: Reverse direction&quot;</span><span class="p">));</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MDM_CAPI_DISABLE_RETRAIN</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">cai</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DSP_CAI_MODEM_DISABLE_RETRAIN</span><span class="p">;</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MDM: Disable retrain&quot;</span><span class="p">));</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MDM_CAPI_DISABLE_RING_TONE</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">cai</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DSP_CAI_MODEM_DISABLE_CALLING_TONE</span> <span class="o">|</span> <span class="n">DSP_CAI_MODEM_DISABLE_ANSWER_TONE</span><span class="p">;</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MDM: Disable ring tone&quot;</span><span class="p">));</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MDM_CAPI_GUARD_1800</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">cai</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DSP_CAI_MODEM_GUARD_TONE_1800HZ</span><span class="p">;</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MDM: 1800 guard tone&quot;</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MDM_CAPI_GUARD_550</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">cai</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DSP_CAI_MODEM_GUARD_TONE_550HZ</span><span class="p">;</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MDM: 550 guard tone&quot;</span><span class="p">));</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="o">==</span> <span class="n">MDM_CAPI_NEG_V100</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">cai</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DSP_CAI_MODEM_NEGOTIATE_V100</span><span class="p">;</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MDM: V100&quot;</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="o">==</span> <span class="n">MDM_CAPI_NEG_MOD_CLASS</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">cai</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DSP_CAI_MODEM_NEGOTIATE_IN_CLASS</span><span class="p">;</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MDM: IN CLASS&quot;</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="o">==</span> <span class="n">MDM_CAPI_NEG_DISABLED</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">cai</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DSP_CAI_MODEM_NEGOTIATE_DISABLED</span><span class="p">;</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MDM: DISABLED&quot;</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_V18</span><span class="p">))</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">))</span> <span class="cm">/* Private V.18 enable */</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options</span> <span class="o">|=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_V18</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="cm">/* Private VOWN enable */</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options</span> <span class="o">|=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_VOWN</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options_conn</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">requested_options_table</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
			    <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_V18</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_VOWN</span><span class="p">)))</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wwwwwws&quot;</span><span class="p">,</span> <span class="n">mdm_cfg</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">i</span> <span class="o">=</span> <span class="mi">27</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">d</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
						<span class="n">cai</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">d</span><span class="p">;</span>          <span class="cm">/* line taking options */</span>
						<span class="n">cai</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>    <span class="cm">/* modulation options */</span>
						<span class="n">cai</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>  <span class="cm">/* vown modulation options */</span>
						<span class="n">cai</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="n">d</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
							<span class="n">cai</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">d</span><span class="p">;</span>        <span class="cm">/* disabled modulations mask */</span>
							<span class="n">cai</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">)</span>
							<span class="p">{</span>
								<span class="n">d</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
								<span class="n">cai</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">d</span><span class="p">;</span>          <span class="cm">/* enabled modulations mask */</span>
								<span class="n">cai</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>   <span class="cm">/* vown enabled modulations */</span>
								<span class="n">cai</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
								<span class="n">cai</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
								<span class="n">cai</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
								<span class="k">if</span> <span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">14</span><span class="p">)</span>
								<span class="p">{</span>
									<span class="n">w</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
									<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
										<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cai</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="n">w</span><span class="p">);</span>  <span class="cm">/* min tx speed */</span>
									<span class="k">if</span> <span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
									<span class="p">{</span>
										<span class="n">w</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
										<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
											<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cai</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span> <span class="n">w</span><span class="p">);</span>  <span class="cm">/* max tx speed */</span>
										<span class="k">if</span> <span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">18</span><span class="p">)</span>
										<span class="p">{</span>
											<span class="n">w</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">17</span><span class="p">]);</span>
											<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
												<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cai</span><span class="p">[</span><span class="mi">17</span><span class="p">],</span> <span class="n">w</span><span class="p">);</span>  <span class="cm">/* min rx speed */</span>
											<span class="k">if</span> <span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">)</span>
											<span class="p">{</span>
												<span class="n">w</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">19</span><span class="p">]);</span>
												<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
													<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cai</span><span class="p">[</span><span class="mi">19</span><span class="p">],</span> <span class="n">w</span><span class="p">);</span>  <span class="cm">/* max rx speed */</span>
												<span class="k">if</span> <span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">22</span><span class="p">)</span>
												<span class="p">{</span>
													<span class="n">w</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">21</span><span class="p">]);</span>
													<span class="n">cai</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="o">-</span><span class="p">((</span><span class="kt">short</span><span class="p">)</span> <span class="n">w</span><span class="p">));</span>  <span class="cm">/* transmit level */</span>
													<span class="k">if</span> <span class="p">(</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">24</span><span class="p">)</span>
													<span class="p">{</span>
														<span class="n">w</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">23</span><span class="p">]);</span>
														<span class="n">cai</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">w</span><span class="p">;</span>        <span class="cm">/* info options mask */</span>
														<span class="n">cai</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">w</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>  <span class="cm">/* disabled symbol rates */</span>
													<span class="p">}</span>
												<span class="p">}</span>
											<span class="p">}</span>
										<span class="p">}</span>
									<span class="p">}</span>
								<span class="p">}</span>
							<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="n">cai</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">27</span><span class="p">;</span>
					<span class="n">i</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wwwwwwss&quot;</span><span class="p">,</span> <span class="n">mdm_cfg</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">mdm_cfg</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;sss&quot;</span><span class="p">,</span> <span class="n">mdm_cfg_v18</span><span class="p">))</span>
						<span class="p">{</span>
							<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
							<span class="p">{</span>
								<span class="n">cai</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">mdm_cfg_v18</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
								<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">word</span><span class="p">)(</span><span class="n">cai</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
									<span class="n">cai</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdm_cfg_v18</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
								<span class="n">i</span> <span class="o">+=</span> <span class="n">cai</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="n">cai</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span>                         <span class="cm">/* V.110 async */</span>
	    <span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>                           <span class="cm">/* V.110 sync */</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;V.110,%d&quot;</span><span class="p">,</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">])));</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>                 <span class="cm">/* Rate */</span>
			<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">case</span> <span class="mi">56000</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>                  <span class="cm">/* V.110 sync 56k */</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;56k sync HSCX&quot;</span><span class="p">));</span>
					<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
					<span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;56k async DSP&quot;</span><span class="p">));</span>
					<span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">50</span>:     <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">75</span>:     <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">110</span>:    <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">150</span>:    <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">200</span>:    <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">300</span>:    <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">600</span>:    <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1200</span>:   <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2400</span>:   <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">4800</span>:   <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">7200</span>:   <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">9600</span>:   <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">12000</span>:  <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">24000</span>:  <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">14400</span>:  <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">19200</span>:  <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">28800</span>:  <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">38400</span>:  <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">48000</span>:  <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">76</span>:     <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* 75/1200     */</span>
			<span class="k">case</span> <span class="mi">1201</span>:   <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* 1200/75     */</span>
			<span class="k">case</span> <span class="mi">56001</span>:  <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>  <span class="cm">/* V.110 56000 */</span>

			<span class="nl">default:</span>
				<span class="k">return</span> <span class="n">_B1_PARM_NOT_SUPPORTED</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>                                        <span class="cm">/* v.110 async */</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
					<span class="p">{</span>       <span class="cm">/* char length */</span>
					<span class="k">case</span> <span class="mi">5</span>:
						<span class="n">cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DSP_CAI_ASYNC_CHAR_LENGTH_5</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="mi">6</span>:
						<span class="n">cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DSP_CAI_ASYNC_CHAR_LENGTH_6</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="mi">7</span>:
						<span class="n">cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DSP_CAI_ASYNC_CHAR_LENGTH_7</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
					<span class="p">{</span>       <span class="cm">/* Parity     */</span>
					<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* odd parity */</span>
						<span class="n">cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DSP_CAI_ASYNC_PARITY_ENABLE</span> <span class="o">|</span> <span class="n">DSP_CAI_ASYNC_PARITY_ODD</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* even parity */</span>
						<span class="n">cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DSP_CAI_ASYNC_PARITY_ENABLE</span> <span class="o">|</span> <span class="n">DSP_CAI_ASYNC_PARITY_EVEN</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">7</span><span class="p">]))</span>
					<span class="p">{</span>       <span class="cm">/* stop bits   */</span>
					<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* 2 stop bits */</span>
						<span class="n">cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DSP_CAI_ASYNC_TWO_STOP_BITS</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">||</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;V.110 default 56k sync&quot;</span><span class="p">));</span>
			<span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cai</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;V.110 default 9600 async&quot;</span><span class="p">));</span>
			<span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cai</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">MaxDataLength</span><span class="p">);</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;CAI[%d]=%x,%x,%x,%x,%x,%x&quot;</span><span class="p">,</span> <span class="n">cai</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cai</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cai</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cai</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">cai</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">cai</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">cai</span><span class="p">[</span><span class="mi">6</span><span class="p">]));</span>
<span class="cm">/* HexDump (&quot;CAI&quot;, sizeof(cai), &amp;cai[0]); */</span>

	<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="n">cai</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* put parameter for b2 and B3  protocol in the parameter buffer    */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">word</span> <span class="nf">add_b23</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">fax_control_bits</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">pos</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">SAPI</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>  <span class="cm">/* default SAPI 16 for x.31 */</span>
	<span class="n">API_PARSE</span> <span class="n">bp_parms</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">API_PARSE</span> <span class="o">*</span><span class="n">b1_config</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="o">*</span><span class="n">b2_config</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">API_PARSE</span> <span class="o">*</span><span class="n">b3_config</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="n">b3_config_parms</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">API_PARSE</span> <span class="n">global_config</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">static</span> <span class="n">byte</span> <span class="n">llc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">static</span> <span class="n">byte</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">static</span> <span class="n">byte</span> <span class="n">nlc</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="k">static</span> <span class="n">byte</span> <span class="n">lli</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">};</span>

	<span class="k">const</span> <span class="n">byte</span> <span class="n">llc2_out</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">X75_V42BIS</span><span class="p">,</span><span class="n">V120_L2</span><span class="p">,</span><span class="n">V120_V42BIS</span><span class="p">,</span><span class="n">V120_L2</span><span class="p">,</span><span class="mi">6</span><span class="p">};</span>
	<span class="k">const</span> <span class="n">byte</span> <span class="n">llc2_in</span><span class="p">[]</span>  <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">X75_V42BIS</span><span class="p">,</span><span class="n">V120_L2</span><span class="p">,</span><span class="n">V120_V42BIS</span><span class="p">,</span><span class="n">V120_L2</span><span class="p">,</span><span class="mi">6</span><span class="p">};</span>

	<span class="k">const</span> <span class="n">byte</span> <span class="n">llc3</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">const</span> <span class="n">byte</span> <span class="n">header</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">bp_parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">b3_config_parms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lli</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_XONOFF_FLOW_CONTROL</span><span class="p">)</span>
		<span class="n">lli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_OOB_CHANNEL</span><span class="p">)</span>
		<span class="n">lli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">lli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">diva_xdi_extended_features</span> <span class="o">&amp;</span> <span class="n">DIVA_CAPI_USE_CMA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_descriptor</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_descriptor</span> <span class="o">=</span> <span class="n">diva_get_dma_descriptor</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_magic</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_descriptor</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_descriptor</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_descriptor</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lli</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">lli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
			<span class="n">lli</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_descriptor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">lli</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_magic</span><span class="p">;</span>
			<span class="n">lli</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_magic</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">);</span>
			<span class="n">lli</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_magic</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">lli</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_magic</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DIVA_CAPI_SUPPORTS_NO_CANCEL</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;add_b23&quot;</span><span class="p">));</span>
	<span class="n">api_save_msg</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B_protocol</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adv_nl</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Default adv.Nl&quot;</span><span class="p">));</span>
		<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LLI</span><span class="p">,</span> <span class="n">lli</span><span class="p">);</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">=</span> <span class="mi">1</span> <span class="cm">/*XPARENT*/</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">=</span> <span class="mi">0</span> <span class="cm">/*XPARENT*/</span><span class="p">;</span>
		<span class="n">llc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">llc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LLC</span><span class="p">,</span> <span class="n">llc</span><span class="p">);</span>
		<span class="n">dlc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dlc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">MaxDataLength</span><span class="p">);</span>
		<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">DLC</span><span class="p">,</span> <span class="n">dlc</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="cm">/*default*/</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;ret default&quot;</span><span class="p">));</span>
		<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LLI</span><span class="p">,</span> <span class="n">lli</span><span class="p">);</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">=</span> <span class="mi">0</span> <span class="cm">/*X.75   */</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">=</span> <span class="mi">0</span> <span class="cm">/*XPARENT*/</span><span class="p">;</span>
		<span class="n">llc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">llc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LLC</span><span class="p">,</span> <span class="n">llc</span><span class="p">);</span>
		<span class="n">dlc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dlc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">MaxDataLength</span><span class="p">);</span>
		<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">DLC</span><span class="p">,</span> <span class="n">dlc</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;b_prot_len=%d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">word</span><span class="p">)</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span>    <span class="k">return</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wwwsssb&quot;</span><span class="p">,</span> <span class="n">bp_parms</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">bp_parms</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wwwsss&quot;</span><span class="p">,</span> <span class="n">bp_parms</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;b-form.!&quot;</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wwwssss&quot;</span><span class="p">,</span> <span class="n">bp_parms</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;b-form.!&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">ADV_VOICE</span><span class="p">)</span> <span class="cm">/* transparent B on advanced voice */</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span>
		    <span class="o">||</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">_B2_NOT_SUPPORTED</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adv_nl</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span><span class="p">)</span> <span class="k">return</span> <span class="n">_B2_NOT_SUPPORTED</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">((</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="n">B2_RTP</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="n">B3_RTP</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_RTP</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LLI</span><span class="p">,</span> <span class="n">lli</span><span class="p">);</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
		<span class="n">llc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CALL_DIR_ORIGINATE</span> <span class="o">|</span> <span class="n">CALL_DIR_FORCE_OUTG_NL</span><span class="p">))</span> <span class="o">?</span> <span class="mi">14</span> <span class="o">:</span> <span class="mi">13</span><span class="p">;</span>
		<span class="n">llc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LLC</span><span class="p">,</span> <span class="n">llc</span><span class="p">);</span>
		<span class="n">dlc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dlc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">MaxDataLength</span><span class="p">);</span>
		<span class="n">dlc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* Addr A */</span>
		<span class="n">dlc</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Addr B */</span>
		<span class="n">dlc</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="cm">/* modulo mode */</span>
		<span class="n">dlc</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="cm">/* window size */</span>
		<span class="n">dlc</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* XID len Lo  */</span>
		<span class="n">dlc</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* XID len Hi  */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bp_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">9</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bp_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
		<span class="n">dlc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="mi">8</span> <span class="o">+</span> <span class="n">bp_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
		<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">DLC</span><span class="p">,</span> <span class="n">dlc</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bp_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">nlc</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bp_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
		<span class="n">nlc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
		<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">NLC</span><span class="p">,</span> <span class="n">nlc</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>



	<span class="k">if</span> <span class="p">((</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B2_Protocols</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="n">B2_PIAFS</span><span class="p">)</span>
		    <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_PIAFS</span><span class="p">)))))</span>

	<span class="p">{</span>
		<span class="k">return</span> <span class="n">_B2_NOT_SUPPORTED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span>
	    <span class="o">||</span> <span class="o">!</span><span class="p">((</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B3_Protocols</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="n">_B3_NOT_SUPPORTED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="n">B2_SDLC</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="n">B1_MODEM_ALL_NEGOTIATE</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="n">B1_MODEM_ASYNC</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="n">B1_MODEM_SYNC_HDLC</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">add_modem_b23</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">bp_parms</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LLI</span><span class="p">,</span> <span class="n">lli</span><span class="p">);</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span> <span class="n">SAPI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* default SAPI D-channel */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">length</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">global_config</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">return</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">global_config</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">))</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CALL_DIR_ANSWER</span><span class="p">)</span> <span class="o">|</span> <span class="n">CALL_DIR_ORIGINATE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CALL_DIR_ORIGINATE</span><span class="p">)</span> <span class="o">|</span> <span class="n">CALL_DIR_ANSWER</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;call_dir=%04x&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span><span class="p">));</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">==</span> <span class="n">B2_PIAFS</span><span class="p">)</span>
		<span class="n">llc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">PIAFS_CRC</span><span class="p">;</span>
	<span class="k">else</span>
<span class="cm">/* IMPLEMENT_PIAFS */</span>
	<span class="p">{</span>
		<span class="n">llc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CALL_DIR_ORIGINATE</span> <span class="o">|</span> <span class="n">CALL_DIR_FORCE_OUTG_NL</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">llc2_out</span><span class="p">[</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">)]</span> <span class="o">:</span> <span class="n">llc2_in</span><span class="p">[</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">)];</span>
	<span class="p">}</span>
	<span class="n">llc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">llc3</span><span class="p">[</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">)];</span>

	<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LLC</span><span class="p">,</span> <span class="n">llc</span><span class="p">);</span>

	<span class="n">dlc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dlc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">MaxDataLength</span> <span class="o">+</span>
		 <span class="n">header</span><span class="p">[</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">)]);</span>

	<span class="n">b1_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">nlc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">4</span>
	    <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T30_INFO</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">nlc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nlc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T30_INFO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_FAX_PAPER_FORMATS</span><span class="p">)</span>
			<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">=</span> <span class="n">T30_OPERATING_MODE_CAPI</span><span class="p">;</span>
		<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">rate_div_2400</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b1_config</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">rate_div_2400</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b1_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2400</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">b2_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">PIAFS_CRC</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">!=</span> <span class="n">B3_TRANSPARENT</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">return</span> <span class="n">_B_STACK_NOT_SUPPORTED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;bwww&quot;</span><span class="p">,</span> <span class="n">b2_config_parms</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dlc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">MaxDataLength</span><span class="p">);</span>
		<span class="n">dlc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Addr A */</span>
		<span class="n">dlc</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Addr B */</span>
		<span class="n">dlc</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* modulo mode */</span>
		<span class="n">dlc</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* window size */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cm">/* PIAFS protocol Speed configuration */</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cm">/* V.42bis P0 */</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="cm">/* V.42bis P0 */</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cm">/* V.42bis P1 */</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="cm">/* V.42bis P1 */</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cm">/* V.42bis P2 */</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="cm">/* V.42bis P2 */</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* PIAFS control abilities */</span>
				<span class="n">dlc</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
				<span class="n">dlc</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* Length of PIAFS extension */</span>
				<span class="n">dlc</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">PIAFS_UDATA_ABILITIES</span><span class="p">;</span> <span class="cm">/* control (UDATA) ability */</span>
				<span class="n">dlc</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cm">/* value */</span>
				<span class="n">dlc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="cm">/* default values, 64K, variable, no compression */</span>
		<span class="p">{</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span> <span class="cm">/* PIAFS protocol Speed configuration */</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span> <span class="cm">/* V.42bis P0 */</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* V.42bis P0 */</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* V.42bis P1 */</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* V.42bis P1 */</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* V.42bis P2 */</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* V.42bis P2 */</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">DLC</span><span class="p">,</span> <span class="n">dlc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">llc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">V120_L2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">llc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">V120_V42BIS</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">!=</span> <span class="n">B3_TRANSPARENT</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">_B_STACK_NOT_SUPPORTED</span><span class="p">;</span>

			<span class="n">dlc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dlc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
			<span class="n">dlc</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">llc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">V120_V42BIS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;bbbbwww&quot;</span><span class="p">,</span> <span class="n">b2_config_parms</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">return</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">dlc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)((</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">));</span>
				<span class="n">dlc</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)((</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">128</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;1D-dlc= %x %x %x %x %x&quot;</span><span class="p">,</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>
					<span class="k">return</span> <span class="n">_B2_PARM_NOT_SUPPORTED</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">dlc</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">dlc</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">V120_V42BIS</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">dlc</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
						<span class="n">dlc</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">dlc</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
						<span class="n">dlc</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
						<span class="n">dlc</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
						<span class="n">dlc</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
						<span class="n">dlc</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
						<span class="n">dlc</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
						<span class="n">dlc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;b2_config_parms[4].info[0] [1]:  %x %x&quot;</span><span class="p">,</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;b2_config_parms[5].info[0] [1]:  %x %x&quot;</span><span class="p">,</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;b2_config_parms[6].info[0] [1]:  %x %x&quot;</span><span class="p">,</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
					<span class="p">}</span>
					<span class="k">else</span> <span class="p">{</span>
						<span class="n">dlc</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;B2-Config&quot;</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">X75_V42BIS</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;bbbbwww&quot;</span><span class="p">,</span> <span class="n">b2_config_parms</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="k">return</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;bbbbs&quot;</span><span class="p">,</span> <span class="n">b2_config_parms</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="k">return</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="cm">/* if B2 Protocol is LAPD, b2_config structure is different */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dlc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>      <span class="cm">/* TEI */</span>
					<span class="k">else</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">==</span> <span class="mi">12</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">SAPI</span> <span class="o">=</span> <span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>    <span class="cm">/* SAPI */</span>
					<span class="p">}</span>
					<span class="n">dlc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SAPI</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">128</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">dlc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>      <span class="cm">/* Mode */</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">dlc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>        <span class="cm">/* Mode */</span>
					<span class="p">}</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>      <span class="cm">/* Window */</span>
					<span class="k">else</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;D-dlc[%d]=%x,%x,%x,%x&quot;</span><span class="p">,</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="k">return</span> <span class="n">_B2_PARM_NOT_SUPPORTED</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">dlc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">length</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
					<span class="n">dlc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
					<span class="n">dlc</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;1D-dlc= %x %x %x %x %x&quot;</span><span class="p">,</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>
						<span class="k">return</span> <span class="n">_B2_PARM_NOT_SUPPORTED</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">dlc</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
					<span class="n">dlc</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dlc</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;2D-dlc= %x %x %x %x %x %x %x&quot;</span><span class="p">,</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">6</span><span class="p">]));</span>
						<span class="k">return</span> <span class="n">_B2_PARM_NOT_SUPPORTED</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">llc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">X75_V42BIS</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">b2_config</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">dlc</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
							<span class="n">dlc</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="n">dlc</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
							<span class="n">dlc</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
							<span class="n">dlc</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
							<span class="n">dlc</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
							<span class="n">dlc</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
							<span class="n">dlc</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
							<span class="n">dlc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
							<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;b2_config_parms[4].info[0] [1]:  %x %x&quot;</span><span class="p">,</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
							<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;b2_config_parms[5].info[0] [1]:  %x %x&quot;</span><span class="p">,</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
							<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;b2_config_parms[6].info[0] [1]:  %x %x&quot;</span><span class="p">,</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
						<span class="p">}</span>
						<span class="k">else</span> <span class="p">{</span>
							<span class="n">dlc</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
						<span class="p">}</span>

					<span class="p">}</span>
					<span class="k">else</span> <span class="p">{</span>
						<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dlc</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
						<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
							<span class="n">dlc</span><span class="p">[</span><span class="mi">11</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2_config_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">DLC</span><span class="p">,</span> <span class="n">dlc</span><span class="p">);</span>

	<span class="n">b3_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b3_config</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">4</span>
		    <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b3_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">b3_config</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wwss&quot;</span><span class="p">,</span> <span class="n">b3_config_parms</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="k">return</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">b3_config_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">));</span>
			<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">resolution</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="o">||</span>
								    <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">byte</span><span class="p">)(</span><span class="n">GET_WORD</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">b3_config_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">)))</span> <span class="o">?</span> <span class="n">T30_RESOLUTION_R8_0770_OR_200</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">data_format</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">GET_WORD</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">b3_config_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">));</span>
			<span class="n">fax_control_bits</span> <span class="o">=</span> <span class="n">T30_CONTROL_BIT_ALL_FEATURES</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">rate_div_2400</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">rate_div_2400</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">))</span>
				<span class="n">fax_control_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">T30_CONTROL_BIT_ENABLE_V34FAX</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_FAX_PAPER_FORMATS</span><span class="p">)</span>
			<span class="p">{</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options_conn</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">requested_options_table</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
				    <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_PAPER_FORMATS</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">resolution</span> <span class="o">|=</span> <span class="n">T30_RESOLUTION_R8_1540</span> <span class="o">|</span>
						<span class="n">T30_RESOLUTION_R16_1540_OR_400</span> <span class="o">|</span> <span class="n">T30_RESOLUTION_300_300</span> <span class="o">|</span>
						<span class="n">T30_RESOLUTION_INCH_BASED</span> <span class="o">|</span> <span class="n">T30_RESOLUTION_METRIC_BASED</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">recording_properties</span> <span class="o">=</span>
					<span class="n">T30_RECORDING_WIDTH_ISO_A3</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">T30_RECORDING_LENGTH_UNLIMITED</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">T30_MIN_SCANLINE_TIME_00_00_00</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x0002</span><span class="p">)</span> <span class="cm">/* Accept incoming fax-polling requests */</span>
					<span class="n">fax_control_bits</span> <span class="o">|=</span> <span class="n">T30_CONTROL_BIT_ACCEPT_POLLING</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x2000</span><span class="p">)</span> <span class="cm">/* Do not use MR compression */</span>
					<span class="n">fax_control_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">T30_CONTROL_BIT_ENABLE_2D_CODING</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="cm">/* Do not use MMR compression */</span>
					<span class="n">fax_control_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">T30_CONTROL_BIT_ENABLE_T6_CODING</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="cm">/* Do not use ECM */</span>
					<span class="n">fax_control_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">T30_CONTROL_BIT_ENABLE_ECM</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">resolution</span> <span class="o">=</span> <span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">resolution</span><span class="p">;</span>
					<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">data_format</span> <span class="o">=</span> <span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data_format</span><span class="p">;</span>
					<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">recording_properties</span> <span class="o">=</span> <span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">recording_properties</span><span class="p">;</span>
					<span class="n">fax_control_bits</span> <span class="o">|=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">control_bits_low</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="p">(</span><span class="n">T30_CONTROL_BIT_REQUEST_POLLING</span> <span class="o">|</span> <span class="n">T30_CONTROL_BIT_MORE_DOCUMENTS</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/* copy station id to NLC */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">T30_MAX_STATION_ID_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">b3_config_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">length</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">station_id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">b3_config_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">)[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">station_id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">station_id_len</span> <span class="o">=</span> <span class="n">T30_MAX_STATION_ID_LENGTH</span><span class="p">;</span>
			<span class="cm">/* copy head line to NLC */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b3_config_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">length</span><span class="p">)</span>
			<span class="p">{</span>

				<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">fax_head_line_time</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">station_id</span><span class="p">[</span><span class="n">T30_MAX_STATION_ID_LENGTH</span><span class="p">])));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">CAPI_MAX_DATE_TIME_LENGTH</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">b3_config_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">CAPI_MAX_HEAD_LINE_SPACE</span><span class="p">)</span>
						<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">nlc</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">T30_INFO</span><span class="p">,</span> <span class="n">station_id</span><span class="p">)</span> <span class="o">+</span> <span class="n">T30_MAX_STATION_ID_LENGTH</span> <span class="o">+</span> <span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
						<span class="n">nlc</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">T30_INFO</span><span class="p">,</span> <span class="n">station_id</span><span class="p">)</span> <span class="o">+</span> <span class="n">T30_MAX_STATION_ID_LENGTH</span> <span class="o">+</span> <span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
						<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">b3_config_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span>
							<span class="n">len</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">CAPI_MAX_DATE_TIME_LENGTH</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">b3_config_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="n">CAPI_MAX_HEAD_LINE_SPACE</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
								<span class="n">nlc</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">T30_INFO</span><span class="p">,</span> <span class="n">station_id</span><span class="p">)</span> <span class="o">+</span> <span class="n">T30_MAX_STATION_ID_LENGTH</span> <span class="o">+</span> <span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">b3_config_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">)[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
							<span class="n">nlc</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">T30_INFO</span><span class="p">,</span> <span class="n">station_id</span><span class="p">)</span> <span class="o">+</span> <span class="n">T30_MAX_STATION_ID_LENGTH</span> <span class="o">+</span> <span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
							<span class="n">nlc</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">T30_INFO</span><span class="p">,</span> <span class="n">station_id</span><span class="p">)</span> <span class="o">+</span> <span class="n">T30_MAX_STATION_ID_LENGTH</span> <span class="o">+</span> <span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">b3_config_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">CAPI_MAX_HEAD_LINE_SPACE</span> <span class="o">-</span> <span class="n">pos</span><span class="p">)</span>
					<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">CAPI_MAX_HEAD_LINE_SPACE</span> <span class="o">-</span> <span class="n">pos</span><span class="p">);</span>
				<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">head_line_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
				<span class="n">nlc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">nlc</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">T30_INFO</span><span class="p">,</span> <span class="n">station_id</span><span class="p">)</span> <span class="o">+</span> <span class="n">T30_MAX_STATION_ID_LENGTH</span> <span class="o">+</span> <span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>  <span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">b3_config_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">)[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">head_line_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">nsf_control_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_SUB_SEP_PWD</span><span class="p">))</span>
				    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">b3_config_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">))</span> <span class="cm">/* Private SUB/SEP/PWD enable */</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options</span> <span class="o">|=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_SUB_SEP_PWD</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_NONSTANDARD</span><span class="p">))</span>
				    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">b3_config_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x4000</span><span class="p">))</span> <span class="cm">/* Private non-standard facilities enable */</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options</span> <span class="o">|=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_NONSTANDARD</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options_conn</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">requested_options_table</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
				    <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_SUB_SEP_PWD</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_NONSTANDARD</span><span class="p">)))</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options_conn</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">requested_options_table</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
					    <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_SUB_SEP_PWD</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">fax_control_bits</span> <span class="o">|=</span> <span class="n">T30_CONTROL_BIT_ACCEPT_SUBADDRESS</span> <span class="o">|</span> <span class="n">T30_CONTROL_BIT_ACCEPT_PASSWORD</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">fax_control_bits</span> <span class="o">&amp;</span> <span class="n">T30_CONTROL_BIT_ACCEPT_POLLING</span><span class="p">)</span>
							<span class="n">fax_control_bits</span> <span class="o">|=</span> <span class="n">T30_CONTROL_BIT_ACCEPT_SEL_POLLING</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">len</span> <span class="o">=</span> <span class="n">nlc</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
					<span class="n">pos</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">T30_INFO</span><span class="p">,</span> <span class="n">station_id</span><span class="p">)</span> <span class="o">+</span> <span class="n">T30_MAX_STATION_ID_LENGTH</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_length</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">pos</span><span class="p">];</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
							<span class="n">nlc</span><span class="p">[</span><span class="o">++</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">];</span>
					<span class="p">}</span>
					<span class="k">else</span>
						<span class="n">nlc</span><span class="p">[</span><span class="o">++</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_length</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">pos</span><span class="p">];</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
							<span class="n">nlc</span><span class="p">[</span><span class="o">++</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">];</span>
					<span class="p">}</span>
					<span class="k">else</span>
						<span class="n">nlc</span><span class="p">[</span><span class="o">++</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options_conn</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">requested_options_table</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
					    <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_FAX_NONSTANDARD</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_length</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
						<span class="p">{</span>
							<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">))</span>
								<span class="n">plci</span><span class="o">-&gt;</span><span class="n">nsf_control_bits</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>
							<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">pos</span><span class="p">];</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
								<span class="n">nlc</span><span class="p">[</span><span class="o">++</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">];</span>
						<span class="p">}</span>
						<span class="k">else</span>
						<span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b3_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">b3_config</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wwsss&quot;</span><span class="p">,</span> <span class="n">b3_config_parms</span><span class="p">))</span>
							<span class="p">{</span>
								<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;non-standard facilities info missing or wrong format&quot;</span><span class="p">));</span>
								<span class="n">nlc</span><span class="p">[</span><span class="o">++</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="k">else</span>
							<span class="p">{</span>
								<span class="k">if</span> <span class="p">((</span><span class="n">b3_config_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b3_config_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">))</span>
									<span class="n">plci</span><span class="o">-&gt;</span><span class="n">nsf_control_bits</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b3_config_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
								<span class="n">nlc</span><span class="p">[</span><span class="o">++</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">b3_config_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
								<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">b3_config_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
									<span class="n">nlc</span><span class="p">[</span><span class="o">++</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="n">b3_config_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
							<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="n">nlc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nsf_control_bits</span> <span class="o">&amp;</span> <span class="n">T30_NSF_CONTROL_BIT_ENABLE_NSF</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nsf_control_bits</span> <span class="o">&amp;</span> <span class="n">T30_NSF_CONTROL_BIT_NEGOTIATE_RESP</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">=</span> <span class="n">T30_OPERATING_MODE_CAPI_NEG</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">control_bits_low</span><span class="p">),</span> <span class="n">fax_control_bits</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">T30_INFO</span><span class="p">,</span> <span class="n">station_id</span><span class="p">)</span> <span class="o">+</span> <span class="n">T30_MAX_STATION_ID_LENGTH</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlc</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
			<span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">head_line_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="p">((</span><span class="n">T30_INFO</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nlc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">head_line_len</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">nlc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlc</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">];</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">nlc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b3_config</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">_B3_PARM_NOT_SUPPORTED</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">nlc</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b3_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b3_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b3_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">128</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">_B3_PARM_NOT_SUPPORTED</span><span class="p">;</span>
			<span class="n">nlc</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">b3_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b3_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">15</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">nlc</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span>
				<span class="k">return</span> <span class="n">_B3_PARM_NOT_SUPPORTED</span><span class="p">;</span>
			<span class="n">nlc</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">b3_config</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">4</span>
		    <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">5</span> <span class="cm">/*T.30 - FAX*/</span><span class="p">)</span> <span class="k">return</span> <span class="n">_B3_PARM_NOT_SUPPORTED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">NLC</span><span class="p">,</span> <span class="n">nlc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------*/</span>
<span class="cm">/*      make the same as add_b23, but only for the modem related  */</span>
<span class="cm">/*      L2 and L3 B-Chan protocol.                                */</span>
<span class="cm">/*                                                                */</span>
<span class="cm">/*      Enabled L2 and L3 Configurations:                         */</span>
<span class="cm">/*        If L1 == Modem all negotiation                          */</span>
<span class="cm">/*          only L2 == Modem with full negotiation is allowed     */</span>
<span class="cm">/*        If L1 == Modem async or sync                            */</span>
<span class="cm">/*          only L2 == Transparent is allowed                     */</span>
<span class="cm">/*        L3 == Modem or L3 == Transparent are allowed            */</span>
<span class="cm">/*      B2 Configuration for modem:                               */</span>
<span class="cm">/*          word : enable/disable compression, bitoptions         */</span>
<span class="cm">/*      B3 Configuration for modem:                               */</span>
<span class="cm">/*          empty                                                 */</span>
<span class="cm">/*----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="n">word</span> <span class="nf">add_modem_b23</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">bp_parms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">byte</span> <span class="n">lli</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">};</span>
	<span class="k">static</span> <span class="n">byte</span> <span class="n">llc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">static</span> <span class="n">byte</span> <span class="n">dlc</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
	<span class="n">API_PARSE</span> <span class="n">mdm_config</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">b2_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">mdm_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dlc</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">dlc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="n">B1_MODEM_ALL_NEGOTIATE</span><span class="p">)</span>
	     <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="n">B2_MODEM_EC_COMPRESSION</span><span class="p">))</span>
	    <span class="o">||</span> <span class="p">((</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="n">B1_MODEM_ALL_NEGOTIATE</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="n">B2_TRANSPARENT</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">_B_STACK_NOT_SUPPORTED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="n">B3_MODEM</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="n">B3_TRANSPARENT</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">_B_STACK_NOT_SUPPORTED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="n">B2_MODEM_EC_COMPRESSION</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">bp_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">length</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			      <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span>
			      <span class="n">mdm_config</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">b2_config</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">mdm_config</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* OK, L2 is modem */</span>

	<span class="n">lli</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_XONOFF_FLOW_CONTROL</span><span class="p">)</span>
		<span class="n">lli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_OOB_CHANNEL</span><span class="p">)</span>
		<span class="n">lli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">lli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">diva_xdi_extended_features</span> <span class="o">&amp;</span> <span class="n">DIVA_CAPI_USE_CMA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_descriptor</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_descriptor</span> <span class="o">=</span> <span class="n">diva_get_dma_descriptor</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_magic</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_descriptor</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_descriptor</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_descriptor</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
			<span class="n">lli</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">lli</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_descriptor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">lli</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_magic</span><span class="p">;</span>
			<span class="n">lli</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_magic</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">);</span>
			<span class="n">lli</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_magic</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">lli</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">rx_dma_magic</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DIVA_CAPI_SUPPORTS_NO_CANCEL</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">llc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CALL_DIR_ORIGINATE</span> <span class="o">|</span> <span class="n">CALL_DIR_FORCE_OUTG_NL</span><span class="p">))</span> <span class="o">?</span>
		<span class="cm">/*V42*/</span> <span class="mi">10</span> <span class="o">:</span> <span class="cm">/*V42_IN*/</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">llc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>                      <span class="cm">/* pass L3 always transparent */</span>
	<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LLI</span><span class="p">,</span> <span class="n">lli</span><span class="p">);</span>
	<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LLC</span><span class="p">,</span> <span class="n">llc</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span>  <span class="mi">1</span><span class="p">;</span>
	<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dlc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">MaxDataLength</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="n">B2_MODEM_EC_COMPRESSION</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp_parms</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">length</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;MDM b2_config=%02x&quot;</span><span class="p">,</span> <span class="n">b2_config</span><span class="p">));</span>
			<span class="n">dlc</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* Addr A */</span>
			<span class="n">dlc</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Addr B */</span>
			<span class="n">dlc</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="cm">/* modulo mode */</span>
			<span class="n">dlc</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="cm">/* window size */</span>
			<span class="n">dlc</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* XID len Lo  */</span>
			<span class="n">dlc</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* XID len Hi  */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">b2_config</span> <span class="o">&amp;</span> <span class="n">MDM_B2_DISABLE_V42bis</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">dlc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DLC_MODEMPROT_DISABLE_V42_V42BIS</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b2_config</span> <span class="o">&amp;</span> <span class="n">MDM_B2_DISABLE_MNP</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">dlc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DLC_MODEMPROT_DISABLE_MNP_MNP5</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b2_config</span> <span class="o">&amp;</span> <span class="n">MDM_B2_DISABLE_TRANS</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">dlc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DLC_MODEMPROT_REQUIRE_PROTOCOL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b2_config</span> <span class="o">&amp;</span> <span class="n">MDM_B2_DISABLE_V42</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">dlc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DLC_MODEMPROT_DISABLE_V42_DETECT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b2_config</span> <span class="o">&amp;</span> <span class="n">MDM_B2_DISABLE_COMP</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">dlc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DLC_MODEMPROT_DISABLE_COMPRESSION</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">dlc</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* Addr A */</span>
		<span class="n">dlc</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Addr B */</span>
		<span class="n">dlc</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="cm">/* modulo mode */</span>
		<span class="n">dlc</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="cm">/* window size */</span>
		<span class="n">dlc</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* XID len Lo  */</span>
		<span class="n">dlc</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* XID len Hi  */</span>
		<span class="n">dlc</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">DLC_MODEMPROT_DISABLE_V42_V42BIS</span> <span class="o">|</span>
			<span class="n">DLC_MODEMPROT_DISABLE_MNP_MNP5</span> <span class="o">|</span>
			<span class="n">DLC_MODEMPROT_DISABLE_V42_DETECT</span> <span class="o">|</span>
			<span class="n">DLC_MODEMPROT_DISABLE_COMPRESSION</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dlc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="cm">/* HexDump (&quot;DLC&quot;, sizeof(dlc), &amp;dlc[0]); */</span>
	<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">DLC</span><span class="p">,</span> <span class="n">dlc</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* send a request for the signaling entity                          */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sig_req</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">req</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_disabled</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;sig_req(%x)&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="n">REMOVE</span><span class="p">)</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_remove_id</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in_start</span><span class="p">],</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">-</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in_start</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">Id</span><span class="p">;</span>   <span class="cm">/* sig/nl flag */</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>  <span class="cm">/* request */</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* channel */</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in_start</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* send a request for the network layer entity                      */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nl_req_ncci</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">req</span><span class="p">,</span> <span class="n">byte</span> <span class="n">ncci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_disabled</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;nl_req %02x %02x %02x&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">ncci</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="n">REMOVE</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span><span class="p">;</span>
		<span class="n">ncci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">ncci</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">ncci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in_start</span><span class="p">],</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">-</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in_start</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>    <span class="cm">/* sig/nl flag */</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>  <span class="cm">/* request */</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">ncci</span><span class="p">];</span>   <span class="cm">/* channel */</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in_start</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_req</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ENTITY</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">l</span><span class="p">;</span>
<span class="cm">/*  word i; */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_disabled</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="n">channel_xmit_xon</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>

	<span class="cm">/* if nothing to do, return */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;send_req(in=%d,out=%d)&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_req</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="p">]);</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">XData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="p">];</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span> <span class="o">+=</span> <span class="n">l</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">e</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="o">++</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">Req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="o">++</span><span class="p">];</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">ReqCh</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="o">++</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">=</span> <span class="n">NL_ID</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">CAI</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">l</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_global_req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;%x:NLREQ(%x:%x:%x)&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Req</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ReqCh</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">e</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="p">])</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="p">];</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="o">++</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">Req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="o">++</span><span class="p">];</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">ReqCh</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_out</span><span class="o">++</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">))</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_global_req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_req</span><span class="p">;</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;%x:SIGREQ(%x:%x:%x)&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Req</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ReqCh</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">XData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">X</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">XData</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;send_ok&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_data</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">DATA_B3_DESC</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">NCCI</span>   <span class="o">*</span><span class="n">ncci_ptr</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">ncci</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncci_ring_list</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
		<span class="n">ncci</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncci_ring_list</span><span class="p">;</span>
		<span class="k">do</span>
		<span class="p">{</span>
			<span class="n">ncci</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_next</span><span class="p">[</span><span class="n">ncci</span><span class="p">];</span>
			<span class="n">ncci_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci</span><span class="p">[</span><span class="n">ncci</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span>
			      <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">ncci</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="n">N_OK_FC_PENDING</span><span class="p">)))</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_pending</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">CONNECTED</span><span class="p">)</span>
					    <span class="o">||</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_state</span><span class="p">[</span><span class="n">ncci</span><span class="p">]</span> <span class="o">==</span> <span class="n">INC_ACT_PENDING</span><span class="p">)</span>
					    <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">send_disc</span> <span class="o">==</span> <span class="n">ncci</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">DBuffer</span><span class="p">[</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_out</span><span class="p">]);</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">==</span> <span class="n">B2_V120_ASYNC</span><span class="p">)</span>
						    <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">==</span> <span class="n">B2_V120_ASYNC_V42BIS</span><span class="p">)</span>
						    <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B2_prot</span> <span class="o">==</span> <span class="n">B2_V120_BIT_TRANSPARENT</span><span class="p">))</span>
						<span class="p">{</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">TransmitBufferGet</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">);</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">PLength</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">Length</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
								<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">v120_break_header</span><span class="p">;</span>
							<span class="k">else</span>
								<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">v120_default_header</span><span class="p">;</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">XNum</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">N_DATA</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="k">else</span>
						<span class="p">{</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">TransmitBufferGet</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">);</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">Length</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
								<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">N_UDATA</span><span class="p">;</span>

							<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="n">B3_RTP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
								<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">N_BDATA</span><span class="p">;</span>

							<span class="k">else</span>
								<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">N_DATA</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">;</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">ReqCh</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">ncci</span><span class="p">];</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;%x:DREQ(%x:%x)&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Req</span><span class="p">));</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">data_sent</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">data_sent_ptr</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">;</span>
						<span class="n">a</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">else</span> <span class="p">{</span>
						<span class="n">cleanup_ncci_data</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ncci</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">send_disc</span> <span class="o">==</span> <span class="n">ncci</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="cm">/* dprintf(&quot;N_DISC&quot;); */</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">ReqCh</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">ncci</span><span class="p">];</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">=</span> <span class="n">N_DISC</span><span class="p">;</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">);</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">_DISCONNECT_B3_R</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">send_disc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ncci</span> <span class="o">!=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncci_ring_list</span><span class="p">));</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncci_ring_list</span> <span class="o">=</span> <span class="n">ncci</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">listen_check</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">activnotifiedcalls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;listen_check(%d,%d)&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">listen_active</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">max_listen</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">remove_started</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">adapter_disabled</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">max_plci</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">notifiedcall</span><span class="p">)</span> <span class="n">activnotifiedcalls</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;listen_check(%d)&quot;</span><span class="p">,</span> <span class="n">activnotifiedcalls</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">listen_active</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">word</span><span class="p">)(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">max_listen</span> <span class="o">+</span> <span class="n">activnotifiedcalls</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">=</span> <span class="n">get_plci</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">listen_active</span><span class="o">++</span><span class="p">;</span>
				<span class="n">plci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">LISTENING</span><span class="p">;</span>

				<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">OAD</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\xfd</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">KEY</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x04\x43\x41\x32\x30</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\xc0</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">UID</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x06\x43\x61\x70\x69\x32\x30</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">LLI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\xc4</span><span class="s">&quot;</span><span class="p">);</span>                  <span class="cm">/* support Dummy CR FAC + MWI + SpoofNotify */</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">SHIFT</span> <span class="o">|</span> <span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">SIN</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x02\x00\x00</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">LISTEN_SIG_ASSIGN_PEND</span><span class="p">;</span>     <span class="cm">/* do indicate_req if OK  */</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="n">DSIG_ID</span><span class="p">);</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* functions for all parameters sent in INDs                        */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">IndParse</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">word</span> <span class="o">*</span><span class="n">parms_id</span><span class="p">,</span> <span class="n">byte</span> <span class="o">**</span><span class="n">parms</span><span class="p">,</span> <span class="n">byte</span> <span class="n">multiIEsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">ploc</span><span class="p">;</span>            <span class="cm">/* points to current location within packet */</span>
	<span class="n">byte</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">wlen</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">codeset</span><span class="p">,</span> <span class="n">lock</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">in</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">code</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">mIEindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ploc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">codeset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">in</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">P</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parms_id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>   <span class="cm">/* multiIE parms_id contains just the 1st */</span>
	<span class="p">{</span>                            <span class="cm">/* element but parms array is larger      */</span>
		<span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">multiIEsize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ploc</span> <span class="o">&lt;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">RBuffer</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* read information element id and length                   */</span>
		<span class="n">w</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="n">ploc</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
<span class="cm">/*    w &amp;=0xf0; removed, cannot detect congestion levels */</span>
<span class="cm">/*    upper 4 bit masked with w==SHIFT now               */</span>
			<span class="n">wlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">wlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">in</span><span class="p">[</span><span class="n">ploc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* check if length valid (not exceeding end of packet)      */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ploc</span> <span class="o">+</span> <span class="n">wlen</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">270</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="n">lock</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="k">else</span> <span class="n">codeset</span> <span class="o">=</span> <span class="n">lock</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">w</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="n">SHIFT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">codeset</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="n">ploc</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">codeset</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">))</span> <span class="n">lock</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">codeset</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
			<span class="n">codeset</span> <span class="o">&amp;=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">lock</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">==</span> <span class="n">ESC</span> <span class="o">&amp;&amp;</span> <span class="n">wlen</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="n">code</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="n">ploc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x800</span><span class="p">;</span>
			<span class="k">else</span> <span class="n">code</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
			<span class="n">code</span> <span class="o">|=</span> <span class="p">(</span><span class="n">codeset</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parms_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">parms_id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">code</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">parms_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">multiIEsize</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* with multiIEs use next field index,          */</span>
					<span class="n">mIEindex</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>    <span class="cm">/* with normal IEs use same index like parms_id */</span>
				<span class="p">}</span>

				<span class="n">parms</span><span class="p">[</span><span class="n">mIEindex</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">in</span><span class="p">[</span><span class="n">ploc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;mIE[%d]=0x%x&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">parms</span><span class="p">[</span><span class="n">mIEindex</span><span class="p">],</span> <span class="n">in</span><span class="p">[</span><span class="n">ploc</span><span class="p">]));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">parms_id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">OAD</span>
				    <span class="o">||</span> <span class="n">parms_id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">CONN_NR</span>
				    <span class="o">||</span> <span class="n">parms_id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">CAD</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="p">[</span><span class="n">ploc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">in</span><span class="p">[</span><span class="n">ploc</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">in</span><span class="p">[</span><span class="n">ploc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
						<span class="n">in</span><span class="p">[</span><span class="n">ploc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">in</span><span class="p">[</span><span class="n">ploc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
						<span class="n">in</span><span class="p">[</span><span class="n">ploc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
						<span class="n">parms</span><span class="p">[</span><span class="n">mIEindex</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">in</span><span class="p">[</span><span class="n">ploc</span><span class="p">];</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">mIEindex</span><span class="o">++</span><span class="p">;</span>       <span class="cm">/* effects multiIEs only */</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ploc</span> <span class="o">+=</span> <span class="p">(</span><span class="n">wlen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* try to match a cip from received BC and HLC                      */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">ie_compare</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">ie1</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">ie2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ie1</span> <span class="o">||</span> <span class="o">!</span><span class="n">ie2</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ie1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">ie1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">ie1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ie2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">word</span> <span class="nf">find_cip</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">bc</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">hlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ie_compare</span><span class="p">(</span><span class="n">bc</span><span class="p">,</span> <span class="n">cip_bc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">u_law</span><span class="p">]);</span> <span class="n">i</span><span class="o">--</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">29</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="o">!</span><span class="n">ie_compare</span><span class="p">(</span><span class="n">bc</span><span class="p">,</span> <span class="n">cip_bc</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">u_law</span><span class="p">])</span> <span class="o">||</span> <span class="o">!</span><span class="n">ie_compare</span><span class="p">(</span><span class="n">hlc</span><span class="p">,</span> <span class="n">cip_hlc</span><span class="p">[</span><span class="n">j</span><span class="p">]));</span> <span class="n">j</span><span class="o">++</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)</span> <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">j</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">byte</span> <span class="nf">AddInfo</span><span class="p">(</span><span class="n">byte</span> <span class="o">**</span><span class="n">add_i</span><span class="p">,</span>
		    <span class="n">byte</span> <span class="o">**</span><span class="n">fty_i</span><span class="p">,</span>
		    <span class="n">byte</span> <span class="o">*</span><span class="n">esc_chi</span><span class="p">,</span>
		    <span class="n">byte</span> <span class="o">*</span><span class="n">facility</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">byte</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">k</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">flen</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* facility is a nested structure */</span>
	<span class="cm">/* FTY can be more than once      */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esc_chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">esc_chi</span><span class="p">[</span><span class="n">esc_chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">add_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;</span><span class="se">\x02\x02\x00</span><span class="s">&quot;</span><span class="p">;</span> <span class="cm">/* use neither b nor d channel */</span>
	<span class="p">}</span>

	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">add_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fty_i</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
	<span class="p">{</span>
		<span class="n">add_i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>    <span class="cm">/* facility array found  */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_MULTI_IE</span> <span class="o">&amp;&amp;</span> <span class="n">fty_i</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;AddIFac[%d]&quot;</span><span class="p">,</span> <span class="n">fty_i</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]));</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">fty_i</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">flen</span> <span class="o">=</span> <span class="n">fty_i</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">facility</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1c</span><span class="p">;</span> <span class="cm">/* copy fac IE */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="n">flen</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">facility</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fty_i</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">];</span>
<span class="cm">/*      dbug(1, dprintf(&quot;%x &quot;,facility[j])); */</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">facility</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">add_i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">facility</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cm">/*  dbug(1, dprintf(&quot;FacArrLen=%d &quot;,len)); */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">add_i</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">add_i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">add_i</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">add_i</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>                          <span class="cm">/* calculate length of all */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* voice and codec features                                         */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">SetVoiceChannel</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">chi</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">byte</span> <span class="n">voice_chi</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x02\x18\x01</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">channel</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">chi</span><span class="p">[</span><span class="n">chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;ExtDevON(Ch=0x%x)&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">));</span>
	<span class="n">voice_chi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="o">?</span> <span class="n">channel</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">FTY</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x02\x01\x07</span><span class="s">&quot;</span><span class="p">);</span>             <span class="cm">/* B On, default on 1 */</span>
	<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ESC</span><span class="p">,</span> <span class="n">voice_chi</span><span class="p">);</span>                  <span class="cm">/* Channel */</span>
	<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">TEL_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">adv_voice_write_coefs</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">,</span> <span class="n">ADV_VOICE_WRITE_ACTIVATION</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">VoiceChannelOff</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;ExtDevOFF&quot;</span><span class="p">));</span>
	<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">FTY</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x02\x01\x08</span><span class="s">&quot;</span><span class="p">);</span>             <span class="cm">/* B Off */</span>
	<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">TEL_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">adv_voice_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">word</span> <span class="nf">AdvCodecSupport</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span>
			    <span class="n">byte</span> <span class="n">hook_listen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">splci</span><span class="p">;</span>

	<span class="cm">/* check if hardware supports handset with hook states (adv.codec) */</span>
	<span class="cm">/* or if just a on board codec is supported                        */</span>
	<span class="cm">/* the advanced codec plci is just for internal use                */</span>

	<span class="cm">/* diva Pro with on-board codec:                                   */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span> <span class="o">&amp;</span> <span class="n">HANDSET</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/* new call, but hook states are already signalled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvCodecFLAG</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalAppl</span> <span class="o">!=</span> <span class="n">appl</span> <span class="o">||</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;AdvSigPlci=0x%x&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">));</span>
				<span class="k">return</span> <span class="mh">0x2001</span><span class="p">;</span> <span class="cm">/* codec in use by another application */</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span> <span class="o">=</span> <span class="n">plci</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">=</span> <span class="n">ADV_VOICE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>                      <span class="cm">/* adv codec still used */</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">=</span> <span class="n">get_plci</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
		<span class="p">{</span>
			<span class="n">splci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
			<span class="n">splci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">=</span> <span class="n">CODEC_PERMANENT</span><span class="p">;</span>
			<span class="cm">/* hook_listen indicates if a facility_req with handset/hook support */</span>
			<span class="cm">/* was sent. Otherwise if just a call on an external device was made */</span>
			<span class="cm">/* the codec will be used but the hook info will be discarded (just  */</span>
			<span class="cm">/* the external controller is in use                                 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hook_listen</span><span class="p">)</span> <span class="n">splci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">ADVANCED_VOICE_SIG</span><span class="p">;</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">splci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">ADVANCED_VOICE_NOSIG</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">spoofed_msg</span> <span class="o">=</span> <span class="n">SPOOFING_REQUIRED</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* indicate D-ch connect if  */</span>
			<span class="p">}</span>                                        <span class="cm">/* codec is connected OK     */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span> <span class="o">=</span> <span class="n">plci</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">=</span> <span class="n">ADV_VOICE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalAppl</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvCodecFLAG</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvCodecPLCI</span> <span class="o">=</span> <span class="n">splci</span><span class="p">;</span>
			<span class="n">add_p</span><span class="p">(</span><span class="n">splci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x15</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">add_p</span><span class="p">(</span><span class="n">splci</span><span class="p">,</span> <span class="n">LLI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x00</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">add_p</span><span class="p">(</span><span class="n">splci</span><span class="p">,</span> <span class="n">ESC</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x02\x18\x00</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">add_p</span><span class="p">(</span><span class="n">splci</span><span class="p">,</span> <span class="n">UID</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x06\x43\x61\x70\x69\x32\x30</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">splci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">PERM_COD_ASSIGN</span><span class="p">;</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Codec Assign&quot;</span><span class="p">));</span>
			<span class="n">sig_req</span><span class="p">(</span><span class="n">splci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="n">DSIG_ID</span><span class="p">);</span>
			<span class="n">send_req</span><span class="p">(</span><span class="n">splci</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">return</span> <span class="mh">0x2001</span><span class="p">;</span> <span class="cm">/* wrong state, no more plcis */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span> <span class="o">&amp;</span> <span class="n">ON_BOARD_CODEC</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hook_listen</span><span class="p">)</span> <span class="k">return</span> <span class="mh">0x300B</span><span class="p">;</span>               <span class="cm">/* Facility not supported */</span>
		<span class="cm">/* no hook with SCOM      */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">=</span> <span class="n">CODEC</span><span class="p">;</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;S/SCOM codec&quot;</span><span class="p">));</span>
		<span class="cm">/* first time we use the scom-s codec we must shut down the internal   */</span>
		<span class="cm">/* handset application of the card. This can be done by an assign with */</span>
		<span class="cm">/* a cai with the 0x80 bit set. Assign return code is &#39;out of resource&#39;*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">scom_appl_disable</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">=</span> <span class="n">get_plci</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">splci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">splci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x80</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">splci</span><span class="p">,</span> <span class="n">UID</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x06\x43\x61\x70\x69\x32\x30</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">splci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">);</span>  <span class="cm">/* 0xc0 is the TEL_ID */</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">splci</span><span class="p">);</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">scom_appl_disable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span><span class="p">{</span>
				<span class="k">return</span> <span class="mh">0x2001</span><span class="p">;</span> <span class="cm">/* wrong state, no more plcis */</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">return</span> <span class="mh">0x300B</span><span class="p">;</span>               <span class="cm">/* Facility not supported */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">CodecIdCheck</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;CodecIdCheck&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span> <span class="o">==</span> <span class="n">plci</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;PLCI owns codec&quot;</span><span class="p">));</span>
		<span class="n">VoiceChannelOff</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvCodecPLCI</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvCodecPLCI</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">ADVANCED_VOICE_NOSIG</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;remove temp codec PLCI&quot;</span><span class="p">));</span>
			<span class="n">plci_remove</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvCodecPLCI</span><span class="p">);</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvCodecFLAG</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvCodecPLCI</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalAppl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* -------------------------------------------------------------------</span>
<span class="cm">   Ask for physical address of card on PCI bus</span>
<span class="cm">   ------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">diva_ask_for_xdi_sdram_bar</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
				       <span class="n">IDI_SYNC_REQ</span> <span class="o">*</span><span class="n">preq</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">sdram_bar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diva_xdi_extended_features</span> <span class="o">&amp;</span> <span class="n">DIVA_CAPI_XDI_PROVIDES_SDRAM_BAR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ENTITY</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)</span><span class="n">preq</span><span class="p">;</span>

		<span class="n">e</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">preq</span><span class="o">-&gt;</span><span class="n">xdi_sdram_bar</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">bar</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">preq</span><span class="o">-&gt;</span><span class="n">xdi_sdram_bar</span><span class="p">.</span><span class="n">Req</span>         <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">preq</span><span class="o">-&gt;</span><span class="n">xdi_sdram_bar</span><span class="p">.</span><span class="n">Rc</span>           <span class="o">=</span> <span class="n">IDI_SYNC_REQ_XDI_GET_ADAPTER_SDRAM_BAR</span><span class="p">;</span>

		<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">))(</span><span class="n">e</span><span class="p">);</span>

		<span class="n">a</span><span class="o">-&gt;</span><span class="n">sdram_bar</span> <span class="o">=</span> <span class="n">preq</span><span class="o">-&gt;</span><span class="n">xdi_sdram_bar</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">bar</span><span class="p">;</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;A(%d) SDRAM BAR = %08x&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">sdram_bar</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* -------------------------------------------------------------------</span>
<span class="cm">   Ask XDI about extended features</span>
<span class="cm">   ------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">diva_get_extended_adapter_features</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">IDI_SYNC_REQ</span> <span class="o">*</span><span class="n">preq</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">preq</span><span class="o">-&gt;</span><span class="n">xdi_extended_features</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ENTITY</span><span class="p">))</span> <span class="o">?</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">preq</span><span class="o">-&gt;</span><span class="n">xdi_extended_features</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">:</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ENTITY</span><span class="p">)];</span>

	<span class="kt">char</span> <span class="n">features</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">preq</span> <span class="o">=</span> <span class="p">(</span><span class="n">IDI_SYNC_REQ</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">diva_xdi_extended_features</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ENTITY</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)</span><span class="n">preq</span><span class="p">;</span>
		<span class="n">diva_xdi_extended_features</span> <span class="o">|=</span> <span class="mh">0x80000000</span><span class="p">;</span>

		<span class="n">e</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">preq</span><span class="o">-&gt;</span><span class="n">xdi_extended_features</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">preq</span><span class="o">-&gt;</span><span class="n">xdi_extended_features</span><span class="p">.</span><span class="n">Rc</span>  <span class="o">=</span> <span class="n">IDI_SYNC_REQ_XDI_GET_EXTENDED_FEATURES</span><span class="p">;</span>
		<span class="n">preq</span><span class="o">-&gt;</span><span class="n">xdi_extended_features</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">buffer_length_in_bytes</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">features</span><span class="p">);</span>
		<span class="n">preq</span><span class="o">-&gt;</span><span class="n">xdi_extended_features</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">))(</span><span class="n">e</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DIVA_XDI_EXTENDED_FEATURES_VALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			  Check features located in the byte &#39;0&#39;</span>
<span class="cm">			*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DIVA_XDI_EXTENDED_FEATURE_CMA</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_xdi_extended_features</span> <span class="o">|=</span> <span class="n">DIVA_CAPI_USE_CMA</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DIVA_XDI_EXTENDED_FEATURE_RX_DMA</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_xdi_extended_features</span> <span class="o">|=</span> <span class="n">DIVA_CAPI_XDI_PROVIDES_RX_DMA</span><span class="p">;</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;XDI provides RxDMA&quot;</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DIVA_XDI_EXTENDED_FEATURE_SDRAM_BAR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_xdi_extended_features</span> <span class="o">|=</span> <span class="n">DIVA_CAPI_XDI_PROVIDES_SDRAM_BAR</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DIVA_XDI_EXTENDED_FEATURE_NO_CANCEL_RC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_xdi_extended_features</span> <span class="o">|=</span> <span class="n">DIVA_CAPI_XDI_PROVIDES_NO_CANCEL</span><span class="p">;</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;XDI provides NO_CANCEL_RC feature&quot;</span><span class="p">));</span>
			<span class="p">}</span>

		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">diva_ask_for_xdi_sdram_bar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">preq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* automatic law                                                    */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* called from OS specific part after init time to get the Law              */</span>
<span class="cm">/* a-law (Euro) and u-law (us,japan) use different BCs in the Setup message */</span>
<span class="kt">void</span> <span class="nf">AutomaticLaw</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">splci</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">automatic_law</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">=</span> <span class="n">get_plci</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">diva_get_extended_adapter_features</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
		<span class="n">splci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">automatic_lawPLCI</span> <span class="o">=</span> <span class="n">splci</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">automatic_law</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">add_p</span><span class="p">(</span><span class="n">splci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x80</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">add_p</span><span class="p">(</span><span class="n">splci</span><span class="p">,</span> <span class="n">UID</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x06\x43\x61\x70\x69\x32\x30</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">splci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">USELAW_REQ</span><span class="p">;</span>
		<span class="n">splci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">splci</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sig_req</span><span class="p">(</span><span class="n">splci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="n">DSIG_ID</span><span class="p">);</span>
		<span class="n">send_req</span><span class="p">(</span><span class="n">splci</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* called from OS specific part if an application sends an Capi20Release */</span>
<span class="n">word</span> <span class="nf">CapiRelease</span><span class="p">(</span><span class="n">word</span> <span class="n">Id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">appls_found</span><span class="p">;</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">;</span>
	<span class="n">APPL</span>   <span class="o">*</span><span class="n">this</span><span class="p">;</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Id</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;A: CapiRelease(Id==0)&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">_WRONG_APPL_ID</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">this</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>               <span class="cm">/* get application pointer */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">appls_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_appl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Id</span><span class="p">)</span>       <span class="cm">/* an application has been found        */</span>
		<span class="p">{</span>
			<span class="n">appls_found</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_adapter</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>             <span class="cm">/* scan all adapters...    */</span>
	<span class="p">{</span>
		<span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">Info_Mask</span><span class="p">[</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">CIP_Mask</span><span class="p">[</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">Notification_Mask</span><span class="p">[</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">codec_listen</span><span class="p">[</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">requested_options_table</span><span class="p">[</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">max_plci</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>           <span class="cm">/* and all PLCIs connected */</span>
			<span class="p">{</span>                                      <span class="cm">/* with this application   */</span>
				<span class="n">plci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span>                         <span class="cm">/* if plci owns no application */</span>
				<span class="p">{</span>                                    <span class="cm">/* it may be not jet connected */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_CON_PENDING</span>
					    <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">==</span> <span class="n">INC_CON_ALERT</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">test_c_ind_mask_bit</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
						<span class="p">{</span>
							<span class="n">clear_c_ind_mask_bit</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">c_ind_mask_empty</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
							<span class="p">{</span>
								<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">HANGUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
								<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
								<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">OUTG_DIS_PENDING</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">test_c_ind_mask_bit</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
					<span class="p">{</span>
						<span class="n">clear_c_ind_mask_bit</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">c_ind_mask_empty</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
						<span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">)</span>
							<span class="p">{</span>
								<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
								<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">==</span> <span class="n">this</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
						<span class="n">plci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">listen_check</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">flag_dynamic_l1_down</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">appls_found</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>            <span class="cm">/* last application does a capi release */</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">=</span> <span class="n">get_plci</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
					<span class="p">{</span>
						<span class="n">plci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">OAD</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\xfd</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x80</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">UID</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x06\x43\x61\x70\x69\x32\x30</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">SHIFT</span> <span class="o">|</span> <span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">SIN</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x02\x00\x00</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">REM_L1_SIG_ASSIGN_PEND</span><span class="p">;</span>
						<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="n">DSIG_ID</span><span class="p">);</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">FTY</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x02\xff\x06</span><span class="s">&quot;</span><span class="p">);</span> <span class="cm">/* l1 down */</span>
						<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">SIG_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
						<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalAppl</span> <span class="o">==</span> <span class="n">this</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">this</span><span class="o">-&gt;</span><span class="n">NullCREnable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvCodecPLCI</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">plci_remove</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvCodecPLCI</span><span class="p">);</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvCodecPLCI</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvCodecPLCI</span><span class="o">-&gt;</span><span class="n">adv_nl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalAppl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvCodecFLAG</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvCodecPLCI</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">word</span> <span class="nf">plci_remove_check</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span> <span class="o">&amp;&amp;</span> <span class="n">c_ind_mask_empty</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;plci_remove_complete(%x)&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">));</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;tel=0x%x,Sig=0x%x&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Id</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">CodecIdCheck</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
				<span class="n">clear_b1_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="n">ncci_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
				<span class="n">plci_free_msg_in_queue</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="n">channel_flow_control_remove</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">notifiedcall</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">listen_check</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">plci_nl_busy</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* only applicable for non-multiplexed protocols */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncci_ring_list</span>
		    <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncci_ring_list</span><span class="p">]</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncci_ring_list</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="n">N_OK_FC_PENDING</span><span class="p">)));</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* DTMF facilities                                                  */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>


<span class="k">static</span> <span class="k">struct</span>
<span class="p">{</span>
	<span class="n">byte</span> <span class="n">send_mask</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">listen_mask</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">character</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">code</span><span class="p">;</span>
<span class="p">}</span> <span class="n">dtmf_digit_map</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="n">DTMF_DIGIT_TONE_CODE_HASHMARK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="n">DTMF_DIGIT_TONE_CODE_STAR</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">DTMF_DIGIT_TONE_CODE_0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="n">DTMF_DIGIT_TONE_CODE_1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="n">DTMF_DIGIT_TONE_CODE_2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="n">DTMF_DIGIT_TONE_CODE_3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="n">DTMF_DIGIT_TONE_CODE_4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="n">DTMF_DIGIT_TONE_CODE_5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="n">DTMF_DIGIT_TONE_CODE_6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="n">DTMF_DIGIT_TONE_CODE_7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="n">DTMF_DIGIT_TONE_CODE_8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="n">DTMF_DIGIT_TONE_CODE_9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="n">DTMF_DIGIT_TONE_CODE_A</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="n">DTMF_DIGIT_TONE_CODE_B</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="n">DTMF_DIGIT_TONE_CODE_C</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="n">DTMF_DIGIT_TONE_CODE_D</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="n">DTMF_DIGIT_TONE_CODE_A</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="n">DTMF_DIGIT_TONE_CODE_B</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="n">DTMF_DIGIT_TONE_CODE_C</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="n">DTMF_DIGIT_TONE_CODE_D</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_NO_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_UNIDENTIFIED_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_DIAL_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_PABX_INTERNAL_DIAL_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_SPECIAL_DIAL_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_SECOND_DIAL_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_RINGING_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_SPECIAL_RINGING_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_BUSY_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_CONGESTION_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_SPECIAL_INFORMATION_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_COMFORT_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_HOLD_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_RECORD_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_CALLER_WAITING_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_CALL_WAITING_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_PAY_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_POSITIVE_INDICATION_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_NEGATIVE_INDICATION_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_WARNING_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_INTRUSION_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_CALLING_CARD_SERVICE_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_PAYPHONE_RECOGNITION_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_CPE_ALERTING_SIGNAL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_OFF_HOOK_WARNING_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_INTERCEPT_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_MODEM_CALLING_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_FAX_CALLING_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_ANSWER_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_REVERSED_ANSWER_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_ANSAM_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_REVERSED_ANSAM_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_BELL103_ANSWER_TONE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_FAX_FLAGS</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_G2_FAX_GROUP_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_HUMAN_SPEECH</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="n">DTMF_SIGNAL_ANSWERING_MACHINE_390</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="n">DTMF_MF_DIGIT_TONE_CODE_1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="n">DTMF_MF_DIGIT_TONE_CODE_2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="n">DTMF_MF_DIGIT_TONE_CODE_3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="n">DTMF_MF_DIGIT_TONE_CODE_4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="n">DTMF_MF_DIGIT_TONE_CODE_5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="n">DTMF_MF_DIGIT_TONE_CODE_6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="n">DTMF_MF_DIGIT_TONE_CODE_7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="n">DTMF_MF_DIGIT_TONE_CODE_8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="n">DTMF_MF_DIGIT_TONE_CODE_9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="n">DTMF_MF_DIGIT_TONE_CODE_0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="n">DTMF_MF_DIGIT_TONE_CODE_K1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="n">DTMF_MF_DIGIT_TONE_CODE_K2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="n">DTMF_MF_DIGIT_TONE_CODE_KP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="n">DTMF_MF_DIGIT_TONE_CODE_S1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">DTMF_MF_DIGIT_TONE_CODE_ST</span> <span class="p">},</span>

<span class="p">};</span>

<span class="cp">#define DTMF_DIGIT_MAP_ENTRIES ARRAY_SIZE(dtmf_digit_map)</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dtmf_enable_receiver</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">enable_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">min_digit_duration</span><span class="p">,</span> <span class="n">min_gap_duration</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: dtmf_enable_receiver %02x&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">enable_mask</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable_mask</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">min_digit_duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_rec_pulse_ms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">40</span> <span class="o">:</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_rec_pulse_ms</span><span class="p">;</span>
		<span class="n">min_gap_duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_rec_pause_ms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">40</span> <span class="o">:</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_rec_pause_ms</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">DTMF_UDATA_REQUEST_ENABLE_RECEIVER</span><span class="p">;</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">min_digit_duration</span><span class="p">);</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">min_gap_duration</span><span class="p">);</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">INTERNAL_IND_BUFFER_SIZE</span><span class="p">);</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">capidtmf_recv_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">capidtmf_state</span><span class="p">),</span> <span class="n">min_digit_duration</span><span class="p">,</span> <span class="n">min_gap_duration</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">DTMF_UDATA_REQUEST_DISABLE_RECEIVER</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">capidtmf_recv_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">capidtmf_state</span><span class="p">));</span>

	<span class="p">}</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">ReqCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">N_UDATA</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dtmf_send_digits</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">digit_buffer</span><span class="p">,</span> <span class="n">word</span> <span class="n">digit_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">w</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: dtmf_send_digits %d&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">digit_count</span><span class="p">));</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">DTMF_UDATA_REQUEST_SEND_DIGITS</span><span class="p">;</span>
	<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_send_pulse_ms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">40</span> <span class="o">:</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_send_pulse_ms</span><span class="p">;</span>
	<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">w</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_send_pause_ms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">40</span> <span class="o">:</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_send_pause_ms</span><span class="p">;</span>
	<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">w</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">digit_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">w</span> <span class="o">&lt;</span> <span class="n">DTMF_DIGIT_MAP_ENTRIES</span><span class="p">)</span>
		       <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">digit_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dtmf_digit_map</span><span class="p">[</span><span class="n">w</span><span class="p">].</span><span class="n">character</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">w</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">[</span><span class="mi">5</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">&lt;</span> <span class="n">DTMF_DIGIT_MAP_ENTRIES</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">dtmf_digit_map</span><span class="p">[</span><span class="n">w</span><span class="p">].</span><span class="n">code</span> <span class="o">:</span> <span class="n">DTMF_DIGIT_TONE_CODE_STAR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">digit_count</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">ReqCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">N_UDATA</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dtmf_rec_clear_config</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: dtmf_rec_clear_config&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_rec_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_rec_pulse_ms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_rec_pause_ms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">capidtmf_init</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">capidtmf_state</span><span class="p">),</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">u_law</span><span class="p">);</span>

<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dtmf_send_clear_config</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: dtmf_send_clear_config&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_send_requests</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_send_pulse_ms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_send_pause_ms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dtmf_prepare_switch</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: dtmf_prepare_switch&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_send_requests</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dtmf_confirmation</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">word</span> <span class="nf">dtmf_save_config</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: dtmf_save_config %02x %d&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span><span class="p">));</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">GOOD</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">word</span> <span class="nf">dtmf_restore_config</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: dtmf_restore_config %02x %d&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">GOOD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_DTMFR</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_DTMF_1</span>:
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci_nl_busy</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_DTMF_1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dtmf_enable_receiver</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_rec_active</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_DTMF_2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_DTMF_2</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK_FC</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Reenable DTMF receiver failed %02x&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">));</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">Info</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dtmf_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">internal_command</span><span class="p">,</span> <span class="n">Info</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: dtmf_command %02x %04x %04x %d %d %d %d&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">,</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_cmd</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_rec_pulse_ms</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_rec_pause_ms</span><span class="p">,</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_send_pulse_ms</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_send_pause_ms</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">GOOD</span><span class="p">;</span>
	<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">DTMF_SUCCESS</span><span class="p">);</span>
	<span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_cmd</span><span class="p">)</span>
	<span class="p">{</span>

	<span class="k">case</span> <span class="n">DTMF_LISTEN_TONE_START</span>:
		<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTMF_LISTEN_MF_START</span>:
		<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DTMF_LISTEN_START</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">internal_command</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="nl">default:</span>
			<span class="n">adjust_b1_resource</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">|</span>
								  <span class="n">B1_FACILITY_DTMFR</span><span class="p">),</span> <span class="n">DTMF_COMMAND_1</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">DTMF_COMMAND_1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">adjust_b_process</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Load DTMF failed&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_FACILITY_NOT_SUPPORTED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DTMF_COMMAND_2</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">plci_nl_busy</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">DTMF_COMMAND_2</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">DTMF_COMMAND_3</span><span class="p">;</span>
			<span class="n">dtmf_enable_receiver</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_rec_active</span> <span class="o">|</span> <span class="n">mask</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DTMF_COMMAND_3</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK_FC</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Enable DTMF receiver failed %02x&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">));</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_FACILITY_NOT_SUPPORTED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">tone_last_indication_code</span> <span class="o">=</span> <span class="n">DTMF_SIGNAL_NO_TONE</span><span class="p">;</span>

			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_rec_active</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>


	<span class="k">case</span> <span class="n">DTMF_LISTEN_TONE_STOP</span>:
		<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTMF_LISTEN_MF_STOP</span>:
		<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DTMF_LISTEN_STOP</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">internal_command</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="nl">default:</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_rec_active</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_rec_active</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">  case DTMF_COMMAND_1:</span>
<span class="cm">  if (plci-&gt;dtmf_rec_active)</span>
<span class="cm">  {</span>
<span class="cm">  if (plci_nl_busy (plci))</span>
<span class="cm">  {</span>
<span class="cm">  plci-&gt;internal_command = DTMF_COMMAND_1;</span>
<span class="cm">  return;</span>
<span class="cm">  }</span>
<span class="cm">  plci-&gt;dtmf_rec_active &amp;= ~mask;</span>
<span class="cm">  plci-&gt;internal_command = DTMF_COMMAND_2;</span>
<span class="cm">  dtmf_enable_receiver (plci, false);</span>
<span class="cm">  return;</span>
<span class="cm">  }</span>
<span class="cm">  Rc = OK;</span>
<span class="cm">  case DTMF_COMMAND_2:</span>
<span class="cm">  if ((Rc != OK) &amp;&amp; (Rc != OK_FC))</span>
<span class="cm">  {</span>
<span class="cm">  dbug (1, dprintf(&quot;[%06lx] %s,%d: Disable DTMF receiver failed %02x&quot;,</span>
<span class="cm">  UnMapId (Id), (char far *)(FILE_), __LINE__, Rc));</span>
<span class="cm">  Info = _FACILITY_NOT_SUPPORTED;</span>
<span class="cm">  break;</span>
<span class="cm">  }</span>
<span class="cm">*/</span>
			<span class="n">adjust_b1_resource</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">&amp;</span>
								  <span class="o">~</span><span class="p">(</span><span class="n">B1_FACILITY_DTMFX</span> <span class="o">|</span> <span class="n">B1_FACILITY_DTMFR</span><span class="p">)),</span> <span class="n">DTMF_COMMAND_3</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">DTMF_COMMAND_3</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">adjust_b_process</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Unload DTMF failed&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_FACILITY_NOT_SUPPORTED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>


	<span class="k">case</span> <span class="n">DTMF_SEND_TONE</span>:
		<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTMF_SEND_MF</span>:
		<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DTMF_DIGITS_SEND</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">internal_command</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="nl">default:</span>
			<span class="n">adjust_b1_resource</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">|</span>
								  <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_parameter_length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">B1_FACILITY_DTMFX</span> <span class="o">|</span> <span class="n">B1_FACILITY_DTMFR</span> <span class="o">:</span> <span class="n">B1_FACILITY_DTMFX</span><span class="p">)),</span>
					   <span class="n">DTMF_COMMAND_1</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">DTMF_COMMAND_1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">adjust_b_process</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Load DTMF failed&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_FACILITY_NOT_SUPPORTED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DTMF_COMMAND_2</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">plci_nl_busy</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">DTMF_COMMAND_2</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_msg_number_queue</span><span class="p">[(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_send_requests</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">DTMF_COMMAND_3</span><span class="p">;</span>
			<span class="n">dtmf_send_digits</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">saved_msg</span><span class="p">.</span><span class="n">parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">saved_msg</span><span class="p">.</span><span class="n">parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DTMF_COMMAND_3</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK_FC</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Send DTMF digits failed %02x&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_send_requests</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_send_requests</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_FACILITY_NOT_SUPPORTED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffffL</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
	      <span class="s">&quot;wws&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">,</span> <span class="n">SELECTOR_DTMF</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">byte</span> <span class="nf">dtmf_request</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span>   <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="n">dtmf_parms</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">byte</span> <span class="n">result</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: dtmf_request&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">GOOD</span><span class="p">;</span>
	<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">DTMF_SUCCESS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span> <span class="o">&amp;</span> <span class="n">GL_DTMF_SUPPORTED</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Facility not supported&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="n">Info</span> <span class="o">=</span> <span class="n">_FACILITY_NOT_SUPPORTED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">dtmf_parms</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong message format&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">dtmf_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="n">DTMF_GET_SUPPORTED_DETECT_CODES</span><span class="p">)</span>
		 <span class="o">||</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">dtmf_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="n">DTMF_GET_SUPPORTED_SEND_CODES</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">requested_options_table</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
		      <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_DTMF_TONE</span><span class="p">)))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: DTMF unknown request %04x&quot;</span><span class="p">,</span>
					<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">dtmf_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)));</span>
			<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">DTMF_UNKNOWN_REQUEST</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">result</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">dtmf_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="n">DTMF_GET_SUPPORTED_DETECT_CODES</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DTMF_DIGIT_MAP_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dtmf_digit_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">listen_mask</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">result</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">dtmf_digit_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">character</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">dtmf_digit_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">character</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DTMF_DIGIT_MAP_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dtmf_digit_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">send_mask</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">result</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">dtmf_digit_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">character</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">dtmf_digit_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">character</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong PLCI&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span>
		    <span class="o">||</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong state&quot;</span><span class="p">,</span>
					<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_cmd</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">dtmf_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_cmd</span><span class="p">)</span>
			<span class="p">{</span>

			<span class="k">case</span> <span class="n">DTMF_LISTEN_TONE_START</span>:
			<span class="k">case</span> <span class="n">DTMF_LISTEN_TONE_STOP</span>:
				<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DTMF_LISTEN_MF_START</span>:
			<span class="k">case</span> <span class="n">DTMF_LISTEN_MF_STOP</span>:
				<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options_conn</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">requested_options_table</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
				      <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_DTMF_TONE</span><span class="p">)))</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: DTMF unknown request %04x&quot;</span><span class="p">,</span>
							<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">dtmf_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)));</span>
					<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">DTMF_UNKNOWN_REQUEST</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="k">case</span> <span class="n">DTMF_LISTEN_START</span>:
			<span class="k">case</span> <span class="n">DTMF_LISTEN_STOP</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_HARDDTMF</span><span class="p">)</span>
				    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_SOFTDTMF_RECEIVE</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Facility not supported&quot;</span><span class="p">,</span>
							<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_FACILITY_NOT_SUPPORTED</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">DTMF_LISTEN_ACTIVE_FLAG</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wwws&quot;</span><span class="p">,</span> <span class="n">dtmf_parms</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_rec_pulse_ms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_rec_pause_ms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_rec_pulse_ms</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">dtmf_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_rec_pause_ms</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">dtmf_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">dtmf_command</span><span class="p">);</span>
				<span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>


			<span class="k">case</span> <span class="n">DTMF_SEND_TONE</span>:
				<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DTMF_SEND_MF</span>:
				<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options_conn</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">requested_options_table</span><span class="p">[</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
				      <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_DTMF_TONE</span><span class="p">)))</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: DTMF unknown request %04x&quot;</span><span class="p">,</span>
							<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">dtmf_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)));</span>
					<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">DTMF_UNKNOWN_REQUEST</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="k">case</span> <span class="n">DTMF_DIGITS_SEND</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;wwws&quot;</span><span class="p">,</span> <span class="n">dtmf_parms</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong message format&quot;</span><span class="p">,</span>
							<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">DTMF_LISTEN_ACTIVE_FLAG</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_send_pulse_ms</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">dtmf_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_send_pause_ms</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">dtmf_parms</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">dtmf_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">length</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">DTMF_DIGIT_MAP_ENTRIES</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">while</span> <span class="p">((</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">DTMF_DIGIT_MAP_ENTRIES</span><span class="p">)</span>
					       <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">dtmf_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dtmf_digit_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">character</span><span class="p">)</span>
						   <span class="o">||</span> <span class="p">((</span><span class="n">dtmf_digit_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">send_mask</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
					<span class="p">{</span>
						<span class="n">j</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">i</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">DTMF_DIGIT_MAP_ENTRIES</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Incorrect DTMF digit %02x&quot;</span><span class="p">,</span>
							<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">dtmf_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
					<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">DTMF_INCORRECT_DIGIT</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_send_requests</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_msg_number_queue</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: DTMF request overrun&quot;</span><span class="p">,</span>
							<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">api_save_msg</span><span class="p">(</span><span class="n">dtmf_parms</span><span class="p">,</span> <span class="s">&quot;wwws&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">saved_msg</span><span class="p">);</span>
				<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">dtmf_command</span><span class="p">);</span>
				<span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>

			<span class="nl">default:</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: DTMF unknown request %04x&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_cmd</span><span class="p">));</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">DTMF_UNKNOWN_REQUEST</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffffL</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span>
	      <span class="s">&quot;wws&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">,</span> <span class="n">SELECTOR_DTMF</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dtmf_confirmation</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: dtmf_confirmation&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">DTMF_SUCCESS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_send_requests</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffffL</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_msg_number_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		      <span class="s">&quot;wws&quot;</span><span class="p">,</span> <span class="n">GOOD</span><span class="p">,</span> <span class="n">SELECTOR_DTMF</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_send_requests</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_send_requests</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_msg_number_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_msg_number_queue</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dtmf_indication</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">word</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: dtmf_indication&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">DTMF_DIGIT_MAP_ENTRIES</span><span class="p">)</span>
		       <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dtmf_digit_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">code</span><span class="p">)</span>
			   <span class="o">||</span> <span class="p">((</span><span class="n">dtmf_digit_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">listen_mask</span> <span class="o">&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_rec_active</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="p">{</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">DTMF_DIGIT_MAP_ENTRIES</span><span class="p">)</span>
		<span class="p">{</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">dtmf_digit_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">listen_mask</span> <span class="o">&amp;</span> <span class="n">DTMF_TONE_LISTEN_ACTIVE_FLAG</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tone_last_indication_code</span> <span class="o">==</span> <span class="n">DTMF_SIGNAL_NO_TONE</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dtmf_digit_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">character</span> <span class="o">!=</span> <span class="n">DTMF_SIGNAL_UNIDENTIFIED_TONE</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
						<span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
					<span class="n">length</span><span class="o">++</span><span class="p">;</span>
					<span class="n">i</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">msg</span><span class="p">[</span><span class="o">++</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">DTMF_SIGNAL_UNIDENTIFIED_TONE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">tone_last_indication_code</span> <span class="o">=</span> <span class="n">dtmf_digit_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">character</span><span class="p">;</span>

			<span class="n">msg</span><span class="p">[</span><span class="o">++</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtmf_digit_map</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">character</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffffL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wS&quot;</span><span class="p">,</span> <span class="n">SELECTOR_DTMF</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* DTMF parameters                                                  */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dtmf_parameter_write</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">parameter_buffer</span><span class="p">[</span><span class="n">DTMF_PARAMETER_BUFFER_SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: dtmf_parameter_write&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="n">parameter_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_parameter_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">parameter_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">DSP_CTRL_SET_DTMF_PARAMETERS</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_parameter_length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">parameter_buffer</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_parameter_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">FTY</span><span class="p">,</span> <span class="n">parameter_buffer</span><span class="p">);</span>
	<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">TEL_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dtmf_parameter_clear_config</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: dtmf_parameter_clear_config&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_parameter_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dtmf_parameter_prepare_switch</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: dtmf_parameter_prepare_switch&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

<span class="p">}</span>


<span class="k">static</span> <span class="n">word</span> <span class="nf">dtmf_parameter_save_config</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: dtmf_parameter_save_config %02x %d&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span><span class="p">));</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">GOOD</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">word</span> <span class="nf">dtmf_parameter_restore_config</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: dtmf_parameter_restore_config %02x %d&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">GOOD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_DTMFR</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">dtmf_parameter_length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_DTMF_PARAMETER_1</span>:
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_req</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_DTMF_PARAMETER_1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dtmf_parameter_write</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_DTMF_PARAMETER_2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_DTMF_PARAMETER_2</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK_FC</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Restore DTMF parameters failed %02x&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">));</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">Info</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* Line interconnect facilities                                     */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>


<span class="n">LI_CONFIG</span>   <span class="o">*</span><span class="n">li_config_table</span><span class="p">;</span>
<span class="n">word</span> <span class="n">li_total_channels</span><span class="p">;</span>


<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* translate a CHI information element to a channel number          */</span>
<span class="cm">/* returns 0xff - any channel                                       */</span>
<span class="cm">/*         0xfe - chi wrong coding                                  */</span>
<span class="cm">/*         0xfd - D-channel                                         */</span>
<span class="cm">/*         0x00 - no channel                                        */</span>
<span class="cm">/*         else channel number / PRI: timeslot                      */</span>
<span class="cm">/* if channels is provided we accept more than one channel.         */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">byte</span> <span class="nf">chi_to_channel</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">chi</span><span class="p">,</span> <span class="n">dword</span> <span class="o">*</span><span class="n">pchannelmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">map</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">excl</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">ofs</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pchannelmap</span><span class="p">)</span> <span class="o">*</span><span class="n">pchannelmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">return</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">excl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">chi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xac</span><span class="p">)</span> <span class="k">return</span> <span class="mh">0xfd</span><span class="p">;</span> <span class="cm">/* exclusive d-channel */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">chi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">chi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="k">return</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">chi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0xc8</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xe9</span><span class="p">)</span> <span class="k">return</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="n">excl</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>

		<span class="cm">/* int. id present */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">chi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">chi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="k">return</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* coding standard, Number/Map, Channel Type */</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">chi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">chi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="k">return</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">chi</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0xd0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xd3</span><span class="p">)</span> <span class="k">return</span> <span class="mh">0xfe</span><span class="p">;</span>

		<span class="cm">/* Number/Map */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chi</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* map */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="n">ofs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="n">ofs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">return</span> <span class="mh">0xfe</span><span class="p">;</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">map</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">chi</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
				<span class="n">ch</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">map</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">chi</span><span class="p">[</span><span class="n">p</span><span class="p">])</span> <span class="p">{</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="p">(</span><span class="n">chi</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ch</span><span class="p">));</span> <span class="n">ch</span><span class="o">++</span><span class="p">);</span>
					<span class="n">map</span> <span class="o">|=</span> <span class="n">chi</span><span class="p">[</span><span class="n">p</span><span class="p">];</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">ch</span> <span class="o">+=</span> <span class="n">ofs</span><span class="p">;</span>
			<span class="n">map</span> <span class="o">&lt;&lt;=</span> <span class="n">ofs</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>

			<span class="cm">/* number */</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="n">chi</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pchannelmap</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="n">chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="k">return</span> <span class="mh">0xfe</span><span class="p">;</span>
				<span class="n">map</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">chi</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">chi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="k">return</span> <span class="mh">0xfe</span><span class="p">;</span>
					<span class="n">map</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">chi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="n">chi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">return</span> <span class="mh">0xfe</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="k">return</span> <span class="mh">0xfe</span><span class="p">;</span>
				<span class="n">map</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">ch</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chi</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="k">return</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pchannelmap</span><span class="p">)</span> <span class="o">*</span><span class="n">pchannelmap</span> <span class="o">=</span> <span class="n">map</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">map</span> <span class="o">!=</span> <span class="p">((</span><span class="n">dword</span><span class="p">)(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">ch</span><span class="p">)))</span> <span class="k">return</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">excl</span> <span class="o">|</span> <span class="n">ch</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>  <span class="cm">/* not PRI */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">chi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">chi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="k">return</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="n">excl</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">chi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x98</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x98</span>: <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x99</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">pchannelmap</span><span class="p">)</span> <span class="o">*</span><span class="n">pchannelmap</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">excl</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x9a</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">pchannelmap</span><span class="p">)</span> <span class="o">*</span><span class="n">pchannelmap</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">excl</span> <span class="o">|</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x9b</span>: <span class="k">return</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x9c</span>: <span class="k">return</span> <span class="mh">0xfd</span><span class="p">;</span> <span class="cm">/* d-ch */</span>
		<span class="nl">default:</span> <span class="k">return</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mixer_set_bchannel_id_esc</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">bchannel_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">splci</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">old_id</span><span class="p">;</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">old_id</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_pri</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">old_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">old_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="n">plci</span><span class="p">))</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">old_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">bchannel_id</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">=</span> <span class="n">plci</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">bchannel_id</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">bchannel_id</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">old_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">old_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="n">plci</span><span class="p">))</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">old_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">=</span> <span class="n">bchannel_id</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span> <span class="o">!=</span> <span class="n">plci</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">ADV_VOICE</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">splci</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">splci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">splci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="n">splci</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">splci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">splci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">;</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">)].</span><span class="n">plci</span> <span class="o">=</span> <span class="n">splci</span><span class="p">;</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: adv_voice_set_bchannel_id_esc %d&quot;</span><span class="p">,</span>
							<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">splci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">splci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
							<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">splci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">=</span> <span class="n">plci</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">old_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="n">plci</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">mixer_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: mixer_set_bchannel_id_esc %d %d&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">bchannel_id</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mixer_set_bchannel_id</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">chi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">splci</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">ch</span><span class="p">,</span> <span class="n">old_id</span><span class="p">;</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">old_id</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">;</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">chi_to_channel</span><span class="p">(</span><span class="n">chi</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_pri</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">old_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">old_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="n">plci</span><span class="p">))</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">old_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">=</span> <span class="n">plci</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">old_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">old_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="n">plci</span><span class="p">))</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">old_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span> <span class="o">!=</span> <span class="n">plci</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">ADV_VOICE</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">splci</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">splci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
						    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">splci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="n">splci</span><span class="p">))</span>
						<span class="p">{</span>
							<span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">splci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="n">splci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">;</span>
						<span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">)].</span><span class="n">plci</span> <span class="o">=</span> <span class="n">splci</span><span class="p">;</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: adv_voice_set_bchannel_id %d&quot;</span><span class="p">,</span>
								<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">splci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">splci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
								<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">splci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">));</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">=</span> <span class="n">plci</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">old_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="n">plci</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">mixer_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: mixer_set_bchannel_id %02x %d&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">));</span>
<span class="p">}</span>


<span class="cp">#define MIXER_MAX_DUMP_CHANNELS 34</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mixer_calculate_coefs</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">hex_digit_table</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sc">&#39;0&#39;</span><span class="p">,</span> <span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="sc">&#39;4&#39;</span><span class="p">,</span> <span class="sc">&#39;5&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;8&#39;</span><span class="p">,</span> <span class="sc">&#39;9&#39;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">,</span> <span class="sc">&#39;b&#39;</span><span class="p">,</span> <span class="sc">&#39;c&#39;</span><span class="p">,</span> <span class="sc">&#39;d&#39;</span><span class="p">,</span> <span class="sc">&#39;e&#39;</span><span class="p">,</span> <span class="sc">&#39;f&#39;</span><span class="p">};</span>
	<span class="n">word</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">hex_line</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">MIXER_MAX_DUMP_CHANNELS</span> <span class="o">+</span> <span class="n">MIXER_MAX_DUMP_CHANNELS</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">4</span><span class="p">];</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: mixer_calculate_coefs&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)(</span><span class="n">UnMapController</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;=</span> <span class="n">LI_CHANNEL_ADDRESSES_SET</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chflags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">|=</span> <span class="n">LI_CHANNEL_INVOLVED</span><span class="p">;</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				    <span class="o">||</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">|=</span> <span class="n">LI_CHANNEL_INVOLVED</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				    <span class="o">||</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">|=</span> <span class="n">LI_CHANNEL_CONFERENCE</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LI_COEF_CH_CH</span> <span class="o">|</span> <span class="n">LI_COEF_CH_PC</span> <span class="o">|</span> <span class="n">LI_COEF_PC_CH</span> <span class="o">|</span> <span class="n">LI_COEF_PC_PC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">)</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_COEF_CH_CH</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_CONFERENCE</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_CONFERENCE</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">|=</span>
							<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_INVOLVED</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LI_COEF_CH_CH</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_COEF_CH_CH</span><span class="p">)</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">)</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_COEF_CH_CH</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_INVOLVED</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_INTERCONNECT</span><span class="p">)</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_COEF_CH_CH</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_MONITOR</span><span class="p">)</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_COEF_CH_PC</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_MIX</span><span class="p">)</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_COEF_PC_CH</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_PCCONNECT</span><span class="p">)</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_COEF_PC_PC</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chflags</span> <span class="o">&amp;</span> <span class="n">LI_CHFLAG_MONITOR</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_INTERCONNECT</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_COEF_CH_PC</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">chflags</span> <span class="o">&amp;</span> <span class="n">LI_CHFLAG_MIX</span><span class="p">)</span>
							<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_COEF_PC_CH</span> <span class="o">|</span> <span class="n">LI_COEF_PC_PC</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chflags</span> <span class="o">&amp;</span> <span class="n">LI_CHFLAG_MIX</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_INTERCONNECT</span><span class="p">)</span>
						<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_COEF_PC_CH</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chflags</span> <span class="o">&amp;</span> <span class="n">LI_CHFLAG_LOOP</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_INTERCONNECT</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_INTERCONNECT</span><span class="p">)</span>
							<span class="p">{</span>
								<span class="n">li_config_table</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_COEF_CH_CH</span><span class="p">;</span>
								<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">chflags</span> <span class="o">&amp;</span> <span class="n">LI_CHFLAG_MIX</span><span class="p">)</span>
								<span class="p">{</span>
									<span class="n">li_config_table</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_COEF_PC_CH</span><span class="p">;</span>
									<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">chflags</span> <span class="o">&amp;</span> <span class="n">LI_CHFLAG_MONITOR</span><span class="p">)</span>
										<span class="n">li_config_table</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_COEF_CH_PC</span> <span class="o">|</span> <span class="n">LI_COEF_PC_PC</span><span class="p">;</span>
								<span class="p">}</span>
								<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">chflags</span> <span class="o">&amp;</span> <span class="n">LI_CHFLAG_MONITOR</span><span class="p">)</span>
									<span class="n">li_config_table</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_COEF_CH_PC</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_INVOLVED</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LI_CHFLAG_MONITOR</span> <span class="o">|</span> <span class="n">LI_CHFLAG_MIX</span> <span class="o">|</span> <span class="n">LI_CHFLAG_LOOP</span><span class="p">))</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">|=</span> <span class="n">LI_CHANNEL_ACTIVE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chflags</span> <span class="o">&amp;</span> <span class="n">LI_CHFLAG_MONITOR</span><span class="p">)</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">|=</span> <span class="n">LI_CHANNEL_RX_DATA</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chflags</span> <span class="o">&amp;</span> <span class="n">LI_CHFLAG_MIX</span><span class="p">)</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">|=</span> <span class="n">LI_CHANNEL_TX_DATA</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span>
				     <span class="p">(</span><span class="n">LI_FLAG_INTERCONNECT</span> <span class="o">|</span> <span class="n">LI_FLAG_PCCONNECT</span> <span class="o">|</span> <span class="n">LI_FLAG_CONFERENCE</span> <span class="o">|</span> <span class="n">LI_FLAG_MONITOR</span><span class="p">))</span>
				    <span class="o">||</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span>
					<span class="p">(</span><span class="n">LI_FLAG_INTERCONNECT</span> <span class="o">|</span> <span class="n">LI_FLAG_PCCONNECT</span> <span class="o">|</span> <span class="n">LI_FLAG_CONFERENCE</span> <span class="o">|</span> <span class="n">LI_FLAG_ANNOUNCEMENT</span> <span class="o">|</span> <span class="n">LI_FLAG_MIX</span><span class="p">)))</span>
				<span class="p">{</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">|=</span> <span class="n">LI_CHANNEL_ACTIVE</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LI_FLAG_PCCONNECT</span> <span class="o">|</span> <span class="n">LI_FLAG_MONITOR</span><span class="p">))</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">|=</span> <span class="n">LI_CHANNEL_RX_DATA</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LI_FLAG_PCCONNECT</span> <span class="o">|</span> <span class="n">LI_FLAG_ANNOUNCEMENT</span> <span class="o">|</span> <span class="n">LI_FLAG_MIX</span><span class="p">))</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">|=</span> <span class="n">LI_CHANNEL_TX_DATA</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_ACTIVE</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_COEF_PC_CH</span> <span class="o">|</span> <span class="n">LI_COEF_CH_PC</span><span class="p">;</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">|=</span> <span class="n">LI_CHANNEL_TX_DATA</span> <span class="o">|</span> <span class="n">LI_CHANNEL_RX_DATA</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_INVOLVED</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_ANNOUNCEMENT</span><span class="p">))</span>
				<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LI_COEF_CH_CH</span> <span class="o">|</span> <span class="n">LI_COEF_PC_CH</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_ANNOUNCEMENT</span><span class="p">)</span>
						<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_COEF_PC_CH</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">li_total_channels</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">MIXER_MAX_DUMP_CHANNELS</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">MIXER_MAX_DUMP_CHANNELS</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">hex_line</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">hex_digit_table</span><span class="p">[</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">curchnl</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">];</span>
		<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">hex_digit_table</span><span class="p">[</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">curchnl</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] CURRENT %s&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)(</span><span class="n">UnMapController</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hex_line</span><span class="p">));</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">hex_line</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">hex_digit_table</span><span class="p">[</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">channel</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">];</span>
		<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">hex_digit_table</span><span class="p">[</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] CHANNEL %s&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)(</span><span class="n">UnMapController</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hex_line</span><span class="p">));</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">hex_line</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">hex_digit_table</span><span class="p">[</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">chflags</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">];</span>
		<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">hex_digit_table</span><span class="p">[</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">chflags</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] CHFLAG  %s&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)(</span><span class="n">UnMapController</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hex_line</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">hex_line</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
			<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">hex_digit_table</span><span class="p">[</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">];</span>
			<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">hex_digit_table</span><span class="p">[</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] FLAG[%02x]%s&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">dword</span><span class="p">)(</span><span class="n">UnMapController</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hex_line</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">hex_line</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
			<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">hex_digit_table</span><span class="p">[</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">];</span>
			<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">hex_digit_table</span><span class="p">[</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] COEF[%02x]%s&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">dword</span><span class="p">)(</span><span class="n">UnMapController</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hex_line</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span>
<span class="p">{</span>
	<span class="n">byte</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">line_flags</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mixer_write_prog_pri</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="n">LI_COEF_CH_CH</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">LI_COEF_CH_PC</span><span class="p">,</span> <span class="n">MIXER_COEF_LINE_TO_PC_FLAG</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">LI_COEF_PC_CH</span><span class="p">,</span> <span class="n">MIXER_COEF_LINE_FROM_PC_FLAG</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">LI_COEF_PC_PC</span><span class="p">,</span> <span class="n">MIXER_COEF_LINE_TO_PC_FLAG</span> <span class="o">|</span> <span class="n">MIXER_COEF_LINE_FROM_PC_FLAG</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span>
<span class="p">{</span>
	<span class="n">byte</span> <span class="n">from_ch</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">to_ch</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">xconnect_override</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mixer_write_prog_bri</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LI_COEF_CH_CH</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>  <span class="cm">/* B      to B      */</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LI_COEF_CH_CH</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>  <span class="cm">/* Alt B  to B      */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LI_COEF_PC_CH</span><span class="p">,</span> <span class="mh">0x80</span> <span class="p">},</span>  <span class="cm">/* PC     to B      */</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LI_COEF_PC_CH</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>  <span class="cm">/* Alt PC to B      */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LI_COEF_CH_CH</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>  <span class="cm">/* IC     to B      */</span>
	<span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LI_COEF_CH_CH</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>  <span class="cm">/* Alt IC to B      */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LI_COEF_CH_PC</span><span class="p">,</span> <span class="mh">0x80</span> <span class="p">},</span>  <span class="cm">/* B      to PC     */</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LI_COEF_CH_PC</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>  <span class="cm">/* Alt B  to PC     */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LI_COEF_PC_PC</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>  <span class="cm">/* PC     to PC     */</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LI_COEF_PC_PC</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>  <span class="cm">/* Alt PC to PC     */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LI_COEF_CH_PC</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>  <span class="cm">/* IC     to PC     */</span>
	<span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LI_COEF_CH_PC</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>  <span class="cm">/* Alt IC to PC     */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">LI_COEF_CH_CH</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>  <span class="cm">/* B      to IC     */</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">LI_COEF_CH_CH</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>  <span class="cm">/* Alt B  to IC     */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">LI_COEF_PC_CH</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>  <span class="cm">/* PC     to IC     */</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">LI_COEF_PC_CH</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>  <span class="cm">/* Alt PC to IC     */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">LI_COEF_CH_CH</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>  <span class="cm">/* IC     to IC     */</span>
	<span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">LI_COEF_CH_CH</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>  <span class="cm">/* Alt IC to IC     */</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LI_COEF_CH_CH</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>  <span class="cm">/* Alt B  to Alt B  */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LI_COEF_CH_CH</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>  <span class="cm">/* B      to Alt B  */</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LI_COEF_PC_CH</span><span class="p">,</span> <span class="mh">0x80</span> <span class="p">},</span>  <span class="cm">/* Alt PC to Alt B  */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LI_COEF_PC_CH</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>  <span class="cm">/* PC     to Alt B  */</span>
	<span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LI_COEF_CH_CH</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>  <span class="cm">/* Alt IC to Alt B  */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LI_COEF_CH_CH</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>  <span class="cm">/* IC     to Alt B  */</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LI_COEF_CH_PC</span><span class="p">,</span> <span class="mh">0x80</span> <span class="p">},</span>  <span class="cm">/* Alt B  to Alt PC */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LI_COEF_CH_PC</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>  <span class="cm">/* B      to Alt PC */</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LI_COEF_PC_PC</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>  <span class="cm">/* Alt PC to Alt PC */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LI_COEF_PC_PC</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>  <span class="cm">/* PC     to Alt PC */</span>
	<span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LI_COEF_CH_PC</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>  <span class="cm">/* Alt IC to Alt PC */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LI_COEF_CH_PC</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>  <span class="cm">/* IC     to Alt PC */</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">LI_COEF_CH_CH</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>  <span class="cm">/* Alt B  to Alt IC */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">LI_COEF_CH_CH</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>  <span class="cm">/* B      to Alt IC */</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">LI_COEF_PC_CH</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>  <span class="cm">/* Alt PC to Alt IC */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">LI_COEF_PC_CH</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>  <span class="cm">/* PC     to Alt IC */</span>
	<span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">LI_COEF_CH_CH</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>  <span class="cm">/* Alt IC to Alt IC */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">LI_COEF_CH_CH</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">}</span>   <span class="cm">/* IC     to Alt IC */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">byte</span> <span class="n">mixer_swapped_index_bri</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="mi">18</span><span class="p">,</span>  <span class="cm">/* B      to B      */</span>
	<span class="mi">19</span><span class="p">,</span>  <span class="cm">/* Alt B  to B      */</span>
	<span class="mi">20</span><span class="p">,</span>  <span class="cm">/* PC     to B      */</span>
	<span class="mi">21</span><span class="p">,</span>  <span class="cm">/* Alt PC to B      */</span>
	<span class="mi">22</span><span class="p">,</span>  <span class="cm">/* IC     to B      */</span>
	<span class="mi">23</span><span class="p">,</span>  <span class="cm">/* Alt IC to B      */</span>
	<span class="mi">24</span><span class="p">,</span>  <span class="cm">/* B      to PC     */</span>
	<span class="mi">25</span><span class="p">,</span>  <span class="cm">/* Alt B  to PC     */</span>
	<span class="mi">26</span><span class="p">,</span>  <span class="cm">/* PC     to PC     */</span>
	<span class="mi">27</span><span class="p">,</span>  <span class="cm">/* Alt PC to PC     */</span>
	<span class="mi">28</span><span class="p">,</span>  <span class="cm">/* IC     to PC     */</span>
	<span class="mi">29</span><span class="p">,</span>  <span class="cm">/* Alt IC to PC     */</span>
	<span class="mi">30</span><span class="p">,</span>  <span class="cm">/* B      to IC     */</span>
	<span class="mi">31</span><span class="p">,</span>  <span class="cm">/* Alt B  to IC     */</span>
	<span class="mi">32</span><span class="p">,</span>  <span class="cm">/* PC     to IC     */</span>
	<span class="mi">33</span><span class="p">,</span>  <span class="cm">/* Alt PC to IC     */</span>
	<span class="mi">34</span><span class="p">,</span>  <span class="cm">/* IC     to IC     */</span>
	<span class="mi">35</span><span class="p">,</span>  <span class="cm">/* Alt IC to IC     */</span>
	<span class="mi">0</span><span class="p">,</span>   <span class="cm">/* Alt B  to Alt B  */</span>
	<span class="mi">1</span><span class="p">,</span>   <span class="cm">/* B      to Alt B  */</span>
	<span class="mi">2</span><span class="p">,</span>   <span class="cm">/* Alt PC to Alt B  */</span>
	<span class="mi">3</span><span class="p">,</span>   <span class="cm">/* PC     to Alt B  */</span>
	<span class="mi">4</span><span class="p">,</span>   <span class="cm">/* Alt IC to Alt B  */</span>
	<span class="mi">5</span><span class="p">,</span>   <span class="cm">/* IC     to Alt B  */</span>
	<span class="mi">6</span><span class="p">,</span>   <span class="cm">/* Alt B  to Alt PC */</span>
	<span class="mi">7</span><span class="p">,</span>   <span class="cm">/* B      to Alt PC */</span>
	<span class="mi">8</span><span class="p">,</span>   <span class="cm">/* Alt PC to Alt PC */</span>
	<span class="mi">9</span><span class="p">,</span>   <span class="cm">/* PC     to Alt PC */</span>
	<span class="mi">10</span><span class="p">,</span>  <span class="cm">/* Alt IC to Alt PC */</span>
	<span class="mi">11</span><span class="p">,</span>  <span class="cm">/* IC     to Alt PC */</span>
	<span class="mi">12</span><span class="p">,</span>  <span class="cm">/* Alt B  to Alt IC */</span>
	<span class="mi">13</span><span class="p">,</span>  <span class="cm">/* B      to Alt IC */</span>
	<span class="mi">14</span><span class="p">,</span>  <span class="cm">/* Alt PC to Alt IC */</span>
	<span class="mi">15</span><span class="p">,</span>  <span class="cm">/* PC     to Alt IC */</span>
	<span class="mi">16</span><span class="p">,</span>  <span class="cm">/* Alt IC to Alt IC */</span>
	<span class="mi">17</span>   <span class="cm">/* IC     to Alt IC */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span>
<span class="p">{</span>
	<span class="n">byte</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">from_pc</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">to_pc</span><span class="p">;</span>
<span class="p">}</span> <span class="n">xconnect_write_prog</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="n">LI_COEF_CH_CH</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">LI_COEF_CH_PC</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">LI_COEF_PC_CH</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">LI_COEF_PC_PC</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span> <span class="p">}</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">xconnect_query_addresses</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">w</span><span class="p">,</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: xconnect_query_addresses&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_pri</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			  <span class="o">||</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">!=</span> <span class="n">plci</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06x] %s,%d: Channel id wiped out&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
				<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">;</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_pri</span><span class="p">)</span> <span class="o">?</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">UDATA_REQUEST_XCONNECT_FROM</span><span class="p">;</span>
	<span class="n">w</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">w</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">w</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">|</span> <span class="n">XCONNECT_CHANNEL_PORT_PC</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">w</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">w</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">ReqCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">N_UDATA</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">xconnect_write_coefs</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">word</span> <span class="n">internal_command</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: xconnect_write_coefs %04x&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">internal_command</span><span class="p">));</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_write_command</span> <span class="o">=</span> <span class="n">internal_command</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_write_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">byte</span> <span class="nf">xconnect_write_coefs_process</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">w</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">to_ch</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">d</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xconnect_transfer_address_s</span>   <span class="o">*</span><span class="n">transfer_address</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">ch_map</span><span class="p">[</span><span class="n">MIXER_CHANNELS_BRI</span><span class="p">];</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06x] %s,%d: xconnect_write_coefs_process %02x %d&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_write_channel</span><span class="p">));</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">!=</span> <span class="n">plci</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06x] %s,%d: Channel id wiped out&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">j</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_write_channel</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK_FC</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: LI write coefs failed %02x&quot;</span><span class="p">,</span>
					<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">));</span>
			<span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_XCONNECT</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_ADDRESSES_SET</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">s</span> <span class="o">=</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">send_b</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">low</span> <span class="o">|</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">send_b</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">high</span><span class="p">)</span> <span class="o">?</span>
				     <span class="p">(</span><span class="n">LI_COEF_CH_CH</span> <span class="o">|</span> <span class="n">LI_COEF_CH_PC</span> <span class="o">|</span> <span class="n">LI_COEF_PC_CH</span> <span class="o">|</span> <span class="n">LI_COEF_PC_PC</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">LI_COEF_CH_PC</span> <span class="o">|</span> <span class="n">LI_COEF_PC_PC</span><span class="p">))</span> <span class="o">&amp;</span>
					<span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">send_pc</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">low</span> <span class="o">|</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">send_pc</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">high</span><span class="p">)</span> <span class="o">?</span>
					 <span class="p">(</span><span class="n">LI_COEF_CH_CH</span> <span class="o">|</span> <span class="n">LI_COEF_CH_PC</span> <span class="o">|</span> <span class="n">LI_COEF_PC_CH</span> <span class="o">|</span> <span class="n">LI_COEF_PC_PC</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">LI_COEF_CH_CH</span> <span class="o">|</span> <span class="n">LI_COEF_PC_CH</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">r</span> <span class="o">=</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">)</span>
			       <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				   <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_ADDRESSES_SET</span><span class="p">))</span>
				   <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">li_pri</span>
				       <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_BCHANNELS_BRI</span><span class="p">))</span>
				   <span class="o">||</span> <span class="p">(((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">send_b</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">low</span> <span class="o">!=</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">send_b</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">low</span><span class="p">)</span>
					<span class="o">||</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">send_b</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">high</span> <span class="o">!=</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">send_b</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">high</span><span class="p">))</span>
				       <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_DMACONNECT</span><span class="p">)</span>
					   <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_DMACONNECT</span><span class="p">)))</span>
				   <span class="o">||</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">!=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">)</span>
				       <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="n">s</span> <span class="o">&amp;</span>
					    <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">send_b</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">low</span> <span class="o">|</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">send_b</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">high</span><span class="p">)</span> <span class="o">?</span>
					     <span class="p">(</span><span class="n">LI_COEF_CH_CH</span> <span class="o">|</span> <span class="n">LI_COEF_CH_PC</span> <span class="o">|</span> <span class="n">LI_COEF_PC_CH</span> <span class="o">|</span> <span class="n">LI_COEF_PC_PC</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">LI_COEF_PC_CH</span> <span class="o">|</span> <span class="n">LI_COEF_PC_PC</span><span class="p">))</span> <span class="o">&amp;</span>
					    <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">send_pc</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">low</span> <span class="o">|</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">send_pc</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">high</span><span class="p">)</span> <span class="o">?</span>
					     <span class="p">(</span><span class="n">LI_COEF_CH_CH</span> <span class="o">|</span> <span class="n">LI_COEF_CH_PC</span> <span class="o">|</span> <span class="n">LI_COEF_PC_CH</span> <span class="o">|</span> <span class="n">LI_COEF_PC_PC</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">LI_COEF_CH_CH</span> <span class="o">|</span> <span class="n">LI_COEF_CH_PC</span><span class="p">))))))</span>
			<span class="p">{</span>
				<span class="n">j</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">)</span>
					<span class="n">r</span> <span class="o">=</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_write_command</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci_nl_busy</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
				<span class="k">return</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
			<span class="n">to_ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_pri</span><span class="p">)</span> <span class="o">?</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">UDATA_REQUEST_XCONNECT_TO</span><span class="p">;</span>
			<span class="k">do</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">!=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">r</span> <span class="o">&amp;=</span> <span class="n">s</span> <span class="o">&amp;</span>
						<span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">send_b</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">low</span> <span class="o">|</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">send_b</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">high</span><span class="p">)</span> <span class="o">?</span>
						 <span class="p">(</span><span class="n">LI_COEF_CH_CH</span> <span class="o">|</span> <span class="n">LI_COEF_CH_PC</span> <span class="o">|</span> <span class="n">LI_COEF_PC_CH</span> <span class="o">|</span> <span class="n">LI_COEF_PC_PC</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">LI_COEF_PC_CH</span> <span class="o">|</span> <span class="n">LI_COEF_PC_PC</span><span class="p">))</span> <span class="o">&amp;</span>
						<span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">send_pc</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">low</span> <span class="o">|</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">send_pc</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">high</span><span class="p">)</span> <span class="o">?</span>
						 <span class="p">(</span><span class="n">LI_COEF_CH_CH</span> <span class="o">|</span> <span class="n">LI_COEF_CH_PC</span> <span class="o">|</span> <span class="n">LI_COEF_PC_CH</span> <span class="o">|</span> <span class="n">LI_COEF_PC_PC</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">LI_COEF_CH_CH</span> <span class="o">|</span> <span class="n">LI_COEF_CH_PC</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">do</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="n">xconnect_write_prog</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">xconnect_write_prog</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">from_pc</span><span class="p">)</span>
							<span class="n">transfer_address</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">send_pc</span><span class="p">);</span>
						<span class="k">else</span>
							<span class="n">transfer_address</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">send_b</span><span class="p">);</span>
						<span class="n">d</span> <span class="o">=</span> <span class="n">transfer_address</span><span class="o">-&gt;</span><span class="n">card_address</span><span class="p">.</span><span class="n">low</span><span class="p">;</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">d</span><span class="p">;</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
						<span class="n">d</span> <span class="o">=</span> <span class="n">transfer_address</span><span class="o">-&gt;</span><span class="n">card_address</span><span class="p">.</span><span class="n">high</span><span class="p">;</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">d</span><span class="p">;</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
						<span class="n">d</span> <span class="o">=</span> <span class="n">transfer_address</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">d</span><span class="p">;</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
						<span class="n">w</span> <span class="o">=</span> <span class="n">xconnect_write_prog</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">to_pc</span> <span class="o">?</span> <span class="n">to_ch</span> <span class="o">|</span> <span class="n">XCONNECT_CHANNEL_PORT_PC</span> <span class="o">:</span> <span class="n">to_ch</span><span class="p">;</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">w</span><span class="p">;</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">w</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
						<span class="n">w</span> <span class="o">=</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">xconnect_write_prog</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x01</span> <span class="o">:</span>
							<span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">u_law</span> <span class="o">?</span>
							 <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">u_law</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mh">0x86</span><span class="p">)</span> <span class="o">:</span>
							 <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">u_law</span> <span class="o">?</span> <span class="mh">0x7a</span> <span class="o">:</span> <span class="mh">0x80</span><span class="p">));</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">w</span><span class="p">;</span>
						<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">^=</span> <span class="n">xconnect_write_prog</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">n</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">xconnect_write_prog</span><span class="p">))</span>
					 <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">p</span> <span class="o">-</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">&lt;</span> <span class="n">INTERNAL_REQ_BUFFER_SIZE</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">xconnect_write_prog</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="k">do</span>
					<span class="p">{</span>
						<span class="n">j</span><span class="o">++</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">)</span>
							<span class="n">r</span> <span class="o">=</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>
					<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">)</span>
						 <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						     <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_ADDRESSES_SET</span><span class="p">))</span>
						     <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">li_pri</span>
							 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_BCHANNELS_BRI</span><span class="p">))</span>
						     <span class="o">||</span> <span class="p">(((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">send_b</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">low</span> <span class="o">!=</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">send_b</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">low</span><span class="p">)</span>
							  <span class="o">||</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">send_b</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">high</span> <span class="o">!=</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">send_b</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">high</span><span class="p">))</span>
							 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_DMACONNECT</span><span class="p">)</span>
							     <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_DMACONNECT</span><span class="p">)))</span>
						     <span class="o">||</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">!=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">)</span>
							 <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="n">s</span> <span class="o">&amp;</span>
							      <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">send_b</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">low</span> <span class="o">|</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">send_b</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">high</span><span class="p">)</span> <span class="o">?</span>
							       <span class="p">(</span><span class="n">LI_COEF_CH_CH</span> <span class="o">|</span> <span class="n">LI_COEF_CH_PC</span> <span class="o">|</span> <span class="n">LI_COEF_PC_CH</span> <span class="o">|</span> <span class="n">LI_COEF_PC_PC</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">LI_COEF_PC_CH</span> <span class="o">|</span> <span class="n">LI_COEF_PC_PC</span><span class="p">))</span> <span class="o">&amp;</span>
							      <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">send_pc</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">low</span> <span class="o">|</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">send_pc</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">high</span><span class="p">)</span> <span class="o">?</span>
							       <span class="p">(</span><span class="n">LI_COEF_CH_CH</span> <span class="o">|</span> <span class="n">LI_COEF_CH_PC</span> <span class="o">|</span> <span class="n">LI_COEF_PC_CH</span> <span class="o">|</span> <span class="n">LI_COEF_PC_PC</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">LI_COEF_CH_CH</span> <span class="o">|</span> <span class="n">LI_COEF_CH_PC</span><span class="p">))))));</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">)</span>
				 <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">p</span> <span class="o">-</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">&lt;</span> <span class="n">INTERNAL_REQ_BUFFER_SIZE</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">li_total_channels</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_write_command</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci_nl_busy</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
				<span class="k">return</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_pri</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">UDATA_REQUEST_SET_MIXER_COEFS_PRI_SYNC</span><span class="p">;</span>
				<span class="n">w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_TX_DATA</span><span class="p">)</span>
					<span class="n">w</span> <span class="o">|=</span> <span class="n">MIXER_FEATURE_ENABLE_TX_DATA</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_RX_DATA</span><span class="p">)</span>
					<span class="n">w</span> <span class="o">|=</span> <span class="n">MIXER_FEATURE_ENABLE_RX_DATA</span><span class="p">;</span>
				<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">w</span><span class="p">;</span>
				<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">w</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">UDATA_REQUEST_SET_MIXER_COEFS_BRI</span><span class="p">;</span>
				<span class="n">w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">ADV_VOICE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span> <span class="o">==</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">)</span>
				    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ADV_VOICE_NEW_COEF_BASE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_length</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">w</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_buffer</span> <span class="o">+</span> <span class="n">ADV_VOICE_NEW_COEF_BASE</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_TX_DATA</span><span class="p">)</span>
					<span class="n">w</span> <span class="o">|=</span> <span class="n">MIXER_FEATURE_ENABLE_TX_DATA</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_RX_DATA</span><span class="p">)</span>
					<span class="n">w</span> <span class="o">|=</span> <span class="n">MIXER_FEATURE_ENABLE_RX_DATA</span><span class="p">;</span>
				<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">w</span><span class="p">;</span>
				<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">w</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ch_map</span><span class="p">);</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">ch_map</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
						<span class="n">ch_map</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">j</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">ch_map</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">j</span><span class="p">;</span>
						<span class="n">ch_map</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mixer_write_prog_bri</span><span class="p">);</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">ch_map</span><span class="p">[</span><span class="n">mixer_write_prog_bri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">to_ch</span><span class="p">];</span>
					<span class="n">j</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">ch_map</span><span class="p">[</span><span class="n">mixer_write_prog_bri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">from_ch</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_INVOLVED</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">mixer_write_prog_bri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">xconnect_override</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
							<span class="n">mixer_write_prog_bri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">xconnect_override</span> <span class="o">:</span>
							<span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mixer_write_prog_bri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mh">0x01</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_BCHANNELS_BRI</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_BCHANNELS_BRI</span><span class="p">))</span>
						<span class="p">{</span>
							<span class="n">w</span> <span class="o">=</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>
							<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">^=</span> <span class="p">(</span><span class="n">w</span> <span class="o">&amp;</span> <span class="n">mixer_write_prog_bri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">ADV_VOICE</span><span class="p">))</span>
						<span class="p">{</span>
							<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span> <span class="o">==</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">)</span> <span class="o">?</span> <span class="n">n</span> <span class="o">:</span> <span class="n">mixer_swapped_index_bri</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">ADV_VOICE_NEW_COEF_BASE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">+</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_length</span><span class="p">)</span>
								<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_buffer</span><span class="p">[</span><span class="n">ADV_VOICE_NEW_COEF_BASE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">+</span> <span class="n">w</span><span class="p">];</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="n">p</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">j</span> <span class="o">=</span> <span class="n">li_total_channels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;=</span> <span class="n">li_total_channels</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_write_command</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci_nl_busy</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
				<span class="k">return</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">)</span>
				<span class="n">j</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_pri</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">UDATA_REQUEST_SET_MIXER_COEFS_PRI_SYNC</span><span class="p">;</span>
				<span class="n">w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_TX_DATA</span><span class="p">)</span>
					<span class="n">w</span> <span class="o">|=</span> <span class="n">MIXER_FEATURE_ENABLE_TX_DATA</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_RX_DATA</span><span class="p">)</span>
					<span class="n">w</span> <span class="o">|=</span> <span class="n">MIXER_FEATURE_ENABLE_RX_DATA</span><span class="p">;</span>
				<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">w</span><span class="p">;</span>
				<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">w</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mixer_write_prog_pri</span><span class="p">);</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">mixer_write_prog_pri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">line_flags</span><span class="p">);</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_CHANNELS_PRI</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">w</span> <span class="o">=</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">&amp;</span> <span class="n">mixer_write_prog_pri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mixer_write_prog_pri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mh">0x01</span><span class="p">;</span>
							<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">^=</span> <span class="n">mixer_write_prog_pri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">else</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">MIXER_COEF_LINE_ROW_FLAG</span> <span class="o">|</span> <span class="n">mixer_write_prog_pri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">line_flags</span><span class="p">);</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_CHANNELS_PRI</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">w</span> <span class="o">=</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">&amp;</span> <span class="n">mixer_write_prog_pri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mixer_write_prog_pri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mh">0x01</span><span class="p">;</span>
							<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="n">mixer_write_prog_pri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">else</span>
							<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">UDATA_REQUEST_SET_MIXER_COEFS_BRI</span><span class="p">;</span>
				<span class="n">w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">ADV_VOICE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span> <span class="o">==</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">)</span>
				    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ADV_VOICE_NEW_COEF_BASE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_length</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">w</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_buffer</span> <span class="o">+</span> <span class="n">ADV_VOICE_NEW_COEF_BASE</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_TX_DATA</span><span class="p">)</span>
					<span class="n">w</span> <span class="o">|=</span> <span class="n">MIXER_FEATURE_ENABLE_TX_DATA</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_RX_DATA</span><span class="p">)</span>
					<span class="n">w</span> <span class="o">|=</span> <span class="n">MIXER_FEATURE_ENABLE_RX_DATA</span><span class="p">;</span>
				<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">w</span><span class="p">;</span>
				<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">w</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ch_map</span><span class="p">);</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">ch_map</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
						<span class="n">ch_map</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">j</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">ch_map</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">j</span><span class="p">;</span>
						<span class="n">ch_map</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mixer_write_prog_bri</span><span class="p">);</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">ch_map</span><span class="p">[</span><span class="n">mixer_write_prog_bri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">to_ch</span><span class="p">];</span>
					<span class="n">j</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">ch_map</span><span class="p">[</span><span class="n">mixer_write_prog_bri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">from_ch</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_INVOLVED</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mixer_write_prog_bri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mh">0x01</span><span class="p">);</span>
						<span class="n">w</span> <span class="o">=</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>
						<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">^=</span> <span class="p">(</span><span class="n">w</span> <span class="o">&amp;</span> <span class="n">mixer_write_prog_bri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">ADV_VOICE</span><span class="p">))</span>
						<span class="p">{</span>
							<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span> <span class="o">==</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">)</span> <span class="o">?</span> <span class="n">n</span> <span class="o">:</span> <span class="n">mixer_swapped_index_bri</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">ADV_VOICE_NEW_COEF_BASE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">+</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_length</span><span class="p">)</span>
								<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_buffer</span><span class="p">[</span><span class="n">ADV_VOICE_NEW_COEF_BASE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">+</span> <span class="n">w</span><span class="p">];</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="n">p</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">j</span> <span class="o">=</span> <span class="n">li_total_channels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_write_channel</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">ReqCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">N_UDATA</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mixer_notify_update</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">others</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">notify_plci</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">msg</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">CAPI_MSG_HEADER</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">];</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: mixer_notify_update %d&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">others</span><span class="p">));</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span> <span class="o">&amp;</span> <span class="n">GL_LINE_INTERCONNECT_SUPPORTED</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">others</span><span class="p">)</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_notify_update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">do</span>
		<span class="p">{</span>
			<span class="n">notify_plci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">others</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">plci</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
					<span class="n">i</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">)</span>
					<span class="n">notify_plci</span> <span class="o">=</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">plci</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="n">plci</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">notify_plci</span> <span class="o">=</span> <span class="n">plci</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">notify_plci</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">notify_plci</span><span class="o">-&gt;</span><span class="n">li_notify_update</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">notify_plci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">notify_plci</span><span class="o">-&gt;</span><span class="n">State</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="n">notify_plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">notify_plci</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">notify_plci</span><span class="o">-&gt;</span><span class="n">li_notify_update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">((</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
				<span class="p">((</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">appl_id</span> <span class="o">=</span> <span class="n">notify_plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
				<span class="p">((</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">_FACILITY_R</span><span class="p">;</span>
				<span class="p">((</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">((</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">controller</span> <span class="o">=</span> <span class="n">notify_plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
				<span class="p">((</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">plci</span> <span class="o">=</span> <span class="n">notify_plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
				<span class="p">((</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">ncci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">((</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">facility_req</span><span class="p">.</span><span class="n">Selector</span> <span class="o">=</span> <span class="n">SELECTOR_LINE_INTERCONNECT</span><span class="p">;</span>
				<span class="p">((</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">facility_req</span><span class="p">.</span><span class="n">structs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(((</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">facility_req</span><span class="p">.</span><span class="n">structs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">LI_REQ_SILENT_UPDATE</span><span class="p">);</span>
				<span class="p">((</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">facility_req</span><span class="p">.</span><span class="n">structs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">w</span> <span class="o">=</span> <span class="n">api_put</span><span class="p">(</span><span class="n">notify_plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="p">(</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="n">_QUEUE_FULL</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Interconnect notify failed %06x %d&quot;</span><span class="p">,</span>
								<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
								<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span>
								<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">notify_plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">notify_plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span> <span class="n">w</span><span class="p">));</span>
					<span class="p">}</span>
					<span class="n">notify_plci</span><span class="o">-&gt;</span><span class="n">li_notify_update</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">others</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">notify_plci</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">others</span><span class="p">)</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_notify_update</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mixer_clear_config</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: mixer_clear_config&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_notify_update</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_write_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_req_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="n">plci</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">curchnl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_pri</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_COEF_CH_PC_SET</span> <span class="o">|</span> <span class="n">LI_COEF_PC_CH_SET</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">ADV_VOICE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span> <span class="o">==</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_IC_CHANNEL_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">curchnl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_SLAVE_CODEC</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_IC_CHANNEL_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">);</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">curchnl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mixer_prepare_switch</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: mixer_prepare_switch&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="k">do</span>
	<span class="p">{</span>
		<span class="n">mixer_indication_coefs_set</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span> <span class="o">!=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_req_pos</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">word</span> <span class="nf">mixer_save_config</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: mixer_save_config %02x %d&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span><span class="p">));</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="n">plci</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_pri</span><span class="p">)</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_COEF_CH_PC_SET</span> <span class="o">|</span> <span class="n">LI_COEF_PC_CH_SET</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">GOOD</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">word</span> <span class="nf">mixer_restore_config</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: mixer_restore_config %02x %d&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">GOOD</span><span class="p">;</span>
	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_MIXER</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="n">plci</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_MIXER_1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_XCONNECT</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci_nl_busy</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_MIXER_1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">xconnect_query_addresses</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_MIXER_2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_MIXER_5</span><span class="p">;</span>
			<span class="n">Rc</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_MIXER_2</span>:
		<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_MIXER_3</span>:
		<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_MIXER_4</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK_FC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Adjust B query addresses failed %02x&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">));</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">==</span> <span class="n">OK</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">==</span> <span class="n">ADJUST_B_RESTORE_MIXER_2</span><span class="p">)</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_MIXER_3</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">==</span> <span class="n">ADJUST_B_RESTORE_MIXER_4</span><span class="p">)</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_MIXER_5</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">==</span> <span class="n">ADJUST_B_RESTORE_MIXER_2</span><span class="p">)</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_MIXER_4</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">==</span> <span class="n">ADJUST_B_RESTORE_MIXER_3</span><span class="p">)</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_MIXER_5</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">!=</span> <span class="n">ADJUST_B_RESTORE_MIXER_5</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_MIXER_5</span>:
			<span class="n">xconnect_write_coefs</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_MIXER_6</span><span class="p">;</span>
			<span class="n">Rc</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_MIXER_6</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xconnect_write_coefs_process</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Write mixer coefs failed&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_FACILITY_NOT_SUPPORTED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_MIXER_7</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_MIXER_7</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">Info</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mixer_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">internal_command</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: mixer_command %02x %04x %04x&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">,</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_cmd</span><span class="p">));</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_cmd</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">LI_REQ_CONNECT</span>:
	<span class="k">case</span> <span class="n">LI_REQ_DISCONNECT</span>:
	<span class="k">case</span> <span class="n">LI_REQ_SILENT_UPDATE</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">internal_command</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_channel_bits</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_INVOLVED</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">adjust_b1_resource</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">|</span>
									  <span class="n">B1_FACILITY_MIXER</span><span class="p">),</span> <span class="n">MIXER_COMMAND_1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="n">MIXER_COMMAND_1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_channel_bits</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_INVOLVED</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">adjust_b_process</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Load mixer failed&quot;</span><span class="p">,</span>
							<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
					<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_req_pos</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_write_pos</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_channel_bits</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_INVOLVED</span><span class="p">)</span>
			    <span class="o">||</span> <span class="p">((</span><span class="n">get_b1_facilities</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_MIXER</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">add_b1_facilities</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">&amp;</span>
										      <span class="o">~</span><span class="n">B1_FACILITY_MIXER</span><span class="p">))</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">)))</span>
			<span class="p">{</span>
				<span class="n">xconnect_write_coefs</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">MIXER_COMMAND_2</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="k">do</span>
				<span class="p">{</span>
					<span class="n">mixer_indication_coefs_set</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span> <span class="o">!=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_req_pos</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="n">MIXER_COMMAND_2</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_channel_bits</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_INVOLVED</span><span class="p">)</span>
			    <span class="o">||</span> <span class="p">((</span><span class="n">get_b1_facilities</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_MIXER</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">add_b1_facilities</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">&amp;</span>
										      <span class="o">~</span><span class="n">B1_FACILITY_MIXER</span><span class="p">))</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">)))</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xconnect_write_coefs_process</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Write mixer coefs failed&quot;</span><span class="p">,</span>
							<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_write_pos</span> <span class="o">!=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_req_pos</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">do</span>
						<span class="p">{</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_write_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_write_pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
								<span class="n">LI_PLCI_B_QUEUE_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_write_pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
							<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_write_pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
								<span class="n">LI_PLCI_B_QUEUE_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_write_pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
						<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_write_pos</span> <span class="o">!=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_req_pos</span><span class="p">)</span>
							 <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_PLCI_B_LAST_FLAG</span><span class="p">));</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
					<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_channel_bits</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_INVOLVED</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">adjust_b1_resource</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">&amp;</span>
									  <span class="o">~</span><span class="n">B1_FACILITY_MIXER</span><span class="p">),</span> <span class="n">MIXER_COMMAND_3</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="n">MIXER_COMMAND_3</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_channel_bits</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_INVOLVED</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">adjust_b_process</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Unload mixer failed&quot;</span><span class="p">,</span>
							<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
					<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">!=</span> <span class="n">plci</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06x] %s,%d: Channel id wiped out %d&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">)));</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">curchnl</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_channel_bits</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_pri</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">ADV_VOICE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span> <span class="o">==</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_IC_CHANNEL_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">curchnl</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_channel_bits</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_SLAVE_CODEC</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_IC_CHANNEL_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">);</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">curchnl</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_channel_bits</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">li_update_connect</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span>
			      <span class="n">dword</span> <span class="n">plci_b_id</span><span class="p">,</span> <span class="n">byte</span> <span class="n">connect</span><span class="p">,</span> <span class="n">dword</span> <span class="n">li_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch_a</span><span class="p">,</span> <span class="n">ch_a_v</span><span class="p">,</span> <span class="n">ch_a_s</span><span class="p">,</span> <span class="n">ch_b</span><span class="p">,</span> <span class="n">ch_b_v</span><span class="p">,</span> <span class="n">ch_b_s</span><span class="p">;</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">plci_b</span><span class="p">;</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a_b</span><span class="p">;</span>

	<span class="n">a_b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">adapter</span><span class="p">[</span><span class="n">MapController</span><span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="n">plci_b_id</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="n">plci_b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">a_b</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[((</span><span class="n">plci_b_id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="n">ch_a</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_pri</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">ADV_VOICE</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span> <span class="o">==</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Id</span> <span class="o">&amp;</span> <span class="n">EXT_CONTROLLER</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">ch_a_v</span> <span class="o">=</span> <span class="n">ch_a</span> <span class="o">+</span> <span class="n">MIXER_IC_CHANNEL_BASE</span><span class="p">;</span>
		<span class="n">ch_a_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_SLAVE_CODEC</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_IC_CHANNEL_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">)</span> <span class="o">:</span> <span class="n">ch_a_v</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">ch_a_v</span> <span class="o">=</span> <span class="n">ch_a</span><span class="p">;</span>
		<span class="n">ch_a_s</span> <span class="o">=</span> <span class="n">ch_a</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ch_b</span> <span class="o">=</span> <span class="n">a_b</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a_b</span><span class="o">-&gt;</span><span class="n">li_pri</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">ADV_VOICE</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci_b</span> <span class="o">==</span> <span class="n">a_b</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci_b_id</span> <span class="o">&amp;</span> <span class="n">EXT_CONTROLLER</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">ch_b_v</span> <span class="o">=</span> <span class="n">ch_b</span> <span class="o">+</span> <span class="n">MIXER_IC_CHANNEL_BASE</span><span class="p">;</span>
		<span class="n">ch_b_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">a_b</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_SLAVE_CODEC</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">a_b</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_IC_CHANNEL_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">)</span> <span class="o">:</span> <span class="n">ch_b_v</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">ch_b_v</span> <span class="o">=</span> <span class="n">ch_b</span><span class="p">;</span>
		<span class="n">ch_b_s</span> <span class="o">=</span> <span class="n">ch_b</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LI_FLAG_MONITOR</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LI_FLAG_MONITOR</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LI_FLAG_ANNOUNCEMENT</span> <span class="o">|</span> <span class="n">LI_FLAG_MIX</span><span class="p">);</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LI_FLAG_ANNOUNCEMENT</span> <span class="o">|</span> <span class="n">LI_FLAG_MIX</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LI_FLAG_MONITOR</span><span class="p">;</span>
	<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LI_FLAG_MONITOR</span><span class="p">;</span>
	<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LI_FLAG_ANNOUNCEMENT</span> <span class="o">|</span> <span class="n">LI_FLAG_MIX</span><span class="p">);</span>
	<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LI_FLAG_ANNOUNCEMENT</span> <span class="o">|</span> <span class="n">LI_FLAG_MIX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch_a_v</span> <span class="o">==</span> <span class="n">ch_b_v</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">ch_a_v</span><span class="p">)</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">ch_a_s</span><span class="p">)</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">ch_a_v</span><span class="p">)</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">ch_a_s</span><span class="p">)</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_flags</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_CONFERENCE_A_B</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_flags</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_CONFERENCE_B_A</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_flags</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_MONITOR_A</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_MONITOR</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_MONITOR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_flags</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_MONITOR_B</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_MONITOR</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_MONITOR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_flags</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_ANNOUNCEMENT_A</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_ANNOUNCEMENT</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_ANNOUNCEMENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_flags</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_ANNOUNCEMENT_B</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_ANNOUNCEMENT</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_ANNOUNCEMENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_flags</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_MIX_A</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_MIX</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_MIX</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_flags</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_MIX_B</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_MIX</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_MIX</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch_a_v</span> <span class="o">!=</span> <span class="n">ch_a_s</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch_b_v</span> <span class="o">!=</span> <span class="n">ch_b_s</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">li2_update_connect</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span>
			       <span class="n">dword</span> <span class="n">plci_b_id</span><span class="p">,</span> <span class="n">byte</span> <span class="n">connect</span><span class="p">,</span> <span class="n">dword</span> <span class="n">li_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">ch_a</span><span class="p">,</span> <span class="n">ch_a_v</span><span class="p">,</span> <span class="n">ch_a_s</span><span class="p">,</span> <span class="n">ch_b</span><span class="p">,</span> <span class="n">ch_b_v</span><span class="p">,</span> <span class="n">ch_b_s</span><span class="p">;</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">plci_b</span><span class="p">;</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a_b</span><span class="p">;</span>

	<span class="n">a_b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">adapter</span><span class="p">[</span><span class="n">MapController</span><span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="n">plci_b_id</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="n">plci_b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">a_b</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[((</span><span class="n">plci_b_id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="n">ch_a</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_pri</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">ADV_VOICE</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span> <span class="o">==</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Id</span> <span class="o">&amp;</span> <span class="n">EXT_CONTROLLER</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">ch_a_v</span> <span class="o">=</span> <span class="n">ch_a</span> <span class="o">+</span> <span class="n">MIXER_IC_CHANNEL_BASE</span><span class="p">;</span>
		<span class="n">ch_a_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_SLAVE_CODEC</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_IC_CHANNEL_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">)</span> <span class="o">:</span> <span class="n">ch_a_v</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">ch_a_v</span> <span class="o">=</span> <span class="n">ch_a</span><span class="p">;</span>
		<span class="n">ch_a_s</span> <span class="o">=</span> <span class="n">ch_a</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ch_b</span> <span class="o">=</span> <span class="n">a_b</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a_b</span><span class="o">-&gt;</span><span class="n">li_pri</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">ADV_VOICE</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci_b</span> <span class="o">==</span> <span class="n">a_b</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci_b_id</span> <span class="o">&amp;</span> <span class="n">EXT_CONTROLLER</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">ch_b_v</span> <span class="o">=</span> <span class="n">ch_b</span> <span class="o">+</span> <span class="n">MIXER_IC_CHANNEL_BASE</span><span class="p">;</span>
		<span class="n">ch_b_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">a_b</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_SLAVE_CODEC</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">a_b</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_IC_CHANNEL_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">)</span> <span class="o">:</span> <span class="n">ch_b_v</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">ch_b_v</span> <span class="o">=</span> <span class="n">ch_b</span><span class="p">;</span>
		<span class="n">ch_b_s</span> <span class="o">=</span> <span class="n">ch_b</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LI_FLAG_MONITOR</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LI_FLAG_MONITOR</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LI_FLAG_MIX</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LI_FLAG_MIX</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LI_FLAG_PCCONNECT</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b</span><span class="p">].</span><span class="n">chflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LI_CHFLAG_MONITOR</span> <span class="o">|</span> <span class="n">LI_CHFLAG_MIX</span> <span class="o">|</span> <span class="n">LI_CHFLAG_LOOP</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LI_FLAG_INTERCONNECT</span> <span class="o">|</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">);</span>
	<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LI_FLAG_INTERCONNECT</span> <span class="o">|</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">);</span>
	<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LI_FLAG_INTERCONNECT</span> <span class="o">|</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">);</span>
	<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LI_FLAG_INTERCONNECT</span> <span class="o">|</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">);</span>
	<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LI_FLAG_INTERCONNECT</span> <span class="o">|</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">);</span>
	<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LI_FLAG_INTERCONNECT</span> <span class="o">|</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">);</span>
	<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LI_FLAG_INTERCONNECT</span> <span class="o">|</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">);</span>
	<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LI_FLAG_INTERCONNECT</span> <span class="o">|</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_flags</span> <span class="o">&amp;</span> <span class="n">LI2_FLAG_INTERCONNECT_A_B</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_INTERCONNECT</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_INTERCONNECT</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_INTERCONNECT</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_INTERCONNECT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_flags</span> <span class="o">&amp;</span> <span class="n">LI2_FLAG_INTERCONNECT_B_A</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_INTERCONNECT</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_INTERCONNECT</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_INTERCONNECT</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_INTERCONNECT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_flags</span> <span class="o">&amp;</span> <span class="n">LI2_FLAG_MONITOR_B</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_MONITOR</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_MONITOR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_flags</span> <span class="o">&amp;</span> <span class="n">LI2_FLAG_MIX_B</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_MIX</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_MIX</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_flags</span> <span class="o">&amp;</span> <span class="n">LI2_FLAG_MONITOR_X</span><span class="p">)</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b</span><span class="p">].</span><span class="n">chflags</span> <span class="o">|=</span> <span class="n">LI_CHFLAG_MONITOR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_flags</span> <span class="o">&amp;</span> <span class="n">LI2_FLAG_MIX_X</span><span class="p">)</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b</span><span class="p">].</span><span class="n">chflags</span> <span class="o">|=</span> <span class="n">LI_CHFLAG_MIX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_flags</span> <span class="o">&amp;</span> <span class="n">LI2_FLAG_LOOP_B</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_INTERCONNECT</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_INTERCONNECT</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_INTERCONNECT</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_INTERCONNECT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_flags</span> <span class="o">&amp;</span> <span class="n">LI2_FLAG_LOOP_PC</span><span class="p">)</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_PCCONNECT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_flags</span> <span class="o">&amp;</span> <span class="n">LI2_FLAG_LOOP_X</span><span class="p">)</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b</span><span class="p">].</span><span class="n">chflags</span> <span class="o">|=</span> <span class="n">LI_CHFLAG_LOOP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_flags</span> <span class="o">&amp;</span> <span class="n">LI2_FLAG_PCCONNECT_A_B</span><span class="p">)</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_PCCONNECT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">li_flags</span> <span class="o">&amp;</span> <span class="n">LI2_FLAG_PCCONNECT_B_A</span><span class="p">)</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_PCCONNECT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch_a_v</span> <span class="o">!=</span> <span class="n">ch_a_s</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_a_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_a_v</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch_b_v</span> <span class="o">!=</span> <span class="n">ch_b_s</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">ch_b_s</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">ch_b_v</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">word</span> <span class="nf">li_check_main_plci</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong PLCI&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">_WRONG_IDENTIFIER</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span>
	    <span class="o">||</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong state&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">_WRONG_STATE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">li_config_table</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">=</span> <span class="n">plci</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">GOOD</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">PLCI</span> <span class="o">*</span><span class="nf">li_check_plci_b</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span>
			     <span class="n">dword</span> <span class="n">plci_b_id</span><span class="p">,</span> <span class="n">word</span> <span class="n">plci_b_write_pos</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">p_result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">byte</span> <span class="n">ctlr_b</span><span class="p">;</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">plci_b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span> <span class="o">&gt;</span> <span class="n">plci_b_write_pos</span><span class="p">)</span> <span class="o">?</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span> <span class="o">:</span>
	     <span class="n">LI_PLCI_B_QUEUE_ENTRIES</span> <span class="o">+</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span><span class="p">)</span> <span class="o">-</span> <span class="n">plci_b_write_pos</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: LI request overrun&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="n">p_result</span><span class="p">,</span> <span class="n">_REQUEST_NOT_ALLOWED_IN_THIS_STATE</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ctlr_b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">plci_b_id</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">ctlr_b</span> <span class="o">=</span> <span class="n">MapController</span><span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="n">plci_b_id</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ctlr_b</span> <span class="o">&gt;</span> <span class="n">max_adapter</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">ctlr_b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">adapter</span><span class="p">[</span><span class="n">ctlr_b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)))</span>
			<span class="n">ctlr_b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctlr_b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(((</span><span class="n">plci_b_id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(((</span><span class="n">plci_b_id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">adapter</span><span class="p">[</span><span class="n">ctlr_b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">max_plci</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: LI invalid second PLCI %08lx&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">plci_b_id</span><span class="p">));</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="n">p_result</span><span class="p">,</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">plci_b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">adapter</span><span class="p">[</span><span class="n">ctlr_b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">plci</span><span class="p">[((</span><span class="n">plci_b_id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">State</span>
	    <span class="o">||</span> <span class="o">!</span><span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span> <span class="o">||</span> <span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: LI peer in wrong state %08lx&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">plci_b_id</span><span class="p">));</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="n">p_result</span><span class="p">,</span> <span class="n">_REQUEST_NOT_ALLOWED_IN_THIS_STATE</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">li_config_table</span><span class="p">[</span><span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">=</span> <span class="n">plci_b</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">byte</span><span class="p">)(</span><span class="n">plci_b_id</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EXT_CONTROLLER</span><span class="p">))</span> <span class="o">!=</span>
	    <span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EXT_CONTROLLER</span><span class="p">))</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_XCONNECT</span><span class="p">)</span>
		<span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_XCONNECT</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: LI not on same ctrl %08lx&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">plci_b_id</span><span class="p">));</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="n">p_result</span><span class="p">,</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">get_b1_facilities</span><span class="p">(</span><span class="n">plci_b</span><span class="p">,</span> <span class="n">add_b1_facilities</span><span class="p">(</span><span class="n">plci_b</span><span class="p">,</span> <span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">,</span>
							  <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">|</span> <span class="n">B1_FACILITY_MIXER</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_MIXER</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Interconnect peer cannot mix %d&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">));</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="n">p_result</span><span class="p">,</span> <span class="n">_REQUEST_NOT_ALLOWED_IN_THIS_STATE</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">plci_b</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">PLCI</span> <span class="o">*</span><span class="nf">li2_check_plci_b</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span>
			      <span class="n">dword</span> <span class="n">plci_b_id</span><span class="p">,</span> <span class="n">word</span> <span class="n">plci_b_write_pos</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">p_result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">byte</span> <span class="n">ctlr_b</span><span class="p">;</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">plci_b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span> <span class="o">&gt;</span> <span class="n">plci_b_write_pos</span><span class="p">)</span> <span class="o">?</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span> <span class="o">:</span>
	     <span class="n">LI_PLCI_B_QUEUE_ENTRIES</span> <span class="o">+</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span><span class="p">)</span> <span class="o">-</span> <span class="n">plci_b_write_pos</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: LI request overrun&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="n">p_result</span><span class="p">,</span> <span class="n">_WRONG_STATE</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ctlr_b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">plci_b_id</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">ctlr_b</span> <span class="o">=</span> <span class="n">MapController</span><span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="n">plci_b_id</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ctlr_b</span> <span class="o">&gt;</span> <span class="n">max_adapter</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">ctlr_b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">adapter</span><span class="p">[</span><span class="n">ctlr_b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)))</span>
			<span class="n">ctlr_b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctlr_b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(((</span><span class="n">plci_b_id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(((</span><span class="n">plci_b_id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">adapter</span><span class="p">[</span><span class="n">ctlr_b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">max_plci</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: LI invalid second PLCI %08lx&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">plci_b_id</span><span class="p">));</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="n">p_result</span><span class="p">,</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">plci_b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">adapter</span><span class="p">[</span><span class="n">ctlr_b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">plci</span><span class="p">[((</span><span class="n">plci_b_id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">State</span>
	    <span class="o">||</span> <span class="o">!</span><span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span> <span class="o">||</span> <span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">!=</span> <span class="n">plci_b</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: LI peer in wrong state %08lx&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">plci_b_id</span><span class="p">));</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="n">p_result</span><span class="p">,</span> <span class="n">_WRONG_STATE</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">byte</span><span class="p">)(</span><span class="n">plci_b_id</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EXT_CONTROLLER</span><span class="p">))</span> <span class="o">!=</span>
	    <span class="p">((</span><span class="n">byte</span><span class="p">)(</span><span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EXT_CONTROLLER</span><span class="p">))</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_XCONNECT</span><span class="p">)</span>
		<span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_XCONNECT</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: LI not on same ctrl %08lx&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">plci_b_id</span><span class="p">));</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="n">p_result</span><span class="p">,</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">get_b1_facilities</span><span class="p">(</span><span class="n">plci_b</span><span class="p">,</span> <span class="n">add_b1_facilities</span><span class="p">(</span><span class="n">plci_b</span><span class="p">,</span> <span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">,</span>
							  <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">|</span> <span class="n">B1_FACILITY_MIXER</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_MIXER</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Interconnect peer cannot mix %d&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">plci_b</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">));</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="n">p_result</span><span class="p">,</span> <span class="n">_WRONG_STATE</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">plci_b</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">byte</span> <span class="nf">mixer_request</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span>   <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">d</span><span class="p">,</span> <span class="n">li_flags</span><span class="p">,</span> <span class="n">plci_b_id</span><span class="p">;</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">plci_b</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="n">li_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">API_PARSE</span> <span class="n">li_req_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">API_PARSE</span> <span class="n">li_participant_struct</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">API_PARSE</span> <span class="n">li_participant_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">word</span> <span class="n">participant_parms_pos</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">result_buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">result_pos</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">plci_b_write_pos</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: mixer_request&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">GOOD</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">result_buffer</span><span class="p">;</span>
	<span class="n">result_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span> <span class="o">&amp;</span> <span class="n">GL_LINE_INTERCONNECT_SUPPORTED</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Facility not supported&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="n">Info</span> <span class="o">=</span> <span class="n">_FACILITY_NOT_SUPPORTED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="n">li_parms</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong message format&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">result_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">li_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">));</span>
		<span class="n">result_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">li_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">))</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">LI_GET_SUPPORTED_SERVICES</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">appl_flags</span> <span class="o">&amp;</span> <span class="n">APPL_FLAG_OLD_LI_SPEC</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">result_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
				<span class="n">result_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">GOOD</span><span class="p">);</span>
				<span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_MIXER_CH_CH</span><span class="p">)</span>
					<span class="n">d</span> <span class="o">|=</span> <span class="n">LI_CONFERENCING_SUPPORTED</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_MIXER_CH_PC</span><span class="p">)</span>
					<span class="n">d</span> <span class="o">|=</span> <span class="n">LI_MONITORING_SUPPORTED</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_MIXER_PC_CH</span><span class="p">)</span>
					<span class="n">d</span> <span class="o">|=</span> <span class="n">LI_ANNOUNCEMENTS_SUPPORTED</span> <span class="o">|</span> <span class="n">LI_MIXING_SUPPORTED</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_XCONNECT</span><span class="p">)</span>
					<span class="n">d</span> <span class="o">|=</span> <span class="n">LI_CROSS_CONTROLLER_SUPPORTED</span><span class="p">;</span>
				<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">d</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_XCONNECT</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_XCONNECT</span><span class="p">)</span>
						    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">li_pri</span>
							<span class="o">||</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_BCHANNELS_BRI</span><span class="p">)))</span>
						<span class="p">{</span>
							<span class="n">d</span><span class="o">++</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">d</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_pri</span> <span class="o">?</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_channels</span> <span class="o">:</span> <span class="n">MIXER_BCHANNELS_BRI</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_buffer</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">d</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_buffer</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">d</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">result_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
				<span class="n">result_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">GOOD</span><span class="p">);</span>
				<span class="n">d</span> <span class="o">=</span> <span class="n">LI2_ASYMMETRIC_SUPPORTED</span> <span class="o">|</span> <span class="n">LI2_B_LOOPING_SUPPORTED</span> <span class="o">|</span> <span class="n">LI2_X_LOOPING_SUPPORTED</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_MIXER_CH_PC</span><span class="p">)</span>
					<span class="n">d</span> <span class="o">|=</span> <span class="n">LI2_MONITORING_SUPPORTED</span> <span class="o">|</span> <span class="n">LI2_REMOTE_MONITORING_SUPPORTED</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_MIXER_PC_CH</span><span class="p">)</span>
					<span class="n">d</span> <span class="o">|=</span> <span class="n">LI2_MIXING_SUPPORTED</span> <span class="o">|</span> <span class="n">LI2_REMOTE_MIXING_SUPPORTED</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_MIXER_PC_PC</span><span class="p">)</span>
					<span class="n">d</span> <span class="o">|=</span> <span class="n">LI2_PC_LOOPING_SUPPORTED</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_XCONNECT</span><span class="p">)</span>
					<span class="n">d</span> <span class="o">|=</span> <span class="n">LI2_CROSS_CONTROLLER_SUPPORTED</span><span class="p">;</span>
				<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">d</span><span class="p">);</span>
				<span class="n">d</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_pri</span> <span class="o">?</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_channels</span> <span class="o">:</span> <span class="n">MIXER_BCHANNELS_BRI</span><span class="p">;</span>
				<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_buffer</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">d</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_buffer</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_XCONNECT</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_XCONNECT</span><span class="p">)</span>
						    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">li_pri</span>
							<span class="o">||</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_BCHANNELS_BRI</span><span class="p">)))</span>
						<span class="p">{</span>
							<span class="n">d</span><span class="o">++</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_buffer</span><span class="p">[</span><span class="mi">18</span><span class="p">],</span> <span class="n">d</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_buffer</span><span class="p">[</span><span class="mi">22</span><span class="p">],</span> <span class="n">d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">LI_REQ_CONNECT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">li_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">appl</span><span class="o">-&gt;</span><span class="n">appl_flags</span> <span class="o">|=</span> <span class="n">APPL_FLAG_OLD_LI_SPEC</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">li_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;dd&quot;</span><span class="p">,</span> <span class="n">li_req_parms</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong message format&quot;</span><span class="p">,</span>
							<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">plci_b_id</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="n">li_req_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
				<span class="n">li_flags</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="n">li_req_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">li_check_main_plci</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
				<span class="n">result_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
				<span class="n">result_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
				<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">plci_b_id</span><span class="p">);</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">GOOD</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Info</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">saved_msg</span><span class="p">.</span><span class="n">info</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">result_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">plci_b_write_pos</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_write_pos</span><span class="p">;</span>
				<span class="n">plci_b</span> <span class="o">=</span> <span class="n">li_check_plci_b</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">plci_b_id</span><span class="p">,</span> <span class="n">plci_b_write_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci_b</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">li_update_connect</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">plci_b_id</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">li_flags</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_queue</span><span class="p">[</span><span class="n">plci_b_write_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci_b_id</span> <span class="o">|</span> <span class="n">LI_PLCI_B_LAST_FLAG</span><span class="p">;</span>
				<span class="n">plci_b_write_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci_b_write_pos</span> <span class="o">==</span> <span class="n">LI_PLCI_B_QUEUE_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">plci_b_write_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_write_pos</span> <span class="o">=</span> <span class="n">plci_b_write_pos</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">appl</span><span class="o">-&gt;</span><span class="n">appl_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">APPL_FLAG_OLD_LI_SPEC</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">li_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;ds&quot;</span><span class="p">,</span> <span class="n">li_req_parms</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong message format&quot;</span><span class="p">,</span>
							<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">li_flags</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="n">li_req_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">LI2_FLAG_INTERCONNECT_A_B</span> <span class="o">|</span> <span class="n">LI2_FLAG_INTERCONNECT_B_A</span><span class="p">);</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">li_check_main_plci</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
				<span class="n">result_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
				<span class="n">result_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">Info</span><span class="p">);</span>
				<span class="n">result_buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Info</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">saved_msg</span><span class="p">.</span><span class="n">info</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">result_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">plci_b_write_pos</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_write_pos</span><span class="p">;</span>
				<span class="n">participant_parms_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">result_pos</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
				<span class="n">li2_update_connect</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="nb">true</span><span class="p">,</span> <span class="n">li_flags</span><span class="p">);</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">participant_parms_pos</span> <span class="o">&lt;</span> <span class="n">li_req_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">result</span><span class="p">[</span><span class="n">result_pos</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
					<span class="n">result_pos</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">;</span>
					<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="n">result_pos</span> <span class="o">-</span> <span class="mi">6</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="n">result_pos</span> <span class="o">-</span> <span class="mi">2</span><span class="p">],</span> <span class="n">GOOD</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li_req_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">participant_parms_pos</span><span class="p">],</span>
						      <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">li_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span> <span class="o">-</span> <span class="n">participant_parms_pos</span><span class="p">),</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="n">li_participant_struct</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong message format&quot;</span><span class="p">,</span>
								<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
						<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="n">result_pos</span> <span class="o">-</span> <span class="mi">2</span><span class="p">],</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li_participant_struct</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
						      <span class="n">li_participant_struct</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;dd&quot;</span><span class="p">,</span> <span class="n">li_participant_parms</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong message format&quot;</span><span class="p">,</span>
								<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
						<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="n">result_pos</span> <span class="o">-</span> <span class="mi">2</span><span class="p">],</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">plci_b_id</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="n">li_participant_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
					<span class="n">li_flags</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="n">li_participant_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
					<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="n">result_pos</span> <span class="o">-</span> <span class="mi">6</span><span class="p">],</span> <span class="n">plci_b_id</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">-</span> <span class="n">result_pos</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: LI result overrun&quot;</span><span class="p">,</span>
								<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
						<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="n">result_pos</span> <span class="o">-</span> <span class="mi">2</span><span class="p">],</span> <span class="n">_WRONG_STATE</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">plci_b</span> <span class="o">=</span> <span class="n">li2_check_plci_b</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">plci_b_id</span><span class="p">,</span> <span class="n">plci_b_write_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="n">result_pos</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci_b</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">li2_update_connect</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">plci_b_id</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">li_flags</span><span class="p">);</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_queue</span><span class="p">[</span><span class="n">plci_b_write_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci_b_id</span> <span class="o">|</span>
							<span class="p">((</span><span class="n">li_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LI2_FLAG_INTERCONNECT_A_B</span> <span class="o">|</span> <span class="n">LI2_FLAG_INTERCONNECT_B_A</span> <span class="o">|</span>
								      <span class="n">LI2_FLAG_PCCONNECT_A_B</span> <span class="o">|</span> <span class="n">LI2_FLAG_PCCONNECT_B_A</span><span class="p">))</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">LI_PLCI_B_DISC_FLAG</span><span class="p">);</span>
						<span class="n">plci_b_write_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci_b_write_pos</span> <span class="o">==</span> <span class="n">LI_PLCI_B_QUEUE_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">plci_b_write_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">participant_parms_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)((</span><span class="o">&amp;</span><span class="n">li_participant_struct</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">li_participant_struct</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">])</span> <span class="o">-</span>
								       <span class="p">(</span><span class="o">&amp;</span><span class="n">li_req_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
				<span class="p">}</span>
				<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">result_pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">result_pos</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
				<span class="n">result</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">result_pos</span> <span class="o">-</span> <span class="mi">7</span><span class="p">);</span>
				<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci_b_write_pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">LI_PLCI_B_QUEUE_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">plci_b_write_pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">plci_b_write_pos</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span><span class="p">)</span>
				    <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_PLCI_B_LAST_FLAG</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_queue</span><span class="p">[</span><span class="n">plci_b_write_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">LI_PLCI_B_SKIP_FLAG</span> <span class="o">|</span> <span class="n">LI_PLCI_B_LAST_FLAG</span><span class="p">;</span>
					<span class="n">plci_b_write_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci_b_write_pos</span> <span class="o">==</span> <span class="n">LI_PLCI_B_QUEUE_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">plci_b_write_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_PLCI_B_LAST_FLAG</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_write_pos</span> <span class="o">=</span> <span class="n">plci_b_write_pos</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mixer_calculate_coefs</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_channel_bits</span> <span class="o">=</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">channel</span><span class="p">;</span>
			<span class="n">mixer_notify_update</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffffL</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span>
			      <span class="s">&quot;wwS&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">,</span> <span class="n">SELECTOR_LINE_INTERCONNECT</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_cmd</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">li_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
			<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">mixer_command</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">LI_REQ_DISCONNECT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">li_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">appl</span><span class="o">-&gt;</span><span class="n">appl_flags</span> <span class="o">|=</span> <span class="n">APPL_FLAG_OLD_LI_SPEC</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">li_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="n">li_req_parms</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong message format&quot;</span><span class="p">,</span>
							<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">plci_b_id</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="n">li_req_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">li_check_main_plci</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
				<span class="n">result_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
				<span class="n">result_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
				<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="n">li_req_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">));</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">GOOD</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Info</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">saved_msg</span><span class="p">.</span><span class="n">info</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">result_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">plci_b_write_pos</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_write_pos</span><span class="p">;</span>
				<span class="n">plci_b</span> <span class="o">=</span> <span class="n">li_check_plci_b</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">plci_b_id</span><span class="p">,</span> <span class="n">plci_b_write_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci_b</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">li_update_connect</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">plci_b_id</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_queue</span><span class="p">[</span><span class="n">plci_b_write_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci_b_id</span> <span class="o">|</span> <span class="n">LI_PLCI_B_DISC_FLAG</span> <span class="o">|</span> <span class="n">LI_PLCI_B_LAST_FLAG</span><span class="p">;</span>
				<span class="n">plci_b_write_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci_b_write_pos</span> <span class="o">==</span> <span class="n">LI_PLCI_B_QUEUE_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">plci_b_write_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_write_pos</span> <span class="o">=</span> <span class="n">plci_b_write_pos</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">appl</span><span class="o">-&gt;</span><span class="n">appl_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">APPL_FLAG_OLD_LI_SPEC</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">li_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="n">li_req_parms</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong message format&quot;</span><span class="p">,</span>
							<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">li_check_main_plci</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
				<span class="n">result_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
				<span class="n">result_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">Info</span><span class="p">);</span>
				<span class="n">result_buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Info</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">saved_msg</span><span class="p">.</span><span class="n">info</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">result_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">plci_b_write_pos</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_write_pos</span><span class="p">;</span>
				<span class="n">participant_parms_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">result_pos</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">participant_parms_pos</span> <span class="o">&lt;</span> <span class="n">li_req_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">result</span><span class="p">[</span><span class="n">result_pos</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
					<span class="n">result_pos</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">;</span>
					<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="n">result_pos</span> <span class="o">-</span> <span class="mi">6</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="n">result_pos</span> <span class="o">-</span> <span class="mi">2</span><span class="p">],</span> <span class="n">GOOD</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li_req_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">participant_parms_pos</span><span class="p">],</span>
						      <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">li_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span> <span class="o">-</span> <span class="n">participant_parms_pos</span><span class="p">),</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="n">li_participant_struct</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong message format&quot;</span><span class="p">,</span>
								<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
						<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="n">result_pos</span> <span class="o">-</span> <span class="mi">2</span><span class="p">],</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li_participant_struct</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
						      <span class="n">li_participant_struct</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="n">li_participant_parms</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong message format&quot;</span><span class="p">,</span>
								<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
						<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="n">result_pos</span> <span class="o">-</span> <span class="mi">2</span><span class="p">],</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">plci_b_id</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="n">li_participant_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
					<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="n">result_pos</span> <span class="o">-</span> <span class="mi">6</span><span class="p">],</span> <span class="n">plci_b_id</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">-</span> <span class="n">result_pos</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: LI result overrun&quot;</span><span class="p">,</span>
								<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
						<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="n">result_pos</span> <span class="o">-</span> <span class="mi">2</span><span class="p">],</span> <span class="n">_WRONG_STATE</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">plci_b</span> <span class="o">=</span> <span class="n">li2_check_plci_b</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">plci_b_id</span><span class="p">,</span> <span class="n">plci_b_write_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="n">result_pos</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">plci_b</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">li2_update_connect</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">plci_b_id</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_queue</span><span class="p">[</span><span class="n">plci_b_write_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci_b_id</span> <span class="o">|</span> <span class="n">LI_PLCI_B_DISC_FLAG</span><span class="p">;</span>
						<span class="n">plci_b_write_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci_b_write_pos</span> <span class="o">==</span> <span class="n">LI_PLCI_B_QUEUE_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">plci_b_write_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">participant_parms_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)((</span><span class="o">&amp;</span><span class="n">li_participant_struct</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">li_participant_struct</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">])</span> <span class="o">-</span>
								       <span class="p">(</span><span class="o">&amp;</span><span class="n">li_req_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
				<span class="p">}</span>
				<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">result_pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">result_pos</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
				<span class="n">result</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">result_pos</span> <span class="o">-</span> <span class="mi">7</span><span class="p">);</span>
				<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci_b_write_pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">LI_PLCI_B_QUEUE_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">plci_b_write_pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">plci_b_write_pos</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span><span class="p">)</span>
				    <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_PLCI_B_LAST_FLAG</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_queue</span><span class="p">[</span><span class="n">plci_b_write_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">LI_PLCI_B_SKIP_FLAG</span> <span class="o">|</span> <span class="n">LI_PLCI_B_LAST_FLAG</span><span class="p">;</span>
					<span class="n">plci_b_write_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci_b_write_pos</span> <span class="o">==</span> <span class="n">LI_PLCI_B_QUEUE_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">plci_b_write_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_PLCI_B_LAST_FLAG</span><span class="p">;</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_write_pos</span> <span class="o">=</span> <span class="n">plci_b_write_pos</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mixer_calculate_coefs</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_channel_bits</span> <span class="o">=</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">channel</span><span class="p">;</span>
			<span class="n">mixer_notify_update</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffffL</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span>
			      <span class="s">&quot;wwS&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">,</span> <span class="n">SELECTOR_LINE_INTERCONNECT</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_cmd</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">li_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
			<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">mixer_command</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">LI_REQ_SILENT_UPDATE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span> <span class="o">||</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span>
			    <span class="o">||</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span>
			    <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			    <span class="o">||</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">!=</span> <span class="n">plci</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong state&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
				<span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">plci_b_write_pos</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_write_pos</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span> <span class="o">&gt;</span> <span class="n">plci_b_write_pos</span><span class="p">)</span> <span class="o">?</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span> <span class="o">:</span>
			     <span class="n">LI_PLCI_B_QUEUE_ENTRIES</span> <span class="o">+</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span><span class="p">)</span> <span class="o">-</span> <span class="n">plci_b_write_pos</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: LI request overrun&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
				<span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci_b_write_pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">LI_PLCI_B_QUEUE_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">plci_b_write_pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">plci_b_write_pos</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span><span class="p">)</span>
			    <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_PLCI_B_LAST_FLAG</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_queue</span><span class="p">[</span><span class="n">plci_b_write_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">LI_PLCI_B_SKIP_FLAG</span> <span class="o">|</span> <span class="n">LI_PLCI_B_LAST_FLAG</span><span class="p">;</span>
				<span class="n">plci_b_write_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci_b_write_pos</span> <span class="o">==</span> <span class="n">LI_PLCI_B_QUEUE_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">plci_b_write_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_PLCI_B_LAST_FLAG</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_write_pos</span> <span class="o">=</span> <span class="n">plci_b_write_pos</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_channel_bits</span> <span class="o">=</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">channel</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_cmd</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">li_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
			<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">mixer_command</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>

		<span class="nl">default:</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: LI unknown request %04x&quot;</span><span class="p">,</span>
					<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">li_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)));</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="n">_FACILITY_NOT_SUPPORTED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffffL</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span>
	      <span class="s">&quot;wwS&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">,</span> <span class="n">SELECTOR_LINE_INTERCONNECT</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mixer_indication_coefs_set</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dword</span> <span class="n">d</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">result</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: mixer_indication_coefs_set&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span> <span class="o">!=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_req_pos</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">do</span>
		<span class="p">{</span>
			<span class="n">d</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_queue</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">LI_PLCI_B_SKIP_FLAG</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">appl_flags</span> <span class="o">&amp;</span> <span class="n">APPL_FLAG_OLD_LI_SPEC</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">LI_PLCI_B_DISC_FLAG</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
						<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">LI_IND_DISCONNECT</span><span class="p">);</span>
						<span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
						<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">_LI_USER_INITIATED</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
						<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">LI_IND_CONNECT_ACTIVE</span><span class="p">);</span>
						<span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
						<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">d</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LI_PLCI_B_FLAG_MASK</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">LI_PLCI_B_DISC_FLAG</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
						<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">LI_IND_DISCONNECT</span><span class="p">);</span>
						<span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
						<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">d</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LI_PLCI_B_FLAG_MASK</span><span class="p">);</span>
						<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">_LI_USER_INITIATED</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">else</span>
					<span class="p">{</span>
						<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
						<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">LI_IND_CONNECT_ACTIVE</span><span class="p">);</span>
						<span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
						<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">d</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LI_PLCI_B_FLAG_MASK</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffffL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="n">SELECTOR_LINE_INTERCONNECT</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span> <span class="o">==</span> <span class="n">LI_PLCI_B_QUEUE_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
				<span class="mi">0</span> <span class="o">:</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">LI_PLCI_B_LAST_FLAG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span> <span class="o">!=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_req_pos</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mixer_indication_xconnect_from</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">word</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xconnect_transfer_address_s</span> <span class="n">s</span><span class="p">,</span>   <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: mixer_indication_xconnect_from %d&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">length</span><span class="p">));</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">s</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">dword</span><span class="p">)(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">dword</span><span class="p">)(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]))</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">s</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">dword</span><span class="p">)(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">dword</span><span class="p">)(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]))</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">s</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">9</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">dword</span><span class="p">)(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">10</span><span class="p">]))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">dword</span><span class="p">)(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">11</span><span class="p">]))</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">12</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">13</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">&amp;</span> <span class="n">XCONNECT_CHANNEL_NUMBER_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_pri</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">j</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">j</span> <span class="o">+=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="n">XCONNECT_CHANNEL_PORT_PC</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">send_pc</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">send_b</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">card_address</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">low</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">card_address</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">card_address</span><span class="p">.</span><span class="n">high</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">channel</span> <span class="o">|=</span> <span class="n">LI_CHANNEL_ADDRESSES_SET</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
	    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">==</span> <span class="n">ADJUST_B_RESTORE_MIXER_2</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">==</span> <span class="n">ADJUST_B_RESTORE_MIXER_3</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">==</span> <span class="n">ADJUST_B_RESTORE_MIXER_4</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]))(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
			<span class="n">next_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mixer_notify_update</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mixer_indication_xconnect_to</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">word</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: mixer_indication_xconnect_to %d&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">length</span><span class="p">));</span>

<span class="p">}</span>


<span class="k">static</span> <span class="n">byte</span> <span class="nf">mixer_notify_source_removed</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">dword</span> <span class="n">plci_b_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">plci_b_write_pos</span><span class="p">;</span>

	<span class="n">plci_b_write_pos</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_write_pos</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span> <span class="o">&gt;</span> <span class="n">plci_b_write_pos</span><span class="p">)</span> <span class="o">?</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span> <span class="o">:</span>
	     <span class="n">LI_PLCI_B_QUEUE_ENTRIES</span> <span class="o">+</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_read_pos</span><span class="p">)</span> <span class="o">-</span> <span class="n">plci_b_write_pos</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: LI request overrun&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
				<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_queue</span><span class="p">[</span><span class="n">plci_b_write_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci_b_id</span> <span class="o">|</span> <span class="n">LI_PLCI_B_DISC_FLAG</span><span class="p">;</span>
	<span class="n">plci_b_write_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci_b_write_pos</span> <span class="o">==</span> <span class="n">LI_PLCI_B_QUEUE_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">plci_b_write_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_plci_b_write_pos</span> <span class="o">=</span> <span class="n">plci_b_write_pos</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mixer_remove</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">notify_plci</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">plci_b_id</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: mixer_remove&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">plci_b_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span> <span class="o">&amp;</span> <span class="n">GL_LINE_INTERCONNECT_SUPPORTED</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="n">plci</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">curchnl</span> <span class="o">|</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_INVOLVED</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_INTERCONNECT</span><span class="p">)</span>
					    <span class="o">||</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LI_FLAG_INTERCONNECT</span><span class="p">))</span>
					<span class="p">{</span>
						<span class="n">notify_plci</span> <span class="o">=</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">plci</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">notify_plci</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
						    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">notify_plci</span> <span class="o">!=</span> <span class="n">plci</span><span class="p">)</span>
						    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">notify_plci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
						    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">notify_plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">appl_flags</span> <span class="o">&amp;</span> <span class="n">APPL_FLAG_OLD_LI_SPEC</span><span class="p">)</span>
						    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">notify_plci</span><span class="o">-&gt;</span><span class="n">State</span><span class="p">)</span>
						    <span class="o">&amp;&amp;</span> <span class="n">notify_plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">notify_plci</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="n">mixer_notify_source_removed</span><span class="p">(</span><span class="n">notify_plci</span><span class="p">,</span> <span class="n">plci_b_id</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">mixer_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="n">mixer_calculate_coefs</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
				<span class="n">mixer_notify_update</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">plci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* Echo canceller facilities                                        */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ec_write_parameters</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">parameter_buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: ec_write_parameters&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="n">parameter_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">parameter_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">DSP_CTRL_SET_LEC_PARAMETERS</span><span class="p">;</span>
	<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parameter_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span><span class="p">);</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LEC_RESET_COEFFICIENTS</span><span class="p">;</span>
	<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_tail_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">128</span> <span class="o">:</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_tail_length</span><span class="p">;</span>
	<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parameter_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">w</span><span class="p">);</span>
	<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">FTY</span><span class="p">,</span> <span class="n">parameter_buffer</span><span class="p">);</span>
	<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">TEL_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ec_clear_config</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: ec_clear_config&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span> <span class="o">=</span> <span class="n">LEC_ENABLE_ECHO_CANCELLER</span> <span class="o">|</span>
		<span class="n">LEC_MANUAL_DISABLE</span> <span class="o">|</span> <span class="n">LEC_ENABLE_NONLINEAR_PROCESSING</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_tail_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ec_prepare_switch</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: ec_prepare_switch&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

<span class="p">}</span>


<span class="k">static</span> <span class="n">word</span> <span class="nf">ec_save_config</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: ec_save_config %02x %d&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span><span class="p">));</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">GOOD</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">word</span> <span class="nf">ec_restore_config</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: ec_restore_config %02x %d&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">GOOD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_EC</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_EC_1</span>:
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_req</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_EC_1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ec_write_parameters</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_EC_2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_EC_2</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK_FC</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Restore EC failed %02x&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">));</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">Info</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ec_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">internal_command</span><span class="p">,</span> <span class="n">Info</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">result</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: ec_command %02x %04x %04x %04x %d&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">,</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_cmd</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_tail_length</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">GOOD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">appl_flags</span> <span class="o">&amp;</span> <span class="n">APPL_FLAG_PRIV_EC_SPEC</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">EC_SUCCESS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_cmd</span><span class="p">);</span>
		<span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">GOOD</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_cmd</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">EC_ENABLE_OPERATION</span>:
	<span class="k">case</span> <span class="n">EC_FREEZE_COEFFICIENTS</span>:
	<span class="k">case</span> <span class="n">EC_RESUME_COEFFICIENT_UPDATE</span>:
	<span class="k">case</span> <span class="n">EC_RESET_COEFFICIENTS</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">internal_command</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="nl">default:</span>
			<span class="n">adjust_b1_resource</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">|</span>
								  <span class="n">B1_FACILITY_EC</span><span class="p">),</span> <span class="n">EC_COMMAND_1</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">EC_COMMAND_1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">adjust_b_process</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Load EC failed&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_FACILITY_NOT_SUPPORTED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EC_COMMAND_2</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_req</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">EC_COMMAND_2</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">EC_COMMAND_3</span><span class="p">;</span>
			<span class="n">ec_write_parameters</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EC_COMMAND_3</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK_FC</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Enable EC failed %02x&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">));</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_FACILITY_NOT_SUPPORTED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">EC_DISABLE_OPERATION</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">internal_command</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">EC_COMMAND_1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_EC</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_req</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">EC_COMMAND_1</span><span class="p">;</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">EC_COMMAND_2</span><span class="p">;</span>
				<span class="n">ec_write_parameters</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">Rc</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EC_COMMAND_2</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK_FC</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Disable EC failed %02x&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">));</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_FACILITY_NOT_SUPPORTED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">adjust_b1_resource</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">&amp;</span>
								  <span class="o">~</span><span class="n">B1_FACILITY_EC</span><span class="p">),</span> <span class="n">EC_COMMAND_3</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">EC_COMMAND_3</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">adjust_b_process</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Unload EC failed&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_FACILITY_NOT_SUPPORTED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffffL</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
	      <span class="s">&quot;wws&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">,</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">appl_flags</span> <span class="o">&amp;</span> <span class="n">APPL_FLAG_PRIV_EC_SPEC</span><span class="p">)</span> <span class="o">?</span>
	      <span class="n">PRIV_SELECTOR_ECHO_CANCELLER</span> <span class="o">:</span> <span class="n">SELECTOR_ECHO_CANCELLER</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">byte</span> <span class="nf">ec_request</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">APPL</span>   <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">API_PARSE</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">opt</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="n">ec_parms</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">byte</span> <span class="n">result</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: ec_request&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">GOOD</span><span class="p">;</span>
	<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_ECHO_CANCELLER</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Facility not supported&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="n">Info</span> <span class="o">=</span> <span class="n">_FACILITY_NOT_SUPPORTED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">appl_flags</span> <span class="o">&amp;</span> <span class="n">APPL_FLAG_PRIV_EC_SPEC</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">ec_parms</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong message format&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong PLCI&quot;</span><span class="p">,</span>
							<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">||</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong state&quot;</span><span class="p">,</span>
							<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_cmd</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">ec_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LEC_MANUAL_DISABLE</span> <span class="o">|</span> <span class="n">LEC_RESET_COEFFICIENTS</span><span class="p">);</span>
					<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">EC_SUCCESS</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">opt</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ec_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LEC_ENABLE_NONLINEAR_PROCESSING</span> <span class="o">|</span>
									  <span class="n">LEC_ENABLE_2100HZ_DETECTOR</span> <span class="o">|</span> <span class="n">LEC_REQUIRE_2100HZ_REVERSALS</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">EC_DISABLE_NON_LINEAR_PROCESSING</span><span class="p">))</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span> <span class="o">|=</span> <span class="n">LEC_ENABLE_NONLINEAR_PROCESSING</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">EC_DETECT_DISABLE_TONE</span><span class="p">)</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span> <span class="o">|=</span> <span class="n">LEC_ENABLE_2100HZ_DETECTOR</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">EC_DO_NOT_REQUIRE_REVERSALS</span><span class="p">))</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span> <span class="o">|=</span> <span class="n">LEC_REQUIRE_2100HZ_REVERSALS</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_tail_length</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ec_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_cmd</span><span class="p">)</span>
					<span class="p">{</span>
					<span class="k">case</span> <span class="n">EC_ENABLE_OPERATION</span>:
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LEC_FREEZE_COEFFICIENTS</span><span class="p">;</span>
						<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">ec_command</span><span class="p">);</span>
						<span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>

					<span class="k">case</span> <span class="n">EC_DISABLE_OPERATION</span>:
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span> <span class="o">=</span> <span class="n">LEC_ENABLE_ECHO_CANCELLER</span> <span class="o">|</span>
							<span class="n">LEC_MANUAL_DISABLE</span> <span class="o">|</span> <span class="n">LEC_ENABLE_NONLINEAR_PROCESSING</span> <span class="o">|</span>
							<span class="n">LEC_RESET_COEFFICIENTS</span><span class="p">;</span>
						<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">ec_command</span><span class="p">);</span>
						<span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>

					<span class="k">case</span> <span class="n">EC_FREEZE_COEFFICIENTS</span>:
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span> <span class="o">|=</span> <span class="n">LEC_FREEZE_COEFFICIENTS</span><span class="p">;</span>
						<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">ec_command</span><span class="p">);</span>
						<span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>

					<span class="k">case</span> <span class="n">EC_RESUME_COEFFICIENT_UPDATE</span>:
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LEC_FREEZE_COEFFICIENTS</span><span class="p">;</span>
						<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">ec_command</span><span class="p">);</span>
						<span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>

					<span class="k">case</span> <span class="n">EC_RESET_COEFFICIENTS</span>:
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span> <span class="o">|=</span> <span class="n">LEC_RESET_COEFFICIENTS</span><span class="p">;</span>
						<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">ec_command</span><span class="p">);</span>
						<span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>

					<span class="nl">default:</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: EC unknown request %04x&quot;</span><span class="p">,</span>
								<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_cmd</span><span class="p">));</span>
						<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">EC_UNSUPPORTED_OPERATION</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">api_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="n">ec_parms</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong message format&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_MESSAGE_FORMAT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="n">ec_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="n">EC_GET_SUPPORTED_SERVICES</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
					<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">EC_GET_SUPPORTED_SERVICES</span><span class="p">);</span>
					<span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
					<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">GOOD</span><span class="p">);</span>
					<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="mh">0x0007</span><span class="p">);</span>
					<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">LEC_MAX_SUPPORTED_TAIL_LENGTH</span><span class="p">);</span>
					<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong PLCI&quot;</span><span class="p">,</span>
							<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_IDENTIFIER</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">||</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Wrong state&quot;</span><span class="p">,</span>
							<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
					<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_cmd</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">ec_parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LEC_MANUAL_DISABLE</span> <span class="o">|</span> <span class="n">LEC_RESET_COEFFICIENTS</span><span class="p">);</span>
					<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
					<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_cmd</span><span class="p">);</span>
					<span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">GOOD</span><span class="p">);</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LEC_ENABLE_NONLINEAR_PROCESSING</span> <span class="o">|</span>
								  <span class="n">LEC_ENABLE_2100HZ_DETECTOR</span> <span class="o">|</span> <span class="n">LEC_REQUIRE_2100HZ_REVERSALS</span><span class="p">);</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_tail_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ec_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">opt</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ec_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">EC_ENABLE_NON_LINEAR_PROCESSING</span><span class="p">)</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span> <span class="o">|=</span> <span class="n">LEC_ENABLE_NONLINEAR_PROCESSING</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">EC_DETECT_DISABLE_TONE</span><span class="p">)</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span> <span class="o">|=</span> <span class="n">LEC_ENABLE_2100HZ_DETECTOR</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">EC_DO_NOT_REQUIRE_REVERSALS</span><span class="p">))</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span> <span class="o">|=</span> <span class="n">LEC_REQUIRE_2100HZ_REVERSALS</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">ec_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_tail_length</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ec_parms</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_cmd</span><span class="p">)</span>
					<span class="p">{</span>
					<span class="k">case</span> <span class="n">EC_ENABLE_OPERATION</span>:
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LEC_FREEZE_COEFFICIENTS</span><span class="p">;</span>
						<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">ec_command</span><span class="p">);</span>
						<span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>

					<span class="k">case</span> <span class="n">EC_DISABLE_OPERATION</span>:
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span> <span class="o">=</span> <span class="n">LEC_ENABLE_ECHO_CANCELLER</span> <span class="o">|</span>
							<span class="n">LEC_MANUAL_DISABLE</span> <span class="o">|</span> <span class="n">LEC_ENABLE_NONLINEAR_PROCESSING</span> <span class="o">|</span>
							<span class="n">LEC_RESET_COEFFICIENTS</span><span class="p">;</span>
						<span class="n">start_internal_command</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">ec_command</span><span class="p">);</span>
						<span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>

					<span class="nl">default:</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: EC unknown request %04x&quot;</span><span class="p">,</span>
								<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_cmd</span><span class="p">));</span>
						<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">_FACILITY_SPECIFIC_FUNCTION_NOT_SUPP</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">sendf</span><span class="p">(</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffffL</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span>
	      <span class="s">&quot;wws&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">,</span> <span class="p">(</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">appl_flags</span> <span class="o">&amp;</span> <span class="n">APPL_FLAG_PRIV_EC_SPEC</span><span class="p">)</span> <span class="o">?</span>
	      <span class="n">PRIV_SELECTOR_ECHO_CANCELLER</span> <span class="o">:</span> <span class="n">SELECTOR_ECHO_CANCELLER</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ec_indication</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">word</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">byte</span> <span class="n">result</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: ec_indication&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ec_idi_options</span> <span class="o">&amp;</span> <span class="n">LEC_MANUAL_DISABLE</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">appl_flags</span> <span class="o">&amp;</span> <span class="n">APPL_FLAG_PRIV_EC_SPEC</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="p">{</span>
			<span class="k">case</span> <span class="n">LEC_DISABLE_TYPE_CONTIGNUOUS_2100HZ</span>:
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">EC_BYPASS_DUE_TO_CONTINUOUS_2100HZ</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">LEC_DISABLE_TYPE_REVERSED_2100HZ</span>:
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">EC_BYPASS_DUE_TO_REVERSED_2100HZ</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">LEC_DISABLE_RELEASED</span>:
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">EC_BYPASS_RELEASED</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">EC_BYPASS_INDICATION</span><span class="p">);</span>
			<span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="p">{</span>
			<span class="k">case</span> <span class="n">LEC_DISABLE_TYPE_CONTIGNUOUS_2100HZ</span>:
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">EC_BYPASS_DUE_TO_CONTINUOUS_2100HZ</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">LEC_DISABLE_TYPE_REVERSED_2100HZ</span>:
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">EC_BYPASS_DUE_TO_REVERSED_2100HZ</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">LEC_DISABLE_RELEASED</span>:
				<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">EC_BYPASS_RELEASED</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffffL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">appl_flags</span> <span class="o">&amp;</span> <span class="n">APPL_FLAG_PRIV_EC_SPEC</span><span class="p">)</span> <span class="o">?</span>
		      <span class="n">PRIV_SELECTOR_ECHO_CANCELLER</span> <span class="o">:</span> <span class="n">SELECTOR_ECHO_CANCELLER</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* Advanced voice                                                   */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">adv_voice_write_coefs</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">word</span> <span class="n">write_command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">word</span> <span class="n">w</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">ch_map</span><span class="p">[</span><span class="n">MIXER_CHANNELS_BRI</span><span class="p">];</span>

	<span class="n">byte</span> <span class="n">coef_buffer</span><span class="p">[</span><span class="n">ADV_VOICE_COEF_BUFFER_SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: adv_voice_write_coefs %d&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">write_command</span><span class="p">));</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">coef_buffer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">DSP_CTRL_OLD_SET_MIXER_COEFFICIENTS</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_length</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_buffer</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ADV_VOICE_OLD_COEF_COUNT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">word</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">PUT_WORD</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_pri</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">].</span><span class="n">plci</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">plci</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">].</span><span class="n">plci</span> <span class="o">=</span> <span class="n">plci</span><span class="p">;</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: adv_voice_set_bchannel_id %d&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
					<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">].</span><span class="n">plci</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">plci</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">plci</span> <span class="o">=</span> <span class="n">plci</span><span class="p">;</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: adv_voice_set_bchannel_id %d&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
					<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_pri</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="n">plci</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">write_command</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">ADV_VOICE_WRITE_ACTIVATION</span>:
			<span class="n">j</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_IC_CHANNEL_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">k</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_IC_CHANNEL_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_MIXER</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span> <span class="o">|</span> <span class="n">LI_FLAG_MIX</span><span class="p">;</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span> <span class="o">|</span> <span class="n">LI_FLAG_MONITOR</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_SLAVE_CODEC</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span> <span class="o">|</span> <span class="n">LI_FLAG_MIX</span><span class="p">;</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span> <span class="o">|</span> <span class="n">LI_FLAG_MONITOR</span><span class="p">;</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_FLAG_CONFERENCE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mixer_calculate_coefs</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">curchnl</span> <span class="o">=</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span><span class="p">;</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">curchnl</span> <span class="o">=</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">channel</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_SLAVE_CODEC</span><span class="p">)</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">curchnl</span> <span class="o">=</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">channel</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ADV_VOICE_WRITE_DEACTIVATION</span>:
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">k</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_IC_CHANNEL_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_SLAVE_CODEC</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">k</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_IC_CHANNEL_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">mixer_calculate_coefs</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_MIXER</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ADV_VOICE_NEW_COEF_BASE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_length</span><span class="p">)</span>
				<span class="n">w</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_buffer</span> <span class="o">+</span> <span class="n">ADV_VOICE_NEW_COEF_BASE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_TX_DATA</span><span class="p">)</span>
				<span class="n">w</span> <span class="o">|=</span> <span class="n">MIXER_FEATURE_ENABLE_TX_DATA</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_RX_DATA</span><span class="p">)</span>
				<span class="n">w</span> <span class="o">|=</span> <span class="n">MIXER_FEATURE_ENABLE_RX_DATA</span><span class="p">;</span>
			<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">w</span><span class="p">;</span>
			<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">w</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ch_map</span><span class="p">);</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">ch_map</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">j</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
				<span class="n">ch_map</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">j</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mixer_write_prog_bri</span><span class="p">);</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">ch_map</span><span class="p">[</span><span class="n">mixer_write_prog_bri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">to_ch</span><span class="p">];</span>
				<span class="n">j</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">ch_map</span><span class="p">[</span><span class="n">mixer_write_prog_bri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">from_ch</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="n">LI_CHANNEL_INVOLVED</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mixer_write_prog_bri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mh">0x01</span><span class="p">);</span>
					<span class="n">w</span> <span class="o">=</span> <span class="p">((</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">^=</span> <span class="p">(</span><span class="n">w</span> <span class="o">&amp;</span> <span class="n">mixer_write_prog_bri</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">ADV_VOICE_NEW_COEF_BASE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_length</span><span class="p">)</span> <span class="o">?</span>
						<span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_buffer</span><span class="p">[</span><span class="n">ADV_VOICE_NEW_COEF_BASE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ADV_VOICE_NEW_COEF_BASE</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>

	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ADV_VOICE_NEW_COEF_BASE</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">coef_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">coef_buffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">FTY</span><span class="p">,</span> <span class="n">coef_buffer</span><span class="p">);</span>
	<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">TEL_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">adv_voice_clear_config</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>

	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>


	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: adv_voice_clear_config&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">ADV_VOICE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span> <span class="o">==</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">adv_voice_coef_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_pri</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="n">plci</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">curchnl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">LI_COEF_CH_PC_SET</span> <span class="o">|</span> <span class="n">LI_COEF_PC_CH_SET</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_IC_CHANNEL_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">curchnl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_SLAVE_CODEC</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">MIXER_IC_CHANNEL_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span><span class="p">);</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">curchnl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">li_total_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">adv_voice_prepare_switch</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: adv_voice_prepare_switch&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

<span class="p">}</span>


<span class="k">static</span> <span class="n">word</span> <span class="nf">adv_voice_save_config</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: adv_voice_save_config %02x %d&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span><span class="p">));</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">GOOD</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">word</span> <span class="nf">adv_voice_restore_config</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: adv_voice_restore_config %02x %d&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">GOOD</span><span class="p">;</span>
	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_VOICE</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">ADV_VOICE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span> <span class="o">==</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_VOICE_1</span>:
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_req</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_VOICE_1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">adv_voice_write_coefs</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ADV_VOICE_WRITE_UPDATE</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_VOICE_2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_VOICE_2</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK_FC</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Restore voice config failed %02x&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">));</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">Info</span><span class="p">);</span>
<span class="p">}</span>




<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/* B1 resource switching                                            */</span>
<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">byte</span> <span class="n">b1_facilities_table</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 0  No bchannel resources      */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 1  Codec (automatic law)      */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 2  Codec (A-law)              */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 3  Codec (y-law)              */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 4  HDLC for X.21              */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 5  HDLC                       */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 6  External Device 0          */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 7  External Device 1          */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 8  HDLC 56k                   */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 9  Transparent                */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 10 Loopback to network        */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 11 Test pattern to net        */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 12 Rate adaptation sync       */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 13 Rate adaptation async      */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 14 R-Interface                */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 15 HDLC 128k leased line      */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 16 FAX                        */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 17 Modem async                */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 18 Modem sync HDLC            */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 19 V.110 async HDLC           */</span>
	<span class="mh">0x12</span><span class="p">,</span>  <span class="cm">/* 20 Adv voice (Trans,mixer)    */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 21 Codec connected to IC      */</span>
	<span class="mh">0x0c</span><span class="p">,</span>  <span class="cm">/* 22 Trans,DTMF                 */</span>
	<span class="mh">0x1e</span><span class="p">,</span>  <span class="cm">/* 23 Trans,DTMF+mixer           */</span>
	<span class="mh">0x1f</span><span class="p">,</span>  <span class="cm">/* 24 Trans,DTMF+mixer+local     */</span>
	<span class="mh">0x13</span><span class="p">,</span>  <span class="cm">/* 25 Trans,mixer+local          */</span>
	<span class="mh">0x12</span><span class="p">,</span>  <span class="cm">/* 26 HDLC,mixer                 */</span>
	<span class="mh">0x12</span><span class="p">,</span>  <span class="cm">/* 27 HDLC 56k,mixer             */</span>
	<span class="mh">0x2c</span><span class="p">,</span>  <span class="cm">/* 28 Trans,LEC+DTMF             */</span>
	<span class="mh">0x3e</span><span class="p">,</span>  <span class="cm">/* 29 Trans,LEC+DTMF+mixer       */</span>
	<span class="mh">0x3f</span><span class="p">,</span>  <span class="cm">/* 30 Trans,LEC+DTMF+mixer+local */</span>
	<span class="mh">0x2c</span><span class="p">,</span>  <span class="cm">/* 31 RTP,LEC+DTMF               */</span>
	<span class="mh">0x3e</span><span class="p">,</span>  <span class="cm">/* 32 RTP,LEC+DTMF+mixer         */</span>
	<span class="mh">0x3f</span><span class="p">,</span>  <span class="cm">/* 33 RTP,LEC+DTMF+mixer+local   */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 34 Signaling task             */</span>
	<span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 35 PIAFS                      */</span>
	<span class="mh">0x0c</span><span class="p">,</span>  <span class="cm">/* 36 Trans,DTMF+TONE            */</span>
	<span class="mh">0x1e</span><span class="p">,</span>  <span class="cm">/* 37 Trans,DTMF+TONE+mixer      */</span>
	<span class="mh">0x1f</span>   <span class="cm">/* 38 Trans,DTMF+TONE+mixer+local*/</span>
<span class="p">};</span>


<span class="k">static</span> <span class="n">word</span> <span class="nf">get_b1_facilities</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">b1_resource</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">b1_facilities</span><span class="p">;</span>

	<span class="n">b1_facilities</span> <span class="o">=</span> <span class="n">b1_facilities_table</span><span class="p">[</span><span class="n">b1_resource</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">b1_resource</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">b1_resource</span> <span class="o">==</span> <span class="mi">20</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">b1_resource</span> <span class="o">==</span> <span class="mi">25</span><span class="p">))</span>
	<span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options_conn</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_DTMF_TONE</span><span class="p">))</span>
		      <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">requested_options_table</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_DTMF_TONE</span><span class="p">)))))</span>

		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_SOFTDTMF_SEND</span><span class="p">)</span>
				<span class="n">b1_facilities</span> <span class="o">|=</span> <span class="n">B1_FACILITY_DTMFX</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_SOFTDTMF_RECEIVE</span><span class="p">)</span>
				<span class="n">b1_facilities</span> <span class="o">|=</span> <span class="n">B1_FACILITY_DTMFR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">b1_resource</span> <span class="o">==</span> <span class="mi">17</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">b1_resource</span> <span class="o">==</span> <span class="mi">18</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MANUFACTURER_FEATURE_V18</span> <span class="o">|</span> <span class="n">MANUFACTURER_FEATURE_VOWN</span><span class="p">))</span>
			<span class="n">b1_facilities</span> <span class="o">|=</span> <span class="n">B1_FACILITY_DTMFX</span> <span class="o">|</span> <span class="n">B1_FACILITY_DTMFR</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">  dbug (1, dprintf(&quot;[%06lx] %s,%d: get_b1_facilities %d %04x&quot;,</span>
<span class="cm">  (dword)((plci-&gt;Id &lt;&lt; 8) | UnMapController(plci-&gt;adapter-&gt;Id)),</span>
<span class="cm">  (char far *)(FILE_), __LINE__, b1_resource, b1_facilites));</span>
<span class="cm">*/</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">b1_facilities</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">byte</span> <span class="nf">add_b1_facilities</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">b1_resource</span><span class="p">,</span> <span class="n">word</span> <span class="n">b1_facilities</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">byte</span> <span class="n">b</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">b1_resource</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="mi">5</span>:
	<span class="k">case</span> <span class="mi">26</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">B1_FACILITY_MIXER</span> <span class="o">|</span> <span class="n">B1_FACILITY_VOICE</span><span class="p">))</span>
			<span class="n">b</span> <span class="o">=</span> <span class="mi">26</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">b</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">8</span>:
	<span class="k">case</span> <span class="mi">27</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">B1_FACILITY_MIXER</span> <span class="o">|</span> <span class="n">B1_FACILITY_VOICE</span><span class="p">))</span>
			<span class="n">b</span> <span class="o">=</span> <span class="mi">27</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">b</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">9</span>:
	<span class="k">case</span> <span class="mi">20</span>:
	<span class="k">case</span> <span class="mi">22</span>:
	<span class="k">case</span> <span class="mi">23</span>:
	<span class="k">case</span> <span class="mi">24</span>:
	<span class="k">case</span> <span class="mi">25</span>:
	<span class="k">case</span> <span class="mi">28</span>:
	<span class="k">case</span> <span class="mi">29</span>:
	<span class="k">case</span> <span class="mi">30</span>:
	<span class="k">case</span> <span class="mi">36</span>:
	<span class="k">case</span> <span class="mi">37</span>:
	<span class="k">case</span> <span class="mi">38</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_EC</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_LOCAL</span><span class="p">)</span>
				<span class="n">b</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">B1_FACILITY_MIXER</span> <span class="o">|</span> <span class="n">B1_FACILITY_VOICE</span><span class="p">))</span>
				<span class="n">b</span> <span class="o">=</span> <span class="mi">29</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">b</span> <span class="o">=</span> <span class="mi">28</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">B1_FACILITY_DTMFX</span> <span class="o">|</span> <span class="n">B1_FACILITY_DTMFR</span> <span class="o">|</span> <span class="n">B1_FACILITY_MIXER</span><span class="p">))</span>
			 <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options_conn</span> <span class="o">|</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">requested_options</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_DTMF_TONE</span><span class="p">))</span>
			     <span class="o">||</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">requested_options_table</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">PRIVATE_DTMF_TONE</span><span class="p">)))))</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_LOCAL</span><span class="p">)</span>
				<span class="n">b</span> <span class="o">=</span> <span class="mi">38</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">B1_FACILITY_MIXER</span> <span class="o">|</span> <span class="n">B1_FACILITY_VOICE</span><span class="p">))</span>
				<span class="n">b</span> <span class="o">=</span> <span class="mi">37</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">b</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_HARDDTMF</span><span class="p">)</span>
			  <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_SOFTDTMF_RECEIVE</span><span class="p">))</span>
			 <span class="o">||</span> <span class="p">((</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_DTMFR</span><span class="p">)</span>
			     <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_MIXER</span><span class="p">)</span>
				 <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_SOFTDTMF_RECEIVE</span><span class="p">)))</span>
			 <span class="o">||</span> <span class="p">((</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_DTMFX</span><span class="p">)</span>
			     <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_MIXER</span><span class="p">)</span>
				 <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_SOFTDTMF_SEND</span><span class="p">))))</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_LOCAL</span><span class="p">)</span>
				<span class="n">b</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">B1_FACILITY_MIXER</span> <span class="o">|</span> <span class="n">B1_FACILITY_VOICE</span><span class="p">))</span>
				<span class="n">b</span> <span class="o">=</span> <span class="mi">23</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">b</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_LOCAL</span><span class="p">)</span>
				<span class="n">b</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">B1_FACILITY_MIXER</span> <span class="o">|</span> <span class="n">B1_FACILITY_VOICE</span><span class="p">))</span>
				<span class="n">b</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">b</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">31</span>:
	<span class="k">case</span> <span class="mi">32</span>:
	<span class="k">case</span> <span class="mi">33</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_LOCAL</span><span class="p">)</span>
			<span class="n">b</span> <span class="o">=</span> <span class="mi">33</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b1_facilities</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">B1_FACILITY_MIXER</span> <span class="o">|</span> <span class="n">B1_FACILITY_VOICE</span><span class="p">))</span>
			<span class="n">b</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">b</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">b1_resource</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: add_b1_facilities %d %04x %d %04x&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">b1_resource</span><span class="p">,</span> <span class="n">b1_facilities</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">get_b1_facilities</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">b</span><span class="p">)));</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">adjust_b1_facilities</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">new_b1_resource</span><span class="p">,</span> <span class="n">word</span> <span class="n">new_b1_facilities</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">removed_facilities</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: adjust_b1_facilities %d %04x %04x&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">new_b1_resource</span><span class="p">,</span> <span class="n">new_b1_facilities</span><span class="p">,</span>
			<span class="n">new_b1_facilities</span> <span class="o">&amp;</span> <span class="n">get_b1_facilities</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">new_b1_resource</span><span class="p">)));</span>

	<span class="n">new_b1_facilities</span> <span class="o">&amp;=</span> <span class="n">get_b1_facilities</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">new_b1_resource</span><span class="p">);</span>
	<span class="n">removed_facilities</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">new_b1_facilities</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">removed_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_EC</span><span class="p">)</span>
		<span class="n">ec_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">removed_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_DTMFR</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dtmf_rec_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
		<span class="n">dtmf_parameter_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">removed_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_DTMFX</span><span class="p">)</span>
		<span class="n">dtmf_send_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">removed_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_MIXER</span><span class="p">)</span>
		<span class="n">mixer_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">removed_facilities</span> <span class="o">&amp;</span> <span class="n">B1_FACILITY_VOICE</span><span class="p">)</span>
		<span class="n">adv_voice_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">=</span> <span class="n">new_b1_facilities</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">adjust_b_clear</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: adjust_b_clear&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_restore</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">word</span> <span class="nf">adjust_b_process</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">b1_resource</span><span class="p">;</span>
	<span class="n">NCCI</span> <span class="o">*</span><span class="n">ncci_ptr</span><span class="p">;</span>
	<span class="n">API_PARSE</span> <span class="n">bp</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: adjust_b_process %02x %d&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">GOOD</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">ADJUST_B_START</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_parms_msg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_SWITCH_L1</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ADJUST_B_MODE_SAVE</span> <span class="o">|</span> <span class="n">ADJUST_B_MODE_SWITCH_L1</span> <span class="o">|</span>
						 <span class="n">ADJUST_B_MODE_NO_RESOURCE</span> <span class="o">|</span> <span class="n">ADJUST_B_MODE_RESTORE</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">b1_resource</span> <span class="o">=</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">==</span> <span class="n">ADJUST_B_MODE_NO_RESOURCE</span><span class="p">)</span> <span class="o">?</span>
				<span class="mi">0</span> <span class="o">:</span> <span class="n">add_b1_facilities</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_facilities</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b1_resource</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">adjust_b1_facilities</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">b1_resource</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_facilities</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_facilities</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">get_b1_facilities</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">b1_resource</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Adjust B nonsupported facilities %d %d %04x&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">,</span> <span class="n">b1_resource</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_facilities</span><span class="p">));</span>
				<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_SAVE</span><span class="p">)</span>
		<span class="p">{</span>

			<span class="n">mixer_prepare_switch</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>


			<span class="n">dtmf_prepare_switch</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
			<span class="n">dtmf_parameter_prepare_switch</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>


			<span class="n">ec_prepare_switch</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>

			<span class="n">adv_voice_prepare_switch</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_SAVE_MIXER_1</span><span class="p">;</span>
		<span class="n">Rc</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADJUST_B_SAVE_MIXER_1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_SAVE</span><span class="p">)</span>
		<span class="p">{</span>

			<span class="n">Info</span> <span class="o">=</span> <span class="n">mixer_save_config</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">Info</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_SAVE_DTMF_1</span><span class="p">;</span>
		<span class="n">Rc</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADJUST_B_SAVE_DTMF_1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_SAVE</span><span class="p">)</span>
		<span class="p">{</span>

			<span class="n">Info</span> <span class="o">=</span> <span class="n">dtmf_save_config</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">Info</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_REMOVE_L23_1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADJUST_B_REMOVE_L23_1</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_REMOVE_L23</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_ncci</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">ncci_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ncci</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_ncci</span><span class="p">]);</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_pending</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">plci</span><span class="o">-&gt;</span><span class="n">data_sent_ptr</span> <span class="o">=</span> <span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">DBuffer</span><span class="p">[</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_out</span><span class="p">].</span><span class="n">P</span><span class="p">;</span>
					<span class="n">data_rc</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_ncci</span><span class="p">]);</span>
				<span class="p">}</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">ncci_ptr</span><span class="o">-&gt;</span><span class="n">data_ack_pending</span><span class="p">)</span>
					<span class="n">data_ack</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ncci_ch</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_ncci</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">REMOVE</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">byte</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_CONNECT</span><span class="p">)</span> <span class="o">?</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_ncci</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
			<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_REMOVE_L23_2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_REMOVE_L23_2</span><span class="p">;</span>
		<span class="n">Rc</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADJUST_B_REMOVE_L23_2</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK_FC</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Adjust B remove failed %02x&quot;</span><span class="p">,</span>
					<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">));</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_REMOVE_L23</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci_nl_busy</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_SAVE_EC_1</span><span class="p">;</span>
		<span class="n">Rc</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADJUST_B_SAVE_EC_1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_SAVE</span><span class="p">)</span>
		<span class="p">{</span>

			<span class="n">Info</span> <span class="o">=</span> <span class="n">ec_save_config</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">Info</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_SAVE_DTMF_PARAMETER_1</span><span class="p">;</span>
		<span class="n">Rc</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADJUST_B_SAVE_DTMF_PARAMETER_1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_SAVE</span><span class="p">)</span>
		<span class="p">{</span>

			<span class="n">Info</span> <span class="o">=</span> <span class="n">dtmf_parameter_save_config</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">Info</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_SAVE_VOICE_1</span><span class="p">;</span>
		<span class="n">Rc</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADJUST_B_SAVE_VOICE_1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_SAVE</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="n">adv_voice_save_config</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">Info</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_SWITCH_L1_1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADJUST_B_SWITCH_L1_1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_SWITCH_L1</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">sig_req</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_parms_msg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">api_load_msg</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_parms_msg</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">api_load_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B_protocol</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="n">add_b1</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">word</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_NO_RESOURCE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
				      <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_facilities</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Info</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Adjust B invalid L1 parameters %d %04x&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_facilities</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span><span class="p">;</span>
			<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">RESOURCES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_SWITCH_L1_2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_SWITCH_L1_2</span><span class="p">;</span>
		<span class="n">Rc</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADJUST_B_SWITCH_L1_2</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK_FC</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Adjust B switch failed %02x %d %04x&quot;</span><span class="p">,</span>
					<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span>
					<span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_facilities</span><span class="p">));</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_VOICE_1</span><span class="p">;</span>
		<span class="n">Rc</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_VOICE_1</span>:
	<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_VOICE_2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_RESTORE</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="n">adv_voice_restore_config</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">Info</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_DTMF_PARAMETER_1</span><span class="p">;</span>
		<span class="n">Rc</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_DTMF_PARAMETER_1</span>:
	<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_DTMF_PARAMETER_2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_RESTORE</span><span class="p">)</span>
		<span class="p">{</span>

			<span class="n">Info</span> <span class="o">=</span> <span class="n">dtmf_parameter_restore_config</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">Info</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_EC_1</span><span class="p">;</span>
		<span class="n">Rc</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_EC_1</span>:
	<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_EC_2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_RESTORE</span><span class="p">)</span>
		<span class="p">{</span>

			<span class="n">Info</span> <span class="o">=</span> <span class="n">ec_restore_config</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">Info</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_ASSIGN_L23_1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADJUST_B_ASSIGN_L23_1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_ASSIGN_L23</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci_nl_busy</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_CONNECT</span><span class="p">)</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">call_dir</span> <span class="o">|=</span> <span class="n">CALL_DIR_FORCE_OUTG_NL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_parms_msg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">api_load_msg</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_parms_msg</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">api_load_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B_protocol</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="n">add_b23</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Info</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Adjust B invalid L23 parameters %04x&quot;</span><span class="p">,</span>
						<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Info</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span><span class="p">;</span>
			<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_ASSIGN_L23_2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_ASSIGN_L23_2</span><span class="p">;</span>
		<span class="n">Rc</span> <span class="o">=</span> <span class="n">ASSIGN_OK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADJUST_B_ASSIGN_L23_2</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK_FC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">ASSIGN_OK</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Adjust B assign failed %02x&quot;</span><span class="p">,</span>
					<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">));</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_ASSIGN_L23</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">ASSIGN_OK</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_USER_CONNECT</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_restore</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_CONNECT_1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADJUST_B_CONNECT_1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_CONNECT</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci_nl_busy</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">N_CONNECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_CONNECT_2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_DTMF_1</span><span class="p">;</span>
		<span class="n">Rc</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADJUST_B_CONNECT_2</span>:
	<span class="k">case</span> <span class="n">ADJUST_B_CONNECT_3</span>:
	<span class="k">case</span> <span class="n">ADJUST_B_CONNECT_4</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK_FC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Adjust B connect failed %02x&quot;</span><span class="p">,</span>
					<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">));</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">==</span> <span class="n">OK</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_CONNECT</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">get_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">Id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">),</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_ncci</span><span class="p">);</span>
				<span class="n">Id</span> <span class="o">=</span> <span class="p">(</span><span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">dword</span><span class="p">)(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_ncci</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">==</span> <span class="n">ADJUST_B_CONNECT_2</span><span class="p">)</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_CONNECT_3</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">==</span> <span class="n">ADJUST_B_CONNECT_4</span><span class="p">)</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_DTMF_1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">==</span> <span class="n">ADJUST_B_CONNECT_2</span><span class="p">)</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_CONNECT_4</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">==</span> <span class="n">ADJUST_B_CONNECT_3</span><span class="p">)</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_DTMF_1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">!=</span> <span class="n">ADJUST_B_RESTORE_DTMF_1</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">Rc</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_DTMF_1</span>:
	<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_DTMF_2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_RESTORE</span><span class="p">)</span>
		<span class="p">{</span>

			<span class="n">Info</span> <span class="o">=</span> <span class="n">dtmf_restore_config</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">Info</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_MIXER_1</span><span class="p">;</span>
		<span class="n">Rc</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_MIXER_1</span>:
	<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_MIXER_2</span>:
	<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_MIXER_3</span>:
	<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_MIXER_4</span>:
	<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_MIXER_5</span>:
	<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_MIXER_6</span>:
	<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_MIXER_7</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">&amp;</span> <span class="n">ADJUST_B_MODE_RESTORE</span><span class="p">)</span>
		<span class="p">{</span>

			<span class="n">Info</span> <span class="o">=</span> <span class="n">mixer_restore_config</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">Info</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_END</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADJUST_B_END</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">Info</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">adjust_b1_resource</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">API_SAVE</span>   <span class="o">*</span><span class="n">bp_msg</span><span class="p">,</span> <span class="n">word</span> <span class="n">b1_facilities</span><span class="p">,</span> <span class="n">word</span> <span class="n">internal_command</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: adjust_b1_resource %d %04x&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">,</span> <span class="n">b1_facilities</span><span class="p">));</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_parms_msg</span> <span class="o">=</span> <span class="n">bp_msg</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_facilities</span> <span class="o">=</span> <span class="n">b1_facilities</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span> <span class="o">=</span> <span class="n">internal_command</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_ncci</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">Id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bp_msg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">=</span> <span class="n">ADJUST_B_MODE_SAVE</span> <span class="o">|</span> <span class="n">ADJUST_B_MODE_NO_RESOURCE</span> <span class="o">|</span> <span class="n">ADJUST_B_MODE_SWITCH_L1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">=</span> <span class="n">ADJUST_B_MODE_SAVE</span> <span class="o">|</span> <span class="n">ADJUST_B_MODE_SWITCH_L1</span> <span class="o">|</span> <span class="n">ADJUST_B_MODE_RESTORE</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_START</span><span class="p">;</span>
	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Adjust B1 resource %d %04x...&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span><span class="p">,</span> <span class="n">b1_facilities</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">adjust_b_restore</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">internal_command</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: adjust_b_restore %02x %04x&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">));</span>

	<span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">internal_command</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">req_in</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">Rc</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_1</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK_FC</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Adjust B enqueued failed %02x&quot;</span><span class="p">,</span>
					<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_parms_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_facilities</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span> <span class="o">=</span> <span class="n">ADJUST_B_RESTORE_2</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_ncci</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">Id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">=</span> <span class="n">ADJUST_B_MODE_RESTORE</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_START</span><span class="p">;</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Adjust B restore...&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">ADJUST_B_RESTORE_2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">adjust_b_process</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Adjust B restore failed&quot;</span><span class="p">,</span>
					<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_b3_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">internal_command</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: reset_b3_command %02x %04x&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">GOOD</span><span class="p">;</span>
	<span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">internal_command</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_parms_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_facilities</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span> <span class="o">=</span> <span class="n">RESET_B3_COMMAND_1</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_ncci</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">Id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">=</span> <span class="n">ADJUST_B_MODE_REMOVE_L23</span> <span class="o">|</span> <span class="n">ADJUST_B_MODE_ASSIGN_L23</span> <span class="o">|</span> <span class="n">ADJUST_B_MODE_CONNECT</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_START</span><span class="p">;</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Reset B3...&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">RESET_B3_COMMAND_1</span>:
		<span class="n">Info</span> <span class="o">=</span> <span class="n">adjust_b_process</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Info</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Reset failed&quot;</span><span class="p">,</span>
					<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cm">/*  sendf (plci-&gt;appl, _RESET_B3_R | CONFIRM, Id, plci-&gt;number, &quot;w&quot;, Info);*/</span>
	<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_RESET_B3_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">select_b_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">internal_command</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">esc_chi</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: select_b_command %02x %04x&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">GOOD</span><span class="p">;</span>
	<span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">internal_command</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_parms_msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">saved_msg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">ADV_VOICE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">plci</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">AdvSignalPLCI</span><span class="p">))</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_facilities</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">|</span> <span class="n">B1_FACILITY_VOICE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_facilities</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B1_FACILITY_VOICE</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span> <span class="o">=</span> <span class="n">SELECT_B_COMMAND_1</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_ncci</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">Id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">saved_msg</span><span class="p">.</span><span class="n">parms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">=</span> <span class="n">ADJUST_B_MODE_SAVE</span> <span class="o">|</span> <span class="n">ADJUST_B_MODE_REMOVE_L23</span> <span class="o">|</span> <span class="n">ADJUST_B_MODE_SWITCH_L1</span> <span class="o">|</span>
				<span class="n">ADJUST_B_MODE_NO_RESOURCE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">=</span> <span class="n">ADJUST_B_MODE_SAVE</span> <span class="o">|</span> <span class="n">ADJUST_B_MODE_REMOVE_L23</span> <span class="o">|</span> <span class="n">ADJUST_B_MODE_SWITCH_L1</span> <span class="o">|</span>
				<span class="n">ADJUST_B_MODE_ASSIGN_L23</span> <span class="o">|</span> <span class="n">ADJUST_B_MODE_USER_CONNECT</span> <span class="o">|</span> <span class="n">ADJUST_B_MODE_RESTORE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_START</span><span class="p">;</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Select B protocol...&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">SELECT_B_COMMAND_1</span>:
		<span class="n">Info</span> <span class="o">=</span> <span class="n">adjust_b_process</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Info</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: Select B protocol failed&quot;</span><span class="p">,</span>
					<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">tel</span> <span class="o">==</span> <span class="n">ADV_VOICE</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">esc_chi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="n">esc_chi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>
			<span class="n">esc_chi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">b_channel</span><span class="p">;</span>
			<span class="n">SetVoiceChannel</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">AdvCodecPLCI</span><span class="p">,</span> <span class="n">esc_chi</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_SELECT_B_REQ</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">fax_connect_ack_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">internal_command</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: fax_connect_ack_command %02x %04x&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">));</span>

	<span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">internal_command</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FAX_CONNECT_ACK_COMMAND_1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci_nl_busy</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">FAX_CONNECT_ACK_COMMAND_1</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">FAX_CONNECT_ACK_COMMAND_2</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_length</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">ReqCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">N_CONNECT_ACK</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FAX_CONNECT_ACK_COMMAND_2</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK_FC</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: FAX issue CONNECT ACK failed %02x&quot;</span><span class="p">,</span>
					<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">&amp;</span> <span class="n">NCPI_VALID_CONNECT_B3_ACT</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">&amp;</span> <span class="n">NCPI_CONNECT_B3_ACT_SENT</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">B3_prot</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_ACTIVE_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_ACTIVE_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;S&quot;</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_buffer</span><span class="p">);</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">ncpi_state</span> <span class="o">|=</span> <span class="n">NCPI_CONNECT_B3_ACT_SENT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">fax_edata_ack_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">internal_command</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: fax_edata_ack_command %02x %04x&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">));</span>

	<span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">internal_command</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FAX_EDATA_ACK_COMMAND_1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci_nl_busy</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">FAX_EDATA_ACK_COMMAND_1</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">FAX_EDATA_ACK_COMMAND_2</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_edata_ack_length</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">ReqCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">N_EDATA</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FAX_EDATA_ACK_COMMAND_2</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK_FC</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: FAX issue EDATA ACK failed %02x&quot;</span><span class="p">,</span>
					<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">fax_connect_info_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">internal_command</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: fax_connect_info_command %02x %04x&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">GOOD</span><span class="p">;</span>
	<span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">internal_command</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FAX_CONNECT_INFO_COMMAND_1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci_nl_busy</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">FAX_CONNECT_INFO_COMMAND_1</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">FAX_CONNECT_INFO_COMMAND_2</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_buffer</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">fax_connect_info_length</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">ReqCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">N_EDATA</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FAX_CONNECT_INFO_COMMAND_2</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK_FC</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: FAX setting connect info failed %02x&quot;</span><span class="p">,</span>
					<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">));</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci_nl_busy</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">FAX_CONNECT_INFO_COMMAND_2</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">_CONNECT_B3_R</span><span class="p">;</span>
		<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">N_CONNECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">fax_adjust_b23_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">internal_command</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: fax_adjust_b23_command %02x %04x&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">GOOD</span><span class="p">;</span>
	<span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">internal_command</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_parms_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_facilities</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span> <span class="o">=</span> <span class="n">FAX_ADJUST_B23_COMMAND_1</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_ncci</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">Id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">=</span> <span class="n">ADJUST_B_MODE_REMOVE_L23</span> <span class="o">|</span> <span class="n">ADJUST_B_MODE_ASSIGN_L23</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_START</span><span class="p">;</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: FAX adjust B23...&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">FAX_ADJUST_B23_COMMAND_1</span>:
		<span class="n">Info</span> <span class="o">=</span> <span class="n">adjust_b_process</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Info</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: FAX adjust failed&quot;</span><span class="p">,</span>
					<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FAX_ADJUST_B23_COMMAND_2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci_nl_busy</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">FAX_ADJUST_B23_COMMAND_2</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">_CONNECT_B3_R</span><span class="p">;</span>
		<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">N_CONNECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">fax_disconnect_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">internal_command</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: fax_disconnect_command %02x %04x&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">));</span>

	<span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">internal_command</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">FAX_DISCONNECT_COMMAND_1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FAX_DISCONNECT_COMMAND_1</span>:
	<span class="k">case</span> <span class="n">FAX_DISCONNECT_COMMAND_2</span>:
	<span class="k">case</span> <span class="n">FAX_DISCONNECT_COMMAND_3</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK_FC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: FAX disconnect EDATA failed %02x&quot;</span><span class="p">,</span>
					<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">==</span> <span class="n">OK</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">internal_command</span> <span class="o">==</span> <span class="n">FAX_DISCONNECT_COMMAND_1</span><span class="p">)</span>
			    <span class="o">||</span> <span class="p">(</span><span class="n">internal_command</span> <span class="o">==</span> <span class="n">FAX_DISCONNECT_COMMAND_2</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">FAX_DISCONNECT_COMMAND_2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">internal_command</span> <span class="o">==</span> <span class="n">FAX_DISCONNECT_COMMAND_1</span><span class="p">)</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">FAX_DISCONNECT_COMMAND_3</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtp_connect_b3_req_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">internal_command</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: rtp_connect_b3_req_command %02x %04x&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">GOOD</span><span class="p">;</span>
	<span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">internal_command</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTP_CONNECT_B3_REQ_COMMAND_1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci_nl_busy</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">RTP_CONNECT_B3_REQ_COMMAND_1</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">RTP_CONNECT_B3_REQ_COMMAND_2</span><span class="p">;</span>
		<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">N_CONNECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTP_CONNECT_B3_REQ_COMMAND_2</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK_FC</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: RTP setting connect info failed %02x&quot;</span><span class="p">,</span>
					<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">));</span>
			<span class="n">Info</span> <span class="o">=</span> <span class="n">_WRONG_STATE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci_nl_busy</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">RTP_CONNECT_B3_REQ_COMMAND_2</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">RTP_CONNECT_B3_REQ_COMMAND_3</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">ReqCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">N_UDATA</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTP_CONNECT_B3_REQ_COMMAND_3</span>:
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_R</span> <span class="o">|</span> <span class="n">CONFIRM</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">Info</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtp_connect_b3_res_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">internal_command</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: rtp_connect_b3_res_command %02x %04x&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">));</span>

	<span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">internal_command</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTP_CONNECT_B3_RES_COMMAND_1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">plci_nl_busy</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">RTP_CONNECT_B3_RES_COMMAND_1</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">RTP_CONNECT_B3_RES_COMMAND_2</span><span class="p">;</span>
		<span class="n">nl_req_ncci</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">N_CONNECT_ACK</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">Id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTP_CONNECT_B3_RES_COMMAND_2</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Rc</span> <span class="o">!=</span> <span class="n">OK_FC</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: RTP setting connect resp info failed %02x&quot;</span><span class="p">,</span>
					<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci_nl_busy</span><span class="p">(</span><span class="n">plci</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">RTP_CONNECT_B3_RES_COMMAND_2</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_CONNECT_B3_ACTIVE_I</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">RTP_CONNECT_B3_RES_COMMAND_3</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_req_buffer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">ReqCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">N_UDATA</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTP_CONNECT_B3_RES_COMMAND_3</span>:
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">void</span> <span class="nf">hold_save_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">byte</span> <span class="n">SS_Ind</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x05\x02\x00\x02\x00\x00</span><span class="s">&quot;</span><span class="p">;</span> <span class="cm">/* Hold_Ind struct*/</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">internal_command</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: hold_save_command %02x %04x&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">GOOD</span><span class="p">;</span>
	<span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">internal_command</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_parms_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_facilities</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span> <span class="o">=</span> <span class="n">HOLD_SAVE_COMMAND_1</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_ncci</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">Id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">=</span> <span class="n">ADJUST_B_MODE_SAVE</span> <span class="o">|</span> <span class="n">ADJUST_B_MODE_REMOVE_L23</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_START</span><span class="p">;</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: HOLD save...&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">HOLD_SAVE_COMMAND_1</span>:
		<span class="n">Info</span> <span class="o">=</span> <span class="n">adjust_b_process</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Info</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: HOLD save failed&quot;</span><span class="p">,</span>
					<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffffL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SS_Ind</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">retrieve_restore_command</span><span class="p">(</span><span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">byte</span> <span class="n">SS_Ind</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x05\x03\x00\x02\x00\x00</span><span class="s">&quot;</span><span class="p">;</span> <span class="cm">/* Retrieve_Ind struct*/</span>
	<span class="n">word</span> <span class="n">Info</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">internal_command</span><span class="p">;</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: retrieve_restore_command %02x %04x&quot;</span><span class="p">,</span>
			<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">Rc</span><span class="p">,</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">));</span>

	<span class="n">Info</span> <span class="o">=</span> <span class="n">GOOD</span><span class="p">;</span>
	<span class="n">internal_command</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">internal_command</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_parms_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_facilities</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_command</span> <span class="o">=</span> <span class="n">RETRIEVE_RESTORE_COMMAND_1</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_ncci</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">Id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_mode</span> <span class="o">=</span> <span class="n">ADJUST_B_MODE_ASSIGN_L23</span> <span class="o">|</span> <span class="n">ADJUST_B_MODE_USER_CONNECT</span> <span class="o">|</span> <span class="n">ADJUST_B_MODE_RESTORE</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adjust_b_state</span> <span class="o">=</span> <span class="n">ADJUST_B_START</span><span class="p">;</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: RETRIEVE restore...&quot;</span><span class="p">,</span>
				<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">RETRIEVE_RESTORE_COMMAND_1</span>:
		<span class="n">Info</span> <span class="o">=</span> <span class="n">adjust_b_process</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">Rc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Info</span> <span class="o">!=</span> <span class="n">GOOD</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: RETRIEVE restore failed&quot;</span><span class="p">,</span>
					<span class="n">UnMapId</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sendf</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">,</span> <span class="n">_FACILITY_I</span><span class="p">,</span> <span class="n">Id</span> <span class="o">&amp;</span> <span class="mh">0xffffL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ws&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SS_Ind</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_b1_config</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: init_b1_config&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mixer_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>


	<span class="n">ec_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>


	<span class="n">dtmf_rec_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
	<span class="n">dtmf_send_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
	<span class="n">dtmf_parameter_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>

	<span class="n">adv_voice_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
	<span class="n">adjust_b_clear</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_b1_config</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;[%06lx] %s,%d: clear_b1_config&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dword</span><span class="p">)((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">FILE_</span><span class="p">),</span> <span class="n">__LINE__</span><span class="p">));</span>

	<span class="n">adv_voice_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
	<span class="n">adjust_b_clear</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>

	<span class="n">ec_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>


	<span class="n">dtmf_rec_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
	<span class="n">dtmf_send_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
	<span class="n">dtmf_parameter_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">((</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">==</span> <span class="n">plci</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">mixer_clear_config</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
		<span class="n">li_config_table</span><span class="p">[</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)].</span><span class="n">plci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">plci</span><span class="o">-&gt;</span><span class="n">li_bchannel_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_resource</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">B1_facilities</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* -----------------------------------------------------------------</span>
<span class="cm">   XON protocol local helpers</span>
<span class="cm">   ----------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">channel_flow_control_remove</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NL_CHANNEL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_plci</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_plci</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">channel_x_on</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">N_XON_SENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">N_XON_SENT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">channel_x_off</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">ch</span><span class="p">,</span> <span class="n">byte</span> <span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">N_RX_FLOW_CONTROL_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">N_CH_XOFF</span> <span class="o">|</span> <span class="n">flag</span><span class="p">);</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_plci</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control_pending</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">channel_request_xon</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">N_CH_XOFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">|=</span> <span class="n">N_XON_REQ</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">N_CH_XOFF</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">N_XON_CONNECT_IND</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">channel_xmit_extended_xon</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_ch</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">one_requested</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">plci</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_ch</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">N_CH_XOFF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">N_XON_CONNECT_IND</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">==</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_plci</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">channel_request_xon</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">i</span><span class="p">);</span>
			<span class="n">one_requested</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">one_requested</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channel_xmit_xon</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Try to xmit next X_ON</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_channel_with_pending_x_on</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">max_ch</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">&amp;</span> <span class="n">MANUFACTURER_FEATURE_XONOFF_FLOW_CONTROL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">last_flow_control_ch</span> <span class="o">&gt;=</span> <span class="n">max_ch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">last_flow_control_ch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">last_flow_control_ch</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_ch</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">N_XON_REQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">==</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_plci</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">last_flow_control_ch</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">last_flow_control_ch</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">N_XON_REQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">==</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_plci</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">last_flow_control_ch</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">channel_xmit_xon</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">||</span> <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Id</span> <span class="o">||</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_remove_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">find_channel_with_pending_x_on</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">plci</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">N_XON_REQ</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_flow_control</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">|=</span> <span class="n">N_XON_SENT</span><span class="p">;</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">nl_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">N_XON</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">ReqCh</span>         <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">X</span>             <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">.</span><span class="n">XNum</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span>       <span class="o">=</span> <span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">RBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">NData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">NL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">channel_can_xon</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">byte</span> <span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">APPL</span> <span class="o">*</span><span class="n">APPLptr</span><span class="p">;</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">NCCIcode</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">Num</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">APPLptr</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span><span class="p">;</span>
	<span class="n">a</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">APPLptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">NCCIcode</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ch_ncci</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">|</span> <span class="p">(((</span><span class="n">word</span><span class="p">)</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* count all buffers within the Application pool    */</span>
	<span class="cm">/* belonging to the same NCCI. XON if a first is    */</span>
	<span class="cm">/* used.                                            */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">Num</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">APPLptr</span><span class="o">-&gt;</span><span class="n">MaxBuffer</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">NCCIcode</span> <span class="o">==</span> <span class="n">APPLptr</span><span class="o">-&gt;</span><span class="n">DataNCCI</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">APPLptr</span><span class="o">-&gt;</span><span class="n">DataNCCI</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">Num</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="n">Num</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">Num</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">word</span> <span class="nf">CPN_filter_ok</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">cpn</span><span class="p">,</span> <span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">word</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/**********************************************************************************/</span>
<span class="cm">/* function groups the listening applications according to the CIP mask and the   */</span>
<span class="cm">/* Info_Mask. Each group gets just one Connect_Ind. Some application manufacturer */</span>
<span class="cm">/* are not multi-instance capable, so they start e.g. 30 applications what causes */</span>
<span class="cm">/* big problems on application level (one call, 30 Connect_Ind, ect). The         */</span>
<span class="cm">/* function must be enabled by setting &quot;a-&gt;group_optimization_enabled&quot; from the   */</span>
<span class="cm">/* OS specific part (per adapter).                                                */</span>
<span class="cm">/**********************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">group_optimization</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">busy</span><span class="p">,</span> <span class="n">group_found</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">info_mask_group</span><span class="p">[</span><span class="n">MAX_CIP_TYPES</span><span class="p">];</span>
	<span class="n">dword</span> <span class="n">cip_mask_group</span><span class="p">[</span><span class="n">MAX_CIP_TYPES</span><span class="p">];</span>
	<span class="n">word</span> <span class="n">appl_number_group_type</span><span class="p">[</span><span class="n">MAX_APPL</span><span class="p">];</span>
	<span class="n">PLCI</span> <span class="o">*</span><span class="n">auxplci</span><span class="p">;</span>

	<span class="n">set_group_ind_mask</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span> <span class="cm">/* all APPLs within this inc. call are allowed to dial in */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">group_optimization_enabled</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;No group optimization&quot;</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Group optimization = 0x%x...&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">group_optimization_enabled</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CIP_TYPES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">info_mask_group</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cip_mask_group</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_APPL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">appl_number_group_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_appl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="cm">/* check if any multi instance capable application is present */</span>
	<span class="p">{</span>  <span class="cm">/* group_optimization set to 1 means not to optimize multi-instance capable applications (default) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Id</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">MaxNCCI</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">CIP_Mask</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">group_optimization_enabled</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Multi-Instance capable, no optimization required&quot;</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span> <span class="cm">/* allow good application unfiltered access */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_appl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="cm">/* Build CIP Groups */</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Id</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">CIP_Mask</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">max_plci</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">Id</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">auxplci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">auxplci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="cm">/* application has a busy PLCI */</span>
					<span class="p">{</span>
						<span class="n">busy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Appl 0x%x is busy&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
					<span class="p">}</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_c_ind_mask_bit</span><span class="p">(</span><span class="n">auxplci</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="cm">/* application has an incoming call pending */</span>
					<span class="p">{</span>
						<span class="n">busy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Appl 0x%x has inc. call pending&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">group_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">MAX_CIP_TYPES</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">busy</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">group_found</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>     <span class="cm">/* build groups with free applications only */</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">MAX_CIP_TYPES</span><span class="p">)</span>       <span class="cm">/* all groups are in use but group still not found */</span>
				<span class="p">{</span>                           <span class="cm">/* the MAX_CIP_TYPES group enables all calls because of field overflow */</span>
					<span class="n">appl_number_group_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAX_CIP_TYPES</span><span class="p">;</span>
					<span class="n">group_found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Field overflow appl 0x%x&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">info_mask_group</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">CIP_Mask</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cip_mask_group</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">Info_Mask</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
				<span class="p">{</span>                                      <span class="cm">/* is group already present ?                  */</span>
					<span class="n">appl_number_group_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>  <span class="cm">/* store the group number for each application */</span>
					<span class="n">group_found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Group 0x%x found with appl 0x%x, CIP=0x%lx&quot;</span><span class="p">,</span> <span class="n">appl_number_group_type</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">info_mask_group</span><span class="p">[</span><span class="n">j</span><span class="p">]));</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info_mask_group</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
				<span class="p">{</span>                                      <span class="cm">/* establish a new group                       */</span>
					<span class="n">appl_number_group_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>  <span class="cm">/* store the group number for each application */</span>
					<span class="n">info_mask_group</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">CIP_Mask</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="cm">/* store the new CIP mask for the new group    */</span>
					<span class="n">cip_mask_group</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">Info_Mask</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="cm">/* store the new Info_Mask for this new group  */</span>
					<span class="n">group_found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;New Group 0x%x established with appl 0x%x, CIP=0x%lx&quot;</span><span class="p">,</span> <span class="n">appl_number_group_type</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">info_mask_group</span><span class="p">[</span><span class="n">j</span><span class="p">]));</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_appl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="cm">/* Build group_optimization_mask_table */</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">appl_number_group_type</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="cm">/* application is free, has listens and is member of a group */</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">appl_number_group_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">MAX_CIP_TYPES</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;OverflowGroup 0x%x, valid appl = 0x%x, call enabled&quot;</span><span class="p">,</span> <span class="n">appl_number_group_type</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Group 0x%x, valid appl = 0x%x&quot;</span><span class="p">,</span> <span class="n">appl_number_group_type</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">max_appl</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>   <span class="cm">/* search other group members and mark them as busy        */</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">appl_number_group_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">appl_number_group_type</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
					<span class="p">{</span>
						<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Appl 0x%x is member of group 0x%x, no call&quot;</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">appl_number_group_type</span><span class="p">[</span><span class="n">j</span><span class="p">]));</span>
						<span class="n">clear_group_ind_mask_bit</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>           <span class="cm">/* disable call on other group members */</span>
						<span class="n">appl_number_group_type</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>       <span class="cm">/* remove disabled group member from group list */</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>                                                 <span class="cm">/* application should not get a call */</span>
		<span class="p">{</span>
			<span class="n">clear_group_ind_mask_bit</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>



<span class="cm">/* OS notifies the driver about a application Capi_Register */</span>
<span class="n">word</span> <span class="nf">CapiRegister</span><span class="p">(</span><span class="n">word</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">appls_found</span><span class="p">;</span>

	<span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">;</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">appls_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_appl</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Id</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">application</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Id</span> <span class="o">!=</span> <span class="n">id</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">appls_found</span><span class="o">++</span><span class="p">;</span>                       <span class="cm">/* an application has been found */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">appls_found</span><span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_adapter</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>                   <span class="cm">/* scan all adapters...    */</span>
	<span class="p">{</span>
		<span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">flag_dynamic_l1_down</span><span class="p">)</span>  <span class="cm">/* remove adapter from L1 tristate (Huntgroup) */</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">appls_found</span><span class="p">)</span>           <span class="cm">/* first application does a capi register   */</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">=</span> <span class="n">get_plci</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>                    <span class="cm">/* activate L1 of all adapters */</span>
					<span class="p">{</span>
						<span class="n">plci</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">OAD</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\xfd</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">CAI</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x80</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">UID</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x06\x43\x61\x70\x69\x32\x30</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">SHIFT</span> <span class="o">|</span> <span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">SIN</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x02\x00\x00</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">plci</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">START_L1_SIG_ASSIGN_PEND</span><span class="p">;</span>
						<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">ASSIGN</span><span class="p">,</span> <span class="n">DSIG_ID</span><span class="p">);</span>
						<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">FTY</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x02\xff\x07</span><span class="s">&quot;</span><span class="p">);</span> <span class="cm">/* l1 start */</span>
						<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="p">,</span> <span class="n">SIG_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
						<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="cm">/* Functions for virtual Switching e.g. Transfer by join, Conference */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">VSwitchReqInd</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">byte</span> <span class="o">**</span><span class="n">parms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">;</span>
	<span class="cm">/* Format of vswitch_t:</span>
<span class="cm">	   0 byte length</span>
<span class="cm">	   1 byte VSWITCHIE</span>
<span class="cm">	   2 byte VSWITCH_REQ/VSWITCH_IND</span>
<span class="cm">	   3 byte reserved</span>
<span class="cm">	   4 word VSwitchcommand</span>
<span class="cm">	   6 word returnerror</span>
<span class="cm">	   8... Params</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">appl</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">State</span> <span class="o">||</span>
	    <span class="n">plci</span><span class="o">-&gt;</span><span class="n">Sig</span><span class="p">.</span><span class="n">Ind</span> <span class="o">==</span> <span class="n">NCR_FACILITY</span>
		<span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_MULTI_IE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* kill it */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;VSwitchReqInd(%d)&quot;</span><span class="p">,</span> <span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]));</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">])</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">VSJOIN</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">!=</span> <span class="n">S_ECT</span> <span class="o">&amp;&amp;</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="o">-&gt;</span><span class="n">ptyState</span> <span class="o">!=</span> <span class="n">S_ECT</span><span class="p">))</span>
			<span class="p">{</span> <span class="cm">/* Error */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* remember all necessary informations */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">11</span> <span class="o">||</span> <span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="cm">/* Length Test */</span>
			<span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">VSWITCH_IND</span> <span class="o">&amp;&amp;</span> <span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="p">{</span>   <span class="cm">/* first indication after ECT-Request on Consultation Call */</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">vswitchstate</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">9</span><span class="p">];</span>
				<span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* State */</span>
				<span class="cm">/* now ask first Call to join */</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">VSWITCH_REQ</span> <span class="o">&amp;&amp;</span> <span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="p">{</span> <span class="cm">/* Answer of VSWITCH_REQ from first Call */</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">vswitchstate</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">9</span><span class="p">];</span>
				<span class="cm">/* tell consultation call to join</span>
<span class="cm">				   and the protocol capabilities of the first call */</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span> <span class="cm">/* Error */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">vsprot</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">10</span><span class="p">];</span> <span class="cm">/* protocol */</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">vsprotdialect</span> <span class="o">=</span> <span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">11</span><span class="p">];</span> <span class="cm">/* protocoldialect */</span>
			<span class="cm">/* send join request to related PLCI */</span>
			<span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">VSWITCHIE</span><span class="p">;</span>
			<span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">VSWITCH_REQ</span><span class="p">;</span>

			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="o">-&gt;</span><span class="n">internal_command</span> <span class="o">=</span> <span class="n">VSWITCH_REQ_PEND</span><span class="p">;</span>
			<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">,</span> <span class="n">ESC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">,</span> <span class="n">VSWITCH_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VSTRANSPORT</span>:
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span> <span class="o">&amp;&amp;</span>
			    <span class="n">plci</span><span class="o">-&gt;</span><span class="n">vswitchstate</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
			    <span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="o">-&gt;</span><span class="n">vswitchstate</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">add_p</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">,</span> <span class="n">ESC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">sig_req</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">,</span> <span class="n">VSWITCH_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">send_req</span><span class="p">(</span><span class="n">plci</span><span class="o">-&gt;</span><span class="n">relatedPTYPLCI</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* kill it */</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">diva_get_dma_descriptor</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="n">dword</span>   <span class="o">*</span><span class="n">dma_magic</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">ENTITY</span> <span class="n">e</span><span class="p">;</span>
	<span class="n">IDI_SYNC_REQ</span> <span class="o">*</span><span class="n">pReq</span> <span class="o">=</span> <span class="p">(</span><span class="n">IDI_SYNC_REQ</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">e</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">diva_xdi_extended_features</span> <span class="o">&amp;</span> <span class="n">DIVA_CAPI_XDI_PROVIDES_RX_DMA</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">Rc</span> <span class="o">=</span> <span class="n">IDI_SYNC_REQ_DMA_DESCRIPTOR_OPERATION</span><span class="p">;</span>

	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">IDI_SYNC_REQ_DMA_DESCRIPTOR_ALLOC</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">descriptor_number</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">descriptor_address</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">descriptor_magic</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">e</span><span class="p">.</span><span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">((</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)</span><span class="n">pReq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">operation</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">descriptor_number</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">descriptor_magic</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">dma_magic</span> <span class="o">=</span> <span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">descriptor_magic</span><span class="p">;</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;dma_alloc, a:%d (%d-%08x)&quot;</span><span class="p">,</span>
				<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span>
				<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">descriptor_number</span><span class="p">,</span>
				<span class="o">*</span><span class="n">dma_magic</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">descriptor_number</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;dma_alloc failed&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">diva_free_dma_descriptor</span><span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="n">plci</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">ENTITY</span> <span class="n">e</span><span class="p">;</span>
	<span class="n">IDI_SYNC_REQ</span> <span class="o">*</span><span class="n">pReq</span> <span class="o">=</span> <span class="p">(</span><span class="n">IDI_SYNC_REQ</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">e</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">Rc</span> <span class="o">=</span> <span class="n">IDI_SYNC_REQ_DMA_DESCRIPTOR_OPERATION</span><span class="p">;</span>

	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">IDI_SYNC_REQ_DMA_DESCRIPTOR_FREE</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">descriptor_number</span>  <span class="o">=</span> <span class="n">nr</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">descriptor_address</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">descriptor_magic</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">e</span><span class="p">.</span><span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">plci</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">((</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)</span><span class="n">pReq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">operation</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;dma_free(%d)&quot;</span><span class="p">,</span> <span class="n">nr</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dbug</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;dma_free failed (%d)&quot;</span><span class="p">,</span> <span class="n">nr</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
