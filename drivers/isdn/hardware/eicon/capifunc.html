<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hardware › eicon › capifunc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>capifunc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: capifunc.c,v 1.61.4.7 2005/02/11 19:40:25 armin Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * ISDN interface module for Eicon active cards DIVA.</span>
<span class="cm"> * CAPI Interface common functions</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2000-2003 by Armin Schindler (mac@melware.de)</span>
<span class="cm"> * Copyright 2000-2003 Cytronics &amp; Melware (info@melware.de)</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;platform.h&quot;</span>
<span class="cp">#include &quot;os_capi.h&quot;</span>
<span class="cp">#include &quot;di_defs.h&quot;</span>
<span class="cp">#include &quot;capi20.h&quot;</span>
<span class="cp">#include &quot;divacapi.h&quot;</span>
<span class="cp">#include &quot;divasync.h&quot;</span>
<span class="cp">#include &quot;capifunc.h&quot;</span>

<span class="cp">#define DBG_MINIMUM  (DL_LOG + DL_FTL + DL_ERR)</span>
<span class="cp">#define DBG_DEFAULT  (DBG_MINIMUM + DL_XLOG + DL_REG)</span>

<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">APPL</span> <span class="o">*</span><span class="n">application</span> <span class="o">=</span> <span class="p">(</span><span class="n">APPL</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">byte</span> <span class="n">max_appl</span> <span class="o">=</span> <span class="n">MAX_APPL</span><span class="p">;</span>
<span class="n">byte</span> <span class="n">max_adapter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="n">CAPI_MSG</span> <span class="o">*</span><span class="n">mapped_msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="n">byte</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">byte</span><span class="p">);</span>
<span class="kt">char</span> <span class="n">DRIVERRELEASE_CAPI</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">AutomaticLaw</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">callback</span><span class="p">(</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">word</span> <span class="n">api_remove_start</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">word</span> <span class="n">CapiRelease</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">word</span> <span class="n">CapiRegister</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">word</span> <span class="n">api_put</span><span class="p">(</span><span class="n">APPL</span> <span class="o">*</span><span class="p">,</span> <span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="n">diva_os_spin_lock_t</span> <span class="n">api_lock</span><span class="p">;</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">cards</span><span class="p">);</span>

<span class="k">static</span> <span class="n">dword</span> <span class="n">notify_handle</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">DIRequest</span><span class="p">(</span><span class="n">ENTITY</span> <span class="o">*</span><span class="n">e</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DESCRIPTOR</span> <span class="n">MAdapter</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DESCRIPTOR</span> <span class="n">DAdapter</span><span class="p">;</span>
<span class="k">static</span> <span class="n">byte</span> <span class="n">ControllerMap</span><span class="p">[</span><span class="n">MAX_DESCRIPTORS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">diva_register_appl</span><span class="p">(</span><span class="k">struct</span> <span class="n">capi_ctr</span> <span class="o">*</span><span class="p">,</span> <span class="n">__u16</span><span class="p">,</span>
			       <span class="n">capi_register_params</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">diva_release_appl</span><span class="p">(</span><span class="k">struct</span> <span class="n">capi_ctr</span> <span class="o">*</span><span class="p">,</span> <span class="n">__u16</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">diva_procinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">capi_ctr</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">diva_send_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">capi_ctr</span> <span class="o">*</span><span class="p">,</span>
			     <span class="n">diva_os_message_buffer_s</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">diva_os_set_controller_struct</span><span class="p">(</span><span class="k">struct</span> <span class="n">capi_ctr</span> <span class="o">*</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">DIVA_DIDD_Read</span><span class="p">(</span><span class="n">DESCRIPTOR</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * debug</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">no_printf</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="p">...);</span>
<span class="cp">#include &quot;debuglib.c&quot;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xlog</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
<span class="cp">#ifndef DIVA_NO_DEBUGLIB</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">myDriverDebugHandle</span><span class="p">.</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DL_XLOG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">myDriverDebugHandle</span><span class="p">.</span><span class="n">dbg_irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">myDriverDebugHandle</span><span class="p">.</span><span class="n">dbg_irq</span><span class="p">(</span><span class="n">myDriverDebugHandle</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
						    <span class="n">DLI_XLOG</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">myDriverDebugHandle</span><span class="p">.</span><span class="n">dbg_old</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">myDriverDebugHandle</span><span class="p">.</span><span class="n">dbg_old</span><span class="p">(</span><span class="n">myDriverDebugHandle</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
						    <span class="n">x</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * info for proc</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">diva_procinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">capi_ctr</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stop debugging</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stop_dbg</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DbgDeregister</span><span class="p">();</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MAdapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAdapter</span><span class="p">));</span>
	<span class="n">dprintf</span> <span class="o">=</span> <span class="n">no_printf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * dummy debug function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">no_printf</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Controller mapping</span>
<span class="cm"> */</span>
<span class="n">byte</span> <span class="nf">MapController</span><span class="p">(</span><span class="n">byte</span> <span class="n">Controller</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">byte</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">MappedController</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="n">Controller</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>	<span class="cm">/* mask external controller bit off */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_adapter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">==</span> <span class="n">ControllerMap</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">MappedController</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">max_adapter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ControllerMap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
		<span class="n">MappedController</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">MappedController</span> <span class="o">|</span> <span class="p">(</span><span class="n">Controller</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">));</span>	<span class="cm">/* put back external controller bit */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Controller unmapping</span>
<span class="cm"> */</span>
<span class="n">byte</span> <span class="nf">UnMapController</span><span class="p">(</span><span class="n">byte</span> <span class="n">MappedController</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">byte</span> <span class="n">Controller</span><span class="p">;</span>
	<span class="n">byte</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="n">MappedController</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>	<span class="cm">/* mask external controller bit off */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&lt;=</span> <span class="n">max_adapter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Controller</span> <span class="o">=</span> <span class="n">ControllerMap</span><span class="p">[</span><span class="n">ctrl</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">Controller</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">Controller</span> <span class="o">|</span> <span class="p">(</span><span class="n">MappedController</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">));</span>	<span class="cm">/* put back external controller bit */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * find a new free id</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_free_id</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">num</span> <span class="o">&lt;</span> <span class="n">MAX_DESCRIPTORS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">num</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * find a card structure by controller number</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">diva_card</span> <span class="o">*</span><span class="nf">find_card_by_ctrl</span><span class="p">(</span><span class="n">word</span> <span class="n">controller</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">diva_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cards</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">diva_card</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ControllerMap</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">]</span> <span class="o">==</span> <span class="n">controller</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">remove_in_progress</span><span class="p">)</span>
				<span class="n">card</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">diva_card</span> <span class="o">*</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Buffer RX/TX</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">TransmitBufferSet</span><span class="p">(</span><span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">dword</span> <span class="n">ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">appl</span><span class="o">-&gt;</span><span class="n">xbuffer_used</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">DBG_PRV1</span><span class="p">((</span><span class="s">&quot;%d:xbuf_used(%d)&quot;</span><span class="p">,</span> <span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="n">ref</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">ref</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">TransmitBufferGet</span><span class="p">(</span><span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">xbuffer_internal</span><span class="p">[(</span><span class="n">dword</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">appl</span><span class="o">-&gt;</span><span class="n">xbuffer_internal</span><span class="p">[(</span><span class="n">dword</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">appl</span><span class="o">-&gt;</span><span class="n">xbuffer_ptr</span><span class="p">[(</span><span class="n">dword</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">TransmitBufferFree</span><span class="p">(</span><span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">appl</span><span class="o">-&gt;</span><span class="n">xbuffer_used</span><span class="p">[(</span><span class="n">dword</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">DBG_PRV1</span><span class="p">((</span><span class="s">&quot;%d:xbuf_free(%d)&quot;</span><span class="p">,</span> <span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="p">((</span><span class="n">dword</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
		<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">ReceiveBufferGet</span><span class="p">(</span><span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">Num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">appl</span><span class="o">-&gt;</span><span class="n">ReceiveBuffer</span><span class="p">[</span><span class="n">Num</span> <span class="o">*</span> <span class="n">appl</span><span class="o">-&gt;</span><span class="n">MaxDataLength</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * api_remove_start/complete for cleanup</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">api_remove_complete</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG_PRV1</span><span class="p">((</span><span class="s">&quot;api_remove_complete&quot;</span><span class="p">))</span>
		<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * main function called by message.c</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sendf</span><span class="p">(</span><span class="n">APPL</span> <span class="o">*</span><span class="n">appl</span><span class="p">,</span> <span class="n">word</span> <span class="n">command</span><span class="p">,</span> <span class="n">dword</span> <span class="n">Id</span><span class="p">,</span> <span class="n">word</span> <span class="n">Number</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="n">word</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="n">dlength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">write</span><span class="p">;</span>
	<span class="n">CAPI_MSG</span> <span class="n">msg</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">string</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
	<span class="n">diva_os_message_buffer_s</span> <span class="o">*</span><span class="n">dmb</span><span class="p">;</span>
	<span class="n">diva_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">appl</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DBG_PRV1</span><span class="p">((</span><span class="s">&quot;sendf(a=%d,cmd=%x,format=%s)&quot;</span><span class="p">,</span>
		  <span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">format</span><span class="p">))</span>

		<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">appl_id</span><span class="p">,</span> <span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">);</span>
	<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">byte</span><span class="p">)</span> <span class="p">(</span><span class="n">command</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x82</span><span class="p">)</span>
		<span class="n">Number</span> <span class="o">=</span> <span class="n">appl</span><span class="o">-&gt;</span><span class="n">Number</span><span class="o">++</span><span class="p">;</span>
	<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">number</span><span class="p">,</span> <span class="n">Number</span><span class="p">);</span>

	<span class="n">PUT_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">controller</span><span class="p">,</span> <span class="n">Id</span><span class="p">);</span>
	<span class="n">write</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">write</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">format</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">format</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;b&#39;</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">dword</span><span class="p">);</span>
			<span class="o">*</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">write</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">write</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">length</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;w&#39;</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">dword</span><span class="p">);</span>
			<span class="n">PUT_WORD</span><span class="p">(</span><span class="n">write</span><span class="p">,</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
			<span class="n">write</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">length</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">dword</span><span class="p">);</span>
			<span class="n">PUT_DWORD</span><span class="p">(</span><span class="n">write</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">write</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">length</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;S&#39;</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="p">);</span>
			<span class="n">length</span> <span class="o">+=</span> <span class="n">string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">string</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="o">*</span><span class="n">write</span><span class="o">++</span> <span class="o">=</span> <span class="n">string</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">controller</span> <span class="o">=</span> <span class="n">UnMapController</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">controller</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">_DATA_B3_I</span><span class="p">)</span>
		<span class="n">dlength</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span>
			<span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">data_b3_ind</span><span class="p">.</span><span class="n">Data_Length</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dmb</span> <span class="o">=</span> <span class="n">diva_os_alloc_message_buffer</span><span class="p">(</span><span class="n">length</span> <span class="o">+</span> <span class="n">dlength</span><span class="p">,</span>
						 <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">write</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;sendf: alloc_message_buffer failed, incoming msg dropped.&quot;</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* copy msg header to sk_buff */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">write</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="cm">/* if DATA_B3_IND, copy data too */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">_DATA_B3_I</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dword</span> <span class="n">data</span> <span class="o">=</span> <span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">data_b3_ind</span><span class="p">.</span><span class="n">Data</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">write</span> <span class="o">+</span> <span class="n">length</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">dlength</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifndef DIVA_NO_DEBUGLIB</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">myDriverDebugHandle</span><span class="p">.</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DL_XLOG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="n">xlog</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x00\x02</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">_DATA_B3_R</span> <span class="o">|</span> <span class="n">CONFIRM</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">myDriverDebugHandle</span><span class="p">.</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DL_BLK</span><span class="p">)</span>
				<span class="n">xlog</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x00\x02</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">_DATA_B3_I</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">myDriverDebugHandle</span><span class="p">.</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DL_BLK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xlog</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x00\x02</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dlength</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DBG_BLK</span><span class="p">((((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">GET_DWORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">data_b3_ind</span><span class="p">.</span><span class="n">Data</span><span class="p">))</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
						 <span class="p">((</span><span class="n">dlength</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">dlength</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="mi">256</span><span class="p">))</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">myDriverDebugHandle</span><span class="p">.</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DL_PRV0</span><span class="p">))</span>
							<span class="k">break</span><span class="p">;</span> <span class="cm">/* not more if not explicitly requested */</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* find the card structure for this controller */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span> <span class="o">=</span> <span class="n">find_card_by_ctrl</span><span class="p">(</span><span class="n">write</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;sendf - controller %d not found, incoming msg dropped&quot;</span><span class="p">,</span>
			 <span class="n">write</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">))</span>
			<span class="n">diva_os_free_message_buffer</span><span class="p">(</span><span class="n">dmb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* send capi msg to capi layer */</span>
	<span class="n">capi_ctr_handle_message</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">capi_ctrl</span><span class="p">,</span> <span class="n">appl</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="n">dmb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * cleanup adapter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">clean_adapter</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">free_mem_q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

	<span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
	<span class="n">k</span> <span class="o">=</span> <span class="n">li_total_channels</span> <span class="o">-</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_channels</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">li_config_table</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_add</span><span class="p">((</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="p">)</span><span class="n">li_config_table</span><span class="p">,</span> <span class="n">free_mem_q</span><span class="p">);</span>
			<span class="n">li_config_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">],</span>
				<span class="o">&amp;</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_channels</span><span class="p">],</span>
				<span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LI_CONFIG</span><span class="p">));</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_channels</span><span class="p">],</span>
					<span class="n">k</span> <span class="o">-</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">);</span>
				<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
					<span class="n">coef_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_channels</span><span class="p">],</span>
					<span class="n">k</span> <span class="o">-</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">li_total_channels</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_adapter</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request</span><span class="p">)</span>
			<span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">li_base</span> <span class="o">-=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_channels</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">)</span>
		<span class="n">list_add</span><span class="p">((</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="p">)</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">,</span> <span class="n">free_mem_q</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">max_adapter</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">adapter</span><span class="p">[</span><span class="n">max_adapter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">request</span><span class="p">)</span>
		<span class="n">max_adapter</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * remove a card, but ensures consistent state of LI tables</span>
<span class="cm"> * in the time adapter is removed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">divacapi_remove_card</span><span class="p">(</span><span class="n">DESCRIPTOR</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">diva_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">free_mem_q</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set &quot;remove in progress flag&quot;.</span>
<span class="cm">	 * Ensures that there is no call from sendf to CAPI in</span>
<span class="cm">	 * the time CAPI controller is about to be removed.</span>
<span class="cm">	 */</span>
	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;remove card&quot;</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cards</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">diva_card</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">request</span> <span class="o">==</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">remove_in_progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">list_del</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;remove card&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Detach CAPI. Sendf cannot call to CAPI any more.</span>
<span class="cm">		 * After detach no call to send_message() is done too.</span>
<span class="cm">		 */</span>
		<span class="n">detach_capi_ctr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">capi_ctrl</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Now get API lock (to ensure stable state of LI tables)</span>
<span class="cm">		 * and update the adapter map/LI table.</span>
<span class="cm">		 */</span>
		<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;remove card&quot;</span><span class="p">);</span>

		<span class="n">clean_adapter</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">free_mem_q</span><span class="p">);</span>
		<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;DelAdapterMap (%d) -&gt; (%d)&quot;</span><span class="p">,</span>
			 <span class="n">ControllerMap</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">],</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">))</span>
			<span class="n">ControllerMap</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;adapter remove, max_adapter=%d&quot;</span><span class="p">,</span>
			 <span class="n">max_adapter</span><span class="p">));</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;remove card&quot;</span><span class="p">);</span>

		<span class="cm">/* After releasing the lock, we can free the memory */</span>
		<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* free queued memory areas */</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">free_mem_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
		<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * remove cards</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">divacapi_remove_cards</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DESCRIPTOR</span> <span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">diva_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>

<span class="nl">rescan:</span>
	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;remove cards&quot;</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cards</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">diva_card</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;remove cards&quot;</span><span class="p">);</span>
		<span class="n">d</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">request</span><span class="p">;</span>
		<span class="n">divacapi_remove_card</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rescan</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;remove cards&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sync_callback</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sync_callback</span><span class="p">(</span><span class="n">ENTITY</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>

	<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;cb:Id=%x,Rc=%x,Ind=%x&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Rc</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Ind</span><span class="p">))</span>

		<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;sync_callback&quot;</span><span class="p">);</span>
	<span class="n">callback</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;sync_callback&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * add a new card</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">diva_add_card</span><span class="p">(</span><span class="n">DESCRIPTOR</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>
	<span class="n">diva_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">capi_ctr</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">IDI_SYNC_REQ</span> <span class="n">sync_req</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">serial</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">mem_to_free</span><span class="p">;</span>
	<span class="n">LI_CONFIG</span> <span class="o">*</span><span class="n">new_li_config_table</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_card</span> <span class="o">*</span><span class="p">)</span> <span class="n">diva_os_malloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">diva_card</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;diva_add_card: failed to allocate card struct.&quot;</span><span class="p">))</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">card</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">diva_card</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DESCRIPTOR</span><span class="p">));</span>
	<span class="n">sync_req</span><span class="p">.</span><span class="n">GetName</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sync_req</span><span class="p">.</span><span class="n">GetName</span><span class="p">.</span><span class="n">Rc</span> <span class="o">=</span> <span class="n">IDI_SYNC_REQ_GET_NAME</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">request</span><span class="p">((</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sync_req</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sync_req</span><span class="p">.</span><span class="n">GetName</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">capi_ctrl</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">register_appl</span> <span class="o">=</span> <span class="n">diva_register_appl</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">release_appl</span> <span class="o">=</span> <span class="n">diva_release_appl</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">send_message</span> <span class="o">=</span> <span class="n">diva_send_message</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">procinfo</span> <span class="o">=</span> <span class="n">diva_procinfo</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">driverdata</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">diva_os_set_controller_struct</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attach_capi_ctr</span><span class="p">(</span><span class="n">ctrl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;diva_add_card: failed to attach controller.&quot;</span><span class="p">))</span>
			<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;find id&quot;</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">=</span> <span class="n">find_free_id</span><span class="p">();</span>
	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;find id&quot;</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">manu</span><span class="p">,</span> <span class="n">M_COMPANY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">manu</span><span class="p">));</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">majorversion</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">minorversion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">majormanuversion</span> <span class="o">=</span> <span class="n">DRRELMAJOR</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">minormanuversion</span> <span class="o">=</span> <span class="n">DRRELMINOR</span><span class="p">;</span>
	<span class="n">sync_req</span><span class="p">.</span><span class="n">GetSerial</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sync_req</span><span class="p">.</span><span class="n">GetSerial</span><span class="p">.</span><span class="n">Rc</span> <span class="o">=</span> <span class="n">IDI_SYNC_REQ_GET_SERIAL</span><span class="p">;</span>
	<span class="n">sync_req</span><span class="p">.</span><span class="n">GetSerial</span><span class="p">.</span><span class="n">serial</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">request</span><span class="p">((</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sync_req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="p">((</span><span class="n">sync_req</span><span class="p">.</span><span class="n">GetSerial</span><span class="p">.</span><span class="n">serial</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="s">&quot;%ld-%d&quot;</span><span class="p">,</span>
			<span class="n">sync_req</span><span class="p">.</span><span class="n">GetSerial</span><span class="p">.</span><span class="n">serial</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="s">&quot;%ld&quot;</span><span class="p">,</span> <span class="n">sync_req</span><span class="p">.</span><span class="n">GetSerial</span><span class="p">.</span><span class="n">serial</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">serial</span><span class="p">[</span><span class="n">CAPI_SERIAL_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">serial</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">));</span>

	<span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">os_card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">ControllerMap</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cnr</span><span class="p">);</span>

	<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;AddAdapterMap (%d) -&gt; (%d)&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cnr</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">))</span>

		<span class="n">sync_req</span><span class="p">.</span><span class="n">xdi_capi_prms</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sync_req</span><span class="p">.</span><span class="n">xdi_capi_prms</span><span class="p">.</span><span class="n">Rc</span> <span class="o">=</span> <span class="n">IDI_SYNC_REQ_XDI_GET_CAPI_PARAMS</span><span class="p">;</span>
	<span class="n">sync_req</span><span class="p">.</span><span class="n">xdi_capi_prms</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">structure_length</span> <span class="o">=</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">diva_xdi_get_capi_parameters_t</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">request</span><span class="p">((</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sync_req</span><span class="p">);</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">flag_dynamic_l1_down</span> <span class="o">=</span>
		<span class="n">sync_req</span><span class="p">.</span><span class="n">xdi_capi_prms</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">flag_dynamic_l1_down</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">group_optimization_enabled</span> <span class="o">=</span>
		<span class="n">sync_req</span><span class="p">.</span><span class="n">xdi_capi_prms</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">group_optimization_enabled</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">=</span> <span class="n">DIRequest</span><span class="p">;</span>	<span class="cm">/* card-&gt;d.request; */</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">max_plci</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">channels</span> <span class="o">+</span> <span class="mi">30</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">max_listen</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span>
	    <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span> <span class="o">=</span>
	     <span class="p">(</span><span class="n">PLCI</span> <span class="o">*</span><span class="p">)</span> <span class="n">diva_os_malloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PLCI</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">max_plci</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;diva_add_card: failed alloc plci struct.&quot;</span><span class="p">))</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PLCI</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">max_plci</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">max_plci</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">Sig</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">sync_callback</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">Sig</span><span class="p">.</span><span class="n">XNum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">Sig</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">XData</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">Sig</span><span class="p">.</span><span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">Sig</span><span class="p">.</span><span class="n">user</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="n">k</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">NL</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">sync_callback</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">NL</span><span class="p">.</span><span class="n">XNum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">NL</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">XData</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">NL</span><span class="p">.</span><span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">);</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">NL</span><span class="p">.</span><span class="n">user</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="n">k</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Number</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Channels</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">channels</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DI_FAX3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span> <span class="o">=</span> <span class="mh">0x71</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DI_CODEC</span><span class="p">)</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span> <span class="o">|=</span> <span class="mh">0x6</span><span class="p">;</span>
<span class="cp">#if IMPLEMENT_DTMF</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span> <span class="o">|=</span> <span class="mh">0x8</span><span class="p">;</span>
<span class="cp">#endif				</span><span class="cm">/* IMPLEMENT_DTMF */</span><span class="cp"></span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* Line Interconnect */</span>
<span class="cp">#if IMPLEMENT_ECHO_CANCELLER</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span> <span class="o">|=</span> <span class="mh">0x100</span><span class="p">;</span>
<span class="cp">#endif				</span><span class="cm">/* IMPLEMENT_ECHO_CANCELLER */</span><span class="cp"></span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B1_Protocols</span> <span class="o">=</span> <span class="mh">0xdf</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B2_Protocols</span> <span class="o">=</span> <span class="mh">0x1fdb</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B3_Protocols</span> <span class="o">=</span> <span class="mh">0xb7</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">=</span> <span class="n">MANUFACTURER_FEATURE_HARDDTMF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span> <span class="o">=</span> <span class="mh">0x71</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">DI_CODEC</span><span class="p">)</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span> <span class="o">|=</span> <span class="mh">0x2</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B1_Protocols</span> <span class="o">=</span> <span class="mh">0x43</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B2_Protocols</span> <span class="o">=</span> <span class="mh">0x1f0f</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B3_Protocols</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">manufacturer_features</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">a</span><span class="o">-&gt;</span><span class="n">li_pri</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Channels</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">li_channels</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_pri</span> <span class="o">?</span> <span class="n">MIXER_CHANNELS_PRI</span> <span class="o">:</span> <span class="n">MIXER_CHANNELS_BRI</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">a</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request</span><span class="p">)</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">li_channels</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">k</span> <span class="o">=</span> <span class="n">li_total_channels</span> <span class="o">+</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_channels</span><span class="p">;</span>
	<span class="n">new_li_config_table</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">LI_CONFIG</span> <span class="o">*</span><span class="p">)</span> <span class="n">diva_os_malloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">((</span><span class="n">k</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LI_CONFIG</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">k</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_li_config_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;diva_add_card: failed alloc li_config table.&quot;</span><span class="p">))</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Prevent access to line interconnect table in process update */</span>
	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;add card&quot;</span><span class="p">);</span>

	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_channels</span><span class="p">))</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LI_CONFIG</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LI_CONFIG</span><span class="p">));</span>
		<span class="n">new_li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">new_li_config_table</span><span class="p">)</span> <span class="o">+</span> <span class="p">(((</span><span class="n">k</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LI_CONFIG</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">k</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">));</span>
		<span class="n">new_li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">new_li_config_table</span><span class="p">)</span> <span class="o">+</span> <span class="p">(((</span><span class="n">k</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LI_CONFIG</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">k</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_channels</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">new_li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				       <span class="o">&amp;</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				       <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				       <span class="o">&amp;</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				       <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_channels</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_channels</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_channels</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span>
									  <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_channels</span><span class="p">],</span>
				       <span class="o">&amp;</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">],</span>
				       <span class="n">k</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_channels</span><span class="p">));</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_li_config_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span>
									  <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_channels</span><span class="p">],</span>
				       <span class="o">&amp;</span><span class="n">li_config_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">coef_table</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span><span class="p">],</span>
				       <span class="n">k</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">li_base</span> <span class="o">+</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_channels</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">li_total_channels</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>

	<span class="n">mem_to_free</span> <span class="o">=</span> <span class="n">li_config_table</span><span class="p">;</span>

	<span class="n">li_config_table</span> <span class="o">=</span> <span class="n">new_li_config_table</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_adapter</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request</span><span class="p">)</span>
			<span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">li_base</span> <span class="o">+=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">li_channels</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="p">[</span><span class="n">max_adapter</span><span class="p">])</span>
		<span class="n">max_adapter</span><span class="o">++</span><span class="p">;</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cards</span><span class="p">);</span>
	<span class="n">AutomaticLaw</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>

	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;add card&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem_to_free</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mem_to_free</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">automatic_law</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">diva_os_sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* profile information */</span>
	<span class="n">PUT_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">nbchannel</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">channels</span><span class="p">);</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">goptions</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">Global_Options</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">support1</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B1_Protocols</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">support2</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B2_Protocols</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">support3</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">B3_Protocols</span><span class="p">;</span>
	<span class="cm">/* manufacturer profile information */</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">manu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">private_options</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">manu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">rtp_primary_payloads</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">manu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">man_profile</span><span class="p">.</span><span class="n">rtp_additional_payloads</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">manu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">manu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">capi_ctr_ready</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;adapter added, max_adapter=%d&quot;</span><span class="p">,</span> <span class="n">max_adapter</span><span class="p">));</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  register appl</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">diva_register_appl</span><span class="p">(</span><span class="k">struct</span> <span class="n">capi_ctr</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">appl</span><span class="p">,</span>
			       <span class="n">capi_register_params</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">APPL</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">bnum</span><span class="p">,</span> <span class="n">xnum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">DataNCCI</span><span class="p">,</span> <span class="o">*</span><span class="n">DataFlags</span><span class="p">,</span> <span class="o">*</span><span class="n">ReceiveBuffer</span><span class="p">,</span> <span class="o">*</span><span class="n">xbuffer_used</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">**</span><span class="n">xbuffer_ptr</span><span class="p">,</span> <span class="o">**</span><span class="n">xbuffer_internal</span><span class="p">;</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mem_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nconn</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">level3cnt</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">diva_os_in_irq</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;CAPI_REGISTER - in irq context !&quot;</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;application register Id=%d&quot;</span><span class="p">,</span> <span class="n">appl</span><span class="p">))</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">appl</span> <span class="o">&gt;</span> <span class="n">MAX_APPL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;CAPI_REGISTER - appl.Id exceeds MAX_APPL&quot;</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nconn</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nconn</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">nbchannel</span> <span class="o">*</span> <span class="o">-</span><span class="n">nconn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nconn</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nconn</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">nbchannel</span><span class="p">;</span>

	<span class="n">DBG_LOG</span><span class="p">((</span><span class="s">&quot;CAPI_REGISTER - Id = %d&quot;</span><span class="p">,</span> <span class="n">appl</span><span class="p">))</span>
		<span class="n">DBG_LOG</span><span class="p">((</span><span class="s">&quot;  MaxLogicalConnections = %d(%d)&quot;</span><span class="p">,</span> <span class="n">nconn</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">level3cnt</span><span class="p">))</span>
		<span class="n">DBG_LOG</span><span class="p">((</span><span class="s">&quot;  MaxBDataBuffers       = %d&quot;</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">datablkcnt</span><span class="p">))</span>
		<span class="n">DBG_LOG</span><span class="p">((</span><span class="s">&quot;  MaxBDataLength        = %d&quot;</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">datablklen</span><span class="p">))</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nconn</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span>
		    <span class="n">nconn</span> <span class="o">&gt;</span> <span class="mi">255</span> <span class="o">||</span>
		    <span class="n">rp</span><span class="o">-&gt;</span><span class="n">datablklen</span> <span class="o">&lt;</span> <span class="mi">80</span> <span class="o">||</span>
		    <span class="n">rp</span><span class="o">-&gt;</span><span class="n">datablklen</span> <span class="o">&gt;</span> <span class="mi">2150</span> <span class="o">||</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">datablkcnt</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;CAPI_REGISTER - invalid parameters&quot;</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">application</span><span class="p">[</span><span class="n">appl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">Id</span> <span class="o">==</span> <span class="n">appl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_LOG</span><span class="p">((</span><span class="s">&quot;CAPI_REGISTER - appl already registered&quot;</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>	<span class="cm">/* appl already registered */</span>
	<span class="p">}</span>

	<span class="cm">/* alloc memory */</span>

	<span class="n">bnum</span> <span class="o">=</span> <span class="n">nconn</span> <span class="o">*</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">datablkcnt</span><span class="p">;</span>
	<span class="n">xnum</span> <span class="o">=</span> <span class="n">nconn</span> <span class="o">*</span> <span class="n">MAX_DATA_B3</span><span class="p">;</span>

	<span class="n">mem_len</span>  <span class="o">=</span> <span class="n">bnum</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>		<span class="cm">/* DataNCCI */</span>
	<span class="n">mem_len</span> <span class="o">+=</span> <span class="n">bnum</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>		<span class="cm">/* DataFlags */</span>
	<span class="n">mem_len</span> <span class="o">+=</span> <span class="n">bnum</span> <span class="o">*</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">datablklen</span><span class="p">;</span>	<span class="cm">/* ReceiveBuffer */</span>
	<span class="n">mem_len</span> <span class="o">+=</span> <span class="n">xnum</span><span class="p">;</span>			<span class="cm">/* xbuffer_used */</span>
	<span class="n">mem_len</span> <span class="o">+=</span> <span class="n">xnum</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>	<span class="cm">/* xbuffer_ptr */</span>
	<span class="n">mem_len</span> <span class="o">+=</span> <span class="n">xnum</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>	<span class="cm">/* xbuffer_internal */</span>
	<span class="n">mem_len</span> <span class="o">+=</span> <span class="n">xnum</span> <span class="o">*</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">datablklen</span><span class="p">;</span>	<span class="cm">/* xbuffer_ptr[xnum] */</span>

	<span class="n">DBG_LOG</span><span class="p">((</span><span class="s">&quot;  Allocated Memory      = %d&quot;</span><span class="p">,</span> <span class="n">mem_len</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">diva_os_malloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mem_len</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;CAPI_REGISTER - memory allocation failed&quot;</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mem_len</span><span class="p">);</span>

	<span class="n">DataNCCI</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">bnum</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>
	<span class="n">DataFlags</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">bnum</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>
	<span class="n">ReceiveBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">bnum</span> <span class="o">*</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">datablklen</span><span class="p">;</span>
	<span class="n">xbuffer_used</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">xnum</span><span class="p">;</span>
	<span class="n">xbuffer_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">xnum</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
	<span class="n">xbuffer_internal</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">xnum</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">xnum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xbuffer_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">datablklen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize application data */</span>
	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;register_appl&quot;</span><span class="p">);</span>

	<span class="n">this</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">appl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">APPL</span><span class="p">));</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_adapter</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">CIP_Mask</span><span class="p">[</span><span class="n">appl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">queue_size</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">MaxNCCI</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">nconn</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">MaxNCCIData</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">datablkcnt</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">MaxBuffer</span> <span class="o">=</span> <span class="n">bnum</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">MaxDataLength</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">datablklen</span><span class="p">;</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">DataNCCI</span> <span class="o">=</span> <span class="n">DataNCCI</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">DataFlags</span> <span class="o">=</span> <span class="n">DataFlags</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">ReceiveBuffer</span> <span class="o">=</span> <span class="n">ReceiveBuffer</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">xbuffer_used</span> <span class="o">=</span> <span class="n">xbuffer_used</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">xbuffer_ptr</span> <span class="o">=</span> <span class="n">xbuffer_ptr</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">xbuffer_internal</span> <span class="o">=</span> <span class="n">xbuffer_internal</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">xnum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">xbuffer_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xbuffer_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">CapiRegister</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">);</span>
	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;register_appl&quot;</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  release appl</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">diva_release_appl</span><span class="p">(</span><span class="k">struct</span> <span class="n">capi_ctr</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">appl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>
	<span class="n">APPL</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">appl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">mem_to_free</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;application %d(%d) cleanup&quot;</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="n">appl</span><span class="p">))</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">diva_os_in_irq</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;CAPI_RELEASE - in irq context !&quot;</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;release_appl&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CapiRelease</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">);</span>
		<span class="n">mem_to_free</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">DataNCCI</span><span class="p">;</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">DataNCCI</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">Id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;release_appl&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem_to_free</span><span class="p">)</span>
		<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mem_to_free</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  send message</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">diva_send_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">capi_ctr</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span>
			     <span class="n">diva_os_message_buffer_s</span> <span class="o">*</span><span class="n">dmb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>
	<span class="n">CAPI_MSG</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)</span> <span class="n">DIVA_MESSAGE_BUFFER_DATA</span><span class="p">(</span><span class="n">dmb</span><span class="p">);</span>
	<span class="n">APPL</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">application</span><span class="p">[</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">appl_id</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">diva_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">driverdata</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">length</span> <span class="o">=</span> <span class="n">DIVA_MESSAGE_BUFFER_LEN</span><span class="p">(</span><span class="n">dmb</span><span class="p">);</span>
	<span class="n">word</span> <span class="n">clength</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">word</span> <span class="n">command</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">command</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">CAPI_NOERROR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">diva_os_in_irq</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;CAPI_SEND_MSG - in irq context !&quot;</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">CAPI_REGOSRESOURCEERR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DBG_PRV1</span><span class="p">((</span><span class="s">&quot;Write - appl = %d, cmd = 0x%x&quot;</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">,</span> <span class="n">command</span><span class="p">))</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">remove_in_progress</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;CAPI_SEND_MSG - remove in progress!&quot;</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">CAPI_REGOSRESOURCEERR</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;send message&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;send message&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">CAPI_ILLAPPNR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* patch controller number */</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">controller</span> <span class="o">=</span> <span class="n">ControllerMap</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">]</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">controller</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>	<span class="cm">/* preserve external controller bit */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">xlog</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x00\x02</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">clength</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">_DATA_B3_I</span> <span class="o">|</span> <span class="n">RESPONSE</span>:
<span class="cp">#ifndef DIVA_NO_DEBUGLIB</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">myDriverDebugHandle</span><span class="p">.</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DL_BLK</span><span class="p">)</span>
			<span class="n">xlog</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x00\x02</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">clength</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">_DATA_B3_R</span>:
<span class="cp">#ifndef DIVA_NO_DEBUGLIB</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">myDriverDebugHandle</span><span class="p">.</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DL_BLK</span><span class="p">)</span>
			<span class="n">xlog</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x00\x02</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">clength</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">clength</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span>
			<span class="n">clength</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>	<span class="cm">/* workaround for PPcom bug */</span>
		<span class="cm">/* header is always 22      */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">data_b3_req</span><span class="p">.</span><span class="n">Data_Length</span><span class="p">)</span> <span class="o">&gt;</span>
		    <span class="n">this</span><span class="o">-&gt;</span><span class="n">MaxDataLength</span>
		    <span class="o">||</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">data_b3_req</span><span class="p">.</span><span class="n">Data_Length</span><span class="p">)</span> <span class="o">&gt;</span>
		    <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">clength</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;Write - invalid message size&quot;</span><span class="p">))</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">CAPI_ILLCMDORSUBCMDORMSGTOSMALL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">write_end</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MAX_DATA_B3</span> <span class="o">*</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">MaxNCCI</span><span class="p">)</span>
			     <span class="o">&amp;&amp;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">xbuffer_used</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">MAX_DATA_B3</span> <span class="o">*</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">MaxNCCI</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;Write - too many data pending&quot;</span><span class="p">))</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">CAPI_SENDQUEUEFULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">write_end</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">data_b3_req</span><span class="p">.</span><span class="n">Data</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">xbuffer_internal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">xbuffer_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)[</span><span class="n">clength</span><span class="p">],</span>
		       <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">data_b3_req</span><span class="p">.</span><span class="n">Data_Length</span><span class="p">));</span>

<span class="cp">#ifndef DIVA_NO_DEBUGLIB</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">myDriverDebugHandle</span><span class="p">.</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DL_BLK</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">myDriverDebugHandle</span><span class="p">.</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DL_XLOG</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span>
				     <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">data_b3_req</span><span class="p">.</span><span class="n">Data_Length</span><span class="p">);</span>
			     <span class="n">j</span> <span class="o">+=</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DBG_BLK</span><span class="p">((((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">xbuffer_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
					 <span class="p">((</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">data_b3_req</span><span class="p">.</span><span class="n">Data_Length</span><span class="p">)</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">&lt;</span>
					  <span class="mi">256</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">data_b3_req</span><span class="p">.</span><span class="n">Data_Length</span><span class="p">)</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">:</span> <span class="mi">256</span><span class="p">))</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">myDriverDebugHandle</span><span class="p">.</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DL_PRV0</span><span class="p">))</span>
						<span class="k">break</span><span class="p">;</span>	<span class="cm">/* not more if not explicitly requested */</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">mapped_msg</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">clength</span><span class="p">);</span>
	<span class="n">mapped_msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">controller</span> <span class="o">=</span> <span class="n">MapController</span><span class="p">(</span><span class="n">mapped_msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">controller</span><span class="p">);</span>
	<span class="n">mapped_msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">clength</span><span class="p">;</span>
	<span class="n">mapped_msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">mapped_msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">GET_WORD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">number</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">api_put</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">mapped_msg</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">_BAD_MSG</span>:
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;Write - bad message&quot;</span><span class="p">))</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">CAPI_ILLCMDORSUBCMDORMSGTOSMALL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">_QUEUE_FULL</span>:
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;Write - queue full&quot;</span><span class="p">))</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">CAPI_SENDQUEUEFULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;Write - api_put returned unknown error&quot;</span><span class="p">))</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">CAPI_UNKNOWNNOTPAR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">write_end:</span>
	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;send message&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">CAPI_NOERROR</span><span class="p">)</span>
		<span class="n">diva_os_free_message_buffer</span><span class="p">(</span><span class="n">dmb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * cards request function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">DIRequest</span><span class="p">(</span><span class="n">ENTITY</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DIVA_CAPI_ADAPTER</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">adapter</span><span class="p">[(</span><span class="n">byte</span><span class="p">)</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]]);</span>
	<span class="n">diva_card</span> <span class="o">*</span><span class="n">os_card</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_card</span> <span class="o">*</span><span class="p">)</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">os_card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">Req</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">FlowControlIdTable</span><span class="p">[</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">ReqCh</span><span class="p">]</span> <span class="o">==</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">FlowControlSkipTable</span><span class="p">[</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">ReqCh</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">os_card</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">request</span><span class="p">))</span> <span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * callback function from didd</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">didd_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="n">DESCRIPTOR</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">removal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IDI_DADAPTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;Notification about IDI_DADAPTER change ! Oops.&quot;</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IDI_DIMAINT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">removal</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stop_dbg</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MAdapter</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MAdapter</span><span class="p">));</span>
			<span class="n">dprintf</span> <span class="o">=</span> <span class="p">(</span><span class="n">DIVA_DI_PRINTF</span><span class="p">)</span> <span class="n">MAdapter</span><span class="p">.</span><span class="n">request</span><span class="p">;</span>
			<span class="n">DbgRegister</span><span class="p">(</span><span class="s">&quot;CAPI20&quot;</span><span class="p">,</span> <span class="n">DRIVERRELEASE_CAPI</span><span class="p">,</span> <span class="n">DBG_DEFAULT</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* IDI Adapter */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">removal</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">divacapi_remove_card</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">diva_add_card</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * connect to didd</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">divacapi_connect_didd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dadapter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">IDI_SYNC_REQ</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">DESCRIPTOR</span> <span class="n">DIDD_Table</span><span class="p">[</span><span class="n">MAX_DESCRIPTORS</span><span class="p">];</span>

	<span class="n">DIVA_DIDD_Read</span><span class="p">(</span><span class="n">DIDD_Table</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DIDD_Table</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">MAX_DESCRIPTORS</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DIDD_Table</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">IDI_DIMAINT</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* MAINT found */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MAdapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DIDD_Table</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAdapter</span><span class="p">));</span>
			<span class="n">dprintf</span> <span class="o">=</span> <span class="p">(</span><span class="n">DIVA_DI_PRINTF</span><span class="p">)</span> <span class="n">MAdapter</span><span class="p">.</span><span class="n">request</span><span class="p">;</span>
			<span class="n">DbgRegister</span><span class="p">(</span><span class="s">&quot;CAPI20&quot;</span><span class="p">,</span> <span class="n">DRIVERRELEASE_CAPI</span><span class="p">,</span> <span class="n">DBG_DEFAULT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">MAX_DESCRIPTORS</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DIDD_Table</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">IDI_DADAPTER</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* DADAPTER found */</span>
			<span class="n">dadapter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DAdapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DIDD_Table</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DAdapter</span><span class="p">));</span>
			<span class="n">req</span><span class="p">.</span><span class="n">didd_notify</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">didd_notify</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">Rc</span> <span class="o">=</span>
				<span class="n">IDI_SYNC_REQ_DIDD_REGISTER_ADAPTER_NOTIFY</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">didd_notify</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">didd_callback</span><span class="p">;</span>
			<span class="n">req</span><span class="p">.</span><span class="n">didd_notify</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">context</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">DAdapter</span><span class="p">.</span><span class="n">request</span><span class="p">((</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">didd_notify</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">Rc</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stop_dbg</span><span class="p">();</span>
				<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">notify_handle</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">didd_notify</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">DIDD_Table</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">type</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">DIDD_Table</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">type</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* IDI Adapter found */</span>
			<span class="n">diva_add_card</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DIDD_Table</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dadapter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stop_dbg</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">dadapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * diconnect from didd</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">divacapi_disconnect_didd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IDI_SYNC_REQ</span> <span class="n">req</span><span class="p">;</span>

	<span class="n">stop_dbg</span><span class="p">();</span>

	<span class="n">req</span><span class="p">.</span><span class="n">didd_notify</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="p">.</span><span class="n">didd_notify</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">Rc</span> <span class="o">=</span> <span class="n">IDI_SYNC_REQ_DIDD_REMOVE_ADAPTER_NOTIFY</span><span class="p">;</span>
	<span class="n">req</span><span class="p">.</span><span class="n">didd_notify</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">notify_handle</span><span class="p">;</span>
	<span class="n">DAdapter</span><span class="p">.</span><span class="n">request</span><span class="p">((</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * we do not provide date/time here,</span>
<span class="cm"> * the application should do this.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fax_head_line_time</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * init (alloc) main structures</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_main_structs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mapped_msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">CAPI_MSG</span> <span class="o">*</span><span class="p">)</span> <span class="n">diva_os_malloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">MAX_MSG_SIZE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;init: failed alloc mapped_msg.&quot;</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">diva_os_malloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX_DESCRIPTORS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;init: failed alloc adapter struct.&quot;</span><span class="p">))</span>
			<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mapped_msg</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DIVA_CAPI_ADAPTER</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX_DESCRIPTORS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">application</span> <span class="o">=</span> <span class="n">diva_os_malloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">APPL</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX_APPL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;init: failed alloc application struct.&quot;</span><span class="p">))</span>
			<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mapped_msg</span><span class="p">);</span>
		<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">APPL</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX_APPL</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * remove (free) main structures</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_main_structs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">application</span><span class="p">)</span>
		<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">application</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="p">)</span>
		<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mapped_msg</span><span class="p">)</span>
		<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mapped_msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * api_remove_start</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_api_remove_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;api remove start&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">api_remove_start</span><span class="p">();</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;api remove start&quot;</span><span class="p">);</span>

		<span class="n">diva_os_sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="o">--</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;could not remove signaling ID&#39;s&quot;</span><span class="p">))</span>
			<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * init</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_capifunc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">diva_os_initialize_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="s">&quot;capifunc&quot;</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ControllerMap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_DESCRIPTORS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">max_adapter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">init_main_structs</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;init: failed to init main structs.&quot;</span><span class="p">))</span>
			<span class="n">diva_os_destroy_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="s">&quot;capifunc&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">divacapi_connect_didd</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;init: failed to connect to DIDD.&quot;</span><span class="p">))</span>
			<span class="n">do_api_remove_start</span><span class="p">();</span>
		<span class="n">divacapi_remove_cards</span><span class="p">();</span>
		<span class="n">remove_main_structs</span><span class="p">();</span>
		<span class="n">diva_os_destroy_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="s">&quot;capifunc&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * finit</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">finit_capifunc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">do_api_remove_start</span><span class="p">();</span>
	<span class="n">divacapi_disconnect_didd</span><span class="p">();</span>
	<span class="n">divacapi_remove_cards</span><span class="p">();</span>
	<span class="n">remove_main_structs</span><span class="p">();</span>
	<span class="n">diva_os_destroy_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">api_lock</span><span class="p">,</span> <span class="s">&quot;capifunc&quot;</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
